<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - StreamRec</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'netflix-red': '#E50914',
                        'netflix-black': '#141414',
                        'netflix-gray': '#2F2F2F'
                    }
                }
            }
        }
    </script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .content-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .scroll-container {
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #1a202c;
        }

        .scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #1a202c;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .nav-tab.active {
            border-bottom: 3px solid #667eea;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            backdrop-filter: blur(10px);
        }

        .preference-badge {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-netflix-black sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-2xl" href="/">
                <i class="bi bi-play-circle-fill text-netflix-red"></i> StreamRec
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/browse"><i class="bi bi-compass"></i> Browse</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/profile"><i class="bi bi-person-circle"></i> Profile</a>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link btn" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Profile Header -->
    <div class="gradient-bg py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="position-relative">
                        <div class="rounded-circle bg-white bg-opacity-25 p-4 text-center"
                            style="width: 120px; height: 120px;">
                            <i class="bi bi-person-fill text-5xl"></i>
                        </div>
                        <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle"
                            onclick="editAvatar()">
                            <i class="bi bi-camera"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-7">
                    <h1 class="display-5 fw-bold mb-2" id="username">Loading...</h1>
                    <p class="text-light mb-3" id="email">...</p>
                    <div class="d-flex flex-wrap gap-2" id="preferencesBadges">
                        <!-- Preference badges will be inserted here -->
                    </div>
                </div>
                <div class="col-md-3 text-md-end">
                    <button class="btn btn-light btn-lg" onclick="openEditProfile()">
                        <i class="bi bi-pencil"></i> Edit Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="container mt-4">
        <div class="row g-3">
            <div class="col-6 col-md-2">
                <div class="stats-card rounded-3 p-3 text-center">
                    <i class="bi bi-eye text-3xl text-primary"></i>
                    <h3 class="mt-2 mb-0" id="totalWatched">0</h3>
                    <small class="text-muted">Watched</small>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="stats-card rounded-3 p-3 text-center">
                    <i class="bi bi-heart text-3xl text-danger"></i>
                    <h3 class="mt-2 mb-0" id="totalLiked">0</h3>
                    <small class="text-muted">Liked</small>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="stats-card rounded-3 p-3 text-center">
                    <i class="bi bi-star text-3xl text-warning"></i>
                    <h3 class="mt-2 mb-0" id="totalFavorited">0</h3>
                    <small class="text-muted">Favorites</small>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="stats-card rounded-3 p-3 text-center">
                    <i class="bi bi-bookmark text-3xl text-info"></i>
                    <h3 class="mt-2 mb-0" id="totalWatchlist">0</h3>
                    <small class="text-muted">Watchlist</small>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="stats-card rounded-3 p-3 text-center">
                    <i class="bi bi-star-half text-3xl text-success"></i>
                    <h3 class="mt-2 mb-0" id="totalRated">0</h3>
                    <small class="text-muted">Rated</small>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div class="stats-card rounded-3 p-3 text-center">
                    <i class="bi bi-bullseye text-3xl text-purple-500"></i>
                    <h3 class="mt-2 mb-0" id="accuracyScore">95%</h3>
                    <small class="text-muted">Match Rate</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="container mt-5">
        <nav class="nav nav-pills nav-fill gap-2">
            <button class="nav-link nav-tab active bg-transparent border-0 text-white"
                onclick="switchTab('recommendations')">
                <i class="bi bi-magic"></i> For You
            </button>
            <button class="nav-link nav-tab bg-transparent border-0 text-white" onclick="switchTab('watchlist')">
                <i class="bi bi-bookmark"></i> Watchlist
            </button>
            <button class="nav-link nav-tab bg-transparent border-0 text-white" onclick="switchTab('favorites')">
                <i class="bi bi-star"></i> Favorites
            </button>
            <button class="nav-link nav-tab bg-transparent border-0 text-white" onclick="switchTab('history')">
                <i class="bi bi-clock-history"></i> History
            </button>
            <button class="nav-link nav-tab bg-transparent border-0 text-white" onclick="switchTab('insights')">
                <i class="bi bi-graph-up"></i> Insights
            </button>
        </nav>
    </div>

    <!-- Content Sections -->
    <div class="container mt-4 mb-5">
        <!-- Recommendations Section -->
        <div id="recommendationsSection" class="tab-content">
            <h2 class="mb-4">Ultra-Personalized For You</h2>

            <!-- Mood Selector -->
            <div class="mb-4">
                <h5 class="mb-3">How are you feeling today?</h5>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-light" onclick="getMoodRecommendations('happy')">
                        üòä Happy
                    </button>
                    <button class="btn btn-outline-light" onclick="getMoodRecommendations('sad')">
                        üò¢ Sad
                    </button>
                    <button class="btn btn-outline-light" onclick="getMoodRecommendations('excited')">
                        üéâ Excited
                    </button>
                    <button class="btn btn-outline-light" onclick="getMoodRecommendations('relaxed')">
                        üòå Relaxed
                    </button>
                    <button class="btn btn-outline-light" onclick="getMoodRecommendations('romantic')">
                        üíï Romantic
                    </button>
                    <button class="btn btn-outline-light" onclick="getMoodRecommendations('scary')">
                        üëª Scary
                    </button>
                </div>
            </div>

            <!-- Top Picks -->
            <div class="mb-5">
                <h4 class="mb-3">üéØ Top Picks (95%+ Match)</h4>
                <div class="scroll-container">
                    <div class="d-flex gap-3" id="topPicks">
                        <!-- Content cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- New For You -->
            <div class="mb-5">
                <h4 class="mb-3">‚ú® New For You</h4>
                <div class="scroll-container">
                    <div class="d-flex gap-3" id="newForYou">
                        <!-- Content cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Explore New Genres -->
            <div class="mb-5">
                <h4 class="mb-3">üöÄ Expand Your Horizons</h4>
                <div class="scroll-container">
                    <div class="d-flex gap-3" id="exploreContent">
                        <!-- Content cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Section -->
        <div id="watchlistSection" class="tab-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Watchlist</h2>
                <span class="badge bg-primary" id="watchlistCount">0 items</span>
            </div>
            <div class="row g-3" id="watchlistContent">
                <!-- Watchlist items will be inserted here -->
            </div>
        </div>

        <!-- Favorites Section -->
        <div id="favoritesSection" class="tab-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Favorites</h2>
                <span class="badge bg-danger" id="favoritesCount">0 items</span>
            </div>
            <div class="row g-3" id="favoritesContent">
                <!-- Favorite items will be inserted here -->
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="tab-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Watch History</h2>
                <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()">
                    <i class="bi bi-trash"></i> Clear History
                </button>
            </div>
            <div class="row g-3" id="historyContent">
                <!-- History items will be inserted here -->
            </div>
        </div>

        <!-- Insights Section -->
        <div id="insightsSection" class="tab-content d-none">
            <h2 class="mb-4">Your Viewing Insights</h2>

            <div class="row g-4">
                <!-- Genre Preferences -->
                <div class="col-md-6">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title">üé≠ Favorite Genres</h5>
                            <div id="genreChart" class="mt-3">
                                <!-- Genre chart will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Language Preferences -->
                <div class="col-md-6">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title">üåç Language Preferences</h5>
                            <div id="languageChart" class="mt-3">
                                <!-- Language chart will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Viewing Patterns -->
                <div class="col-md-6">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title">üìä Viewing Patterns</h5>
                            <div class="mt-3">
                                <div class="mb-3">
                                    <small class="text-muted">Completion Rate</small>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" id="completionRate" style="width: 0%">0%
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Binge-Watching Tendency</small>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning" id="bingeRate" style="width: 0%">0%</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Rewatch Rate</small>
                                    <div class="progress">
                                        <div class="progress-bar bg-info" id="rewatchRate" style="width: 0%">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Type Distribution -->
                <div class="col-md-6">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title">üì∫ Content Type Distribution</h5>
                            <div id="contentTypeChart" class="mt-3">
                                <!-- Content type chart will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mood Preferences -->
                <div class="col-12">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title">üòä Mood & Theme Preferences</h5>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>Top Moods</h6>
                                    <div id="moodPreferences">
                                        <!-- Mood preferences will be inserted here -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Favorite Themes</h6>
                                    <div id="themePreferences">
                                        <!-- Theme preferences will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <!-- Languages -->
                        <div class="mb-4">
                            <label class="form-label">Preferred Languages</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="telugu" id="langTelugu">
                                        <label class="form-check-label" for="langTelugu">Telugu</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="english"
                                            id="langEnglish">
                                        <label class="form-check-label" for="langEnglish">English</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="hindi" id="langHindi">
                                        <label class="form-check-label" for="langHindi">Hindi</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="tamil" id="langTamil">
                                        <label class="form-check-label" for="langTamil">Tamil</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="malayalam"
                                            id="langMalayalam">
                                        <label class="form-check-label" for="langMalayalam">Malayalam</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="kannada"
                                            id="langKannada">
                                        <label class="form-check-label" for="langKannada">Kannada</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Genres -->
                        <div class="mb-4">
                            <label class="form-label">Preferred Genres</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Action" id="genreAction">
                                        <label class="form-check-label" for="genreAction">Action</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Comedy" id="genreComedy">
                                        <label class="form-check-label" for="genreComedy">Comedy</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Drama" id="genreDrama">
                                        <label class="form-check-label" for="genreDrama">Drama</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Romance"
                                            id="genreRomance">
                                        <label class="form-check-label" for="genreRomance">Romance</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Thriller"
                                            id="genreThriller">
                                        <label class="form-check-label" for="genreThriller">Thriller</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Horror" id="genreHorror">
                                        <label class="form-check-label" for="genreHorror">Horror</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Sci-Fi" id="genreSciFi">
                                        <label class="form-check-label" for="genreSciFi">Sci-Fi</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Animation"
                                            id="genreAnimation">
                                        <label class="form-check-label" for="genreAnimation">Animation</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="Documentary"
                                            id="genreDocumentary">
                                        <label class="form-check-label" for="genreDocumentary">Documentary</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location -->
                        <div class="mb-4">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control bg-secondary text-white border-0" id="location"
                                placeholder="City, Country">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Message here
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        const API_BASE = '/api';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            if (!authToken) {
                window.location.href = '/login';
                return;
            }
            loadUserProfile();
            loadPersonalizedRecommendations();
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('authToken');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('Failed to load profile');
                }

                const data = await response.json();
                currentUser = data.user;

                // Update UI with user data
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('email').textContent = currentUser.email;

                // Update statistics
                const stats = data.statistics;
                document.getElementById('totalWatched').textContent = stats.total_watched;
                document.getElementById('totalLiked').textContent = stats.total_liked;
                document.getElementById('totalFavorited').textContent = stats.total_favorited;
                document.getElementById('totalWatchlist').textContent = stats.total_watchlist;
                document.getElementById('totalRated').textContent = stats.total_rated;

                // Update preference badges
                updatePreferenceBadges();

                // Load insights if available
                if (data.insights) {
                    updateInsights(data.insights);
                }

            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Failed to load profile', 'error');
            }
        }

        // Update preference badges
        function updatePreferenceBadges() {
            const badgesContainer = document.getElementById('preferencesBadges');
            badgesContainer.innerHTML = '';

            // Add language badges
            if (currentUser.preferred_languages && currentUser.preferred_languages.length > 0) {
                currentUser.preferred_languages.forEach(lang => {
                    const badge = `<span class="badge bg-primary preference-badge">
                        <i class="bi bi-translate"></i> ${lang}
                    </span>`;
                    badgesContainer.innerHTML += badge;
                });
            }

            // Add genre badges
            if (currentUser.preferred_genres && currentUser.preferred_genres.length > 0) {
                currentUser.preferred_genres.slice(0, 3).forEach(genre => {
                    const badge = `<span class="badge bg-secondary preference-badge">
                        <i class="bi bi-film"></i> ${genre}
                    </span>`;
                    badgesContainer.innerHTML += badge;
                });
            }

            // Add location badge
            if (currentUser.location) {
                const badge = `<span class="badge bg-info preference-badge">
                    <i class="bi bi-geo-alt"></i> ${currentUser.location}
                </span>`;
                badgesContainer.innerHTML += badge;
            }
        }

        // Load personalized recommendations
        async function loadPersonalizedRecommendations() {
            try {
                // Load For You section
                const forYouResponse = await fetch(`${API_BASE}/recommendations/for-you`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (forYouResponse.ok) {
                    const data = await forYouResponse.json();

                    // Display top picks
                    if (data.categories.top_picks) {
                        displayContentCards('topPicks', data.categories.top_picks);
                    }

                    // Display new for you
                    if (data.categories.new_for_you) {
                        displayContentCards('newForYou', data.categories.new_for_you);
                    }
                }

                // Load exploration recommendations
                const exploreResponse = await fetch(`${API_BASE}/recommendations/explore?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (exploreResponse.ok) {
                    const data = await exploreResponse.json();
                    displayContentCards('exploreContent', data.recommendations);
                }

            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }

        // Display content cards
        function displayContentCards(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container || !items || items.length === 0) return;

            container.innerHTML = '';

            items.forEach(item => {
                const card = createContentCard(item);
                container.innerHTML += card;
            });
        }

        // Create content card HTML
        function createContentCard(item) {
            const matchScore = item.match_score ?
                `<span class="badge bg-success position-absolute top-2 end-2">${Math.round(item.match_score * 100)}% Match</span>` : '';

            const rating = item.rating ?
                `<span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> ${item.rating.toFixed(1)}</span>` : '';

            return `
                <div class="content-card flex-shrink-0" style="width: 200px; cursor: pointer;" onclick="viewContent(${item.id})">
                    <div class="position-relative">
                        <img src="${item.poster_path || '/placeholder.jpg'}" 
                             class="rounded-3" 
                             style="width: 200px; height: 300px; object-fit: cover;"
                             alt="${item.title}"
                             onerror="this.src='/placeholder.jpg'">
                        ${matchScore}
                        <div class="position-absolute bottom-0 start-0 end-0 p-2 bg-gradient-to-t from-black to-transparent">
                            <h6 class="text-white mb-1 text-truncate">${item.title}</h6>
                            <div class="d-flex gap-1">
                                ${rating}
                                ${item.youtube_trailer ?
                    `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); playTrailer('${item.youtube_trailer}')">
                                        <i class="bi bi-play-fill"></i>
                                    </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.tab-content').forEach(section => {
                section.classList.add('d-none');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(`${tabName}Section`).classList.remove('d-none');

            // Add active class to selected tab
            event.target.classList.add('active');

            // Load content for the selected tab
            switch (tabName) {
                case 'watchlist':
                    loadWatchlist();
                    break;
                case 'favorites':
                    loadFavorites();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'insights':
                    loadInsights();
                    break;
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayListContent('watchlistContent', data.watchlist);
                    document.getElementById('watchlistCount').textContent = `${data.watchlist.length} items`;
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        // Load favorites
        async function loadFavorites() {
            try {
                const response = await fetch(`${API_BASE}/user/favorites`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayListContent('favoritesContent', data.favorites);
                    document.getElementById('favoritesCount').textContent = `${data.favorites.length} items`;
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/user/history?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayListContent('historyContent', data.history, true);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Display list content
        function displayListContent(containerId, items, showDate = false) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5">No items found</div>';
                return;
            }

            items.forEach(item => {
                const date = showDate && item.watched_at ?
                    `<small class="text-muted">Watched: ${new Date(item.watched_at).toLocaleDateString()}</small>` :
                    (item.added_at ? `<small class="text-muted">Added: ${new Date(item.added_at).toLocaleDateString()}</small>` : '');

                const card = `
                    <div class="col-6 col-md-3 col-lg-2">
                        <div class="content-card" onclick="viewContent(${item.id})">
                            <img src="${item.poster_path || '/placeholder.jpg'}" 
                                 class="rounded-3 w-100" 
                                 style="height: 250px; object-fit: cover;"
                                 alt="${item.title}"
                                 onerror="this.src='/placeholder.jpg'">
                            <div class="mt-2">
                                <h6 class="mb-1 text-truncate">${item.title}</h6>
                                ${date}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // Load insights
        async function loadInsights() {
            try {
                const response = await fetch(`${API_BASE}/user/insights`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const insights = await response.json();
                    updateInsights(insights);
                }
            } catch (error) {
                console.error('Error loading insights:', error);
            }
        }

        // Update insights UI
        function updateInsights(insights) {
            // Update genre chart
            if (insights.favorite_genres && insights.favorite_genres.length > 0) {
                const genreChart = document.getElementById('genreChart');
                genreChart.innerHTML = '';
                insights.favorite_genres.forEach(([genre, score]) => {
                    const percentage = Math.round(score * 100);
                    genreChart.innerHTML += `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${genre}</span>
                                <span>${percentage}%</span>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });
            }

            // Update language chart
            if (insights.favorite_languages && insights.favorite_languages.length > 0) {
                const languageChart = document.getElementById('languageChart');
                languageChart.innerHTML = '';
                insights.favorite_languages.forEach(([language, score]) => {
                    const percentage = Math.round(score * 100);
                    languageChart.innerHTML += `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${language}</span>
                                <span>${percentage}%</span>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-info" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });
            }

            // Update viewing patterns
            if (insights.viewing_patterns) {
                const patterns = insights.viewing_patterns;

                if (patterns.completion_rate !== undefined) {
                    const rate = patterns.completion_rate;
                    document.getElementById('completionRate').style.width = `${rate}%`;
                    document.getElementById('completionRate').textContent = `${rate}%`;
                }

                if (patterns.binge_watching_tendency !== undefined) {
                    const rate = patterns.binge_watching_tendency;
                    document.getElementById('bingeRate').style.width = `${rate}%`;
                    document.getElementById('bingeRate').textContent = `${rate}%`;
                }

                if (patterns.rewatch_rate !== undefined) {
                    const rate = patterns.rewatch_rate;
                    document.getElementById('rewatchRate').style.width = `${rate}%`;
                    document.getElementById('rewatchRate').textContent = `${rate}%`;
                }
            }

            // Update content type distribution
            if (insights.content_type_distribution) {
                const contentTypeChart = document.getElementById('contentTypeChart');
                contentTypeChart.innerHTML = '';
                Object.entries(insights.content_type_distribution).forEach(([type, percentage]) => {
                    contentTypeChart.innerHTML += `
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>${type}</span>
                                <span>${percentage}%</span>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-warning" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });
            }

            // Update mood preferences
            if (insights.mood_preferences && insights.mood_preferences.length > 0) {
                const moodContainer = document.getElementById('moodPreferences');
                moodContainer.innerHTML = '';
                insights.mood_preferences.forEach(([mood, score]) => {
                    moodContainer.innerHTML += `
                        <span class="badge bg-primary me-2 mb-2">${mood}</span>
                    `;
                });
            }

            // Update theme preferences
            if (insights.theme_preferences && insights.theme_preferences.length > 0) {
                const themeContainer = document.getElementById('themePreferences');
                themeContainer.innerHTML = '';
                insights.theme_preferences.forEach(([theme, score]) => {
                    themeContainer.innerHTML += `
                        <span class="badge bg-secondary me-2 mb-2">${theme}</span>
                    `;
                });
            }
        }

        // Get mood-based recommendations
        async function getMoodRecommendations(mood) {
            try {
                const response = await fetch(`${API_BASE}/recommendations/mood?mood=${mood}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayContentCards('topPicks', data.recommendations);
                    showToast(`Showing ${mood} recommendations`, 'success');
                }
            } catch (error) {
                console.error('Error loading mood recommendations:', error);
            }
        }

        // Open edit profile modal
        function openEditProfile() {
            // Pre-fill form with current values
            if (currentUser) {
                // Set languages
                if (currentUser.preferred_languages) {
                    currentUser.preferred_languages.forEach(lang => {
                        const checkbox = document.getElementById(`lang${capitalizeFirst(lang)}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Set genres
                if (currentUser.preferred_genres) {
                    currentUser.preferred_genres.forEach(genre => {
                        const checkbox = document.getElementById(`genre${genre.replace(/\s+/g, '')}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Set location
                if (currentUser.location) {
                    document.getElementById('location').value = currentUser.location;
                }
            }

            const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            modal.show();
        }

        // Save profile
        async function saveProfile() {
            try {
                // Collect selected languages
                const languages = [];
                document.querySelectorAll('input[id^="lang"]:checked').forEach(checkbox => {
                    languages.push(checkbox.value);
                });

                // Collect selected genres
                const genres = [];
                document.querySelectorAll('input[id^="genre"]:checked').forEach(checkbox => {
                    genres.push(checkbox.value);
                });

                const location = document.getElementById('location').value;

                const response = await fetch(`${API_BASE}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        preferred_languages: languages,
                        preferred_genres: genres,
                        location: location
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updatePreferenceBadges();

                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();

                    showToast('Profile updated successfully', 'success');

                    // Reload recommendations with new preferences
                    loadPersonalizedRecommendations();
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Failed to update profile', 'error');
            }
        }

        // View content details
        function viewContent(contentId) {
            window.location.href = `/content/${contentId}`;
        }

        // Play trailer
        function playTrailer(youtubeUrl) {
            window.open(youtubeUrl, '_blank');
        }

        // Clear history
        async function clearHistory() {
            if (!confirm('Are you sure you want to clear your watch history?')) {
                return;
            }

            // Note: This endpoint would need to be implemented in the backend
            showToast('History clearing not implemented', 'info');
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            // Update toast color based on type
            toastElement.classList.remove('bg-success', 'bg-danger', 'bg-info');
            if (type === 'success') {
                toastElement.classList.add('bg-success');
            } else if (type === 'error') {
                toastElement.classList.add('bg-danger');
            } else {
                toastElement.classList.add('bg-info');
            }

            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        // Utility function
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Edit avatar placeholder
        function editAvatar() {
            showToast('Avatar upload not implemented', 'info');
        }
    </script>
</body>

</html>