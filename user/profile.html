<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="User Profile - CineBrain">
  <title id="page-title">Profile - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="profile-layout">
        <!-- Profile Header -->
        <div class="profile-header">
          <div class="profile-avatar">
            <img id="profile-avatar" src="" alt="Profile Avatar">
          </div>
          <div class="profile-info">
            <h1 id="profile-username">Loading...</h1>
            <p class="text-muted" id="profile-email">Loading...</p>
            <div class="profile-stats">
              <div class="stat-item">
                <span class="stat-value" id="watchlist-count">0</span>
                <span class="stat-label">Watchlist</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="favorites-count">0</span>
                <span class="stat-label">Favorites</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="ratings-count">0</span>
                <span class="stat-label">Ratings</span>
              </div>
            </div>
          </div>
          <div class="profile-actions">
            <button class="btn btn-outline" onclick="editProfile()">Edit Profile</button>
            <button class="btn btn-ghost" onclick="viewSettings()">Settings</button>
          </div>
        </div>

        <!-- User's Recent Activity -->
        <section class="content-section">
          <h2 class="section-title">Recent Activity</h2>
          <div class="carousel-wrapper">
            <div class="content-carousel">
              <div class="carousel-container">
                <div class="carousel-track" id="recent-activity-track">
                  <!-- Real recent activity loaded here -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Personalized Recommendations -->
        <section class="content-section">
          <div class="section-header">
            <h2 class="section-title">Recommended for You</h2>
            <button class="section-btn" onclick="refreshRecommendations()">ðŸ”„ Refresh</button>
          </div>
          <div class="carousel-wrapper">
            <div class="content-carousel">
              <div class="carousel-container">
                <div class="carousel-track" id="recommendations-track">
                  <!-- Real personalized recommendations loaded here -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Quick Access Sections -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Watchlist Preview -->
          <section class="content-section">
            <div class="section-header">
              <h3 class="text-xl font-semibold">My Watchlist</h3>
              <a href="/user/watchlist.html" class="section-btn">View All</a>
            </div>
            <div class="content-grid" id="watchlist-preview">
              <!-- Real watchlist preview loaded here -->
            </div>
          </section>

          <!-- Favorites Preview -->
          <section class="content-section">
            <div class="section-header">
              <h3 class="text-xl font-semibold">My Favorites</h3>
              <a href="/user/favorites.html" class="section-btn">View All</a>
            </div>
            <div class="content-grid" id="favorites-preview">
              <!-- Real favorites preview loaded here -->
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeProfilePage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeProfilePage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    function initializeProfilePage() {
      // Require authentication
      if (!Auth.requireAuth()) {
        return;
      }
      
      currentUser = Auth.getCurrentUser();
      
      // Validate URL matches current user
      const pathUsername = window.location.pathname.split('/')[1];
      if (pathUsername !== currentUser.username) {
        window.location.href = `/${currentUser.username}/profile`;
        return;
      }
      
      loadUserProfile();
      
      console.log('ðŸ‘¤ Profile page initialized for user:', currentUser.username);
    }

    async function loadUserProfile() {
      try {
        // Update profile display
        updateProfileDisplay();
        
        // Load user data in parallel
        await Promise.all([
          loadUserStats(),
          loadRecentActivity(),
          loadPersonalizedRecommendations(),
          loadWatchlistPreview(),
          loadFavoritesPreview()
        ]);
        
      } catch (error) {
        console.error('Profile loading error:', error);
        showToast('Failed to load profile data', 'error');
      }
    }

    function updateProfileDisplay() {
      document.getElementById('page-title').textContent = `${currentUser.username} - Profile - CineBrain`;
      document.getElementById('profile-username').textContent = currentUser.username;
      document.getElementById('profile-email').textContent = currentUser.email || 'No email provided';
      
      // Set avatar
      const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.username)}&background=3b82f6&color=ffffff&size=120&rounded=true`;
      document.getElementById('profile-avatar').src = avatarUrl;
    }

    async function loadUserStats() {
      try {
        const [watchlist, favorites] = await Promise.all([
          Auth.getUserWatchlist(),
          Auth.getUserFavorites()
        ]);
        
        document.getElementById('watchlist-count').textContent = watchlist.length;
        document.getElementById('favorites-count').textContent = favorites.length;
        
        // Get ratings count from interactions
        const ratingsCount = await getUserRatingsCount();
        document.getElementById('ratings-count').textContent = ratingsCount;
        
      } catch (error) {
        console.error('Stats loading error:', error);
      }
    }

    async function getUserRatingsCount() {
      try {
        // This would be a real API call to get user's ratings count
        return 0; // Placeholder for now
      } catch (error) {
        return 0;
      }
    }

    async function loadRecentActivity() {
      try {
        // Load user's recent interactions/activity
        // This would come from a real backend endpoint
        const recentActivity = []; // Placeholder
        
        const track = document.getElementById('recent-activity-track');
        if (recentActivity.length > 0) {
          track.innerHTML = '';
          recentActivity.forEach(item => {
            const card = app.createContentCard(item);
            track.appendChild(card);
          });
        } else {
          track.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
        }
        
      } catch (error) {
        console.error('Recent activity error:', error);
      }
    }

    async function loadPersonalizedRecommendations() {
      try {
        const data = await Auth.getMLRecommendations();
        const recommendations = data.recommendations || [];
        
        const track = document.getElementById('recommendations-track');
        if (recommendations.length > 0) {
          track.innerHTML = '';
          recommendations.slice(0, 10).forEach(item => {
            const card = app.createContentCard(item);
            track.appendChild(card);
          });
        } else {
          track.innerHTML = '<div class="empty-state"><p>Building your recommendations...</p></div>';
        }
        
      } catch (error) {
        console.error('Recommendations error:', error);
        document.getElementById('recommendations-track').innerHTML = '<div class="error-state"><p>Failed to load recommendations</p></div>';
      }
    }

    async function loadWatchlistPreview() {
      try {
        const watchlist = await Auth.getUserWatchlist();
        
        const container = document.getElementById('watchlist-preview');
        if (watchlist.length > 0) {
          container.innerHTML = '';
          watchlist.slice(0, 4).forEach(item => {
            const card = app.createContentCard(item);
            card.classList.add('content-card-mini');
            container.appendChild(card);
          });
        } else {
          container.innerHTML = '<div class="empty-state"><p>Your watchlist is empty</p><button class="btn btn-primary mt-2" onclick="exploreContent()">Explore Content</button></div>';
        }
        
      } catch (error) {
        console.error('Watchlist preview error:', error);
      }
    }

    async function loadFavoritesPreview() {
      try {
        const favorites = await Auth.getUserFavorites();
        
        const container = document.getElementById('favorites-preview');
        if (favorites.length > 0) {
          container.innerHTML = '';
          favorites.slice(0, 4).forEach(item => {
            const card = app.createContentCard(item);
            card.classList.add('content-card-mini');
            container.appendChild(card);
          });
        } else {
          container.innerHTML = '<div class="empty-state"><p>No favorites yet</p><button class="btn btn-primary mt-2" onclick="exploreContent()">Find Favorites</button></div>';
        }
        
      } catch (error) {
        console.error('Favorites preview error:', error);
      }
    }

    async function refreshRecommendations() {
      showToast('Refreshing recommendations...', 'info');
      await loadPersonalizedRecommendations();
      showToast('Recommendations updated!', 'success');
    }

    function editProfile() {
      showToast('Profile editing coming soon!', 'info');
    }

    function viewSettings() {
      window.location.href = '/user/settings.html';
    }

    function exploreContent() {
      window.location.href = '/content/search.html';
    }
  </script>
</body>
</html>