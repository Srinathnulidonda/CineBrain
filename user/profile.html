<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="container">
                <!-- Profile Header -->
                <div class="profile-header animate-fadeIn">
                    <div class="profile-header__info">
                        <div class="profile-header__avatar">
                            <img src="/assets/images/default-avatar.png" alt="Profile" id="profileAvatar">
                        </div>
                        <div class="profile-header__details">
                            <h1 id="profileUsername">Loading...</h1>
                            <p class="text-muted mb-md" id="profileEmail">Loading...</p>
                            <p class="text-sm text-muted" id="profileJoined">Loading...</p>
                        </div>
                    </div>

                    <div class="profile-header__stats">
                        <div class="profile-stat">
                            <span class="profile-stat__value" id="watchlistCount">0</span>
                            <span class="profile-stat__label">Watchlist</span>
                        </div>
                        <div class="profile-stat">
                            <span class="profile-stat__value" id="favoritesCount">0</span>
                            <span class="profile-stat__label">Favorites</span>
                        </div>
                        <div class="profile-stat">
                            <span class="profile-stat__value" id="watchedCount">0</span>
                            <span class="profile-stat__label">Watched</span>
                        </div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <div class="tabs">
                    <ul class="tabs__list">
                        <li class="tabs__item tabs__item--active" data-tab="overview">Overview</li>
                        <li class="tabs__item" data-tab="activity">Recent Activity</li>
                        <li class="tabs__item" data-tab="preferences">Preferences</li>
                        <li class="tabs__item" data-tab="recommendations">For You</li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane active" id="overview">
                        <!-- Continue Watching -->
                        <section class="mb-2xl" id="continueWatchingSection" style="display: none;">
                            <h2 class="mb-lg">Continue Watching</h2>
                            <div class="content-grid content-grid--movies" id="continueWatchingGrid">
                                <!-- Dynamic content -->
                            </div>
                        </section>

                        <!-- Recently Viewed -->
                        <section class="mb-2xl">
                            <div class="d-flex justify-between align-center mb-lg">
                                <h2>Recently Viewed</h2>
                                <a href="#" onclick="clearRecentlyViewed()" class="text-sm text-muted">Clear All</a>
                            </div>
                            <div class="content-grid content-grid--movies" id="recentlyViewedGrid">
                                <!-- Dynamic content -->
                            </div>
                        </section>

                        <!-- Watchlist Preview -->
                        <section class="mb-2xl">
                            <div class="d-flex justify-between align-center mb-lg">
                                <h2>My Watchlist</h2>
                                <a href="#" onclick="navigateToWatchlist()" class="text-blue">View All</a>
                            </div>
                            <div class="content-grid content-grid--movies" id="watchlistPreview">
                                <!-- Dynamic content -->
                            </div>
                        </section>

                        <!-- Favorites Preview -->
                        <section>
                            <div class="d-flex justify-between align-center mb-lg">
                                <h2>My Favorites</h2>
                                <a href="#" onclick="navigateToFavorites()" class="text-blue">View All</a>
                            </div>
                            <div class="content-grid content-grid--movies" id="favoritesPreview">
                                <!-- Dynamic content -->
                            </div>
                        </section>
                    </div>

                    <!-- Activity Tab -->
                    <div class="tab-pane" id="activity">
                        <div class="activity-timeline" id="activityTimeline">
                            <!-- Dynamic activity feed -->
                        </div>
                    </div>

                    <!-- Preferences Tab -->
                    <div class="tab-pane" id="preferences">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="bg-secondary rounded-lg p-lg mb-lg">
                                    <h3 class="mb-lg">Content Preferences</h3>

                                    <div class="mb-lg">
                                        <label class="auth-form__label mb-sm">Preferred Genres</label>
                                        <div class="filters__options" id="genrePreferences">
                                            <!-- Dynamic genre chips -->
                                        </div>
                                    </div>

                                    <div class="mb-lg">
                                        <label class="auth-form__label mb-sm">Preferred Languages</label>
                                        <div class="filters__options" id="languagePreferences">
                                            <!-- Dynamic language chips -->
                                        </div>
                                    </div>

                                    <button class="btn btn-primary" onclick="savePreferences()">
                                        Save Preferences
                                    </button>
                                </div>

                                <div class="bg-secondary rounded-lg p-lg">
                                    <h3 class="mb-lg">Account Actions</h3>
                                    <button class="btn btn-secondary mb-sm w-100" onclick="navigateToSettings()">
                                        <i class="bi bi-gear"></i> Account Settings
                                    </button>
                                    <button class="btn btn-secondary mb-sm w-100" onclick="auth.logout()">
                                        <i class="bi bi-box-arrow-right"></i> Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations Tab -->
                    <div class="tab-pane" id="recommendations">
                        <div class="mb-lg">
                            <p class="text-muted">Personalized recommendations based on your viewing history and
                                preferences.</p>
                        </div>
                        <div class="content-grid content-grid--movies" id="personalizedGrid">
                            <!-- Dynamic personalized content -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" onclick="navigateToWatchlist()" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" class="mobile-nav__link mobile-nav__link--active">
                        <i class="bi bi-person-fill mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login if not authenticated
        }

        let userWatchlist = [];
        let userFavorites = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Update navigation
            updateNavigation();

            // Load user profile
            loadUserProfile();

            // Load user content
            loadUserContent();

            // Setup tabs
            setupTabs();
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const user = auth.getUser();

            navbarUser.innerHTML = `
                <a href="${auth.getUserUrl('watchlist')}" class="navbar__link">
                    <i class="bi bi-bookmark"></i>
                </a>
                <a href="${auth.getUserUrl('favorites')}" class="navbar__link">
                    <i class="bi bi-heart"></i>
                </a>
                <div class="navbar__avatar">
                    <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                </div>
            `;
        }

        function loadUserProfile() {
            const user = auth.getUser();

            // Update profile info
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileJoined').textContent = `Member since ${new Date(user.created_at || Date.now()).toLocaleDateString()}`;

            // Update preferences
            loadPreferences();
        }

        async function loadUserContent() {
            try {
                // Load watchlist
                const watchlistResponse = await api.getWatchlist();
                userWatchlist = watchlistResponse.watchlist || [];
                document.getElementById('watchlistCount').textContent = userWatchlist.length;
                renderContentGrid('watchlistPreview', userWatchlist.slice(0, 6));

                // Load favorites
                const favoritesResponse = await api.getFavorites();
                userFavorites = favoritesResponse.favorites || [];
                document.getElementById('favoritesCount').textContent = userFavorites.length;
                renderContentGrid('favoritesPreview', userFavorites.slice(0, 6));

                // Load recently viewed
                const recentlyViewed = Storage.getRecentlyViewed();
                renderContentGrid('recentlyViewedGrid', recentlyViewed.slice(0, 12));

                // Load personalized recommendations
                loadPersonalizedRecommendations();

            } catch (error) {
                console.error('Failed to load user content:', error);
            }
        }

        async function loadPersonalizedRecommendations() {
            try {
                const response = await api.getPersonalizedRecommendations(20);
                renderContentGrid('personalizedGrid', response.recommendations);
            } catch (error) {
                // Fallback to anonymous recommendations
                const response = await api.getAnonymousRecommendations(20);
                renderContentGrid('personalizedGrid', response.recommendations);
            }
        }

        function loadPreferences() {
            const user = auth.getUser();
            const genres = user.preferred_genres || [];
            const languages = user.preferred_languages || [];

            // Render genre preferences
            const genreContainer = document.getElementById('genrePreferences');
            genreContainer.innerHTML = Config.GENRES.movie.map(genre => `
                <label class="filter-chip cursor-pointer ${genres.includes(genre) ? 'filter-chip--active' : ''}">
                    <input type="checkbox" value="${genre}" name="genre" class="d-none" ${genres.includes(genre) ? 'checked' : ''}>
                    ${genre}
                </label>
            `).join('');

            // Render language preferences
            const languageContainer = document.getElementById('languagePreferences');
            languageContainer.innerHTML = Object.entries(Config.LANGUAGES).map(([key, lang]) => `
                <label class="filter-chip cursor-pointer ${languages.includes(key) ? 'filter-chip--active' : ''}">
                    <input type="checkbox" value="${key}" name="language" class="d-none" ${languages.includes(key) ? 'checked' : ''}>
                    ${lang.name}
                </label>
            `).join('');

            // Setup chip interactions
            setupFilterChips();
        }

        function setupFilterChips() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function () {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('filter-chip--active', checkbox.checked);
                });
            });
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tabs__item');
            const panes = document.querySelectorAll('.tab-pane');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active from all
                    tabs.forEach(t => t.classList.remove('tabs__item--active'));
                    panes.forEach(p => p.classList.remove('active'));

                    // Add active to clicked
                    tab.classList.add('tabs__item--active');
                    const paneId = tab.dataset.tab;
                    document.getElementById(paneId).classList.add('active');

                    // Load content if needed
                    if (paneId === 'activity' && !document.getElementById('activityTimeline').hasChildNodes()) {
                        loadActivityFeed();
                    }
                });
            });
        }

        async function loadActivityFeed() {
            // Simulate activity feed - in production, this would come from API
            const activities = [
                { type: 'watchlist', content: userWatchlist[0], time: 'Today' },
                { type: 'favorite', content: userFavorites[0], time: 'Yesterday' },
                { type: 'view', content: Storage.getRecentlyViewed()[0], time: '2 days ago' }
            ].filter(a => a.content);

            const timeline = document.getElementById('activityTimeline');
            timeline.innerHTML = activities.map(activity => `
                <div class="activity-item p-md bg-secondary rounded-lg mb-md animate-fadeInUp">
                    <div class="d-flex align-center gap-md">
                        <i class="bi bi-${activity.type === 'watchlist' ? 'bookmark-fill' : activity.type === 'favorite' ? 'heart-fill' : 'eye-fill'} text-blue"></i>
                        <div class="flex-grow-1">
                            <p class="mb-xs">
                                ${activity.type === 'watchlist' ? 'Added to watchlist' : activity.type === 'favorite' ? 'Added to favorites' : 'Watched'}
                                <strong>${activity.content.title}</strong>
                            </p>
                            <p class="text-xs text-muted">${activity.time}</p>
                        </div>
                        ${activity.content.poster_path ? `
                            <img src="${activity.content.poster_path}" 
                                 alt="${activity.content.title}"
                                 class="rounded"
                                 style="width: 60px; height: 90px; object-fit: cover;"
                                 onclick="navigateToContentDetails(${activity.content.id})">
                        ` : ''}
                    </div>
                </div>
            `).join('') || '<p class="text-center text-muted">No recent activity</p>';
        }

        function renderContentGrid(gridId, items) {
            const grid = document.getElementById(gridId);

            if (items.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted col-span-full">No content yet</p>';
                return;
            }

            grid.innerHTML = items.map(item => `
                <div class="content-card" onclick="navigateToContentDetails(${item.id})">
                    <div class="content-card__image-wrapper">
                        <img src="${item.poster_path}" 
                             alt="${item.title}" 
                             class="content-card__image"
                             loading="lazy">
                    </div>
                    <div class="content-card__body">
                        <h3 class="content-card__title">${item.title}</h3>
                        <div class="content-card__meta">
                            <span class="content-card__rating">
                                <i class="bi bi-star-fill content-card__rating-star"></i>
                                ${item.rating || 'N/A'}
                            </span>
                            <span>${item.content_type}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function savePreferences() {
            try {
                const genres = Array.from(document.querySelectorAll('input[name="genre"]:checked')).map(cb => cb.value);
                const languages = Array.from(document.querySelectorAll('input[name="language"]:checked')).map(cb => cb.value);

                // In production, this would update via API
                const user = auth.getUser();
                user.preferred_genres = genres;
                user.preferred_languages = languages;
                Storage.setUser(user);

                showToast('Preferences saved successfully', 'success');
            } catch (error) {
                showToast('Failed to save preferences', 'error');
            }
        }

        function clearRecentlyViewed() {
            if (confirm('Are you sure you want to clear your viewing history?')) {
                Storage.clearSearchHistory();
                document.getElementById('recentlyViewedGrid').innerHTML = '<p class="text-center text-muted col-span-full">No content yet</p>';
                showToast('Viewing history cleared', 'success');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>

</html>