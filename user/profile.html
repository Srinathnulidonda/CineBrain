<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CineBrain</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="View your CineBrain profile, watch statistics, and personalized recommendations.">
    <meta name="keywords" content="user profile, watch history, statistics, recommendations">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- CSS Files -->
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/layouts.css" rel="stylesheet">
    <link href="/css/animations.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
</head>

<body data-page="profile">

    <!-- Navigation -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Profile Header -->
        <section class="profile-header position-relative overflow-hidden">
            <div class="profile-banner position-absolute top-0 start-0 w-100 h-100">
                <img src="" alt="" class="banner-image w-100 h-100 object-fit-cover opacity-30">
                <div
                    class="banner-overlay position-absolute top-0 start-0 w-100 h-100 bg-gradient-to-b from-transparent to-black">
                </div>
            </div>

            <div class="container position-relative py-5">
                <div class="row align-items-end">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-end">
                            <!-- Profile Avatar -->
                            <div class="profile-avatar-container me-4">
                                <div
                                    class="profile-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                                    <span class="avatar-letter fs-1 fw-bold">U</span>
                                </div>
                                <button class="btn btn-sm btn-primary avatar-edit-btn position-absolute bottom-0 end-0"
                                    title="Change Avatar">
                                    <i class="bi bi-camera"></i>
                                </button>
                            </div>

                            <!-- Profile Info -->
                            <div class="profile-info text-white mb-3">
                                <h1 class="profile-username fw-bold mb-2">Username</h1>
                                <p class="profile-email text-gray-300 mb-2">
                                    <i class="bi bi-envelope me-2"></i>
                                    <span class="email-text">email@example.com</span>
                                </p>
                                <p class="profile-member-since text-gray-400">
                                    <i class="bi bi-calendar3 me-2"></i>
                                    Member since <span class="join-date">January 2024</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 text-lg-end">
                        <a href="/user/settings.html" class="btn btn-outline-light">
                            <i class="bi bi-gear me-2"></i>Edit Profile
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Content -->
        <div class="container py-5">

            <!-- Statistics Overview -->
            <section class="stats-section mb-5">
                <h2 class="text-white fw-bold mb-4">
                    <i class="bi bi-graph-up me-2"></i>Your Statistics
                </h2>

                <div class="row g-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card text-center">
                            <div class="stat-icon mb-3">
                                <i class="bi bi-film text-primary fs-1"></i>
                            </div>
                            <div class="stat-number">0</div>
                            <div class="stat-label">Movies Watched</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card text-center">
                            <div class="stat-icon mb-3">
                                <i class="bi bi-tv text-purple-500 fs-1"></i>
                            </div>
                            <div class="stat-number">0</div>
                            <div class="stat-label">TV Shows</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card text-center">
                            <div class="stat-icon mb-3">
                                <i class="bi bi-heart-fill text-danger fs-1"></i>
                            </div>
                            <div class="stat-number">0</div>
                            <div class="stat-label">Favorites</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card text-center">
                            <div class="stat-icon mb-3">
                                <i class="bi bi-bookmark-fill text-warning fs-1"></i>
                            </div>
                            <div class="stat-number">0</div>
                            <div class="stat-label">Watchlist</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Favorite Genres -->
            <section class="genres-section mb-5">
                <h2 class="text-white fw-bold mb-4">
                    <i class="bi bi-palette me-2"></i>Favorite Genres
                </h2>

                <div class="genres-chart-container bg-theater rounded-3 p-4">
                    <canvas id="genresChart" height="100"></canvas>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="activity-section mb-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-white fw-bold mb-0">
                        <i class="bi bi-clock-history me-2"></i>Recent Activity
                    </h2>
                    <a href="/user/activity.html" class="btn btn-outline-primary">
                        View All <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>

                <div class="activity-list">
                    <!-- Loading placeholder -->
                    <div class="activity-loading text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading activity...</span>
                        </div>
                    </div>

                    <!-- Activity items will be populated here -->
                </div>
            </section>

            <!-- Personal Recommendations -->
            <section class="recommendations-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-white fw-bold mb-0">
                        <i class="bi bi-brain me-2"></i>Recommended For You
                    </h2>
                    <button class="btn btn-outline-primary refresh-recommendations">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>

                <div class="recommendations-grid content-grid">
                    <!-- Loading placeholders -->
                    <div class="skeleton" style="height: 420px; border-radius: 12px;"></div>
                    <div class="skeleton" style="height: 420px; border-radius: 12px;"></div>
                    <div class="skeleton" style="height: 420px; border-radius: 12px;"></div>
                    <div class="skeleton" style="height: 420px; border-radius: 12px;"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Trailer Modal Container -->
    <div id="trailer-modal-container"></div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Profile Page Controller
        class ProfilePage {
            constructor() {
                this.user = null;
                this.statistics = null;
                this.genresChart = null;
                this.isOwnProfile = false;
                this.profileUsername = null;
                this.initialize();
            }

            async initialize() {
                try {
                    // Check authentication
                    if (!auth.isAuthenticated()) {
                        window.location.href = '/auth/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                        return;
                    }

                    // Get profile username from URL
                    this.profileUsername = this.getUsernameFromURL();

                    // Check if viewing own profile
                    const currentUser = auth.getCurrentUser();
                    this.isOwnProfile = !this.profileUsername || this.profileUsername === currentUser.username;

                    // Load navigation components
                    await this.loadComponents();

                    // Load profile data
                    await this.loadProfileData();

                    // Setup event listeners
                    this.setupEventListeners();

                    // Load sections
                    await Promise.all([
                        this.loadStatistics(),
                        this.loadRecentActivity(),
                        this.loadRecommendations()
                    ]);

                    // Initialize genre chart
                    this.initializeGenreChart();

                    console.log('Profile page loaded successfully');

                } catch (error) {
                    console.error('Error initializing profile page:', error);
                    this.showError('Failed to load profile data');
                }
            }

            getUsernameFromURL() {
                const pathParts = window.location.pathname.split('/');
                // URL format: /{username}/profile
                if (pathParts.length >= 3 && pathParts[2] === 'profile') {
                    return pathParts[1];
                }
                return null;
            }

            async loadComponents() {
                try {
                    // Load topbar
                    const topbarResponse = await fetch('/components/layout/topbar.html');
                    const topbarHTML = await topbarResponse.text();
                    document.getElementById('topbar-container').innerHTML = topbarHTML;

                    // Load mobile navigation
                    const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
                    const mobileNavHTML = await mobileNavResponse.text();
                    document.getElementById('mobile-nav-container').innerHTML = mobileNavHTML;

                    // Load trailer modal
                    const trailerModalResponse = await fetch('/components/modals/trailer-modal.html');
                    const trailerModalHTML = await trailerModalResponse.text();
                    document.getElementById('trailer-modal-container').innerHTML = trailerModalHTML;

                } catch (error) {
                    console.error('Error loading components:', error);
                }
            }

            async loadProfileData() {
                try {
                    if (this.isOwnProfile) {
                        // Load current user's profile
                        this.user = auth.getCurrentUser();
                        this.updateProfileUI();
                    } else {
                        // In a real implementation, fetch other user's public profile
                        // For now, show error
                        this.showError('User profile not found');
                        return;
                    }

                    // Update page title
                    document.title = `${this.user.username} - Profile - CineBrain`;

                } catch (error) {
                    console.error('Error loading profile data:', error);
                    this.showError('Failed to load profile information');
                }
            }

            updateProfileUI() {
                // Update avatar
                const avatarLetter = document.querySelector('.avatar-letter');
                if (avatarLetter) {
                    avatarLetter.textContent = this.user.username.charAt(0).toUpperCase();
                }

                // Update username
                const usernameElement = document.querySelector('.profile-username');
                if (usernameElement) {
                    usernameElement.textContent = this.user.username;
                }

                // Update email
                const emailElement = document.querySelector('.email-text');
                if (emailElement) {
                    emailElement.textContent = this.user.email;
                }

                // Update join date
                const joinDateElement = document.querySelector('.join-date');
                if (joinDateElement && this.user.created_at) {
                    const joinDate = new Date(this.user.created_at);
                    joinDateElement.textContent = joinDate.toLocaleDateString('en-US', {
                        month: 'long',
                        year: 'numeric'
                    });
                }

                // Update banner with random gradient
                this.updateProfileBanner();
            }

            updateProfileBanner() {
                const bannerImage = document.querySelector('.banner-image');
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
                ];

                const randomGradient = gradients[Math.floor(Math.random() * gradients.length)];
                bannerImage.style.background = randomGradient;
                bannerImage.style.opacity = '0.3';
            }

            async loadStatistics() {
                try {
                    // Get user's watchlist and favorites
                    const [watchlistResponse, favoritesResponse] = await Promise.all([
                        api.getWatchlist(),
                        api.getFavorites()
                    ]);

                    const watchlist = watchlistResponse.watchlist || [];
                    const favorites = favoritesResponse.favorites || [];

                    // Count by type
                    const movieCount = watchlist.filter(item => item.content_type === 'movie').length;
                    const tvCount = watchlist.filter(item => item.content_type === 'tv').length;

                    // Update statistics
                    this.updateStatCard('Movies Watched', movieCount);
                    this.updateStatCard('TV Shows', tvCount);
                    this.updateStatCard('Favorites', favorites.length);
                    this.updateStatCard('Watchlist', watchlist.length);

                    // Store for genre chart
                    this.statistics = {
                        watchlist,
                        favorites,
                        movieCount,
                        tvCount
                    };

                } catch (error) {
                    console.error('Error loading statistics:', error);
                }
            }

            updateStatCard(label, value) {
                const statCards = document.querySelectorAll('.stat-card');
                statCards.forEach(card => {
                    const cardLabel = card.querySelector('.stat-label');
                    if (cardLabel && cardLabel.textContent === label) {
                        const statNumber = card.querySelector('.stat-number');
                        if (statNumber) {
                            // Animate number
                            this.animateNumber(statNumber, 0, value, 1000);
                        }
                    }
                });
            }

            animateNumber(element, start, end, duration) {
                const startTime = performance.now();
                const updateNumber = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const current = Math.floor(start + (end - start) * progress);
                    element.textContent = current;

                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    }
                };
                requestAnimationFrame(updateNumber);
            }

            async loadRecentActivity() {
                try {
                    const activityContainer = document.querySelector('.activity-list');

                    // In a real implementation, we would fetch user's viewing history
                    // For now, show a message
                    activityContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-clock-history text-muted fs-1 mb-3"></i>
                        <h5 class="text-white mb-2">No Recent Activity</h5>
                        <p class="text-muted mb-4">Your viewing history will appear here</p>
                        <a href="/content/trending.html" class="btn btn-primary">
                            <i class="bi bi-compass me-2"></i>Explore Content
                        </a>
                    </div>
                `;

                } catch (error) {
                    console.error('Error loading activity:', error);
                }
            }

            async loadRecommendations() {
                try {
                    const response = await api.getMLPersonalizedRecommendations({ limit: 8 });
                    const recommendations = response.recommendations || [];

                    const container = document.querySelector('.recommendations-grid');

                    if (recommendations.length === 0) {
                        container.innerHTML = `
                        <div class="col-span-full text-center py-5">
                            <i class="bi bi-brain text-muted fs-1 mb-3"></i>
                            <h5 class="text-white mb-2">Building Your Recommendations</h5>
                            <p class="text-muted">Watch more content to get personalized recommendations</p>
                        </div>
                    `;
                        return;
                    }

                    container.innerHTML = recommendations.map(item => this.createContentCard(item)).join('');
                    this.initializeContentCards(container);

                } catch (error) {
                    console.error('Error loading recommendations:', error);
                    // Fallback to trending content
                    this.loadFallbackRecommendations();
                }
            }

            async loadFallbackRecommendations() {
                try {
                    const response = await api.getTrending({ limit: 8 });
                    const recommendations = response.recommendations || [];

                    const container = document.querySelector('.recommendations-grid');
                    container.innerHTML = recommendations.map(item => this.createContentCard(item)).join('');
                    this.initializeContentCards(container);

                } catch (error) {
                    console.error('Error loading fallback recommendations:', error);
                }
            }

            initializeGenreChart() {
                if (!this.statistics || !this.statistics.watchlist.length) {
                    const chartContainer = document.querySelector('.genres-chart-container');
                    chartContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">Watch more content to see your genre preferences</p>
                    </div>
                `;
                    return;
                }

                // Count genres from watchlist and favorites
                const genreCounts = {};
                const allContent = [...this.statistics.watchlist, ...this.statistics.favorites];

                allContent.forEach(item => {
                    if (item.genres) {
                        item.genres.forEach(genre => {
                            genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                        });
                    }
                });

                // Sort and get top genres
                const sortedGenres = Object.entries(genreCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6);

                if (sortedGenres.length === 0) {
                    return;
                }

                // Create chart
                const ctx = document.getElementById('genresChart').getContext('2d');
                this.genresChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedGenres.map(([genre]) => genre),
                        datasets: [{
                            label: 'Content Count',
                            data: sortedGenres.map(([, count]) => count),
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(139, 92, 246, 1)',
                                'rgba(236, 72, 153, 1)',
                                'rgba(245, 158, 11, 1)',
                                'rgba(16, 185, 129, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            setupEventListeners() {
                // Avatar edit button (placeholder)
                const avatarEditBtn = document.querySelector('.avatar-edit-btn');
                if (avatarEditBtn) {
                    avatarEditBtn.addEventListener('click', () => {
                        this.showToast('Avatar customization coming soon!', 'info');
                    });
                }

                // Refresh recommendations
                const refreshBtn = document.querySelector('.refresh-recommendations');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        refreshBtn.disabled = true;
                        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spinner-spin"></i>Loading...';

                        await this.loadRecommendations();

                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
                    });
                }
            }

            createContentCard(item) {
                return `
                <div class="content-card bg-theater rounded-3 overflow-hidden shadow-lg hover-lift position-relative" 
                     data-content-id="${item.id}">
                    <div class="content-card-poster position-relative">
                        <img src="${item.poster_path || IMAGE_CONFIG.PLACEHOLDER}" 
                             alt="${item.title}" 
                             class="w-100 h-100 object-fit-cover"
                             loading="lazy">
                        
                        <div class="rating-badge position-absolute top-0 end-0 m-2">
                            <span class="rating-value ${UTILS.getRatingColorClass(item.rating)}">${UTILS.formatRating(item.rating)}</span>
                        </div>
                        
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="type-badge type-badge-${item.content_type}">${item.content_type.toUpperCase()}</span>
                        </div>
                        
                        ${item.youtube_trailer ? `
                            <div class="position-absolute inset-0 d-flex align-items-center justify-content-center bg-black bg-opacity-50 opacity-0 transition-opacity duration-300 play-overlay">
                                <button class="btn btn-primary btn-lg rounded-circle play-trailer" 
                                        data-video-id="${this.extractVideoId(item.youtube_trailer)}" 
                                        data-title="${item.title}"
                                        data-content-id="${item.id}">
                                    <i class="bi bi-play-fill fs-3"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <div class="p-3">
                        <h6 class="card-title text-white mb-2 text-truncate" title="${item.title}">
                            ${item.title}
                        </h6>
                        
                        ${item.genres ? `
                            <div class="genre-container mb-2">
                                ${item.genres.slice(0, 2).map(genre => `
                                    <span class="genre-chip ${UTILS.getGenreColorClass(genre)}">${genre}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="d-flex justify-content-between align-items-center text-sm text-gray-400 mb-2">
                            <span class="release-date">${item.release_date ? new Date(item.release_date).getFullYear() : 'TBA'}</span>
                            <span class="content-type-text">${item.content_type.charAt(0).toUpperCase() + item.content_type.slice(1)}</span>
                        </div>
                        
                        <p class="card-text text-gray-300 text-sm mb-3" style="font-size: 0.875rem; line-height: 1.4;">
                            ${UTILS.truncateText(item.overview, 100)}
                        </p>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-fill add-to-watchlist" 
                                    data-content-id="${item.id}" title="Add to Watchlist">
                                <i class="bi bi-bookmark me-1"></i>
                                <span class="d-none d-md-inline">Watchlist</span>
                            </button>
                            <button class="btn btn-outline-danger btn-sm flex-fill add-to-favorites" 
                                    data-content-id="${item.id}" title="Add to Favorites">
                                <i class="bi bi-heart me-1"></i>
                                <span class="d-none d-md-inline">Favorite</span>
                            </button>
                            <a href="/content/details.html?id=${item.id}" 
                               class="btn btn-primary btn-sm" title="View Details">
                                <i class="bi bi-info-circle"></i>
                                <span class="d-none d-lg-inline ms-1">Details</span>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            }

            initializeContentCards(container) {
                // Add hover effects
                const cards = container.querySelectorAll('.content-card');
                cards.forEach(card => {
                    card.addEventListener('mouseenter', () => {
                        const playOverlay = card.querySelector('.play-overlay');
                        if (playOverlay) {
                            playOverlay.classList.remove('opacity-0');
                            playOverlay.classList.add('opacity-100');
                        }
                    });

                    card.addEventListener('mouseleave', () => {
                        const playOverlay = card.querySelector('.play-overlay');
                        if (playOverlay) {
                            playOverlay.classList.add('opacity-0');
                            playOverlay.classList.remove('opacity-100');
                        }
                    });

                    // Watchlist and favorites functionality
                    const watchlistBtn = card.querySelector('.add-to-watchlist');
                    const favoritesBtn = card.querySelector('.add-to-favorites');

                    if (watchlistBtn) {
                        watchlistBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleWatchlistAction(watchlistBtn, card.dataset.contentId);
                        });
                    }

                    if (favoritesBtn) {
                        favoritesBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleFavoritesAction(favoritesBtn, card.dataset.contentId);
                        });
                    }

                    // Card click to details
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('button, a')) {
                            window.location.href = `/content/details.html?id=${card.dataset.contentId}`;
                        }
                    });
                });
            }

            async handleWatchlistAction(btn, contentId) {
                try {
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                    btn.disabled = true;

                    await auth.addToWatchlist(contentId);

                    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Added';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');

                    // Update statistics
                    await this.loadStatistics();

                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('Error adding to watchlist:', error);
                    this.showToast('Failed to add to watchlist', 'error');
                }
            }

            async handleFavoritesAction(btn, contentId) {
                try {
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                    btn.disabled = true;

                    await auth.addToFavorites(contentId);

                    btn.innerHTML = '<i class="bi bi-heart-fill me-1"></i>Loved';
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');

                    // Update statistics
                    await this.loadStatistics();

                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-danger');
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('Error adding to favorites:', error);
                    this.showToast('Failed to add to favorites', 'error');
                }
            }

            extractVideoId(url) {
                if (!url) return null;
                const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
                return match ? match[1] : null;
            }

            showError(message) {
                const container = document.querySelector('.main-content');
                container.innerHTML = `
                <div class="container py-5">
                    <div class="row justify-content-center">
                        <div class="col-md-6 text-center">
                            <i class="bi bi-exclamation-triangle text-warning fs-1 mb-4"></i>
                            <h3 class="text-white mb-3">Error</h3>
                            <p class="text-muted mb-4">${message}</p>
                            <a href="/" class="btn btn-primary">
                                <i class="bi bi-house me-2"></i>Go Home
                            </a>
                        </div>
                    </div>
                </div>
            `;
            }

            showToast(message, type = 'info') {
                const toastClass = type === 'success' ? 'alert-success' :
                    type === 'error' ? 'alert-danger' :
                        type === 'warning' ? 'alert-warning' : 'alert-info';

                const toast = document.createElement('div');
                toast.className = `alert ${toastClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 5000);
            }
        }

        // Initialize profile page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            window.profilePage = new ProfilePage();
        });
    </script>

    <style>
        /* Profile Page Specific Styles */
        .profile-header {
            background: var(--hero-gradient);
            min-height: 350px;
            position: relative;
        }

        .profile-banner {
            z-index: 1;
        }

        .banner-overlay {
            background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.8) 100%);
        }

        .profile-avatar-container {
            position: relative;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            font-size: 3rem;
        }

        .avatar-edit-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Statistics Cards */
        .stat-card {
            background: var(--theater-dark);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            opacity: 0.8;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: rgba(156, 163, 175, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Genre Chart */
        .genres-chart-container {
            border: 1px solid rgba(139, 92, 246, 0.2);
            min-height: 200px;
        }

        /* Activity List */
        .activity-item {
            background: var(--theater-dark);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateX(4px);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .profile-header {
                min-height: 300px;
            }

            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }

            .profile-username {
                font-size: 1.5rem;
            }

            .stat-card {
                padding: 1.5rem 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }
        }

        /* Spinner Animation */
        .spinner-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>