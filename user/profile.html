<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Profile - CineBrain</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body class="bg-gray-900 text-white">
    <!-- Fixed Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="pt-20 pb-20 md:pb-8">
        <div class="container-fluid px-3 px-md-4">
            <!-- Profile Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card glass-effect border-0">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-md-3 text-center text-md-start mb-3 mb-md-0">
                                    <img id="profileAvatar" src="" alt="Profile" class="rounded-circle mb-3" width="120"
                                        height="120">
                                    <div>
                                        <button class="btn btn-outline-light btn-sm"
                                            onclick="profileHandler.changeAvatar()">
                                            <i class="fas fa-camera me-2"></i>Change Avatar
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h2 id="profileUsername" class="text-white fw-bold mb-1">Loading...</h2>
                                            <p id="profileEmail" class="text-muted mb-2">Loading...</p>
                                            <div class="d-flex gap-2">
                                                <span class="badge bg-primary" id="userRole">User</span>
                                                <span class="badge bg-success" id="memberSince">Member since</span>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-light" onclick="profileHandler.editProfile()">
                                            <i class="fas fa-edit me-2"></i>Edit Profile
                                        </button>
                                    </div>

                                    <!-- Stats -->
                                    <div class="row text-center" id="profileStats">
                                        <div class="col-6 col-md-3 mb-3 mb-md-0">
                                            <div class="fw-bold text-danger fs-4" id="watchlistCount">0</div>
                                            <small class="text-muted">Watchlist</small>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3 mb-md-0">
                                            <div class="fw-bold text-warning fs-4" id="favoritesCount">0</div>
                                            <small class="text-muted">Favorites</small>
                                        </div>
                                        <div class="col-6 col-md-3 mb-3 mb-md-0">
                                            <div class="fw-bold text-info fs-4" id="interactionsCount">0</div>
                                            <small class="text-muted">Interactions</small>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="fw-bold text-success fs-4" id="ratingsCount">0</div>
                                            <small class="text-muted">Ratings</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-pills nav-fill glass-effect mb-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="pill"
                                data-bs-target="#overview" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activity-tab" data-bs-toggle="pill" data-bs-target="#activity"
                                type="button" role="tab">Activity</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preferences-tab" data-bs-toggle="pill"
                                data-bs-target="#preferences" type="button" role="tab">Preferences</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="recommendations-tab" data-bs-toggle="pill"
                                data-bs-target="#recommendations" type="button" role="tab">For You</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="profileTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <!-- Recent Activity -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0 h-100">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Recent Activity</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentActivity">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading activity...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Access -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0 h-100">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Quick Access</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <a href="watchlist.html" class="btn btn-outline-light text-start">
                                                    <i class="fas fa-bookmark me-3"></i>
                                                    <span>My Watchlist</span>
                                                    <span class="badge bg-danger ms-auto"
                                                        id="quickWatchlistCount">0</span>
                                                </a>
                                                <a href="favorites.html" class="btn btn-outline-light text-start">
                                                    <i class="fas fa-heart me-3"></i>
                                                    <span>My Favorites</span>
                                                    <span class="badge bg-warning ms-auto"
                                                        id="quickFavoritesCount">0</span>
                                                </a>
                                                <a href="activity.html" class="btn btn-outline-light text-start">
                                                    <i class="fas fa-history me-3"></i>
                                                    <span>Watch History</span>
                                                    <span class="badge bg-info ms-auto" id="quickHistoryCount">0</span>
                                                </a>
                                                <a href="settings.html" class="btn btn-outline-light text-start">
                                                    <i class="fas fa-cog me-3"></i>
                                                    <span>Settings</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Tab -->
                        <div class="tab-pane fade" id="activity" role="tabpanel">
                            <div class="card glass-effect border-0">
                                <div class="card-body">
                                    <div id="activityContent">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-danger mb-3" role="status"></div>
                                            <h5 class="text-white">Loading activity...</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences" role="tabpanel">
                            <div class="card glass-effect border-0">
                                <div class="card-body">
                                    <form id="preferencesForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-4">
                                                <h5 class="text-white mb-3">Language Preferences</h5>
                                                <div id="languagePreferences">
                                                    <!-- Will be populated dynamically -->
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-4">
                                                <h5 class="text-white mb-3">Genre Preferences</h5>
                                                <div id="genrePreferences">
                                                    <!-- Will be populated dynamically -->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-primary-custom">
                                                <i class="fas fa-save me-2"></i>Save Preferences
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations Tab -->
                        <div class="tab-pane fade" id="recommendations" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="text-white mb-0">Personalized Recommendations</h5>
                                        <button class="btn btn-outline-light btn-sm"
                                            onclick="profileHandler.refreshRecommendations()">
                                            <i class="fas fa-refresh me-2"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="personalizedRecommendations">
                                <div class="col-12 text-center py-5">
                                    <div class="spinner-border text-danger mb-3" role="status"></div>
                                    <h5 class="text-white">Loading personalized recommendations...</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass-effect">
                <div class="modal-header">
                    <h5 class="modal-title text-white">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label text-white">Username</label>
                            <input type="text" class="form-control search-input" id="editUsername" readonly>
                            <div class="form-text text-muted">Username cannot be changed</div>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label text-white">Email</label>
                            <input type="email" class="form-control search-input" id="editEmail" readonly>
                            <div class="form-text text-muted">Email cannot be changed</div>
                        </div>
                        <div class="mb-3">
                            <label for="editLocation" class="form-label text-white">Location</label>
                            <input type="text" class="form-control search-input" id="editLocation"
                                placeholder="Enter your location">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" onclick="profileHandler.saveProfile()">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        class ProfileHandler {
            constructor() {
                this.userData = null;
                this.watchlistData = [];
                this.favoritesData = [];
                this.recommendations = [];
                this.init();
            }

            init() {
                this.checkAuthentication();
                this.loadUserData();
                this.setupEventListeners();
            }

            checkAuthentication() {
                const token = Utils.getStorage('auth_token');
                if (!token) {
                    window.location.href = '../auth/login.html';
                    return;
                }
            }

            setupEventListeners() {
                // Tab change events
                document.querySelectorAll('#profileTabs button').forEach(tab => {
                    tab.addEventListener('shown.bs.tab', (event) => {
                        const target = event.target.getAttribute('data-bs-target');
                        if (target === '#activity') {
                            this.loadActivityData();
                        } else if (target === '#preferences') {
                            this.loadPreferences();
                        } else if (target === '#recommendations') {
                            this.loadPersonalizedRecommendations();
                        }
                    });
                });

                // Preferences form
                document.getElementById('preferencesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePreferences();
                });
            }

            async loadUserData() {
                try {
                    this.userData = Utils.getStorage('user_data');

                    if (!this.userData) {
                        throw new Error('No user data found');
                    }

                    this.renderUserProfile();
                    await this.loadUserStats();

                } catch (error) {
                    console.error('Failed to load user data:', error);
                    Utils.showToast('Failed to load profile data', 'error');
                }
            }

            renderUserProfile() {
                const userData = this.userData;

                // Profile info
                document.getElementById('profileUsername').textContent = userData.username;
                document.getElementById('profileEmail').textContent = userData.email;

                // Avatar
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.username)}&background=E50914&color=fff&size=120&bold=true`;
                document.getElementById('profileAvatar').src = avatarUrl;

                // Role badge
                const roleElement = document.getElementById('userRole');
                if (userData.is_admin) {
                    roleElement.textContent = 'Admin';
                    roleElement.className = 'badge bg-warning';
                } else {
                    roleElement.textContent = 'User';
                    roleElement.className = 'badge bg-primary';
                }

                // Member since (we don't have this data, so we'll show a default)
                document.getElementById('memberSince').textContent = 'Member since 2024';
            }

            async loadUserStats() {
                try {
                    // Load watchlist and favorites in parallel
                    const [watchlistResponse, favoritesResponse] = await Promise.all([
                        apiClient.getWatchlist(),
                        apiClient.getFavorites()
                    ]);

                    this.watchlistData = watchlistResponse.watchlist || [];
                    this.favoritesData = favoritesResponse.favorites || [];

                    // Update stats
                    document.getElementById('watchlistCount').textContent = this.watchlistData.length;
                    document.getElementById('favoritesCount').textContent = this.favoritesData.length;

                    // Update quick access counts
                    document.getElementById('quickWatchlistCount').textContent = this.watchlistData.length;
                    document.getElementById('quickFavoritesCount').textContent = this.favoritesData.length;

                    // For interactions and ratings, we'll simulate since the API doesn't provide this directly
                    document.getElementById('interactionsCount').textContent = this.watchlistData.length + this.favoritesData.length;
                    document.getElementById('ratingsCount').textContent = Math.floor((this.watchlistData.length + this.favoritesData.length) * 0.6);
                    document.getElementById('quickHistoryCount').textContent = Math.floor(this.watchlistData.length * 1.5);

                    this.renderRecentActivity();

                } catch (error) {
                    console.error('Failed to load user stats:', error);
                    Utils.showToast('Failed to load user statistics', 'error');
                }
            }

            renderRecentActivity() {
                const recentActivityContainer = document.getElementById('recentActivity');

                // Combine recent watchlist and favorites
                const recentItems = [...this.watchlistData.slice(0, 3), ...this.favoritesData.slice(0, 2)]
                    .slice(0, 5);

                if (recentItems.length === 0) {
                    recentActivityContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-history text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted">No recent activity</p>
                        </div>
                    `;
                    return;
                }

                const activityHtml = recentItems.map((item, index) => `
                    <div class="d-flex align-items-center mb-3" onclick="window.location.href='../content/details.html?id=${item.id}'">
                        <img src="${Utils.getImageUrl(item.poster_path, 'w92')}" 
                             alt="${item.title}" class="rounded me-3" width="50" height="75"
                             onerror="this.src='${Utils.getImageUrl(null)}'">
                        <div class="flex-grow-1">
                            <h6 class="text-white mb-1">${item.title}</h6>
                            <small class="text-muted">
                                ${index < 3 ? 'Added to watchlist' : 'Added to favorites'} recently
                            </small>
                        </div>
                    </div>
                `).join('');

                recentActivityContainer.innerHTML = activityHtml;
            }

            async loadActivityData() {
                const activityContainer = document.getElementById('activityContent');

                try {
                    // Since we don't have a specific activity endpoint, we'll show watchlist and favorites
                    const allActivity = [
                        ...this.watchlistData.map(item => ({ ...item, activity_type: 'watchlist' })),
                        ...this.favoritesData.map(item => ({ ...item, activity_type: 'favorite' }))
                    ];

                    if (allActivity.length === 0) {
                        activityContainer.innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-history text-muted mb-3" style="font-size: 4rem;"></i>
                                <h5 class="text-white mb-2">No Activity Yet</h5>
                                <p class="text-muted">Start watching and rating content to see your activity here.</p>
                            </div>
                        `;
                        return;
                    }

                    const activityHtml = allActivity.map(item => `
                        <div class="d-flex align-items-center mb-3 p-3 glass-effect rounded" 
                             onclick="window.location.href='../content/details.html?id=${item.id}'">
                            <img src="${Utils.getImageUrl(item.poster_path, 'w92')}" 
                                 alt="${item.title}" class="rounded me-3" width="60" height="90"
                                 onerror="this.src='${Utils.getImageUrl(null)}'">
                            <div class="flex-grow-1">
                                <h6 class="text-white mb-1">${item.title}</h6>
                                <p class="text-muted mb-1">${Utils.formatContentType(item.content_type)}</p>
                                <small class="text-muted">
                                    ${item.activity_type === 'watchlist' ? 'Added to watchlist' : 'Added to favorites'}
                                </small>
                            </div>
                            <div class="text-end">
                                ${item.rating ? `
                                    <span class="${Utils.formatRating(item.rating).className}">
                                        ${Utils.formatRating(item.rating).value}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');

                    activityContainer.innerHTML = activityHtml;

                } catch (error) {
                    console.error('Failed to load activity:', error);
                    activityContainer.innerHTML = Components.createErrorState('Failed to load activity');
                }
            }

            loadPreferences() {
                const userData = this.userData;

                // Language preferences
                const languages = ['english', 'hindi', 'telugu', 'tamil', 'kannada', 'malayalam'];
                const userLanguages = userData.preferred_languages || [];

                const languageHtml = languages.map(lang => `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${lang}" 
                               id="pref_lang_${lang}" ${userLanguages.includes(lang) ? 'checked' : ''}>
                        <label class="form-check-label text-white" for="pref_lang_${lang}">
                            ${lang.charAt(0).toUpperCase() + lang.slice(1)}
                        </label>
                    </div>
                `).join('');

                document.getElementById('languagePreferences').innerHTML = languageHtml;

                // Genre preferences
                const genres = ['Action', 'Comedy', 'Drama', 'Romance', 'Thriller', 'Horror', 'Sci-Fi', 'Fantasy', 'Animation', 'Documentary'];
                const userGenres = userData.preferred_genres || [];

                const genreHtml = genres.map(genre => `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${genre}" 
                               id="pref_genre_${genre}" ${userGenres.includes(genre) ? 'checked' : ''}>
                        <label class="form-check-label text-white" for="pref_genre_${genre}">
                            ${genre}
                        </label>
                    </div>
                `).join('');

                document.getElementById('genrePreferences').innerHTML = genreHtml;
            }

            async savePreferences() {
                try {
                    const selectedLanguages = Array.from(
                        document.querySelectorAll('#languagePreferences input:checked')
                    ).map(input => input.value);

                    const selectedGenres = Array.from(
                        document.querySelectorAll('#genrePreferences input:checked')
                    ).map(input => input.value);

                    // Update user data in storage
                    this.userData.preferred_languages = selectedLanguages;
                    this.userData.preferred_genres = selectedGenres;
                    Utils.setStorage('user_data', this.userData);

                    Utils.showToast('Preferences saved successfully', 'success');

                } catch (error) {
                    console.error('Failed to save preferences:', error);
                    Utils.showToast('Failed to save preferences', 'error');
                }
            }

            async loadPersonalizedRecommendations() {
                const container = document.getElementById('personalizedRecommendations');

                try {
                    const response = await apiClient.getPersonalizedRecommendations(20);
                    this.recommendations = response.recommendations || [];

                    if (this.recommendations.length === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-robot text-muted mb-3" style="font-size: 4rem;"></i>
                                <h5 class="text-white mb-2">No Personalized Recommendations</h5>
                                <p class="text-muted">Interact with more content to get personalized recommendations.</p>
                            </div>
                        `;
                        return;
                    }

                    const recommendationsHtml = this.recommendations.map(item => `
                        <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                            ${Components.createContentCard(item)}
                        </div>
                    `).join('');

                    container.innerHTML = recommendationsHtml;

                } catch (error) {
                    console.error('Failed to load recommendations:', error);
                    container.innerHTML = `
                        <div class="col-12">
                            ${Components.createErrorState('Failed to load personalized recommendations')}
                        </div>
                    `;
                }
            }

            async refreshRecommendations() {
                document.getElementById('personalizedRecommendations').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-danger mb-3" role="status"></div>
                        <h5 class="text-white">Refreshing recommendations...</h5>
                    </div>
                `;

                await this.loadPersonalizedRecommendations();
            }

            editProfile() {
                // Fill modal with current data
                document.getElementById('editUsername').value = this.userData.username;
                document.getElementById('editEmail').value = this.userData.email;
                document.getElementById('editLocation').value = this.userData.location || '';

                const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
                modal.show();
            }

            saveProfile() {
                // Since the backend doesn't have a profile update endpoint, we'll just show a message
                const location = document.getElementById('editLocation').value;

                // Update local storage
                this.userData.location = location;
                Utils.setStorage('user_data', this.userData);

                Utils.showToast('Profile updated successfully', 'success');

                const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                modal.hide();
            }

            changeAvatar() {
                // Since we're using UI Avatars, we can't change the actual avatar
                // But we can show a message about how it works
                Utils.showToast('Avatar is automatically generated from your username', 'info');
            }
        }

        // Initialize profile handler
        document.addEventListener('DOMContentLoaded', () => {
            window.profileHandler = new ProfileHandler();
        });
    </script>
</body>

</html>