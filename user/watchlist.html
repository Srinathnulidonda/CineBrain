<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Watchlist - CineScope</title>
    <meta name="description" content="Your personal watchlist of movies, TV shows, and anime to watch later.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Watchlist...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">üìã My Watchlist</h1>
                <p class="text-gray-400">Movies and shows you want to watch</p>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div class="stats-card min-w-0">
                    <div class="stats-value text-2xl" id="watchlistCount">0</div>
                    <div class="stats-label">Items</div>
                </div>
                <button class="btn btn-secondary" onclick="clearWatchlist()">
                    Clear All
                </button>
            </div>
        </div>

        <!-- Filters and Sort -->
        <div class="card mb-8">
            <div class="card-content">
                <div class="grid grid-1 md:grid-4 gap-6">
                    <div>
                        <label class="form-label">Filter by Type</label>
                        <select id="typeFilter" class="form-input">
                            <option value="">All Types</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Filter by Genre</label>
                        <select id="genreFilter" class="form-input">
                            <option value="">All Genres</option>
                            <option value="action">Action</option>
                            <option value="comedy">Comedy</option>
                            <option value="drama">Drama</option>
                            <option value="thriller">Thriller</option>
                            <option value="romance">Romance</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Sort by</label>
                        <select id="sortBy" class="form-input">
                            <option value="added">Date Added</option>
                            <option value="title">Title</option>
                            <option value="rating">Rating</option>
                            <option value="release_date">Release Date</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button class="btn btn-ghost w-full" onclick="exportWatchlist()">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Content -->
        <div id="watchlistContent">
            <!-- Content will be loaded here -->
        </div>

        <!-- Recommendations based on watchlist -->
        <section class="section mt-16">
            <h2 class="section-title">Recommended for You</h2>
            <p class="text-gray-400 mb-6">Based on your watchlist preferences</p>
            <div class="content-grid" id="recommendationsContent">
                <!-- Recommendations will be loaded here -->
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let watchlistItems = [];
        let filteredItems = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!appState.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            setupEventListeners();
            await loadWatchlist();
            await loadRecommendations();
        });

        function setupEventListeners() {
            ['typeFilter', 'genreFilter', 'sortBy'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFiltersAndSort);
            });
        }

        async function loadWatchlist() {
            try {
                const container = document.getElementById('watchlistContent');
                UI.showSkeleton(container, 6);

                const response = await api.getWatchlist();
                watchlistItems = response.watchlist || [];
                
                document.getElementById('watchlistCount').textContent = watchlistItems.length;
                applyFiltersAndSort();

            } catch (error) {
                console.error('Error loading watchlist:', error);
                showErrorState();
            }
        }

        function applyFiltersAndSort() {
            const typeFilter = document.getElementById('typeFilter').value;
            const genreFilter = document.getElementById('genreFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // Apply filters
            filteredItems = watchlistItems.filter(item => {
                if (typeFilter && item.content_type !== typeFilter) return false;
                if (genreFilter) {
                    const genres = item.genres || [];
                    if (!genres.some(genre => genre.toLowerCase().includes(genreFilter.toLowerCase()))) {
                        return false;
                    }
                }
                return true;
            });

            // Apply sort
            switch (sortBy) {
                case 'title':
                    filteredItems.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'rating':
                    filteredItems.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'release_date':
                    filteredItems.sort((a, b) => new Date(b.release_date || 0) - new Date(a.release_date || 0));
                    break;
                default: // added
                    // Keep original order (most recently added first)
            }

            renderWatchlist();
        }

        function renderWatchlist() {
            const container = document.getElementById('watchlistContent');

            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3 class="empty-state-title">
                            ${watchlistItems.length === 0 ? 'Your watchlist is empty' : 'No items match your filters'}
                        </h3>
                        <p class="empty-state-description">
                            ${watchlistItems.length === 0 
                                ? 'Start adding movies and shows you want to watch later.' 
                                : 'Try adjusting your filters to see more items.'
                            }
                        </p>
                        ${watchlistItems.length === 0 ? `
                            <a href="/categories/trending" class="btn btn-primary mt-4">
                                Discover Content
                            </a>
                        ` : `
                            <button class="btn btn-secondary mt-4" onclick="clearFilters()">
                                Clear Filters
                            </button>
                        `}
                    </div>
                `;
                return;
            }

            // Enhanced grid view with remove buttons
            container.innerHTML = `
                <div class="content-grid">
                    ${filteredItems.map(item => `
                        <div class="movie-card relative group">
                            <img src="${item.poster_path || Utils.getPlaceholderImage()}" 
                                 alt="${Utils.sanitizeHTML(item.title)}" 
                                 class="w-full h-full object-cover rounded-lg"
                                 onerror="this.src='${Utils.getPlaceholderImage()}'">
                            
                            <!-- Remove button -->
                            <button class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                    onclick="removeFromWatchlist(${item.id})"
                                    title="Remove from watchlist">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            
                            <!-- Content overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                                <div class="absolute bottom-0 left-0 right-0 p-4">
                                    <h3 class="font-semibold text-sm mb-2">${Utils.sanitizeHTML(item.title)}</h3>
                                    <div class="flex items-center gap-2 text-xs text-gray-300">
                                        ${item.rating ? `<span class="flex items-center gap-1">‚≠ê ${Utils.formatRating(item.rating)}</span>` : ''}
                                        ${item.release_date ? `<span>${Utils.formatDate(item.release_date)}</span>` : ''}
                                        <span class="badge badge-ghost text-xs">${item.content_type?.toUpperCase()}</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm mt-2 w-full" onclick="Router.navigate('/details?id=${item.id}')">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            Utils.lazyLoadImages();
        }

        async function removeFromWatchlist(contentId) {
            try {
                // In a real implementation, this would call an API to remove the item
                // For now, we'll simulate it by removing from the local array
                watchlistItems = watchlistItems.filter(item => item.id !== contentId);
                document.getElementById('watchlistCount').textContent = watchlistItems.length;
                
                UI.showToast('Removed from watchlist', 'success');
                applyFiltersAndSort();

            } catch (error) {
                console.error('Error removing from watchlist:', error);
                UI.showToast('Failed to remove from watchlist', 'error');
            }
        }

        function clearFilters() {
            document.getElementById('typeFilter').value = '';
            document.getElementById('genreFilter').value = '';
            document.getElementById('sortBy').value = 'added';
            applyFiltersAndSort();
        }

        function clearWatchlist() {
            if (watchlistItems.length === 0) return;

            UI.showModal(`
                <div class="text-center">
                    <h3 class="text-xl font-semibold mb-4">Clear Watchlist?</h3>
                    <p class="text-gray-400 mb-6">This will remove all items from your watchlist. This action cannot be undone.</p>
                    <div class="flex justify-center gap-4">
                        <button class="btn btn-secondary" onclick="UI.hideModal(this.closest('.modal-overlay'))">Cancel</button>
                        <button class="btn btn-error" onclick="confirmClearWatchlist()">Clear Watchlist</button>
                    </div>
                </div>
            `, 'Clear Watchlist');
        }

        function confirmClearWatchlist() {
            watchlistItems = [];
            filteredItems = [];
            document.getElementById('watchlistCount').textContent = '0';
            renderWatchlist();
            UI.hideModal(document.querySelector('.modal-overlay'));
            UI.showToast('Watchlist cleared', 'success');
        }

        function exportWatchlist() {
            if (watchlistItems.length === 0) {
                UI.showToast('Nothing to export', 'warning');
                return;
            }

            const exportData = {
                exported_at: new Date().toISOString(),
                total_items: watchlistItems.length,
                watchlist: watchlistItems.map(item => ({
                    title: item.title,
                    type: item.content_type,
                    rating: item.rating,
                    release_date: item.release_date,
                    genres: item.genres
                }))
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `cinescope-watchlist-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            UI.showToast('Watchlist exported successfully!', 'success');
        }

        async function loadRecommendations() {
            if (watchlistItems.length === 0) return;

            try {
                const container = document.getElementById('recommendationsContent');
                UI.showSkeleton(container, 6);

                // Get recommendations based on watchlist content
                // For now, we'll use trending as a fallback
                const response = await api.getTrending('all', 12);
                const recommendations = response.recommendations || [];

                contentManager.renderMovieGrid(container, { recommendations });

            } catch (error) {
                console.error('Error loading recommendations:', error);
                document.getElementById('recommendationsContent').innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-8">
                        Failed to load recommendations
                    </div>
                `;
            }
        }

        function showErrorState() {
            const container = document.getElementById('watchlistContent');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <h3 class="empty-state-title">Failed to load watchlist</h3>
                    <p class="empty-state-description">Please try again later.</p>
                    <button class="btn btn-primary mt-4" onclick="loadWatchlist()">Retry</button>
                </div>
            `;
        }
    </script>
</body>
</html>