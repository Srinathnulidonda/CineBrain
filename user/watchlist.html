<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Watchlist - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header__breadcrumb">
                        <a href="/" class="text-muted">Home</a>
                        <span class="page-header__breadcrumb-separator">/</span>
                        <a href="#" onclick="navigateToProfile()" class="text-muted">Profile</a>
                        <span class="page-header__breadcrumb-separator">/</span>
                        <span>Watchlist</span>
                    </div>
                    <h1 class="page-header__title">My Watchlist</h1>
                    <p class="page-header__description" id="watchlistDescription">
                        You have 0 items in your watchlist
                    </p>
                </div>

                <!-- Filters -->
                <div class="filters mb-xl">
                    <div class="d-flex justify-between align-center flex-wrap gap-md">
                        <div class="d-flex gap-sm">
                            <select class="form-control" id="filterType" style="width: auto;">
                                <option value="all">All Types</option>
                                <option value="movie">Movies</option>
                                <option value="tv">TV Shows</option>
                                <option value="anime">Anime</option>
                            </select>

                            <select class="form-control" id="sortBy" style="width: auto;">
                                <option value="added_desc">Recently Added</option>
                                <option value="added_asc">Oldest First</option>
                                <option value="title_asc">Title (A-Z)</option>
                                <option value="title_desc">Title (Z-A)</option>
                                <option value="rating_desc">Highest Rated</option>
                            </select>
                        </div>

                        <div class="d-flex gap-sm">
                            <button class="btn btn-secondary" onclick="exportWatchlist()">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button class="btn btn-secondary" onclick="clearWatchlist()">
                                <i class="bi bi-trash"></i> Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Watchlist Grid -->
                <div class="content-grid content-grid--movies stagger-animation" id="watchlistGrid">
                    <!-- Loading skeleton -->
                    <div class="content-card skeleton" style="height: 300px;"></div>
                    <div class="content-card skeleton" style="height: 300px;"></div>
                    <div class="content-card skeleton" style="height: 300px;"></div>
                    <div class="content-card skeleton" style="height: 300px;"></div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="bi bi-bookmark empty-state__icon"></i>
                    <h2 class="empty-state__title">Your watchlist is empty</h2>
                    <p class="empty-state__description">
                        Start adding movies and shows you want to watch later
                    </p>
                    <button class="btn btn-primary" onclick="router.navigate('/content/search.html')">
                        Browse Content
                    </button>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" class="mobile-nav__link mobile-nav__link--active">
                        <i class="bi bi-bookmark-fill mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" onclick="navigateToProfile()" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login if not authenticated
        }

        let watchlistItems = [];
        let filteredItems = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            updateNavigation();
            await loadWatchlist();
            setupFilters();
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const user = auth.getUser();

            navbarUser.innerHTML = `
                <a href="${auth.getUserUrl('watchlist')}" class="navbar__link navbar__link--active">
                    <i class="bi bi-bookmark-fill"></i>
                </a>
                <a href="${auth.getUserUrl('favorites')}" class="navbar__link">
                    <i class="bi bi-heart"></i>
                </a>
                <div class="navbar__avatar">
                    <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                </div>
            `;
        }

        async function loadWatchlist() {
            try {
                const response = await api.getWatchlist();
                watchlistItems = response.watchlist || [];
                filteredItems = [...watchlistItems];

                // Update description
                document.getElementById('watchlistDescription').textContent =
                    `You have ${watchlistItems.length} item${watchlistItems.length !== 1 ? 's' : ''} in your watchlist`;

                // Cache watchlist for offline access
                Storage.setWatchlistCache(watchlistItems);

                renderWatchlist();
            } catch (error) {
                console.error('Failed to load watchlist:', error);
                // Try to load from cache
                watchlistItems = Storage.getWatchlistCache();
                filteredItems = [...watchlistItems];
                renderWatchlist();
            }
        }

        function renderWatchlist() {
            const grid = document.getElementById('watchlistGrid');
            const emptyState = document.getElementById('emptyState');

            if (filteredItems.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = filteredItems.map((item, index) => `
                <div class="content-card animate-fadeInUp" style="animation-delay: ${index * 0.1}s">
                    <div class="content-card__image-wrapper" onclick="navigateToContentDetails(${item.id})">
                        <img src="${item.poster_path}" 
                             alt="${item.title}" 
                             class="content-card__image"
                             loading="lazy">
                        <button class="content-card__badge bg-gradient-primary" 
                                onclick="event.stopPropagation(); removeFromWatchlist(${item.id})"
                                title="Remove from watchlist">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="content-card__body" onclick="navigateToContentDetails(${item.id})">
                        <h3 class="content-card__title">${item.title}</h3>
                        <div class="content-card__meta">
                            <span class="content-card__rating">
                                <i class="bi bi-star-fill content-card__rating-star"></i>
                                ${item.rating || 'N/A'}
                            </span>
                            <span>${item.content_type}</span>
                        </div>
                    </div>
                    <div class="content-card__overlay">
                        <div class="content-card__actions">
                            <button class="content-card__action-btn" onclick="event.stopPropagation(); playContent(${item.id})">
                                <i class="bi bi-play-fill"></i> Play
                            </button>
                            <button class="content-card__action-btn" onclick="event.stopPropagation(); addToFavorites(${item.id})">
                                <i class="bi bi-heart"></i> Favorite
                            </button>
                            ${item.youtube_trailer ? `
                                <button class="content-card__action-btn" onclick="event.stopPropagation(); window.open('${item.youtube_trailer}', '_blank')">
                                    <i class="bi bi-youtube"></i> Trailer
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setupFilters() {
            const filterType = document.getElementById('filterType');
            const sortBy = document.getElementById('sortBy');

            filterType.addEventListener('change', applyFilters);
            sortBy.addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const filterType = document.getElementById('filterType').value;
            const sortBy = document.getElementById('sortBy').value;

            // Filter by type
            if (filterType === 'all') {
                filteredItems = [...watchlistItems];
            } else {
                filteredItems = watchlistItems.filter(item => item.content_type === filterType);
            }

            // Sort
            switch (sortBy) {
                case 'added_desc':
                    // Default order (most recent first)
                    break;
                case 'added_asc':
                    filteredItems.reverse();
                    break;
                case 'title_asc':
                    filteredItems.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title_desc':
                    filteredItems.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'rating_desc':
                    filteredItems.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
            }

            renderWatchlist();
        }

        async function removeFromWatchlist(contentId) {
            try {
                await api.recordInteraction(contentId, 'remove_watchlist');

                // Remove from local arrays
                watchlistItems = watchlistItems.filter(item => item.id !== contentId);
                filteredItems = filteredItems.filter(item => item.id !== contentId);

                // Update cache
                Storage.setWatchlistCache(watchlistItems);

                // Update UI
                document.getElementById('watchlistDescription').textContent =
                    `You have ${watchlistItems.length} item${watchlistItems.length !== 1 ? 's' : ''} in your watchlist`;

                renderWatchlist();
                showToast('Removed from watchlist', 'success');
            } catch (error) {
                showToast('Failed to remove from watchlist', 'error');
            }
        }

        async function addToFavorites(contentId) {
            try {
                await api.recordInteraction(contentId, Config.INTERACTIONS.FAVORITE);
                showToast('Added to favorites', 'success');
            } catch (error) {
                showToast('Failed to add to favorites', 'error');
            }
        }

        function playContent(contentId) {
            // In production, this would integrate with video player
            navigateToContentDetails(contentId);
        }

        function exportWatchlist() {
            const data = watchlistItems.map(item => ({
                title: item.title,
                type: item.content_type,
                rating: item.rating,
                year: item.release_date ? new Date(item.release_date).getFullYear() : 'N/A'
            }));

            const csv = [
                ['Title', 'Type', 'Rating', 'Year'],
                ...data.map(row => [row.title, row.type, row.rating, row.year])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinescope-watchlist-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Watchlist exported successfully', 'success');
        }

        function clearWatchlist() {
            if (!confirm('Are you sure you want to clear your entire watchlist? This action cannot be undone.')) {
                return;
            }

            // In production, this would call API to clear all
            watchlistItems = [];
            filteredItems = [];
            Storage.setWatchlistCache([]);

            document.getElementById('watchlistDescription').textContent = 'You have 0 items in your watchlist';
            renderWatchlist();
            showToast('Watchlist cleared', 'success');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>

</html>