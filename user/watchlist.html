<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Watchlist - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/bootstrap-overrides.css" rel="stylesheet">
    <link href="/css/tailwind.css" rel="stylesheet">
    <link href="/css/animation.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    <link href="/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Desktop Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Header -->
                <div class="mb-4">
                    <h1 class="tw-text-3xl tw-font-bold mb-3">
                        <i class="bi bi-bookmark-fill text-primary"></i> My Watchlist
                    </h1>
                    <p class="text-muted">Movies and shows you want to watch</p>
                </div>

                <!-- Filter Options -->
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="filterType" id="filter-all" value="all" checked>
                        <label class="btn btn-outline-secondary" for="filter-all">All</label>

                        <input type="radio" class="btn-check" name="filterType" id="filter-movie" value="movie">
                        <label class="btn btn-outline-secondary" for="filter-movie">Movies</label>

                        <input type="radio" class="btn-check" name="filterType" id="filter-tv" value="tv">
                        <label class="btn btn-outline-secondary" for="filter-tv">TV Shows</label>

                        <input type="radio" class="btn-check" name="filterType" id="filter-anime" value="anime">
                        <label class="btn btn-outline-secondary" for="filter-anime">Anime</label>
                    </div>

                    <div class="ms-auto">
                        <button class="btn btn-outline-danger" onclick="clearWatchlist()" id="clearBtn">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                </div>

                <!-- Watchlist Content -->
                <div id="watchlistContent">
                    <!-- Loading State -->
                    <div id="loadingState">
                        <div class="row g-4">
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="skeleton-card">
                                    <div class="skeleton-img"></div>
                                    <div class="skeleton-body">
                                        <div class="skeleton-title"></div>
                                        <div class="skeleton-text"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="skeleton-card">
                                    <div class="skeleton-img"></div>
                                    <div class="skeleton-body">
                                        <div class="skeleton-title"></div>
                                        <div class="skeleton-text"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Watchlist Grid -->
                    <div class="row g-4 d-none" id="watchlistGrid"></div>

                    <!-- Empty State -->
                    <div class="empty-state d-none" id="emptyState">
                        <i class="bi bi-bookmark"></i>
                        <h5>Your watchlist is empty</h5>
                        <p>Start adding movies and shows you want to watch</p>
                        <a href="/content/search" class="btn btn-primary">Browse Content</a>
                    </div>
                </div>

                <!-- Recommendations Based on Watchlist -->
                <section class="mt-5 d-none" id="recommendationsSection">
                    <h3 class="mb-4">Based on Your Watchlist</h3>
                    <div class="row g-4" id="recommendationsGrid">
                        <div class="col-12 text-center text-muted">Loading recommendations...</div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <div id="mobile-nav-container"></div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>

    <!-- Page specific JS -->
    <script>
        let watchlistData = [];
        let filteredData = [];

        // Initialize page
        async function pageInit() {
            // Set up event listeners
            setupEventListeners();

            // Load watchlist
            await loadWatchlist();
        }

        function setupEventListeners() {
            // Filter type change
            document.querySelectorAll('input[name="filterType"]').forEach(input => {
                input.addEventListener('change', filterWatchlist);
            });
        }

        async function loadWatchlist() {
            const user = Storage.getUser();

            try {
                if (user) {
                    // Load from API for logged-in users
                    const response = await api.user.getWatchlist();
                    watchlistData = response.watchlist || [];
                } else {
                    // Load from local storage for anonymous users
                    const watchlistIds = Storage.getLocalWatchlist();

                    // Fetch details for each content ID
                    watchlistData = [];
                    for (const id of watchlistIds) {
                        try {
                            const content = await api.content.getDetails(id);
                            watchlistData.push({
                                id: content.id,
                                title: content.title,
                                content_type: content.content_type,
                                genres: content.genres,
                                rating: content.rating,
                                poster_path: content.poster_path,
                                youtube_trailer: content.youtube_trailer
                            });
                        } catch (error) {
                            console.error(`Failed to load content ${id}:`, error);
                        }
                    }
                }

                // Initial display
                displayWatchlist();

                // Load recommendations if watchlist has items
                if (watchlistData.length > 0) {
                    loadRecommendations();
                }

            } catch (error) {
                console.error('Error loading watchlist:', error);
                UI.showToast('Failed to load watchlist', 'error');
                showEmptyState();
            }
        }

        function displayWatchlist() {
            const loadingState = document.getElementById('loadingState');
            const watchlistGrid = document.getElementById('watchlistGrid');
            const emptyState = document.getElementById('emptyState');
            const clearBtn = document.getElementById('clearBtn');

            // Hide loading
            loadingState.classList.add('d-none');

            if (filteredData.length === 0 && watchlistData.length === 0) {
                // Show empty state
                emptyState.classList.remove('d-none');
                watchlistGrid.classList.add('d-none');
                clearBtn.disabled = true;
            } else if (filteredData.length === 0) {
                // No items match filter
                watchlistGrid.classList.remove('d-none');
                watchlistGrid.innerHTML = '<div class="col-12 text-center text-muted">No items match the selected filter</div>';
                clearBtn.disabled = false;
            } else {
                // Show watchlist
                emptyState.classList.add('d-none');
                watchlistGrid.classList.remove('d-none');
                clearBtn.disabled = false;

                // Create cards with remove button
                watchlistGrid.innerHTML = filteredData.map(content => {
                    const posterUrl = content.poster_path || '/assets/no-poster.jpg';
                    const rating = content.rating ? content.rating.toFixed(1) : 'N/A';
                    const year = content.release_date ? new Date(content.release_date).getFullYear() : '';

                    return `
                        <div class="col-6 col-md-4 col-lg-3" id="watchlist-item-${content.id}">
                            <div class="content-card position-relative">
                                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                        style="z-index: 10;" 
                                        onclick="event.stopPropagation(); removeFromWatchlist(${content.id})">
                                    <i class="bi bi-x"></i>
                                </button>
                                <div onclick="window.location.href='/content/details?id=${content.id}'">
                                    <div class="content-poster">
                                        <img src="${posterUrl}" alt="${content.title}" loading="lazy">
                                        <div class="content-overlay">
                                            <button class="btn-play" onclick="event.stopPropagation(); UI.playTrailer('${content.youtube_trailer || ''}', '${content.title}')">
                                                <i class="bi bi-play-circle-fill"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="content-info">
                                        <h6 class="content-title">${content.title}</h6>
                                        <div class="content-meta">
                                            <span class="badge-rating">
                                                <i class="bi bi-star-fill"></i> ${rating}
                                            </span>
                                            <span class="badge badge-secondary">${content.content_type.toUpperCase()}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function filterWatchlist() {
            const filterType = document.querySelector('input[name="filterType"]:checked').value;

            if (filterType === 'all') {
                filteredData = watchlistData;
            } else {
                filteredData = watchlistData.filter(content => content.content_type === filterType);
            }

            displayWatchlist();
        }

        async function removeFromWatchlist(contentId) {
            const user = Storage.getUser();

            try {
                if (user) {
                    // Remove via API for logged-in users
                    await api.user.recordInteraction(contentId, 'remove_watchlist');

                    // Update local cache
                    const watchlist = JSON.parse(localStorage.getItem(`user_${user.id}_watchlist`) || '[]');
                    const index = watchlist.indexOf(contentId);
                    if (index > -1) watchlist.splice(index, 1);
                    localStorage.setItem(`user_${user.id}_watchlist`, JSON.stringify(watchlist));
                } else {
                    // Remove from local storage for anonymous users
                    Storage.removeFromLocalWatchlist(contentId);
                }

                // Remove from current data
                watchlistData = watchlistData.filter(content => content.id !== contentId);
                filteredData = filteredData.filter(content => content.id !== contentId);

                // Animate removal
                const element = document.getElementById(`watchlist-item-${contentId}`);
                if (element) {
                    element.classList.add('animate-fade-out');
                    setTimeout(() => {
                        displayWatchlist();
                    }, 300);
                }

                UI.showToast('Removed from watchlist', 'success');

                // Update recommendations
                if (watchlistData.length > 0) {
                    loadRecommendations();
                } else {
                    document.getElementById('recommendationsSection').classList.add('d-none');
                }

            } catch (error) {
                console.error('Error removing from watchlist:', error);
                UI.showToast('Failed to remove from watchlist', 'error');
            }
        }

        async function clearWatchlist() {
            if (!confirm('Are you sure you want to clear your entire watchlist?')) {
                return;
            }

            const user = Storage.getUser();

            try {
                if (user) {
                    // Clear via API for each item
                    for (const content of watchlistData) {
                        await api.user.recordInteraction(content.id, 'remove_watchlist');
                    }

                    // Clear local cache
                    localStorage.setItem(`user_${user.id}_watchlist`, JSON.stringify([]));
                } else {
                    // Clear local storage for anonymous users
                    localStorage.setItem(Storage.KEYS.WATCHLIST, JSON.stringify([]));
                }

                // Clear data
                watchlistData = [];
                filteredData = [];

                // Update display
                displayWatchlist();
                document.getElementById('recommendationsSection').classList.add('d-none');

                UI.showToast('Watchlist cleared', 'success');

            } catch (error) {
                console.error('Error clearing watchlist:', error);
                UI.showToast('Failed to clear watchlist', 'error');
            }
        }

        async function loadRecommendations() {
            const section = document.getElementById('recommendationsSection');
            const grid = document.getElementById('recommendationsGrid');

            section.classList.remove('d-none');

            try {
                // Get recommendations based on first item in watchlist
                const baseContent = watchlistData[0];
                const data = await api.content.getSimilar(baseContent.id, 8);

                if (data.recommendations && data.recommendations.length > 0) {
                    grid.innerHTML = UI.createContentGrid(data.recommendations);
                } else {
                    grid.innerHTML = '<div class="col-12 text-center text-muted">No recommendations available</div>';
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                grid.innerHTML = '<div class="col-12 text-center text-danger">Failed to load recommendations</div>';
            }
        }

        function showEmptyState() {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('watchlistGrid').classList.add('d-none');
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('clearBtn').disabled = true;
        }

        // Set pageInit for App.js
        window.pageInit = pageInit;
    </script>
</body>

</html>