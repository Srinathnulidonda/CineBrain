<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your CineBrain Watchlist - Movies and shows you want to watch">
    <meta name="robots" content="noindex, nofollow">

    <title>My Watchlist - CineBrain</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
</head>

<body>
    <!-- Fixed Topbar -->
    <div id="topbarContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Watchlist Header -->
        <section class="py-5"
            style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-4 fw-bold text-white mb-3">
                            <i class="fas fa-bookmark text-primary me-3"></i>
                            My Watchlist
                        </h1>
                        <p class="lead text-muted mb-4">Your personal queue of must-watch content</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="watchlist-stats">
                            <div class="stat-card d-inline-block text-center px-4 py-3 bg-dark rounded me-3">
                                <h3 class="text-primary mb-0" id="totalCount">0</h3>
                                <small class="text-muted">Total Items</small>
                            </div>
                            <div class="stat-card d-inline-block text-center px-4 py-3 bg-dark rounded">
                                <h3 class="text-warning mb-0" id="estimatedTime">0h</h3>
                                <small class="text-muted">Watch Time</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Sort Options -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary filter-btn active" data-filter="all"
                                onclick="filterWatchlist('all')">
                                <i class="fas fa-th me-1"></i>All
                            </button>
                            <button class="btn btn-outline-primary filter-btn" data-filter="movie"
                                onclick="filterWatchlist('movie')">
                                <i class="fas fa-film me-1"></i>Movies
                            </button>
                            <button class="btn btn-outline-primary filter-btn" data-filter="tv"
                                onclick="filterWatchlist('tv')">
                                <i class="fas fa-tv me-1"></i>TV Shows
                            </button>
                            <button class="btn btn-outline-primary filter-btn" data-filter="anime"
                                onclick="filterWatchlist('anime')">
                                <i class="fas fa-dragon me-1"></i>Anime
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <select
                            class="form-select form-select-sm bg-dark text-white border-secondary d-inline-block w-auto"
                            id="sortBy" onchange="sortWatchlist()">
                            <option value="date_added">Date Added</option>
                            <option value="title">Title (A-Z)</option>
                            <option value="rating">Highest Rated</option>
                            <option value="release_date">Release Date</option>
                        </select>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="clearWatchlist()">
                            <i class="fas fa-trash me-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Watchlist Content -->
        <section class="py-5">
            <div class="container">
                <div id="watchlistContainer" class="row">
                    <div class="col-12 text-center py-4">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-muted">Loading your watchlist...</p>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5 d-none">
                    <i class="fas fa-bookmark text-muted mb-3" style="font-size: 4rem;"></i>
                    <h3 class="text-white mb-2">Your Watchlist is Empty</h3>
                    <p class="text-muted mb-4">Start adding movies and shows you want to watch!</p>
                    <a href="/content/search.html" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Discover Content
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- JavaScript Files -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Page-specific JavaScript -->
    <script>
        (function () {
            let watchlistData = [];
            let filteredData = [];
            let currentFilter = 'all';
            let currentSort = 'date_added';

            // Initialize watchlist page
            async function initWatchlistPage() {
                try {
                    // Check authentication
                    if (!window.auth || !window.auth.requireAuth()) {
                        return;
                    }

                    await loadComponents();
                    await loadWatchlist();
                } catch (error) {
                    console.error('Watchlist page initialization failed:', error);
                }
            }

            // Load reusable components
            async function loadComponents() {
                try {
                    // Load topbar
                    const topbarResponse = await fetch('/components/layout/topbar.html');
                    const topbarHTML = await topbarResponse.text();
                    document.getElementById('topbarContainer').innerHTML = topbarHTML;

                    // Load mobile navigation
                    const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
                    const mobileNavHTML = await mobileNavResponse.text();
                    document.getElementById('mobileNavContainer').innerHTML = mobileNavHTML;

                    // Execute component scripts
                    const scripts = document.querySelectorAll('#topbarContainer script, #mobileNavContainer script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                    });
                } catch (error) {
                    console.error('Failed to load components:', error);
                }
            }

            // Load watchlist
            async function loadWatchlist() {
                const container = document.getElementById('watchlistContainer');

                try {
                    const response = await window.api.getUserList('watchlist');
                    watchlistData = response.watchlist || [];

                    if (watchlistData.length > 0) {
                        document.getElementById('emptyState').classList.add('d-none');
                        updateStats();
                        applyFiltersAndSort();
                    } else {
                        container.innerHTML = '';
                        document.getElementById('emptyState').classList.remove('d-none');
                        updateStats();
                    }
                } catch (error) {
                    console.error('Failed to load watchlist:', error);
                    container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                        <h5 class="text-muted">Failed to load watchlist</h5>
                        <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
                            <i class="fas fa-refresh me-1"></i>Try Again
                        </button>
                    </div>
                `;
                }
            }

            // Update statistics
            function updateStats() {
                document.getElementById('totalCount').textContent = watchlistData.length;

                // Calculate estimated watch time
                let totalMinutes = 0;
                watchlistData.forEach(item => {
                    if (item.runtime) {
                        totalMinutes += item.runtime;
                    } else if (item.content_type === 'movie') {
                        totalMinutes += 120; // Default 2 hours for movies
                    } else {
                        totalMinutes += 45; // Default 45 min per episode
                    }
                });

                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                document.getElementById('estimatedTime').textContent =
                    hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            }

            // Filter watchlist
            window.filterWatchlist = function (filter) {
                currentFilter = filter;

                // Update active button
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.classList.add('btn-outline-primary');
                    if (btn.dataset.filter === filter) {
                        btn.classList.add('active', 'btn-primary');
                        btn.classList.remove('btn-outline-primary');
                    }
                });

                applyFiltersAndSort();
            };

            // Sort watchlist
            window.sortWatchlist = function () {
                currentSort = document.getElementById('sortBy').value;
                applyFiltersAndSort();
            };

            // Apply filters and sort
            function applyFiltersAndSort() {
                // Filter
                if (currentFilter === 'all') {
                    filteredData = [...watchlistData];
                } else {
                    filteredData = watchlistData.filter(item => item.content_type === currentFilter);
                }

                // Sort
                switch (currentSort) {
                    case 'title':
                        filteredData.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'rating':
                        filteredData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                        break;
                    case 'release_date':
                        filteredData.sort((a, b) => {
                            const dateA = new Date(a.release_date || '1900-01-01');
                            const dateB = new Date(b.release_date || '1900-01-01');
                            return dateB - dateA;
                        });
                        break;
                    case 'date_added':
                    default:
                        // Keep original order (most recent first)
                        break;
                }

                renderWatchlist();
            }

            // Render watchlist
            function renderWatchlist() {
                const container = document.getElementById('watchlistContainer');

                if (filteredData.length === 0) {
                    container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="fas fa-filter text-muted mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted">No ${currentFilter === 'all' ? 'items' : currentFilter} in your watchlist</p>
                    </div>
                `;
                    return;
                }

                const contentHTML = filteredData.map((item, index) => {
                    const typeColor = item.content_type === 'movie' ? 'primary' :
                        item.content_type === 'tv' ? 'success' : 'warning';

                    return `
                    <div class="col-12 mb-3 watchlist-item" style="animation-delay: ${index * 0.05}s;">
                        <div class="card bg-dark border-secondary h-100">
                            <div class="row g-0">
                                <div class="col-md-2">
                                    <img src="${item.poster_path || '/assets/no-poster.jpg'}" 
                                         class="img-fluid rounded-start" 
                                         style="height: 200px; width: 100%; object-fit: cover;"
                                         alt="${item.title}"
                                         onclick="viewDetails(${item.id})"
                                         onerror="this.src='/assets/no-poster.jpg'">
                                </div>
                                <div class="col-md-10">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h5 class="card-title text-white mb-2">
                                                    <a href="/content/details.html?id=${item.id}" class="text-decoration-none text-white">
                                                        ${item.title}
                                                    </a>
                                                </h5>
                                                <div class="d-flex align-items-center gap-3 mb-2">
                                                    <span class="badge bg-${typeColor}">
                                                        ${item.content_type.toUpperCase()}
                                                    </span>
                                                    ${item.rating ? `
                                                        <span class="text-warning">
                                                            <i class="fas fa-star"></i> ${parseFloat(item.rating).toFixed(1)}
                                                        </span>
                                                    ` : ''}
                                                    ${item.release_date ? `
                                                        <span class="text-muted">
                                                            ${new Date(item.release_date).getFullYear()}
                                                        </span>
                                                    ` : ''}
                                                    ${item.runtime ? `
                                                        <span class="text-muted">
                                                            <i class="fas fa-clock"></i> ${item.runtime} min
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                ${item.genres && item.genres.length > 0 ? `
                                                    <div class="mb-2">
                                                        ${item.genres.slice(0, 3).map(genre =>
                        `<span class="badge bg-secondary me-1">${genre}</span>`
                    ).join('')}
                                                    </div>
                                                ` : ''}
                                                <p class="card-text text-muted d-none d-md-block">
                                                    ${item.overview ? item.overview.substring(0, 200) + '...' : 'No description available'}
                                                                                </p>
                                            </div>
                                            <div class="watchlist-actions">
                                                <button class="btn btn-primary btn-sm mb-2" onclick="viewDetails(${item.id})">
                                                    <i class="fas fa-play me-1"></i>Watch Now
                                                </button>
                                                <br>
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromWatchlist(${item.id})">
                                                    <i class="fas fa-times me-1"></i>Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                container.innerHTML = contentHTML;

                // Add animation
                const items = container.querySelectorAll('.watchlist-item');
                items.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('fade-in-up');
                    }, index * 50);
                });
            }

            // Remove from watchlist
            window.removeFromWatchlist = async function (contentId) {
                if (!confirm('Remove this item from your watchlist?')) return;

                try {
                    await window.api.recordInteraction(contentId, 'watchlist_remove');

                    // Remove from local data
                    watchlistData = watchlistData.filter(item => item.id !== contentId);

                    if (window.showToast) {
                        window.showToast('Removed from watchlist', 'success');
                    }

                    updateStats();
                    applyFiltersAndSort();

                    if (watchlistData.length === 0) {
                        document.getElementById('emptyState').classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Failed to remove from watchlist:', error);
                    if (window.showToast) {
                        window.showToast('Failed to remove item', 'error');
                    }
                }
            };

            // Clear entire watchlist
            window.clearWatchlist = async function () {
                if (!confirm('Are you sure you want to clear your entire watchlist? This cannot be undone.')) return;

                try {
                    // Remove all items
                    for (const item of watchlistData) {
                        await window.api.recordInteraction(item.id, 'watchlist_remove');
                    }

                    watchlistData = [];
                    document.getElementById('watchlistContainer').innerHTML = '';
                    document.getElementById('emptyState').classList.remove('d-none');
                    updateStats();

                    if (window.showToast) {
                        window.showToast('Watchlist cleared', 'success');
                    }
                } catch (error) {
                    console.error('Failed to clear watchlist:', error);
                    if (window.showToast) {
                        window.showToast('Failed to clear watchlist', 'error');
                    }
                }
            };

            // View details
            window.viewDetails = function (contentId) {
                window.location.href = `/content/details.html?id=${contentId}`;
            };

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initWatchlistPage);
            } else {
                initWatchlistPage();
            }
        })();
    </script>

    <!-- Watchlist-specific Styles -->
    <style>
        .stat-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .watchlist-item {
            opacity: 0;
        }

        .watchlist-item.fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .watchlist-item .card {
            transition: all 0.3s ease;
        }

        .watchlist-item .card:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .filter-btn {
            min-width: 100px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .watchlist-item .row {
                flex-direction: column;
            }

            .watchlist-item img {
                height: 150px !important;
                border-radius: 0.5rem 0.5rem 0 0 !important;
            }

            .watchlist-actions {
                margin-top: 1rem;
            }
        }
    </style>
</body>

</html>