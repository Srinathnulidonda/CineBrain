<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your personal watchlist on CineScope">

    <title>My Watchlist - CineScope</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/bootstrap-overrides.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body class="bg-black">
    <!-- Layout Container -->
    <div id="app-container">
        <!-- Top Bar Container (Desktop) -->
        <div id="topbar-container" class="d-none d-lg-block"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="watchlist-header py-5">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="display-5 fw-bold text-white mb-3">
                                <i class="bi bi-bookmark-fill text-primary me-3"></i>My Watchlist
                            </h1>
                            <p class="lead text-muted">Movies and shows you want to watch</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="watchlist-stats">
                                <div class="d-flex flex-wrap justify-content-md-end gap-3">
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-primary fw-bold h4 mb-0" id="total-items">0</div>
                                        <div class="stat-label text-muted small">Total Items</div>
                                    </div>
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-success fw-bold h4 mb-0" id="movies-count">0</div>
                                        <div class="stat-label text-muted small">Movies</div>
                                    </div>
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-info fw-bold h4 mb-0" id="shows-count">0</div>
                                        <div class="stat-label text-muted small">TV Shows</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters and Controls -->
                <div class="watchlist-controls mb-4">
                    <div class="row align-items-center">
                        <div class="col-lg-6">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-primary filter-btn active" data-filter="all">
                                    All (<span id="all-count">0</span>)
                                </button>
                                <button class="btn btn-outline-primary filter-btn" data-filter="movie">
                                    Movies (<span id="movie-count">0</span>)
                                </button>
                                <button class="btn btn-outline-primary filter-btn" data-filter="tv">
                                    TV Shows (<span id="tv-count">0</span>)
                                </button>
                                <button class="btn btn-outline-primary filter-btn" data-filter="anime">
                                    Anime (<span id="anime-count">0</span>)
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="d-flex justify-content-lg-end gap-2">
                                <select class="form-select bg-dark border-secondary text-white" style="width: auto;"
                                    id="sort-select">
                                    <option value="added_desc">Recently Added</option>
                                    <option value="added_asc">Oldest First</option>
                                    <option value="title_asc">Title A-Z</option>
                                    <option value="title_desc">Title Z-A</option>
                                    <option value="rating_desc">Highest Rated</option>
                                    <option value="rating_asc">Lowest Rated</option>
                                </select>
                                <button class="btn btn-outline-danger" id="clear-watchlist-btn" title="Clear Watchlist">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Watchlist Content -->
                <div id="watchlist-container" class="watchlist-content">
                    <!-- Loading state -->
                    <div id="loading-state" class="d-flex justify-content-center py-5">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted">Loading your watchlist...</p>
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div id="empty-state" class="d-none">
                        <div class="text-center py-5">
                            <i class="bi bi-bookmark display-1 text-muted mb-4"></i>
                            <h4 class="text-white mb-3">Your Watchlist is Empty</h4>
                            <p class="text-muted mb-4">Start adding movies and shows you want to watch!</p>
                            <div class="d-flex justify-content-center gap-3">
                                <a href="/?section=trending" class="btn btn-primary">
                                    <i class="bi bi-fire me-2"></i>Browse Trending
                                </a>
                                <a href="#" class="btn btn-outline-primary" id="search-link">
                                    <i class="bi bi-search me-2"></i>Search Content
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Content grid -->
                    <div id="content-grid" class="d-none">
                        <!-- Content will be populated here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation Container -->
        <div id="mobile-nav-container" class="d-lg-none"></div>
    </div>

    <!-- Clear Watchlist Confirmation Modal -->
    <div class="modal fade" id="clearWatchlistModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>Clear Watchlist
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-white">Are you sure you want to clear your entire watchlist?</p>
                    <p class="text-muted">This action cannot be undone. All items will be removed from your watchlist.
                    </p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-clear-btn">
                        <i class="bi bi-trash me-2"></i>Clear Watchlist
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Widget Templates -->
    <div id="widget-templates" class="d-none">
        <template id="content-card-template">
            <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                <div class="card content-card bg-dark border-0 h-100 position-relative" data-content-id="">
                    <div class="card-img-wrapper position-relative overflow-hidden">
                        <img src="" class="card-img-top" alt="" loading="lazy"
                            onerror="this.src='/assets/placeholder-poster.jpg'">
                        <div
                            class="card-overlay position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm rounded-circle p-2 play-trailer-btn"
                                    title="Play Trailer">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button class="btn btn-outline-light btn-sm rounded-circle p-2 quick-view-btn"
                                    title="Quick View">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm rounded-circle p-2 remove-btn"
                                    title="Remove from Watchlist">
                                    <i class="bi bi-bookmark-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="position-absolute top-0 end-0 m-2 rating-badge">
                            <span class="badge bg-primary rounded-pill">
                                <i class="bi bi-star-fill me-1"></i><span class="rating-value">0.0</span>
                            </span>
                        </div>
                        <div class="position-absolute top-0 start-0 m-2 content-type-badge">
                            <span class="badge bg-secondary">MOVIE</span>
                        </div>
                        <div class="position-absolute bottom-0 start-0 m-2 special-badges"></div>
                    </div>
                    <div class="card-body p-3">
                        <h6 class="card-title text-white mb-2 text-truncate" title=""></h6>
                        <p class="card-text text-muted small mb-2 genres-text"></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small release-date"></span>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-light btn-sm favorite-btn" title="Add to Favorites">
                                    <i class="bi bi-heart"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm remove-watchlist-btn"
                                    title="Remove from Watchlist">
                                    <i class="bi bi-bookmark-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core JavaScript -->
    <script src="/js/config.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>

    <!-- Widget Scripts -->
    <script src="/widgets/content-card.html"></script>

    <!-- Page Script -->
    <script>
        let watchlistData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let currentSort = 'added_desc';

        document.addEventListener('DOMContentLoaded', async function () {
            console.log('📋 Loading Watchlist Page...');

            // Ensure user is authenticated
            if (!CineScope.App.requireAuth()) {
                return;
            }

            const currentUser = CineScope.App.getCurrentUser();
            const currentUsername = CineScope.utils.getCurrentUsername();

            // Verify username matches current user
            if (currentUsername !== currentUser.username) {
                console.log('🚫 Username mismatch, redirecting...');
                window.location.href = `/${currentUser.username}/watchlist`;
                return;
            }

            // Set page title
            CineScope.UI.updatePageTitle('My Watchlist');

            // Update navigation links
            updateNavigationLinks(currentUser.username);

            // Load watchlist data
            await loadWatchlist();

            // Initialize filters and controls
            initializeControls();

            console.log('✅ Watchlist page loaded');
        });

        function updateNavigationLinks(username) {
            document.getElementById('search-link').href = `/${username}/search`;
        }

        async function loadWatchlist() {
            try {
                console.log('📡 Loading watchlist data...');

                const response = await CineScope.HTTP.user.getWatchlist();
                watchlistData = response.watchlist || [];

                console.log(`✅ Loaded ${watchlistData.length} watchlist items`);

                // Update statistics
                updateStatistics();

                // Apply current filter and sort
                applyFilterAndSort();

                // Show appropriate state
                if (watchlistData.length === 0) {
                    showEmptyState();
                } else {
                    showContentGrid();
                }

            } catch (error) {
                console.error('❌ Failed to load watchlist:', error);
                showErrorState(error.message);
            } finally {
                document.getElementById('loading-state').classList.add('d-none');
            }
        }

        function updateStatistics() {
            const total = watchlistData.length;
            const movies = watchlistData.filter(item => item.content_type === 'movie').length;
            const shows = watchlistData.filter(item => item.content_type === 'tv').length;
            const anime = watchlistData.filter(item => item.content_type === 'anime').length;

            document.getElementById('total-items').textContent = total;
            document.getElementById('movies-count').textContent = movies;
            document.getElementById('shows-count').textContent = shows;

            // Update filter buttons
            document.getElementById('all-count').textContent = total;
            document.getElementById('movie-count').textContent = movies;
            document.getElementById('tv-count').textContent = shows;
            document.getElementById('anime-count').textContent = anime;
        }

        function initializeControls() {
            // Filter buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    // Update active state
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Apply filter
                    currentFilter = this.dataset.filter;
                    applyFilterAndSort();
                });
            });

            // Sort dropdown
            const sortSelect = document.getElementById('sort-select');
            sortSelect.addEventListener('change', function () {
                currentSort = this.value;
                applyFilterAndSort();
            });

            // Clear watchlist button
            const clearBtn = document.getElementById('clear-watchlist-btn');
            clearBtn.addEventListener('click', function () {
                if (watchlistData.length > 0) {
                    const modal = new bootstrap.Modal(document.getElementById('clearWatchlistModal'));
                    modal.show();
                }
            });

            // Confirm clear watchlist
            document.getElementById('confirm-clear-btn').addEventListener('click', async function () {
                await clearWatchlist();
            });
        }

        function applyFilterAndSort() {
            // Apply filter
            if (currentFilter === 'all') {
                filteredData = [...watchlistData];
            } else {
                filteredData = watchlistData.filter(item => item.content_type === currentFilter);
            }

            // Apply sort
            filteredData.sort((a, b) => {
                switch (currentSort) {
                    case 'added_desc':
                        return new Date(b.added_at || 0) - new Date(a.added_at || 0);
                    case 'added_asc':
                        return new Date(a.added_at || 0) - new Date(b.added_at || 0);
                    case 'title_asc':
                        return a.title.localeCompare(b.title);
                    case 'title_desc':
                        return b.title.localeCompare(a.title);
                    case 'rating_desc':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'rating_asc':
                        return (a.rating || 0) - (b.rating || 0);
                    default:
                        return 0;
                }
            });

            // Update display
            if (filteredData.length === 0 && currentFilter !== 'all') {
                showFilteredEmptyState();
            } else {
                displayContent(filteredData);
            }
        }

        function displayContent(content) {
            const container = document.getElementById('content-grid');

            // Create enhanced content cards with remove functionality
            const enhancedOptions = {
                showTrailer: true,
                showRating: true,
                showGenres: true,
                onClick: function (content) {
                    const username = CineScope.App.getCurrentUser().username;
                    window.location.href = `/${username}/details/${content.id}`;
                }
            };

            CineScope.Widgets.ContentCard.createGrid(content, container, enhancedOptions);

            // Add remove functionality to each card
            container.querySelectorAll('.content-card').forEach(card => {
                const contentId = card.dataset.contentId;

                // Add remove button functionality
                const removeBtn = card.querySelector('.remove-watchlist-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', async function (e) {
                        e.stopPropagation();
                        await removeFromWatchlist(contentId, card);
                    });
                }
            });
        }

        async function removeFromWatchlist(contentId, cardElement) {
            try {
                // Add loading state to card
                cardElement.style.opacity = '0.5';
                cardElement.style.pointerEvents = 'none';

                // Note: In a real implementation, you'd call an API to remove the item
                // await CineScope.HTTP.user.removeFromWatchlist(contentId);

                // For now, just remove from local data
                watchlistData = watchlistData.filter(item => item.id != contentId);

                // Update display
                updateStatistics();
                applyFilterAndSort();

                // Animate card removal
                cardElement.style.transform = 'scale(0)';
                cardElement.style.transition = 'all 0.3s ease';

                setTimeout(() => {
                    if (watchlistData.length === 0) {
                        showEmptyState();
                    }
                }, 300);

                CineScope.UI.toast.success('Removed from watchlist');

            } catch (error) {
                console.error('❌ Failed to remove from watchlist:', error);
                CineScope.UI.toast.error('Failed to remove from watchlist');

                // Restore card state
                cardElement.style.opacity = '1';
                cardElement.style.pointerEvents = 'auto';
            }
        }

        async function clearWatchlist() {
            try {
                const confirmBtn = document.getElementById('confirm-clear-btn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Clearing...';

                // Note: In a real implementation, you'd call an API to clear the watchlist
                // await CineScope.HTTP.user.clearWatchlist();

                // For now, just clear local data
                watchlistData = [];
                filteredData = [];

                // Update display
                updateStatistics();
                showEmptyState();

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('clearWatchlistModal'));
                modal.hide();

                CineScope.UI.toast.success('Watchlist cleared');

            } catch (error) {
                console.error('❌ Failed to clear watchlist:', error);
                CineScope.UI.toast.error('Failed to clear watchlist');
            } finally {
                const confirmBtn = document.getElementById('confirm-clear-btn');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-trash me-2"></i>Clear Watchlist';
            }
        }

        function showEmptyState() {
            document.getElementById('content-grid').classList.add('d-none');
            document.getElementById('empty-state').classList.remove('d-none');
        }

        function showContentGrid() {
            document.getElementById('empty-state').classList.add('d-none');
            document.getElementById('content-grid').classList.remove('d-none');
        }

        function showFilteredEmptyState() {
            const container = document.getElementById('content-grid');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-funnel display-1 text-muted mb-4"></i>
                    <h5 class="text-white mb-3">No ${currentFilter === 'tv' ? 'TV Shows' : currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} Found</h5>
                    <p class="text-muted mb-4">You don't have any ${currentFilter === 'tv' ? 'TV shows' : currentFilter} in your watchlist yet.</p>
                    <button class="btn btn-primary" onclick="document.querySelector('[data-filter=\"all\"]').click()">
                        <i class="bi bi-arrow-left me-2"></i>Show All Items
                    </button>
                </div>
            `;
            showContentGrid();
        }

        function showErrorState(message) {
            const container = document.getElementById('watchlist-container');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle display-1 text-danger mb-4"></i>
                    <h4 class="text-white mb-3">Failed to Load Watchlist</h4>
                    <p class="text-muted mb-4">${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                    </button>
                </div>
            `;
        }
    </script>
</body>

</html>