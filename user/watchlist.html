<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Watchlist - CineScope</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .watchlist-container {
            margin-top: 64px;
            min-height: calc(100vh - 64px);
            padding: var(--spacing-xl) 0;
        }

        .watchlist-header {
            margin-bottom: var(--spacing-2xl);
            text-align: center;
        }

        .watchlist-stats {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            margin: var(--spacing-lg) 0;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: var(--spacing-lg);
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-blue);
            display: block;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .watchlist-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .sort-controls {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .sort-select {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 0.375rem;
            cursor: pointer;
        }

        .view-toggle {
            display: flex;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .view-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .view-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--spacing-lg);
        }

        .watchlist-list {
            display: none;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .watchlist-list.active {
            display: flex;
        }

        .watchlist-grid.list-view {
            display: none;
        }

        .watchlist-item-list {
            display: flex;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .watchlist-item-list:hover {
            background: var(--border-color);
        }

        .item-poster-small {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-right: var(--spacing-md);
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--text-primary);
        }

        .item-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
        }

        .item-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-left: var(--spacing-md);
            align-items: center;
        }

        .remove-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all var(--transition-fast);
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .empty-watchlist {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
        }
    </style>
</head>

<body>
    <div data-include="header"></div>

    <div class="watchlist-container">
        <div class="container">
            <div class="watchlist-header">
                <h1>📋 My Watchlist</h1>
                <p>Keep track of movies and shows you want to watch</p>

                <div class="watchlist-stats" id="watchlist-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="total-items">0</span>
                        <span class="stat-label">Total Items</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="movies-count">0</span>
                        <span class="stat-label">Movies</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="shows-count">0</span>
                        <span class="stat-label">TV Shows</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="anime-count">0</span>
                        <span class="stat-label">Anime</span>
                    </div>
                </div>
            </div>

            <div class="watchlist-controls">
                <div class="sort-controls">
                    <label for="sort-select">Sort by:</label>
                    <select class="sort-select" id="sort-select">
                        <option value="added">Date Added</option>
                        <option value="title">Title</option>
                        <option value="rating">Rating</option>
                        <option value="release">Release Date</option>
                    </select>
                </div>

                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid">Grid</button>
                    <button class="view-btn" data-view="list">List</button>
                </div>
            </div>

            <div class="watchlist-content" id="watchlist-content">
                <div class="watchlist-grid" id="watchlist-grid">
                    <!-- Watchlist items will be loaded here -->
                </div>

                <div class="watchlist-list" id="watchlist-list">
                    <!-- List view items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div data-include="footer"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class WatchlistPage {
            constructor() {
                this.watchlistItems = [];
                this.currentView = 'grid';
                this.sortBy = 'added';
                this.init();
            }

            async init() {
                if (!app.token) {
                    window.location.href = '/login';
                    return;
                }

                this.setupControls();
                await this.loadWatchlist();
            }

            setupControls() {
                // View toggle
                const viewBtns = document.querySelectorAll('.view-btn');
                viewBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        viewBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        this.currentView = btn.dataset.view;
                        this.toggleView();
                    });
                });

                // Sort control
                const sortSelect = document.getElementById('sort-select');
                sortSelect.addEventListener('change', () => {
                    this.sortBy = sortSelect.value;
                    this.sortAndRenderWatchlist();
                });
            }

            async loadWatchlist() {
                try {
                    app.showLoading('Loading your watchlist...');

                    const data = await app.apiCall('/user/watchlist');
                    this.watchlistItems = data.watchlist || [];

                    this.updateStats();
                    this.sortAndRenderWatchlist();

                } catch (error) {
                    console.error('Failed to load watchlist:', error);
                    app.showNotification('Failed to load watchlist', 'error');
                    this.renderEmptyState();
                } finally {
                    app.hideLoading();
                }
            }

            updateStats() {
                const totalItems = this.watchlistItems.length;
                const movieCount = this.watchlistItems.filter(item => item.content_type === 'movie').length;
                const showCount = this.watchlistItems.filter(item => item.content_type === 'tv').length;
                const animeCount = this.watchlistItems.filter(item => item.content_type === 'anime').length;

                document.getElementById('total-items').textContent = totalItems;
                document.getElementById('movies-count').textContent = movieCount;
                document.getElementById('shows-count').textContent = showCount;
                document.getElementById('anime-count').textContent = animeCount;
            }

            sortAndRenderWatchlist() {
                if (this.watchlistItems.length === 0) {
                    this.renderEmptyState();
                    return;
                }

                // Sort items
                const sortedItems = [...this.watchlistItems].sort((a, b) => {
                    switch (this.sortBy) {
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'rating':
                            return (b.rating || 0) - (a.rating || 0);
                        case 'release':
                            return new Date(b.release_date || 0) - new Date(a.release_date || 0);
                        case 'added':
                        default:
                            return new Date(b.added_date || 0) - new Date(a.added_date || 0);
                    }
                });

                this.renderWatchlist(sortedItems);
            }

            renderWatchlist(items) {
                this.renderGridView(items);
                this.renderListView(items);
            }

            renderGridView(items) {
                const grid = document.getElementById('watchlist-grid');
                grid.innerHTML = items.map(item => this.createWatchlistCard(item)).join('');
                app.setupLazyLoading(grid);
            }

            renderListView(items) {
                const list = document.getElementById('watchlist-list');
                list.innerHTML = items.map(item => this.createWatchlistListItem(item)).join('');
            }

            createWatchlistCard(item) {
                return app.createMovieCard(item);
            }

            createWatchlistListItem(item) {
                const posterUrl = item.poster_path || '/assets/placeholder.jpg';
                const rating = item.rating ? item.rating.toFixed(1) : 'N/A';
                const year = item.release_date ? new Date(item.release_date).getFullYear() : '';

                return `
                    <div class="watchlist-item-list">
                        <img src="${posterUrl}" alt="${item.title}" class="item-poster-small" loading="lazy">
                        <div class="item-info">
                            <h3 class="item-title">${item.title}</h3>
                            <div class="item-meta">
                                ${item.content_type.toUpperCase()} • ${year} • ⭐ ${rating}
                            </div>
                            <div class="content-genres">
                                ${(item.genres || []).slice(0, 2).map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-primary btn-sm" onclick="app.navigateToDetails(${item.id})">View</button>
                            <button class="remove-btn" onclick="watchlistPage.removeFromWatchlist(${item.id})">Remove</button>
                        </div>
                    </div>
                `;
            }

            toggleView() {
                const grid = document.getElementById('watchlist-grid');
                const list = document.getElementById('watchlist-list');

                if (this.currentView === 'grid') {
                    grid.style.display = 'grid';
                    list.style.display = 'none';
                } else {
                    grid.style.display = 'none';
                    list.style.display = 'flex';
                }
            }

            async removeFromWatchlist(contentId) {
                try {
                    // This would be an API call to remove from watchlist
                    // await app.apiCall(`/user/watchlist/${contentId}`, { method: 'DELETE' });

                    // For now, remove from local array
                    this.watchlistItems = this.watchlistItems.filter(item => item.id !== contentId);

                    this.updateStats();
                    this.sortAndRenderWatchlist();

                    app.showNotification('Removed from watchlist', 'success');

                } catch (error) {
                    console.error('Failed to remove from watchlist:', error);
                    app.showNotification('Failed to remove from watchlist', 'error');
                }
            }

            renderEmptyState() {
                const content = document.getElementById('watchlist-content');
                content.innerHTML = `
                    <div class="empty-watchlist">
                        <div class="empty-icon">📋</div>
                        <h3>Your watchlist is empty</h3>
                        <p>Start adding movies, shows, and anime you want to watch!</p>
                        <a href="/categories/trending" class="btn btn-primary">Browse Content</a>
                    </div>
                `;
            }
        }

        let watchlistPage;
        document.addEventListener('DOMContentLoaded', () => {
            watchlistPage = new WatchlistPage();
        });
    </script>
</body>

</html>