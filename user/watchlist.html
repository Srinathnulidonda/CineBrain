<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Watchlist - CineScope</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --netflix-red: #e50914;
            --netflix-black: #141414;
            --netflix-gray: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--netflix-black);
            color: white;
        }

        .navbar {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .content-card:hover {
            transform: translateY(-5px);
            border-color: var(--netflix-red);
            background: rgba(255, 255, 255, 0.08);
        }

        .content-image {
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }

        .btn-primary {
            background: var(--netflix-red);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #b8070e;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .filter-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--netflix-red);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .list-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .view-toggle {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-toggle.active {
            background: var(--netflix-red);
            border-color: var(--netflix-red);
        }

        @media (max-width: 768px) {
            .grid-view {
                grid-template-columns: 1fr;
            }

            .content-image {
                width: 80px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar fixed top-0 left-0 right-0 z-30 px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="text-white hover:text-red-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-red-600">My Watchlist</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a href="../dashboard.html" class="text-white hover:text-red-500">Dashboard</a>
                <a href="../profile.html" class="text-white hover:text-red-500">Profile</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20 p-6 max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold mb-2">My Watchlist</h1>
                <p class="text-gray-400">Movies and shows you want to watch</p>
            </div>
            
            <!-- Controls -->
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <!-- Sort Filter -->
                <select id="sortFilter" class="filter-select">
                    <option value="added">Recently Added</option>
                    <option value="title">Title</option>
                    <option value="rating">Rating</option>
                    <option value="release">Release Date</option>
                </select>
                
                <!-- Type Filter -->
                <select id="typeFilter" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="movie">Movies</option>
                    <option value="tv">TV Shows</option>
                    <option value="anime">Anime</option>
                </select>
                
                <!-- View Toggle -->
                <div class="flex border border-gray-600 rounded-lg overflow-hidden">
                    <button id="gridViewBtn" class="view-toggle active px-3 py-2" onclick="setView('grid')">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button id="listViewBtn" class="view-toggle px-3 py-2" onclick="setView('list')">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 16a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-500" id="totalItems">0</div>
                <div class="text-sm text-gray-400">Total Items</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-500" id="movieCount">0</div>
                <div class="text-sm text-gray-400">Movies</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-500" id="tvCount">0</div>
                <div class="text-sm text-gray-400">TV Shows</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-500" id="animeCount">0</div>
                <div class="text-sm text-gray-400">Anime</div>
            </div>
        </div>

        <!-- Content Grid/List -->
        <div id="watchlistContainer" class="grid-view">
            <!-- Loading State -->
            <div class="loading-card">
                <div class="h-6 bg-gray-600 rounded mb-2"></div>
                <div class="h-4 bg-gray-600 rounded mb-2"></div>
                <div class="h-4 bg-gray-600 rounded w-3/4"></div>
            </div>
            <div class="loading-card">
                <div class="h-6 bg-gray-600 rounded mb-2"></div>
                <div class="h-4 bg-gray-600 rounded mb-2"></div>
                <div class="h-4 bg-gray-600 rounded w-3/4"></div>
            </div>
            <div class="loading-card">
                <div class="h-6 bg-gray-600 rounded mb-2"></div>
                <div class="h-4 bg-gray-600 rounded mb-2"></div>
                <div class="h-4 bg-gray-600 rounded w-3/4"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
            <div class="empty-state-icon">📖</div>
            <h3 class="text-xl font-bold mb-2">Your watchlist is empty</h3>
            <p class="text-gray-400 mb-6">Start adding movies and shows you want to watch</p>
            <a href="../index.html" class="btn-primary">Browse Content</a>
        </div>
    </main>

    <script>
        // Constants
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        
        // State
        let currentUser = window.currentUser;
        let authToken = window.authToken;
        let watchlistData = [];
        let currentView = 'grid';
        let currentSort = 'added';
        let currentFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            initializeEventListeners();
            loadWatchlist();
        });

        function checkAuthentication() {
            if (!currentUser || !authToken) {
                window.location.href = '../login.html?redirect=user/watchlist.html';
                return;
            }
        }

        function initializeEventListeners() {
            // Sort and filter changes
            document.getElementById('sortFilter').addEventListener('change', function() {
                currentSort = this.value;
                renderWatchlist();
            });

            document.getElementById('typeFilter').addEventListener('change', function() {
                currentFilter = this.value;
                renderWatchlist();
            });
        }

        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    watchlistData = data.watchlist || [];
                    renderWatchlist();
                    updateStats();
                } else {
                    showError(data.error || 'Failed to load watchlist');
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
                showError('Failed to load watchlist');
            }
        }

        function renderWatchlist() {
            const container = document.getElementById('watchlistContainer');
            const emptyState = document.getElementById('emptyState');

            // Filter data
            let filteredData = watchlistData.filter(item => {
                if (currentFilter === 'all') return true;
                return item.content_type === currentFilter;
            });

            // Sort data
            filteredData.sort((a, b) => {
                switch (currentSort) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'release':
                        return new Date(b.release_date || 0) - new Date(a.release_date || 0);
                    default: // 'added'
                        return new Date(b.added_at || 0) - new Date(a.added_at || 0);
                }
            });

            if (filteredData.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');

            if (currentView === 'grid') {
                container.className = 'grid-view';
                container.innerHTML = filteredData.map(item => createGridCard(item)).join('');
            } else {
                container.className = 'list-view';
                container.innerHTML = filteredData.map(item => createListCard(item)).join('');
            }
        }

        function createGridCard(item) {
            const posterUrl = item.poster_path || 'https://via.placeholder.com/300x450/333/fff?text=No+Image';
            const rating = item.rating ? `⭐ ${item.rating.toFixed(1)}` : '';
            const ottInfo = getOTTInfo(item.ott_platforms);

            return `
                <div class="content-card" onclick="openContentDetails(${item.id})">
                    <div class="p-4">
                        <div class="flex space-x-4">
                            <img src="${posterUrl}" alt="${item.title}" class="content-image" loading="lazy">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg mb-2">${item.title}</h3>
                                <div class="flex items-center space-x-4 text-sm text-gray-400 mb-2">
                                    <span class="capitalize">${item.content_type}</span>
                                    ${rating ? `<span>${rating}</span>` : ''}
                                    ${item.release_date ? `<span>${new Date(item.release_date).getFullYear()}</span>` : ''}
                                </div>
                                <p class="text-gray-300 text-sm mb-3 line-clamp-2">${item.overview || 'No description available.'}</p>
                                <div class="mb-3">
                                    ${(item.genres || []).slice(0, 3).map(genre => 
                                        `<span class="inline-block bg-red-600 bg-opacity-20 text-red-400 px-2 py-1 rounded text-xs mr-1">${genre}</span>`
                                    ).join('')}
                                </div>
                                ${ottInfo}
                                <div class="flex space-x-2 mt-3">
                                    <button class="btn-primary" onclick="event.stopPropagation(); openContentDetails(${item.id})">
                                        Watch Now
                                    </button>
                                    <button class="btn-secondary" onclick="event.stopPropagation(); removeFromWatchlist(${item.id})">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createListCard(item) {
            const posterUrl = item.poster_path || 'https://via.placeholder.com/300x450/333/fff?text=No+Image';
            const rating = item.rating ? `⭐ ${item.rating.toFixed(1)}` : '';
            const ottInfo = getOTTInfo(item.ott_platforms);

            return `
                <div class="content-card" onclick="openContentDetails(${item.id})">
                    <div class="p-4">
                        <div class="flex space-x-4">
                            <img src="${posterUrl}" alt="${item.title}" class="content-image" loading="lazy">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-xl">${item.title}</h3>
                                    <div class="flex space-x-2">
                                        <button class="btn-primary" onclick="event.stopPropagation(); openContentDetails(${item.id})">
                                            Watch
                                        </button>
                                        <button class="btn-secondary" onclick="event.stopPropagation(); removeFromWatchlist(${item.id})">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4 text-sm text-gray-400 mb-3">
                                    <span class="capitalize">${item.content_type}</span>
                                    ${rating ? `<span>${rating}</span>` : ''}
                                    ${item.release_date ? `<span>${new Date(item.release_date).getFullYear()}</span>` : ''}
                                </div>
                                <p class="text-gray-300 mb-3">${item.overview || 'No description available.'}</p>
                                <div class="flex items-center space-x-4">
                                    <div>
                                        ${(item.genres || []).slice(0, 5).map(genre => 
                                            `<span class="inline-block bg-red-600 bg-opacity-20 text-red-400 px-2 py-1 rounded text-xs mr-1">${genre}</span>`
                                        ).join('')}
                                    </div>
                                    <div class="ml-auto">
                                        ${ottInfo}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getOTTInfo(ottPlatforms) {
            if (!ottPlatforms || ottPlatforms.length === 0) {
                return '<div class="text-xs text-gray-500">No streaming info</div>';
            }

            const platforms = typeof ottPlatforms === 'string' ? JSON.parse(ottPlatforms) : ottPlatforms;
            const freePlatforms = platforms.filter(p => p.is_free);
            const paidPlatforms = platforms.filter(p => !p.is_free);

            let html = '<div class="text-xs">';
            
            if (freePlatforms.length > 0) {
                html += `<span class="bg-green-600 bg-opacity-20 text-green-400 px-2 py-1 rounded mr-1">FREE (${freePlatforms.length})</span>`;
            }
            
            if (paidPlatforms.length > 0) {
                html += `<span class="bg-orange-600 bg-opacity-20 text-orange-400 px-2 py-1 rounded">PAID (${paidPlatforms.length})</span>`;
            }
            
            html += '</div>';
            return html;
        }

        function updateStats() {
            const total = watchlistData.length;
            const movies = watchlistData.filter(item => item.content_type === 'movie').length;
            const tvShows = watchlistData.filter(item => item.content_type === 'tv').length;
            const anime = watchlistData.filter(item => item.content_type === 'anime').length;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('movieCount').textContent = movies;
            document.getElementById('tvCount').textContent = tvShows;
            document.getElementById('animeCount').textContent = anime;
        }

        function setView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            
            // Re-render
            renderWatchlist();
        }

        async function removeFromWatchlist(contentId) {
            if (!confirm('Remove this item from your watchlist?')) return;

            try {
                // Note: API endpoint for removing from watchlist would be needed
                // For now, just remove from local data
                watchlistData = watchlistData.filter(item => item.id !== contentId);
                renderWatchlist();
                updateStats();
                showNotification('Removed from watchlist');
            } catch (error) {
                console.error('Failed to remove from watchlist:', error);
                showNotification('Failed to remove from watchlist');
            }
        }

        function openContentDetails(contentId) {
            window.location.href = `../details.html?id=${contentId}`;
        }

        function showError(message) {
            const container = document.getElementById('watchlistContainer');
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-xl text-red-500">${message}</p>
                    <button onclick="loadWatchlist()" class="btn-primary mt-4">Try Again</button>
                </div>
            `;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-green-600 text-white px-4 py-2 rounded-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function goBack() {
            window.location.href = '../dashboard.html';
        }
    </script>
</body>
</html>