<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - CineScope</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div data-include="header"></div>

    <div class="watchlist-container">
        <div class="container">
            <div class="watchlist-header">
                <h1>❤️ My Favorites</h1>
                <p>Your most loved movies, shows, and anime</p>

                <div class="watchlist-stats" id="favorites-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="total-items">0</span>
                        <span class="stat-label">Total Items</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="movies-count">0</span>
                        <span class="stat-label">Movies</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="shows-count">0</span>
                        <span class="stat-label">TV Shows</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="anime-count">0</span>
                        <span class="stat-label">Anime</span>
                    </div>
                </div>
            </div>

            <div class="watchlist-controls">
                <div class="sort-controls">
                    <label for="sort-select">Sort by:</label>
                    <select class="sort-select" id="sort-select">
                        <option value="added">Date Added</option>
                        <option value="title">Title</option>
                        <option value="rating">Rating</option>
                        <option value="release">Release Date</option>
                    </select>
                </div>

                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid">Grid</button>
                    <button class="view-btn" data-view="list">List</button>
                </div>
            </div>

            <div class="watchlist-content" id="favorites-content">
                <div class="watchlist-grid" id="favorites-grid">
                    <!-- Favorite items will be loaded here -->
                </div>

                <div class="watchlist-list" id="favorites-list">
                    <!-- List view items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div data-include="footer"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>

    <script>
        // Similar implementation to watchlist but for favorites
        class FavoritesPage {
            constructor() {
                this.favoriteItems = [];
                this.currentView = 'grid';
                this.sortBy = 'added';
                this.init();
            }

            async init() {
                if (!app.token) {
                    window.location.href = '/login';
                    return;
                }

                this.setupControls();
                await this.loadFavorites();
            }

            setupControls() {
                // Similar to watchlist controls
                const viewBtns = document.querySelectorAll('.view-btn');
                viewBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        viewBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        this.currentView = btn.dataset.view;
                        this.toggleView();
                    });
                });

                const sortSelect = document.getElementById('sort-select');
                sortSelect.addEventListener('change', () => {
                    this.sortBy = sortSelect.value;
                    this.sortAndRenderFavorites();
                });
            }

            async loadFavorites() {
                try {
                    app.showLoading('Loading your favorites...');

                    const data = await app.apiCall('/user/favorites');
                    this.favoriteItems = data.favorites || [];

                    this.updateStats();
                    this.sortAndRenderFavorites();

                } catch (error) {
                    console.error('Failed to load favorites:', error);
                    app.showNotification('Failed to load favorites', 'error');
                    this.renderEmptyState();
                } finally {
                    app.hideLoading();
                }
            }

            updateStats() {
                const totalItems = this.favoriteItems.length;
                const movieCount = this.favoriteItems.filter(item => item.content_type === 'movie').length;
                const showCount = this.favoriteItems.filter(item => item.content_type === 'tv').length;
                const animeCount = this.favoriteItems.filter(item => item.content_type === 'anime').length;

                document.getElementById('total-items').textContent = totalItems;
                document.getElementById('movies-count').textContent = movieCount;
                document.getElementById('shows-count').textContent = showCount;
                document.getElementById('anime-count').textContent = animeCount;
            }

            sortAndRenderFavorites() {
                if (this.favoriteItems.length === 0) {
                    this.renderEmptyState();
                    return;
                }

                const sortedItems = [...this.favoriteItems].sort((a, b) => {
                    switch (this.sortBy) {
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'rating':
                            return (b.rating || 0) - (a.rating || 0);
                        case 'release':
                            return new Date(b.release_date || 0) - new Date(a.release_date || 0);
                        case 'added':
                        default:
                            return new Date(b.added_date || 0) - new Date(a.added_date || 0);
                    }
                });

                this.renderFavorites(sortedItems);
            }

            renderFavorites(items) {
                this.renderGridView(items);
                this.renderListView(items);
            }

            renderGridView(items) {
                const grid = document.getElementById('favorites-grid');
                grid.innerHTML = items.map(item => app.createMovieCard(item)).join('');
                app.setupLazyLoading(grid);
            }

            renderListView(items) {
                const list = document.getElementById('favorites-list');
                list.innerHTML = items.map(item => this.createFavoriteListItem(item)).join('');
            }

            createFavoriteListItem(item) {
                const posterUrl = item.poster_path || '/assets/placeholder.jpg';
                const rating = item.rating ? item.rating.toFixed(1) : 'N/A';
                const year = item.release_date ? new Date(item.release_date).getFullYear() : '';

                return `
                    <div class="watchlist-item-list">
                        <img src="${posterUrl}" alt="${item.title}" class="item-poster-small" loading="lazy">
                        <div class="item-info">
                            <h3 class="item-title">${item.title}</h3>
                            <div class="item-meta">
                                ${item.content_type.toUpperCase()} • ${year} • ⭐ ${rating}
                            </div>
                            <div class="content-genres">
                                ${(item.genres || []).slice(0, 2).map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-primary btn-sm" onclick="app.navigateToDetails(${item.id})">View</button>
                            <button class="remove-btn" onclick="favoritesPage.removeFromFavorites(${item.id})">Remove</button>
                        </div>
                    </div>
                `;
            }

            toggleView() {
                const grid = document.getElementById('favorites-grid');
                const list = document.getElementById('favorites-list');

                if (this.currentView === 'grid') {
                    grid.style.display = 'grid';
                    list.style.display = 'none';
                } else {
                    grid.style.display = 'none';
                    list.style.display = 'flex';
                }
            }

            async removeFromFavorites(contentId) {
                try {
                    this.favoriteItems = this.favoriteItems.filter(item => item.id !== contentId);

                    this.updateStats();
                    this.sortAndRenderFavorites();

                    app.showNotification('Removed from favorites', 'success');

                } catch (error) {
                    console.error('Failed to remove from favorites:', error);
                    app.showNotification('Failed to remove from favorites', 'error');
                }
            }

            renderEmptyState() {
                const content = document.getElementById('favorites-content');
                content.innerHTML = `
                    <div class="empty-watchlist">
                        <div class="empty-icon">❤️</div>
                        <h3>No favorites yet</h3>
                        <p>Start favoriting content you love!</p>
                        <a href="/categories/trending" class="btn btn-primary">Browse Content</a>
                    </div>
                `;
            }
        }

        let favoritesPage;
        document.addEventListener('DOMContentLoaded', () => {
            favoritesPage = new FavoritesPage();
        });
    </script>
</body>

</html>