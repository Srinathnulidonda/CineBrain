<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header__breadcrumb">
                        <a href="/" class="text-muted">Home</a>
                        <span class="page-header__breadcrumb-separator">/</span>
                        <a href="#" onclick="navigateToProfile()" class="text-muted">Profile</a>
                        <span class="page-header__breadcrumb-separator">/</span>
                        <span>Favorites</span>
                    </div>
                    <h1 class="page-header__title">
                        <i class="bi bi-heart-fill text-error"></i> My Favorites
                    </h1>
                    <p class="page-header__description" id="favoritesDescription">
                        You have 0 favorites
                    </p>
                </div>

                <!-- View Options -->
                <div class="d-flex justify-between align-center mb-xl">
                    <div class="d-flex gap-sm">
                        <button class="btn btn-sm btn-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                            <i class="bi bi-grid-3x3-gap"></i> Grid
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleView('list')" id="listViewBtn">
                            <i class="bi bi-list"></i> List
                        </button>
                    </div>

                    <select class="form-control" id="sortBy" style="width: auto;">
                        <option value="added_desc">Recently Added</option>
                        <option value="title_asc">Title (A-Z)</option>
                        <option value="rating_desc">Highest Rated</option>
                    </select>
                </div>

                <!-- Favorites Container -->
                <div id="favoritesContainer">
                    <!-- Loading skeleton -->
                    <div class="content-grid content-grid--movies">
                        <div class="content-card skeleton" style="height: 300px;"></div>
                        <div class="content-card skeleton" style="height: 300px;"></div>
                        <div class="content-card skeleton" style="height: 300px;"></div>
                        <div class="content-card skeleton" style="height: 300px;"></div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="bi bi-heart empty-state__icon"></i>
                    <h2 class="empty-state__title">No favorites yet</h2>
                    <p class="empty-state__description">
                        Start adding movies and shows you love
                    </p>
                    <button class="btn btn-primary" onclick="router.navigate('/content/search.html')">
                        Discover Content
                    </button>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" onclick="navigateToWatchlist()" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" onclick="navigateToProfile()" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login if not authenticated
        }

        let favoriteItems = [];
        let currentView = 'grid';

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            updateNavigation();
            await loadFavorites();
            setupSorting();
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const user = auth.getUser();

            navbarUser.innerHTML = `
                <a href="${auth.getUserUrl('watchlist')}" class="navbar__link">
                    <i class="bi bi-bookmark"></i>
                </a>
                <a href="${auth.getUserUrl('favorites')}" class="navbar__link navbar__link--active">
                    <i class="bi bi-heart-fill"></i>
                </a>
                <div class="navbar__avatar">
                    <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                </div>
            `;
        }

        async function loadFavorites() {
            try {
                const response = await api.getFavorites();
                favoriteItems = response.favorites || [];

                // Update description
                document.getElementById('favoritesDescription').textContent =
                    `You have ${favoriteItems.length} favorite${favoriteItems.length !== 1 ? 's' : ''}`;

                // Cache favorites
                Storage.setFavoritesCache(favoriteItems);

                renderFavorites();
            } catch (error) {
                console.error('Failed to load favorites:', error);
                // Try to load from cache
                favoriteItems = Storage.getFavoritesCache();
                renderFavorites();
            }
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesContainer');
            const emptyState = document.getElementById('emptyState');

            if (favoriteItems.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderListView();
            }
        }

        function renderGridView() {
            const container = document.getElementById('favoritesContainer');
            container.innerHTML = `
                <div class="content-grid content-grid--movies stagger-animation">
                    ${favoriteItems.map((item, index) => `
                        <div class="content-card animate-fadeInUp" style="animation-delay: ${index * 0.1}s">
                            <div class="content-card__image-wrapper" onclick="navigateToContentDetails(${item.id})">
                                <img src="${item.poster_path}" 
                                     alt="${item.title}" 
                                     class="content-card__image"
                                     loading="lazy">
                                <button class="content-card__badge bg-error" 
                                        onclick="event.stopPropagation(); removeFromFavorites(${item.id})"
                                        title="Remove from favorites">
                                    <i class="bi bi-heart-fill"></i>
                                </button>
                            </div>
                            <div class="content-card__body" onclick="navigateToContentDetails(${item.id})">
                                <h3 class="content-card__title">${item.title}</h3>
                                <div class="content-card__meta">
                                    <span class="content-card__rating">
                                        <i class="bi bi-star-fill content-card__rating-star"></i>
                                        ${item.rating || 'N/A'}
                                    </span>
                                    <span>${item.content_type}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderListView() {
            const container = document.getElementById('favoritesContainer');
            container.innerHTML = `
                <div class="space-y-md">
                    ${favoriteItems.map((item, index) => `
                        <div class="d-flex gap-md p-md bg-secondary rounded-lg animate-fadeInUp" 
                             style="animation-delay: ${index * 0.1}s">
                            <img src="${item.poster_path}" 
                                 alt="${item.title}"
                                 style="width: 100px; height: 150px; object-fit: cover; border-radius: 8px;"
                                 onclick="navigateToContentDetails(${item.id})"
                                 class="cursor-pointer">
                            <div class="flex-grow-1">
                                <h3 class="mb-sm cursor-pointer hover:text-blue" 
                                    onclick="navigateToContentDetails(${item.id})">${item.title}</h3>
                                <div class="d-flex gap-md mb-sm text-sm text-muted">
                                    <span><i class="bi bi-star-fill text-gold"></i> ${item.rating || 'N/A'}</span>
                                    <span>${item.content_type.toUpperCase()}</span>
                                    ${item.release_date ? `<span>${new Date(item.release_date).getFullYear()}</span>` : ''}
                                </div>
                                <p class="text-sm text-secondary mb-md">${item.overview || 'No description available.'}</p>
                                <div class="d-flex gap-sm">
                                    <button class="btn btn-sm btn-secondary" onclick="navigateToContentDetails(${item.id})">
                                        <i class="bi bi-play-fill"></i> Watch
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="removeFromFavorites(${item.id})">
                                        <i class="bi bi-heart-fill"></i> Remove
                                    </button>
                                    ${item.youtube_trailer ? `
                                        <button class="btn btn-sm btn-secondary" onclick="window.open('${item.youtube_trailer}', '_blank')">
                                            <i class="bi bi-youtube"></i> Trailer
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleView(view) {
            currentView = view;

            // Update button states
            if (view === 'grid') {
                document.getElementById('gridViewBtn').classList.add('btn-primary');
                document.getElementById('gridViewBtn').classList.remove('btn-secondary');
                document.getElementById('listViewBtn').classList.add('btn-secondary');
                document.getElementById('listViewBtn').classList.remove('btn-primary');
            } else {
                document.getElementById('listViewBtn').classList.add('btn-primary');
                document.getElementById('listViewBtn').classList.remove('btn-secondary');
                document.getElementById('gridViewBtn').classList.add('btn-secondary');
                document.getElementById('gridViewBtn').classList.remove('btn-primary');
            }

            renderFavorites();
        }

        function setupSorting() {
            document.getElementById('sortBy').addEventListener('change', (e) => {
                const sortBy = e.target.value;

                switch (sortBy) {
                    case 'title_asc':
                        favoriteItems.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'rating_desc':
                        favoriteItems.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                        break;
                    case 'added_desc':
                    default:
                        // Keep original order (most recent first)
                        break;
                }

                renderFavorites();
            });
        }

        async function removeFromFavorites(contentId) {
            if (!confirm('Remove from favorites?')) return;

            try {
                await api.recordInteraction(contentId, 'remove_favorite');

                // Remove from local array
                favoriteItems = favoriteItems.filter(item => item.id !== contentId);

                // Update cache
                Storage.setFavoritesCache(favoriteItems);

                // Update UI
                document.getElementById('favoritesDescription').textContent =
                    `You have ${favoriteItems.length} favorite${favoriteItems.length !== 1 ? 's' : ''}`;

                renderFavorites();
                showToast('Removed from favorites', 'success');
            } catch (error) {
                showToast('Failed to remove from favorites', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>

</html>