<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Favorites - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/bootstrap-overrides.css" rel="stylesheet">
    <link href="/css/tailwind.css" rel="stylesheet">
    <link href="/css/animation.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    <link href="/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Desktop Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Header -->
                <div class="mb-4">
                    <h1 class="tw-text-3xl tw-font-bold mb-3">
                        <i class="bi bi-heart-fill text-danger"></i> My Favorites
                    </h1>
                    <p class="text-muted">Your most loved movies and shows</p>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-primary mb-0" id="totalFavorites">0</h3>
                                <small class="text-muted">Total Favorites</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-success mb-0" id="movieCount">0</h3>
                                <small class="text-muted">Movies</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-info mb-0" id="tvCount">0</h3>
                                <small class="text-muted">TV Shows</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="text-warning mb-0" id="avgRating">0.0</h3>
                                <small class="text-muted">Avg Rating</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sort Options -->
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <select class="form-select" style="width: auto;" id="sortBy">
                        <option value="added">Recently Added</option>
                        <option value="rating">Highest Rated</option>
                        <option value="title">Title (A-Z)</option>
                        <option value="year">Release Year</option>
                    </select>

                    <div class="btn-group ms-auto" role="group">
                        <button class="btn btn-outline-secondary active" id="gridViewBtn" onclick="setView('grid')">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button class="btn btn-outline-secondary" id="listViewBtn" onclick="setView('list')">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Favorites Content -->
                <div id="favoritesContent">
                    <!-- Loading State -->
                    <div id="loadingState">
                        <div class="row g-4">
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="skeleton-card">
                                    <div class="skeleton-img"></div>
                                    <div class="skeleton-body">
                                        <div class="skeleton-title"></div>
                                        <div class="skeleton-text"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="skeleton-card">
                                    <div class="skeleton-img"></div>
                                    <div class="skeleton-body">
                                        <div class="skeleton-title"></div>
                                        <div class="skeleton-text"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid View -->
                    <div class="row g-4 d-none" id="gridView"></div>

                    <!-- List View -->
                    <div class="d-none" id="listView"></div>

                    <!-- Empty State -->
                    <div class="empty-state d-none" id="emptyState">
                        <i class="bi bi-heart"></i>
                        <h5>No favorites yet</h5>
                        <p>Start adding movies and shows you love</p>
                        <a href="/content/search" class="btn btn-primary">Discover Content</a>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="mt-4 d-none" id="exportSection">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Export Your Favorites</h5>
                            <p class="card-text">Download your favorites list or share it with friends</p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" onclick="exportFavorites('json')">
                                    <i class="bi bi-download"></i> Export as JSON
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportFavorites('csv')">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Export as CSV
                                </button>
                                <button class="btn btn-outline-primary" onclick="shareFavorites()">
                                    <i class="bi bi-share"></i> Share List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <div id="mobile-nav-container"></div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>

    <!-- Page specific JS -->
    <script>
        let favoritesData = [];
        let currentView = 'grid';

        // Initialize page
        async function pageInit() {
            // Set up event listeners
            setupEventListeners();

            // Load favorites
            await loadFavorites();
        }

        function setupEventListeners() {
            // Sort change
            document.getElementById('sortBy').addEventListener('change', () => {
                sortFavorites();
                displayFavorites();
            });
        }

        async function loadFavorites() {
            const user = Storage.getUser();

            try {
                if (user) {
                    // Load from API for logged-in users
                    const response = await api.user.getFavorites();
                    favoritesData = response.favorites || [];
                } else {
                    // Load from local storage for anonymous users
                    const favoriteIds = Storage.getLocalFavorites();

                    // Fetch details for each content ID
                    favoritesData = [];
                    for (const id of favoriteIds) {
                        try {
                            const content = await api.content.getDetails(id);
                            favoritesData.push({
                                id: content.id,
                                title: content.title,
                                content_type: content.content_type,
                                genres: content.genres,
                                rating: content.rating,
                                poster_path: content.poster_path,
                                release_date: content.release_date,
                                overview: content.overview,
                                youtube_trailer: content.youtube_trailer,
                                added_date: new Date().toISOString() // Would come from backend normally
                            });
                        } catch (error) {
                            console.error(`Failed to load content ${id}:`, error);
                        }
                    }
                }

                // Update stats
                updateStats();

                // Sort and display
                sortFavorites();
                displayFavorites();

                // Show export section if has favorites
                if (favoritesData.length > 0) {
                    document.getElementById('exportSection').classList.remove('d-none');
                }

            } catch (error) {
                console.error('Error loading favorites:', error);
                UI.showToast('Failed to load favorites', 'error');
                showEmptyState();
            }
        }

        function updateStats() {
            document.getElementById('totalFavorites').textContent = favoritesData.length;

            const movieCount = favoritesData.filter(c => c.content_type === 'movie').length;
            const tvCount = favoritesData.filter(c => c.content_type === 'tv').length;
            const animeCount = favoritesData.filter(c => c.content_type === 'anime').length;

            document.getElementById('movieCount').textContent = movieCount;
            document.getElementById('tvCount').textContent = tvCount + animeCount;

            const avgRating = favoritesData.length > 0
                ? (favoritesData.reduce((sum, c) => sum + (c.rating || 0), 0) / favoritesData.length).toFixed(1)
                : '0.0';
            document.getElementById('avgRating').textContent = avgRating;
        }

        function sortFavorites() {
            const sortBy = document.getElementById('sortBy').value;

            switch (sortBy) {
                case 'added':
                    favoritesData.sort((a, b) => new Date(b.added_date) - new Date(a.added_date));
                    break;
                case 'rating':
                    favoritesData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'title':
                    favoritesData.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'year':
                    favoritesData.sort((a, b) => {
                        const yearA = a.release_date ? new Date(a.release_date).getFullYear() : 0;
                        const yearB = b.release_date ? new Date(b.release_date).getFullYear() : 0;
                        return yearB - yearA;
                    });
                    break;
            }
        }

        function displayFavorites() {
            const loadingState = document.getElementById('loadingState');
            const gridView = document.getElementById('gridView');
            const listView = document.getElementById('listView');
            const emptyState = document.getElementById('emptyState');

            // Hide loading
            loadingState.classList.add('d-none');

            if (favoritesData.length === 0) {
                // Show empty state
                emptyState.classList.remove('d-none');
                gridView.classList.add('d-none');
                listView.classList.add('d-none');
            } else {
                // Show appropriate view
                emptyState.classList.add('d-none');

                if (currentView === 'grid') {
                    gridView.classList.remove('d-none');
                    listView.classList.add('d-none');
                    displayGridView();
                } else {
                    gridView.classList.add('d-none');
                    listView.classList.remove('d-none');
                    displayListView();
                }
            }
        }

        function displayGridView() {
            const gridView = document.getElementById('gridView');

            gridView.innerHTML = favoritesData.map(content => {
                const posterUrl = content.poster_path || '/assets/no-poster.jpg';
                const rating = content.rating ? content.rating.toFixed(1) : 'N/A';
                const year = content.release_date ? new Date(content.release_date).getFullYear() : '';

                return `
                    <div class="col-6 col-md-4 col-lg-3" id="favorite-item-${content.id}">
                        <div class="content-card position-relative">
                            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                    style="z-index: 10;" 
                                    onclick="event.stopPropagation(); removeFromFavorites(${content.id})">
                                <i class="bi bi-heart-fill"></i>
                            </button>
                            <div onclick="window.location.href='/content/details?id=${content.id}'">
                                <div class="content-poster">
                                    <img src="${posterUrl}" alt="${content.title}" loading="lazy">
                                    <div class="content-overlay">
                                        <button class="btn-play" onclick="event.stopPropagation(); UI.playTrailer('${content.youtube_trailer || ''}', '${content.title}')">
                                            <i class="bi bi-play-circle-fill"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="content-info">
                                    <h6 class="content-title">${content.title}</h6>
                                    <div class="content-meta">
                                        <span class="badge-rating">
                                            <i class="bi bi-star-fill"></i> ${rating}
                                        </span>
                                        ${year ? `<span class="text-muted">${year}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayListView() {
            const listView = document.getElementById('listView');

            listView.innerHTML = `
                <div class="list-group">
                    ${favoritesData.map(content => {
                const posterUrl = content.poster_path || '/assets/no-poster.jpg';
                const rating = content.rating ? content.rating.toFixed(1) : 'N/A';
                const year = content.release_date ? new Date(content.release_date).getFullYear() : '';
                const genres = content.genres ? content.genres.slice(0, 3).join(', ') : '';

                return `
                            <div class="list-group-item p-3" id="favorite-list-item-${content.id}">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <img src="${posterUrl}" alt="${content.title}" 
                                             style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px;">
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1">
                                            <a href="/content/details?id=${content.id}" class="text-decoration-none text-primary">
                                                ${content.title}
                                            </a>
                                        </h6>
                                        <div class="d-flex align-items-center gap-3 mb-1">
                                            <span class="badge-rating">
                                                <i class="bi bi-star-fill"></i> ${rating}
                                            </span>
                                            <span class="text-muted">${year}</span>
                                            <span class="badge badge-secondary">${content.content_type.toUpperCase()}</span>
                                        </div>
                                        <small class="text-muted">${genres}</small>
                                        <p class="mb-0 mt-1 text-muted small line-clamp-2">${content.overview || ''}</p>
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-outline-danger btn-sm" onclick="removeFromFavorites(${content.id})">
                                            <i class="bi bi-heart-fill"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function setView(view) {
            currentView = view;

            // Update button states
            if (view === 'grid') {
                document.getElementById('gridViewBtn').classList.add('active');
                document.getElementById('listViewBtn').classList.remove('active');
            } else {
                document.getElementById('gridViewBtn').classList.remove('active');
                document.getElementById('listViewBtn').classList.add('active');
            }

            displayFavorites();
        }

        async function removeFromFavorites(contentId) {
            const user = Storage.getUser();

            try {
                if (user) {
                    // Remove via API for logged-in users
                    await api.user.recordInteraction(contentId, 'remove_favorite');

                    // Update local cache
                    const favorites = JSON.parse(localStorage.getItem(`user_${user.id}_favorites`) || '[]');
                    const index = favorites.indexOf(contentId);
                    if (index > -1) favorites.splice(index, 1);
                    localStorage.setItem(`user_${user.id}_favorites`, JSON.stringify(favorites));
                } else {
                    // Remove from local storage for anonymous users
                    Storage.removeFromLocalFavorites(contentId);
                }

                // Remove from current data
                favoritesData = favoritesData.filter(content => content.id !== contentId);

                // Update stats
                updateStats();

                // Animate removal
                const gridElement = document.getElementById(`favorite-item-${contentId}`);
                const listElement = document.getElementById(`favorite-list-item-${contentId}`);
                const element = gridElement || listElement;

                if (element) {
                    element.classList.add('animate-fade-out');
                    setTimeout(() => {
                        displayFavorites();
                    }, 300);
                }

                UI.showToast('Removed from favorites', 'success');

                // Hide export section if no favorites
                if (favoritesData.length === 0) {
                    document.getElementById('exportSection').classList.add('d-none');
                }

            } catch (error) {
                console.error('Error removing from favorites:', error);
                UI.showToast('Failed to remove from favorites', 'error');
            }
        }

        function exportFavorites(format) {
            if (format === 'json') {
                const data = JSON.stringify(favoritesData, null, 2);
                downloadFile(data, 'favorites.json', 'application/json');
            } else if (format === 'csv') {
                let csv = 'Title,Type,Rating,Year,Genres\n';
                favoritesData.forEach(content => {
                    const year = content.release_date ? new Date(content.release_date).getFullYear() : '';
                    const genres = content.genres ? content.genres.join('; ') : '';
                    csv += `"${content.title}","${content.content_type}","${content.rating || ''}","${year}","${genres}"\n`;
                });
                downloadFile(csv, 'favorites.csv', 'text/csv');
            }

            UI.showToast('Favorites exported successfully', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function shareFavorites() {
            const shareText = `Check out my CineScope favorites list:\n\n${favoritesData.slice(0, 5).map(c => `â€¢ ${c.title}`).join('\n')}\n\nAnd ${favoritesData.length - 5} more!`;

            if (navigator.share) {
                navigator.share({
                    title: 'My CineScope Favorites',
                    text: shareText,
                    url: window.location.href
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    UI.showToast('Favorites list copied to clipboard', 'success');
                }).catch(() => {
                    UI.showToast('Failed to share favorites', 'error');
                });
            }
        }

        function showEmptyState() {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('gridView').classList.add('d-none');
            document.getElementById('listView').classList.add('d-none');
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('exportSection').classList.add('d-none');
        }

        // Set pageInit for App.js
        window.pageInit = pageInit;
    </script>
</body>

</html>