<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - CineScope</title>
    <meta name="description" content="Your favorite movies, TV shows, and anime on CineScope.">
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <main style="padding-top: 80px;">
        <!-- Page Hero -->
        <section class="page-hero">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                    <span>Favorites</span>
                </div>
                <h1 class="page-title">❤️ My Favorites</h1>
                <p class="page-description" id="favoritesDescription">Your most loved content</p>
            </div>
        </section>

        <div class="container">
            <!-- Favorites Stats -->
            <div class="favorites-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalFavorites">0</div>
                    <div class="stat-label">Total Favorites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgRating">0</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topGenre">-</div>
                    <div class="stat-label">Top Genre</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentCount">0</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <!-- Filters and Actions -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label for="typeFilter">Type:</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="">All</option>
                        <option value="movie">Movies</option>
                        <option value="tv">TV Shows</option>
                        <option value="anime">Anime</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="genreFilter">Genre:</label>
                    <select id="genreFilter" class="filter-select">
                        <option value="">All Genres</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortFilter">Sort by:</label>
                    <select id="sortFilter" class="filter-select">
                        <option value="recent">Recently Added</option>
                        <option value="title">Title</option>
                        <option value="rating">Rating</option>
                        <option value="year">Year</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
                <button class="btn btn-outline" onclick="exportFavorites()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" onclick="toggleView('grid')">
                    <i class="fas fa-th"></i> Grid
                </button>
                <button class="view-btn" data-view="list" onclick="toggleView('list')">
                    <i class="fas fa-list"></i> List
                </button>
            </div>

            <!-- Favorites Content -->
            <div class="content-grid" id="favoritesContent">
                <!-- Content will be loaded here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <h2>No favorites yet</h2>
                <p>Start adding content to your favorites to see them here</p>
                <a href="/" class="btn btn-primary">Discover Content</a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div data-include="footer"></div>

    <!-- Scripts -->
    <script src="/js/include.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/main.js"></script>

    <script>
        let favoritesData = [];
        let currentView = 'grid';

        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) return;
            
            loadFavorites();
        });

        async function loadFavorites() {
            const container = document.getElementById('favoritesContent');
            const emptyState = document.getElementById('emptyState');
            
            try {
                showLoadingSkeleton(container);
                
                const response = await ApiService.getFavorites();
                
                if (response.success && response.data.favorites) {
                    favoritesData = response.data.favorites;
                    
                    if (favoritesData.length > 0) {
                        updateFavoritesStats();
                        populateGenreFilter();
                        renderFavorites(favoritesData);
                        container.style.display = currentView === 'grid' ? 'grid' : 'block';
                        emptyState.style.display = 'none';
                    } else {
                        container.style.display = 'none';
                        emptyState.style.display = 'block';
                    }
                } else {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
                showErrorMessage(container, 'Failed to load favorites');
            }
        }

        function updateFavoritesStats() {
            const total = favoritesData.length;
            const ratings = favoritesData.filter(item => item.rating).map(item => item.rating);
            const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 0;
            
            // Get top genre
            const genreCounts = {};
            favoritesData.forEach(item => {
                if (item.genres) {
                    item.genres.forEach(genre => {
                        genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                    });
                }
            });
            const topGenre = Object.keys(genreCounts).reduce((a, b) => genreCounts[a] > genreCounts[b] ? a : b, '-');
            
            // Count recent (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentCount = favoritesData.filter(item => {
                // This would be based on when it was added to favorites
                // For demo, we'll use a random subset
                return Math.random() > 0.7;
            }).length;
            
            document.getElementById('totalFavorites').textContent = total;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('topGenre').textContent = topGenre;
            document.getElementById('recentCount').textContent = recentCount;
            
            document.getElementById('favoritesDescription').textContent = 
                `${total} favorite${total !== 1 ? 's' : ''} in your collection`;
        }

        function populateGenreFilter() {
            const genreFilter = document.getElementById('genreFilter');
            const genres = new Set();
            
            favoritesData.forEach(item => {
                if (item.genres) {
                    item.genres.forEach(genre => genres.add(genre));
                }
            });
            
            // Clear existing options except "All Genres"
            genreFilter.innerHTML = '<option value="">All Genres</option>';
            
            // Add genre options
            Array.from(genres).sort().forEach(genre => {
                const option = document.createElement('option');
                option.value = genre.toLowerCase();
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        function renderFavorites(data) {
            const container = document.getElementById('favoritesContent');
            
            if (currentView === 'grid') {
                container.className = 'content-grid';
                container.innerHTML = data.map(item => createFavoriteCard(item)).join('');
            } else {
                container.className = 'favorites-list';
                container.innerHTML = data.map(item => createFavoriteListItem(item)).join('');
            }
        }

        function createFavoriteCard(item) {
            return `
                <div class="favorite-card" data-id="${item.id}">
                    <div class="card-image">
                        <img src="${item.poster_path || '/assets/images/placeholder.jpg'}" 
                             alt="${item.title}" class="content-poster">
                        <div class="card-overlay">
                            <button class="action-btn" onclick="viewDetails(${item.id})" title="View Details">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="action-btn remove-btn" onclick="removeFromFavorites(${item.id})" title="Remove">
                                <i class="fas fa-heart-broken"></i>
                            </button>
                        </div>
                        <div class="favorite-badge">❤️</div>
                    </div>
                    <div class="card-info">
                        <h3 class="content-title">${item.title}</h3>
                        <div class="content-meta">
                            <span class="content-type">${item.content_type.toUpperCase()}</span>
                            ${item.rating ? `<span class="rating">⭐ ${item.rating}</span>` : ''}
                        </div>
                        <div class="genres">
                            ${item.genres ? item.genres.slice(0, 2).map(genre => `<span class="genre-tag">${genre}</span>`).join('') : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function createFavoriteListItem(item) {
            return `
                <div class="favorite-list-item" data-id="${item.id}">
                    <img src="${item.poster_path || '/assets/images/placeholder.jpg'}" 
                         alt="${item.title}" class="list-poster">
                    <div class="list-content">
                        <h3 class="list-title">${item.title}</h3>
                        <div class="list-meta">
                            <span class="content-type">${item.content_type.toUpperCase()}</span>
                            ${item.rating ? `<span class="rating">⭐ ${item.rating}</span>` : ''}
                            ${item.release_date ? `<span class="year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                        </div>
                        <p class="list-overview">${(item.overview || '').substring(0, 200)}${item.overview && item.overview.length > 200 ? '...' : ''}</p>
                        <div class="list-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewDetails(${item.id})">
                                View Details
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="addToWatchlist(${item.id})">
                                <i class="fas fa-bookmark"></i> Watchlist
                            </button>
                            <button class="btn btn-ghost btn-sm remove-btn" onclick="removeFromFavorites(${item.id})">
                                <i class="fas fa-heart-broken"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function removeFromFavorites(contentId) {
            if (!confirm('Remove this item from your favorites?')) return;
            
            try {
                const card = document.querySelector(`[data-id="${contentId}"]`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }
                
                // Simulate API call
                setTimeout(() => {
                    favoritesData = favoritesData.filter(item => item.id !== contentId);
                    updateFavoritesStats();
                    populateGenreFilter();
                    renderFavorites(favoritesData);
                    showToast('Removed from favorites', 'success');
                    
                    if (favoritesData.length === 0) {
                        document.getElementById('favoritesContent').style.display = 'none';
                        document.getElementById('emptyState').style.display = 'block';
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error removing from favorites:', error);
                showToast('Failed to remove from favorites', 'error');
            }
        }

        function toggleView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            renderFavorites(favoritesData);
        }

        function applyFilters() {
            const typeFilter = document.getElementById('typeFilter').value;
            const genreFilter = document.getElementById('genreFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            let filtered = [...favoritesData];
            
            // Apply type filter
            if (typeFilter) {
                filtered = filtered.filter(item => item.content_type === typeFilter);
            }
            
            // Apply genre filter
            if (genreFilter) {
                filtered = filtered.filter(item => 
                    item.genres && item.genres.some(genre => genre.toLowerCase().includes(genreFilter))
                );
            }
            
            // Apply sorting
            filtered.sort((a, b) => {
                switch (sortFilter) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'year':
                        const yearA = a.release_date ? new Date(a.release_date).getFullYear() : 0;
                        const yearB = b.release_date ? new Date(b.release_date).getFullYear() : 0;
                        return yearB - yearA;
                    default: // recent
                        return 0;
                }
            });
            
            renderFavorites(filtered);
        }

        function exportFavorites() {
            const data = favoritesData.map(item => ({
                title: item.title,
                type: item.content_type,
                rating: item.rating,
                genres: item.genres ? item.genres.join(', ') : '',
                year: item.release_date ? new Date(item.release_date).getFullYear() : ''
            }));
            
            const csv = [
                'Title,Type,Rating,Genres,Year',
                ...data.map(item => `"${item.title}","${item.type}","${item.rating}","${item.genres}","${item.year}"`)
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-favorites.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Favorites exported successfully!', 'success');
        }
    </script>

    <style>
        .favorites-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            justify-content: flex-end;
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .view-btn.active,
        .view-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .favorite-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.2rem;
            z-index: 2;
        }
        
        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .favorite-list-item {
            background: var(--dark-surface);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            gap: 1rem;
            transition: var(--transition-smooth);
        }
        
        .favorite-list-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .list-poster {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .list-content {
            flex: 1;
            min-width: 0;
        }
        
        .list-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .list-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }
        
        .list-overview {
            color: var(--text-muted);
            line-height: 1.4;
            margin-bottom: 1rem;
        }
        
        .list-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .genre-tag {
            background: var(--gradient-purple);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .favorite-list-item {
                flex-direction: column;
                text-align: center;
            }
            
            .list-poster {
                width: 100px;
                height: 150px;
                margin: 0 auto;
            }
            
            .list-actions {
                justify-content: center;
            }
        }
    </style>
</body>
</html>