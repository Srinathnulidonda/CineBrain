<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="My Favorites - CineScope">
    <title>My Favorites - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="topbar">
        <div class="topbar-left">
            <a href="/" class="logo">CineScope</a>
            <button class="back-btn" onclick="goToProfile()">‚Üê Profile</button>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search..." id="headerSearch">
        </div>
        <div class="topbar-right" id="userSection"></div>
    </nav>

    <main class="favorites-page">
        <div class="container">
            <!-- Favorites Header -->
            <div class="page-header">
                <div class="header-content">
                    <h1 class="page-title">My Favorites</h1>
                    <p class="page-description">Content you absolutely love</p>
                </div>
                <div class="header-stats" id="headerStats">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Favorites Controls -->
            <div class="favorites-controls" id="favoritesControls" style="display: none;">
                <div class="controls-left">
                    <select id="sortSelect" class="control-select" onchange="sortFavorites()">
                        <option value="recent">Recently Added</option>
                        <option value="title">Title A-Z</option>
                        <option value="rating">Highest Rated</option>
                        <option value="year">Newest First</option>
                        <option value="personal">Personal Rating</option>
                    </select>
                    
                    <select id="filterSelect" class="control-select" onchange="filterFavorites()">
                        <option value="all">All Types</option>
                        <option value="movie">Movies</option>
                        <option value="tv">TV Shows</option>
                        <option value="anime">Anime</option>
                    </select>

                    <select id="ratingFilter" class="control-select" onchange="filterByRating()">
                        <option value="all">All Ratings</option>
                        <option value="9+">9.0+ Stars</option>
                        <option value="8+">8.0+ Stars</option>
                        <option value="7+">7.0+ Stars</option>
                        <option value="6+">6.0+ Stars</option>
                    </select>
                </div>

                <div class="controls-right">
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid" onclick="switchView('grid')">
                            <span class="view-icon">‚äû</span> Grid
                        </button>
                        <button class="view-btn" data-view="list" onclick="switchView('list')">
                            <span class="view-icon">‚ò∞</span> List
                        </button>
                        <button class="view-btn" data-view="detailed" onclick="switchView('detailed')">
                            <span class="view-icon">üìÑ</span> Detailed
                        </button>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="exportFavorites()">
                        üì§ Export List
                    </button>
                </div>
            </div>

            <!-- Favorites Content -->
            <div class="favorites-content" id="favoritesContent">
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p>Loading your favorites...</p>
                </div>
            </div>

            <!-- Personal Rating Modal -->
            <div class="modal" id="ratingModal" style="display: none;">
                <div class="modal-backdrop" onclick="closeRatingModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Rate <span id="ratingTitle"></span></h3>
                        <button class="modal-close" onclick="closeRatingModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="rating-section">
                            <p>How much did you enjoy this content?</p>
                            <div class="star-rating" id="starRating">
                                <span class="star" data-rating="1">‚≠ê</span>
                                <span class="star" data-rating="2">‚≠ê</span>
                                <span class="star" data-rating="3">‚≠ê</span>
                                <span class="star" data-rating="4">‚≠ê</span>
                                <span class="star" data-rating="5">‚≠ê</span>
                                <span class="star" data-rating="6">‚≠ê</span>
                                <span class="star" data-rating="7">‚≠ê</span>
                                <span class="star" data-rating="8">‚≠ê</span>
                                <span class="star" data-rating="9">‚≠ê</span>
                                <span class="star" data-rating="10">‚≠ê</span>
                            </div>
                            <div class="rating-display" id="ratingDisplay">Click stars to rate</div>
                        </div>
                        <div class="rating-actions">
                            <button class="btn btn-primary" onclick="submitRating()">Save Rating</button>
                            <button class="btn btn-outline" onclick="closeRatingModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="/" class="mobile-nav-item">
            <span class="mobile-nav-icon">üè†</span>
            <span class="mobile-nav-label">Home</span>
        </a>
        <a href="/content/search.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">üîç</span>
            <span class="mobile-nav-label">Search</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="goToWatchlist()">
            <span class="mobile-nav-icon">üìö</span>
            <span class="mobile-nav-label">Watchlist</span>
        </a>
        <a href="#" class="mobile-nav-item active">
            <span class="mobile-nav-icon">‚ù§Ô∏è</span>
            <span class="mobile-nav-label">Favorites</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="goToProfile()">
            <span class="mobile-nav-icon">üë§</span>
            <span class="mobile-nav-label">Profile</span>
        </a>
    </nav>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let favoritesData = [];
        let filteredData = [];
        let currentView = 'grid';
        let currentUser = null;
        let personalRatings = {};
        let currentRatingContentId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/auth/login.html';
                return;
            }

            // Verify URL username matches current user
            const pathUsername = window.location.pathname.split('/')[1];
            currentUser = window.auth.getUser();
            
            if (pathUsername !== currentUser.username) {
                window.location.href = `/${currentUser.username}/favorites`;
                return;
            }

            updateUserSection();
            setupHeaderSearch();
            setupRatingModal();
            await loadFavoritesData();
        });

        async function loadFavoritesData() {
            try {
                const loadingState = document.getElementById('loadingState');
                loadingState.style.display = 'flex';

                // Load favorites from API
                const response = await window.api.getFavorites();
                favoritesData = response.favorites || [];
                filteredData = [...favoritesData];

                // Load personal ratings from localStorage (simulated)
                personalRatings = JSON.parse(localStorage.getItem(`cinescope_ratings_${currentUser.id}`) || '{}');

                renderHeaderStats();
                renderFavoritesContent();
                
                loadingState.style.display = 'none';
                document.getElementById('favoritesControls').style.display = favoritesData.length > 0 ? 'flex' : 'none';

            } catch (error) {
                console.error('Failed to load favorites:', error);
                showError('Failed to load your favorites');
            }
        }

        function renderHeaderStats() {
            const statsContainer = document.getElementById('headerStats');
            
            if (favoritesData.length === 0) {
                statsContainer.innerHTML = '';
                return;
            }

            const typeCount = {};
            const ratedCount = Object.keys(personalRatings).filter(id => 
                favoritesData.some(item => item.id.toString() === id)
            ).length;
            
            const averageRating = ratedCount > 0 ? 
                Object.entries(personalRatings)
                    .filter(([id]) => favoritesData.some(item => item.id.toString() === id))
                    .reduce((sum, [, rating]) => sum + rating, 0) / ratedCount : 0;

            favoritesData.forEach(item => {
                const type = item.content_type || 'unknown';
                typeCount[type] = (typeCount[type] || 0) + 1;
            });

            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">${favoritesData.length}</div>
                        <div class="stat-label">Total Favorites</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${averageRating.toFixed(1)}</div>
                        <div class="stat-label">Avg Rating</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${typeCount.movie || 0}</div>
                        <div class="stat-label">Movies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${typeCount.tv || 0}</div>
                        <div class="stat-label">TV Shows</div>
                    </div>
                    ${typeCount.anime ? `
                        <div class="stat-item">
                            <div class="stat-number">${typeCount.anime}</div>
                            <div class="stat-label">Anime</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderFavoritesContent() {
            const container = document.getElementById('favoritesContent');
            
            if (filteredData.length === 0 && favoritesData.length === 0) {
                container.innerHTML = renderEmptyState();
                return;
            }

            if (filteredData.length === 0) {
                container.innerHTML = renderNoResultsState();
                return;
            }

            switch (currentView) {
                case 'grid':
                    container.innerHTML = `
                        <div class="favorites-grid">
                            ${filteredData.map(item => renderGridItem(item)).join('')}
                        </div>
                    `;
                    break;
                case 'list':
                    container.innerHTML = `
                        <div class="favorites-list">
                            ${filteredData.map(item => renderListItem(item)).join('')}
                        </div>
                    `;
                    break;
                case 'detailed':
                    container.innerHTML = `
                        <div class="favorites-detailed">
                            ${filteredData.map(item => renderDetailedItem(item)).join('')}
                        </div>
                    `;
                    break;
            }
        }

        function renderEmptyState() {
            return `
                <div class="empty-favorites">
                    <div class="empty-icon">‚ù§Ô∏è</div>
                    <h3>No favorites yet</h3>
                    <p>Start marking content as favorite to build your personal collection of amazing movies, shows, and anime.</p>
                    <div class="empty-actions">
                        <a href="/content/search.html" class="btn btn-primary">Discover Content</a>
                        <a href="/" class="btn btn-outline">Browse Trending</a>
                    </div>
                    <div class="suggestions">
                        <h4>What makes content worth favoriting?</h4>
                        <ul class="favorite-tips">
                            <li>üé≠ Exceptional storytelling and characters</li>
                            <li>üé¨ Outstanding cinematography or animation</li>
                            <li>üí´ Memorable moments you want to revisit</li>
                            <li>üèÜ Award-winning or critically acclaimed</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderNoResultsState() {
            return `
                <div class="no-results">
                    <div class="no-results-icon">üîç</div>
                    <h3>No favorites match your filters</h3>
                    <p>Try adjusting your search criteria or clear the filters.</p>
                    <button class="btn btn-outline" onclick="clearFilters()">Clear All Filters</button>
                </div>
            `;
        }

        function renderGridItem(item) {
            const personalRating = personalRatings[item.id] || null;
            
            return `
                <div class="favorites-card" data-id="${item.id}">
                    <div class="card-image" onclick="viewContent(${item.id})">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                        <div class="card-overlay">
                            <button class="play-btn" onclick="event.stopPropagation(); playTrailer(${item.id})">‚ñ∂</button>
                        </div>
                        <button class="card-remove" onclick="removeFromFavorites(${item.id})" title="Remove from favorites">üíî</button>
                        <div class="card-badges">
                            ${item.rating ? `<span class="rating-badge">‚òÖ ${item.rating}</span>` : ''}
                            ${personalRating ? `<span class="personal-rating-badge">‚ù§Ô∏è ${personalRating}/10</span>` : ''}
                            <span class="type-badge">${item.content_type}</span>
                        </div>
                    </div>
                    <div class="card-info">
                        <h3 class="card-title" onclick="viewContent(${item.id})">${item.title}</h3>
                        <div class="card-meta">
                            ${item.release_date ? `<span class="release-year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                            ${item.runtime ? `<span class="runtime">${item.runtime}m</span>` : ''}
                        </div>
                        <div class="card-genres">
                            ${(item.genres || []).slice(0, 3).map(genre => 
                                `<span class="genre-chip">${genre}</span>`
                            ).join('')}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline" onclick="rateContent(${item.id}, '${item.title}')">
                                ${personalRating ? `‚≠ê ${personalRating}/10` : '‚≠ê Rate'}
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="addToWatchlist(${item.id})">
                                üìö Watchlist
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderListItem(item) {
            const personalRating = personalRatings[item.id] || null;
            
            return `
                <div class="favorites-list-item" data-id="${item.id}">
                    <div class="list-item-poster" onclick="viewContent(${item.id})">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                        <div class="poster-overlay">
                            <button class="play-btn" onclick="event.stopPropagation(); playTrailer(${item.id})">‚ñ∂</button>
                        </div>
                    </div>
                    
                    <div class="list-item-content">
                        <div class="list-item-header">
                            <h3 class="list-item-title" onclick="viewContent(${item.id})">${item.title}</h3>
                            <div class="list-item-ratings">
                                ${item.rating ? `<span class="public-rating">‚òÖ ${item.rating}</span>` : ''}
                                ${personalRating ? `<span class="personal-rating">‚ù§Ô∏è ${personalRating}/10</span>` : ''}
                            </div>
                            <button class="list-item-remove" onclick="removeFromFavorites(${item.id})" title="Remove from favorites">üíî</button>
                        </div>
                        
                        <div class="list-item-meta">
                            <span class="type-badge">${item.content_type}</span>
                            ${item.release_date ? `<span class="year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                            ${item.runtime ? `<span class="runtime">${item.runtime} min</span>` : ''}
                        </div>
                        
                        <div class="list-item-genres">
                            ${(item.genres || []).slice(0, 4).map(genre => 
                                `<span class="genre-chip">${genre}</span>`
                            ).join('')}
                        </div>
                        
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-primary" onclick="playTrailer(${item.id})">
                                ‚ñ∂ Watch Trailer
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="rateContent(${item.id}, '${item.title}')">
                                ${personalRating ? `‚≠ê Edit Rating (${personalRating}/10)` : '‚≠ê Rate This'}
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="addToWatchlist(${item.id})">
                                üìö Add to Watchlist
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="shareContent(${item.id})">
                                üì§ Share
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetailedItem(item) {
            const personalRating = personalRatings[item.id] || null;
            
            return `
                <div class="favorites-detailed-item" data-id="${item.id}">
                    <div class="detailed-poster" onclick="viewContent(${item.id})">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                    </div>
                    
                    <div class="detailed-content">
                        <div class="detailed-header">
                            <h2 class="detailed-title" onclick="viewContent(${item.id})">${item.title}</h2>
                            <button class="detailed-remove" onclick="removeFromFavorites(${item.id})" title="Remove from favorites">üíî Remove</button>
                        </div>
                        
                        <div class="detailed-meta">
                            <span class="type-badge">${item.content_type}</span>
                            ${item.release_date ? `<span class="year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                            ${item.runtime ? `<span class="runtime">${item.runtime} minutes</span>` : ''}
                            ${item.rating ? `<span class="public-rating">‚òÖ ${item.rating}/10 (Public)</span>` : ''}
                            ${personalRating ? `<span class="personal-rating">‚ù§Ô∏è ${personalRating}/10 (Your Rating)</span>` : ''}
                        </div>
                        
                        <div class="detailed-genres">
                            ${(item.genres || []).map(genre => 
                                `<span class="genre-chip">${genre}</span>`
                            ).join('')}
                        </div>
                        
                        <p class="detailed-overview">${item.overview || 'No description available.'}</p>
                        
                        <div class="detailed-actions">
                            <button class="btn btn-primary" onclick="playTrailer(${item.id})">
                                ‚ñ∂ Watch Trailer
                            </button>
                            <button class="btn btn-outline" onclick="rateContent(${item.id}, '${item.title}')">
                                ${personalRating ? `‚≠ê Update Rating (${personalRating}/10)` : '‚≠ê Rate This Content'}
                            </button>
                            <button class="btn btn-secondary" onclick="addToWatchlist(${item.id})">
                                üìö Add to Watchlist
                            </button>
                            <button class="btn btn-secondary" onclick="shareContent(${item.id})">
                                üì§ Share
                            </button>
                            <button class="btn btn-secondary" onclick="viewContent(${item.id})">
                                ‚ÑπÔ∏è Full Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Rating System
        function setupRatingModal() {
            const stars = document.querySelectorAll('#starRating .star');
            let selectedRating = 0;

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.rating);
                    updateStarDisplay(selectedRating);
                });

                star.addEventListener('mouseenter', () => {
                    const rating = parseInt(star.dataset.rating);
                    updateStarDisplay(rating);
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', () => {
                updateStarDisplay(selectedRating);
            });

            function updateStarDisplay(rating) {
                stars.forEach((star, index) => {
                    star.style.opacity = index < rating ? '1' : '0.3';
                });
                document.getElementById('ratingDisplay').textContent = 
                    rating > 0 ? `${rating}/10 stars` : 'Click stars to rate';
            }
        }

        function rateContent(contentId, title) {
            currentRatingContentId = contentId;
            document.getElementById('ratingTitle').textContent = title;
            
            const currentRating = personalRatings[contentId] || 0;
            updateStarDisplay(currentRating);
            
            document.getElementById('ratingModal').style.display = 'flex';
        }

        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('#starRating .star');
            stars.forEach((star, index) => {
                star.style.opacity = index < rating ? '1' : '0.3';
            });
            document.getElementById('ratingDisplay').textContent = 
                rating > 0 ? `${rating}/10 stars` : 'Click stars to rate';
        }

        async function submitRating() {
            const selectedStars = document.querySelectorAll('#starRating .star[style*="opacity: 1"]');
            const rating = selectedStars.length;
            
            if (rating === 0) {
                showToast('Please select a rating', 'warning');
                return;
            }

            try {
                // Save rating locally
                personalRatings[currentRatingContentId] = rating;
                localStorage.setItem(`cinescope_ratings_${currentUser.id}`, JSON.stringify(personalRatings));
                
                // In a real app, this would also save to the backend
                await window.api.recordInteraction({
                    content_id: currentRatingContentId,
                    interaction_type: 'rating',
                    rating: rating
                });
                
                closeRatingModal();
                renderHeaderStats();
                renderFavoritesContent();
                
                showToast(`Rated ${rating}/10 stars`, 'success');
                
            } catch (error) {
                console.error('Failed to save rating:', error);
                showToast('Failed to save rating', 'error');
            }
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').style.display = 'none';
            currentRatingContentId = null;
        }

        // Filtering and Sorting Functions
        function sortFavorites() {
            const sortValue = document.getElementById('sortSelect').value;
            
            switch (sortValue) {
                case 'title':
                    filteredData.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'rating':
                    filteredData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'year':
                    filteredData.sort((a, b) => {
                        const yearA = a.release_date ? new Date(a.release_date).getFullYear() : 0;
                        const yearB = b.release_date ? new Date(b.release_date).getFullYear() : 0;
                        return yearB - yearA;
                    });
                    break;
                case 'personal':
                    filteredData.sort((a, b) => (personalRatings[b.id] || 0) - (personalRatings[a.id] || 0));
                    break;
                default: // recent
                    filteredData = [...favoritesData];
                    applyCurrentFilters();
                    break;
            }
            
            renderFavoritesContent();
        }

        function filterFavorites() {
            applyCurrentFilters();
        }

        function filterByRating() {
            applyCurrentFilters();
        }

        function applyCurrentFilters() {
            const typeFilter = document.getElementById('filterSelect').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            filteredData = favoritesData.filter(item => {
                // Type filter
                if (typeFilter !== 'all' && item.content_type !== typeFilter) {
                    return false;
                }
                
                // Rating filter
                if (ratingFilter !== 'all') {
                    const minRating = parseFloat(ratingFilter.replace('+', ''));
                    if (!item.rating || item.rating < minRating) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderFavoritesContent();
        }

        function clearFilters() {
            document.getElementById('filterSelect').value = 'all';
            document.getElementById('ratingFilter').value = 'all';
            document.getElementById('sortSelect').value = 'recent';
            
            filteredData = [...favoritesData];
            renderFavoritesContent();
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            renderFavoritesContent();
        }

        // Export functionality
        function exportFavorites() {
            if (favoritesData.length === 0) {
                showToast('No favorites to export', 'warning');
                return;
            }

            const exportData = {
                user: currentUser.username,
                exportDate: new Date().toISOString(),
                totalFavorites: favoritesData.length,
                favorites: favoritesData.map(item => ({
                    title: item.title,
                    type: item.content_type,
                    year: item.release_date ? new Date(item.release_date).getFullYear() : null,
                    rating: item.rating,
                    personalRating: personalRatings[item.id] || null,
                    genres: item.genres || []
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinescope-favorites-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Favorites list exported', 'success');
        }

        // Action Functions (similar to watchlist.html)
        async function viewContent(contentId) {
            window.location.href = `/content/details.html?id=${contentId}`;
        }

        async function playTrailer(contentId) {
            try {
                const content = await window.api.getContentDetails(contentId);
                
                if (content.youtube_trailer) {
                    const modal = document.createElement('div');
                    modal.className = 'modal modal-large';
                    modal.innerHTML = `
                        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${content.title} - Trailer</h3>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <iframe 
                                    src="https://www.youtube.com/embed/${content.youtube_trailer_id}?autoplay=1"
                                    frameborder="0" 
                                    allowfullscreen
                                    width="100%" 
                                    height="400">
                                </iframe>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    modal.style.display = 'flex';
                } else {
                    showToast('Trailer not available', 'warning');
                }
            } catch (error) {
                console.error('Failed to play trailer:', error);
                showToast('Failed to load trailer', 'error');
            }
        }

        async function removeFromFavorites(contentId) {
            try {
                await window.api.recordInteraction({
                    content_id: contentId,
                    interaction_type: 'favorite'
                });
                
                // Remove from local data
                favoritesData = favoritesData.filter(item => item.id !== contentId);
                filteredData = filteredData.filter(item => item.id !== contentId);
                
                // Remove personal rating
                delete personalRatings[contentId];
                localStorage.setItem(`cinescope_ratings_${currentUser.id}`, JSON.stringify(personalRatings));
                
                // Re-render
                renderHeaderStats();
                renderFavoritesContent();
                
                // Hide controls if empty
                document.getElementById('favoritesControls').style.display = favoritesData.length > 0 ? 'flex' : 'none';
                
                showToast('Removed from favorites', 'success');
                
            } catch (error) {
                console.error('Failed to remove from favorites:', error);
                showToast('Failed to remove from favorites', 'error');
            }
        }

        async function addToWatchlist(contentId) {
            try {
                await window.api.recordInteraction({
                    content_id: contentId,
                    interaction_type: 'watchlist'
                });
                
                showToast('Added to watchlist', 'success');
            } catch (error) {
                console.error('Failed to add to watchlist:', error);
                showToast('Failed to add to watchlist', 'error');
            }
        }

        async function shareContent(contentId) {
            const item = favoritesData.find(item => item.id === contentId);
            if (!item) return;
            
            const shareData = {
                title: item.title,
                text: `Check out ${item.title} on CineScope! One of my favorites.`,
                url: `${window.location.origin}/content/details.html?id=${contentId}`
            };
            
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        fallbackShare(shareData.url);
                    }
                }
            } else {
                fallbackShare(shareData.url);
            }
        }

        function fallbackShare(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy link', 'error');
            });
        }

        // Utility Functions (same as watchlist.html)
        function updateUserSection() {
            const userSection = document.getElementById('userSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <img src="${window.auth.getUserAvatar()}" 
                         alt="${user.username}" 
                         class="user-avatar"
                         onclick="toggleUserMenu()">
                    <div class="user-dropdown" id="userDropdown" style="display: none;">
                        <a href="/${user.username}/profile" class="dropdown-item">Profile</a>
                        <a href="/${user.username}/watchlist" class="dropdown-item">Watchlist</a>
                        <a href="/${user.username}/favorites" class="dropdown-item active">Favorites</a>
                        <a href="/${user.username}/settings" class="dropdown-item">Settings</a>
                        ${user.is_admin ? '<a href="/admin/" class="dropdown-item">Admin</a>' : ''}
                        <hr>
                        <a href="#" onclick="window.auth.logout()" class="dropdown-item">Logout</a>
                    </div>
                `;
            }
        }

        function setupHeaderSearch() {
            const searchInput = document.getElementById('headerSearch');
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        window.location.href = `/content/search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function goToProfile() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/profile`;
        }

        function goToWatchlist() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/watchlist`;
        }

        function showError(message) {
            document.getElementById('favoritesContent').innerHTML = `
                <div class="error-message">
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.topbar-right')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>