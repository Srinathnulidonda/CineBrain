<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - CineScope</title>
    <meta name="description" content="Your favorite movies, TV shows, and anime that you love the most.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Favorites...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">❤️ My Favorites</h1>
                <p class="text-gray-400">Content you absolutely love</p>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div class="stats-card min-w-0">
                    <div class="stats-value text-2xl" id="favoritesCount">0</div>
                    <div class="stats-label">Favorites</div>
                </div>
                <button class="btn btn-secondary" onclick="shareMyFavorites()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                    Share List
                </button>
            </div>
        </div>

        <!-- Filters and Views -->
        <div class="card mb-8">
            <div class="card-content">
                <div class="grid grid-1 md:grid-5 gap-6">
                    <div>
                        <label class="form-label">Filter by Type</label>
                        <select id="typeFilter" class="form-input">
                            <option value="">All Types</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Filter by Genre</label>
                        <select id="genreFilter" class="form-input">
                            <option value="">All Genres</option>
                            <option value="action">Action</option>
                            <option value="comedy">Comedy</option>
                            <option value="drama">Drama</option>
                            <option value="thriller">Thriller</option>
                            <option value="romance">Romance</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Sort by</label>
                        <select id="sortBy" class="form-input">
                            <option value="added">Date Added</option>
                            <option value="rating">Rating</option>
                            <option value="title">Title</option>
                            <option value="release_date">Release Date</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">View</label>
                        <div class="flex border border-gray-700 rounded-lg overflow-hidden">
                            <button class="flex-1 p-2 bg-primary text-white text-sm" id="gridViewBtn" onclick="setView('grid')">
                                Grid
                            </button>
                            <button class="flex-1 p-2 bg-gray-800 text-gray-400 text-sm" id="listViewBtn" onclick="setView('list')">
                                List
                            </button>
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button class="btn btn-ghost w-full" onclick="createFavoritesList()">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create List
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Favorites Content -->
        <div id="favoritesContent">
            <!-- Content will be loaded here -->
        </div>

        <!-- Statistics -->
        <section class="section mt-16">
            <h2 class="section-title">Your Taste Profile</h2>
            <div class="grid grid-1 md:grid-2 gap-8">
                <!-- Favorite Genres Chart -->
                <div class="card">
                    <div class="card-content">
                        <h3 class="text-lg font-semibold mb-4">Favorite Genres</h3>
                        <div id="genreStats" class="space-y-3">
                            <!-- Genre stats will be populated -->
                        </div>
                    </div>
                </div>

                <!-- Rating Distribution -->
                <div class="card">
                    <div class="card-content">
                        <h3 class="text-lg font-semibold mb-4">Rating Distribution</h3>
                        <div id="ratingStats" class="space-y-3">
                            <!-- Rating stats will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recommendations based on favorites -->
        <section class="section">
            <h2 class="section-title">More Like Your Favorites</h2>
            <p class="text-gray-400 mb-6">Discover content similar to what you love</p>
            <div class="content-grid" id="recommendationsContent">
                <!-- Recommendations will be loaded here -->
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let favoritesItems = [];
        let filteredItems = [];
        let currentView = 'grid';

        document.addEventListener('DOMContentLoaded', async () => {
            if (!appState.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            setupEventListeners();
            await loadFavorites();
            await loadRecommendations();
        });

        function setupEventListeners() {
            ['typeFilter', 'genreFilter', 'sortBy'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFiltersAndSort);
            });
        }

        async function loadFavorites() {
            try {
                const container = document.getElementById('favoritesContent');
                UI.showSkeleton(container, 6);

                const response = await api.getFavorites();
                favoritesItems = response.favorites || [];
                
                document.getElementById('favoritesCount').textContent = favoritesItems.length;
                
                updateStatistics();
                applyFiltersAndSort();

            } catch (error) {
                console.error('Error loading favorites:', error);
                showErrorState();
            }
        }

        function applyFiltersAndSort() {
            const typeFilter = document.getElementById('typeFilter').value;
            const genreFilter = document.getElementById('genreFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // Apply filters
            filteredItems = favoritesItems.filter(item => {
                if (typeFilter && item.content_type !== typeFilter) return false;
                if (genreFilter) {
                    const genres = item.genres || [];
                    if (!genres.some(genre => genre.toLowerCase().includes(genreFilter.toLowerCase()))) {
                        return false;
                    }
                }
                return true;
            });

            // Apply sort
            switch (sortBy) {
                case 'rating':
                    filteredItems.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'title':
                    filteredItems.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'release_date':
                    filteredItems.sort((a, b) => new Date(b.release_date || 0) - new Date(a.release_date || 0));
                    break;
                default: // added
                    // Keep original order
            }

            renderFavorites();
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesContent');

            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❤️</div>
                        <h3 class="empty-state-title">
                            ${favoritesItems.length === 0 ? 'No favorites yet' : 'No items match your filters'}
                        </h3>
                        <p class="empty-state-description">
                            ${favoritesItems.length === 0 
                                ? 'Start adding content you love to your favorites!' 
                                : 'Try adjusting your filters to see more items.'
                            }
                        </p>
                        ${favoritesItems.length === 0 ? `
                            <a href="/categories/trending" class="btn btn-primary mt-4">
                                Discover Content
                            </a>
                        ` : `
                            <button class="btn btn-secondary mt-4" onclick="clearFilters()">
                                Clear Filters
                            </button>
                        `}
                    </div>
                `;
                return;
            }

            if (currentView === 'grid') {
                renderGridView(container);
            } else {
                renderListView(container);
            }
        }

        function renderGridView(container) {
            container.innerHTML = `
                <div class="content-grid">
                    ${filteredItems.map(item => `
                        <div class="movie-card relative group">
                            <img src="${item.poster_path || Utils.getPlaceholderImage()}" 
                                 alt="${Utils.sanitizeHTML(item.title)}" 
                                 class="w-full h-full object-cover rounded-lg"
                                 onerror="this.src='${Utils.getPlaceholderImage()}'">
                            
                            <!-- Favorite indicator -->
                            <div class="absolute top-2 left-2 z-10">
                                <div class="bg-red-600 text-white p-2 rounded-full">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Remove button -->
                            <button class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                    onclick="removeFromFavorites(${item.id})"
                                    title="Remove from favorites">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            
                            <!-- Content overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                                <div class="absolute bottom-0 left-0 right-0 p-4">
                                    <h3 class="font-semibold text-sm mb-2">${Utils.sanitizeHTML(item.title)}</h3>
                                    <div class="flex items-center gap-2 text-xs text-gray-300 mb-3">
                                        ${item.rating ? `<span class="flex items-center gap-1">⭐ ${Utils.formatRating(item.rating)}</span>` : ''}
                                        ${item.release_date ? `<span>${Utils.formatDate(item.release_date)}</span>` : ''}
                                        <span class="badge badge-ghost text-xs">${item.content_type?.toUpperCase()}</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm w-full" onclick="Router.navigate('/details?id=${item.id}')">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            Utils.lazyLoadImages();
        }

        function renderListView(container) {
            container.innerHTML = `
                <div class="space-y-4">
                    ${filteredItems.map(item => `
                        <div class="card">
                            <div class="card-content">
                                <div class="flex gap-4">
                                    <div class="relative">
                                        <img src="${item.poster_path || Utils.getPlaceholderImage(100, 150)}" 
                                             alt="${Utils.sanitizeHTML(item.title)}" 
                                             class="w-20 h-30 object-cover rounded"
                                             onerror="this.src='${Utils.getPlaceholderImage(100, 150)}'">
                                        <div class="absolute -top-2 -right-2 bg-red-600 text-white p-1 rounded-full">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <h3 class="text-lg font-semibold mb-2">${Utils.sanitizeHTML(item.title)}</h3>
                                                <div class="flex items-center gap-4 mb-2 text-sm text-gray-400">
                                                    ${item.rating ? `<span class="flex items-center gap-1">⭐ ${Utils.formatRating(item.rating)}</span>` : ''}
                                                    ${item.release_date ? `<span>${Utils.formatDate(item.release_date)}</span>` : ''}
                                                    <span class="badge badge-ghost">${item.content_type?.toUpperCase() || 'MOVIE'}</span>
                                                </div>
                                                <p class="text-gray-300 text-sm">${Utils.truncateText(item.overview, 150)}</p>
                                            </div>
                                            <div class="flex gap-2 ml-4">
                                                <button class="btn btn-primary btn-sm" onclick="Router.navigate('/details?id=${item.id}')">
                                                    View
                                                </button>
                                                <button class="btn btn-error btn-sm" onclick="removeFromFavorites(${item.id})" title="Remove">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function setView(view) {
            currentView = view;
            
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (view === 'grid') {
                gridBtn.classList.add('bg-primary', 'text-white');
                gridBtn.classList.remove('bg-gray-800', 'text-gray-400');
                listBtn.classList.add('bg-gray-800', 'text-gray-400');
                listBtn.classList.remove('bg-primary', 'text-white');
            } else {
                listBtn.classList.add('bg-primary', 'text-white');
                listBtn.classList.remove('bg-gray-800', 'text-gray-400');
                gridBtn.classList.add('bg-gray-800', 'text-gray-400');
                gridBtn.classList.remove('bg-primary', 'text-white');
            }
            
            renderFavorites();
        }

        function updateStatistics() {
            // Genre statistics
            const genreCount = {};
            const ratingCount = { high: 0, medium: 0, low: 0 };

            favoritesItems.forEach(item => {
                // Count genres
                if (item.genres) {
                    item.genres.forEach(genre => {
                        genreCount[genre] = (genreCount[genre] || 0) + 1;
                    });
                }

                // Count ratings
                const rating = item.rating || 0;
                if (rating >= 8) ratingCount.high++;
                else if (rating >= 6) ratingCount.medium++;
                else ratingCount.low++;
            });

            // Render genre stats
            const genreStatsContainer = document.getElementById('genreStats');
            const sortedGenres = Object.entries(genreCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            if (sortedGenres.length === 0) {
                genreStatsContainer.innerHTML = '<p class="text-gray-400 text-sm">No genre data available</p>';
            } else {
                genreStatsContainer.innerHTML = sortedGenres.map(([genre, count]) => {
                    const percentage = Math.round((count / favoritesItems.length) * 100);
                    return `
                        <div class="flex items-center justify-between">
                            <span class="text-sm">${genre}</span>
                            <div class="flex items-center gap-2">
                                <div class="w-20 bg-gray-800 rounded-full h-2">
                                    <div class="bg-primary h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-xs text-gray-400 w-8">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render rating stats
            const ratingStatsContainer = document.getElementById('ratingStats');
            const total = favoritesItems.length;
            
            if (total === 0) {
                ratingStatsContainer.innerHTML = '<p class="text-gray-400 text-sm">No rating data available</p>';
            } else {
                ratingStatsContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm">High Rated (8.0+)</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 bg-gray-800 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${Math.round((ratingCount.high / total) * 100)}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 w-8">${ratingCount.high}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Medium Rated (6.0-7.9)</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 bg-gray-800 rounded-full h-2">
                                <div class="bg-yellow-500 h-2 rounded-full" style="width: ${Math.round((ratingCount.medium / total) * 100)}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 w-8">${ratingCount.medium}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Lower Rated (< 6.0)</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 bg-gray-800 rounded-full h-2">
                                <div class="bg-red-500 h-2 rounded-full" style="width: ${Math.round((ratingCount.low / total) * 100)}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 w-8">${ratingCount.low}</span>
                        </div>
                    </div>
                `;
            }
        }

        async function removeFromFavorites(contentId) {
            try {
                favoritesItems = favoritesItems.filter(item => item.id !== contentId);
                document.getElementById('favoritesCount').textContent = favoritesItems.length;
                
                UI.showToast('Removed from favorites', 'success');
                updateStatistics();
                applyFiltersAndSort();

            } catch (error) {
                console.error('Error removing from favorites:', error);
                UI.showToast('Failed to remove from favorites', 'error');
            }
        }

        function clearFilters() {
            document.getElementById('typeFilter').value = '';
            document.getElementById('genreFilter').value = '';
            document.getElementById('sortBy').value = 'added';
            applyFiltersAndSort();
        }

        async function loadRecommendations() {
            if (favoritesItems.length === 0) return;

            try {
                const container = document.getElementById('recommendationsContent');
                UI.showSkeleton(container, 6);

                // Get recommendations based on favorites
                const response = await api.getTrending('all', 12);
                const recommendations = response.recommendations || [];

                contentManager.renderMovieGrid(container, { recommendations });

            } catch (error) {
                console.error('Error loading recommendations:', error);
                document.getElementById('recommendationsContent').innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-8">
                        Failed to load recommendations
                    </div>
                `;
            }
        }

        function shareMyFavorites() {
            if (favoritesItems.length === 0) {
                UI.showToast('No favorites to share', 'warning');
                return;
            }

            const shareText = `Check out my favorite movies and shows on CineScope! I've got ${favoritesItems.length} amazing picks.`;
            const shareUrl = window.location.origin + '/user/favorites';

            if (navigator.share) {
                navigator.share({
                    title: 'My CineScope Favorites',
                    text: shareText,
                    url: shareUrl
                });
            } else {
                Utils.copyToClipboard(shareUrl).then(() => {
                    UI.showToast('Favorites link copied to clipboard!', 'success');
                });
            }
        }

        function createFavoritesList() {
            if (favoritesItems.length === 0) {
                UI.showToast('Add some favorites first!', 'warning');
                return;
            }

            UI.showModal(`
                <div>
                    <h3 class="text-xl font-semibold mb-4">Create Custom List</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="form-label">List Name</label>
                            <input type="text" id="listName" class="form-input" placeholder="My Awesome Movies">
                        </div>
                        <div>
                            <label class="form-label">Description (Optional)</label>
                            <textarea id="listDescription" class="form-input h-20" placeholder="A collection of my all-time favorite movies..."></textarea>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="publicList" class="rounded">
                            <label for="publicList" class="text-sm">Make this list public</label>
                        </div>
                        <div class="flex justify-end gap-4">
                            <button class="btn btn-secondary" onclick="UI.hideModal(this.closest('.modal-overlay'))">Cancel</button>
                            <button class="btn btn-primary" onclick="saveCustomList()">Create List</button>
                        </div>
                    </div>
                </div>
            `, 'Create Custom List');
        }

        function saveCustomList() {
            const name = document.getElementById('listName').value.trim();
            const description = document.getElementById('listDescription').value.trim();
            const isPublic = document.getElementById('publicList').checked;

            if (!name) {
                UI.showToast('Please enter a list name', 'error');
                return;
            }

            // Simulate saving the list
            UI.showToast('Custom list created successfully!', 'success');
            UI.hideModal(document.querySelector('.modal-overlay'));
        }

        function showErrorState() {
            const container = document.getElementById('favoritesContent');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">❌</div>
                    <h3 class="empty-state-title">Failed to load favorites</h3>
                    <p class="empty-state-description">Please try again later.</p>
                    <button class="btn btn-primary mt-4" onclick="loadFavorites()">Retry</button>
                </div>
            `;
        }
    </script>
</body>
</html>