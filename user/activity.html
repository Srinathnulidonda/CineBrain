<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="My Activity - CineBrain">
  <title>My Activity - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="container py-8">
        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-2">My Activity</h1>
          <p class="text-muted">Your watch history and interactions</p>
        </div>

        <!-- Activity Filters -->
        <div class="bg-elevated rounded-xl p-6 mb-8">
          <div class="flex flex-wrap gap-3 items-center justify-between">
            <div class="flex gap-2">
              <button class="filter-chip active" data-filter="all" onclick="setActivityFilter('all')">All Activity</button>
              <button class="filter-chip" data-filter="watched" onclick="setActivityFilter('watched')">Watched</button>
              <button class="filter-chip" data-filter="liked" onclick="setActivityFilter('liked')">Liked</button>
              <button class="filter-chip" data-filter="rated" onclick="setActivityFilter('rated')">Rated</button>
            </div>
            <button class="btn btn-outline btn-sm" onclick="clearActivity()">Clear History</button>
          </div>
        </div>

        <!-- Activity Timeline -->
        <div id="activity-timeline">
          <div class="text-center py-12">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-muted">Loading your activity...</p>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-activity" style="display: none;">
          <h3>üìä No Activity Yet</h3>
          <p>Start watching and rating content to build your activity history</p>
          <button class="btn btn-primary mt-4" onclick="exploreContent()">Explore Content</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let activityData = [];
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeActivityPage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeActivityPage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    function initializeActivityPage() {
      if (!Auth.requireAuth()) {
        return;
      }
      
      loadActivityHistory();
      console.log('üìä Activity page initialized');
    }

    async function loadActivityHistory() {
      try {
        // Since backend doesn't have an activity endpoint, we'll simulate with local data
        activityData = await getSimulatedActivity();
        displayActivity();
        
      } catch (error) {
        console.error('Activity loading error:', error);
        showEmptyState();
      }
    }

    async function getSimulatedActivity() {
      // In a real implementation, this would fetch from backend
      // For now, we'll generate some sample activity
      const activities = [];
      
      // Get some recent content from API
      try {
        const trending = await ContentAPI.getTrending('all', 10);
        const content = trending.recommendations || trending;
        
        content.forEach((item, index) => {
          const daysAgo = Math.floor(Math.random() * 7);
          const activityDate = new Date();
          activityDate.setDate(activityDate.getDate() - daysAgo);
          
          activities.push({
            id: index + 1,
            content: item,
            type: ['watched', 'liked', 'rated'][Math.floor(Math.random() * 3)],
            timestamp: activityDate.toISOString(),
            rating: Math.floor(Math.random() * 5) + 1
          });
        });
        
      } catch (error) {
        console.error('Failed to get content for activity:', error);
      }
      
      return activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }

    function displayActivity() {
      const timeline = document.getElementById('activity-timeline');
      const emptyState = document.getElementById('empty-activity');
      
      // Filter activities
      let filteredActivities = activityData;
      if (currentFilter !== 'all') {
        filteredActivities = activityData.filter(activity => activity.type === currentFilter);
      }
      
      if (filteredActivities.length === 0) {
        timeline.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      // Group activities by date
      const groupedActivities = groupByDate(filteredActivities);
      
      timeline.innerHTML = Object.entries(groupedActivities).map(([date, activities]) => `
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-muted">${formatDateHeader(date)}</h3>
          <div class="space-y-4">
            ${activities.map(activity => createActivityItem(activity)).join('')}
          </div>
        </div>
      `).join('');
    }

    function groupByDate(activities) {
      const grouped = {};
      
      activities.forEach(activity => {
        const date = new Date(activity.timestamp).toDateString();
        if (!grouped[date]) {
          grouped[date] = [];
        }
        grouped[date].push(activity);
      });
      
      return grouped;
    }

    function formatDateHeader(dateString) {
      const date = new Date(dateString);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      } else {
        return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      }
    }

    function createActivityItem(activity) {
      const content = activity.content;
      const time = new Date(activity.timestamp).toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit' 
      });
      
      let actionText = '';
      let actionIcon = '';
      
      switch (activity.type) {
        case 'watched':
          actionText = 'Watched';
          actionIcon = 'üëÅÔ∏è';
          break;
        case 'liked':
          actionText = 'Liked';
          actionIcon = '‚ù§Ô∏è';
          break;
        case 'rated':
          actionText = `Rated ${activity.rating}/5`;
          actionIcon = '‚≠ê';
          break;
      }
      
      const posterUrl = content.poster_path 
        ? (content.poster_path.startsWith('http') ? content.poster_path : `https://image.tmdb.org/t/p/w200${content.poster_path}`)
        : '/images/placeholder-poster.jpg';
      
      return `
        <div class="bg-elevated rounded-xl p-4 hover:bg-surface transition cursor-pointer" onclick="navigateToContent(${content.id})">
          <div class="flex gap-4">
            <img 
              src="${posterUrl}" 
              alt="${content.title}" 
              class="w-16 h-24 object-cover rounded-lg"
            >
            <div class="flex-1">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h4 class="font-semibold">${content.title}</h4>
                  <p class="text-sm text-muted">
                    ${content.content_type.toUpperCase()} ‚Ä¢ 
                    ${content.genres ? content.genres.slice(0, 2).join(', ') : 'N/A'}
                  </p>
                </div>
                <span class="text-xs text-muted">${time}</span>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <span>${actionIcon}</span>
                <span class="text-muted">${actionText}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function setActivityFilter(filter) {
      currentFilter = filter;
      
      // Update active filter
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      
      displayActivity();
    }

    async function clearActivity() {
      const confirmed = confirm('Are you sure you want to clear your entire activity history? This action cannot be undone.');
      
      if (confirmed) {
        try {
          // Clear local data
          activityData = [];
          displayActivity();
          
          showToast('Activity history cleared', 'success');
          
        } catch (error) {
          console.error('Clear activity error:', error);
          showToast('Failed to clear activity', 'error');
        }
      }
    }

    function navigateToContent(contentId) {
      window.location.href = `/content/details.html?id=${contentId}`;
    }

    function exploreContent() {
      window.location.href = '/content/search.html';
    }

    function showEmptyState() {
      document.getElementById('activity-timeline').innerHTML = '';
      document.getElementById('empty-activity').style.display = 'block';
    }
  </script>
</body>
</html>