<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity History - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header__breadcrumb">
                        <a href="/" class="text-muted">Home</a>
                        <span class="page-header__breadcrumb-separator">/</span>
                        <a href="#" onclick="navigateToProfile()" class="text-muted">Profile</a>
                        <span class="page-header__breadcrumb-separator">/</span>
                        <span>Activity</span>
                    </div>
                    <h1 class="page-header__title">
                        <i class="bi bi-clock-history"></i> Activity History
                    </h1>
                    <p class="page-header__description">
                        Your viewing history and interactions
                    </p>
                </div>

                <!-- Activity Filters -->
                <div class="filters mb-xl">
                    <div class="d-flex gap-sm">
                        <button class="filter-chip filter-chip--active" data-filter="all">
                            All Activity
                        </button>
                        <button class="filter-chip" data-filter="watched">
                            <i class="bi bi-eye"></i> Watched
                        </button>
                        <button class="filter-chip" data-filter="watchlist">
                            <i class="bi bi-bookmark"></i> Watchlist
                        </button>
                        <button class="filter-chip" data-filter="favorites">
                            <i class="bi bi-heart"></i> Favorites
                        </button>
                        <button class="filter-chip" data-filter="rated">
                            <i class="bi bi-star"></i> Rated
                        </button>
                    </div>
                </div>

                <!-- Activity Timeline -->
                <div class="activity-timeline" id="activityTimeline">
                    <!-- Loading skeleton -->
                    <div class="skeleton mb-md" style="height: 100px;"></div>
                    <div class="skeleton mb-md" style="height: 100px;"></div>
                    <div class="skeleton mb-md" style="height: 100px;"></div>
                </div>

                <!-- Load More -->
                <div class="text-center mt-xl" id="loadMoreContainer">
                    <button class="btn btn-secondary" onclick="loadMoreActivity()">
                        Load More
                    </button>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" onclick="navigateToWatchlist()" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="#" onclick="navigateToProfile()" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <style>
        .activity-timeline {
            position: relative;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 30px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--bg-tertiary);
        }

        .activity-item {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            position: relative;
        }

        .activity-item__icon {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-full);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .activity-item__content {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
        }

        .activity-item__header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }

        .activity-item__title {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .activity-item__meta {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .activity-item__time {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .activity-item__body {
            display: flex;
            gap: var(--spacing-md);
        }

        .activity-item__poster {
            width: 60px;
            height: 90px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            cursor: pointer;
        }

        .activity-item__poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .activity-item__details {
            flex: 1;
        }
    </style>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login if not authenticated
        }

        let currentFilter = 'all';
        let activityData = [];
        let displayedItems = 10;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            updateNavigation();
            setupFilters();
            loadActivity();
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const user = auth.getUser();

            navbarUser.innerHTML = `
                <a href="${auth.getUserUrl('watchlist')}" class="navbar__link">
                    <i class="bi bi-bookmark"></i>
                </a>
                <a href="${auth.getUserUrl('favorites')}" class="navbar__link">
                    <i class="bi bi-heart"></i>
                </a>
                <div class="navbar__avatar">
                    <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                </div>
            `;
        }

        function setupFilters() {
            document.querySelectorAll('[data-filter]').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('[data-filter]').forEach(c => c.classList.remove('filter-chip--active'));
                    chip.classList.add('filter-chip--active');
                    currentFilter = chip.dataset.filter;
                    displayedItems = 10;
                    renderActivity();
                });
            });
        }

        async function loadActivity() {
            // Generate mock activity data
            const recentlyViewed = Storage.getRecentlyViewed();
            const watchlist = Storage.getWatchlistCache();
            const favorites = Storage.getFavoritesCache();

            activityData = [
                ...recentlyViewed.map(item => ({
                    type: 'watched',
                    content: item,
                    timestamp: item.viewed_at || new Date().toISOString(),
                    icon: '👁️',
                    action: 'Watched'
                })),
                ...watchlist.slice(0, 5).map(item => ({
                    type: 'watchlist',
                    content: item,
                    timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                    icon: '🔖',
                    action: 'Added to watchlist'
                })),
                ...favorites.slice(0, 5).map(item => ({
                    type: 'favorites',
                    content: item,
                    timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                    icon: '❤️',
                    action: 'Added to favorites'
                }))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            renderActivity();
        }

        function renderActivity() {
            let filteredData = activityData;

            if (currentFilter !== 'all') {
                filteredData = activityData.filter(item => item.type === currentFilter);
            }

            const itemsToShow = filteredData.slice(0, displayedItems);
            const timeline = document.getElementById('activityTimeline');

            if (itemsToShow.length === 0) {
                timeline.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-clock empty-state__icon"></i>
                        <h2 class="empty-state__title">No activity yet</h2>
                        <p class="empty-state__description">
                            Start watching content to see your activity here
                        </p>
                    </div>
                `;
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }

            timeline.innerHTML = itemsToShow.map((item, index) => `
                <div class="activity-item animate-fadeInUp" style="animation-delay: ${index * 0.1}s">
                    <div class="activity-item__icon">
                        ${item.icon}
                    </div>
                    <div class="activity-item__content">
                        <div class="activity-item__header">
                            <div>
                                <p class="activity-item__title">${item.action}</p>
                                <p class="activity-item__meta">${item.content.title}</p>
                            </div>
                            <span class="activity-item__time">${formatRelativeTime(item.timestamp)}</span>
                        </div>
                        ${item.content.poster_path ? `
                            <div class="activity-item__body">
                                <div class="activity-item__poster" onclick="navigateToContentDetails(${item.content.id})">
                                    <img src="${item.content.poster_path}" alt="${item.content.title}">
                                </div>
                                <div class="activity-item__details">
                                    <p class="text-sm text-muted mb-sm">
                                        ${item.content.content_type ? item.content.content_type.toUpperCase() : 'CONTENT'}
                                        ${item.content.rating ? `• ⭐ ${item.content.rating}` : ''}
                                    </p>
                                    <button class="btn btn-sm btn-secondary" onclick="navigateToContentDetails(${item.content.id})">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Show/hide load more button
            document.getElementById('loadMoreContainer').style.display =
                filteredData.length > displayedItems ? 'block' : 'none';
        }

        function loadMoreActivity() {
            displayedItems += 10;
            renderActivity();
        }

        function formatRelativeTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;

            return date.toLocaleDateString();
        }
    </script>
</body>

</html>