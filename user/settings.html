<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="User Settings - CineScope">
    <title>Settings - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="topbar">
        <div class="topbar-left">
            <a href="/" class="logo">CineScope</a>
            <button class="back-btn" onclick="history.back()">‚Üê Back</button>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search..." id="headerSearch">
        </div>
        <div class="topbar-right" id="userSection"></div>
    </nav>

    <main class="settings-page">
        <div class="container">
            <div class="settings-header">
                <h1>Account Settings</h1>
                <p>Manage your account preferences and privacy settings</p>
            </div>

            <div class="settings-content">
                <div class="settings-nav">
                    <div class="nav-item active" data-section="profile">
                        <span class="nav-icon">üë§</span>
                        <span class="nav-label">Profile</span>
                    </div>
                    <div class="nav-item" data-section="preferences">
                        <span class="nav-icon">üé≠</span>
                        <span class="nav-label">Preferences</span>
                    </div>
                    <div class="nav-item" data-section="privacy">
                        <span class="nav-icon">üîí</span>
                        <span class="nav-label">Privacy</span>
                    </div>
                    <div class="nav-item" data-section="notifications">
                        <span class="nav-icon">üîî</span>
                        <span class="nav-label">Notifications</span>
                    </div>
                    <div class="nav-item" data-section="account">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-label">Account</span>
                    </div>
                </div>

                <div class="settings-main">
                    <div class="settings-section" id="settingsContent">
                        <!-- Content will be dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="/" class="mobile-nav-item">
            <span class="mobile-nav-icon">üè†</span>
            <span class="mobile-nav-label">Home</span>
        </a>
        <a href="/content/search.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">üîç</span>
            <span class="mobile-nav-label">Search</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="goToWatchlist()">
            <span class="mobile-nav-icon">üìö</span>
            <span class="mobile-nav-label">Watchlist</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="goToFavorites()">
            <span class="mobile-nav-icon">‚ù§Ô∏è</span>
            <span class="mobile-nav-label">Favorites</span>
        </a>
        <a href="#" class="mobile-nav-item active" onclick="goToProfile()">
            <span class="mobile-nav-icon">üë§</span>
            <span class="mobile-nav-label">Profile</span>
        </a>
    </nav>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let currentUser = null;
        let userPreferences = {
            languages: [],
            genres: [],
            notifications: {
                email: true,
                push: false,
                marketing: false
            },
            privacy: {
                profilePublic: false,
                activityVisible: true,
                recommendationsEnabled: true
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/auth/login.html';
                return;
            }

            // Verify URL username matches current user
            const pathUsername = window.location.pathname.split('/')[1];
            const currentUsername = window.auth.getUser()?.username;
            
            if (pathUsername !== currentUsername) {
                window.location.href = `/${currentUsername}/settings`;
                return;
            }

            currentUser = window.auth.getUser();
            loadUserPreferences();
            updateUserSection();
            setupHeaderSearch();
            setupSettingsNavigation();
            showSettingsSection('profile');
        });

        function loadUserPreferences() {
            // Load preferences from user data
            try {
                userPreferences.languages = JSON.parse(currentUser.preferred_languages || '[]');
                userPreferences.genres = JSON.parse(currentUser.preferred_genres || '[]');
            } catch (error) {
                console.warn('Failed to parse user preferences:', error);
            }

            // Load additional preferences from localStorage (simulated)
            const savedPrefs = localStorage.getItem(`cinescope_prefs_${currentUser.id}`);
            if (savedPrefs) {
                try {
                    const parsed = JSON.parse(savedPrefs);
                    userPreferences = { ...userPreferences, ...parsed };
                } catch (error) {
                    console.warn('Failed to parse saved preferences:', error);
                }
            }
        }

        function setupSettingsNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const section = e.currentTarget.dataset.section;
                    showSettingsSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });
        }

        function showSettingsSection(section) {
            const content = document.getElementById('settingsContent');
            
            switch (section) {
                case 'profile':
                    renderProfileSettings(content);
                    break;
                case 'preferences':
                    renderPreferencesSettings(content);
                    break;
                case 'privacy':
                    renderPrivacySettings(content);
                    break;
                case 'notifications':
                    renderNotificationSettings(content);
                    break;
                case 'account':
                    renderAccountSettings(content);
                    break;
                default:
                    renderProfileSettings(content);
            }
        }

        function renderProfileSettings(container) {
            container.innerHTML = `
                <div class="settings-form">
                    <h2>Profile Information</h2>
                    <p class="section-description">Update your basic profile information</p>

                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Profile Picture</label>
                            <div class="profile-picture-section">
                                <img src="${window.auth.getUserAvatarLarge()}" alt="Profile" class="profile-picture-preview">
                                <div class="profile-picture-info">
                                    <p>Your profile picture is automatically generated based on your username.</p>
                                    <small class="text-muted">Profile pictures help other users identify you</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   class="form-input" 
                                   value="${currentUser.username}"
                                   readonly
                                   disabled>
                            <small class="form-hint">Username cannot be changed</small>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   class="form-input" 
                                   value="${currentUser.email}"
                                   required>
                            <small class="form-hint">We'll send important updates to this email</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Account Type</label>
                            <div class="account-type-display">
                                <span class="account-badge ${currentUser.is_admin ? 'admin' : 'user'}">
                                    ${currentUser.is_admin ? 'üîß Admin' : 'üë§ User'}
                                </span>
                                <small class="text-muted">
                                    ${currentUser.is_admin ? 'You have administrative privileges' : 'Standard user account'}
                                </small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Member Since</label>
                            <div class="readonly-field">
                                ${new Date(currentUser.created_at || Date.now()).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                            <button type="button" class="btn btn-outline" onclick="resetProfileForm()">Reset</button>
                        </div>
                    </form>
                </div>
            `;

            setupProfileForm();
        }

        function renderPreferencesSettings(container) {
            container.innerHTML = `
                <div class="settings-form">
                    <h2>Content Preferences</h2>
                    <p class="section-description">Customize your content recommendations and viewing preferences</p>

                    <form id="preferencesForm">
                        <div class="form-group">
                            <label class="form-label">Preferred Languages</label>
                            <div class="checkbox-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="english" 
                                           ${userPreferences.languages.includes('english') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    English
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="hindi" 
                                           ${userPreferences.languages.includes('hindi') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Hindi
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="telugu" 
                                           ${userPreferences.languages.includes('telugu') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Telugu
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="tamil" 
                                           ${userPreferences.languages.includes('tamil') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Tamil
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="kannada" 
                                           ${userPreferences.languages.includes('kannada') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Kannada
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="malayalam" 
                                           ${userPreferences.languages.includes('malayalam') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Malayalam
                                </label>
                            </div>
                            <small class="form-hint">Select languages for personalized content recommendations</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Favorite Genres</label>
                            <div class="checkbox-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="action" 
                                           ${userPreferences.genres.includes('action') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Action
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="comedy" 
                                           ${userPreferences.genres.includes('comedy') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Comedy
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="drama" 
                                           ${userPreferences.genres.includes('drama') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Drama
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="thriller" 
                                           ${userPreferences.genres.includes('thriller') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Thriller
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="romance" 
                                           ${userPreferences.genres.includes('romance') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Romance
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="sci-fi" 
                                           ${userPreferences.genres.includes('sci-fi') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Sci-Fi
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="horror" 
                                           ${userPreferences.genres.includes('horror') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Horror
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="animation" 
                                           ${userPreferences.genres.includes('animation') ? 'checked' : ''}>
                                    <span class="checkbox-custom"></span>
                                    Animation
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Recommendation Settings</label>
                            <div class="toggle-group">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           ${userPreferences.privacy.recommendationsEnabled ? 'checked' : ''} 
                                           onchange="updateRecommendationsSetting(this.checked)">
                                    <span class="toggle-slider"></span>
                                    Enable AI-powered recommendations
                                </label>
                                <small class="form-hint">Use machine learning to suggest content based on your viewing history</small>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                            <button type="button" class="btn btn-outline" onclick="resetPreferences()">Reset to Default</button>
                        </div>
                    </form>
                </div>
            `;

            setupPreferencesForm();
        }

        function renderPrivacySettings(container) {
            container.innerHTML = `
                <div class="settings-form">
                    <h2>Privacy & Data</h2>
                    <p class="section-description">Control your privacy and data sharing preferences</p>

                    <div class="privacy-sections">
                        <div class="privacy-section">
                            <h3>Profile Visibility</h3>
                            <div class="privacy-controls">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           ${userPreferences.privacy.profilePublic ? 'checked' : ''} 
                                           onchange="updatePrivacySetting('profilePublic', this.checked)">
                                    <span class="toggle-slider"></span>
                                    Make profile public
                                </label>
                                <small class="form-hint">Allow other users to view your profile and activity</small>
                            </div>
                        </div>

                        <div class="privacy-section">
                            <h3>Activity Sharing</h3>
                            <div class="privacy-controls">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           ${userPreferences.privacy.activityVisible ? 'checked' : ''} 
                                           onchange="updatePrivacySetting('activityVisible', this.checked)">
                                    <span class="toggle-slider"></span>
                                    Show viewing activity
                                </label>
                                <small class="form-hint">Share what you're watching with other users</small>
                            </div>
                        </div>

                        <div class="privacy-section">
                            <h3>Data Usage</h3>
                            <div class="data-info">
                                <div class="data-item">
                                    <span class="data-label">Account Data</span>
                                    <span class="data-value">Basic profile information</span>
                                </div>
                                <div class="data-item">
                                    <span class="data-label">Viewing History</span>
                                    <span class="data-value">Content you've watched and rated</span>
                                </div>
                                <div class="data-item">
                                    <span class="data-label">Preferences</span>
                                    <span class="data-value">Language and genre preferences</span>
                                </div>
                            </div>
                        </div>

                        <div class="privacy-section">
                            <h3>Data Management</h3>
                            <div class="data-actions">
                                <button class="btn btn-outline" onclick="downloadData()">
                                    üì• Download My Data
                                </button>
                                <button class="btn btn-outline" onclick="clearWatchHistory()">
                                    üóëÔ∏è Clear Watch History
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNotificationSettings(container) {
            container.innerHTML = `
                <div class="settings-form">
                    <h2>Notification Preferences</h2>
                    <p class="section-description">Choose what notifications you'd like to receive</p>

                    <div class="notification-sections">
                        <div class="notification-section">
                            <h3>Email Notifications</h3>
                            <div class="notification-controls">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           ${userPreferences.notifications.email ? 'checked' : ''} 
                                           onchange="updateNotificationSetting('email', this.checked)">
                                    <span class="toggle-slider"></span>
                                    Enable email notifications
                                </label>
                                <small class="form-hint">Receive important updates and recommendations via email</small>
                            </div>
                        </div>

                        <div class="notification-section">
                            <h3>Push Notifications</h3>
                            <div class="notification-controls">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           ${userPreferences.notifications.push ? 'checked' : ''} 
                                           onchange="updateNotificationSetting('push', this.checked)">
                                    <span class="toggle-slider"></span>
                                    Enable push notifications
                                </label>
                                <small class="form-hint">Get instant updates on new releases and recommendations</small>
                            </div>
                        </div>

                        <div class="notification-section">
                            <h3>Marketing Communications</h3>
                            <div class="notification-controls">
                                <label class="toggle-label">
                                    <input type="checkbox" 
                                           ${userPreferences.notifications.marketing ? 'checked' : ''} 
                                           onchange="updateNotificationSetting('marketing', this.checked)">
                                    <span class="toggle-slider"></span>
                                    Receive promotional content
                                </label>
                                <small class="form-hint">Get updates about new features, special offers, and curated collections</small>
                            </div>
                        </div>

                        <div class="notification-section">
                            <h3>Notification Frequency</h3>
                            <select class="form-input" onchange="updateNotificationFrequency(this.value)">
                                <option value="instant">Instant</option>
                                <option value="daily" selected>Daily Digest</option>
                                <option value="weekly">Weekly Summary</option>
                                <option value="monthly">Monthly Update</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAccountSettings(container) {
            container.innerHTML = `
                <div class="settings-form">
                    <h2>Account Management</h2>
                    <p class="section-description">Manage your account security and preferences</p>

                    <div class="account-sections">
                        <div class="account-section">
                            <h3>Change Password</h3>
                            <form id="passwordForm" onsubmit="changePassword(event)">
                                <div class="form-group">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <input type="password" id="currentPassword" name="currentPassword" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" id="newPassword" name="newPassword" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Password</button>
                            </form>
                        </div>

                        <div class="account-section">
                            <h3>Account Information</h3>
                            <div class="account-info">
                                <div class="info-item">
                                    <span class="info-label">Username:</span>
                                    <span class="info-value">${currentUser.username}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email:</span>
                                    <span class="info-value">${currentUser.email}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Member Since:</span>
                                    <span class="info-value">${new Date(currentUser.created_at || Date.now()).toLocaleDateString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Account Type:</span>
                                    <span class="info-value">${currentUser.is_admin ? 'Administrator' : 'User'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="account-section">
                            <h3>Session Management</h3>
                            <div class="session-info">
                                <p>You are currently signed in on this device.</p>
                                <button class="btn btn-outline" onclick="logoutAllDevices()">
                                    Sign out of all devices
                                </button>
                            </div>
                        </div>

                        <div class="account-section danger-zone">
                            <h3>Danger Zone</h3>
                            <div class="danger-actions">
                                <button class="btn btn-danger" onclick="confirmDeleteAccount()">
                                    Delete Account
                                </button>
                                <small class="warning-text">
                                    ‚ö†Ô∏è This action cannot be undone. All your data will be permanently deleted.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Form handling functions
        function setupProfileForm() {
            const form = document.getElementById('profileForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const email = formData.get('email');

                if (email !== currentUser.email) {
                    // In a real app, this would call an API to update the email
                    showToast('Profile update functionality would be implemented with backend API', 'info');
                } else {
                    showToast('No changes to save', 'info');
                }
            });
        }

        function setupPreferencesForm() {
            const form = document.getElementById('preferencesForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const languages = Array.from(formData.getAll('languages'));
                const genres = Array.from(formData.getAll('genres'));

                userPreferences.languages = languages;
                userPreferences.genres = genres;

                // Save to localStorage (in real app, would save to backend)
                localStorage.setItem(`cinescope_prefs_${currentUser.id}`, JSON.stringify(userPreferences));
                
                showToast('Preferences saved successfully!', 'success');
            });
        }

        function resetProfileForm() {
            document.getElementById('email').value = currentUser.email;
            showToast('Form reset to original values', 'info');
        }

        function resetPreferences() {
            userPreferences.languages = ['english'];
            userPreferences.genres = [];
            
            // Update checkboxes
            document.querySelectorAll('input[name="languages"]').forEach(cb => {
                cb.checked = cb.value === 'english';
            });
            document.querySelectorAll('input[name="genres"]').forEach(cb => {
                cb.checked = false;
            });
            
            showToast('Preferences reset to default', 'info');
        }

        function updatePrivacySetting(setting, value) {
            userPreferences.privacy[setting] = value;
            localStorage.setItem(`cinescope_prefs_${currentUser.id}`, JSON.stringify(userPreferences));
            showToast('Privacy setting updated', 'success');
        }

        function updateNotificationSetting(setting, value) {
            userPreferences.notifications[setting] = value;
            localStorage.setItem(`cinescope_prefs_${currentUser.id}`, JSON.stringify(userPreferences));
            showToast('Notification setting updated', 'success');
        }

        function updateRecommendationsSetting(enabled) {
            userPreferences.privacy.recommendationsEnabled = enabled;
            localStorage.setItem(`cinescope_prefs_${currentUser.id}`, JSON.stringify(userPreferences));
            showToast(`Recommendations ${enabled ? 'enabled' : 'disabled'}`, 'success');
        }

        function updateNotificationFrequency(frequency) {
            userPreferences.notificationFrequency = frequency;
            localStorage.setItem(`cinescope_prefs_${currentUser.id}`, JSON.stringify(userPreferences));
            showToast(`Notification frequency set to ${frequency}`, 'success');
        }

        function changePassword(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');

            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            // In a real app, this would call the backend API
            showToast('Password change functionality would be implemented with backend API', 'info');
            event.target.reset();
        }

        function downloadData() {
            // Simulate data download
            const userData = {
                profile: currentUser,
                preferences: userPreferences,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinescope-data-${currentUser.username}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Your data has been downloaded', 'success');
        }

        function clearWatchHistory() {
            if (confirm('Are you sure you want to clear your watch history? This action cannot be undone.')) {
                // In a real app, this would call the backend API
                showToast('Watch history cleared (simulation)', 'success');
            }
        }

        function logoutAllDevices() {
            if (confirm('This will sign you out of all devices. You will need to sign in again. Continue?')) {
                window.auth.logout();
                showToast('Signed out of all devices', 'success');
            }
        }

        function confirmDeleteAccount() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-backdrop"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Delete Account</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="delete-warning">
                            <p><strong>‚ö†Ô∏è This action cannot be undone!</strong></p>
                            <p>Deleting your account will:</p>
                            <ul>
                                <li>Permanently delete your profile</li>
                                <li>Remove all your watchlists and favorites</li>
                                <li>Delete your viewing history</li>
                                <li>Cancel any active subscriptions</li>
                            </ul>
                            <p>Type <strong>DELETE</strong> to confirm:</p>
                            <input type="text" id="deleteConfirm" class="form-input" placeholder="Type DELETE">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function deleteAccount() {
            const confirmText = document.getElementById('deleteConfirm').value;
            
            if (confirmText !== 'DELETE') {
                showToast('Please type DELETE to confirm', 'error');
                return;
            }

            // In a real app, this would call the backend API
            showToast('Account deletion would be processed with backend API', 'info');
            document.querySelector('.modal').remove();
        }

        // Utility Functions
        function updateUserSection() {
            const userSection = document.getElementById('userSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <img src="${window.auth.getUserAvatar()}" 
                         alt="${user.username}" 
                         class="user-avatar"
                         onclick="toggleUserMenu()">
                    <div class="user-dropdown" id="userDropdown" style="display: none;">
                        <a href="/${user.username}/profile" class="dropdown-item">Profile</a>
                        <a href="/${user.username}/settings" class="dropdown-item active">Settings</a>
                        ${user.is_admin ? '<a href="/admin/" class="dropdown-item">Admin</a>' : ''}
                        <hr>
                        <a href="#" onclick="window.auth.logout()" class="dropdown-item">Logout</a>
                    </div>
                `;
            }
        }

        function setupHeaderSearch() {
            const searchInput = document.getElementById('headerSearch');
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        window.location.href = `/content/search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function goToWatchlist() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/watchlist`;
        }

        function goToFavorites() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/favorites`;
        }

        function goToProfile() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/profile`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.topbar-right')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>