<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Account Settings - CineBrain">
  <title>Settings - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="container py-8 max-w-4xl">
        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-2">Account Settings</h1>
          <p class="text-muted">Manage your account preferences and privacy</p>
        </div>

        <!-- Settings Sections -->
        <div class="space-y-8">
          
          <!-- Profile Information -->
          <section class="bg-elevated rounded-xl p-6">
            <h2 class="text-2xl font-semibold mb-6">Profile Information</h2>
            
            <form id="profile-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                  <label for="username" class="form-label">Username</label>
                  <input type="text" id="username" name="username" class="form-input" readonly>
                  <p class="text-xs text-muted mt-1">Username cannot be changed</p>
                </div>
                
                <div class="form-group">
                  <label for="email" class="form-label">Email Address</label>
                  <input type="email" id="email" name="email" class="form-input" readonly>
                  <p class="text-xs text-muted mt-1">Contact support to change email</p>
                </div>
              </div>
              
              <div class="form-group">
                <label for="display-name" class="form-label">Display Name</label>
                <input type="text" id="display-name" name="display-name" class="form-input" placeholder="Your display name">
              </div>
              
              <div class="form-group">
                <label for="bio" class="form-label">Bio</label>
                <textarea id="bio" name="bio" class="form-input h-24" placeholder="Tell us about yourself..."></textarea>
                <p class="text-xs text-muted mt-1">Maximum 200 characters</p>
              </div>
              
              <button type="submit" class="btn btn-primary">Update Profile</button>
            </form>
          </section>

          <!-- Content Preferences -->
          <section class="bg-elevated rounded-xl p-6">
            <h2 class="text-2xl font-semibold mb-6">Content Preferences</h2>
            
            <form id="preferences-form" class="space-y-6">
              <div class="form-group">
                <label class="form-label">Preferred Languages</label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-2">
                  <label class="flex items-center">
                    <input type="checkbox" name="languages" value="english" class="mr-2">
                    <span class="text-sm">🇺🇸 English</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="languages" value="hindi" class="mr-2">
                    <span class="text-sm">🇮🇳 Hindi</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="languages" value="telugu" class="mr-2">
                    <span class="text-sm">🇮🇳 Telugu</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="languages" value="tamil" class="mr-2">
                    <span class="text-sm">🇮🇳 Tamil</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="languages" value="kannada" class="mr-2">
                    <span class="text-sm">🇮🇳 Kannada</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="languages" value="malayalam" class="mr-2">
                    <span class="text-sm">🇮🇳 Malayalam</span>
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Favorite Genres</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Action" class="mr-2">
                    <span class="text-sm">Action</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Comedy" class="mr-2">
                    <span class="text-sm">Comedy</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Drama" class="mr-2">
                    <span class="text-sm">Drama</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Horror" class="mr-2">
                    <span class="text-sm">Horror</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Romance" class="mr-2">
                    <span class="text-sm">Romance</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Sci-Fi" class="mr-2">
                    <span class="text-sm">Sci-Fi</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Thriller" class="mr-2">
                    <span class="text-sm">Thriller</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" name="genres" value="Anime" class="mr-2">
                    <span class="text-sm">Anime</span>
                  </label>
                </div>
              </div>
              
              <button type="submit" class="btn btn-primary">Save Preferences</button>
            </form>
          </section>

          <!-- Privacy Settings -->
          <section class="bg-elevated rounded-xl p-6">
            <h2 class="text-2xl font-semibold mb-6">Privacy & Security</h2>
            
            <div class="space-y-6">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-medium">Profile Visibility</h3>
                  <p class="text-sm text-muted">Make your profile visible to other users</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="profile-public" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>
              
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-medium">Data Analytics</h3>
                  <p class="text-sm text-muted">Help improve recommendations by sharing viewing data</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="analytics-enabled" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>
              
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-medium">Email Notifications</h3>
                  <p class="text-sm text-muted">Receive email updates about new content and features</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="email-notifications" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>
            </div>
          </section>

          <!-- Appearance -->
          <section class="bg-elevated rounded-xl p-6">
            <h2 class="text-2xl font-semibold mb-6">Appearance</h2>
            
            <div class="space-y-6">
              <div class="form-group">
                <label class="form-label">Theme</label>
                <div class="flex gap-4 mt-2">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="theme" value="dark" class="mr-2" checked>
                    <div class="flex items-center">
                      <div class="w-6 h-6 bg-gray-800 rounded mr-2"></div>
                      <span>Dark Mode</span>
                    </div>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="theme" value="light" class="mr-2">
                    <div class="flex items-center">
                      <div class="w-6 h-6 bg-gray-100 rounded mr-2 border"></div>
                      <span>Light Mode</span>
                    </div>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="theme" value="auto" class="mr-2">
                    <div class="flex items-center">
                      <div class="w-6 h-6 bg-gradient-to-r from-gray-800 to-gray-100 rounded mr-2"></div>
                      <span>Auto</span>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label for="content-per-page" class="form-label">Content Per Page</label>
                <select id="content-per-page" class="form-input">
                  <option value="20">20 items</option>
                  <option value="40" selected>40 items</option>
                  <option value="60">60 items</option>
                </select>
              </div>
            </div>
          </section>

          <!-- Account Actions -->
          <section class="bg-elevated rounded-xl p-6">
            <h2 class="text-2xl font-semibold mb-6">Account Actions</h2>
            
            <div class="space-y-4">
              <button class="btn btn-outline w-full md:w-auto" onclick="changePassword()">
                Change Password
              </button>
              
              <button class="btn btn-outline w-full md:w-auto" onclick="downloadData()">
                Download My Data
              </button>
              
              <button class="btn btn-outline w-full md:w-auto" onclick="clearWatchHistory()">
                Clear Watch History
              </button>
              
              <div class="border-t border-red-500/20 pt-4 mt-6">
                <button class="btn w-full md:w-auto" style="background: #ef4444; color: white;" onclick="deleteAccount()">
                  Delete Account
                </button>
                <p class="text-xs text-muted mt-2">This action cannot be undone</p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeSettingsPage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeSettingsPage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    function initializeSettingsPage() {
      if (!Auth.requireAuth()) {
        return;
      }
      
      currentUser = Auth.getCurrentUser();
      loadUserSettings();
      setupEventListeners();
      
      console.log('⚙️ Settings page initialized');
    }

    function loadUserSettings() {
      // Load current user data
      document.getElementById('username').value = currentUser.username || '';
      document.getElementById('email').value = currentUser.email || '';
      
      // Load preferences if available
      if (currentUser.preferred_languages) {
        currentUser.preferred_languages.forEach(lang => {
          const checkbox = document.querySelector(`input[name="languages"][value="${lang}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }
      
      if (currentUser.preferred_genres) {
        currentUser.preferred_genres.forEach(genre => {
          const checkbox = document.querySelector(`input[name="genres"][value="${genre}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }
      
      // Load theme preference
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.querySelector(`input[name="theme"][value="${savedTheme}"]`).checked = true;
    }

    function setupEventListeners() {
      // Profile form
      document.getElementById('profile-form').addEventListener('submit', updateProfile);
      
      // Preferences form
      document.getElementById('preferences-form').addEventListener('submit', updatePreferences);
      
      // Theme change
      document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', changeTheme);
      });
      
      // Toggle switches
      setupToggleSwitches();
    }

    function setupToggleSwitches() {
      const toggles = [
        'profile-public',
        'analytics-enabled', 
        'email-notifications'
      ];
      
      toggles.forEach(toggleId => {
        document.getElementById(toggleId).addEventListener('change', savePrivacySettings);
      });
    }

    async function updateProfile(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const displayName = formData.get('display-name');
      const bio = formData.get('bio');
      
      try {
        // Simulate profile update (backend doesn't have this endpoint)
        await simulateProfileUpdate({ displayName, bio });
        
        showToast('Profile updated successfully', 'success');
        
      } catch (error) {
        console.error('Profile update error:', error);
        showToast('Failed to update profile', 'error');
      }
    }

    async function updatePreferences(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const languages = formData.getAll('languages');
      const genres = formData.getAll('genres');
      
      try {
        // Store preferences locally since backend doesn't have update endpoint
        const preferences = { languages, genres };
        localStorage.setItem('user_preferences', JSON.stringify(preferences));
        
        showToast('Preferences saved successfully', 'success');
        
      } catch (error) {
        console.error('Preferences update error:', error);
        showToast('Failed to save preferences', 'error');
      }
    }

    function changeTheme(event) {
      const theme = event.target.value;
      
      if (theme === 'auto') {
        // Use system preference
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        app.setTheme(systemTheme);
        localStorage.setItem('theme', 'auto');
      } else {
        app.setTheme(theme);
        localStorage.setItem('theme', theme);
      }
      
      showToast(`Theme changed to ${theme}`, 'success');
    }

    async function savePrivacySettings() {
      const settings = {
        profilePublic: document.getElementById('profile-public').checked,
        analyticsEnabled: document.getElementById('analytics-enabled').checked,
        emailNotifications: document.getElementById('email-notifications').checked
      };
      
      try {
        localStorage.setItem('privacy_settings', JSON.stringify(settings));
        showToast('Privacy settings saved', 'success');
      } catch (error) {
        console.error('Privacy settings error:', error);
        showToast('Failed to save privacy settings', 'error');
      }
    }

    // Account action handlers
    function changePassword() {
      showToast('Password change feature coming soon!', 'info');
    }

    function downloadData() {
      showToast('Data download feature coming soon!', 'info');
    }

    async function clearWatchHistory() {
      const confirmed = confirm('Are you sure you want to clear your entire watch history? This action cannot be undone.');
      
      if (confirmed) {
        try {
          // Clear local storage
          localStorage.removeItem('watch_history');
          showToast('Watch history cleared', 'success');
        } catch (error) {
          showToast('Failed to clear watch history', 'error');
        }
      }
    }

    async function deleteAccount() {
      const confirmed = confirm('Are you sure you want to delete your account? This action cannot be undone and will permanently delete all your data.');
      
      if (confirmed) {
        const doubleConfirm = confirm('This will permanently delete your account, watchlist, favorites, and all personal data. Type "DELETE" to confirm.');
        
        if (doubleConfirm) {
          showToast('Account deletion feature will be available soon. Please contact support.', 'warning');
        }
      }
    }

    // Utility functions
    async function simulateProfileUpdate(data) {
      return new Promise(resolve => {
        setTimeout(() => {
          resolve({ success: true });
        }, 1000);
      });
    }
  </script>
</body>
</html>