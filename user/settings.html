<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Settings - CineBrain</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body class="bg-gray-900 text-white">
    <!-- Fixed Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="pt-20 pb-20 md:pb-8">
        <div class="container-fluid px-3 px-md-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white fw-bold mb-2">⚙️ Settings</h1>
                    <p class="text-muted">Manage your account and preferences</p>
                </div>
            </div>

            <!-- Settings Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-pills nav-fill glass-effect mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="account-tab" data-bs-toggle="pill"
                                data-bs-target="#account" type="button" role="tab">Account</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preferences-tab" data-bs-toggle="pill"
                                data-bs-target="#preferences" type="button" role="tab">Preferences</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="privacy-tab" data-bs-toggle="pill" data-bs-target="#privacy"
                                type="button" role="tab">Privacy</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="subscription-tab" data-bs-toggle="pill"
                                data-bs-target="#subscription" type="button" role="tab">Subscription</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="settingsTabsContent">
                        <!-- Account Tab -->
                        <div class="tab-pane fade show active" id="account" role="tabpanel">
                            <div class="row">
                                <!-- Profile Information -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Profile Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center mb-4">
                                                <img id="settingsAvatar" src="" alt="Profile"
                                                    class="rounded-circle mb-3" width="100" height="100">
                                                <div>
                                                    <button class="btn btn-outline-light btn-sm"
                                                        onclick="settingsHandler.changeAvatar()">
                                                        <i class="fas fa-camera me-2"></i>Change Avatar
                                                    </button>
                                                </div>
                                            </div>

                                            <form id="profileForm">
                                                <div class="mb-3">
                                                    <label for="username" class="form-label text-white">Username</label>
                                                    <input type="text" class="form-control search-input" id="username"
                                                        readonly>
                                                    <div class="form-text text-muted">Username cannot be changed</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="email" class="form-label text-white">Email</label>
                                                    <input type="email" class="form-control search-input" id="email"
                                                        readonly>
                                                    <div class="form-text text-muted">Email cannot be changed</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="location" class="form-label text-white">Location</label>
                                                    <input type="text" class="form-control search-input" id="location"
                                                        placeholder="Enter your location">
                                                </div>
                                                <button type="submit" class="btn btn-primary-custom">
                                                    <i class="fas fa-save me-2"></i>Save Changes
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Security</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <h6 class="text-white">Password</h6>
                                                <p class="text-muted small">Change your account password</p>
                                                <button class="btn btn-outline-light"
                                                    onclick="settingsHandler.changePassword()">
                                                    <i class="fas fa-key me-2"></i>Change Password
                                                </button>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="text-white">Account Status</h6>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-success me-2">Active</span>
                                                    <small class="text-muted">Account is active and verified</small>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="text-white">Login Activity</h6>
                                                <p class="text-muted small">Last login: <span
                                                        id="lastLogin">Loading...</span></p>
                                                <button class="btn btn-outline-light btn-sm"
                                                    onclick="settingsHandler.viewLoginActivity()">
                                                    <i class="fas fa-history me-2"></i>View Activity
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences" role="tabpanel">
                            <div class="row">
                                <!-- Content Preferences -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Content Preferences</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="contentPreferencesForm">
                                                <div class="mb-4">
                                                    <label class="form-label text-white">Preferred Languages</label>
                                                    <div id="languagePreferences">
                                                        <!-- Will be populated dynamically -->
                                                    </div>
                                                </div>

                                                <div class="mb-4">
                                                    <label class="form-label text-white">Favorite Genres</label>
                                                    <div id="genrePreferences">
                                                        <!-- Will be populated dynamically -->
                                                    </div>
                                                </div>

                                                <button type="submit" class="btn btn-primary-custom">
                                                    <i class="fas fa-save me-2"></i>Save Preferences
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Display Settings -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Display Settings</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="displaySettingsForm">
                                                <div class="mb-3">
                                                    <label class="form-label text-white">Theme</label>
                                                    <select class="form-select search-input" id="themeSelect">
                                                        <option value="dark">Dark (Default)</option>
                                                        <option value="light">Light</option>
                                                        <option value="auto">Auto</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label text-white">Cards per Row</label>
                                                    <select class="form-select search-input" id="cardsPerRow">
                                                        <option value="auto">Auto</option>
                                                        <option value="4">4 Cards</option>
                                                        <option value="6">6 Cards</option>
                                                        <option value="8">8 Cards</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="autoplayTrailers">
                                                        <label class="form-check-label text-white"
                                                            for="autoplayTrailers">
                                                            Autoplay Trailers
                                                        </label>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox"
                                                            id="showAdultContent">
                                                        <label class="form-check-label text-white"
                                                            for="showAdultContent">
                                                            Show Adult Content
                                                        </label>
                                                    </div>
                                                </div>

                                                <button type="submit" class="btn btn-primary-custom">
                                                    <i class="fas fa-save me-2"></i>Save Settings
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Privacy Tab -->
                        <div class="tab-pane fade" id="privacy" role="tabpanel">
                            <div class="row">
                                <!-- Privacy Settings -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Privacy Controls</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="profileVisibility" checked>
                                                    <label class="form-check-label text-white" for="profileVisibility">
                                                        Public Profile
                                                    </label>
                                                    <div class="form-text text-muted">Allow others to see your profile
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="activityVisibility">
                                                    <label class="form-check-label text-white" for="activityVisibility">
                                                        Share Activity
                                                    </label>
                                                    <div class="form-text text-muted">Share your viewing activity</div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="dataCollection"
                                                        checked>
                                                    <label class="form-check-label text-white" for="dataCollection">
                                                        Improve Recommendations
                                                    </label>
                                                    <div class="form-text text-muted">Use viewing data to improve
                                                        recommendations</div>
                                                </div>
                                            </div>

                                            <button class="btn btn-primary-custom"
                                                onclick="settingsHandler.savePrivacySettings()">
                                                <i class="fas fa-save me-2"></i>Save Privacy Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Management -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Data Management</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <h6 class="text-white">Export Data</h6>
                                                <p class="text-muted small">Download your account data</p>
                                                <button class="btn btn-outline-light"
                                                    onclick="settingsHandler.exportData()">
                                                    <i class="fas fa-download me-2"></i>Export Data
                                                </button>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="text-white">Clear History</h6>
                                                <p class="text-muted small">Clear your viewing history</p>
                                                <button class="btn btn-outline-warning"
                                                    onclick="settingsHandler.clearHistory()">
                                                    <i class="fas fa-trash me-2"></i>Clear History
                                                </button>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="text-white">Delete Account</h6>
                                                <p class="text-muted small">Permanently delete your account</p>
                                                <button class="btn btn-outline-danger"
                                                    onclick="settingsHandler.deleteAccount()">
                                                    <i class="fas fa-user-times me-2"></i>Delete Account
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Subscription Tab -->
                        <div class="tab-pane fade" id="subscription" role="tabpanel">
                            <div class="row">
                                <!-- Current Plan -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Current Plan</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center mb-4">
                                                <div class="badge bg-primary fs-6 mb-2">FREE PLAN</div>
                                                <h4 class="text-white">$0.00 / month</h4>
                                                <p class="text-muted">Free access to CineBrain features</p>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="text-white">Plan Features</h6>
                                                <ul class="text-muted">
                                                    <li>Unlimited content discovery</li>
                                                    <li>Personal watchlist and favorites</li>
                                                    <li>Basic recommendations</li>
                                                    <li>Ad-supported experience</li>
                                                </ul>
                                            </div>

                                            <button class="btn btn-primary-custom w-100"
                                                onclick="settingsHandler.upgradePlan()">
                                                <i class="fas fa-crown me-2"></i>Upgrade to Premium
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Available Plans -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Premium Plan</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center mb-4">
                                                <div class="badge bg-warning fs-6 mb-2">PREMIUM</div>
                                                <h4 class="text-white">$9.99 / month</h4>
                                                <p class="text-muted">Enhanced experience with premium features</p>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="text-white">Premium Features</h6>
                                                <ul class="text-muted">
                                                    <li>Ad-free experience</li>
                                                    <li>Advanced ML recommendations</li>
                                                    <li>Early access to new features</li>
                                                    <li>Priority customer support</li>
                                                    <li>Offline downloads (coming soon)</li>
                                                </ul>
                                            </div>

                                            <button class="btn btn-warning w-100"
                                                onclick="settingsHandler.subscribePremium()">
                                                <i class="fas fa-star me-2"></i>Subscribe Now
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        class SettingsHandler {
            constructor() {
                this.userData = null;
                this.init();
            }

            init() {
                this.checkAuthentication();
                this.loadUserData();
                this.setupEventListeners();
            }

            checkAuthentication() {
                const token = Utils.getStorage('auth_token');
                if (!token) {
                    window.location.href = '../auth/login.html';
                    return;
                }
            }

            setupEventListeners() {
                // Profile form
                document.getElementById('profileForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveProfile();
                });

                // Content preferences form
                document.getElementById('contentPreferencesForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveContentPreferences();
                });

                // Display settings form
                document.getElementById('displaySettingsForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveDisplaySettings();
                });
            }

            loadUserData() {
                this.userData = Utils.getStorage('user_data');

                if (!this.userData) {
                    Utils.showToast('Failed to load user data', 'error');
                    return;
                }

                this.populateAccountInfo();
                this.populatePreferences();
                this.loadDisplaySettings();
            }

            populateAccountInfo() {
                const userData = this.userData;

                // Avatar
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.username)}&background=E50914&color=fff&size=100&bold=true`;
                document.getElementById('settingsAvatar').src = avatarUrl;

                // Profile form
                document.getElementById('username').value = userData.username;
                document.getElementById('email').value = userData.email;
                document.getElementById('location').value = userData.location || '';

                // Last login (simulated)
                document.getElementById('lastLogin').textContent = new Date().toLocaleDateString();
            }

            populatePreferences() {
                const userData = this.userData;

                // Language preferences
                const languages = ['english', 'hindi', 'telugu', 'tamil', 'kannada', 'malayalam'];
                const userLanguages = userData.preferred_languages || [];

                const languageHtml = languages.map(lang => `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${lang}" 
                               id="lang_${lang}" ${userLanguages.includes(lang) ? 'checked' : ''}>
                        <label class="form-check-label text-white" for="lang_${lang}">
                            ${lang.charAt(0).toUpperCase() + lang.slice(1)}
                        </label>
                    </div>
                `).join('');

                document.getElementById('languagePreferences').innerHTML = languageHtml;

                // Genre preferences
                const genres = ['Action', 'Comedy', 'Drama', 'Romance', 'Thriller', 'Horror', 'Sci-Fi', 'Fantasy', 'Animation', 'Documentary'];
                const userGenres = userData.preferred_genres || [];

                const genreHtml = genres.map(genre => `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${genre}" 
                               id="genre_${genre}" ${userGenres.includes(genre) ? 'checked' : ''}>
                        <label class="form-check-label text-white" for="genre_${genre}">
                            ${genre}
                        </label>
                    </div>
                `).join('');

                document.getElementById('genrePreferences').innerHTML = genreHtml;
            }

            loadDisplaySettings() {
                // Load saved display settings from localStorage
                const settings = Utils.getStorage('display_settings') || {};

                document.getElementById('themeSelect').value = settings.theme || 'dark';
                document.getElementById('cardsPerRow').value = settings.cardsPerRow || 'auto';
                document.getElementById('autoplayTrailers').checked = settings.autoplayTrailers !== false;
                document.getElementById('showAdultContent').checked = settings.showAdultContent === true;
            }

            saveProfile() {
                try {
                    const location = document.getElementById('location').value;

                    // Update user data
                    this.userData.location = location;
                    Utils.setStorage('user_data', this.userData);

                    Utils.showToast('Profile updated successfully', 'success');

                } catch (error) {
                    console.error('Failed to save profile:', error);
                    Utils.showToast('Failed to save profile', 'error');
                }
            }

            saveContentPreferences() {
                try {
                    const selectedLanguages = Array.from(
                        document.querySelectorAll('#languagePreferences input:checked')
                    ).map(input => input.value);

                    const selectedGenres = Array.from(
                        document.querySelectorAll('#genrePreferences input:checked')
                    ).map(input => input.value);

                    // Update user data
                    this.userData.preferred_languages = selectedLanguages;
                    this.userData.preferred_genres = selectedGenres;
                    Utils.setStorage('user_data', this.userData);

                    Utils.showToast('Content preferences saved successfully', 'success');

                } catch (error) {
                    console.error('Failed to save preferences:', error);
                    Utils.showToast('Failed to save preferences', 'error');
                }
            }

            saveDisplaySettings() {
                try {
                    const settings = {
                        theme: document.getElementById('themeSelect').value,
                        cardsPerRow: document.getElementById('cardsPerRow').value,
                        autoplayTrailers: document.getElementById('autoplayTrailers').checked,
                        showAdultContent: document.getElementById('showAdultContent').checked
                    };

                    Utils.setStorage('display_settings', settings);
                    Utils.showToast('Display settings saved successfully', 'success');

                    // Apply theme change
                    this.applyTheme(settings.theme);

                } catch (error) {
                    console.error('Failed to save display settings:', error);
                    Utils.showToast('Failed to save display settings', 'error');
                }
            }

            applyTheme(theme) {
                // Theme application logic would go here
                console.log('Applying theme:', theme);
            }

            savePrivacySettings() {
                try {
                    const privacySettings = {
                        profileVisibility: document.getElementById('profileVisibility').checked,
                        activityVisibility: document.getElementById('activityVisibility').checked,
                        dataCollection: document.getElementById('dataCollection').checked
                    };

                    Utils.setStorage('privacy_settings', privacySettings);
                    Utils.showToast('Privacy settings saved successfully', 'success');

                } catch (error) {
                    console.error('Failed to save privacy settings:', error);
                    Utils.showToast('Failed to save privacy settings', 'error');
                }
            }

            changeAvatar() {
                Utils.showToast('Avatar is automatically generated from your username', 'info');
            }

            changePassword() {
                Utils.showToast('Password change feature will be available in future updates', 'info');
            }

            viewLoginActivity() {
                Utils.showToast('Login activity tracking will be available in future updates', 'info');
            }

            exportData() {
                try {
                    const userData = {
                        profile: this.userData,
                        settings: {
                            display: Utils.getStorage('display_settings'),
                            privacy: Utils.getStorage('privacy_settings')
                        },
                        timestamp: new Date().toISOString()
                    };

                    const dataStr = JSON.stringify(userData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });

                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `cinebrain-data-${Date.now()}.json`;
                    link.click();

                    Utils.showToast('Data exported successfully', 'success');

                } catch (error) {
                    console.error('Failed to export data:', error);
                    Utils.showToast('Failed to export data', 'error');
                }
            }

            clearHistory() {
                if (confirm('Are you sure you want to clear your viewing history? This action cannot be undone.')) {
                    try {
                        // Clear any cached activity data
                        localStorage.removeItem('cached_activity');
                        Utils.showToast('History cleared successfully', 'success');
                    } catch (error) {
                        Utils.showToast('Failed to clear history', 'error');
                    }
                }
            }

            deleteAccount() {
                const confirmed = confirm('Are you sure you want to delete your account? This action cannot be undone and you will lose all your data.');

                if (confirmed) {
                    const doubleConfirm = prompt('Type "DELETE" to confirm account deletion:');

                    if (doubleConfirm === 'DELETE') {
                        try {
                            // Clear all user data
                            Utils.setStorage('auth_token', null);
                            Utils.setStorage('user_data', null);
                            Utils.setStorage('display_settings', null);
                            Utils.setStorage('privacy_settings', null);

                            Utils.showToast('Account deletion initiated. You will be logged out.', 'success');

                            setTimeout(() => {
                                window.location.href = '../auth/login.html';
                            }, 2000);

                        } catch (error) {
                            Utils.showToast('Failed to delete account', 'error');
                        }
                    } else {
                        Utils.showToast('Account deletion cancelled', 'info');
                    }
                }
            }

            upgradePlan() {
                Utils.showToast('Premium upgrade feature coming soon!', 'info');
            }

            subscribePremium() {
                Utils.showToast('Premium subscription feature coming soon!', 'info');
            }
        }

        // Initialize settings handler
        document.addEventListener('DOMContentLoaded', () => {
            window.settingsHandler = new SettingsHandler();
        });
    </script>
</body>

</html>