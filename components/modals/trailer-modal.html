<!-- Trailer Video Modal -->
<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-light" id="trailerModalLabel">Watch Trailer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Video Container -->
                <div class="ratio ratio-16x9 bg-dark">
                    <iframe id="trailerIframe" src="" title="Trailer Video" allowfullscreen style="border: none;">
                    </iframe>
                </div>

                <!-- Video Controls/Info -->
                <div class="p-3 bg-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-light mb-1" id="trailerTitle">Loading...</h6>
                            <small class="text-muted" id="trailerDescription">Official Trailer</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm share-trailer-btn">
                                <i class="fas fa-share"></i> Share
                            </button>
                            <button class="btn btn-outline-light btn-sm fullscreen-btn">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    class TrailerModal {
        constructor() {
            this.modal = document.getElementById('trailerModal');
            this.iframe = document.getElementById('trailerIframe');
            this.titleElement = document.getElementById('trailerTitle');
            this.descriptionElement = document.getElementById('trailerDescription');

            this.init();
        }

        init() {
            this.attachEventListeners();
        }

        attachEventListeners() {
            // Clean up when modal is hidden
            this.modal.addEventListener('hidden.bs.modal', () => {
                this.cleanup();
            });

            // Share button
            this.modal.querySelector('.share-trailer-btn').addEventListener('click', () => {
                this.shareTrailer();
            });

            // Fullscreen button
            this.modal.querySelector('.fullscreen-btn').addEventListener('click', () => {
                this.requestFullscreen();
            });

            // Global trailer modal trigger
            document.addEventListener('showTrailer', (event) => {
                this.showTrailer(event.detail);
            });
        }

        showTrailer(trailerData) {
            const { url, title, description } = trailerData;

            // Set iframe source
            this.iframe.src = this.getEmbedUrl(url);

            // Set title and description
            this.titleElement.textContent = title || 'Trailer';
            this.descriptionElement.textContent = description || 'Official Trailer';

            // Show modal
            const bsModal = new bootstrap.Modal(this.modal);
            bsModal.show();
        }

        getEmbedUrl(url) {
            if (!url) return '';

            // YouTube URL conversion
            if (url.includes('youtube.com/watch')) {
                const videoId = url.split('v=')[1]?.split('&')[0];
                return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
            }

            if (url.includes('youtu.be/')) {
                const videoId = url.split('youtu.be/')[1]?.split('?')[0];
                return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
            }

            // Vimeo URL conversion
            if (url.includes('vimeo.com/')) {
                const videoId = url.split('vimeo.com/')[1];
                return `https://player.vimeo.com/video/${videoId}?autoplay=1`;
            }

            // Return as is for direct embed URLs
            return url;
        }

        cleanup() {
            // Stop video by clearing iframe src
            this.iframe.src = '';

            // Reset content
            this.titleElement.textContent = 'Loading...';
            this.descriptionElement.textContent = 'Official Trailer';
        }

        shareTrailer() {
            const trailerUrl = this.iframe.src;
            const title = this.titleElement.textContent;

            if (navigator.share) {
                // Use native sharing if available
                navigator.share({
                    title: `${title} - Trailer`,
                    text: `Watch the trailer for ${title}`,
                    url: trailerUrl
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback to clipboard
                this.copyToClipboard(trailerUrl);
            }
        }

        copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('Trailer link copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                this.showToast('Trailer link copied to clipboard!');
            }
        }

        requestFullscreen() {
            const modalDialog = this.modal.querySelector('.modal-dialog');

            if (modalDialog.requestFullscreen) {
                modalDialog.requestFullscreen();
            } else if (modalDialog.webkitRequestFullscreen) {
                modalDialog.webkitRequestFullscreen();
            } else if (modalDialog.msRequestFullscreen) {
                modalDialog.msRequestFullscreen();
            }
        }

        showToast(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification position-fixed top-0 start-50 translate-middle-x mt-3 px-4 py-2 bg-success text-white rounded-3 shadow-lg';
            toast.style.zIndex = '9999';
            toast.textContent = message;

            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
                toast.style.opacity = '1';
            }, 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    }

    // Initialize trailer modal
    document.addEventListener('DOMContentLoaded', () => {
        new TrailerModal();
    });

    // Global function to show trailer
    window.showTrailer = function (url, title, description) {
        const event = new CustomEvent('showTrailer', {
            detail: { url, title, description }
        });
        document.dispatchEvent(event);
    };
</script>

<style>
    .toast-notification {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
        transition: all 0.3s ease;
    }

    @media (max-width: 768px) {
        #trailerModal .modal-dialog {
            margin: 0;
            max-width: 100%;
            height: 100vh;
        }

        #trailerModal .modal-content {
            height: 100%;
            border-radius: 0;
        }

        #trailerModal .ratio {
            height: calc(100vh - 140px);
        }
    }
</style>