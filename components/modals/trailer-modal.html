<!-- Trailer Modal Component -->
<div class="modal fade trailer-modal" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-theater border-royal">

            <!-- Modal Header -->
            <div class="modal-header border-royal">
                <div class="d-flex align-items-center">
                    <i class="bi bi-play-circle me-2 text-primary fs-4"></i>
                    <h5 class="modal-title text-white" id="trailerModalLabel">Trailer</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body p-0 position-relative">

                <!-- Video Container -->
                <div class="video-container position-relative">
                    <!-- YouTube Iframe -->
                    <iframe class="trailer-iframe w-100" height="450" src="" title="YouTube video player"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen>
                    </iframe>

                    <!-- Loading Overlay -->
                    <div
                        class="loading-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-black bg-opacity-75">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading trailer...</span>
                            </div>
                            <p class="text-white">Loading trailer...</p>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div
                        class="error-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-black bg-opacity-75 d-none">
                        <div class="text-center">
                            <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                            <h5 class="text-white mb-2">Trailer Unavailable</h5>
                            <p class="text-gray-400">Sorry, the trailer for this content is not available.</p>
                            <button class="btn btn-primary retry-trailer">Try Again</button>
                        </div>
                    </div>
                </div>

                <!-- Trailer Information -->
                <div class="trailer-info p-3 bg-velvet border-top border-royal">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="text-white mb-1 trailer-title">Content Title</h6>
                            <p class="text-gray-400 mb-0 trailer-description">Official Trailer</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-sm btn-outline-primary add-to-watchlist" data-content-id=""
                                    title="Add to Watchlist">
                                    <i class="bi bi-bookmark"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger add-to-favorites" data-content-id=""
                                    title="Add to Favorites">
                                    <i class="bi bi-heart"></i>
                                </button>
                                <a href="#" class="btn btn-sm btn-primary view-details" data-content-id="">
                                    <i class="bi bi-info-circle me-1"></i>Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    class TrailerModal {
        constructor() {
            this.modal = document.getElementById('trailerModal');
            this.iframe = this.modal.querySelector('.trailer-iframe');
            this.loadingOverlay = this.modal.querySelector('.loading-overlay');
            this.errorOverlay = this.modal.querySelector('.error-overlay');
            this.modalTitle = this.modal.querySelector('#trailerModalLabel');
            this.trailerTitle = this.modal.querySelector('.trailer-title');
            this.trailerDescription = this.modal.querySelector('.trailer-description');

            this.currentVideoId = null;
            this.currentContentId = null;
            this.currentTitle = null;

            this.initialize();
        }

        initialize() {
            this.setupEventListeners();
            this.setupBootstrapModal();
        }

        setupEventListeners() {
            // Modal events
            this.modal.addEventListener('show.bs.modal', () => {
                this.onModalShow();
            });

            this.modal.addEventListener('hide.bs.modal', () => {
                this.onModalHide();
            });

            this.modal.addEventListener('hidden.bs.modal', () => {
                this.onModalHidden();
            });

            // Iframe load events
            this.iframe.addEventListener('load', () => {
                this.onIframeLoad();
            });

            this.iframe.addEventListener('error', () => {
                this.onIframeError();
            });

            // Retry button
            const retryBtn = this.modal.querySelector('.retry-trailer');
            if (retryBtn) {
                retryBtn.addEventListener('click', () => {
                    this.retryLoad();
                });
            }

            // Action buttons
            const watchlistBtn = this.modal.querySelector('.add-to-watchlist');
            if (watchlistBtn) {
                watchlistBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.addToWatchlist();
                });
            }

            const favoritesBtn = this.modal.querySelector('.add-to-favorites');
            if (favoritesBtn) {
                favoritesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.addToFavorites();
                });
            }

            const detailsBtn = this.modal.querySelector('.view-details');
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.viewDetails();
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (this.isVisible()) {
                    if (e.key === 'Escape') {
                        this.hide();
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        this.togglePlayPause();
                    }
                }
            });
        }

        setupBootstrapModal() {
            if (typeof bootstrap !== 'undefined') {
                this.bootstrapModal = new bootstrap.Modal(this.modal, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
            }
        }

        show(videoId, title, contentId = null, description = null) {
            this.currentVideoId = videoId;
            this.currentTitle = title;
            this.currentContentId = contentId;

            // Update modal content
            this.updateModalContent(title, description);
            this.updateActionButtons(contentId);

            // Show loading state
            this.showLoading();

            // Load video
            this.loadVideo(videoId);

            // Show modal
            if (this.bootstrapModal) {
                this.bootstrapModal.show();
            } else {
                this.modal.style.display = 'block';
                this.modal.classList.add('show');
                document.body.classList.add('modal-open');
            }

            // Record view interaction
            if (contentId && auth.isAuthenticated()) {
                auth.viewContent(contentId);
            }
        }

        hide() {
            if (this.bootstrapModal) {
                this.bootstrapModal.hide();
            } else {
                this.modal.style.display = 'none';
                this.modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        updateModalContent(title, description = null) {
            this.modalTitle.textContent = `${title} - Trailer`;
            this.trailerTitle.textContent = title;
            this.trailerDescription.textContent = description || 'Official Trailer';
        }

        updateActionButtons(contentId) {
            const buttons = this.modal.querySelectorAll('[data-content-id]');
            buttons.forEach(btn => {
                if (contentId) {
                    btn.dataset.contentId = contentId;
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });

            // Update details link
            const detailsBtn = this.modal.querySelector('.view-details');
            if (detailsBtn && contentId) {
                detailsBtn.href = `/content/details.html?id=${contentId}`;
            }
        }

        loadVideo(videoId) {
            if (!videoId) {
                this.showError();
                return;
            }

            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;

            this.showLoading();
            this.iframe.src = embedUrl;
        }

        showLoading() {
            this.loadingOverlay.classList.remove('d-none');
            this.errorOverlay.classList.add('d-none');
        }

        hideLoading() {
            this.loadingOverlay.classList.add('d-none');
        }

        showError() {
            this.loadingOverlay.classList.add('d-none');
            this.errorOverlay.classList.remove('d-none');
        }

        hideError() {
            this.errorOverlay.classList.add('d-none');
        }

        onModalShow() {
            // Add any show logic here
            document.body.style.overflow = 'hidden';
        }

        onModalHide() {
            // Pause video
            this.iframe.src = '';
        }

        onModalHidden() {
            // Reset modal state
            this.currentVideoId = null;
            this.currentContentId = null;
            this.currentTitle = null;
            this.hideLoading();
            this.hideError();
            document.body.style.overflow = '';
        }

        onIframeLoad() {
            this.hideLoading();
            this.hideError();
        }

        onIframeError() {
            this.showError();
        }

        retryLoad() {
            if (this.currentVideoId) {
                this.loadVideo(this.currentVideoId);
            }
        }

        togglePlayPause() {
            // Send pause/play command to iframe (YouTube API)
            try {
                this.iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            } catch (error) {
                console.warn('Cannot control video playback:', error);
            }
        }

        isVisible() {
            return this.modal.classList.contains('show') || this.modal.style.display === 'block';
        }

        async addToWatchlist() {
            if (!auth.isAuthenticated()) {
                this.hide();
                window.location.href = '/auth/login.html';
                return;
            }

            if (!this.currentContentId) return;

            try {
                const btn = this.modal.querySelector('.add-to-watchlist');
                const originalContent = btn.innerHTML;

                btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                btn.disabled = true;

                await auth.addToWatchlist(this.currentContentId);

                btn.innerHTML = '<i class="bi bi-check-lg"></i>';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');

                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error adding to watchlist:', error);
            }
        }

        async addToFavorites() {
            if (!auth.isAuthenticated()) {
                this.hide();
                window.location.href = '/auth/login.html';
                return;
            }

            if (!this.currentContentId) return;

            try {
                const btn = this.modal.querySelector('.add-to-favorites');
                const originalContent = btn.innerHTML;

                btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                btn.disabled = true;

                await auth.addToFavorites(this.currentContentId);

                btn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-danger');

                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error adding to favorites:', error);
            }
        }

        viewDetails() {
            if (this.currentContentId) {
                window.location.href = `/content/details.html?id=${this.currentContentId}`;
            }
        }

        // Static method to show trailer globally
        static show(videoId, title, contentId = null, description = null) {
            if (!window.trailerModalInstance) {
                window.trailerModalInstance = new TrailerModal();
            }
            window.trailerModalInstance.show(videoId, title, contentId, description);
        }

        // Extract video ID from YouTube URL
        static extractVideoId(url) {
            if (!url) return null;

            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);

            return (match && match[2].length === 11) ? match[2] : null;
        }
    }

    // Initialize trailer modal when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Create global instance
        window.trailerModalInstance = new TrailerModal();

        // Setup global click handlers for play trailer buttons
        document.addEventListener('click', function (e) {
            const playButton = e.target.closest('.play-trailer');
            if (playButton) {
                e.preventDefault();
                e.stopPropagation();

                const videoId = playButton.dataset.videoId;
                const title = playButton.dataset.title;
                const contentId = playButton.dataset.contentId;
                const description = playButton.dataset.description;

                if (videoId) {
                    TrailerModal.show(videoId, title, contentId, description);
                }
            }
        });
    });

    // Export for global use
    window.TrailerModal = TrailerModal;
</script>

<style>
    .trailer-modal .modal-dialog {
        max-width: 90%;
    }

    .trailer-modal .modal-content {
        background: var(--theater-dark);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        overflow: hidden;
    }

    .trailer-modal .modal-header {
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        padding: 1rem 1.5rem;
    }

    .trailer-modal .modal-title {
        font-weight: 600;
        color: white;
    }

    .trailer-modal .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .video-container {
        aspect-ratio: 16/9;
        background: #000;
    }

    .trailer-iframe {
        border: none;
        aspect-ratio: 16/9;
    }

    .loading-overlay,
    .error-overlay {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10;
    }

    .trailer-info {
        background: rgba(30, 30, 35, 0.9);
        border-top: 1px solid rgba(139, 92, 246, 0.2);
    }

    .trailer-title {
        font-weight: 600;
        color: white;
    }

    .trailer-description {
        color: rgba(156, 163, 175, 0.8);
        font-size: 0.875rem;
    }

    /* Action buttons */
    .trailer-modal .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .trailer-modal .btn-outline-primary {
        border-color: rgba(59, 130, 246, 0.5);
        color: #3b82f6;
    }

    .trailer-modal .btn-outline-primary:hover {
        background-color: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }

    .trailer-modal .btn-outline-danger {
        border-color: rgba(239, 68, 68, 0.5);
        color: #ef4444;
    }

    .trailer-modal .btn-outline-danger:hover {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: #ef4444;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .trailer-modal .modal-dialog {
            max-width: 95%;
            margin: 1rem auto;
        }

        .video-container {
            height: 250px;
        }

        .trailer-iframe {
            height: 250px;
        }

        .trailer-info .col-md-4 {
            margin-top: 1rem;
            text-align: center !important;
        }
    }

    @media (max-width: 576px) {
        .trailer-modal .modal-header {
            padding: 0.75rem 1rem;
        }

        .trailer-modal .modal-title {
            font-size: 1rem;
        }

        .video-container {
            height: 200px;
        }

        .trailer-iframe {
            height: 200px;
        }

        .trailer-info {
            padding: 0.75rem;
        }

        .trailer-info .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    /* Animation */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: scale(0.9);
    }

    .modal.show .modal-dialog {
        transform: scale(1);
    }

    /* Focus states */
    .trailer-modal .btn:focus {
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
    }

    /* Loading animation */
    .loading-overlay .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    /* Error state styling */
    .error-overlay .bi-exclamation-triangle {
        color: #f59e0b;
        font-size: 4rem;
    }

    .retry-trailer {
        background: linear-gradient(135deg, var(--platinum-blue), var(--royal-purple));
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        color: white;
        transition: all 0.3s ease;
    }

    .retry-trailer:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
</style>