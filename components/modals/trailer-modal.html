<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel" aria-hidden="true"
    role="dialog" aria-modal="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-[#0a0a0f] border-[#60a5fa]/20">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title text-[#e0e0ff]" id="trailerModalLabel">Watch Trailer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="trailer-iframe" src="" title="Trailer video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let trailerModal;
    let currentTrailerPosition = 0;

    // Initialize modal
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('trailerModal');
        if (modalElement) {
            trailerModal = new bootstrap.Modal(modalElement);

            // Handle modal events
            modalElement.addEventListener('hide.bs.modal', function () {
                // Save position and pause video
                const iframe = document.getElementById('trailer-iframe');
                if (iframe.src) {
                    // Store position in sessionStorage
                    const contentId = iframe.dataset.contentId;
                    if (contentId) {
                        sessionStorage.setItem(`${contentId}_trailer_pos`, currentTrailerPosition);
                    }
                    // Clear iframe to stop playback
                    iframe.src = '';
                }
            });
        }
    });

    // Open trailer modal
    function openTrailer(youtubeId, contentId, title) {
        if (!youtubeId) {
            showToast('Trailer not available', 'warning');
            return;
        }

        const iframe = document.getElementById('trailer-iframe');
        const modalTitle = document.getElementById('trailerModalLabel');

        // Set title
        modalTitle.textContent = title ? `${title} - Trailer` : 'Watch Trailer';

        // Check for saved position
        const savedPosition = sessionStorage.getItem(`${contentId}_trailer_pos`);
        const startTime = savedPosition ? `&start=${savedPosition}` : '';

        // Set iframe source with autoplay
        iframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1${startTime}`;
        iframe.dataset.contentId = contentId;

        // Show modal
        trailerModal.show();

        // Prefetch related content
        if (contentId) {
            fetch(`https://backend-app-970m.onrender.com/api/recommendations/similar/${contentId}?limit=5`)
                .catch(() => { });
        }
    }

    // Helper to extract YouTube ID from URL
    function getYouTubeId(url) {
        if (!url) return null;
        const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);
        return match ? match[1] : null;
    }
</script>

<style>
    #trailerModal .modal-content {
        background: #0a0a0f;
        border: 1px solid rgba(96, 165, 250, 0.2);
    }

    #trailerModal .btn-close-white {
        filter: invert(1);
    }

    @media (max-width: 768px) {
        #trailerModal .modal-dialog {
            margin: 0;
            max-width: 100%;
            height: 100%;
        }

        #trailerModal .modal-content {
            height: 100%;
            border-radius: 0;
        }
    }
</style>