<!-- Advanced Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="fas fa-filter me-2 text-netflix-red"></i>
                    Advanced Filters
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="filterForm">
                    <!-- Content Type Filter -->
                    <div class="filter-section mb-4">
                        <h6 class="filter-section-title text-netflix-red mb-3">
                            <i class="fas fa-film me-2"></i>Content Type
                        </h6>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="movie" id="filterMovie"
                                        checked>
                                    <label class="form-check-label text-light" for="filterMovie">
                                        <i class="fas fa-film me-2"></i>Movies
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="tv" id="filterTV" checked>
                                    <label class="form-check-label text-light" for="filterTV">
                                        <i class="fas fa-tv me-2"></i>TV Series
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="anime" id="filterAnime"
                                        checked>
                                    <label class="form-check-label text-light" for="filterAnime">
                                        <i class="fas fa-magic me-2"></i>Anime
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Genre Filter -->
                    <div class="filter-section mb-4">
                        <h6 class="filter-section-title text-netflix-red mb-3">
                            <i class="fas fa-tags me-2"></i>Genres
                        </h6>
                        <div class="genre-filter-container">
                            <div class="row" id="genreCheckboxes">
                                <!-- Genres populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Rating Filter -->
                    <div class="filter-section mb-4">
                        <h6 class="filter-section-title text-netflix-red mb-3">
                            <i class="fas fa-star me-2"></i>Rating Range
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="minRating" class="form-label">Minimum Rating</label>
                                <select class="form-select bg-dark text-light border-secondary" id="minRating">
                                    <option value="0">Any Rating</option>
                                    <option value="6.0">6.0+ Good</option>
                                    <option value="7.0">7.0+ Very Good</option>
                                    <option value="8.0">8.0+ Excellent</option>
                                    <option value="9.0">9.0+ Masterpiece</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="maxRating" class="form-label">Maximum Rating</label>
                                <select class="form-select bg-dark text-light border-secondary" id="maxRating">
                                    <option value="10">Any Rating</option>
                                    <option value="9.0">Below 9.0</option>
                                    <option value="8.0">Below 8.0</option>
                                    <option value="7.0">Below 7.0</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Year Range Filter -->
                    <div class="filter-section mb-4">
                        <h6 class="filter-section-title text-netflix-red mb-3">
                            <i class="fas fa-calendar me-2"></i>Release Year
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="yearFrom" class="form-label">From Year</label>
                                <select class="form-select bg-dark text-light border-secondary" id="yearFrom">
                                    <option value="">Any Year</option>
                                    <!-- Years populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="yearTo" class="form-label">To Year</label>
                                <select class="form-select bg-dark text-light border-secondary" id="yearTo">
                                    <option value="">Any Year</option>
                                    <!-- Years populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Language Filter -->
                    <div class="filter-section mb-4">
                        <h6 class="filter-section-title text-netflix-red mb-3">
                            <i class="fas fa-globe me-2"></i>Language
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="en" id="langEnglish" checked>
                                    <label class="form-check-label text-light" for="langEnglish">English</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="hi" id="langHindi">
                                    <label class="form-check-label text-light" for="langHindi">Hindi</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="ja" id="langJapanese">
                                    <label class="form-check-label text-light" for="langJapanese">Japanese</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="ko" id="langKorean">
                                    <label class="form-check-label text-light" for="langKorean">Korean</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sort Options -->
                    <div class="filter-section mb-4">
                        <h6 class="filter-section-title text-netflix-red mb-3">
                            <i class="fas fa-sort me-2"></i>Sort By
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select bg-dark text-light border-secondary" id="sortBy">
                                    <option value="popularity.desc">Popularity (High to Low)</option>
                                    <option value="rating.desc">Rating (High to Low)</option>
                                    <option value="release_date.desc">Newest First</option>
                                    <option value="release_date.asc">Oldest First</option>
                                    <option value="title.asc">Title A-Z</option>
                                    <option value="title.desc">Title Z-A</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select bg-dark text-light border-secondary" id="resultsPerPage">
                                    <option value="20">20 Results</option>
                                    <option value="40">40 Results</option>
                                    <option value="60">60 Results</option>
                                    <option value="100">100 Results</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" id="clearFilters">
                    <i class="fas fa-eraser me-2"></i>Clear All
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-netflix-red" id="applyFilters">
                    <i class="fas fa-search me-2"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    class FilterModal {
        constructor() {
            this.modal = document.getElementById('filterModal');
            this.form = document.getElementById('filterForm');
            this.currentFilters = this.getDefaultFilters();

            this.init();
        }

        init() {
            this.populateGenres();
            this.populateYears();
            this.attachEventListeners();
            this.loadSavedFilters();
        }

        getDefaultFilters() {
            return {
                contentTypes: ['movie', 'tv', 'anime'],
                genres: [],
                minRating: 0,
                maxRating: 10,
                yearFrom: '',
                yearTo: '',
                languages: ['en'],
                sortBy: 'popularity.desc',
                resultsPerPage: 20
            };
        }

        async populateGenres() {
            const genres = [
                'Action', 'Adventure', 'Animation', 'Biography', 'Comedy', 'Crime',
                'Documentary', 'Drama', 'Family', 'Fantasy', 'History', 'Horror',
                'Music', 'Mystery', 'Romance', 'Science Fiction', 'Thriller', 'War',
                'Western', 'Slice of Life', 'Supernatural', 'Psychological'
            ];

            const container = document.getElementById('genreCheckboxes');
            let html = '';

            genres.forEach((genre, index) => {
                const genreId = `genre${genre.replace(/\s+/g, '')}`;
                html += `
        <div class="col-md-4 col-sm-6 mb-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${genre.toLowerCase()}" id="${genreId}">
            <label class="form-check-label text-light" for="${genreId}">${genre}</label>
          </div>
        </div>
      `;
            });

            container.innerHTML = html;
        }

        populateYears() {
            const currentYear = new Date().getFullYear();
            const startYear = 1950;

            const yearFromSelect = document.getElementById('yearFrom');
            const yearToSelect = document.getElementById('yearTo');

            let yearOptions = '';
            for (let year = currentYear; year >= startYear; year--) {
                yearOptions += `<option value="${year}">${year}</option>`;
            }

            yearFromSelect.innerHTML = '<option value="">Any Year</option>' + yearOptions;
            yearToSelect.innerHTML = '<option value="">Any Year</option>' + yearOptions;
        }

        attachEventListeners() {
            // Apply filters button
            document.getElementById('applyFilters').addEventListener('click', () => {
                this.applyFilters();
            });

            // Clear filters button
            document.getElementById('clearFilters').addEventListener('click', () => {
                this.clearFilters();
            });

            // Form input changes
            this.form.addEventListener('change', () => {
                this.updateFilters();
            });

            // Modal events
            this.modal.addEventListener('shown.bs.modal', () => {
                this.loadCurrentFilters();
            });
        }

        updateFilters() {
            // Content types
            this.currentFilters.contentTypes = Array.from(
                this.form.querySelectorAll('input[type="checkbox"][value="movie"], input[type="checkbox"][value="tv"], input[type="checkbox"][value="anime"]:checked')
            ).map(cb => cb.value);

            // Genres
            this.currentFilters.genres = Array.from(
                this.form.querySelectorAll('#genreCheckboxes input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            // Rating range
            this.currentFilters.minRating = parseFloat(document.getElementById('minRating').value) || 0;
            this.currentFilters.maxRating = parseFloat(document.getElementById('maxRating').value) || 10;

            // Year range
            this.currentFilters.yearFrom = document.getElementById('yearFrom').value;
            this.currentFilters.yearTo = document.getElementById('yearTo').value;

            // Languages
            this.currentFilters.languages = Array.from(
                this.form.querySelectorAll('input[type="checkbox"][value^="en"], input[type="checkbox"][value^="hi"], input[type="checkbox"][value^="ja"], input[type="checkbox"][value^="ko"]:checked')
            ).map(cb => cb.value);

            // Sort options
            this.currentFilters.sortBy = document.getElementById('sortBy').value;
            this.currentFilters.resultsPerPage = parseInt(document.getElementById('resultsPerPage').value);
        }

        loadCurrentFilters() {
            // Load content types
            this.currentFilters.contentTypes.forEach(type => {
                const checkbox = this.form.querySelector(`input[value="${type}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Load genres
            this.currentFilters.genres.forEach(genre => {
                const checkbox = this.form.querySelector(`#genreCheckboxes input[value="${genre}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Load rating range
            document.getElementById('minRating').value = this.currentFilters.minRating;
            document.getElementById('maxRating').value = this.currentFilters.maxRating;

            // Load year range
            document.getElementById('yearFrom').value = this.currentFilters.yearFrom;
            document.getElementById('yearTo').value = this.currentFilters.yearTo;

            // Load languages
            this.currentFilters.languages.forEach(lang => {
                const checkbox = this.form.querySelector(`input[value="${lang}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Load sort options
            document.getElementById('sortBy').value = this.currentFilters.sortBy;
            document.getElementById('resultsPerPage').value = this.currentFilters.resultsPerPage;
        }

        clearFilters() {
            this.currentFilters = this.getDefaultFilters();

            // Reset form
            this.form.reset();

            // Re-check default content types
            ['movie', 'tv', 'anime'].forEach(type => {
                const checkbox = this.form.querySelector(`input[value="${type}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Check English by default
            const englishCheckbox = this.form.querySelector('input[value="en"]');
            if (englishCheckbox) englishCheckbox.checked = true;
        }

        applyFilters() {
            this.updateFilters();
            this.saveFilters();

            // Dispatch filter event
            const event = new CustomEvent('filtersApplied', {
                detail: { filters: this.currentFilters }
            });
            document.dispatchEvent(event);

            // Hide modal
            const bsModal = bootstrap.Modal.getInstance(this.modal);
            bsModal.hide();

            // Navigate to search with filters
            this.navigateWithFilters();
        }

        navigateWithFilters() {
            const params = new URLSearchParams();

            // Add filters to URL
            if (this.currentFilters.contentTypes.length > 0 && this.currentFilters.contentTypes.length < 3) {
                params.set('type', this.currentFilters.contentTypes.join(','));
            }

            if (this.currentFilters.genres.length > 0) {
                params.set('genres', this.currentFilters.genres.join(','));
            }

            if (this.currentFilters.minRating > 0) {
                params.set('min_rating', this.currentFilters.minRating);
            }

            if (this.currentFilters.maxRating < 10) {
                params.set('max_rating', this.currentFilters.maxRating);
            }

            if (this.currentFilters.yearFrom) {
                params.set('year_from', this.currentFilters.yearFrom);
            }

            if (this.currentFilters.yearTo) {
                params.set('year_to', this.currentFilters.yearTo);
            }

            if (this.currentFilters.languages.length > 0) {
                params.set('languages', this.currentFilters.languages.join(','));
            }

            params.set('sort', this.currentFilters.sortBy);
            params.set('limit', this.currentFilters.resultsPerPage);

            // Navigate to search page
            const currentPath = window.location.pathname;
            if (currentPath.includes('search')) {
                // Update current search page
                window.location.search = params.toString();
            } else {
                // Navigate to search page
                window.location.href = `content/search.html?${params.toString()}`;
            }
        }

        saveFilters() {
            localStorage.setItem('cinebrain_filters', JSON.stringify(this.currentFilters));
        }

        loadSavedFilters() {
            const saved = localStorage.getItem('cinebrain_filters');
            if (saved) {
                try {
                    this.currentFilters = { ...this.getDefaultFilters(), ...JSON.parse(saved) };
                } catch (error) {
                    console.error('Error loading saved filters:', error);
                }
            }
        }

        getFilters() {
            return this.currentFilters;
        }

        setFilters(newFilters) {
            this.currentFilters = { ...this.currentFilters, ...newFilters };
        }
    }

    // Initialize filter modal
    document.addEventListener('DOMContentLoaded', () => {
        window.filterModal = new FilterModal();
    });
</script>

<style>
    .text-netflix-red {
        color: #E50914 !important;
    }

    .btn-netflix-red {
        background-color: #E50914;
        border-color: #E50914;
        color: white;
    }

    .btn-netflix-red:hover {
        background-color: #B8070F;
        border-color: #B8070F;
        color: white;
    }

    .filter-section {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 1rem;
    }

    .filter-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .filter-section-title {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
    }

    .form-check-input:checked {
        background-color: #E50914;
        border-color: #E50914;
    }

    .form-check-input:focus {
        border-color: #E50914;
        box-shadow: 0 0 0 0.25rem rgba(229, 9, 20, 0.25);
    }

    .form-select:focus {
        border-color: #E50914;
        box-shadow: 0 0 0 0.25rem rgba(229, 9, 20, 0.25);
    }

    @media (max-width: 768px) {
        .modal-dialog {
            margin: 0.5rem;
        }

        .filter-section-title {
            font-size: 0.85rem;
        }
    }
</style>