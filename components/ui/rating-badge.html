<!-- CineBrain Rating Badge Component -->
<span class="rating-badge" data-content-id="" data-rating-type="composite">
    <i class="bi bi-star-fill rating-icon"></i>
    <span class="rating-value">--</span>
    <span class="rating-source">Loading...</span>
</span>

<script>
(function() {
    'use strict';
    
    class RatingBadge {
        constructor(element, contentId, options = {}) {
            this.element = element;
            this.contentId = contentId;
            this.options = {
                type: 'composite', // 'composite', 'imdb', 'tmdb', 'rt', 'user'
                showSource: true,
                size: 'normal', // 'small', 'normal', 'large'
                ...options
            };
            this.init();
        }
        
        init() {
            this.setupElement();
            this.loadRating();
        }
        
        setupElement() {
            this.element.setAttribute('data-content-id', this.contentId);
            this.element.setAttribute('data-rating-type', this.options.type);
            this.element.className = `rating-badge rating-${this.options.size}`;
            
            if (!this.options.showSource) {
                this.element.classList.add('no-source');
            }
        }
        
        async loadRating() {
            try {
                this.showLoading();
                
                const response = await fetch(`https://backend-app-970m.onrender.com/api/content/${this.contentId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch content data');
                }
                
                const contentData = await response.json();
                this.displayRating(contentData);
                
            } catch (error) {
                console.error('Error loading rating:', error);
                this.showError();
            }
        }
        
        displayRating(contentData) {
            const ratingValue = this.element.querySelector('.rating-value');
            const ratingSource = this.element.querySelector('.rating-source');
            const ratingIcon = this.element.querySelector('.rating-icon');
            
            let rating = null;
            let source = '';
            let iconClass = 'bi-star-fill';
            
            switch (this.options.type) {
                case 'composite':
                    rating = this.calculateCompositeRating(contentData);
                    source = 'CineBrain';
                    iconClass = 'bi-star-fill';
                    break;
                    
                case 'imdb':
                    rating = this.extractIMDbRating(contentData);
                    source = 'IMDb';
                    iconClass = 'bi-star-fill';
                    break;
                    
                case 'tmdb':
                    rating = contentData.rating;
                    source = 'TMDb';
                    iconClass = 'bi-star-fill';
                    break;
                    
                case 'rt':
                    rating = this.extractRottenTomatoesRating(contentData);
                    source = 'RT';
                    iconClass = 'bi-percent';
                    break;
                    
                case 'user':
                    rating = await this.getUserRating(contentData.id);
                    source = 'Users';
                    iconClass = 'bi-people-fill';
                    break;
                    
                default:
                    rating = contentData.rating;
                    source = 'TMDb';
            }
            
            if (rating !== null && rating !== undefined) {
                this.updateDisplay(rating, source, iconClass);
            } else {
                this.showNoRating();
            }
        }
        
        calculateCompositeRating(contentData) {
            // Calculate weighted composite rating from multiple sources
            const ratings = [];
            const weights = [];
            
            // TMDb rating (weight: 0.3)
            if (contentData.rating && contentData.vote_count > 10) {
                ratings.push(contentData.rating);
                weights.push(0.3);
            }
            
            // IMDb rating (weight: 0.4)
            const imdbRating = this.extractIMDbRating(contentData);
            if (imdbRating) {
                ratings.push(imdbRating);
                weights.push(0.4);
            }
            
            // Critics score (weight: 0.2)
            if (contentData.critics_score) {
                ratings.push(contentData.critics_score);
                weights.push(0.2);
            }
            
            // User ratings (weight: 0.1)
            if (contentData.user_rating) {
                ratings.push(contentData.user_rating);
                weights.push(0.1);
            }
            
            if (ratings.length === 0) return null;
            
            // Calculate weighted average
            let weightedSum = 0;
            let totalWeight = 0;
            
            for (let i = 0; i < ratings.length; i++) {
                weightedSum += ratings[i] * weights[i];
                totalWeight += weights[i];
            }
            
            return Math.round((weightedSum / totalWeight) * 10) / 10;
        }
        
        extractIMDbRating(contentData) {
            // Try to extract IMDb rating from content data
            if (contentData.imdb_rating) {
                return contentData.imdb_rating;
            }
            
            // Parse from external_ratings if available
            if (contentData.external_ratings) {
                try {
                    const ratings = JSON.parse(contentData.external_ratings);
                    return ratings.imdb?.rating;
                } catch (e) {
                    return null;
                }
            }
            
            return null;
        }
        
        extractRottenTomatoesRating(contentData) {
            // Try to extract Rotten Tomatoes rating
            if (contentData.rt_score) {
                return contentData.rt_score;
            }
            
            if (contentData.external_ratings) {
                try {
                    const ratings = JSON.parse(contentData.external_ratings);
                    return ratings.rotten_tomatoes?.critics_score;
                } catch (e) {
                    return null;
                }
            }
            
            return null;
        }
        
        async getUserRating(contentId) {
            try {
                const response = await fetch(`https://backend-app-970m.onrender.com/api/content/${contentId}/user-rating`);
                if (response.ok) {
                    const data = await response.json();
                    return data.average_rating;
                }
            } catch (error) {
                console.error('Error fetching user rating:', error);
            }
            return null;
        }
        
        updateDisplay(rating, source, iconClass) {
            const ratingValue = this.element.querySelector('.rating-value');
            const ratingSource = this.element.querySelector('.rating-source');
            const ratingIcon = this.element.querySelector('.rating-icon');
            
            // Update icon
            ratingIcon.className = `${iconClass} rating-icon`;
            
            // Update rating value
            if (this.options.type === 'rt') {
                ratingValue.textContent = `${Math.round(rating)}%`;
            } else {
                ratingValue.textContent = Number(rating).toFixed(1);
            }
            
            // Update source
            if (this.options.showSource) {
                ratingSource.textContent = source;
                ratingSource.style.display = 'inline';
            } else {
                ratingSource.style.display = 'none';
            }
            
            // Add rating tier class for color coding
            this.addRatingTierClass(rating);
            
            // Remove loading state
            this.element.classList.remove('loading', 'error');
        }
        
        addRatingTierClass(rating) {
            // Remove existing tier classes
            this.element.classList.remove('rating-excellent', 'rating-good', 'rating-average', 'rating-poor');
            
            // Add appropriate tier class
            if (rating >= 8.0) {
                this.element.classList.add('rating-excellent');
            } else if (rating >= 6.5) {
                this.element.classList.add('rating-good');
            } else if (rating >= 5.0) {
                this.element.classList.add('rating-average');
            } else {
                this.element.classList.add('rating-poor');
            }
        }
        
        showLoading() {
            this.element.classList.add('loading');
            const ratingValue = this.element.querySelector('.rating-value');
            const ratingSource = this.element.querySelector('.rating-source');
            
            ratingValue.textContent = '--';
            if (this.options.showSource) {
                ratingSource.textContent = 'Loading...';
            }
        }
        
        showError() {
            this.element.classList.add('error');
            this.element.classList.remove('loading');
            
            const ratingValue = this.element.querySelector('.rating-value');
            const ratingSource = this.element.querySelector('.rating-source');
            
            ratingValue.textContent = 'N/A';
            if (this.options.showSource) {
                ratingSource.textContent = 'Error';
            }
        }
        
        showNoRating() {
            const ratingValue = this.element.querySelector('.rating-value');
            const ratingSource = this.element.querySelector('.rating-source');
            
            ratingValue.textContent = 'NR';
            if (this.options.showSource) {
                ratingSource.textContent = 'Not Rated';
            }
            
            this.element.classList.remove('loading', 'error');
            this.element.classList.add('no-rating');
        }
    }
    
    // Global function to create rating badge
    window.createRatingBadge = function(contentId, container, options = {}) {
        const badgeHTML = `
            <span class="rating-badge" data-content-id="${contentId}">
                <i class="bi bi-star-fill rating-icon"></i>
                <span class="rating-value">--</span>
                <span class="rating-source">Loading...</span>
            </span>
        `;
        
        if (container) {
            container.insertAdjacentHTML('beforeend', badgeHTML);
            const newBadge = container.lastElementChild;
            new RatingBadge(newBadge, contentId, options);
            return newBadge;
        } else {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = badgeHTML;
            const badgeElement = tempDiv.firstElementChild;
            new RatingBadge(badgeElement, contentId, options);
            return badgeElement;
        }
    };
    
    // Auto-initialize rating badges
    function initRatingBadges() {
        document.querySelectorAll('.rating-badge:not([data-initialized])').forEach(badgeElement => {
            badgeElement.setAttribute('data-initialized', 'true');
            
            const contentId = badgeElement.dataset.contentId;
            const ratingType = badgeElement.dataset.ratingType || 'composite';
            const showSource = badgeElement.dataset.showSource !== 'false';
            const size = badgeElement.dataset.size || 'normal';
            
            if (contentId) {
                new RatingBadge(badgeElement, contentId, {
                    type: ratingType,
                    showSource: showSource,
                    size: size
                });
            }
        });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRatingBadges);
    } else {
        initRatingBadges();
    }
    
})();
</script>

<style>
.rating-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-quaternary));
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all var(--transition-fast) var(--ease-cinematic);
}

.rating-badge.loading {
    opacity: 0.7;
    animation: pulse 1.5s ease-in-out infinite;
}

.rating-badge.error {
    background: var(--cinema-red);
    color: white;
}

.rating-badge.no-rating {
    background: var(--bg-tertiary);
    color: var(--text-muted);
}

/* Size variants */
.rating-badge.rating-small {
    padding: 0.125rem 0.375rem;
    font-size: 0.625rem;
    gap: 0.125rem;
}

.rating-badge.rating-large {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    gap: 0.375rem;
}

/* Rating tier colors */
.rating-badge.rating-excellent {
    background: linear-gradient(135deg, var(--emerald-green), #059669);
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.rating-badge.rating-good {
    background: linear-gradient(135deg, var(--vip-gold), #d97706);
    color: white;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.rating-badge.rating-average {
    background: linear-gradient(135deg, var(--sunset-orange), #ea580c);
    color: white;
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
}

.rating-badge.rating-poor {
    background: linear-gradient(135deg, var(--cinema-red), #dc2626);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.rating-icon {
    font-size: 0.75em;
    flex-shrink: 0;
}

.rating-value {
    font-weight: 700;
    letter-spacing: 0.025em;
}

.rating-source {
    font-size: 0.85em;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.rating-badge.no-source .rating-source {
    display: none;
}

/* Hover effects */
.rating-badge:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.rating-badge.rating-excellent:hover {
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.rating-badge.rating-good:hover {
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.rating-badge.rating-average:hover {
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
}

.rating-badge.rating-poor:hover {
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

/* Animation for rating updates */
@keyframes ratingUpdate {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

.rating-badge.updating {
    animation: ratingUpdate 0.3s ease-in-out;
}

/* Responsive adjustments */
@media (max-width: 767.98px) {
    .rating-badge {
        font-size: 0.6875rem;
        padding: 0.1875rem 0.375rem;
    }
    
    .rating-badge.rating-large {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>