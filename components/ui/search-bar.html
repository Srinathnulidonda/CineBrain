<div class="search-bar-component" data-endpoint="{{endpoint}}" data-placeholder="{{placeholder}}">
    <div class="search-input-wrapper">
        <input type="text" 
               class="search-input" 
               placeholder="{{placeholder}}" 
               autocomplete="off">
        <button class="search-clear" style="display: none;">×</button>
        <button class="search-submit">
            <i class="icon-search"></i>
        </button>
    </div>
    <div class="search-suggestions" style="display: none;"></div>
</div>

<script>
class SearchBar {
    constructor(element) {
        this.element = element;
        this.input = element.querySelector('.search-input');
        this.clearBtn = element.querySelector('.search-clear');
        this.submitBtn = element.querySelector('.search-submit');
        this.suggestions = element.querySelector('.search-suggestions');
        this.endpoint = element.dataset.endpoint || API_ENDPOINTS.SEARCH;
        
        this.searchDebounce = null;
        this.currentRequest = null;
        
        this.init();
    }
    
    init() {
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('focus', () => this.handleFocus());
        this.input.addEventListener('blur', () => this.handleBlur());
        this.clearBtn.addEventListener('click', () => this.clearSearch());
        this.submitBtn.addEventListener('click', () => this.submitSearch());
        this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.submitSearch();
        });
        
        // Click outside to close suggestions
        document.addEventListener('click', (e) => {
            if (!this.element.contains(e.target)) {
                this.hideSuggestions();
            }
        });
    }
    
    handleInput(e) {
        const query = e.target.value.trim();
        
        // Show/hide clear button
        this.clearBtn.style.display = query ? 'block' : 'none';
        
        // Cancel previous request
        if (this.currentRequest) {
            this.currentRequest.abort();
        }
        
        // Clear previous timeout
        clearTimeout(this.searchDebounce);
        
        if (query.length < 2) {
            this.hideSuggestions();
            return;
        }
        
        // Debounce search
        this.searchDebounce = setTimeout(() => {
            this.performSearch(query);
        }, 300);
    }
    
    async performSearch(query) {
        try {
            this.showLoadingSuggestions();
            
            const controller = new AbortController();
            this.currentRequest = controller;
            
            const response = await fetch(`${this.endpoint}?query=${encodeURIComponent(query)}&limit=5`, {
                signal: controller.signal,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                }
            });
            
            if (!response.ok) throw new Error('Search failed');
            
            const data = await response.json();
            this.displaySuggestions(data.results || []);
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Search error:', error);
                this.hideSuggestions();
            }
        } finally {
            this.currentRequest = null;
        }
    }
    
    displaySuggestions(results) {
        if (results.length === 0) {
            this.suggestions.innerHTML = `
                <div class="no-suggestions">
                    No results found
                </div>
            `;
        } else {
            this.suggestions.innerHTML = results.map(item => `
                <a href="/content/details.html?id=${item.id}" class="suggestion-item">
                    <img src="${item.poster_path ? 
                        `https://image.tmdb.org/t/p/w92${item.poster_path}` : 
                        '/images/placeholder.jpg'}" 
                        alt="${item.title}">
                    <div class="suggestion-info">
                        <div class="suggestion-title">${item.title}</div>
                        <div class="suggestion-meta">
                            ${item.content_type} 
                            ${item.rating ? `• ⭐ ${item.rating.toFixed(1)}` : ''}
                        </div>
                    </div>
                </a>
            `).join('');
        }
        
        this.suggestions.style.display = 'block';
    }
    
    showLoadingSuggestions() {
        this.suggestions.innerHTML = `
            <div class="suggestions-loading">
                <div class="loader-spinner small"></div>
                Searching...
            </div>
        `;
        this.suggestions.style.display = 'block';
    }
    
    hideSuggestions() {
        setTimeout(() => {
            this.suggestions.style.display = 'none';
        }, 200);
    }
    
    clearSearch() {
        this.input.value = '';
        this.clearBtn.style.display = 'none';
        this.hideSuggestions();
        this.input.focus();
    }
    
    submitSearch() {
        const query = this.input.value.trim();
        if (query) {
            window.location.href = `/content/search.html?q=${encodeURIComponent(query)}`;
        }
    }
    
    handleFocus() {
        this.element.classList.add('focused');
    }
    
    handleBlur() {
        this.element.classList.remove('focused');
    }
}

// Auto-initialize
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.search-bar-component').forEach(searchBar => {
        new SearchBar(searchBar);
    });
});
</script>

<style>
.search-bar-component {
    position: relative;
    width: 100%;
    max-width: 600px;
}

.search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.search-input {
    width: 100%;
    padding: var(--space-md) var(--space-lg);
    padding-right: 80px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid transparent;
    border-radius: 24px;
    color: var(--text-primary);
    font-size: 1rem;
    transition: all var(--transition-fast);
}

.search-bar-component.focused .search-input {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--platinum-blue);
}

.search-clear {
    position: absolute;
    right: 50px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.25rem;
    cursor: pointer;
    padding: var(--space-sm);
}

.search-submit {
    position: absolute;
    right: 4px;
    background: var(--platinum-blue);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.search-submit:hover {
    background: var(--primary-600);
    transform: scale(1.05);
}

.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: var(--space-sm);
    background: var(--theater-dark);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    box-shadow: var(--shadow-xl);
    max-height: 400px;
    overflow-y: auto;
    z-index: 100;
}

.suggestion-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    transition: background var(--transition-fast);
    text-decoration: none;
    color: inherit;
}

.suggestion-item:hover {
    background: var(--velvet-dark);
}

.suggestion-item img {
    width: 40px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
}

.suggestion-info {
    flex: 1;
}

.suggestion-title {
    font-weight: 600;
    margin-bottom: var(--space-xs);
}

.suggestion-meta {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.suggestions-loading,
.no-suggestions {
    padding: var(--space-lg);
    text-align: center;
    color: var(--text-secondary);
}

.loader-spinner.small {
    width: 20px;
    height: 20px;
    border-width: 2px;
}
</style>