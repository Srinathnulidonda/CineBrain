<form id="global-search" role="search" class="w-100" onsubmit="handleSearch(event)">
    <div class="position-relative">
        <input id="search-input" type="search"
            class="form-control rounded-pill ps-5 pe-4 py-2 bg-[#1a1a2e] text-[#e0e0ff] border-[#60a5fa]/30"
            placeholder="Search movies, shows, anime..." aria-autocomplete="list" aria-controls="search-suggestions"
            aria-expanded="false" autocomplete="off" style="height: 42px;">

        <!-- Search Icon -->
        <div class="position-absolute start-0 top-50 translate-middle-y ps-3">
            <svg class="w-5 h-5 text-[#60a5fa]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>

        <!-- Clear Button -->
        <button type="button" id="clear-search"
            class="btn btn-ghost position-absolute end-0 top-50 translate-middle-y pe-2 d-none" onclick="clearSearch()"
            aria-label="Clear search">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Loading Spinner -->
        <div id="search-spinner" class="position-absolute end-0 top-50 translate-middle-y pe-3 d-none">
            <div class="spinner-border spinner-border-sm text-[#60a5fa]" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Suggestions Dropdown -->
    <ul id="search-suggestions" role="listbox"
        class="list-unstyled position-absolute w-100 mt-2 bg-[#1a1a2e] rounded-3 shadow-lg overflow-hidden d-none"
        style="max-height: 400px; overflow-y: auto; z-index: 1050;">
    </ul>
</form>

<script>
    let searchTimeout;
    let selectedIndex = -1;
    const searchCache = new Map();

    // Initialize search input
    const searchInput = document.getElementById('search-input');
    const suggestions = document.getElementById('search-suggestions');
    const clearBtn = document.getElementById('clear-search');
    const spinner = document.getElementById('search-spinner');

    // Input handler with debounce
    searchInput.addEventListener('input', function (e) {
        const query = e.target.value.trim();

        // Show/hide clear button
        clearBtn.classList.toggle('d-none', query.length === 0);

        // Clear timeout for previous search
        clearTimeout(searchTimeout);

        if (query.length < 2) {
            hideSuggestions();
            return;
        }

        // Check cache first
        if (searchCache.has(query)) {
            showSuggestions(searchCache.get(query));
            return;
        }

        // Show spinner
        spinner.classList.remove('d-none');

        // Debounced search
        searchTimeout = setTimeout(() => fetchSuggestions(query), 250);
    });

    // Fetch suggestions from API
    async function fetchSuggestions(query) {
        try {
            const response = await fetch(`https://backend-app-970m.onrender.com/api/search?query=${encodeURIComponent(query)}&limit=6`);
            const data = await response.json();

            // Cache results
            searchCache.set(query, data.results);

            // Show suggestions
            showSuggestions(data.results);
        } catch (error) {
            console.error('Search error:', error);
            showSuggestions([]);
        } finally {
            spinner.classList.add('d-none');
        }
    }

    // Display suggestions
    function showSuggestions(results) {
        if (results.length === 0) {
            suggestions.innerHTML = `
                <li class="p-3 text-center text-[#a78bfa]">
                    No suggestions found. Press Enter to search.
                </li>
            `;
        } else {
            suggestions.innerHTML = results.map((item, index) => `
                <li role="option" 
                    class="suggestion-item d-flex align-items-center gap-3 p-2 hover:bg-[#60a5fa]/20 cursor-pointer"
                    data-index="${index}"
                    data-id="${item.id}"
                    onclick="selectSuggestion(${item.id})">
                    ${item.poster_path ? `
                        <img src="${item.poster_path}" 
                             alt="${item.title}" 
                             class="rounded"
                             style="width: 40px; height: 60px; object-fit: cover;">
                    ` : `
                        <div class="bg-gradient-to-br from-[#60a5fa] to-[#a78bfa] rounded d-flex align-items-center justify-content-center"
                             style="width: 40px; height: 60px;">
                            <span class="text-white fw-bold">${item.title[0]}</span>
                        </div>
                    `}
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-[#e0e0ff]">${item.title}</div>
                        <div class="text-xs text-[#a78bfa]">
                            ${item.content_type} • ${item.rating ? `⭐ ${item.rating}` : 'Not rated'}
                        </div>
                    </div>
                </li>
            `).join('');
        }

        suggestions.classList.remove('d-none');
        searchInput.setAttribute('aria-expanded', 'true');
        selectedIndex = -1;
    }

    // Hide suggestions
    function hideSuggestions() {
        suggestions.classList.add('d-none');
        searchInput.setAttribute('aria-expanded', 'false');
        selectedIndex = -1;
    }

    // Keyboard navigation
    searchInput.addEventListener('keydown', function (e) {
        const items = suggestions.querySelectorAll('.suggestion-item');

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
                break;

            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
                break;

            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    const id = items[selectedIndex].dataset.id;
                    selectSuggestion(id);
                } else {
                    handleSearch(e);
                }
                break;

            case 'Escape':
                hideSuggestions();
                searchInput.blur();
                break;
        }
    });

    // Update keyboard selection
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-[#60a5fa]/20');
                item.setAttribute('aria-selected', 'true');
                searchInput.setAttribute('aria-activedescendant', `suggestion-${index}`);
            } else {
                item.classList.remove('bg-[#60a5fa]/20');
                item.setAttribute('aria-selected', 'false');
            }
        });
    }

    // Select suggestion
    function selectSuggestion(contentId) {
        window.location.href = `/content/details.html?id=${contentId}`;
    }

    // Handle form submission
    function handleSearch(event) {
        event.preventDefault();
        const query = searchInput.value.trim();
        if (query) {
            window.location.href = `/content/search.html?q=${encodeURIComponent(query)}`;
        }
    }

    // Clear search
    function clearSearch() {
        searchInput.value = '';
        clearBtn.classList.add('d-none');
        hideSuggestions();
        searchInput.focus();
    }

    // Hide suggestions on click outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('#global-search')) {
            hideSuggestions();
        }
    });

    // Prefetch on hover
    suggestions.addEventListener('mouseover', function (e) {
        const item = e.target.closest('.suggestion-item');
        if (item) {
            const id = item.dataset.id;
            // Prefetch content details
            fetch(`https://backend-app-970m.onrender.com/api/content/${id}`).catch(() => { });
        }
    });
</script>

<style>
    #search-input:focus {
        outline: none;
        border-color: #60a5fa;
        box-shadow: 0 0 0 0.2rem rgba(96, 165, 250, 0.25);
    }

    .suggestion-item:hover {
        background: rgba(96, 165, 250, 0.1);
    }

    #search-suggestions::-webkit-scrollbar {
        width: 8px;
    }

    #search-suggestions::-webkit-scrollbar-track {
        background: #1a1a2e;
    }

    #search-suggestions::-webkit-scrollbar-thumb {
        background: #60a5fa;
        border-radius: 4px;
    }
</style>