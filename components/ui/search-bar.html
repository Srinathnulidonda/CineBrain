<!-- Enhanced Search Component -->
<div class="search-container position-relative" id="searchContainer">
    <!-- Mobile: Initially shows only icon, expands to full search -->
    <div class="d-md-none">
        <button class="btn btn-outline-light rounded-circle p-2 search-toggle-btn" id="mobileSearchToggle">
            <i class="fas fa-search"></i>
        </button>

        <!-- Expandable search bar for mobile -->
        <div class="search-bar-mobile position-absolute top-0 end-0 w-100 bg-dark rounded-3 border border-light border-opacity-25 p-2 d-none"
            style="z-index: 1050; transform: translateX(100%); transition: transform 0.3s ease;">
            <div class="d-flex align-items-center">
                <input type="text" class="form-control bg-transparent border-0 text-light search-input-mobile"
                    placeholder="Search movies, shows, anime..." id="mobileSearchInput">
                <button class="btn btn-outline-light btn-sm ms-2 search-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-results-mobile mt-2 d-none"></div>
        </div>
    </div>

    <!-- Desktop: Always visible search bar -->
    <div class="d-none d-md-block">
        <div class="input-group search-bar-desktop" style="min-width: 300px;">
            <span class="input-group-text bg-dark border-light border-opacity-25 text-light">
                <i class="fas fa-search"></i>
            </span>
            <input type="text"
                class="form-control bg-dark border-light border-opacity-25 text-light search-input-desktop"
                placeholder="Search movies, shows, anime..." id="desktopSearchInput">
            <button class="btn btn-outline-light search-filter-btn" type="button" title="Filters">
                <i class="fas fa-filter"></i>
            </button>
        </div>

        <!-- Desktop search results dropdown -->
        <div class="search-results-desktop position-absolute w-100 bg-dark border border-light border-opacity-25 rounded-3 mt-1 p-0 d-none shadow-lg"
            style="z-index: 1050; max-height: 400px; overflow-y: auto;">
            <!-- Results populated dynamically -->
        </div>
    </div>
</div>

<script>
    class EnhancedSearch {
        constructor() {
            this.searchContainer = document.getElementById('searchContainer');
            this.mobileSearchToggle = document.getElementById('mobileSearchToggle');
            this.mobileSearchBar = this.searchContainer.querySelector('.search-bar-mobile');
            this.mobileSearchInput = document.getElementById('mobileSearchInput');
            this.desktopSearchInput = document.getElementById('desktopSearchInput');
            this.searchCloseBtn = this.searchContainer.querySelector('.search-close-btn');

            this.searchTimeout = null;
            this.isSearchOpen = false;

            this.init();
        }

        init() {
            this.attachEventListeners();
            this.loadRecentSearches();
        }

        attachEventListeners() {
            // Mobile search toggle
            this.mobileSearchToggle.addEventListener('click', () => {
                this.toggleMobileSearch();
            });

            // Close mobile search
            this.searchCloseBtn.addEventListener('click', () => {
                this.closeMobileSearch();
            });

            // Search input handlers
            this.mobileSearchInput.addEventListener('input', (e) => {
                this.handleSearchInput(e.target.value, 'mobile');
            });

            this.desktopSearchInput.addEventListener('input', (e) => {
                this.handleSearchInput(e.target.value, 'desktop');
            });

            // Enter key search
            [this.mobileSearchInput, this.desktopSearchInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch(e.target.value);
                    }
                });
            });

            // Filter button
            this.searchContainer.querySelector('.search-filter-btn')?.addEventListener('click', () => {
                this.showFilterModal();
            });

            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!this.searchContainer.contains(e.target)) {
                    this.hideSearchResults();
                }
            });
        }

        toggleMobileSearch() {
            if (this.isSearchOpen) {
                this.closeMobileSearch();
            } else {
                this.openMobileSearch();
            }
        }

        openMobileSearch() {
            this.mobileSearchBar.classList.remove('d-none');
            this.mobileSearchToggle.style.opacity = '0';

            // Animate slide in
            setTimeout(() => {
                this.mobileSearchBar.style.transform = 'translateX(0)';
                this.mobileSearchInput.focus();
            }, 10);

            this.isSearchOpen = true;
        }

        closeMobileSearch() {
            this.mobileSearchBar.style.transform = 'translateX(100%)';
            this.mobileSearchToggle.style.opacity = '1';

            setTimeout(() => {
                this.mobileSearchBar.classList.add('d-none');
                this.hideSearchResults('mobile');
            }, 300);

            this.isSearchOpen = false;
        }

        async handleSearchInput(query, device) {
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }

            if (query.trim().length < 2) {
                this.hideSearchResults(device);
                return;
            }

            // Debounce search
            this.searchTimeout = setTimeout(() => {
                this.searchContent(query, device);
            }, 300);
        }

        async searchContent(query, device) {
            try {
                const response = await fetch(`https://backend-app-970m.onrender.com/api/search?query=${encodeURIComponent(query)}&type=multi`);

                if (response.ok) {
                    const data = await response.json();
                    this.displaySearchResults(data.results, device);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        displaySearchResults(results, device) {
            const resultsContainer = device === 'mobile'
                ? this.searchContainer.querySelector('.search-results-mobile')
                : this.searchContainer.querySelector('.search-results-desktop');

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<div class="p-3 text-muted text-center">No results found</div>';
                resultsContainer.classList.remove('d-none');
                return;
            }

            const resultsHTML = results.slice(0, 8).map(item => `
      <div class="search-result-item d-flex align-items-center p-2 border-bottom border-secondary border-opacity-25 search-result-hover"
           data-content-id="${item.id}"
           style="cursor: pointer;">
        <img src="${item.poster_path || '/api/placeholder/40x60'}" 
             alt="${item.title}"
             class="search-result-poster me-3 rounded-1"
             style="width: 40px; height: 60px; object-fit: cover;">
        
        <div class="flex-grow-1">
          <h6 class="text-light mb-1 search-result-title">${item.title}</h6>
          <div class="d-flex align-items-center gap-2">
            <span class="badge ${this.getTypeColor(item.content_type)} badge-sm">${item.content_type.toUpperCase()}</span>
            ${item.rating ? `<span class="text-warning small">‚≠ê ${item.rating.toFixed(1)}</span>` : ''}
          </div>
          <div class="text-muted small">${item.genres?.slice(0, 3).join(', ') || ''}</div>
        </div>
        
        <i class="fas fa-chevron-right text-muted"></i>
      </div>
    `).join('');

            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.classList.remove('d-none');

            // Add click handlers to results
            resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const contentId = item.dataset.contentId;
                    window.location.href = `content/details.html?id=${contentId}`;
                });
            });
        }

        getTypeColor(type) {
            const colors = {
                'movie': 'bg-primary',
                'tv': 'bg-success',
                'anime': 'bg-info'
            };
            return colors[type] || 'bg-secondary';
        }

        hideSearchResults(device) {
            if (device) {
                const resultsContainer = device === 'mobile'
                    ? this.searchContainer.querySelector('.search-results-mobile')
                    : this.searchContainer.querySelector('.search-results-desktop');
                resultsContainer.classList.add('d-none');
            } else {
                // Hide both
                this.searchContainer.querySelector('.search-results-mobile')?.classList.add('d-none');
                this.searchContainer.querySelector('.search-results-desktop')?.classList.add('d-none');
            }
        }

        performSearch(query) {
            if (query.trim()) {
                // Save to recent searches
                this.saveRecentSearch(query);

                // Navigate to search page
                window.location.href = `content/search.html?q=${encodeURIComponent(query)}`;
            }
        }

        showFilterModal() {
            // Show filter modal (will be implemented with filter-modal.html)
            const filterModal = document.querySelector('#filterModal');
            if (filterModal) {
                const bsModal = new bootstrap.Modal(filterModal);
                bsModal.show();
            }
        }

        saveRecentSearch(query) {
            let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            recentSearches = recentSearches.filter(search => search !== query);
            recentSearches.unshift(query);
            recentSearches = recentSearches.slice(0, 10); // Keep only 10 recent searches
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }

        loadRecentSearches() {
            const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
            // Could show these when search input is focused but empty
        }
    }

    // Initialize enhanced search
    document.addEventListener('DOMContentLoaded', () => {
        new EnhancedSearch();
    });
</script>

<style>
    .search-result-hover:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .search-result-poster {
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-bar-mobile {
        min-width: 280px;
    }

    @media (max-width: 576px) {
        .search-bar-mobile {
            min-width: calc(100vw - 40px);
        }
    }
</style>