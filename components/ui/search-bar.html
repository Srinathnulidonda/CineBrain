<!-- Advanced Search Bar Component -->
<div class="search-bar-component position-relative" data-search-type="global">

    <!-- Main Search Input -->
    <div class="search-input-container position-relative">
        <div class="input-group">
            <span class="input-group-text bg-velvet border-royal">
                <i class="bi bi-search text-gray-400"></i>
            </span>

            <input type="text" class="form-control search-input bg-velvet border-royal text-white"
                placeholder="Search movies, shows, anime..." autocomplete="off" data-bs-toggle="dropdown"
                aria-expanded="false">

            <button class="btn btn-outline-royal filter-toggle" type="button" title="Advanced Filters">
                <i class="bi bi-funnel"></i>
            </button>

            <button class="btn btn-primary search-submit" type="button">
                <span class="search-btn-text">Search</span>
                <div class="spinner-border spinner-border-sm d-none" role="status">
                    <span class="visually-hidden">Searching...</span>
                </div>
            </button>
        </div>

        <!-- Search Suggestions Dropdown -->
        <div class="dropdown-menu search-suggestions w-100 bg-theater border-royal shadow-lg custom-scroll"
            style="max-height: 400px; overflow-y: auto;">

            <!-- Quick Filters -->
            <div class="quick-filters p-3 border-bottom border-gray-700">
                <h6 class="text-white mb-2">Quick Filters</h6>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary quick-filter" data-filter="trending">Trending</button>
                    <button class="btn btn-sm btn-outline-secondary quick-filter" data-filter="new">New
                        Releases</button>
                    <button class="btn btn-sm btn-outline-success quick-filter" data-filter="top-rated">Top
                        Rated</button>
                    <button class="btn btn-sm btn-outline-warning quick-filter" data-filter="anime">Anime</button>
                </div>
            </div>

            <!-- Search History -->
            <div class="search-history p-3 border-bottom border-gray-700 d-none">
                <h6 class="text-white mb-2">Recent Searches</h6>
                <div class="history-items">
                    <!-- Dynamic history items -->
                </div>
            </div>

            <!-- Search Results -->
            <div class="search-results">
                <!-- Dynamic search results -->
            </div>

            <!-- No Results -->
            <div class="no-results p-4 text-center text-muted d-none">
                <i class="bi bi-search mb-2 fs-3"></i>
                <p class="mb-0">No results found. Try different keywords.</p>
            </div>
        </div>
    </div>

    <!-- Advanced Filters Panel -->
    <div class="advanced-filters position-absolute top-100 start-0 w-100 bg-theater border border-royal rounded-3 shadow-lg mt-2 p-4 d-none"
        style="z-index: 1000;">

        <div class="row g-3">
            <!-- Content Type Filter -->
            <div class="col-md-3">
                <label class="form-label text-white">Type</label>
                <select class="form-select bg-velvet border-royal text-white filter-type">
                    <option value="">All Types</option>
                    <option value="movie">Movies</option>
                    <option value="tv">TV Shows</option>
                    <option value="anime">Anime</option>
                </select>
            </div>

            <!-- Genre Filter -->
            <div class="col-md-3">
                <label class="form-label text-white">Genre</label>
                <select class="form-select bg-velvet border-royal text-white filter-genre">
                    <option value="">All Genres</option>
                    <option value="action">Action</option>
                    <option value="comedy">Comedy</option>
                    <option value="drama">Drama</option>
                    <option value="horror">Horror</option>
                    <option value="romance">Romance</option>
                    <option value="sci-fi">Sci-Fi</option>
                    <option value="thriller">Thriller</option>
                </select>
            </div>

            <!-- Year Range -->
            <div class="col-md-3">
                <label class="form-label text-white">Year</label>
                <div class="d-flex gap-2">
                    <input type="number" class="form-control bg-velvet border-royal text-white filter-year-from"
                        placeholder="From" min="1900" max="2024">
                    <input type="number" class="form-control bg-velvet border-royal text-white filter-year-to"
                        placeholder="To" min="1900" max="2024">
                </div>
            </div>

            <!-- Rating Filter -->
            <div class="col-md-3">
                <label class="form-label text-white">Min Rating</label>
                <select class="form-select bg-velvet border-royal text-white filter-rating">
                    <option value="">Any Rating</option>
                    <option value="7">7+ Stars</option>
                    <option value="8">8+ Stars</option>
                    <option value="9">9+ Stars</option>
                </select>
            </div>

            <!-- Language Filter -->
            <div class="col-md-4">
                <label class="form-label text-white">Language</label>
                <select class="form-select bg-velvet border-royal text-white filter-language">
                    <option value="">All Languages</option>
                    <option value="english">English</option>
                    <option value="hindi">Hindi</option>
                    <option value="telugu">Telugu</option>
                    <option value="tamil">Tamil</option>
                    <option value="kannada">Kannada</option>
                    <option value="malayalam">Malayalam</option>
                </select>
            </div>

            <!-- Sort By -->
            <div class="col-md-4">
                <label class="form-label text-white">Sort By</label>
                <select class="form-select bg-velvet border-royal text-white filter-sort">
                    <option value="popularity">Popularity</option>
                    <option value="rating">Rating</option>
                    <option value="release_date">Release Date</option>
                    <option value="title">Title</option>
                </select>
            </div>

            <!-- Filter Actions -->
            <div class="col-md-4 d-flex align-items-end gap-2">
                <button class="btn btn-primary flex-fill apply-filters">Apply Filters</button>
                <button class="btn btn-outline-secondary clear-filters">Clear</button>
            </div>
        </div>
    </div>
</div>

<script>
    class SearchBar {
        constructor(element) {
            this.element = element;
            this.searchInput = element.querySelector('.search-input');
            this.searchSuggestions = element.querySelector('.search-suggestions');
            this.advancedFilters = element.querySelector('.advanced-filters');
            this.isOpen = false;
            this.searchHistory = this.loadSearchHistory();
            this.currentFilters = {};
            this.debounceTimer = null;

            this.initialize();
        }

        initialize() {
            this.setupEventListeners();
            this.loadSearchHistory();
            this.preloadQuickFilters();
        }

        setupEventListeners() {
            // Search input events
            this.searchInput.addEventListener('input', (e) => {
                this.handleSearchInput(e.target.value);
            });

            this.searchInput.addEventListener('focus', () => {
                this.showSuggestions();
            });

            this.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.performSearch();
                } else if (e.key === 'Escape') {
                    this.hideSuggestions();
                }
            });

            // Search submit button
            const submitBtn = this.element.querySelector('.search-submit');
            submitBtn.addEventListener('click', () => {
                this.performSearch();
            });

            // Filter toggle
            const filterToggle = this.element.querySelector('.filter-toggle');
            filterToggle.addEventListener('click', () => {
                this.toggleAdvancedFilters();
            });

            // Quick filters
            const quickFilters = this.element.querySelectorAll('.quick-filter');
            quickFilters.forEach(filter => {
                filter.addEventListener('click', (e) => {
                    this.handleQuickFilter(e.target.dataset.filter);
                });
            });

            // Advanced filter actions
            const applyFilters = this.element.querySelector('.apply-filters');
            applyFilters.addEventListener('click', () => {
                this.applyAdvancedFilters();
            });

            const clearFilters = this.element.querySelector('.clear-filters');
            clearFilters.addEventListener('click', () => {
                this.clearAdvancedFilters();
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!this.element.contains(e.target)) {
                    this.hideSuggestions();
                    this.hideAdvancedFilters();
                }
            });

            // Handle suggestion clicks
            this.searchSuggestions.addEventListener('click', (e) => {
                const resultItem = e.target.closest('.search-result-item');
                if (resultItem) {
                    const contentId = resultItem.dataset.contentId;
                    this.selectSearchResult(contentId);
                }

                const historyItem = e.target.closest('.history-item');
                if (historyItem) {
                    const query = historyItem.dataset.query;
                    this.searchInput.value = query;
                    this.performSearch();
                }
            });
        }

        handleSearchInput(query) {
            clearTimeout(this.debounceTimer);

            if (query.length < 2) {
                this.showQuickOptions();
                return;
            }

            this.debounceTimer = setTimeout(async () => {
                await this.performLiveSearch(query);
            }, 300);
        }

        async performLiveSearch(query) {
            try {
                this.showSearchLoading();

                const response = await api.search(query, {
                    type: this.currentFilters.type || 'multi',
                    limit: 8
                });

                this.displaySearchResults(response.results || []);

            } catch (error) {
                console.error('Live search error:', error);
                this.showSearchError();
            }
        }

        async performSearch() {
            const query = this.searchInput.value.trim();
            if (!query) return;

            try {
                this.showSearchLoading();
                this.addToSearchHistory(query);

                // Build search params
                const searchParams = new URLSearchParams({
                    q: query,
                    ...this.currentFilters
                });

                // Navigate to search results page
                window.location.href = `/content/search.html?${searchParams.toString()}`;

            } catch (error) {
                console.error('Search error:', error);
                this.showSearchError();
            }
        }

        showSearchLoading() {
            const submitBtn = this.element.querySelector('.search-submit');
            const btnText = submitBtn.querySelector('.search-btn-text');
            const spinner = submitBtn.querySelector('.spinner-border');

            btnText.classList.add('d-none');
            spinner.classList.remove('d-none');
            submitBtn.disabled = true;

            this.searchSuggestions.innerHTML = `
      <div class="p-4 text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Searching...</span>
        </div>
        <p class="mt-2 text-muted">Searching...</p>
      </div>
    `;
            this.showSuggestions();
        }

        hideSearchLoading() {
            const submitBtn = this.element.querySelector('.search-submit');
            const btnText = submitBtn.querySelector('.search-btn-text');
            const spinner = submitBtn.querySelector('.spinner-border');

            btnText.classList.remove('d-none');
            spinner.classList.add('d-none');
            submitBtn.disabled = false;
        }

        displaySearchResults(results) {
            this.hideSearchLoading();

            if (results.length === 0) {
                this.searchSuggestions.innerHTML = `
        <div class="no-results p-4 text-center text-muted">
          <i class="bi bi-search mb-2 fs-3"></i>
          <p class="mb-0">No results found. Try different keywords.</p>
        </div>
      `;
            } else {
                const resultsHTML = results.map(item => `
        <div class="search-result-item dropdown-item d-flex align-items-center p-3 hover:bg-velvet" 
             data-content-id="${item.id}">
          <img src="${item.poster_path || IMAGE_CONFIG.PLACEHOLDER}" 
               alt="${item.title}" 
               class="rounded me-3" 
               style="width: 40px; height: 60px; object-fit: cover;"
               loading="lazy">
          <div class="flex-grow-1">
            <h6 class="mb-1 text-white">${item.title}</h6>
            <p class="mb-1 text-sm text-gray-400">
              ${item.content_type.toUpperCase()} 
              ${item.release_date ? `• ${new Date(item.release_date).getFullYear()}` : ''}
            </p>
            <div class="text-xs text-yellow-500">
              ${item.rating ? `⭐ ${UTILS.formatRating(item.rating)}` : 'No rating'}
            </div>
          </div>
          <i class="bi bi-arrow-right text-gray-400"></i>
        </div>
      `).join('');

                this.searchSuggestions.innerHTML = resultsHTML;
            }

            this.showSuggestions();
        }

        showQuickOptions() {
            // Show quick filters and search history
            const quickFiltersHTML = this.element.querySelector('.quick-filters').outerHTML;
            const historyHTML = this.getSearchHistoryHTML();

            this.searchSuggestions.innerHTML = quickFiltersHTML + historyHTML;
            this.showSuggestions();
        }

        getSearchHistoryHTML() {
            if (this.searchHistory.length === 0) return '';

            const historyItems = this.searchHistory.slice(0, 5).map(query => `
      <div class="history-item dropdown-item d-flex align-items-center p-2 hover:bg-velvet" 
           data-query="${query}">
        <i class="bi bi-clock-history me-2 text-gray-400"></i>
        <span class="text-white">${query}</span>
      </div>
    `).join('');

            return `
      <div class="search-history p-3 border-bottom border-gray-700">
        <h6 class="text-white mb-2">Recent Searches</h6>
        ${historyItems}
      </div>
    `;
        }

        showSuggestions() {
            this.searchSuggestions.classList.add('show');
            this.isOpen = true;
        }

        hideSuggestions() {
            this.searchSuggestions.classList.remove('show');
            this.isOpen = false;
        }

        toggleAdvancedFilters() {
            if (this.advancedFilters.classList.contains('d-none')) {
                this.showAdvancedFilters();
            } else {
                this.hideAdvancedFilters();
            }
        }

        showAdvancedFilters() {
            this.advancedFilters.classList.remove('d-none');
            this.hideSuggestions();
        }

        hideAdvancedFilters() {
            this.advancedFilters.classList.add('d-none');
        }

        applyAdvancedFilters() {
            // Collect filter values
            this.currentFilters = {
                type: this.element.querySelector('.filter-type').value,
                genre: this.element.querySelector('.filter-genre').value,
                year_from: this.element.querySelector('.filter-year-from').value,
                year_to: this.element.querySelector('.filter-year-to').value,
                rating: this.element.querySelector('.filter-rating').value,
                language: this.element.querySelector('.filter-language').value,
                sort: this.element.querySelector('.filter-sort').value
            };

            // Remove empty filters
            Object.keys(this.currentFilters).forEach(key => {
                if (!this.currentFilters[key]) {
                    delete this.currentFilters[key];
                }
            });

            this.hideAdvancedFilters();
            this.performSearch();
        }

        clearAdvancedFilters() {
            this.currentFilters = {};

            // Reset all filter inputs
            this.element.querySelectorAll('.advanced-filters select, .advanced-filters input').forEach(input => {
                input.value = '';
            });

            this.hideAdvancedFilters();
        }

        handleQuickFilter(filterType) {
            switch (filterType) {
                case 'trending':
                    window.location.href = '/content/trending.html';
                    break;
                case 'new':
                    window.location.href = '/content/trending.html?filter=new-releases';
                    break;
                case 'top-rated':
                    window.location.href = '/content/trending.html?filter=critics-choice';
                    break;
                case 'anime':
                    window.location.href = '/content/anime.html';
                    break;
            }
        }

        selectSearchResult(contentId) {
            window.location.href = `/content/details.html?id=${contentId}`;
        }

        addToSearchHistory(query) {
            // Remove if already exists
            this.searchHistory = this.searchHistory.filter(item => item !== query);

            // Add to beginning
            this.searchHistory.unshift(query);

            // Keep only last 10 searches
            this.searchHistory = this.searchHistory.slice(0, 10);

            // Save to localStorage
            localStorage.setItem(STORAGE_KEYS.SEARCH_HISTORY, JSON.stringify(this.searchHistory));
        }

        loadSearchHistory() {
            try {
                const history = localStorage.getItem(STORAGE_KEYS.SEARCH_HISTORY);
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('Error loading search history:', error);
                return [];
            }
        }

        showSearchError() {
            this.hideSearchLoading();
            this.searchSuggestions.innerHTML = `
      <div class="p-4 text-center text-danger">
        <i class="bi bi-exclamation-triangle mb-2 fs-3"></i>
        <p class="mb-0">Search failed. Please try again.</p>
      </div>
    `;
            this.showSuggestions();
        }

        async preloadQuickFilters() {
            try {
                // Preload trending content for quick access
                await api.prefetch(API_ENDPOINTS.TRENDING, { limit: 5 });
            } catch (error) {
                console.warn('Failed to preload quick filters:', error);
            }
        }
    }

    // Initialize search bars
    document.addEventListener('DOMContentLoaded', function () {
        const searchBars = document.querySelectorAll('.search-bar-component');
        searchBars.forEach(searchBar => {
            new SearchBar(searchBar);
        });
    });

    // Export for dynamic use
    window.SearchBar = SearchBar;
</script>

<style>
    .search-bar-component {
        z-index: 1000;
    }

    .search-input {
        background-color: rgba(30, 30, 35, 0.8);
        backdrop-filter: blur(10px);
        border-color: rgba(139, 92, 246, 0.3);
        color: white;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        background-color: rgba(30, 30, 35, 0.9);
        border-color: var(--platinum-blue);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        color: white;
    }

    .search-input::placeholder {
        color: rgba(156, 163, 175, 0.8);
    }

    .input-group-text {
        background-color: rgba(30, 30, 35, 0.8);
        border-color: rgba(139, 92, 246, 0.3);
        color: rgba(156, 163, 175, 0.8);
    }

    .filter-toggle {
        border-color: rgba(139, 92, 246, 0.3);
        color: rgba(139, 92, 246, 0.8);
    }

    .filter-toggle:hover {
        background-color: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.5);
        color: rgba(139, 92, 246, 1);
    }

    .search-suggestions {
        background: rgba(20, 20, 24, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 12px;
        margin-top: 8px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .search-result-item:hover {
        background-color: rgba(30, 30, 35, 0.8);
        cursor: pointer;
    }

    .history-item:hover {
        background-color: rgba(30, 30, 35, 0.8);
        cursor: pointer;
    }

    .quick-filter {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        transition: all 0.3s ease;
    }

    .quick-filter:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .advanced-filters {
        background: rgba(20, 20, 24, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(139, 92, 246, 0.2);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .advanced-filters .form-control,
    .advanced-filters .form-select {
        background-color: rgba(30, 30, 35, 0.8);
        border-color: rgba(139, 92, 246, 0.3);
        color: white;
    }

    .advanced-filters .form-control:focus,
    .advanced-filters .form-select:focus {
        background-color: rgba(30, 30, 35, 0.9);
        border-color: var(--platinum-blue);
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        color: white;
    }

    .advanced-filters .form-select option {
        background-color: var(--theater-dark);
        color: white;
    }

    /* Custom scrollbar for suggestions */
    .custom-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: rgba(30, 30, 35, 0.5);
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.6);
        border-radius: 3px;
    }

    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 92, 246, 0.8);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .advanced-filters .row {
            --bs-gutter-x: 0.5rem;
        }

        .advanced-filters .col-md-3,
        .advanced-filters .col-md-4 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .search-suggestions {
            max-height: 300px;
        }
    }
</style>