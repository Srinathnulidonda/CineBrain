<!-- Infinite Scroll Component -->
<template id="infinite-scroll-template">
    <div class="infinite-scroll-container">
        <div class="infinite-scroll-content"></div>
        <div class="infinite-scroll-loader" style="display: none;">
            <div class="spinner"></div>
            <p>Loading more content...</p>
        </div>
        <div class="infinite-scroll-end" style="display: none;">
            <p>You've reached the end!</p>
        </div>
        <div class="infinite-scroll-error" style="display: none;">
            <p>Failed to load content</p>
            <button class="btn btn-secondary btn-sm">Retry</button>
        </div>
    </div>
</template>

<script>
    class InfiniteScroll extends HTMLElement {
        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this.page = 1;
            this.loading = false;
            this.hasMore = true;
            this.observer = null;
            this.loadMoreCallback = null;
        }

        connectedCallback() {
            this.loadTemplate();
            this.setupIntersectionObserver();
            this.setupEventListeners();

            // Load initial content
            if (this.getAttribute('auto-load') === 'true') {
                this.loadMore();
            }
        }

        disconnectedCallback() {
            if (this.observer) {
                this.observer.disconnect();
            }
        }

        loadTemplate() {
            const template = document.getElementById('infinite-scroll-template');
            const node = template.content.cloneNode(true);

            const style = document.createElement('style');
            style.textContent = `
            @import '/assets/css/components.css';
            
            .infinite-scroll-container {
                position: relative;
            }
            
            .infinite-scroll-loader,
            .infinite-scroll-end,
            .infinite-scroll-error {
                text-align: center;
                padding: 2rem;
                color: var(--text-muted);
            }
            
            .spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(255, 255, 255, 0.1);
                border-top-color: var(--accent-blue);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 1rem;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            .infinite-scroll-content {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            @media (max-width: 768px) {
                .infinite-scroll-content {
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                }
            }
        `;

            this.shadowRoot.appendChild(style);
            this.shadowRoot.appendChild(node);
        }

        setupIntersectionObserver() {
            const options = {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            };

            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !this.loading && this.hasMore) {
                        this.loadMore();
                    }
                });
            }, options);

            // Observe loader element
            const loader = this.shadowRoot.querySelector('.infinite-scroll-loader');
            this.observer.observe(loader);
        }

        setupEventListeners() {
            // Retry button
            const retryBtn = this.shadowRoot.querySelector('.infinite-scroll-error button');
            retryBtn.addEventListener('click', () => this.retry());

            // Custom load more callback
            const callback = this.getAttribute('load-more');
            if (callback) {
                this.loadMoreCallback = new Function('page', callback);
            }
        }

        async loadMore() {
            if (this.loading || !this.hasMore) return;

            this.loading = true;
            this.showLoader();

            try {
                // Get data source
                const endpoint = this.getAttribute('endpoint');
                const contentType = this.getAttribute('content-type') || 'movie';

                let data;

                if (this.loadMoreCallback) {
                    // Use custom callback
                    data = await this.loadMoreCallback(this.page);
                } else if (endpoint) {
                    // Use API endpoint
                    data = await this.fetchData(endpoint, this.page);
                } else {
                    // Default to trending
                    data = await api.getTrending(contentType, 20);
                }

                if (data && data.recommendations) {
                    this.renderContent(data.recommendations);
                    this.page++;

                    // Check if there's more content
                    if (data.recommendations.length < 20) {
                        this.hasMore = false;
                        this.showEnd();
                    }
                } else {
                    this.hasMore = false;
                    this.showEnd();
                }

            } catch (error) {
                console.error('Failed to load more content:', error);
                this.showError();
            } finally {
                this.loading = false;
                this.hideLoader();
            }
        }

        async fetchData(endpoint, page) {
            const params = new URLSearchParams({
                page: page,
                limit: 20
            });

            const response = await fetch(`${Config.API_BASE}${endpoint}?${params}`, {
                headers: {
                    'Authorization': `Bearer ${Storage.getToken()}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            return response.json();
        }

        renderContent(items) {
            const container = this.shadowRoot.querySelector('.infinite-scroll-content');
            const fragment = document.createDocumentFragment();

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'content-item animate-fadeInUp';
                card.style.animationDelay = `${index * 0.05}s`;

                card.innerHTML = `
                <div class="content-card" onclick="window.location.href='/content/details.html?id=${item.id}'">
                    <div class="content-card__image-wrapper">
                        <img src="${item.poster_path || '/assets/images/placeholder-poster.jpg'}" 
                             alt="${item.title}"
                             loading="lazy"
                             class="content-card__image">
                        ${item.is_new_release ? '<span class="badge badge--new">NEW</span>' : ''}
                    </div>
                    <div class="content-card__body">
                        <h3 class="content-card__title">${item.title}</h3>
                        <div class="content-card__meta">
                            <span class="rating">
                                <i class="bi bi-star-fill"></i> ${item.rating || 'N/A'}
                            </span>
                            <span>${item.content_type || ''}</span>
                        </div>
                    </div>
                </div>
            `;

                fragment.appendChild(card);
            });

            container.appendChild(fragment);

            // Emit event
            this.dispatchEvent(new CustomEvent('content-loaded', {
                detail: { items, page: this.page }
            }));
        }

        retry() {
            this.hideError();
            this.loadMore();
        }

        reset() {
            this.page = 1;
            this.hasMore = true;
            this.loading = false;

            const container = this.shadowRoot.querySelector('.infinite-scroll-content');
            container.innerHTML = '';

            this.hideError();
            this.hideEnd();

            if (this.getAttribute('auto-load') === 'true') {
                this.loadMore();
            }
        }

        showLoader() {
            this.shadowRoot.querySelector('.infinite-scroll-loader').style.display = 'block';
        }

        hideLoader() {
            this.shadowRoot.querySelector('.infinite-scroll-loader').style.display = 'none';
        }

        showEnd() {
            this.shadowRoot.querySelector('.infinite-scroll-end').style.display = 'block';
        }

        hideEnd() {
            this.shadowRoot.querySelector('.infinite-scroll-end').style.display = 'none';
        }

        showError() {
            this.shadowRoot.querySelector('.infinite-scroll-error').style.display = 'block';
        }

        hideError() {
            this.shadowRoot.querySelector('.infinite-scroll-error').style.display = 'none';
        }
    }

    // Register custom element
    customElements.define('infinite-scroll', InfiniteScroll);
</script>