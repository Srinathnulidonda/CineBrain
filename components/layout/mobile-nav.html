<!-- CineBrain Mobile Navigation Component -->
<nav class="mobile-nav" id="cinebrain-mobile-nav">
    <div class="nav-container">
        <div class="nav-item">
            <a href="/" class="nav-link" data-nav="home">
                <i class="bi bi-house-fill"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="nav-item">
            <a href="/content/search.html" class="nav-link" data-nav="search">
                <i class="bi bi-search"></i>
                <span>Search</span>
            </a>
        </div>
        <div class="nav-item">
            <a href="/user/watchlist.html" class="nav-link" data-nav="watchlist">
                <i class="bi bi-bookmark"></i>
                <span>Watchlist</span>
            </a>
        </div>
        <div class="nav-item">
            <a href="/user/favorites.html" class="nav-link" data-nav="favorites">
                <i class="bi bi-heart"></i>
                <span>Favorites</span>
            </a>
        </div>
        <div class="nav-item" id="mobile-nav-profile">
            <!-- Dynamic content based on auth state -->
            <a href="/auth/login.html" class="nav-link" data-nav="profile">
                <i class="bi bi-box-arrow-in-right"></i>
                <span>Login</span>
            </a>
        </div>
    </div>
</nav>

<script>
(function() {
    'use strict';
    
    const mobileNav = document.getElementById('cinebrain-mobile-nav');
    const profileItem = document.getElementById('mobile-nav-profile');
    
    // Initialize mobile navigation
    function initMobileNav() {
        updateProfileItem();
        setupActiveState();
        setupHapticFeedback();
        setupSwipeGestures();
    }
    
    // Update profile item based on authentication state
    function updateProfileItem() {
        const token = localStorage.getItem('cinebrain_token');
        const user = JSON.parse(localStorage.getItem('cinebrain_user') || 'null');
        
        if (token && user) {
            profileItem.innerHTML = `
                <a href="/${user.username}/profile" class="nav-link" data-nav="profile">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=6366f1&color=fff&size=24" 
                         alt="${user.username}" class="rounded-circle" width="24" height="24">
                    <span>Profile</span>
                </a>
            `;
        } else {
            profileItem.innerHTML = `
                <a href="/auth/login.html" class="nav-link" data-nav="profile">
                    <i class="bi bi-box-arrow-in-right"></i>
                    <span>Login</span>
                </a>
            `;
        }
    }
    
    // Setup active state management
    function setupActiveState() {
        const currentPath = window.location.pathname;
        const navLinks = mobileNav.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            link.classList.remove('active');
            
            const href = link.getAttribute('href');
            const navType = link.dataset.nav;
            
            // Determine active state based on current path
            if (
                (navType === 'home' && (currentPath === '/' || currentPath === '/index.html')) ||
                (navType === 'search' && currentPath.includes('/content/search')) ||
                (navType === 'watchlist' && currentPath.includes('/user/watchlist')) ||
                (navType === 'favorites' && currentPath.includes('/user/favorites')) ||
                (navType === 'profile' && (currentPath.includes('/user/') || currentPath.includes('/auth/')))
            ) {
                link.classList.add('active');
            }
        });
    }
    
    // Setup haptic feedback for mobile devices
    function setupHapticFeedback() {
        if ('vibrate' in navigator) {
            mobileNav.addEventListener('click', function(e) {
                const navLink = e.target.closest('.nav-link');
                if (navLink) {
                    navigator.vibrate(50); // Short haptic feedback
                }
            });
        }
    }
    
    // Setup swipe gestures for navigation
    function setupSwipeGestures() {
        let startX = 0;
        let startY = 0;
        let isScrolling = false;
        
        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].pageX;
            startY = e.touches[0].pageY;
            isScrolling = false;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            if (!startX || !startY) return;
            
            const currentX = e.touches[0].pageX;
            const currentY = e.touches[0].pageY;
            const diffX = Math.abs(currentX - startX);
            const diffY = Math.abs(currentY - startY);
            
            if (diffY > diffX) {
                isScrolling = true;
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            if (!startX || !startY || isScrolling) return;
            
            const endX = e.changedTouches[0].pageX;
            const diffX = startX - endX;
            const threshold = 100;
            
            if (Math.abs(diffX) > threshold) {
                handleSwipeNavigation(diffX > 0 ? 'left' : 'right');
            }
            
            startX = 0;
            startY = 0;
        }, { passive: true });
    }
    
    // Handle swipe navigation between tabs
    function handleSwipeNavigation(direction) {
        const navLinks = Array.from(mobileNav.querySelectorAll('.nav-link'));
        const activeLink = mobileNav.querySelector('.nav-link.active');
        const currentIndex = navLinks.indexOf(activeLink);
        
        if (currentIndex === -1) return;
        
        let nextIndex;
        if (direction === 'left' && currentIndex < navLinks.length - 1) {
            nextIndex = currentIndex + 1;
        } else if (direction === 'right' && currentIndex > 0) {
            nextIndex = currentIndex - 1;
        }
        
        if (nextIndex !== undefined) {
            const nextLink = navLinks[nextIndex];
            if (nextLink && nextLink.href !== '#') {
                window.location.href = nextLink.href;
            }
        }
    }
    
    // Handle pull-to-refresh
    function setupPullToRefresh() {
        let startY = 0;
        let isPulling = false;
        
        document.addEventListener('touchstart', function(e) {
            if (window.scrollY === 0) {
                startY = e.touches[0].pageY;
            }
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            if (window.scrollY === 0 && startY) {
                const currentY = e.touches[0].pageY;
                const pullDistance = currentY - startY;
                
                if (pullDistance > 80 && !isPulling) {
                    isPulling = true;
                    // Trigger refresh
                    if ('vibrate' in navigator) {
                        navigator.vibrate(100);
                    }
                    window.location.reload();
                }
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function() {
            startY = 0;
            isPulling = false;
        }, { passive: true });
    }
    
    // Update badge counts for watchlist and favorites
    async function updateBadgeCounts() {
        const token = localStorage.getItem('cinebrain_token');
        if (!token) return;
        
        try {
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            const [watchlistRes, favoritesRes] = await Promise.all([
                fetch('https://backend-app-970m.onrender.com/api/user/watchlist', { headers }),
                fetch('https://backend-app-970m.onrender.com/api/user/favorites', { headers })
            ]);
            
            if (watchlistRes.ok) {
                const watchlistData = await watchlistRes.json();
                updateNavBadge('watchlist', watchlistData.watchlist?.length || 0);
            }
            
            if (favoritesRes.ok) {
                const favoritesData = await favoritesRes.json();
                updateNavBadge('favorites', favoritesData.favorites?.length || 0);
            }
        } catch (error) {
            console.error('Error updating badge counts:', error);
        }
    }
    
    // Update navigation badge
    function updateNavBadge(navType, count) {
        const navLink = mobileNav.querySelector(`[data-nav="${navType}"]`);
        if (!navLink) return;
        
        // Remove existing badge
        const existingBadge = navLink.querySelector('.nav-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        // Add new badge if count > 0
        if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'nav-badge';
            badge.textContent = count > 99 ? '99+' : count.toString();
            navLink.appendChild(badge);
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileNav);
    } else {
        initMobileNav();
    }
    
    // Update on auth state changes
    window.addEventListener('storage', function(e) {
        if (e.key === 'cinebrain_token' || e.key === 'cinebrain_user') {
            updateProfileItem();
            updateBadgeCounts();
        }
    });
    
    // Update badge counts periodically
    setInterval(updateBadgeCounts, 30000); // Every 30 seconds
    
    // Initial badge count update
    setTimeout(updateBadgeCounts, 1000);
    
})();
</script>

<style>
.nav-badge {
    position: absolute;
    top: 0.25rem;
    right: 50%;
    transform: translateX(50%);
    background: var(--cinema-red);
    color: white;
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 0.75rem;
    min-width: 1.25rem;
    text-align: center;
    z-index: 10;
}

.nav-item {
    position: relative;
}

@media (min-width: 768px) {
    .mobile-nav {
        display: none !important;
    }
}
</style>