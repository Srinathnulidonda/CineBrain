<div class="topbar" id="global-topbar">
  <div class="topbar-content">
    <a href="/" class="brand-link">
      <div class="logo">CineBrain</div>
      <div class="tagline">The Mind Behind Your Next Favorite</div>
    </a>
    
    <div class="search-container">
      <div class="search-icon" id="search-toggle">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </div>
      <div class="search-bar" id="search-bar">
        <input type="text" id="search-input" placeholder="Search movies, shows, anime..." autocomplete="off">
        <div class="search-results" id="search-results"></div>
      </div>
    </div>
    
    <div class="user-section">
      <div class="user-avatar" id="user-avatar">
        <img src="https://ui-avatars.com/api/?name=Guest&background=3b82f6&color=fff" alt="User Avatar">
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const searchToggle = document.getElementById('search-toggle');
  const searchBar = document.getElementById('search-bar');
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const userAvatar = document.getElementById('user-avatar');
  
  // Update user avatar based on auth state
  function updateUserAvatar() {
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    if (token && user.username) {
      const avatarImg = userAvatar.querySelector('img');
      avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5cf6&color=fff`;
      userAvatar.innerHTML = `<a href="/${user.username}/profile">${avatarImg.outerHTML}</a>`;
    }
  }
  
  // Search functionality
  let searchDebounce;
  searchToggle.addEventListener('click', () => {
    searchBar.classList.toggle('active');
    if (searchBar.classList.contains('active')) {
      searchInput.focus();
    }
  });
  
  searchInput.addEventListener('input', (e) => {
    clearTimeout(searchDebounce);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
      searchResults.style.display = 'none';
      return;
    }
    
    searchDebounce = setTimeout(async () => {
      try {
        const response = await fetch(`https://backend-app-970m.onrender.com/api/search?query=${encodeURIComponent(query)}&type=multi&limit=5`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          searchResults.innerHTML = data.results.map(item => `
            <a href="/content/details.html?id=${item.id}" class="search-result-item">
              <img src="${item.poster_path || 'https://via.placeholder.com/50x75?text=No+Image'}" alt="${item.title}">
              <div class="result-info">
                <div class="result-title">${item.title}</div>
                <div class="result-meta">${item.content_type} • ${item.rating ? item.rating.toFixed(1) : 'N/A'} ⭐</div>
              </div>
            </a>
          `).join('');
          searchResults.style.display = 'block';
        } else {
          searchResults.innerHTML = '<div class="no-results">No results found</div>';
          searchResults.style.display = 'block';
        }
      } catch (error) {
        console.error('Search error:', error);
      }
    }, 300);
  });
  
  // Hide search results on outside click
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-container')) {
      searchResults.style.display = 'none';
      searchBar.classList.remove('active');
    }
  });
  
  // Initialize
  updateUserAvatar();
  window.addEventListener('auth-changed', updateUserAvatar);
})();
</script>