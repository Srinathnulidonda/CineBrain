<nav class="navbar fixed-top bg-[#0a0a0f] border-bottom border-[#60a5fa]/20 z-50 px-3 sm:px-4 md:px-5 lg:px-6"
    style="height: 64px;">
    <div class="container-fluid d-flex align-items-center justify-content-between">
        <!-- Brand -->
        <div class="d-flex align-items-center gap-3">
            <a class="navbar-brand d-flex flex-column align-items-start text-decoration-none" href="/">
                <div class="fw-bold text-[#60a5fa] fs-4 fs-md-3">CineBrain</div>
                <div class="text-[#a78bfa] text-xs d-none d-sm-block">The Mind Behind Your Next Favorite</div>
            </a>
        </div>

        <!-- Search (Desktop) -->
        <div class="d-none d-md-flex flex-grow-1 justify-content-center mx-4">
            <div id="topbar-search" class="w-100" style="max-width: 600px;"></div>
        </div>

        <!-- Actions -->
        <div class="d-flex align-items-center gap-2">
            <!-- Mobile Search Icon -->
            <button id="search-icon-mobile" class="d-md-none btn btn-ghost p-2 text-[#60a5fa]"
                onclick="toggleMobileSearch()" aria-label="Search">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </button>

            <!-- User Avatar/Login -->
            <div id="avatar-dropdown" class="dropdown"></div>
        </div>
    </div>

    <!-- Mobile Search Overlay -->
    <div id="mobile-search-overlay" class="position-fixed top-0 start-0 end-0 bg-[#0a0a0f] p-3 shadow-lg d-none"
        style="top: 64px; z-index: 1040;">
        <div id="mobile-search-bar"></div>
    </div>
</nav>

<script>
    // Initialize topbar components
    (async function () {
        // Load search bar
        const searchBarHtml = await fetch('/components/ui/search-bar.html').then(r => r.text());
        document.getElementById('topbar-search').innerHTML = searchBarHtml;
        document.getElementById('mobile-search-bar').innerHTML = searchBarHtml;

        // Check authentication
        const token = localStorage.getItem('cinebrain_token');
        const avatarDropdown = document.getElementById('avatar-dropdown');

        if (token) {
            // Load user info
            try {
                const response = await fetch('https://backend-app-970m.onrender.com/api/user/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const user = await response.json();
                    avatarDropdown.innerHTML = `
                        <button class="btn btn-ghost dropdown-toggle d-flex align-items-center gap-2" 
                                type="button" 
                                data-bs-toggle="dropdown" 
                                aria-expanded="false">
                            <div class="avatar rounded-circle bg-gradient-to-r from-[#60a5fa] to-[#a78bfa] d-flex align-items-center justify-content-center"
                                 style="width: 36px; height: 36px;">
                                <span class="text-white fw-bold">${user.username[0].toUpperCase()}</span>
                            </div>
                            <span class="d-none d-lg-inline text-[#e0e0ff]">${user.username}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end bg-[#1a1a2e] border-[#60a5fa]/20">
                            <li><a class="dropdown-item text-[#e0e0ff] hover:bg-[#60a5fa]/20" href="/user/watchlist.html">
                                <svg class="w-4 h-4 me-2 d-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Watchlist
                            </a></li>
                            <li><a class="dropdown-item text-[#e0e0ff] hover:bg-[#60a5fa]/20" href="/user/favorites.html">
                                <svg class="w-4 h-4 me-2 d-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                Favorites
                            </a></li>
                            <li><a class="dropdown-item text-[#e0e0ff] hover:bg-[#60a5fa]/20" href="/user/profile.html">
                                <svg class="w-4 h-4 me-2 d-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Profile
                            </a></li>
                            <li><hr class="dropdown-divider border-[#60a5fa]/20"></li>
                            <li><button class="dropdown-item text-danger" onclick="logout()">
                                <svg class="w-4 h-4 me-2 d-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Logout
                            </button></li>
                        </ul>
                    `;
                } else {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                localStorage.removeItem('cinebrain_token');
                showLoginButton();
            }
        } else {
            showLoginButton();
        }

        function showLoginButton() {
            avatarDropdown.innerHTML = `
                <button class="btn btn-outline-primary" onclick="window.location.href='/auth/login.html'">
                    Sign In
                </button>
            `;
        }
    })();

    // Mobile search toggle
    function toggleMobileSearch() {
        const overlay = document.getElementById('mobile-search-overlay');
        overlay.classList.toggle('d-none');

        if (!overlay.classList.contains('d-none')) {
            overlay.querySelector('input').focus();
        }
    }

    // Logout function
    function logout() {
        localStorage.removeItem('cinebrain_token');
        window.location.href = '/';
    }
</script>