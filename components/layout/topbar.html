<!-- CineBrain Fixed Topbar Component -->
<nav class="topbar" id="cinebrain-topbar">
    <div class="container">
        <div class="brand">
            <a href="/" class="logo">CineBrain</a>
            <div class="tagline">The Mind Behind Your Next Favorite</div>
        </div>
        
        <div class="search-container">
            <div class="position-relative">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="form-control search-input" id="global-search" 
                       placeholder="Search movies, shows, anime..." autocomplete="off">
                <div class="search-results dropdown-menu" id="search-results-dropdown"></div>
            </div>
        </div>
        
        <div class="auth-section" id="auth-section">
            <!-- Dynamic content populated by JavaScript -->
            <div class="auth-buttons">
                <a href="/auth/login.html" class="btn btn-outline-light me-2">Login</a>
                <a href="/auth/register.html" class="btn btn-primary">Sign Up</a>
            </div>
        </div>
        
        <button class="theme-toggle ml-3" id="theme-toggle" title="Toggle theme">
            <i class="bi bi-sun icon icon-sun"></i>
            <i class="bi bi-moon icon icon-moon"></i>
        </button>
    </div>
</nav>

<script>
(function() {
    'use strict';
    
    let searchTimeout;
    const searchInput = document.getElementById('global-search');
    const searchResults = document.getElementById('search-results-dropdown');
    const authSection = document.getElementById('auth-section');
    const themeToggle = document.getElementById('theme-toggle');
    
    // Initialize topbar
    async function initTopbar() {
        updateAuthSection();
        setupSearch();
        setupThemeToggle();
        setupScrollBehavior();
    }
    
    // Update authentication section based on user state
    function updateAuthSection() {
        const token = localStorage.getItem('cinebrain_token');
        const user = JSON.parse(localStorage.getItem('cinebrain_user') || 'null');
        
        if (token && user) {
            authSection.innerHTML = `
                <div class="user-menu dropdown">
                    <button class="btn btn-link dropdown-toggle d-flex align-items-center" 
                            type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=6366f1&color=fff&size=32" 
                             alt="${user.username}" class="user-avatar rounded-circle me-2" width="32" height="32">
                        <span class="username text-light">${user.username}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/${user.username}/profile">
                            <i class="bi bi-person me-2"></i>Profile
                        </a></li>
                        <li><a class="dropdown-item" href="/user/watchlist.html">
                            <i class="bi bi-bookmark me-2"></i>Watchlist
                        </a></li>
                        <li><a class="dropdown-item" href="/user/favorites.html">
                            <i class="bi bi-heart me-2"></i>Favorites
                        </a></li>
                        <li><a class="dropdown-item" href="/user/settings.html">
                            <i class="bi bi-gear me-2"></i>Settings
                        </a></li>
                        ${user.is_admin ? `
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/">
                            <i class="bi bi-shield-check me-2"></i>Admin Panel
                        </a></li>
                        ` : ''}
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item logout-btn" onclick="handleLogout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </button></li>
                    </ul>
                </div>
            `;
        } else {
            authSection.innerHTML = `
                <div class="auth-buttons">
                    <a href="/auth/login.html" class="btn btn-outline-light me-2">Login</a>
                    <a href="/auth/register.html" class="btn btn-primary">Sign Up</a>
                </div>
            `;
        }
    }
    
    // Setup real-time search functionality
    function setupSearch() {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => performSearch(query), 300);
            } else {
                hideSearchResults();
            }
        });
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                hideSearchResults();
            }
        });
        
        // Handle search result clicks
        searchResults.addEventListener('click', function(e) {
            const resultItem = e.target.closest('.search-result-item');
            if (resultItem) {
                const contentId = resultItem.dataset.contentId;
                if (contentId) {
                    window.location.href = `/content/details.html?id=${contentId}`;
                }
            }
        });
    }
    
    // Perform real-time search
    async function performSearch(query) {
        try {
            showSearchLoading();
            
            const response = await fetch(`https://backend-app-970m.onrender.com/api/search?query=${encodeURIComponent(query)}&limit=8`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error('Search failed');
            
            const data = await response.json();
            displaySearchResults(data.results || []);
            
        } catch (error) {
            console.error('Search error:', error);
            showSearchError();
        }
    }
    
    // Display search results
    function displaySearchResults(results) {
        if (results.length === 0) {
            searchResults.innerHTML = `
                <div class="search-no-results p-3 text-center">
                    <i class="bi bi-search text-muted mb-2" style="font-size: 2rem;"></i>
                    <p class="mb-0 text-muted">No results found</p>
                </div>
            `;
        } else {
            const html = results.map(item => `
                <div class="search-result-item" data-content-id="${item.id}">
                    <img src="${item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : '/images/placeholder-poster.jpg'}" 
                         alt="${item.title}" class="search-result-poster" loading="lazy">
                    <div class="search-result-info">
                        <h6 class="search-result-title">${item.title}</h6>
                        <p class="search-result-meta">
                            ${item.content_type.toUpperCase()} • 
                            ${item.rating ? `${item.rating}/10` : 'NR'}
                            ${item.release_date ? ` • ${new Date(item.release_date).getFullYear()}` : ''}
                        </p>
                    </div>
                </div>
            `).join('');
            
            searchResults.innerHTML = html;
        }
        
        searchResults.classList.add('show');
    }
    
    function showSearchLoading() {
        searchResults.innerHTML = `
            <div class="search-loading p-3 text-center">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <span>Searching...</span>
            </div>
        `;
        searchResults.classList.add('show');
    }
    
    function showSearchError() {
        searchResults.innerHTML = `
            <div class="search-error p-3 text-center text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Search failed. Please try again.
            </div>
        `;
        searchResults.classList.add('show');
    }
    
    function hideSearchResults() {
        searchResults.classList.remove('show');
        setTimeout(() => {
            if (!searchResults.classList.contains('show')) {
                searchResults.innerHTML = '';
            }
        }, 200);
    }
    
    // Setup theme toggle
    function setupThemeToggle() {
        themeToggle.addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('cinebrain_theme', newTheme);
            
            // Show toast notification
            if (window.App && window.App.showToast) {
                window.App.showToast(`Switched to ${newTheme} theme`, 'info');
            }
        });
    }
    
    // Setup scroll behavior for topbar
    function setupScrollBehavior() {
        let lastScrollTop = 0;
        const topbar = document.getElementById('cinebrain-topbar');
        
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > lastScrollTop && scrollTop > 100) {
                // Scrolling down
                topbar.classList.add('hidden');
            } else {
                // Scrolling up
                topbar.classList.remove('hidden');
            }
            
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }, { passive: true });
    }
    
    // Global logout function
    window.handleLogout = function() {
        localStorage.removeItem('cinebrain_token');
        localStorage.removeItem('cinebrain_user');
        
        // Clear any cached data
        if (window.api && window.api.clearCache) {
            window.api.clearCache();
        }
        
        // Redirect to home
        window.location.href = '/';
        
        // Show logout message
        if (window.App && window.App.showToast) {
            window.App.showToast('You have been logged out', 'info');
        }
    };
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTopbar);
    } else {
        initTopbar();
    }
    
    // Listen for auth state changes
    window.addEventListener('storage', function(e) {
        if (e.key === 'cinebrain_token' || e.key === 'cinebrain_user') {
            updateAuthSection();
        }
    });
    
})();
</script>