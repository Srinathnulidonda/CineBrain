<!-- CineBrain Fixed Topbar - Bootstrap 5 + Tailwind CSS -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-lg border-bottom border-primary" style="background: linear-gradient(135deg, var(--cinema-black) 0%, var(--theater-dark) 100%) !important; backdrop-filter: blur(10px);">
  <div class="container-fluid px-4">
    <!-- Logo & Tagline -->
    <div class="navbar-brand d-flex align-items-center me-4">
      <div class="logo fw-bold text-primary fs-3 me-2" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));">
        CineBrain
      </div>
      <div class="tagline text-muted ms-2 d-none d-md-block small fw-light">
        The Mind Behind Your Next Favorite
      </div>
    </div>

    <!-- Search Component -->
    <div class="flex-grow-1 mx-4 position-relative" style="max-width: 500px;">
      <div class="input-group">
        <span class="input-group-text bg-dark border-secondary text-primary">
          <i class="fas fa-search"></i>
        </span>
        <input 
          type="text" 
          id="globalSearch" 
          class="form-control bg-dark border-secondary text-white" 
          placeholder="Search movies, TV shows, anime..."
          style="border-radius: 0 25px 25px 0; transition: all 0.3s ease;"
        >
      </div>
      <!-- Autocomplete Results -->
      <div 
        id="searchResults" 
        class="position-absolute w-100 bg-dark border border-secondary rounded-bottom shadow-lg mt-1 d-none"
        style="top: 100%; z-index: 1050; max-height: 400px; overflow-y: auto;"
      ></div>
    </div>

    <!-- User Avatar & Menu -->
    <div class="d-flex align-items-center">
      <div id="userSection" class="d-none">
        <div class="dropdown">
          <button class="btn btn-link p-0 dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <img id="userAvatar" class="rounded-circle border border-primary" width="40" height="40" style="filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));">
          </button>
          <ul class="dropdown-menu dropdown-menu-end bg-dark border-secondary">
            <li><a class="dropdown-item text-white" href="#" onclick="navigateToProfile()">
              <i class="fas fa-user me-2 text-primary"></i>Profile
            </a></li>
            <li><a class="dropdown-item text-white" href="/user/watchlist.html">
              <i class="fas fa-bookmark me-2 text-primary"></i>Watchlist
            </a></li>
            <li><a class="dropdown-item text-white" href="/user/favorites.html">
              <i class="fas fa-heart me-2 text-primary"></i>Favorites
            </a></li>
            <li><hr class="dropdown-divider border-secondary"></li>
            <li><a class="dropdown-item text-white" href="#" onclick="logout()">
              <i class="fas fa-sign-out-alt me-2 text-danger"></i>Logout
            </a></li>
          </ul>
        </div>
      </div>
      
      <div id="authSection" class="d-flex gap-2">
        <a href="/auth/login.html" class="btn btn-outline-primary btn-sm px-3">Login</a>
        <a href="/auth/register.html" class="btn btn-primary btn-sm px-3">Sign Up</a>
      </div>
    </div>
  </div>
</nav>

<script>
// Topbar Component JavaScript
(function() {
  let searchTimeout;
  const searchInput = document.getElementById('globalSearch');
  const searchResults = document.getElementById('searchResults');
  const userSection = document.getElementById('userSection');
  const authSection = document.getElementById('authSection');
  const userAvatar = document.getElementById('userAvatar');

  // Initialize topbar
  async function initTopbar() {
    const token = localStorage.getItem('cinebrain_token');
    if (token) {
      try {
        const response = await fetch(`${API_ENDPOINTS.BASE_URL}/user/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const userData = await response.json();
          showUserSection(userData);
        } else {
          localStorage.removeItem('cinebrain_token');
          showAuthSection();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        showAuthSection();
      }
    } else {
      showAuthSection();
    }
  }

  function showUserSection(user) {
    userSection.classList.remove('d-none');
    authSection.classList.add('d-none');
    
    // Generate avatar URL
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=3b82f6&color=fff&size=40&bold=true`;
    userAvatar.src = avatarUrl;
    userAvatar.alt = user.username;
  }

  function showAuthSection() {
    userSection.classList.add('d-none');
    authSection.classList.remove('d-none');
  }

  // Global search functionality
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length >= 2) {
      searchTimeout = setTimeout(() => performSearch(query), 300);
    } else {
      hideSearchResults();
    }
  });

  async function performSearch(query) {
    try {
      const response = await fetch(`${API_ENDPOINTS.BASE_URL}${API_ENDPOINTS.SEARCH}?query=${encodeURIComponent(query)}&limit=8`);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        displaySearchResults(data.results);
      } else {
        showNoResults();
      }
    } catch (error) {
      console.error('Search failed:', error);
      hideSearchResults();
    }
  }

  function displaySearchResults(results) {
    const resultsHTML = results.map(item => `
      <div class="p-2 border-bottom border-secondary search-result-item" 
           style="cursor: pointer; transition: background-color 0.2s;"
           onclick="selectSearchResult(${item.id})"
           onmouseover="this.style.backgroundColor='rgba(59, 130, 246, 0.1)'"
           onmouseout="this.style.backgroundColor='transparent'">
        <div class="d-flex align-items-center">
          <img src="${item.poster_path || '/assets/no-poster.jpg'}" 
               class="rounded me-3" 
               width="40" height="60" 
               style="object-fit: cover;"
               onerror="this.src='/assets/no-poster.jpg'">
          <div class="flex-grow-1">
            <div class="text-white fw-semibold">${item.title}</div>
            <div class="text-muted small">
              ${item.content_type.toUpperCase()} • ${item.rating ? `⭐ ${item.rating}/10` : 'Not Rated'}
            </div>
            <div class="text-muted small">
              ${item.genres.slice(0, 2).join(', ')}
            </div>
          </div>
        </div>
      </div>
    `).join('');

    searchResults.innerHTML = resultsHTML;
    searchResults.classList.remove('d-none');
  }

  function showNoResults() {
    searchResults.innerHTML = '<div class="p-3 text-center text-muted">No results found</div>';
    searchResults.classList.remove('d-none');
  }

  function hideSearchResults() {
    searchResults.classList.add('d-none');
  }

  // Global functions
  window.selectSearchResult = function(contentId) {
    window.location.href = `/content/details.html?id=${contentId}`;
  };

  window.navigateToProfile = function() {
    const token = localStorage.getItem('cinebrain_token');
    if (token) {
      // Decode token to get username (simplified)
      const userData = JSON.parse(localStorage.getItem('cinebrain_user') || '{}');
      window.location.href = `/${userData.username || 'user'}/profile`;
    }
  };

  window.logout = function() {
    localStorage.removeItem('cinebrain_token');
    localStorage.removeItem('cinebrain_user');
    window.location.href = '/';
  };

  // Hide search results when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      hideSearchResults();
    }
  });

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTopbar);
  } else {
    initTopbar();
  }
})();
</script>