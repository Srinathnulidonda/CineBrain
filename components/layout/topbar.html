<!-- Fixed Navigation Bar (Bootstrap + Tailwind) -->
<nav class="navbar navbar-expand-lg fixed-top bg-theater backdrop-blur-md border-bottom border-theater safe-area-top"
    style="backdrop-filter: blur(20px);">
    <div class="container-fluid px-3 px-md-4 px-lg-6">

        <!-- Mobile Layout: Single Line -->
        <div class="d-flex align-items-center justify-content-between w-100">

            <!-- Brand Logo & Tagline (Always Stacked) -->
            <div class="navbar-brand d-flex flex-column align-items-start py-2 mb-0">
                <div class="brand-logo text-primary font-bold" style="font-size: 1.25rem; line-height: 1;">
                    CineBrain
                </div>
                <div class="brand-tagline text-muted font-italic" style="font-size: 0.625rem; line-height: 1.2;">
                    The Mind Behind Your Next Favorite
                </div>
            </div>

            <!-- Right Side: Search & Avatar -->
            <div class="d-flex align-items-center gap-2 gap-md-3">

                <!-- Search Component -->
                <div class="search-wrapper position-relative">
                    <!-- Mobile: Search Icon Toggle -->
                    <button class="btn btn-link text-white p-2 d-lg-none search-toggle-btn" type="button"
                        aria-label="Toggle search">
                        <i class="bi bi-search fs-5"></i>
                    </button>

                    <!-- Desktop: Always Visible Search Bar -->
                    <div class="search-container d-none d-lg-block position-relative" style="width: 400px;">
                        <div class="position-relative">
                            <input type="text"
                                class="search-input form-control bg-velvet border-royal text-white placeholder-gray-400 rounded-pill ps-4 pe-12"
                                placeholder="Search movies, shows, anime..." autocomplete="off">
                            <button
                                class="position-absolute top-50 end-0 translate-middle-y me-3 btn btn-link text-gray-400 p-0">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>

                        <!-- Search Results Dropdown -->
                        <div class="search-results position-absolute w-100 mt-2 bg-theater border border-royal rounded-3 shadow-2xl d-none custom-scroll"
                            style="max-height: 400px; overflow-y: auto; z-index: 1050;">
                            <!-- Dynamic search results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- User Avatar & Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-link text-white p-0 user-dropdown-toggle d-flex align-items-center"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="user-avatar bg-primary rounded-circle d-flex align-items-center justify-content-center text-white font-semibold"
                            style="width: 36px; height: 36px; font-size: 0.875rem;">
                            <span class="username-initial">G</span>
                        </div>
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end bg-theater border-royal shadow-xl rounded-3 mt-2"
                        style="min-width: 200px;">
                        <!-- Guest Menu -->
                        <div class="guest-only">
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                    href="/auth/login.html">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Login
                                </a></li>
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                    href="/auth/register.html">
                                    <i class="bi bi-person-plus me-2"></i>Sign Up
                                </a></li>
                        </div>

                        <!-- Authenticated User Menu -->
                        <div class="auth-required d-none">
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                    href="/user/activity.html">
                                    <i class="bi bi-clock-history me-2"></i>Activity
                                </a></li>
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                    href="/user/favorites.html">
                                    <i class="bi bi-heart me-2"></i>Favorites
                                </a></li>
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2 profile-link"
                                    href="#">
                                    <i class="bi bi-person me-2"></i>Profile
                                </a></li>
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                    href="/user/settings.html">
                                    <i class="bi bi-gear me-2"></i>Settings
                                </a></li>
                            <li><a class="dropdown-item text-white hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                    href="/user/watchlist.html">
                                    <i class="bi bi-bookmark me-2"></i>Watchlist
                                </a></li>

                            <!-- Admin Links -->
                            <div class="admin-only d-none">
                                <li>
                                    <hr class="dropdown-divider border-royal">
                                </li>
                                <li><a class="dropdown-item text-vip hover:bg-velvet rounded-2 mx-2 my-1 px-3 py-2"
                                        href="/admin/index.html">
                                        <i class="bi bi-shield-check me-2"></i>Admin Panel
                                    </a></li>
                            </div>

                            <li>
                                <hr class="dropdown-divider border-royal">
                            </li>
                            <li><a class="dropdown-item text-red-400 hover:bg-red-900 hover:bg-opacity-20 rounded-2 mx-2 my-1 px-3 py-2 logout-btn"
                                    href="#">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                        </div>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Mobile Expanded Search Overlay -->
        <div class="mobile-search-overlay position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-90 d-none"
            style="z-index: 1060;">
            <div class="container-fluid p-3">
                <div class="d-flex align-items-center gap-3 bg-theater rounded-3 p-3">
                    <!-- Back Button -->
                    <button class="btn btn-link text-white p-0 search-close-btn">
                        <i class="bi bi-arrow-left fs-5"></i>
                    </button>

                    <!-- Search Input -->
                    <div class="flex-grow-1 position-relative">
                        <input type="text"
                            class="search-input-mobile form-control bg-velvet border-royal text-white placeholder-gray-400 rounded-pill ps-4 pe-12"
                            placeholder="Search movies, shows, anime..." autocomplete="off" autofocus>
                        <button
                            class="position-absolute top-50 end-0 translate-middle-y me-3 btn btn-link text-gray-400 p-0">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Mobile Search Results -->
                <div class="search-results-mobile mt-3 bg-theater rounded-3 custom-scroll d-none"
                    style="max-height: calc(100vh - 120px); overflow-y: auto;">
                    <!-- Dynamic search results will be populated here -->
                </div>
            </div>
        </div>
    </div>
</nav>

<style>
    /* Navbar Responsive Styling */
    .navbar {
        min-height: 60px;
        transition: all 0.3s ease;
    }

    /* Brand Responsive Typography */
    @media (min-width: 576px) {
        .navbar-brand .brand-logo {
            font-size: 1.375rem !important;
        }

        .navbar-brand .brand-tagline {
            font-size: 0.75rem !important;
            /* text-xs → text-sm */
        }
    }

    @media (min-width: 768px) {
        .navbar-brand .brand-logo {
            font-size: 1.5rem !important;
        }

        .navbar-brand .brand-tagline {
            font-size: 0.875rem !important;
            /* text-sm */
        }
    }

    @media (min-width: 992px) {
        .navbar-brand .brand-logo {
            font-size: 1.75rem !important;
        }

        .navbar-brand .brand-tagline {
            font-size: 1rem !important;
            /* text-base */
        }
    }

    /* Touch Target Optimization */
    .search-toggle-btn,
    .user-dropdown-toggle {
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Search Overlay Animation */
    .mobile-search-overlay {
        backdrop-filter: blur(10px);
        transition: opacity 0.3s ease;
    }

    .mobile-search-overlay.show {
        display: block !important;
        animation: fadeIn 0.3s ease;
    }

    /* Dropdown Enhancements */
    .dropdown-item {
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: rgba(30, 30, 35, 0.8) !important;
        transform: translateX(2px);
    }

    /* Avatar Hover Effect */
    .user-avatar {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .user-dropdown-toggle:hover .user-avatar {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }

    /* Search Input Mobile Optimizations */
    @media (max-width: 991.98px) {
        .search-input-mobile {
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }
    }

    /* Animation Keyframes */
    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mobile search toggle functionality
        const searchToggleBtn = document.querySelector('.search-toggle-btn');
        const searchCloseBtn = document.querySelector('.search-close-btn');
        const mobileSearchOverlay = document.querySelector('.mobile-search-overlay');
        const searchInputMobile = document.querySelector('.search-input-mobile');

        if (searchToggleBtn && mobileSearchOverlay) {
            // Open mobile search
            searchToggleBtn.addEventListener('click', function () {
                mobileSearchOverlay.classList.add('show');
                document.body.style.overflow = 'hidden';

                // Focus on search input
                setTimeout(() => {
                    searchInputMobile?.focus();
                }, 100);
            });

            // Close mobile search
            searchCloseBtn?.addEventListener('click', function () {
                mobileSearchOverlay.classList.remove('show');
                document.body.style.overflow = '';
            });

            // Close on escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && mobileSearchOverlay.classList.contains('show')) {
                    mobileSearchOverlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        }

        // Profile link update based on authentication
        function updateProfileLink() {
            const profileLink = document.querySelector('.profile-link');
            if (profileLink && auth.isAuthenticated()) {
                const user = auth.getCurrentUser();
                profileLink.href = `/${user.username}/profile`;
            }
        }

        // Username initial update
        function updateUsernameInitial() {
            const usernameInitial = document.querySelector('.username-initial');
            if (usernameInitial) {
                if (auth.isAuthenticated()) {
                    const user = auth.getCurrentUser();
                    usernameInitial.textContent = user.username.charAt(0).toUpperCase();
                } else {
                    usernameInitial.textContent = 'G'; // Guest
                }
            }
        }

        // Logout functionality
        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();
                auth.logout();
            });
        }

        // Search functionality for both desktop and mobile
        const searchInputs = document.querySelectorAll('.search-input, .search-input-mobile');
        const searchResults = document.querySelectorAll('.search-results, .search-results-mobile');

        searchInputs.forEach((input, index) => {
            const resultsContainer = searchResults[index];

            const debouncedSearch = UTILS.debounce(async (query) => {
                if (query.length < 2) {
                    resultsContainer.classList.add('d-none');
                    return;
                }

                try {
                    // Show loading state
                    resultsContainer.innerHTML = `
          <div class="p-4 text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Searching...</span>
            </div>
          </div>
        `;
                    resultsContainer.classList.remove('d-none');

                    // Perform search
                    const response = await api.search(query);
                    const results = response.results || [];

                    if (results.length === 0) {
                        resultsContainer.innerHTML = '<div class="p-4 text-center text-muted">No results found</div>';
                    } else {
                        const resultsHTML = results.slice(0, 8).map(item => `
            <a href="/content/details.html?id=${item.id}" class="search-result-item d-flex align-items-center p-3 text-decoration-none text-white hover:bg-velvet border-bottom border-gray-700">
              <img src="${item.poster_path || IMAGE_CONFIG.PLACEHOLDER}" 
                   alt="${item.title}" 
                   class="rounded me-3" 
                   style="width: 48px; height: 72px; object-fit: cover;"
                   loading="lazy">
              <div class="flex-grow-1">
                <h6 class="mb-1 text-white">${item.title}</h6>
                <p class="mb-1 text-sm text-gray-400">${item.content_type.toUpperCase()}</p>
                <div class="text-xs text-yellow-500">
                  ${item.rating ? `⭐ ${UTILS.formatRating(item.rating)}` : 'No rating'}
                </div>
              </div>
            </a>
          `).join('');

                        resultsContainer.innerHTML = resultsHTML;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    resultsContainer.innerHTML = '<div class="p-4 text-center text-danger">Search failed. Please try again.</div>';
                }
            }, 300);

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                debouncedSearch(query);
            });

            // Enter key to navigate to search page
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    e.preventDefault();
                    window.location.href = `/content/search.html?q=${encodeURIComponent(e.target.value.trim())}`;
                }
            });

            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.closest('.search-container, .search-wrapper, .mobile-search-overlay').contains(e.target)) {
                    resultsContainer.classList.add('d-none');
                }
            });
        });

        // Initialize on load
        updateProfileLink();
        updateUsernameInitial();

        // Listen for auth state changes
        window.addEventListener('auth-state-change', function (event) {
            updateProfileLink();
            updateUsernameInitial();
        });
    });
</script>