<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineBrain - Content Cards</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cinebrain: {
                            red: '#E50914',
                            blue: '#0073E6',
                            purple: '#8B5CF6',
                            dark: '#0F0F0F',
                            darker: '#000000',
                            gold: '#FFD700',
                            green: '#46d369'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s infinite'
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom CSS for Content Cards */
        .content-card {
            @apply relative group cursor-pointer transition-all duration-300 ease-out;
        }

        .content-card:hover {
            @apply transform scale-105 z-10;
        }

        .content-card:active {
            @apply transform scale-100;
        }

        /* Mobile tap effect */
        @media (max-width: 768px) {
            .content-card:active {
                @apply transform scale-95;
            }

            .content-card::after {
                content: '';
                @apply absolute inset-0 bg-white dark:bg-gray-300 opacity-0 rounded-lg pointer-events-none;
            }

            .content-card:active::after {
                animation: ripple 0.6s ease-out;
            }
        }

        @keyframes ripple {
            0% {
                @apply opacity-20;
                transform: scale(0);
            }

            100% {
                @apply opacity-0;
                transform: scale(1);
            }
        }

        /* Poster aspect ratio container */
        .poster-container {
            @apply relative overflow-hidden bg-gray-200 dark:bg-gray-800 rounded-lg;
            aspect-ratio: 2/3;
        }

        /* Loading skeleton animation */
        .skeleton {
            @apply bg-gray-300 dark:bg-gray-700 relative overflow-hidden;
        }

        .skeleton::after {
            content: '';
            @apply absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent;
            animation: shimmer 2s infinite;
        }

        /* Genre chip styles */
        .genre-chip {
            @apply px-2 py-0.5 text-xs rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300;
        }

        /* Rating badge gradient */
        .rating-badge {
            background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
        }

        /* Bookmark button animation */
        .bookmark-btn {
            @apply transition-all duration-300 ease-out;
        }

        .bookmark-btn:hover {
            @apply transform scale-110;
        }

        .bookmark-btn.active {
            @apply text-cinebrain-gold;
            animation: bookmark-pulse 0.5s ease-out;
        }

        @keyframes bookmark-pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1.1);
            }
        }

        /* Line clamp for title */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Responsive grid */
        .content-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(2, 1fr);
            /* Mobile: 2 cards */
        }

        @media (min-width: 640px) {
            .content-grid {
                grid-template-columns: repeat(3, 1fr);
                /* Tablet: 3 cards */
            }
        }

        @media (min-width: 768px) {
            .content-grid {
                grid-template-columns: repeat(4, 1fr);
                /* Tablet: 4 cards */
            }
        }

        @media (min-width: 1024px) {
            .content-grid {
                grid-template-columns: repeat(5, 1fr);
                /* Desktop: 5 cards */
            }
        }

        @media (min-width: 1280px) {
            .content-grid {
                grid-template-columns: repeat(6, 1fr);
                /* Large Desktop: 6 cards */
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-cinebrain-darker text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Theme Toggle Button -->
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleTheme()"
            class="p-3 rounded-full bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-all duration-300">
            <svg class="w-6 h-6 text-yellow-500 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path class="dark:hidden" fill-rule="evenodd"
                    d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z">
                </path>
                <path class="hidden dark:block" d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z">
                </path>
            </svg>
        </button>
    </div>

    <div class="container mx-auto px-4 py-8">
        <h1
            class="text-3xl font-bold mb-8 text-center bg-gradient-to-r from-cinebrain-red to-cinebrain-purple bg-clip-text text-transparent">
            CineBrain Content Library
        </h1>

        <!-- Filter Controls -->
        <div class="mb-6 flex flex-wrap gap-4 justify-center">
            <select id="contentType" onchange="loadContent()"
                class="px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                <option value="all">All Content</option>
                <option value="movie">Movies</option>
                <option value="tv">TV Shows</option>
                <option value="anime">Anime</option>
            </select>

            <select id="sortBy" onchange="loadContent()"
                class="px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                <option value="trending">Trending</option>
                <option value="new">New Releases</option>
                <option value="critics">Critics Choice</option>
                <option value="popular">Popular</option>
            </select>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="content-grid hidden">
            <!-- Skeleton cards will be generated here -->
        </div>

        <!-- Content Grid -->
        <div id="contentGrid" class="content-grid">
            <!-- Content cards will be dynamically loaded here -->
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-gray-600 dark:text-gray-400">Failed to load content. Please try again.</p>
            <button onclick="loadContent()"
                class="mt-4 px-6 py-2 bg-cinebrain-red text-white rounded-lg hover:bg-opacity-90 transition-colors">
                Retry
            </button>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        let currentUser = null;
        let watchlist = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            checkAuthentication();
            loadContent();
        });

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('cinebrain-theme') || 'dark';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('cinebrain-theme', isDark ? 'dark' : 'light');
        }

        // Authentication Check
        function checkAuthentication() {
            const token = localStorage.getItem('cinebrain-token');
            const userStr = localStorage.getItem('cinebrain-user');

            if (token && userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    loadWatchlist();
                } catch (e) {
                    console.error('Failed to parse user data:', e);
                }
            }
        }

        // Load user's watchlist
        async function loadWatchlist() {
            if (!currentUser) return;

            const token = localStorage.getItem('cinebrain-token');
            try {
                const response = await fetch(`${API_BASE}/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    watchlist = data.watchlist.map(item => item.id);
                }
            } catch (error) {
                console.error('Failed to load watchlist:', error);
            }
        }

        // Create skeleton loading card
        function createSkeletonCard() {
            return `
                <div class="content-card">
                    <div class="poster-container skeleton"></div>
                    <div class="mt-3 space-y-2">
                        <div class="skeleton h-4 rounded"></div>
                        <div class="skeleton h-3 w-2/3 rounded"></div>
                        <div class="flex gap-1">
                            <div class="skeleton h-5 w-12 rounded-full"></div>
                            <div class="skeleton h-5 w-12 rounded-full"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show loading state
        function showLoading() {
            const loadingState = document.getElementById('loadingState');
            const contentGrid = document.getElementById('contentGrid');
            const errorState = document.getElementById('errorState');

            loadingState.innerHTML = Array(12).fill(0).map(() => createSkeletonCard()).join('');
            loadingState.classList.remove('hidden');
            contentGrid.classList.add('hidden');
            errorState.classList.add('hidden');
        }

        // Show error state
        function showError() {
            const loadingState = document.getElementById('loadingState');
            const contentGrid = document.getElementById('contentGrid');
            const errorState = document.getElementById('errorState');

            loadingState.classList.add('hidden');
            contentGrid.classList.add('hidden');
            errorState.classList.remove('hidden');
        }

        // Load content from API
        async function loadContent() {
            showLoading();

            const contentType = document.getElementById('contentType').value;
            const sortBy = document.getElementById('sortBy').value;

            try {
                let endpoint = '';
                const params = new URLSearchParams();

                // Determine endpoint based on sort option
                switch (sortBy) {
                    case 'trending':
                        endpoint = '/recommendations/trending';
                        if (contentType !== 'all') params.append('type', contentType);
                        break;
                    case 'new':
                        endpoint = '/recommendations/new-releases';
                        if (contentType !== 'all') params.append('type', contentType);
                        break;
                    case 'critics':
                        endpoint = '/recommendations/critics-choice';
                        if (contentType !== 'all') params.append('type', contentType);
                        break;
                    case 'popular':
                        if (contentType === 'anime') {
                            endpoint = '/recommendations/anime';
                        } else {
                            endpoint = '/recommendations/trending';
                            if (contentType !== 'all') params.append('type', contentType);
                        }
                        break;
                }

                params.append('limit', '24');

                const response = await fetch(`${API_BASE}${endpoint}?${params.toString()}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch content');
                }

                const data = await response.json();
                displayContent(data.recommendations || []);

            } catch (error) {
                console.error('Error loading content:', error);
                showError();
            }
        }

        // Create content card HTML
        function createContentCard(item) {
            const isInWatchlist = watchlist.includes(item.id);
            const posterUrl = item.poster_path || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+';
            const rating = item.rating ? item.rating.toFixed(1) : 'N/A';
            const year = item.release_date ? new Date(item.release_date).getFullYear() : '';
            const genres = item.genres || [];

            // Determine rating color
            let ratingColorClass = 'from-gray-500 to-gray-600';
            if (item.rating >= 8) {
                ratingColorClass = 'from-cinebrain-gold to-yellow-600';
            } else if (item.rating >= 7) {
                ratingColorClass = 'from-cinebrain-green to-green-600';
            } else if (item.rating >= 5) {
                ratingColorClass = 'from-yellow-500 to-orange-500';
            } else if (item.rating > 0) {
                ratingColorClass = 'from-red-500 to-red-600';
            }

            return `
                <div class="content-card bg-white dark:bg-gray-900 rounded-lg shadow-lg hover:shadow-2xl dark:hover:shadow-cinebrain-purple/20 overflow-hidden"
                     data-id="${item.id}">
                    <div class="poster-container relative">
                        <!-- Lazy-loaded poster image -->
                        <img src="${posterUrl}" 
                             alt="${item.title}"
                             loading="lazy"
                             class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'">
                        
                        <!-- Rating Badge -->
                        <div class="absolute top-2 right-2 px-2 py-1 rounded-lg rating-badge ${ratingColorClass} text-white text-xs font-bold shadow-lg">
                            ⭐ ${rating}
                        </div>
                        
                        <!-- Bookmark Button (for authenticated users) -->
                        ${currentUser ? `
                            <button onclick="toggleWatchlist(event, ${item.id})" 
                                    class="bookmark-btn absolute top-2 left-2 p-2 rounded-full bg-black/50 backdrop-blur-sm text-white hover:bg-black/70 ${isInWatchlist ? 'active' : ''}">
                                <svg class="w-5 h-5" fill="${isInWatchlist ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                </svg>
                            </button>
                        ` : ''}
                        
                        <!-- Content Type Badge -->
                        <div class="absolute bottom-2 left-2 px-2 py-1 rounded bg-black/70 backdrop-blur-sm text-white text-xs font-medium">
                            ${item.content_type.toUpperCase()}
                        </div>
                    </div>
                    
                    <!-- Content Details -->
                    <div class="p-3">
                        <h3 class="font-semibold text-sm line-clamp-2 mb-1 group-hover:text-cinebrain-purple dark:group-hover:text-cinebrain-blue transition-colors">
                            ${item.title}
                        </h3>
                        
                        ${year ? `
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">${year}</p>
                        ` : ''}
                        
                        <!-- Genre Chips -->
                        <div class="flex flex-wrap gap-1">
                            ${genres.slice(0, 2).map(genre => `
                                <span class="genre-chip">${genre}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Display content cards
        function displayContent(items) {
            const contentGrid = document.getElementById('contentGrid');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');

            if (items.length === 0) {
                contentGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-600 dark:text-gray-400">No content found</p>
                    </div>
                `;
            } else {
                contentGrid.innerHTML = items.map(item => createContentCard(item)).join('');

                // Add click handlers to cards
                contentGrid.querySelectorAll('.content-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Don't navigate if clicking bookmark button
                        if (!e.target.closest('.bookmark-btn')) {
                            const contentId = card.dataset.id;
                            window.location.href = `/content/details.html?id=${contentId}`;
                        }
                    });
                });
            }

            loadingState.classList.add('hidden');
            contentGrid.classList.remove('hidden');
            errorState.classList.add('hidden');
        }

        // Toggle watchlist
        async function toggleWatchlist(event, contentId) {
            event.stopPropagation();

            if (!currentUser) {
                window.location.href = '/auth/login.html';
                return;
            }

            const button = event.currentTarget;
            const token = localStorage.getItem('cinebrain-token');

            try {
                const isInWatchlist = watchlist.includes(contentId);
                const method = 'POST';
                const interaction_type = isInWatchlist ? 'remove_watchlist' : 'watchlist';

                const response = await fetch(`${API_BASE}/interactions`, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: interaction_type
                    })
                });

                if (response.ok) {
                    if (isInWatchlist) {
                        watchlist = watchlist.filter(id => id !== contentId);
                        button.classList.remove('active');
                        button.querySelector('svg').setAttribute('fill', 'none');
                    } else {
                        watchlist.push(contentId);
                        button.classList.add('active');
                        button.querySelector('svg').setAttribute('fill', 'currentColor');
                    }

                    // Add animation feedback
                    button.style.animation = 'bookmark-pulse 0.5s ease-out';
                    setTimeout(() => {
                        button.style.animation = '';
                    }, 500);
                }
            } catch (error) {
                console.error('Failed to update watchlist:', error);
            }
        }
    </script>
</body>

</html>