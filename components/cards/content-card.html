<!-- CineBrain Standard Content Card Component -->
<div class="content-card" data-content-id="" data-content-type="">
    <div class="card-poster">
        <img src="" alt="" class="card-image" loading="lazy">
        <div class="card-overlay">
            <button class="btn btn-play" data-action="play-trailer" title="Play Trailer">
                <i class="bi bi-play-fill"></i>
            </button>
        </div>
        <div class="card-badges">
            <!-- Quality badges will be inserted here -->
        </div>
    </div>
    <div class="card-content">
        <h6 class="card-title"></h6>
        <div class="card-meta">
            <span class="card-rating"></span>
            <span class="card-type"></span>
            <span class="card-year"></span>
        </div>
        <div class="card-genres"></div>
        <div class="card-actions">
            <button class="btn btn-sm btn-outline-light" data-action="add-watchlist" title="Add to Watchlist">
                <i class="bi bi-bookmark"></i>
            </button>
            <button class="btn btn-sm btn-outline-light" data-action="add-favorite" title="Add to Favorites">
                <i class="bi bi-heart"></i>
            </button>
            <button class="btn btn-sm btn-outline-light" data-action="view-content" title="More Info">
                <i class="bi bi-info-circle"></i>
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Content Card Class
    class ContentCard {
        constructor(element, data) {
            this.element = element;
            this.data = data;
            this.init();
        }
        
        init() {
            this.render();
            this.setupEventListeners();
            this.checkUserInteractions();
        }
        
        render() {
            if (!this.data) return;
            
            const {
                id,
                title,
                content_type,
                poster_path,
                backdrop_path,
                rating,
                release_date,
                genres,
                youtube_trailer,
                is_new_release,
                is_critics_choice,
                is_trending
            } = this.data;
            
            // Set data attributes
            this.element.setAttribute('data-content-id', id);
            this.element.setAttribute('data-content-type', content_type);
            
            // Update poster image
            const cardImage = this.element.querySelector('.card-image');
            if (poster_path) {
                const posterUrl = poster_path.startsWith('http') 
                    ? poster_path 
                    : `https://image.tmdb.org/t/p/w500${poster_path}`;
                cardImage.src = posterUrl;
                cardImage.alt = title;
            } else {
                cardImage.src = '/images/placeholder-poster.jpg';
                cardImage.alt = 'No poster available';
            }
            
            // Update title
            const cardTitle = this.element.querySelector('.card-title');
            cardTitle.textContent = title;
            cardTitle.title = title;
            
            // Update rating
            const cardRating = this.element.querySelector('.card-rating');
            if (rating) {
                cardRating.innerHTML = `<i class="bi bi-star-fill text-warning me-1"></i>${Number(rating).toFixed(1)}`;
            } else {
                cardRating.textContent = 'NR';
            }
            
            // Update type
            const cardType = this.element.querySelector('.card-type');
            cardType.textContent = content_type.toUpperCase();
            cardType.className = `card-type type-badge ${content_type}`;
            
            // Update year
            const cardYear = this.element.querySelector('.card-year');
            if (release_date) {
                cardYear.textContent = new Date(release_date).getFullYear();
            } else {
                cardYear.textContent = 'TBA';
            }
            
            // Update genres
            const cardGenres = this.element.querySelector('.card-genres');
            if (genres && genres.length > 0) {
                const genreChips = genres.slice(0, 2).map(genre => 
                    `<span class="genre-chip">${genre}</span>`
                ).join('');
                cardGenres.innerHTML = genreChips;
            }
            
            // Update badges
            this.updateBadges();
            
            // Update action buttons with content ID
            this.element.querySelectorAll('[data-action]').forEach(btn => {
                btn.setAttribute('data-content-id', id);
            });
        }
        
        updateBadges() {
            const badgesContainer = this.element.querySelector('.card-badges');
            const badges = [];
            
            if (this.data.is_new_release) {
                badges.push('<span class="quality-badge new">NEW</span>');
            }
            
            if (this.data.is_trending) {
                badges.push('<span class="quality-badge trending">TRENDING</span>');
            }
            
            if (this.data.is_critics_choice) {
                badges.push('<span class="quality-badge critics">CRITICS\' CHOICE</span>');
            }
            
            // Add quality badges based on content metadata
            if (this.data.video_quality) {
                if (this.data.video_quality.includes('4K')) {
                    badges.push('<span class="quality-4k">4K</span>');
                } else if (this.data.video_quality.includes('HD')) {
                    badges.push('<span class="quality-hd">HD</span>');
                }
            }
            
            if (this.data.has_hdr) {
                badges.push('<span class="quality-hdr">HDR</span>');
            }
            
            badgesContainer.innerHTML = badges.join('');
        }
        
        setupEventListeners() {
            // Card click for main content view
            this.element.addEventListener('click', (e) => {
                if (!e.target.closest('[data-action]')) {
                    this.viewContent();
                }
            });
            
            // Hover effects for desktop
            if (!this.isMobileDevice()) {
                this.element.addEventListener('mouseenter', this.handleMouseEnter.bind(this));
                this.element.addEventListener('mouseleave', this.handleMouseLeave.bind(this));
            }
            
            // Touch effects for mobile
            this.element.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
            this.element.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
        }
        
        handleMouseEnter() {
            // Preload backdrop image for smooth hover effect
            if (this.data.backdrop_path && !this.backdropPreloaded) {
                const backdropUrl = this.data.backdrop_path.startsWith('http')
                    ? this.data.backdrop_path
                    : `https://image.tmdb.org/t/p/w780${this.data.backdrop_path}`;
                
                const img = new Image();
                img.src = backdropUrl;
                this.backdropPreloaded = true;
            }
        }
        
        handleMouseLeave() {
            // Reset any hover states
        }
        
        handleTouchStart() {
            this.element.classList.add('touch-active');
        }
        
        handleTouchEnd() {
            setTimeout(() => {
                this.element.classList.remove('touch-active');
            }, 150);
        }
        
        async checkUserInteractions() {
            const token = localStorage.getItem('cinebrain_token');
            if (!token) return;
            
            try {
                // Check if item is in watchlist or favorites
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                const [watchlistRes, favoritesRes] = await Promise.all([
                    fetch('https://backend-app-970m.onrender.com/api/user/watchlist', { headers }),
                    fetch('https://backend-app-970m.onrender.com/api/user/favorites', { headers })
                ]);
                
                if (watchlistRes.ok) {
                    const watchlistData = await watchlistRes.json();
                    const isInWatchlist = watchlistData.watchlist?.some(item => item.id === this.data.id);
                    this.updateActionButton('add-watchlist', isInWatchlist);
                }
                
                if (favoritesRes.ok) {
                    const favoritesData = await favoritesRes.json();
                    const isInFavorites = favoritesData.favorites?.some(item => item.id === this.data.id);
                    this.updateActionButton('add-favorite', isInFavorites);
                }
            } catch (error) {
                console.error('Error checking user interactions:', error);
            }
        }
        
        updateActionButton(action, isActive) {
            const button = this.element.querySelector(`[data-action="${action}"]`);
            if (!button) return;
            
            if (isActive) {
                button.classList.add('active');
                if (action === 'add-watchlist') {
                    button.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
                    button.title = 'Remove from Watchlist';
                } else if (action === 'add-favorite') {
                    button.innerHTML = '<i class="bi bi-heart-fill"></i>';
                    button.title = 'Remove from Favorites';
                }
            } else {
                button.classList.remove('active');
                if (action === 'add-watchlist') {
                    button.innerHTML = '<i class="bi bi-bookmark"></i>';
                    button.title = 'Add to Watchlist';
                } else if (action === 'add-favorite') {
                    button.innerHTML = '<i class="bi bi-heart"></i>';
                    button.title = 'Add to Favorites';
                }
            }
        }
        
        viewContent() {
            // Record view interaction
            this.recordInteraction('view');
            
            // Navigate to details page
            window.location.href = `/content/details.html?id=${this.data.id}`;
        }
        
        async recordInteraction(type, rating = null) {
            const token = localStorage.getItem('cinebrain_token');
            if (!token) return;
            
            try {
                const response = await fetch('https://backend-app-970m.onrender.com/api/interactions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: this.data.id,
                        interaction_type: type,
                        rating: rating
                    })
                });
                
                if (!response.ok) {
                    console.warn('Failed to record interaction:', response.statusText);
                }
            } catch (error) {
                console.error('Error recording interaction:', error);
            }
        }
        
        isMobileDevice() {
            return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
    }
    
    // Auto-initialize content cards
    function initContentCards() {
        document.querySelectorAll('.content-card:not([data-initialized])').forEach(cardElement => {
            cardElement.setAttribute('data-initialized', 'true');
            
            // If card has data attribute, use it
            const contentData = cardElement.dataset.contentData;
            if (contentData) {
                try {
                    const data = JSON.parse(contentData);
                    new ContentCard(cardElement, data);
                } catch (error) {
                    console.error('Error parsing content data:', error);
                }
            }
        });
    }
    
    // Global function to create content card with data
    window.createContentCard = function(data, container) {
        const cardHTML = `
            <div class="content-card" data-content-id="${data.id}" data-content-type="${data.content_type}">
                <div class="card-poster">
                    <img src="" alt="" class="card-image" loading="lazy">
                    <div class="card-overlay">
                        <button class="btn btn-play" data-action="play-trailer" title="Play Trailer">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    </div>
                    <div class="card-badges"></div>
                </div>
                <div class="card-content">
                    <h6 class="card-title"></h6>
                    <div class="card-meta">
                        <span class="card-rating"></span>
                        <span class="card-type"></span>
                        <span class="card-year"></span>
                    </div>
                    <div class="card-genres"></div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-light" data-action="add-watchlist" title="Add to Watchlist">
                            <i class="bi bi-bookmark"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light" data-action="add-favorite" title="Add to Favorites">
                            <i class="bi bi-heart"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light" data-action="view-content" title="More Info">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        if (container) {
            container.insertAdjacentHTML('beforeend', cardHTML);
            const newCard = container.lastElementChild;
            new ContentCard(newCard, data);
            return newCard;
        } else {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHTML;
            const cardElement = tempDiv.firstElementChild;
            new ContentCard(cardElement, data);
            return cardElement;
        }
    };
    
    // Initialize existing cards when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initContentCards);
    } else {
        initContentCards();
    }
    
    // Re-initialize when new cards are added
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                initContentCards();
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
})();
</script>

<style>
.content-card {
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background-color: var(--bg-secondary);
    transition: all var(--duration-base) var(--ease-cinematic);
    cursor: pointer;
    aspect-ratio: 2/3;
}

.content-card:hover {
    transform: scale(1.03) translateY(-0.25rem);
    box-shadow: var(--shadow-2xl);
    z-index: 10;
}

.card-poster {
    position: relative;
    width: 100%;
    height: 75%;
    overflow: hidden;
}

.card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-cinematic);
}

.content-card:hover .card-image {
    transform: scale(1.05);
}

.card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.8) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--duration-base) var(--ease-cinematic);
}

.content-card:hover .card-overlay {
    opacity: 1;
}

.btn-play {
    background-color: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    font-size: 1.25rem;
    transform: scale(0.8);
    transition: all var(--duration-base) var(--ease-cinematic);
}

.content-card:hover .btn-play {
    transform: scale(1);
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.card-badges {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    z-index: 5;
}

.quality-badge {
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.quality-badge.new {
    background: var(--emerald-green);
}

.quality-badge.trending {
    background: var(--cinema-red);
}

.quality-badge.critics {
    background: var(--vip-gold);
}

.card-content {
    height: 25%;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.card-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.card-rating {
    color: var(--vip-gold);
    font-weight: 600;
}

.card-genres {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
}

.genre-chip {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: 1rem;
    font-size: 0.625rem;
    font-weight: 500;
}

.card-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity var(--duration-base) var(--ease-cinematic);
}

.content-card:hover .card-actions {
    opacity: 1;
}

.card-actions .btn {
    padding: 0.25rem;
    width: 1.75rem;
    height: 1.75rem;
    font-size: 0.75rem;
}

.card-actions .btn.active {
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.touch-active {
    transform: scale(0.98) !important;
    transition-duration: 0.1s !important;
}

@media (max-width: 767.98px) {
    .card-actions {
        opacity: 1;
    }
    
    .card-overlay {
        opacity: 0.7;
    }
    
    .content-card:hover {
        transform: none;
        box-shadow: var(--shadow-lg);
    }
}
</style>