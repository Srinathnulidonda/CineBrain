<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popular - CineScope</title>
    <meta name="description" content="Discover the most popular movies, TV shows, and anime on CineScope.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Popular Content...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">⭐ Popular</h1>
            <p class="text-gray-400 text-lg">Most loved by our community</p>
        </div>

        <!-- Content Type Filter -->
        <div class="tabs mb-8" id="contentTabs">
            <div class="tab-list">
                <button class="tab-button active" data-tab="movie">Movies</button>
                <button class="tab-button" data-tab="tv">TV Shows</button>
                <button class="tab-button" data-tab="anime">Anime</button>
            </div>
        </div>

        <!-- Region Filter -->
        <div class="flex justify-center mb-8">
            <select id="regionFilter" class="form-input max-w-xs">
                <option value="">All Regions</option>
                <option value="US">United States</option>
                <option value="IN">India</option>
                <option value="JP">Japan</option>
                <option value="KR">South Korea</option>
                <option value="GB">United Kingdom</option>
            </select>
        </div>

        <div class="content-grid" id="popularContent">
            <!-- Content will be loaded here -->
        </div>

        <div class="text-center mt-12">
            <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMore()" style="display: none;">
                Load More Popular
            </button>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let currentType = 'movie';
        let currentRegion = '';
        let currentPage = 1;
        let allResults = [];
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', () => {
            UI.initTabs(document.getElementById('contentTabs'));
            setupEventListeners();
            loadPopularContent();
        });

        function setupEventListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    currentType = button.dataset.tab;
                    resetAndLoad();
                });
            });

            document.getElementById('regionFilter').addEventListener('change', (e) => {
                currentRegion = e.target.value;
                resetAndLoad();
            });
        }

        function resetAndLoad() {
            currentPage = 1;
            allResults = [];
            loadPopularContent();
        }

        async function loadPopularContent() {
            if (isLoading) return;

            try {
                isLoading = true;
                const container = document.getElementById('popularContent');
                
                if (currentPage === 1) {
                    UI.showSkeleton(container, 20);
                }

                let response;
                if (currentType === 'anime') {
                    response = await api.getAnimeRecommendations(null, 20);
                } else {
                    // For movies and TV shows, we'll use getTrending as a fallback since getPopular might not be implemented
                    response = await api.getTrending(currentType, 20);
                }
                
                const content = response.recommendations || [];

                if (currentPage === 1) {
                    allResults = content;
                } else {
                    allResults = [...allResults, ...content];
                }

                contentManager.renderMovieGrid(container, { recommendations: allResults });
                
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.style.display = content.length >= 20 ? 'block' : 'none';

            } catch (error) {
                console.error('Error loading popular content:', error);
                showErrorState();
            } finally {
                isLoading = false;
            }
        }

        function loadMore() {
            currentPage++;
            loadPopularContent();
        }

        function showErrorState() {
            const container = document.getElementById('popularContent');
            container.innerHTML = `
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <h3 class="empty-state-title">Failed to load popular content</h3>
                        <p class="empty-state-description">Please try again later.</p>
                        <button class="btn btn-primary mt-4" onclick="loadPopularContent()">Retry</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>