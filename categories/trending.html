<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trending Content - CineScope</title>
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <i class="fas fa-film"></i>
                <span>CineScope</span>
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading trending content...</div>
        </div>
    </div>

    <!-- Header -->
    <div id="headerContainer"></div>

    <!-- Main Content -->
    <main class="main-content category-content">
        <!-- Category Hero -->
        <section class="category-hero">
            <div class="container">
                <div class="category-header">
                    <div class="breadcrumb-nav">
                        <nav class="breadcrumb">
                            <span class="breadcrumb-item"><a href="/">Home</a></span>
                            <span class="breadcrumb-item"><a href="/categories">Categories</a></span>
                            <span class="breadcrumb-item active">Trending</span>
                        </nav>
                    </div>
                    <h1 class="category-title">
                        <i class="fas fa-fire text-warning me-3"></i>
                        Trending Now
                    </h1>
                    <p class="category-description">
                        Discover what's hot and trending across movies, TV shows, and anime worldwide.
                    </p>
                </div>
            </div>
        </section>

        <!-- Filters and Controls -->
        <section class="category-controls">
            <div class="container">
                <div class="controls-wrapper">
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label>Type:</label>
                            <select class="form-select form-select-sm" id="typeFilter">
                                <option value="all">All Content</option>
                                <option value="movie">Movies</option>
                                <option value="tv">TV Shows</option>
                                <option value="anime">Anime</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Time:</label>
                            <select class="form-select form-select-sm" id="timeFilter">
                                <option value="day">Today</option>
                                <option value="week" selected>This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Genre:</label>
                            <select class="form-select form-select-sm" id="genreFilter">
                                <option value="">All Genres</option>
                                <option value="action">Action</option>
                                <option value="comedy">Comedy</option>
                                <option value="drama">Drama</option>
                                <option value="horror">Horror</option>
                                <option value="romance">Romance</option>
                                <option value="sci-fi">Sci-Fi</option>
                                <option value="thriller">Thriller</option>
                            </select>
                        </div>
                    </div>
                    <div class="view-controls">
                        <div class="view-toggle">
                            <button class="btn btn-sm btn-outline-primary active" data-view="grid" id="gridViewBtn">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" data-view="list" id="listViewBtn">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                        <div class="sort-control">
                            <select class="form-select form-select-sm" id="sortFilter">
                                <option value="popularity">Popularity</option>
                                <option value="rating">Rating</option>
                                <option value="release_date">Release Date</option>
                                <option value="title">Title</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Content Grid -->
        <section class="category-content-section">
            <div class="container">
                <div class="content-grid" id="contentGrid">
                    <!-- Loading skeleton -->
                    <div class="loading-skeleton">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="pagination-container" id="paginationContainer"></div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div id="footerContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/include.js"></script>
    <script>
        let currentFilters = {
            type: 'all',
            time: 'week',
            genre: '',
            sort: 'popularity',
            page: 1
        };
        let currentView = 'grid';
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCategoryPage();
        });

        async function initializeCategoryPage() {
            // Load includes
            await loadIncludes();
            
            // Initialize category page
            bindCategoryEvents();
            await loadTrendingContent();
            
            Utils.hideLoadingScreen();
        }

        async function loadIncludes() {
            try {
                await Promise.all([
                    loadHeader(),
                    loadFooter()
                ]);
            } catch (error) {
                console.error('Failed to load includes:', error);
            }
        }

        function bindCategoryEvents() {
            // Filter controls
            document.getElementById('typeFilter').onchange = (e) => {
                currentFilters.type = e.target.value;
                currentFilters.page = 1;
                loadTrendingContent();
            };

            document.getElementById('timeFilter').onchange = (e) => {
                currentFilters.time = e.target.value;
                currentFilters.page = 1;
                loadTrendingContent();
            };

            document.getElementById('genreFilter').onchange = (e) => {
                currentFilters.genre = e.target.value;
                currentFilters.page = 1;
                loadTrendingContent();
            };

            document.getElementById('sortFilter').onchange = (e) => {
                currentFilters.sort = e.target.value;
                currentFilters.page = 1;
                loadTrendingContent();
            };

            // View toggle
            document.getElementById('gridViewBtn').onclick = () => switchView('grid');
            document.getElementById('listViewBtn').onclick = () => switchView('list');
        }

        async function loadTrendingContent() {
            if (isLoading) return;
            
            isLoading = true;
            const contentGrid = document.getElementById('contentGrid');
            
            try {
                // Show loading
                if (currentFilters.page === 1) {
                    showLoadingSkeleton();
                }

                // Build API URL based on filters
                let apiUrl = `/recommendations/trending?limit=24&page=${currentFilters.page}`;
                
                if (currentFilters.type !== 'all') {
                    apiUrl += `&type=${currentFilters.type}`;
                }

                // For genre filtering, we'll need to use genre-specific API
                if (currentFilters.genre) {
                    apiUrl = `/recommendations/genre/${currentFilters.genre}?limit=24&page=${currentFilters.page}`;
                    if (currentFilters.type !== 'all') {
                        apiUrl += `&type=${currentFilters.type}`;
                    }
                }

                const response = await ApiService.request(apiUrl);
                const content = response.recommendations || [];

                // Sort content if needed
                const sortedContent = sortContent(content, currentFilters.sort);

                // Render content
                renderContent(sortedContent);
                
                // Update pagination
                updatePagination(response.total_pages || 1, currentFilters.page);

            } catch (error) {
                console.error('Failed to load trending content:', error);
                Utils.showToast('Failed to load content', 'error');
                contentGrid.innerHTML = '<div class="error-message">Failed to load content. Please try again.</div>';
            } finally {
                isLoading = false;
            }
        }

        function showLoadingSkeleton() {
            const contentGrid = document.getElementById('contentGrid');
            const skeletonHtml = Array(8).fill(0).map(() => 
                '<div class="skeleton-card skeleton"></div>'
            ).join('');
            contentGrid.innerHTML = `<div class="loading-skeleton">${skeletonHtml}</div>`;
        }

        function sortContent(content, sortBy) {
            const sorted = [...content];
            
            switch (sortBy) {
                case 'rating':
                    return sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                case 'release_date':
                    return sorted.sort((a, b) => new Date(b.release_date || 0) - new Date(a.release_date || 0));
                case 'title':
                    return sorted.sort((a, b) => a.title.localeCompare(b.title));
                case 'popularity':
                default:
                    return sorted.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
            }
        }

        function renderContent(content) {
            const contentGrid = document.getElementById('contentGrid');
            
            if (content.length === 0) {
                contentGrid.innerHTML = `
                    <div class="no-content-message">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h3>No content found</h3>
                        <p>Try adjusting your filters or check back later.</p>
                    </div>
                `;
                return;
            }

            const contentHtml = content.map(item => {
                if (currentView === 'grid') {
                    return createGridCard(item);
                } else {
                    return createListCard(item);
                }
            }).join('');

            contentGrid.className = `content-grid ${currentView}-view`;
            contentGrid.innerHTML = contentHtml;
        }

        function createGridCard(item) {
            const badges = [];
            if (item.is_trending) badges.push('<span class="badge badge-trending">Trending</span>');
            if (item.is_new_release) badges.push('<span class="badge badge-new">New</span>');
            if (item.is_critics_choice) badges.push('<span class="badge badge-critics">Critics Choice</span>');

            return `
                <div class="content-card-wrapper" onclick="Utils.navigateToDetails(${item.id})">
                    <div class="content-card">
                        <div class="content-card-poster">
                            <img src="${Utils.getImageUrl(item.poster_path)}" 
                                 alt="${item.title}" 
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                            <div class="content-card-overlay">
                                <button class="play-btn" onclick="event.stopPropagation(); UIComponents.playTrailer('${item.youtube_trailer || ''}')">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                            ${badges.length ? `<div class="content-card-badges">${badges.join('')}</div>` : ''}
                        </div>
                        <div class="content-card-info">
                            <h6 class="content-card-title">${item.title}</h6>
                            <div class="content-card-meta">
                                <span class="content-type">${item.content_type.toUpperCase()}</span>
                                <div class="content-card-rating">
                                    <i class="fas fa-star"></i>
                                    <span>${Utils.formatRating(item.rating)}</span>
                                </div>
                            </div>
                            <p class="content-card-overview">${Utils.truncateText(item.overview, 100)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createListCard(item) {
            const badges = [];
            if (item.is_trending) badges.push('<span class="badge badge-trending">Trending</span>');
            if (item.is_new_release) badges.push('<span class="badge badge-new">New</span>');
            if (item.is_critics_choice) badges.push('<span class="badge badge-critics">Critics Choice</span>');

            return `
                <div class="list-card" onclick="Utils.navigateToDetails(${item.id})">
                    <div class="list-card-poster">
                        <img src="${Utils.getImageUrl(item.poster_path, 'w154')}" 
                             alt="${item.title}"
                             onerror="this.src='https://via.placeholder.com/154x231?text=No+Image'">
                    </div>
                    <div class="list-card-content">
                        <div class="list-card-header">
                            <h5 class="list-card-title">${item.title}</h5>
                            <div class="list-card-badges">${badges.join('')}</div>
                        </div>
                        <div class="list-card-meta">
                            <span class="content-type">${item.content_type.toUpperCase()}</span>
                            <span class="release-date">${Utils.formatDate(item.release_date)}</span>
                            <div class="content-rating">
                                <i class="fas fa-star"></i>
                                <span>${Utils.formatRating(item.rating)}</span>
                            </div>
                        </div>
                        <p class="list-card-overview">${Utils.truncateText(item.overview, 200)}</p>
                        <div class="list-card-genres">
                            ${(item.genres || []).map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                        </div>
                    </div>
                    <div class="list-card-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); UIComponents.playTrailer('${item.youtube_trailer || ''}')">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); addToWatchlist(${item.id})">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            // Re-render current content
            loadTrendingContent();
        }

        function updatePagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHtml += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHtml += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `<span class="pagination-ellipsis">...</span>`;
                }
                paginationHtml += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            paginationHtml += `
                <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            paginationContainer.innerHTML = paginationHtml;
        }

        function goToPage(page) {
            currentFilters.page = page;
            loadTrendingContent();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function addToWatchlist(contentId) {
            if (!AppState.isAuthenticated) {
                Utils.showToast('Please login to add to watchlist', 'error');
                return;
            }

            try {
                await ApiService.recordInteraction(contentId, 'watchlist');
                Utils.showToast('Added to watchlist!', 'success');
            } catch (error) {
                Utils.showToast('Failed to add to watchlist', 'error');
            }
        }
    </script>

    <style>
        .category-content {
            padding-top: 2rem;
        }

        .category-hero {
            padding: 2rem 0 3rem;
            background: var(--gradient-dark);
        }

        .category-header {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .category-title {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-description {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .category-controls {
            padding: 2rem 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 80px;
            z-index: 100;
        }

        .controls-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .filter-controls {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .view-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.25rem;
        }

        .view-toggle .btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-content-section {
            padding: 3rem 0;
            min-height: 60vh;
        }

        .content-grid {
            display: grid;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .content-grid.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .content-grid.list-view {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .content-card-wrapper {
            cursor: pointer;
        }

        .content-card-overview {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
            margin-top: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .list-card {
            display: flex;
            gap: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .list-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .list-card-poster {
            flex-shrink: 0;
        }

        .list-card-poster img {
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .list-card-content {
            flex: 1;
            min-width: 0;
        }

        .list-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .list-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.3;
        }

        .list-card-badges {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .list-card-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .list-card-overview {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .list-card-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .list-card-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }

        .loading-skeleton {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2rem;
        }

        .skeleton-card {
            height: 350px;
            border-radius: var(--border-radius-lg);
        }

        .no-content-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .error-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--danger-color);
            background: var(--bg-card);
            border: 1px solid var(--danger-color);
            border-radius: var(--border-radius-lg);
        }

        .pagination-ellipsis {
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .controls-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .filter-controls {
                justify-content: center;
                gap: 1rem;
            }

            .view-controls {
                justify-content: center;
            }

            .category-controls {
                position: static;
            }

            .content-grid.grid-view {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }

            .list-card {
                flex-direction: column;
                text-align: center;
            }

            .list-card-poster img {
                width: 150px;
                height: 225px;
                margin: 0 auto;
            }

            .list-card-header {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
            }

            .list-card-meta {
                justify-content: center;
                flex-wrap: wrap;
            }

            .list-card-actions {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</body>
</html>