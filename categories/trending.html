<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trending - CineScope</title>
    <meta name="description" content="Discover what's trending now on CineScope - the hottest movies, TV shows, and anime.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Trending...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">üî• Trending Now</h1>
            <p class="text-gray-400 text-lg">What everyone's watching right now</p>
        </div>

        <!-- Content Type Tabs -->
        <div class="tabs mb-8" id="contentTabs">
            <div class="tab-list">
                <button class="tab-button active" data-tab="all">All</button>
                <button class="tab-button" data-tab="movie">Movies</button>
                <button class="tab-button" data-tab="tv">TV Shows</button>
                <button class="tab-button" data-tab="anime">Anime</button>
            </div>
        </div>

        <!-- Time Period Filter -->
        <div class="flex justify-center mb-8">
            <div class="flex border border-gray-700 rounded-lg overflow-hidden">
                <button class="px-6 py-2 bg-primary text-white" id="todayBtn" onclick="setTimePeriod('day')">
                    Today
                </button>
                <button class="px-6 py-2 bg-gray-800 text-gray-400" id="weekBtn" onclick="setTimePeriod('week')">
                    This Week
                </button>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid" id="trendingContent">
            <!-- Content will be loaded here -->
        </div>

        <!-- Load More -->
        <div class="text-center mt-12">
            <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMore()" style="display: none;">
                Load More Trending
            </button>
        </div>

        <!-- Trending Stats -->
        <section class="section mt-16">
            <h2 class="section-title">Trending Statistics</h2>
            <div class="grid grid-2 md:grid-4 gap-6">
                <div class="stats-card">
                    <div class="stats-value" id="totalTrending">0</div>
                    <div class="stats-label">Trending Items</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="trendingMovies">0</div>
                    <div class="stats-label">Movies</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="trendingTVShows">0</div>
                    <div class="stats-label">TV Shows</div>
                </div>
                <div class="stats-card">
                    <div class="stats-value" id="trendingAnime">0</div>
                    <div class="stats-label">Anime</div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let currentType = 'all';
        let currentTimePeriod = 'day';
        let currentPage = 1;
        let allResults = [];
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', () => {
            UI.initTabs(document.getElementById('contentTabs'));
            setupEventListeners();
            loadTrendingContent();
        });

        function setupEventListeners() {
            // Tab change events
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    currentType = button.dataset.tab;
                    currentPage = 1;
                    allResults = [];
                    loadTrendingContent();
                });
            });
        }

        async function loadTrendingContent() {
            if (isLoading) return;

            try {
                isLoading = true;
                const container = document.getElementById('trendingContent');
                
                if (currentPage === 1) {
                    UI.showSkeleton(container, 20);
                }

                const response = await api.getTrending(currentType, 20 * currentPage);
                const content = response.recommendations || [];

                if (currentPage === 1) {
                    allResults = content;
                } else {
                    allResults = [...allResults, ...content];
                }

                renderContent(container, allResults);
                updateStats(allResults);
                
                // Show/hide load more button
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.style.display = content.length >= 20 ? 'block' : 'none';

            } catch (error) {
                console.error('Error loading trending content:', error);
                showErrorState();
            } finally {
                isLoading = false;
            }
        }

        function renderContent(container, content) {
            if (!content || content.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <h3 class="empty-state-title">No trending content</h3>
                            <p class="empty-state-description">Check back later for trending updates.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = content.map((item, index) => {
                const card = UI.createMovieCard(item);
                
                // Add trending rank badge
                const rank = index + 1;
                card.innerHTML = `
                    <div class="relative">
                        <div class="absolute top-2 left-2 z-10">
                            <div class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full">
                                #${rank}
                            </div>
                        </div>
                        ${card.innerHTML}
                    </div>
                `;
                
                return card.outerHTML;
            }).join('');

            Utils.lazyLoadImages();
        }

        function updateStats(content) {
            const totalCount = content.length;
            const movieCount = content.filter(item => item.content_type === 'movie').length;
            const tvCount = content.filter(item => item.content_type === 'tv').length;
            const animeCount = content.filter(item => item.content_type === 'anime').length;

            document.getElementById('totalTrending').textContent = totalCount;
            document.getElementById('trendingMovies').textContent = movieCount;
            document.getElementById('trendingTVShows').textContent = tvCount;
            document.getElementById('trendingAnime').textContent = animeCount;
        }

        function setTimePeriod(period) {
            currentTimePeriod = period;
            currentPage = 1;
            allResults = [];

            // Update button states
            const todayBtn = document.getElementById('todayBtn');
            const weekBtn = document.getElementById('weekBtn');

            if (period === 'day') {
                todayBtn.classList.add('bg-primary', 'text-white');
                todayBtn.classList.remove('bg-gray-800', 'text-gray-400');
                weekBtn.classList.add('bg-gray-800', 'text-gray-400');
                weekBtn.classList.remove('bg-primary', 'text-white');
            } else {
                weekBtn.classList.add('bg-primary', 'text-white');
                weekBtn.classList.remove('bg-gray-800', 'text-gray-400');
                todayBtn.classList.add('bg-gray-800', 'text-gray-400');
                todayBtn.classList.remove('bg-primary', 'text-white');
            }

            loadTrendingContent();
        }

        function loadMore() {
            currentPage++;
            loadTrendingContent();
        }

        function showErrorState() {
            const container = document.getElementById('trendingContent');
            container.innerHTML = `
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3 class="empty-state-title">Failed to load trending content</h3>
                        <p class="empty-state-description">Please try again later.</p>
                        <button class="btn btn-primary mt-4" onclick="loadTrendingContent()">Retry</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>