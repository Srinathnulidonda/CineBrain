<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies - CineScope</title>
    <meta name="description" content="Explore our vast collection of movies from around the world.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Movies...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">üé¨ Movies</h1>
            <p class="text-gray-400 text-lg">Discover amazing movies from every genre</p>
        </div>

        <!-- Genre Tabs -->
        <div class="tabs mb-8" id="genreTabs">
            <div class="tab-list">
                <button class="tab-button active" data-tab="all">All Movies</button>
                <button class="tab-button" data-tab="action">Action</button>
                <button class="tab-button" data-tab="comedy">Comedy</button>
                <button class="tab-button" data-tab="drama">Drama</button>
                <button class="tab-button" data-tab="thriller">Thriller</button>
                <button class="tab-button" data-tab="romance">Romance</button>
                <button class="tab-button" data-tab="sci-fi">Sci-Fi</button>
                <button class="tab-button" data-tab="horror">Horror</button>
            </div>
        </div>

        <!-- Additional Filters -->
        <div class="card mb-8">
            <div class="card-content">
                <div class="grid grid-1 md:grid-4 gap-6">
                    <div>
                        <label class="form-label">Language</label>
                        <select id="languageFilter" class="form-input">
                            <option value="">All Languages</option>
                            <option value="english">English</option>
                            <option value="hindi">Hindi</option>
                            <option value="telugu">Telugu</option>
                            <option value="tamil">Tamil</option>
                            <option value="kannada">Kannada</option>
                            <option value="malayalam">Malayalam</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Year Range</label>
                        <select id="yearRange" class="form-input">
                            <option value="">All Years</option>
                            <option value="2020-2025">2020s</option>
                            <option value="2010-2019">2010s</option>
                            <option value="2000-2009">2000s</option>
                            <option value="1990-1999">90s</option>
                            <option value="1980-1989">80s</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Sort By</label>
                        <select id="sortBy" class="form-input">
                            <option value="popularity">Popularity</option>
                            <option value="rating">Rating</option>
                            <option value="release_date">Release Date</option>
                            <option value="title">Title</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button class="btn btn-secondary w-full" onclick="clearFilters()">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-grid" id="moviesContent">
            <!-- Content will be loaded here -->
        </div>

        <div class="text-center mt-12">
            <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMore()" style="display: none;">
                Load More Movies
            </button>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let currentGenre = 'all';
        let currentPage = 1;
        let allResults = [];
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', () => {
            UI.initTabs(document.getElementById('genreTabs'));
            setupEventListeners();
            loadMovies();
        });

        function setupEventListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    currentGenre = button.dataset.tab;
                    resetAndLoad();
                });
            });

            ['languageFilter', 'yearRange', 'sortBy'].forEach(id => {
                document.getElementById(id).addEventListener('change', resetAndLoad);
            });
        }

        function resetAndLoad() {
            currentPage = 1;
            allResults = [];
            loadMovies();
        }

        async function loadMovies() {
            if (isLoading) return;

            try {
                isLoading = true;
                const container = document.getElementById('moviesContent');
                
                if (currentPage === 1) {
                    UI.showSkeleton(container, 20);
                }

                let response;
                if (currentGenre === 'all') {
                    response = await api.getTrending('movie', 20);
                } else {
                    response = await api.getGenreRecommendations(currentGenre, 'movie', 20);
                }
                
                const content = response.recommendations || [];

                if (currentPage === 1) {
                    allResults = content;
                } else {
                    allResults = [...allResults, ...content];
                }

                // Apply client-side filters
                const filteredResults = applyFilters(allResults);
                contentManager.renderMovieGrid(container, { recommendations: filteredResults });
                
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.style.display = content.length >= 20 ? 'block' : 'none';

            } catch (error) {
                console.error('Error loading movies:', error);
                showErrorState();
            } finally {
                isLoading = false;
            }
        }

        function applyFilters(content) {
            let filtered = [...content];
            
            const language = document.getElementById('languageFilter').value;
            const yearRange = document.getElementById('yearRange').value;
            const sortBy = document.getElementById('sortBy').value;

            // Language filter
            if (language) {
                filtered = filtered.filter(item => {
                    const languages = item.languages || [];
                    return languages.includes(language);
                });
            }

            // Year filter
            if (yearRange) {
                const [startYear, endYear] = yearRange.split('-').map(Number);
                filtered = filtered.filter(item => {
                    if (!item.release_date) return false;
                    const year = new Date(item.release_date).getFullYear();
                    return year >= startYear && year <= endYear;
                });
            }

            // Sort
            switch (sortBy) {
                case 'rating':
                    filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'release_date':
                    filtered.sort((a, b) => new Date(b.release_date || 0) - new Date(a.release_date || 0));
                    break;
                case 'title':
                    filtered.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                default: // popularity
                    filtered.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
            }

            return filtered;
        }

        function clearFilters() {
            document.getElementById('languageFilter').value = '';
            document.getElementById('yearRange').value = '';
            document.getElementById('sortBy').value = 'popularity';
            resetAndLoad();
        }

        function loadMore() {
            currentPage++;
            loadMovies();
        }

        function showErrorState() {
            const container = document.getElementById('moviesContent');
            container.innerHTML = `
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3 class="empty-state-title">Failed to load movies</h3>
                        <p class="empty-state-description">Please try again later.</p>
                        <button class="btn btn-primary mt-4" onclick="loadMovies()">Retry</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>