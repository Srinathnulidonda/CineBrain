<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <script>document.write('<script src="/includes/head.html"><\/script>');</script>
    <title>New Releases | CineScope</title>
</head>
<body>
    <div data-include="header"></div>
    
    <main class="container py-8 pt-24">
        <section class="category-header mb-8">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-clock text-green-500 mr-3"></i>
                New <span class="text-gradient">Releases</span>
            </h1>
            <p class="text-gray-400 text-lg">Fresh content released in the last 60 days</p>
        </section>

        <div class="category-filters mb-8">
            <div class="flex flex-wrap gap-4">
                <select id="contentType" class="filter-select" onchange="loadNewReleases()">
                    <option value="movie">Movies</option>
                    <option value="tv">TV Shows</option>
                </select>
                <select id="language" class="filter-select" onchange="loadNewReleases()">
                    <option value="">All Languages</option>
                    <option value="english">English</option>
                    <option value="hindi">Hindi</option>
                    <option value="telugu">Telugu</option>
                    <option value="tamil">Tamil</option>
                    <option value="kannada">Kannada</option>
                    <option value="malayalam">Malayalam</option>
                </select>
                <select id="sortBy" class="filter-select" onchange="loadNewReleases()">
                    <option value="release_date">Release Date</option>
                    <option value="rating">Rating</option>
                    <option value="popularity">Popularity</option>
                </select>
            </div>
        </div>

        <div id="newReleasesContent">
            <div class="loading"><div class="spinner"></div></div>
        </div>

        <div id="loadMoreContainer" class="text-center mt-8 hidden">
            <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMoreContent()">
                Load More Content
            </button>
        </div>
    </main>

    <div data-include="footer"></div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let currentPage = 1;
        let allContent = [];

        async function loadNewReleases(reset = true) {
            const container = document.getElementById('newReleasesContent');
            const contentType = document.getElementById('contentType').value;
            const language = document.getElementById('language').value;
            
            if (reset) {
                currentPage = 1;
                allContent = [];
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            }
            
            try {
                const response = await APIService.getNewReleases(language, contentType, 20);
                const content = response.recommendations || [];
                
                if (reset) {
                    allContent = content;
                } else {
                    allContent = [...allContent, ...content];
                }

                sortContent();
                displayContent();
            } catch (error) {
                container.innerHTML = '<p class="text-center text-red-400 py-8">Failed to load new releases</p>';
            }
        }

        function sortContent() {
            const sortBy = document.getElementById('sortBy').value;
            
            allContent.sort((a, b) => {
                switch (sortBy) {
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'popularity':
                        return (b.popularity || 0) - (a.popularity || 0);
                    case 'release_date':
                    default:
                        const dateA = a.release_date ? new Date(a.release_date) : new Date(0);
                        const dateB = b.release_date ? new Date(b.release_date) : new Date(0);
                        return dateB - dateA;
                }
            });
        }

        function displayContent() {
            const container = document.getElementById('newReleasesContent');
            
            if (allContent.length > 0) {
                const contentHTML = allContent.map(item => {
                    const releaseDate = item.release_date ? new Date(item.release_date).toLocaleDateString() : 'Unknown';
                    const isNew = item.release_date && new Date(item.release_date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    
                    return `
                        <div class="content-card cursor-pointer" onclick="window.location.href='/details?id=${item.id}'">
                            <div class="content-card-image">
                                <img src="${item.poster_path || '/assets/images/placeholder.jpg'}" alt="${item.title}" loading="lazy">
                                ${isNew ? '<div class="absolute top-2 left-2"><span class="badge badge-new">NEW</span></div>' : ''}
                                <div class="content-card-overlay"></div>
                                <div class="content-card-actions">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); ContentManager.addToWatchlist(${item.id})">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); ContentManager.addToFavorites(${item.id})">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    ${item.youtube_trailer ? `
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); ContentManager.playTrailer('${item.youtube_trailer}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="content-card-info">
                                <div class="content-card-title">${item.title}</div>
                                <div class="content-card-meta">
                                    <span class="rating">
                                        <i class="fas fa-star"></i> ${item.rating ? item.rating.toFixed(1) : 'N/A'}
                                    </span>
                                    <span class="badge">${item.content_type.toUpperCase()}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-2">Released: ${releaseDate}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `<div class="content-grid">${contentHTML}</div>`;
            } else {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">No new releases found</p>';
            }
        }

        async function loadMoreContent() {
            currentPage++;
            await loadNewReleases(false);
        }

        document.addEventListener('DOMContentLoaded', loadNewReleases);
    </script>
</body>
</html>