<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineBrain - The Mind Behind Your Next Favorite</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white min-h-screen">

  <!-- CineBrain Topbar Component -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700;800;900&display=swap');

    .brand-font {
      font-family: 'Bebas Neue', cursive;
      letter-spacing: 0.05em;
    }

    .brand-gradient {
      background: linear-gradient(135deg, #E50914 0%, #0073E6 50%, #8B5CF6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .glass-effect {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .autocomplete-dropdown {
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(139, 92, 246, 0.5) transparent;
    }

    .autocomplete-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-track {
      background: transparent;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 3px;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-down {
      animation: slideDown 0.3s ease-out;
    }
  </style>

  <div id="cinebrain-topbar" x-data="topbarComponent()" x-init="init()"
    class="fixed top-0 left-0 right-0 z-50 glass-effect transition-all duration-300">

    <nav class="container mx-auto px-4 py-3 md:py-4">
      <div class="flex items-center justify-between">

        <!-- Brand Section -->
        <a href="/" class="flex flex-col group cursor-pointer transform transition-transform hover:scale-105">
          <h1 class="brand-font text-lg md:text-2xl lg:text-3xl brand-gradient leading-tight">
            CineBrain
          </h1>
          <span class="text-xs md:text-sm text-gray-400 group-hover:text-gray-300 transition-colors -mt-1">
            The Mind Behind Your Next Favorite
          </span>
        </a>

        <!-- Search Section -->
        <div class="flex-1 max-w-2xl mx-4 md:mx-8 relative"
          x-data="{ searchOpen: false, searchQuery: '', searchResults: [], searching: false }">

          <div class="relative">
            <!-- Mobile Search Icon -->
            <button @click="searchOpen = !searchOpen"
              class="md:hidden p-2 rounded-full hover:bg-gray-800 transition-colors">
              <i class="fas fa-search text-gray-400"></i>
            </button>

            <!-- Desktop Search Bar -->
            <div class="hidden md:block relative">
              <input type="text" x-model="searchQuery" @input.debounce.300ms="performSearch()"
                @focus="searchOpen = true" @click.away="setTimeout(() => searchOpen = false, 200)"
                placeholder="Search movies, TV shows, anime..." class="w-full px-4 py-2 pl-10 bg-gray-800/50 border border-gray-700 rounded-full 
                                      focus:outline-none focus:border-blue-500 transition-all
                                      placeholder-gray-500 text-sm text-white">
              <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>

              <div x-show="searching" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Autocomplete Dropdown -->
          <div x-show="searchOpen && searchQuery.length > 0" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" class="absolute top-full mt-2 w-full bg-gray-900 border border-gray-700 rounded-lg shadow-2xl 
                            autocomplete-dropdown animate-slide-down">

            <template x-if="searchResults.length > 0">
              <div class="p-2">
                <template x-for="result in searchResults" :key="result.id">
                  <a :href="'/content.html?id=' + result.id"
                    class="flex items-center p-2 hover:bg-gray-800 rounded-lg transition-colors group">
                    <div class="w-12 h-16 bg-gray-800 rounded overflow-hidden flex-shrink-0">
                      <img :src="result.poster_path || 'data:image/svg+xml,%3Csvg xmlns=\" http://www.w3.org/2000/svg\"
                        viewBox=\"0 0 48 64\" fill=\"%23374151\"%3E%3C/svg%3E'" :alt="result.title"
                        class="w-full h-full object-cover">
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                      <h4 class="text-sm font-medium text-white group-hover:text-blue-400 truncate"
                        x-text="result.title"></h4>
                      <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs px-2 py-0.5 bg-gray-800 rounded" :class="{
                                                      'text-blue-400': result.content_type === 'movie',
                                                      'text-green-400': result.content_type === 'tv',
                                                      'text-purple-400': result.content_type === 'anime'
                                                  }" x-text="result.content_type?.toUpperCase()"></span>
                        <span class="text-xs text-gray-500"
                          x-text="result.release_date?.substring(0, 4) || 'N/A'"></span>
                      </div>
                    </div>
                  </a>
                </template>
              </div>
            </template>

            <template x-if="searchResults.length === 0 && searchQuery.length > 0 && !searching">
              <div class="p-8 text-center text-gray-500">
                <i class="fas fa-film text-3xl mb-2"></i>
                <p class="text-sm">No results found</p>
              </div>
            </template>

            <template x-if="searching">
              <div class="p-4 text-center text-gray-400">
                <i class="fas fa-spinner fa-spin"></i> Searching...
              </div>
            </template>
          </div>
        </div>

        <!-- Avatar Menu -->
        <div class="relative" x-data="{ menuOpen: false }">
          <button @click="menuOpen = !menuOpen" class="relative w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden border-2 
                               transition-all duration-300 hover:scale-110"
            :class="user ? 'border-purple-500' : 'border-gray-600'">

            <template x-if="user">
              <div class="w-full h-full bg-gradient-to-br from-purple-500 to-blue-500 
                                    flex items-center justify-center text-white font-bold text-lg">
                <span x-text="user.username.charAt(0).toUpperCase()"></span>
              </div>
            </template>

            <template x-if="!user">
              <div class="w-full h-full bg-gray-700 flex items-center justify-center">
                <i class="fas fa-user text-gray-400"></i>
              </div>
            </template>

            <template x-if="user && user.is_admin">
              <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border border-gray-900"></span>
            </template>
          </button>

          <div x-show="menuOpen" x-transition @click.away="menuOpen = false"
            class="absolute right-0 mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-2xl">

            <template x-if="!user">
              <div class="py-2">
                <a href="/login.html" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800">
                  <i class="fas fa-sign-in-alt w-5 text-gray-500"></i>
                  <span class="ml-3">Login</span>
                </a>
                <a href="/register.html" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800">
                  <i class="fas fa-user-plus w-5 text-gray-500"></i>
                  <span class="ml-3">Register</span>
                </a>
              </div>
            </template>

            <template x-if="user">
              <div class="py-2">
                <div class="px-4 py-3 border-b border-gray-800">
                  <p class="text-sm font-medium text-white" x-text="user.username"></p>
                  <p class="text-xs text-gray-400" x-text="user.email"></p>
                </div>

                <template x-if="user.is_admin">
                  <div>
                    <a href="/admin/dashboard.html"
                      class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800">
                      <i class="fas fa-tachometer-alt w-5 text-gray-500"></i>
                      <span class="ml-3">Dashboard</span>
                    </a>
                    <div class="border-t border-gray-800 my-2"></div>
                  </div>
                </template>

                <a href="/profile.html" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800">
                  <i class="fas fa-user-circle w-5 text-gray-500"></i>
                  <span class="ml-3">My Profile</span>
                </a>
                <a href="/watchlist.html" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800">
                  <i class="fas fa-bookmark w-5 text-gray-500"></i>
                  <span class="ml-3">Watchlist</span>
                </a>
                <a href="/favorites.html" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800">
                  <i class="fas fa-heart w-5 text-gray-500"></i>
                  <span class="ml-3">Favorites</span>
                </a>

                <div class="border-t border-gray-800 my-2"></div>

                <button @click="signOut()"
                  class="w-full flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 text-left">
                  <i class="fas fa-sign-out-alt w-5 text-gray-500"></i>
                  <span class="ml-3">Sign Out</span>
                </button>
              </div>
            </template>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <script>
    const API_BASE_URL = 'https://backend-app-970m.onrender.com/api';

    function topbarComponent() {
      return {
        user: null,
        searchQuery: '',
        searchResults: [],
        searching: false,

        init() {
          this.checkAuth();
          window.addEventListener('auth-changed', () => this.checkAuth());

          // Wake up backend
          fetch(API_BASE_URL + '/health').catch(() => { });
        },

        checkAuth() {
          const token = localStorage.getItem('cinebrain_token');
          const userData = localStorage.getItem('cinebrain_user');

          if (token && userData) {
            try {
              this.user = JSON.parse(userData);
            } catch (e) {
              this.user = null;
              localStorage.removeItem('cinebrain_token');
              localStorage.removeItem('cinebrain_user');
            }
          }
        },

        async performSearch() {
          if (this.searchQuery.length < 2) {
            this.searchResults = [];
            return;
          }

          this.searching = true;

          try {
            const response = await fetch(API_BASE_URL + '/search?query=' + encodeURIComponent(this.searchQuery) + '&type=multi');

            if (response.ok) {
              const data = await response.json();
              this.searchResults = (data.results || []).slice(0, 8);
            } else {
              this.searchResults = [];
            }
          } catch (error) {
            console.error('Search error:', error);
            this.searchResults = [];
          } finally {
            this.searching = false;
          }
        },

        signOut() {
          localStorage.removeItem('cinebrain_token');
          localStorage.removeItem('cinebrain_user');
          this.user = null;
          window.dispatchEvent(new Event('auth-changed'));
          window.location.href = '/';
        }
      }
    }
  </script>

</body>

</html>