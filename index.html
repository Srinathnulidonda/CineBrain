<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineScope - Premium Movie & TV Recommendations</title>
    <meta name="description" content="Discover your next favorite movie or TV show with CineScope's ML-powered recommendations. Premium streaming platform with personalized content discovery.">
    
    <!-- Preload Critical CSS -->
    <link rel="preload" href="/css/main.css" as="style">
    <link rel="preload" href="/css/components.css" as="style">
    <link rel="preload" href="/css/layouts.css" as="style">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">
    
    <!-- Preload Critical JS -->
    <link rel="modulepreload" href="/js/config.js">
    <link rel="modulepreload" href="/js/api.js">
    <link rel="modulepreload" href="/js/auth.js">
    <link rel="modulepreload" href="/js/app.js">
    
    <!-- PWA Meta -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    
    <!-- Performance -->
    <link rel="dns-prefetch" href="https://backend-app-970m.onrender.com">
    <link rel="preconnect" href="https://image.tmdb.org" crossorigin>
    <link rel="preconnect" href="https://ui-avatars.com" crossorigin>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Page Loader -->
    <div class="page-loader">
        <div class="spinner"></div>
        <div style="margin-top: 1rem; color: var(--text-secondary);">Loading CineScope...</div>
    </div>

    <!-- Fixed Top Bar -->
    <header class="topbar" id="topbar">
        <div class="topbar-logo" onclick="app.router.navigate('/')">
            CineScope
        </div>
        
        <div class="topbar-search">
            <div class="search-icon">üîç</div>
            <input type="text" class="search-input" placeholder="Search movies, TV shows, anime..." />
            <div class="search-results" id="search-results"></div>
        </div>
        
        <div class="topbar-actions">
            <button class="theme-toggle" title="Toggle theme"></button>
            
            <!-- Show when not logged in -->
            <button class="login-btn user-only-hide" onclick="app.showModal('login', getLoginModalContent())">
                Sign In
            </button>
            
            <!-- Show when logged in -->
            <img class="user-avatar user-only-show" style="display: none;" alt="User Avatar" onclick="toggleUserMenu()" />
            
            <!-- User Menu (hidden by default) -->
            <div class="user-menu" style="display: none;">
                <div class="user-menu-dropdown">
                    <a href="#" onclick="app.router.navigate(`/${authManager.getUser()?.username}/profile`)">Profile</a>
                    <a href="#" onclick="app.router.navigate('/user/watchlist.html')">Watchlist</a>
                    <a href="#" onclick="app.router.navigate('/user/favorites.html')">Favorites</a>
                    <a href="#" onclick="app.router.navigate('/user/settings.html')">Settings</a>
                    <div class="admin-only" style="display: none;">
                        <hr>
                        <a href="#" onclick="app.router.navigate('/admin/index.html')">Admin Panel</a>
                    </div>
                    <hr>
                    <a href="#" onclick="authManager.logout()">Sign Out</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Content will be dynamically loaded here -->
        <div class="loading-skeleton" style="height: 400px; margin: 2rem; border-radius: 8px;"></div>
        <div class="loading-skeleton" style="height: 200px; margin: 2rem; border-radius: 8px;"></div>
        <div class="loading-skeleton" style="height: 200px; margin: 2rem; border-radius: 8px;"></div>
    </main>

    <!-- Fixed Bottom Navigation (Mobile) -->
    <nav class="mobile-nav" id="mobile-nav">
        <a href="/" class="mobile-nav-item" data-page="home">
            <div class="mobile-nav-icon">üè†</div>
            <span>Home</span>
        </a>
        <a href="/content/search.html" class="mobile-nav-item" data-page="search">
            <div class="mobile-nav-icon">üîç</div>
            <span>Search</span>
        </a>
        <a href="/user/watchlist.html" class="mobile-nav-item user-only-show" data-page="watchlist" style="display: none;">
            <div class="mobile-nav-icon">üìã</div>
            <span>Watchlist</span>
        </a>
        <a href="/user/favorites.html" class="mobile-nav-item user-only-show" data-page="favorites" style="display: none;">
            <div class="mobile-nav-icon">‚ù§Ô∏è</div>
            <span>Favorites</span>
        </a>
        <a href="#" class="mobile-nav-item" data-page="profile" onclick="handleProfileClick()">
            <div class="mobile-nav-icon">üë§</div>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Load JavaScript Modules -->
    <script type="module">
        // Import and initialize the app
        import app from '/js/app.js';
        import authManager from '/js/auth.js';
        import apiClient from '/js/api.js';
        
        // Make available globally for onclick handlers
        window.app = app;
        window.authManager = authManager;
        window.apiClient = apiClient;
        
        // Page-specific functions
        window.toggleUserMenu = function() {
            const menu = document.querySelector('.user-menu');
            const isVisible = menu.style.display !== 'none';
            menu.style.display = isVisible ? 'none' : 'block';
        };
        
        window.handleProfileClick = function() {
            if (authManager.isLoggedIn()) {
                const username = authManager.getUser().username;
                app.router.navigate(`/${username}/profile`);
            } else {
                app.showModal('login', getLoginModalContent());
            }
        };
        
        window.getLoginModalContent = function() {
            return `
                <div class="auth-card" style="background: var(--theater-dark); margin: 0;">
                    <div class="auth-header">
                        <div class="auth-logo">CineScope</div>
                        <h2 class="auth-title">Welcome Back</h2>
                        <p class="auth-subtitle">Sign in to your account</p>
                    </div>
                    
                    <form class="auth-form" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-input" required />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" name="password" class="form-input" required />
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('login')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Sign In</button>
                        </div>
                    </form>
                    
                    <div class="auth-footer">
                        <p>Don't have an account? <a href="#" onclick="showRegisterModal()">Sign up</a></p>
                    </div>
                </div>
            `;
        };
        
        window.getRegisterModalContent = function() {
            return `
                <div class="auth-card" style="background: var(--theater-dark); margin: 0;">
                    <div class="auth-header">
                        <div class="auth-logo">CineScope</div>
                        <h2 class="auth-title">Create Account</h2>
                        <p class="auth-subtitle">Join the premium experience</p>
                    </div>
                    
                    <form class="auth-form" onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-input" required />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-input" required />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" name="password" class="form-input" required />
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('register')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Account</button>
                        </div>
                    </form>
                    
                    <div class="auth-footer">
                        <p>Already have an account? <a href="#" onclick="showLoginModal()">Sign in</a></p>
                    </div>
                </div>
            `;
        };
        
        window.showLoginModal = function() {
            app.closeModal('register');
            app.showModal('login', getLoginModalContent());
        };
        
        window.showRegisterModal = function() {
            app.closeModal('login');
            app.showModal('register', getRegisterModalContent());
        };
        
        window.handleLogin = async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const credentials = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;
            
            try {
                const result = await authManager.login(credentials);
                if (result.success) {
                    app.closeModal('login');
                } else {
                    app.showToast(result.error, 'error');
                }
            } catch (error) {
                app.showToast('Login failed', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        };
        
        window.handleRegister = async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password')
            };
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating account...';
            submitBtn.disabled = true;
            
            try {
                const result = await authManager.register(userData);
                if (result.success) {
                    app.closeModal('register');
                } else {
                    app.showToast(result.error, 'error');
                }
            } catch (error) {
                app.showToast('Registration failed', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        };
        
        // Initialize search functionality
        const searchInput = document.querySelector('.search-input');
        const searchResults = document.getElementById('search-results');
        let searchTimeout;
        
        searchInput?.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (!query) {
                searchResults.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const results = await apiClient.search({ query, limit: 8 });
                    displaySearchResults(results.results || []);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });
        
        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No results found</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            searchResults.innerHTML = results.map(item => `
                <div class="search-result-item" onclick="app.showContentDetails(${item.id}); searchResults.style.display='none';">
                    <img src="${item.poster_path || '/assets/default-poster.jpg'}" alt="${item.title}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px;" />
                    <div style="flex: 1; margin-left: 0.75rem;">
                        <div style="font-weight: 600; font-size: 0.875rem;">${item.title}</div>
                        <div style="color: var(--text-secondary); font-size: 0.75rem;">
                            ${item.content_type?.toUpperCase()} ${item.rating ? `‚Ä¢ ‚òÖ ${item.rating.toFixed(1)}` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            searchResults.style.display = 'block';
        }
        
        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput?.contains(e.target) && !searchResults?.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
        
        // Update mobile nav active state
        function updateMobileNavActive() {
            const path = window.location.pathname;
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (path === '/' && item.dataset.page === 'home') {
                    item.classList.add('active');
                } else if (path.includes(item.dataset.page)) {
                    item.classList.add('active');
                }
            });
        }
        
        // Update nav on route change
        window.addEventListener('popstate', updateMobileNavActive);
        updateMobileNavActive();
        
        // Handle topbar scroll effects
        let lastScrollY = 0;
        window.addEventListener('scroll', () => {
            const topbar = document.getElementById('topbar');
            const currentScrollY = window.scrollY;
            
            if (currentScrollY > 50) {
                topbar.classList.add('scrolled');
            } else {
                topbar.classList.remove('scrolled');
            }
            
            lastScrollY = currentScrollY;
        });
        
        // Performance monitoring
        if (performance.mark) {
            performance.mark('app-start');
        }
        
        // Initialize app when ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.body.classList.add('app-ready');
                if (performance.mark) {
                    performance.mark('app-ready');
                    performance.measure('app-load-time', 'app-start', 'app-ready');
                }
            }, 100);
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>