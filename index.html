<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="CineBrain - The Mind Behind Your Next Favorite. Discover movies, TV shows, and anime with AI-powered recommendations.">
  <title>CineBrain - The Mind Behind Your Next Favorite</title>
  
  <!-- Preload Critical Resources -->
  <link rel="preload" href="/css/main.css" as="style">
  <link rel="preload" href="/css/components.css" as="style">
  <link rel="preload" href="/js/config.js" as="script">
  <link rel="preload" href="/js/api.js" as="script">
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
  
  <!-- Favicon & PWA -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta name="theme-color" content="#3b82f6">
  
  <!-- Open Graph -->
  <meta property="og:title" content="CineBrain - AI-Powered Movie Recommendations">
  <meta property="og:description" content="Discover your next favorite movie, TV show, or anime with our premium recommendation engine.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cinebrain.vercel.app">
  <meta property="og:image" content="/og-image.jpg">
  
  <!-- Performance Hints -->
  <link rel="dns-prefetch" href="//backend-app-970m.onrender.com">
  <link rel="preconnect" href="https://backend-app-970m.onrender.com">
  <link rel="preconnect" href="https://image.tmdb.org">
  <link rel="preconnect" href="https://ui-avatars.com">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>
  
  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <!-- Hero Section with Real Trending Content -->
      <section class="hero-section" id="hero-section">
        <div class="hero-backdrop">
          <img id="hero-backdrop-img" src="" alt="Hero Movie" loading="eager">
        </div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-info">
            <h1 class="hero-title" id="hero-title">Loading...</h1>
            <p class="hero-description" id="hero-description">Discovering amazing content for you...</p>
            <div class="hero-meta" id="hero-meta">
              <div class="rating-badge">
                <span>‚≠ê</span>
                <span id="hero-rating">8.5</span>
              </div>
              <div class="type-badge" id="hero-type">MOVIE</div>
              <div class="badge badge-outline" id="hero-year">2024</div>
            </div>
            <div class="hero-actions">
              <button class="hero-btn hero-btn-primary" id="hero-play-btn" onclick="playHeroContent()">
                ‚ñ∂Ô∏è Watch Trailer
              </button>
              <button class="hero-btn hero-btn-secondary" id="hero-info-btn" onclick="viewHeroDetails()">
                ‚ÑπÔ∏è More Info
              </button>
              <button class="hero-btn hero-btn-secondary" id="hero-watchlist-btn" onclick="addHeroToWatchlist()">
                üìã Add to List
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Trending Content -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">Trending Now</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="loadTrendingMovies()">Movies</button>
            <button class="section-btn" onclick="loadTrendingTV()">TV Shows</button>
            <button class="section-btn" onclick="loadTrendingAnime()">Anime</button>
            <button class="section-btn" onclick="viewAllTrending()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="trending-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="trending-track">
                <!-- Real-time trending content loaded here -->
                <div class="loading-skeleton skeleton-card"></div>
                <div class="loading-skeleton skeleton-card"></div>
                <div class="loading-skeleton skeleton-card"></div>
                <div class="loading-skeleton skeleton-card"></div>
                <div class="loading-skeleton skeleton-card"></div>
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="trendingCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="trendingCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>

      <!-- New Releases -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">New Releases</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="viewAllNewReleases()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="newreleases-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="newreleases-track">
                <!-- Real-time new releases loaded here -->
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="newReleasesCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="newReleasesCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>

      <!-- Critics' Choice -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">Critics' Choice</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="viewAllCriticsChoice()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="critics-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="critics-track">
                <!-- Real-time critics choice loaded here -->
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="criticsCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="criticsCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>

      <!-- Regional Favorites -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">Regional Favorites</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="loadRegionalContent('hindi')">Hindi</button>
            <button class="section-btn" onclick="loadRegionalContent('telugu')">Telugu</button>
            <button class="section-btn" onclick="loadRegionalContent('tamil')">Tamil</button>
            <button class="section-btn" onclick="loadRegionalContent('kannada')">Kannada</button>
            <button class="section-btn" onclick="viewAllRegional()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="regional-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="regional-track">
                <!-- Real-time regional content loaded here -->
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="regionalCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="regionalCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>

      <!-- Anime Section -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">Popular Anime</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="loadAnimeByGenre('action')">Action</button>
            <button class="section-btn" onclick="loadAnimeByGenre('romance')">Romance</button>
            <button class="section-btn" onclick="loadAnimeByGenre('comedy')">Comedy</button>
            <button class="section-btn" onclick="viewAllAnime()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="anime-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="anime-track">
                <!-- Real-time anime content loaded here -->
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="animeCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="animeCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>

      <!-- Admin's Choice (Public Feed) -->
      <section class="content-section">
        <div class="section-header">
          <h2 class="section-title">Admin's Choice</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="viewAllAdminChoice()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="admin-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="admin-track">
                <!-- Real-time admin recommendations loaded here -->
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="adminCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="adminCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>

      <!-- Personalized Recommendations (Auth Users Only) -->
      <section class="content-section" id="personalized-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title">Recommended for You</h2>
          <div class="section-actions">
            <button class="section-btn" onclick="refreshPersonalizedRecommendations()">üîÑ Refresh</button>
            <button class="section-btn" onclick="viewAllPersonalized()">View All</button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="content-carousel" id="personalized-carousel">
            <div class="carousel-container">
              <div class="carousel-track" id="personalized-track">
                <!-- Real-time personalized content loaded here -->
              </div>
            </div>
            <button class="carousel-btn carousel-prev" onclick="personalizedCarousel.prev()">‚Äπ</button>
            <button class="carousel-btn carousel-next" onclick="personalizedCarousel.next()">‚Ä∫</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Theme Toggle -->
  <div class="theme-toggle-wrapper">
    <button class="theme-toggle" onclick="app.toggleTheme()">
      <span class="theme-toggle-icon moon">üåô</span>
      <span class="theme-toggle-icon sun">‚òÄÔ∏è</span>
    </button>
  </div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    // Global carousel instances
    let trendingCarousel, newReleasesCarousel, criticsCarousel, regionalCarousel, animeCarousel, adminCarousel, personalizedCarousel;
    let currentHeroContent = null;

    // Initialize homepage when DOM and app are ready
    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      // Wait for app to be ready
      window.addEventListener('appReady', function() {
        initializeHomepage();
      });
      
      // Initialize immediately if app is already ready
      if (window.app && window.app.isInitialized) {
        initializeHomepage();
      }
    });

    // Load reusable components
    async function loadComponents() {
      try {
        // Load topbar
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        // Load mobile navigation
        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    // Initialize homepage with real data
    async function initializeHomepage() {
      try {
        // Initialize carousels
        initializeCarousels();
        
        // Load hero content
        await loadHeroContent();
        
        // Load all sections in parallel for maximum performance
        await Promise.all([
          loadTrendingContent(),
          loadNewReleases(),
          loadCriticsChoice(),
          loadRegionalContent('hindi'),
          loadAnimeContent(),
          loadAdminChoice()
        ]);
        
        // Load personalized content if user is authenticated
        if (Auth.isAuthenticated()) {
          document.getElementById('personalized-section').style.display = 'block';
          await loadPersonalizedContent();
        }
        
        // Setup auth state listeners
        setupAuthListeners();
        
        console.log('üè† Homepage initialized with real-time data');
        
      } catch (error) {
        console.error('Homepage initialization error:', error);
        showToast('Failed to load content', 'error');
      }
    }

    // Initialize all carousels
    function initializeCarousels() {
      trendingCarousel = new ContentCarousel(document.getElementById('trending-carousel'));
      newReleasesCarousel = new ContentCarousel(document.getElementById('newreleases-carousel'));
      criticsCarousel = new ContentCarousel(document.getElementById('critics-carousel'));
      regionalCarousel = new ContentCarousel(document.getElementById('regional-carousel'));
      animeCarousel = new ContentCarousel(document.getElementById('anime-carousel'));
      adminCarousel = new ContentCarousel(document.getElementById('admin-carousel'));
      personalizedCarousel = new ContentCarousel(document.getElementById('personalized-carousel'));
    }

    // Load hero content from real trending data
    async function loadHeroContent() {
      try {
        const trendingData = await ContentAPI.getTrending('all', 5);
        const heroContent = trendingData.recommendations?.[0] || trendingData[0];
        
        if (heroContent) {
          currentHeroContent = heroContent;
          updateHeroSection(heroContent);
        }
      } catch (error) {
        console.error('Hero content error:', error);
        // Fallback to static hero
        updateHeroSection({
          title: 'CineBrain',
          overview: 'Discover your next favorite movie, TV show, or anime with AI-powered recommendations.',
          backdrop_path: '/images/hero-fallback.jpg',
          rating: 9.0,
          content_type: 'platform'
        });
      }
    }

    // Update hero section with real content
    function updateHeroSection(content) {
      document.getElementById('hero-title').textContent = content.title;
      document.getElementById('hero-description').textContent = content.overview || 'Discover amazing content';
      document.getElementById('hero-rating').textContent = content.rating?.toFixed(1) || '8.5';
      document.getElementById('hero-type').textContent = content.content_type?.toUpperCase() || 'CONTENT';
      
      const backdropImg = document.getElementById('hero-backdrop-img');
      if (content.backdrop_path) {
        const backdropUrl = content.backdrop_path.startsWith('http') 
          ? content.backdrop_path 
          : `https://image.tmdb.org/t/p/w1280${content.backdrop_path}`;
        backdropImg.src = backdropUrl;
        backdropImg.alt = content.title;
      }
      
      // Set release year if available
      if (content.release_date) {
        const year = new Date(content.release_date).getFullYear();
        document.getElementById('hero-year').textContent = year;
      }
    }

    // Load trending content with real API data
    async function loadTrendingContent() {
      try {
        const data = await ContentAPI.getTrending('all', 20);
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('trending-track', content);
          trendingCarousel.updateItems();
        }
      } catch (error) {
        console.error('Trending content error:', error);
        showErrorInCarousel('trending-track', 'Failed to load trending content');
      }
    }

    // Load new releases with real API data
    async function loadNewReleases() {
      try {
        const data = await ContentAPI.getNewReleases('movie', null, 15);
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('newreleases-track', content);
          newReleasesCarousel.updateItems();
        }
      } catch (error) {
        console.error('New releases error:', error);
        showErrorInCarousel('newreleases-track', 'Failed to load new releases');
      }
    }

    // Load critics choice with real API data
    async function loadCriticsChoice() {
      try {
        const data = await ContentAPI.getCriticsChoice('movie', 15);
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('critics-track', content);
          criticsCarousel.updateItems();
        }
      } catch (error) {
        console.error('Critics choice error:', error);
        showErrorInCarousel('critics-track', 'Failed to load critics choice');
      }
    }

    // Load regional content with real API data
    async function loadRegionalContent(language = 'hindi') {
      try {
        const data = await API.get(`/recommendations/regional/${language}`, { limit: 15 });
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('regional-track', content);
          regionalCarousel.updateItems();
        }
      } catch (error) {
        console.error('Regional content error:', error);
        showErrorInCarousel('regional-track', 'Failed to load regional content');
      }
    }

    // Load anime content with real API data
    async function loadAnimeContent() {
      try {
        const data = await ContentAPI.getAnime(null, 15);
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('anime-track', content);
          animeCarousel.updateItems();
        }
      } catch (error) {
        console.error('Anime content error:', error);
        showErrorInCarousel('anime-track', 'Failed to load anime content');
      }
    }

    // Load admin choice with real API data
    async function loadAdminChoice() {
      try {
        const data = await API.get('/recommendations/admin-choice', { limit: 15 });
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('admin-track', content);
          adminCarousel.updateItems();
        }
      } catch (error) {
        console.error('Admin choice error:', error);
        showErrorInCarousel('admin-track', 'Failed to load admin recommendations');
      }
    }

    // Load personalized content for authenticated users
    async function loadPersonalizedContent() {
      try {
        const data = await Auth.getPersonalizedRecommendations();
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          renderCarouselContent('personalized-track', content);
          personalizedCarousel.updateItems();
        }
      } catch (error) {
        console.error('Personalized content error:', error);
        showErrorInCarousel('personalized-track', 'Failed to load personalized recommendations');
      }
    }

    // Render content in carousel track
    function renderCarouselContent(trackId, content) {
      const track = document.getElementById(trackId);
      track.innerHTML = '';
      
      content.forEach(item => {
        const card = app.createContentCard(item);
        track.appendChild(card);
      });
    }

    // Show error message in carousel
    function showErrorInCarousel(trackId, message) {
      const track = document.getElementById(trackId);
      track.innerHTML = `
        <div class="error-state">
          <h3>üòî Oops!</h3>
          <p>${message}</p>
          <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
        </div>
      `;
    }

    // Hero action handlers
    function playHeroContent() {
      if (currentHeroContent && currentHeroContent.id) {
        app.playTrailer(currentHeroContent.id);
      } else {
        showToast('Trailer not available', 'warning');
      }
    }

    function viewHeroDetails() {
      if (currentHeroContent && currentHeroContent.id) {
        window.location.href = `/content/details.html?id=${currentHeroContent.id}`;
      }
    }

    function addHeroToWatchlist() {
      if (currentHeroContent && currentHeroContent.id) {
        app.toggleWishlist(currentHeroContent.id);
      }
    }

    // Section action handlers
    function loadTrendingMovies() {
      ContentAPI.getTrending('movie', 20).then(data => {
        const content = data.recommendations || data;
        renderCarouselContent('trending-track', content);
        trendingCarousel.updateItems();
      });
    }

    function loadTrendingTV() {
      ContentAPI.getTrending('tv', 20).then(data => {
        const content = data.recommendations || data;
        renderCarouselContent('trending-track', content);
        trendingCarousel.updateItems();
      });
    }

    function loadTrendingAnime() {
      ContentAPI.getAnime(null, 20).then(data => {
        const content = data.recommendations || data;
        renderCarouselContent('trending-track', content);
        trendingCarousel.updateItems();
      });
    }

    function loadAnimeByGenre(genre) {
      ContentAPI.getAnime(genre, 15).then(data => {
        const content = data.recommendations || data;
        renderCarouselContent('anime-track', content);
        animeCarousel.updateItems();
      });
    }

    function refreshPersonalizedRecommendations() {
      loadPersonalizedContent();
      showToast('Recommendations refreshed', 'success');
    }

    // Navigation handlers
    function viewAllTrending() {
      window.location.href = '/content/trending.html';
    }

    function viewAllNewReleases() {
      window.location.href = '/content/new-releases.html';
    }

    function viewAllCriticsChoice() {
      window.location.href = '/content/critics-choice.html';
    }

    function viewAllRegional() {
      window.location.href = '/content/regional.html';
    }

    function viewAllAnime() {
      window.location.href = '/content/anime.html';
    }

    function viewAllAdminChoice() {
      window.location.href = '/content/admin-choice.html';
    }

    function viewAllPersonalized() {
      if (Auth.isAuthenticated()) {
        window.location.href = `/user/recommendations.html`;
      } else {
        window.location.href = '/auth/login.html';
      }
    }

    // Setup authentication event listeners
    function setupAuthListeners() {
      window.addEventListener('userLoggedIn', function() {
        document.getElementById('personalized-section').style.display = 'block';
        loadPersonalizedContent();
        showToast('Welcome back! Loading your personalized recommendations...', 'success');
      });

      window.addEventListener('userLoggedOut', function() {
        document.getElementById('personalized-section').style.display = 'none';
        showToast('See you soon!', 'info');
      });
    }
  </script>
</body>
</html>