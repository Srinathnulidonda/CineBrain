memorize my frontent files

1. Recommendation.html 
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- Navigation detection meta tags -->
    <meta name="page-section" content="recommendations">
    <meta name="page-title" content="Recommendations">

    <title>CineBrain Admin - Content Recommendations & Management</title>
    <!-- Security Headers - Updated CSP -->
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
    img-src 'self' data: blob: https: http:;
    connect-src 'self' https://cinebrain.onrender.com https://api.themoviedb.org https://api.jikan.moe https://localhost:5000 http://127.0.0.1:5000 ws://localhost:* wss://localhost:* ws://127.0.0.1:* wss://127.0.0.1:* ws://cinebrain.onrender.com wss://cinebrain.onrender.com https://cdn.jsdelivr.net;
    base-uri 'self';
    form-action 'self';
    object-src 'none';
  ">
    <!-- Meta Tags -->
    <meta name="description"
        content="CineBrain Admin Recommendations - Manage content recommendations, search external APIs, and curate movie/TV/anime content">
    <meta name="robots" content="noindex, nofollow">
    <meta name="author" content="CineBrain">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-icon-180x180.png">

    <!-- Preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- Core CSS -->
    <link rel="stylesheet" href="/assets/css/components/theme.css">
    <link rel="stylesheet" href="/assets/css/components/topbar.css">
    <link rel="stylesheet" href="/assets/css/components/mobile-nav.css">
    <link rel="stylesheet" href="/assets/css/components/footer.css">

    <!-- Recommendations CSS -->
    <link rel="stylesheet" href="/assets/css/admin/rec/recommendations.css">
    <link rel="stylesheet" href="/assets/css/admin/rec/rec-telegram.css">

    <!-- Theme Initialization -->
    <script>
        (function () {
            try {
                const savedTheme = localStorage.getItem('cinebrain-theme');
                const theme = (savedTheme === 'light' || savedTheme === 'dark') ? savedTheme : 'dark';
                document.documentElement.setAttribute('data-theme', theme);
                document.documentElement.setAttribute('data-bs-theme', theme);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            }
        })();
    </script>
</head>

<body class="admin-recommendations">
    <!-- Skip Link -->
    <a href="#main-content" class="visually-hidden-focusable">Skip to main content</a>

    <!-- Loading Indicator -->
    <div id="page-loading-indicator" class="page-loading-indicator"></div>

    <header>
        <nav class="navbar navbar-expand-lg navbar-cinebrain fixed-top" role="navigation" aria-label="Main navigation">
            <div class="container-fluid">
                <div class="navbar-brand-wrapper">
                    <a href="/" style="text-decoration: none;" aria-label="CineBrain Admin Home">
                        <h1 class="navbar-brand-cinebrain">CineBrain</h1>
                        <div class="tagline">
                            <span class="tagline-full d-none d-md-block">Recommendations</span>
                            <span class="tagline-medium d-none d-sm-block d-md-none">Recommendations</span>
                            <span class="tagline-short d-sm-none">Recs</span>
                        </div>
                    </a>
                </div>

                <div class="search-container desktop-search d-none d-lg-block" id="desktopSearchContainer">
                    <div class="search-wrapper">
                        <div class="search-bar-wrapper">
                            <div class="search-input-wrapper">
                                <i data-feather="search" class="search-icon" aria-hidden="true"></i>
                                <input type="text" class="form-control search-input" id="desktopSearchInput"
                                    placeholder="Search movies, shows, anime..." autocomplete="off"
                                    aria-label="Search content" maxlength="100">
                                <button class="search-clear" id="searchClear" aria-label="Clear search"
                                    style="display: none;">
                                    <i data-feather="x" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="search-results" id="desktopSearchResults" role="listbox" aria-live="polite">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-icons-section">
                    <button class="icon-button mobile-search-trigger d-lg-none" id="mobileSearchTrigger"
                        aria-label="Open search">
                        <i data-feather="search" aria-hidden="true"></i>
                    </button>

                    <button class="icon-button theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <i data-feather="sun" class="theme-icon theme-icon-light" aria-hidden="true"></i>
                        <i data-feather="moon" class="theme-icon theme-icon-dark" aria-hidden="true"></i>
                    </button>

                    <button class="icon-button notification-bell" id="notificationBell"
                        aria-label="Admin notifications">
                        <i data-feather="bell" aria-hidden="true"></i>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>

                    <!-- Notification dropdown -->
                    <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
                        <div class="notification-dropdown-header">
                            <h4 class="notification-dropdown-title">
                                <i data-feather="bell"></i>
                                Notifications
                            </h4>
                            <button class="notification-dropdown-close" id="closeNotificationDropdown">
                                <i data-feather="x"></i>
                            </button>
                        </div>
                        <div class="notification-dropdown-content" id="notificationDropdownContent">
                            <div class="notification-loading">Loading notifications...</div>
                        </div>
                        <div class="notification-dropdown-footer">
                            <button class="btn-text" id="markAllNotificationsReadBtn">Mark all as read</button>
                        </div>
                    </div>

                    <div class="dropdown">
                        <button class="avatar-menu" data-bs-toggle="dropdown" aria-expanded="false" id="avatarMenu">
                            <i data-feather="user" aria-hidden="true"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-cinebrain" id="userDropdown">
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Mobile Search Overlay -->
    <div class="mobile-search-overlay" id="mobileSearchOverlay">
        <div class="container">
            <div class="mobile-search-header">
                <button class="btn-back" id="closeMobileSearch">
                    <i data-feather="arrow-left"></i>
                </button>
                <div class="mobile-search-input-wrapper">
                    <i data-feather="search" class="search-icon"></i>
                    <input type="text" class="form-control search-input" id="mobileSearchInput"
                        placeholder="Search content..." autocomplete="off" autofocus>
                </div>
            </div>
            <div class="search-results mobile-results" id="mobileSearchResults">
            </div>
        </div>
    </div>

    <main id="main-content" class="admin-main" role="main">
        <!-- Recommendations Content -->
        <div class="container-fluid admin-container">

            <!-- Breadcrumb Navigation -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/admin/index.html">
                            <i data-feather="home"></i>
                            <span class="d-none d-sm-inline">Dashboard</span>
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i data-feather="star"></i>
                        Recommendations
                    </li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="page-header">
                        <div class="page-header-content">
                            <h1 class="page-title">
                                Content Recommendations
                            </h1>
                            <p class="page-subtitle">
                                Search, curate, and manage content recommendations for CineBrain users
                            </p>
                        </div>
                        <div class="page-header-actions">
                            <button class="btn btn-outline-primary btn-sm" id="viewRecommendationAnalytics">
                                <i data-feather="bar-chart"></i>
                                <span class="d-none d-sm-inline">Analytics</span>
                            </button>
                            <button class="btn btn-primary btn-sm" id="createRecommendationBtn">
                                <i data-feather="plus"></i>
                                <span class="d-none d-sm-inline">New Recommendation</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="recommendations-status-bar">
                        <div class="status-main-indicators">
                            <div class="status-item">
                                <span class="status-dot green" id="telegramStatusDot"></span>
                                <span class="status-text">Telegram: <span id="telegramStatus">Connected</span></span>
                            </div>
                            <div class="status-item d-none d-sm-flex">
                                <i data-feather="database" class="status-icon"></i>
                                <span class="status-text">TMDB: <span id="tmdbStatus">Online</span></span>
                            </div>
                            <div class="status-item d-none d-md-flex">
                                <i data-feather="globe" class="status-icon"></i>
                                <span class="status-text">Jikan: <span id="jikanStatus">Online</span></span>
                            </div>
                        </div>

                        <div class="status-meta-info d-none d-sm-flex">
                            <div class="status-item">
                                <i data-feather="clock" class="status-icon"></i>
                                <span class="status-text">Last Sync: <span id="lastSync">--</span></span>
                            </div>
                        </div>

                        <div class="status-actions">
                            <button class="btn btn-sm btn-outline-success" id="syncExternalAPIs"
                                title="Sync External APIs">
                                <i data-feather="rotate-cw"></i>
                                <span class="d-none d-sm-inline">Sync</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="quick-stats-grid" id="quickStatsGrid">
                        <!-- Quick stats will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <section class="content-navigation">
                <div class="nav-tabs-wrapper">
                    <button class="nav-tab active" data-tab="search" role="tab"
                        onclick="window.recommendationsManager.switchTab('search')" aria-selected="true"
                        title="Search Content">
                        <i data-feather="search"></i>
                        <span class="tab-text">Search Content</span>
                    </button>
                    <button class="nav-tab" data-tab="recommendations" role="tab"
                        onclick="window.recommendationsManager.switchTab('recommendations')" aria-selected="false"
                        title="My Recommendations">
                        <i data-feather="star"></i>
                        <span class="tab-text">Recommendations</span>
                        <span class="tab-badge" id="recommendationsCount">0</span>
                    </button>
                    <button class="nav-tab" data-tab="saved-content" role="tab"
                        onclick="window.recommendationsManager.switchTab('saved-content')" aria-selected="false"
                        title="Draft Recommendations">
                        <i data-feather="edit"></i>
                        <span class="tab-text">Drafts</span>
                        <span class="tab-badge" id="savedContentCount">0</span>
                    </button>
                    <button class="nav-tab" data-tab="analytics" role="tab"
                        onclick="window.recommendationsManager.switchTab('analytics')" aria-selected="false"
                        title="Analytics">
                        <i data-feather="trending-up"></i>
                        <span class="tab-text">Analytics</span>
                    </button>
                </div>
            </section>

            <!-- Tab Content -->
            <div class="tab-content-container">
                <!-- Search Content Tab - FIXED DESKTOP LAYOUT -->
                <div class="tab-pane active" id="search-content" role="tabpanel">
                    <div class="search-content-wrapper">
                        <!-- Professional Search Controls - FIXED DESKTOP LAYOUT -->
                        <div class="search-controls">
                            <div class="search-input-group">
                                <div class="search-input-wrapper">
                                    <i data-feather="search" class="search-icon"></i>
                                    <input type="text" class="search-input" id="contentSearchInput"
                                        placeholder="Search movies, TV shows, anime..." autocomplete="off"
                                        maxlength="100">
                                    <button class="search-clear" id="contentSearchClear">
                                        <i data-feather="x"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="filter-separator"></div>

                            <div class="search-filters">
                                <select class="form-select" id="searchSource">
                                    <option value="tmdb">TMDB</option>
                                    <option value="anime">Anime</option>
                                </select>
                                <select class="form-select" id="searchType">
                                    <option value="all">All</option>
                                    <option value="movie">Movies</option>
                                    <option value="tv">TV Shows</option>
                                </select>
                                <button class="btn-search" id="performSearch">
                                    <i data-feather="search"></i>
                                    <span>Search</span>
                                </button>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div class="search-results-container" id="searchResultsContainer">
                            <div class="search-results-header" style="display: none;">
                                <div class="results-info">
                                    <span class="results-count" id="resultsCount">0 results</span>
                                    <span class="results-source" id="resultsSource">TMDB</span>
                                </div>
                                <div class="results-actions">
                                    <select class="form-select form-select-sm" id="resultsSortBy">
                                        <option value="popularity">Popularity</option>
                                        <option value="rating">Rating</option>
                                        <option value="release_date">Release Date</option>
                                        <option value="title">Title</option>
                                    </select>
                                </div>
                            </div>

                            <div class="search-results-grid" id="searchResultsGrid">
                                <!-- Search results will be populated here -->
                            </div>

                            <div class="search-pagination" id="searchPagination" style="display: none;">
                                <!-- Pagination will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Tab -->
                <div class="tab-pane" id="recommendations-content" role="tabpanel">
                    <div class="recommendations-wrapper">
                        <!-- Recommendations Controls - Update the selects -->
                        <div class="recommendations-controls">
                            <div class="controls-left">
                                <div class="filter-group">
                                    <select class="form-select form-select-sm" id="recommendationsSort">
                                        <option value="created_at">Latest</option>
                                        <option value="updated_at">Recently Updated</option>
                                        <option value="type">Type</option>
                                    </select>
                                    <select class="form-select form-select-sm" id="recommendationsFilter">
                                        <option value="all">All Recommendations</option>
                                        <option value="active">Active</option>
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                    </select>
                                </div>
                            </div>

                            <div class="controls-right">
                                <button class="btn btn-outline-secondary btn-sm" id="refreshRecommendations">
                                    <i data-feather="rotate-cw"></i>
                                    <span class="d-none d-sm-inline">Refresh</span>
                                </button>
                                <button class="btn btn-primary btn-sm" id="bulkActionsBtn">
                                    <i data-feather="send"></i>
                                    <span class="d-none d-sm-inline">Bulk Send</span>
                                </button>
                            </div>
                        </div>

                        <!-- Recommendations List -->
                        <div class="recommendations-list-container" id="recommendationsListContainer">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Draft Recommendations Tab -->
                <div class="tab-pane" id="saved-content" role="tabpanel">
                    <div class="saved-content-wrapper">
                        <!-- Saved Content Controls - Update the selects -->
                        <div class="saved-content-controls">
                            <div class="controls-left">
                                <div class="filter-group">
                                    <select class="form-select form-select-sm" id="savedContentFilter">
                                        <option value="all">All Types</option>
                                        <option value="featured">Featured</option>
                                        <option value="hidden_gem">Hidden Gems</option>
                                        <option value="trending">Trending</option>
                                        <option value="classic">Classics</option>
                                        <option value="new_release">New Releases</option>
                                        <option value="mind_bending">Mind-Bending</option>
                                        <option value="anime_gem">Anime Gems</option>
                                        <option value="scene_clip">Scene Clips</option>
                                        <option value="top_list">Top Lists</option>
                                    </select>
                                    <input type="text" class="form-control form-control-sm search-input"
                                        id="savedContentSearch" placeholder="Search drafts...">
                                </div>
                            </div>

                            <div class="controls-right">
                                <button class="btn btn-outline-secondary btn-sm" id="refreshSavedContent">
                                    <i data-feather="rotate-cw"></i>
                                    <span class="d-none d-sm-inline">Refresh</span>
                                </button>
                                <button class="btn btn-outline-primary btn-sm" id="bulkContentActions">
                                    <i data-feather="edit"></i>
                                    <span class="d-none d-sm-inline">Bulk Edit</span>
                                </button>
                            </div>
                        </div>

                        <!-- Draft Recommendations Grid -->
                        <div class="saved-content-grid" id="savedContentGrid">
                            <!-- Draft recommendations will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane" id="analytics-content" role="tabpanel">
                    <div class="analytics-wrapper">
                        <!-- Analytics Charts -->
                        <div class="row">
                            <div class="col-12 col-lg-6 mb-4">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            <i data-feather="trending-up"></i>
                                            Recommendation Performance
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="recommendationPerformanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6 mb-4">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            <i data-feather="pie-chart"></i>
                                            Content Distribution
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="contentDistributionChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Metrics -->
                        <div class="analytics-metrics" id="analyticsMetrics">
                            <!-- Analytics metrics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Create Recommendation Modal with Template Support -->
    <div class="modal fade" id="enhancedCreateRecommendationModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i data-feather="star"></i>
                        Create Recommendation with Template
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Content Preview -->
                    <div class="content-preview mb-4" id="modalContentPreview">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Template Selection -->
                    <div class="template-selection-container mb-4">
                        <h6 class="template-section-title">
                            <i data-feather="layout"></i>
                            Choose Template Style
                        </h6>
                        <div class="template-grid" id="templateGrid">
                            <!-- Templates populated by JavaScript -->
                        </div>

                        <!-- Template Description Box - MOVED INSIDE template-selection-container -->
                        <div class="template-guidance" id="templateGuidance" style="display: none;">
                            <div class="guidance-card">
                                <div class="guidance-content" id="guidanceContent">
                                    <!-- Guidance populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Template-Specific Fields - SEPARATE FROM TEMPLATE SELECTION -->
                    <div class="template-fields" id="templateFieldsContainer" style="display: none;">
                        <!-- Template fields populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveTemplateDraftBtn">
                        <i data-feather="bookmark"></i>
                        Save as Draft
                    </button>
                    <button type="button" class="btn btn-primary" id="publishTemplateBtn">
                        <i data-feather="send"></i>
                        Publish to Telegram
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-bottom-nav d-md-none" id="mobileBottomNav">
        <div class="mobile-nav-container" id="mobileNavContainer">
        </div>
    </nav>

    <!-- Mobile Menu -->
    <aside class="mobile-menu-overlay" id="mobileMenuOverlay">
        <div class="menu-handle"></div>
        <div class="menu-header">
            <h3 class="menu-title">Recommendations Menu</h3>
            <button class="menu-close-btn" id="mobileMenuClose">
                <i data-feather="x"></i>
            </button>
        </div>
        <section class="menu-section">
            <div class="mobile-menu-grid" id="mobileMenuGrid">
            </div>
        </section>
        <section class="menu-section">
            <h4 class="menu-section-title" id="userSectionTitle">Quick Actions</h4>
            <div class="mobile-menu-list" id="mobileMenuList">
            </div>
        </section>
    </aside>

    <!-- Mobile Backdrop -->
    <div class="mobile-backdrop" id="mobileBackdrop"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Core JS -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/components/theme-manager.js"></script>
    <script src="/assets/js/components/topbar.js"></script>
    <script src="/assets/js/components/mobile-nav.js"></script>

    <!-- Recommendations JS -->
    <script src="/assets/js/admin/rec/rec-utils.js"></script>
    <script src="/assets/js/admin/rec/rec-search.js"></script>
    <script src="/assets/js/admin/rec/rec-recommendations.js"></script>
    <script src="/assets/js/admin/rec/rec-upcoming.js"></script>
    <script src="/assets/js/admin/rec/recommendations.js"></script>
    <script src="/assets/js/admin/rec/rec-telegram.js"></script>

    <!-- Initialize Feather Icons -->
    <script>
        // Initialize Feather icons when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });

        // Re-initialize icons after dynamic content updates
        function refreshFeatherIcons() {
            setTimeout(() => {
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }, 100);
        }

        // Make refreshFeatherIcons globally available
        window.refreshFeatherIcons = refreshFeatherIcons;
    </script>
</body>

</html>


2. rec-recommendations.js
class RecRecommendations {
    constructor(manager) {
        this.manager = manager;
        this.initializeElements();
        this.setupEventListeners();
        console.log('‚úÖ RecRecommendations module initialized');
    }

    initializeElements() {
        this.elements = {
            recommendationsListContainer: document.getElementById('recommendationsListContainer'),
            recommendationsFilter: document.getElementById('recommendationsFilter'),
            recommendationsSort: document.getElementById('recommendationsSort'),
            refreshRecommendations: document.getElementById('refreshRecommendations'),
            bulkActionsBtn: document.getElementById('bulkActionsBtn'),
            analyticsMetrics: document.getElementById('analyticsMetrics')
        };
    }

    setupEventListeners() {
        this.elements.recommendationsFilter?.addEventListener('change', () => {
            this.manager.state.filters.recommendations = this.elements.recommendationsFilter.value;
            this.manager.loadRecommendations();
        });

        // Add sort listener
        this.elements.recommendationsSort?.addEventListener('change', () => {
            this.manager.state.sorting.recommendations = this.elements.recommendationsSort.value;
            this.manager.loadRecommendations();
        });

        this.elements.refreshRecommendations?.addEventListener('click', () => {
            this.manager.loadRecommendations(true);
        });

        this.elements.bulkActionsBtn?.addEventListener('click', () => {
            this.showBulkActionsModal();
        });
    }

    renderRecommendations() {
        if (!this.elements.recommendationsListContainer) return;

        if (this.manager.state.recommendations.length === 0) {
            this.elements.recommendationsListContainer.classList.remove('active');
            this.elements.recommendationsListContainer.innerHTML = window.recUtils.getEmptyState(
                'star',
                'No active recommendations yet',
                'Create your first recommendation to get started',
                false
            );
            this.updateTabContainerHeight();
            window.recUtils.refreshFeatherIcons();
            return;
        }

        this.elements.recommendationsListContainer.innerHTML = this.manager.state.recommendations.map(rec =>
            this.createRecommendationItem(rec)
        ).join('');

        this.elements.recommendationsListContainer.classList.add('active');
        this.updateTabContainerHeight();
        window.recUtils.refreshFeatherIcons();
    }

    createRecommendationItem(recommendation) {
        const posterUrl = window.recUtils.getPosterUrl(recommendation.content);
        const statusColor = this.getRecommendationStatusColor(recommendation.recommendation_type);
        const date = this.manager.formatTimeAgo(recommendation.created_at);
        const isActive = recommendation.is_active !== false;

        // NEW: Check if recommendation has template data
        const hasTemplateData = recommendation.template_data && recommendation.template_data.selected_template;
        const templateIndicator = hasTemplateData ?
            `<span class="template-indicator" title="Created with ${recommendation.template_data.selected_template} template">üìù</span>` : '';

        return `
            <div class="recommendation-item" style="--recommendation-status-color: ${statusColor}">
                <div class="recommendation-poster">
                    <img src="${posterUrl}" alt="${recommendation.content?.title || 'Content'}" loading="lazy">
                </div>
                <div class="recommendation-content">
                    <div class="recommendation-header">
                        <h3 class="recommendation-title">
                            ${recommendation.content?.title || 'Unknown Title'}
                            ${templateIndicator}
                        </h3>
                        <div class="recommendation-type" style="background-color: ${statusColor}">
                            ${this.manager.capitalizeFirst(recommendation.recommendation_type)}
                        </div>
                    </div>
                    <p class="recommendation-description">${recommendation.description || 'No description'}</p>
                    <div class="recommendation-meta">
                        <span class="recommendation-date">${date}</span>
                        <span class="recommendation-status ${isActive ? 'active' : 'inactive'}">${isActive ? 'active' : 'draft'}</span>
                        ${hasTemplateData ? '<span class="template-badge">Template</span>' : ''}
                        <div class="recommendation-actions">
                            <button class="recommendation-action" onclick="window.recRecommendations.editRecommendation(${recommendation.id})">
                                <i data-feather="edit"></i>
                                ${hasTemplateData ? 'Enhanced Edit' : 'Edit'}
                            </button>
                            <button class="recommendation-action primary" onclick="window.recRecommendations.sendToTelegram(${recommendation.id})">
                                <i data-feather="send"></i>
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async editRecommendation(recommendationId) {
        try {
            const response = await this.manager.makeAuthenticatedRequest(`/admin/recommendations/${recommendationId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch recommendation details');
            }

            const recommendation = await response.json();

            // Use enhanced template modal for editing (same as upcoming)
            if (window.recUpcoming) {
                window.recUpcoming.showEnhancedEditModal(recommendation);
            } else {
                // Fallback to simple modal if recUpcoming not available
                this.showEditRecommendationModal(recommendation);
            }

        } catch (error) {
            console.error('Edit recommendation error:', error);
            this.manager.showError('Failed to open edit form: ' + error.message);
        }
    }

    // Keep the old modal as fallback but update it to be more consistent
    showEditRecommendationModal(recommendation) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'editRecommendationModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i data-feather="edit"></i>
                            Edit Recommendation (Simple)
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i data-feather="info"></i>
                            For advanced template editing, please use the enhanced edit from the drafts section.
                        </div>
                        
                        <div class="content-preview mb-4">
                            <div class="row">
                                <div class="col-3">
                                    <img src="${window.recUtils.getPosterUrl(recommendation.content)}" 
                                         alt="${recommendation.content?.title}" 
                                         class="img-fluid rounded">
                                </div>
                                <div class="col-9">
                                    <h6>${recommendation.content?.title || 'Unknown Title'}</h6>
                                    <p class="text-muted mb-2">${recommendation.content?.content_type || 'movie'}</p>
                                    <p class="small">${(recommendation.content?.overview || '').substring(0, 150)}...</p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="editRecommendationForm">
                            <div class="mb-3">
                                <label for="editRecommendationType" class="form-label">Recommendation Type</label>
                                <select class="form-select" id="editRecommendationType" required>
                                    <option value="featured" ${recommendation.recommendation_type === 'featured' ? 'selected' : ''}>Featured Pick</option>
                                    <option value="trending" ${recommendation.recommendation_type === 'trending' ? 'selected' : ''}>Trending Now</option>
                                    <option value="hidden_gem" ${recommendation.recommendation_type === 'hidden_gem' ? 'selected' : ''}>Hidden Gem</option>
                                    <option value="classic" ${recommendation.recommendation_type === 'classic' ? 'selected' : ''}>Classic Must-Watch</option>
                                    <option value="new_release" ${recommendation.recommendation_type === 'new_release' ? 'selected' : ''}>New Release</option>
                                    <option value="mind_bending" ${recommendation.recommendation_type === 'mind_bending' ? 'selected' : ''}>Mind-Bending</option>
                                    <option value="anime_gem" ${recommendation.recommendation_type === 'anime_gem' ? 'selected' : ''}>Anime Gem</option>
                                    <option value="scene_clip" ${recommendation.recommendation_type === 'scene_clip' ? 'selected' : ''}>Scene Clip</option>
                                    <option value="top_list" ${recommendation.recommendation_type === 'top_list' ? 'selected' : ''}>Top List</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editRecommendationDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editRecommendationDescription" 
                                         rows="4" placeholder="Why do you recommend this content?"
                                         maxlength="500" required>${recommendation.description || ''}</textarea>
                                <div class="form-text">
                                    <span id="editDescriptionCount">${(recommendation.description || '').length}</span>/500 characters
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="recommendationStatus" class="form-label">Status</label>
                                <select class="form-select" id="recommendationStatus">
                                    <option value="true" ${recommendation.is_active ? 'selected' : ''}>Active</option>
                                    <option value="false" ${!recommendation.is_active ? 'selected' : ''}>Draft</option>
                                </select>
                            </div>

                            <!-- Show template data if available -->
                            ${recommendation.template_data ? `
                            <div class="mb-3">
                                <div class="alert alert-warning">
                                    <i data-feather="layout"></i>
                                    <strong>Template Data Available:</strong> This recommendation was created with template "${recommendation.template_data.selected_template}". 
                                    Use enhanced edit to modify template fields.
                                </div>
                            </div>
                            ` : ''}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger me-auto" id="deleteRecommendationBtn">
                            <i data-feather="trash"></i>
                            Delete
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-outline-primary" id="switchToEnhancedEditBtn">
                            <i data-feather="layout"></i>
                            Enhanced Edit
                        </button>
                        <button type="button" class="btn btn-primary" id="updateRecommendationSubmit">
                            <i data-feather="check-circle"></i>
                            Update Recommendation
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        const form = document.getElementById('editRecommendationForm');
        const descriptionTextarea = document.getElementById('editRecommendationDescription');
        const descriptionCount = document.getElementById('editDescriptionCount');
        const submitBtn = document.getElementById('updateRecommendationSubmit');
        const deleteBtn = document.getElementById('deleteRecommendationBtn');
        const switchToEnhancedBtn = document.getElementById('switchToEnhancedEditBtn');

        descriptionTextarea.addEventListener('input', () => {
            descriptionCount.textContent = descriptionTextarea.value.length;
        });

        submitBtn.addEventListener('click', async () => {
            if (form.checkValidity()) {
                const recommendationType = document.getElementById('editRecommendationType').value;
                const description = descriptionTextarea.value;
                const isActive = document.getElementById('recommendationStatus').value === 'true';

                await this.updateRecommendation(recommendation.id, {
                    recommendation_type: recommendationType,
                    description: description,
                    is_active: isActive
                });
            } else {
                form.reportValidity();
            }
        });

        deleteBtn.addEventListener('click', async () => {
            await this.deleteRecommendation(recommendation.id);
        });

        // NEW: Switch to enhanced edit button
        switchToEnhancedBtn.addEventListener('click', () => {
            // Close current modal
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }

            // Open enhanced modal
            setTimeout(() => {
                if (window.recUpcoming) {
                    window.recUpcoming.showEnhancedEditModal(recommendation);
                }
            }, 300);
        });

        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });

        window.recUtils.refreshFeatherIcons();
    }

    async updateRecommendation(recommendationId, data) {
        try {
            this.manager.showToast('Updating recommendation...', 'info');

            const response = await this.manager.makeAuthenticatedRequest(`/admin/recommendations/${recommendationId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                this.manager.showToast('Recommendation updated successfully!', 'success');
                this.manager.loadRecommendations(true);
                this.manager.loadUpcomingRecommendations(true);
                this.closeEditRecommendationModal();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Update failed');
            }
        } catch (error) {
            console.error('Update recommendation error:', error);
            this.manager.showError('Failed to update recommendation: ' + error.message);
        }
    }

    async deleteRecommendation(recommendationId) {
        try {
            if (!confirm('Are you sure you want to delete this recommendation? This action cannot be undone.')) {
                return;
            }

            this.manager.showToast('Deleting recommendation...', 'info');

            const response = await this.manager.makeAuthenticatedRequest(`/admin/recommendations/${recommendationId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                this.manager.showToast('Recommendation deleted successfully!', 'success');
                this.manager.loadRecommendations(true);
                this.manager.loadUpcomingRecommendations(true);
                this.manager.loadQuickStats();
                this.closeEditRecommendationModal();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Delete failed');
            }
        } catch (error) {
            console.error('Delete recommendation error:', error);
            this.manager.showError('Failed to delete recommendation: ' + error.message);
        }
    }

    async sendToTelegram(recommendationId) {
        try {
            this.manager.showToast('Sending to Telegram...', 'info');

            // Get recommendation to check for template data
            const recommendation = this.manager.state.recommendations.find(rec => rec.id === recommendationId);

            let publishData = { template_type: 'auto' };

            // If recommendation has template data, use it
            if (recommendation?.template_data) {
                publishData = {
                    template_type: recommendation.template_data.selected_template || 'auto',
                    template_params: recommendation.template_data.template_fields || {}
                };
            }

            const response = await this.manager.makeAuthenticatedRequest(`/admin/recommendations/${recommendationId}/send`, {
                method: 'POST',
                body: JSON.stringify(publishData)
            });

            if (response.ok) {
                const result = await response.json();
                if (result.telegram_sent) {
                    this.manager.showToast('Successfully sent to Telegram channel!', 'success');
                } else {
                    this.manager.showToast('Telegram is not configured', 'warning');
                }
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Send failed');
            }
        } catch (error) {
            console.error('Send to Telegram error:', error);
            this.manager.showError('Failed to send to Telegram: ' + error.message);
        }
    }

    showBulkActionsModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'bulkActionsModal';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i data-feather="send"></i>
                            Bulk Send Actions
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Select an action to perform on all active recommendations:</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="bulkSendToTelegram">
                                <i data-feather="send"></i>
                                Send All to Telegram
                            </button>
                            <button class="btn btn-outline-secondary" id="bulkExport">
                                <i data-feather="download"></i>
                                Export as CSV
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        document.getElementById('bulkSendToTelegram').addEventListener('click', async () => {
            await this.bulkSendToTelegram();
        });

        document.getElementById('bulkExport').addEventListener('click', async () => {
            await this.exportRecommendations();
        });

        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });

        window.recUtils.refreshFeatherIcons();
    }

    async bulkSendToTelegram() {
        try {
            if (!confirm('Are you sure you want to send all active recommendations to Telegram?')) {
                return;
            }

            this.manager.showToast('Sending all recommendations to Telegram...', 'info');

            const promises = this.manager.state.recommendations.map(rec =>
                this.sendToTelegram(rec.id)
            );

            await Promise.allSettled(promises);
            this.manager.showToast('Bulk send completed!', 'success');

        } catch (error) {
            console.error('Bulk send error:', error);
            this.manager.showError('Failed to send all recommendations');
        }
    }

    async exportRecommendations() {
        try {
            const csvContent = this.generateCSV(this.manager.state.recommendations);
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `recommendations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            window.URL.revokeObjectURL(url);
            this.manager.showToast('Recommendations exported!', 'success');

        } catch (error) {
            console.error('Export error:', error);
            this.manager.showError('Failed to export recommendations');
        }
    }

    generateCSV(recommendations) {
        const headers = ['Title', 'Type', 'Content Type', 'Description', 'Status', 'Created Date', 'Template'];
        const rows = recommendations.map(rec => [
            rec.content?.title || 'Unknown',
            rec.recommendation_type,
            rec.content?.content_type || 'movie',
            (rec.description || '').replace(/"/g, '""'),
            rec.is_active ? 'Active' : 'Draft',
            new Date(rec.created_at).toLocaleDateString(),
            rec.template_data?.selected_template || 'Manual'
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(field => `"${field}"`).join(','))
        ].join('\n');

        return csvContent;
    }

    renderAnalytics(data = {}) {
        if (!this.elements.analyticsMetrics) return;

        const userAnalytics = data.user_analytics || {};
        const contentAnalytics = data.content_analytics || {};
        const interactionAnalytics = data.interaction_analytics || {};

        const metrics = [
            {
                label: 'Total Users',
                value: this.formatNumber(userAnalytics.total_users || 0),
                change: '+12.5%',
                color: '#113CCF'
            },
            {
                label: 'Total Content',
                value: this.formatNumber(contentAnalytics.total_content || 0),
                change: '+8.3%',
                color: '#10b981'
            },
            {
                label: 'Total Interactions',
                value: this.formatNumber(interactionAnalytics.total_interactions || 0),
                change: '+15.2%',
                color: '#f59e0b'
            },
            {
                label: 'Active Today',
                value: this.formatNumber(userAnalytics.active_today || 0),
                change: 'Online now',
                color: '#e50914'
            }
        ];

        this.elements.analyticsMetrics.innerHTML = metrics.map(metric => `
            <div class="analytics-metric-card" style="--metric-color: ${metric.color}">
                <div class="analytics-metric-value">${metric.value}</div>
                <div class="analytics-metric-label">${metric.label}</div>
                <div class="analytics-metric-change">${metric.change}</div>
            </div>
        `).join('');

        window.recUtils.refreshFeatherIcons();
    }

    formatNumber(num) {
        if (!num || num === 0) return '0';
        if (num >= 1000000) {
            return `${(num / 1000000).toFixed(1)}M`;
        } else if (num >= 1000) {
            return `${(num / 1000).toFixed(this.manager.isMobile ? 0 : 1)}K`;
        }
        return num.toString();
    }

    closeEditRecommendationModal() {
        const modal = document.getElementById('editRecommendationModal');
        if (modal) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        }
    }

    getRecommendationStatusColor(status) {
        const colors = {
            'featured': '#e50914',
            'trending': '#113CCF',
            'hidden_gem': '#10b981',
            'classic': '#f59e0b',
            'new_release': '#8b5cf6',
            'mind_bending': '#6366f1',
            'anime_gem': '#ff6b35',
            'scene_clip': '#ec4899',
            'top_list': '#84cc16',
            'standard_movie': '#e50914',
            'standard_tv': '#113CCF',
            'standard_anime': '#ff6b35'
        };
        return colors[status] || '#6b7280';
    }

    updateTabContainerHeight() {
        const contentTabs = document.querySelector('.content-tabs');
        const activeTabPane = document.querySelector('.tab-pane.active');

        if (contentTabs && activeTabPane) {
            const hasExpandedContent = activeTabPane.querySelector('.active');

            if (hasExpandedContent) {
                contentTabs.classList.add('has-expanded-content');
            } else {
                contentTabs.classList.remove('has-expanded-content');
            }
        }
    }

    // Add method to show enhanced edit if recUpcoming is not available
    showEnhancedEdit(recommendation) {
        if (window.recUpcoming) {
            window.recUpcoming.showEnhancedEditModal(recommendation);
        } else {
            this.manager.showError('Enhanced edit not available. Please refresh the page.');
        }
    }

    refreshFeatherIcons() {
        window.recUtils.refreshFeatherIcons();
    }
}

// Initialize and expose globally
window.recRecommendations = null;


3. rec-search.js 
class RecSearch {
    constructor(manager) {
        this.manager = manager;
        this.initializeElements();
        this.setupEventListeners();
        console.log('‚úÖ RecSearch module initialized');
    }

    initializeElements() {
        this.elements = {
            contentSearchInput: document.getElementById('contentSearchInput'),
            searchSource: document.getElementById('searchSource'),
            searchType: document.getElementById('searchType'),
            performSearch: document.getElementById('performSearch'),
            searchResultsGrid: document.getElementById('searchResultsGrid'),
            searchResultsContainer: document.getElementById('searchResultsContainer'),
            searchPagination: document.getElementById('searchPagination'),
            resultsCount: document.getElementById('resultsCount'),
            searchClear: document.getElementById('contentSearchClear'),
            resultsSource: document.getElementById('resultsSource'),
            resultsSortBy: document.getElementById('resultsSortBy')
        };
    }

    setupEventListeners() {
        const searchInput = this.elements.contentSearchInput;
        const clearButton = this.elements.searchClear;

        if (searchInput && clearButton) {
            searchInput.addEventListener('input', function () {
                clearButton.style.display = this.value ? 'flex' : 'none';
            });

            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                searchInput.focus();
                clearButton.style.display = 'none';
                this.clearSearch();
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.performContentSearch();
                }
            });
        }

        this.elements.contentSearchInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.performContentSearch();
            }
        });

        this.elements.performSearch?.addEventListener('click', () => {
            this.performContentSearch();
        });

        this.elements.contentSearchInput?.addEventListener('input',
            this.manager.debounce(() => {
                if (this.elements.contentSearchInput.value.length >= 3) {
                    this.performContentSearch();
                }
            }, 500)
        );

        this.elements.searchSource?.addEventListener('change', () => {
            if (this.manager.state.searchQuery) {
                this.performContentSearch();
            }
        });

        this.elements.searchType?.addEventListener('change', () => {
            if (this.manager.state.searchQuery) {
                this.performContentSearch();
            }
        });

        this.elements.resultsSortBy?.addEventListener('change', () => {
            if (this.manager.state.searchResults.length > 0) {
                this.sortSearchResults();
            }
        });

        // Setup card click handlers
        this.setupCardClickHandlers();
    }

    setupCardClickHandlers() {
        document.addEventListener('click', (e) => {
            const card = e.target.closest('.content-card');
            if (card && !e.target.closest('.action-btn')) {
                e.preventDefault();
                this.handleCardClick(card);
            }
        });

        document.addEventListener('keydown', (e) => {
            const card = e.target.closest('.content-card');
            if (card && (e.key === 'Enter' || e.key === ' ') && !e.target.closest('.action-btn')) {
                e.preventDefault();
                this.handleCardClick(card);
            }
        });
    }

    handleCardClick(card) {
        try {
            card.style.transform = 'scale(0.98)';
            card.style.transition = 'transform 0.1s ease';

            setTimeout(() => {
                card.style.transform = '';

                const contentData = this.extractContentDataFromCard(card);
                if (contentData) {
                    this.navigateToContentDetails(contentData);
                } else {
                    this.manager.showError('Unable to open content details');
                }
            }, 100);
        } catch (error) {
            console.error('Card click error:', error);
            this.manager.showError('Navigation failed');
        }
    }

    extractContentDataFromCard(card) {
        try {
            const contentId = card.dataset.contentId;
            let content = this.manager.state.searchResults.find(c =>
                (c.id || c.tmdb_id || c.mal_id) == contentId
            );

            if (!content) {
                const titleEl = card.querySelector('.card-title');
                const typeEl = card.querySelector('.content-type-badge');
                const yearEl = card.querySelector('.card-year');
                const posterEl = card.querySelector('.card-poster');
                const ratingEl = card.querySelector('.rating-badge span');

                content = {
                    id: contentId || Date.now(),
                    title: titleEl?.textContent?.trim() || 'Unknown',
                    content_type: typeEl?.textContent?.toLowerCase()?.trim() || 'movie',
                    release_date: yearEl?.textContent ? `${yearEl.textContent}-01-01` : null,
                    poster_path: posterEl?.getAttribute('data-src') || posterEl?.src || '',
                    rating: ratingEl?.textContent && ratingEl.textContent !== 'N/A' ?
                        parseFloat(ratingEl.textContent) : null,
                    tmdb_id: card.dataset.tmdbId ? parseInt(card.dataset.tmdbId) : null
                };
            }

            return content;
        } catch (error) {
            console.error('Error extracting content data from card:', error);
            return null;
        }
    }

    navigateToContentDetails(content) {
        try {
            this.showLoadingIndicator();

            let slug = content.slug;

            if (!slug && content.title) {
                slug = this.generateContentSlug(content);
            }

            if (slug && slug.length >= 2) {
                const cleanSlug = slug.replace(/[^a-z0-9\-]/gi, '').toLowerCase();
                if (cleanSlug.length >= 2) {
                    const targetUrl = `/explore/details.html?${encodeURIComponent(cleanSlug)}`;
                    window.location.href = targetUrl;
                    return;
                }
            }

            if (content.id) {
                const fallbackSlug = `content-${content.id}`;
                window.location.href = `/explore/details.html?${encodeURIComponent(fallbackSlug)}`;
                return;
            }

            if (content.title) {
                const titleSlug = this.generateContentSlug(content);
                if (titleSlug) {
                    window.location.href = `/explore/details.html?${encodeURIComponent(titleSlug)}`;
                    return;
                }
            }

            throw new Error('No valid identifier for navigation');

        } catch (error) {
            console.error('Navigation error:', error);
            this.manager.showError('Unable to open content details');
        } finally {
            this.hideLoadingIndicator();
        }
    }

    generateContentSlug(content) {
        try {
            if (!content.title) return '';

            const { cleanTitle, extractedYear } = this.extractYearFromTitle(content.title);
            const finalTitle = cleanTitle || content.title;

            let year = null;
            if (content.release_date) {
                year = window.recUtils.extractYear(content.release_date);
            } else if (extractedYear) {
                year = extractedYear;
            }

            let slug = finalTitle.toLowerCase()
                .trim()
                .replace(/[^\w\s\-']/g, '')
                .replace(/\s+/g, ' ')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-+|-+$/g, '');

            if (!slug || slug.length < 2) {
                slug = this.manualSlugify(finalTitle);
            }

            const contentType = content.content_type || 'movie';
            if (contentType === 'anime' && !slug.startsWith('anime-')) {
                slug = `anime-${slug}`;
            } else if (contentType === 'tv' && !slug.startsWith('tv-')) {
                slug = `tv-${slug}`;
            } else if (contentType === 'movie' && slug.length < 10) {
                slug = `movie-${slug}`;
            }

            if (year && (contentType === 'movie' || contentType === 'anime') &&
                year >= 1900 && year <= 2030) {
                slug += `-${year}`;
            }

            if (content.tmdb_id && slug.length < 15) {
                slug += `-${content.tmdb_id}`;
            }

            if (slug.length > 120) {
                const parts = slug.substring(0, 117).split('-');
                if (parts.length > 1) {
                    parts.pop();
                    slug = parts.join('-');
                } else {
                    slug = slug.substring(0, 117);
                }
            }

            return slug || `content-${content.tmdb_id || content.id || Date.now()}`;

        } catch (error) {
            console.error('Slug generation error:', error);
            return `content-${content.tmdb_id || content.id || Date.now()}`;
        }
    }

    extractYearFromTitle(title) {
        try {
            const yearPatterns = [
                /\((\d{4})\)$/,
                /\s(\d{4})$/,
                /-(\d{4})$/,
                /\[(\d{4})\]$/
            ];

            for (const pattern of yearPatterns) {
                const match = title.match(pattern);
                if (match) {
                    const year = parseInt(match[1]);
                    if (year >= 1900 && year <= 2030) {
                        const cleanTitle = title.replace(pattern, '').trim();
                        return { cleanTitle, extractedYear: year };
                    }
                }
            }

            return { cleanTitle: title, extractedYear: null };
        } catch (error) {
            console.error('Year extraction error:', error);
            return { cleanTitle: title, extractedYear: null };
        }
    }

    manualSlugify(text) {
        try {
            if (!text) return '';
            return text.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[-\s]+/g, '-')
                .replace(/^-+|-+$/g, '')
                .substring(0, 70);
        } catch (error) {
            return '';
        }
    }

    async performContentSearch() {
        const query = this.elements.contentSearchInput?.value.trim();
        if (!query || query.length < 2) {
            this.clearSearchResults();
            return;
        }

        const cacheKey = `${query}_${this.elements.searchSource?.value}_${this.manager.state.currentPage}`;
        if (this.manager.cache.searchResults.has(cacheKey)) {
            const cachedData = this.manager.cache.searchResults.get(cacheKey);
            this.manager.state.searchResults = cachedData.results;
            this.manager.state.totalPages = cachedData.totalPages;
            this.renderSearchResults();
            this.updateSearchResultsHeader(cachedData);
            return;
        }

        this.manager.state.searchQuery = query;
        this.manager.state.currentPage = 1;
        this.manager.state.isLoading = true;

        this.showSearchLoading();

        try {
            const source = this.elements.searchSource?.value || 'tmdb';
            const type = this.elements.searchType?.value || 'all';

            const params = new URLSearchParams({
                query: query,
                source: source,
                page: this.manager.state.currentPage
            });

            if (type !== 'all') {
                params.append('type', type);
            }

            const response = await this.manager.makeAuthenticatedRequest(`/admin/search?${params}`);

            if (response.ok) {
                const data = await response.json();
                this.manager.state.searchResults = data.results || [];
                this.manager.state.totalPages = data.total_pages || 1;

                this.manager.cache.searchResults.set(cacheKey, {
                    results: this.manager.state.searchResults,
                    totalPages: this.manager.state.totalPages,
                    totalResults: data.total_results || 0
                });

                this.renderSearchResults();
                this.updateSearchResultsHeader(data);

                if (this.elements.searchClear) {
                    this.elements.searchClear.style.display = 'flex';
                }
            }
        } catch (error) {
            console.error('Error performing search:', error);
            this.manager.showError('Search failed. Please try again.');
        } finally {
            this.manager.state.isLoading = false;
            this.hideSearchLoading();
        }
    }

    async changePage(newPage) {
        if (newPage < 1 || newPage > this.manager.state.totalPages) {
            return;
        }

        this.manager.state.currentPage = newPage;
        await this.performContentSearch();
    }

    sortSearchResults() {
        const sortBy = this.elements.resultsSortBy?.value || 'popularity';

        switch (sortBy) {
            case 'popularity':
                this.manager.state.searchResults.sort((a, b) =>
                    (b.popularity || 0) - (a.popularity || 0)
                );
                break;
            case 'rating':
                this.manager.state.searchResults.sort((a, b) =>
                    (b.vote_average || b.rating || 0) - (a.vote_average || a.rating || 0)
                );
                break;
            case 'release_date':
                this.manager.state.searchResults.sort((a, b) => {
                    const dateA = new Date(a.release_date || a.first_air_date || '1900-01-01');
                    const dateB = new Date(b.release_date || b.first_air_date || '1900-01-01');
                    return dateB - dateA;
                });
                break;
            case 'title':
                this.manager.state.searchResults.sort((a, b) =>
                    (a.title || a.name || '').localeCompare(b.title || b.name || '')
                );
                break;
        }

        this.renderSearchResults();
    }

    renderSearchResults() {
        if (!this.elements.searchResultsGrid) return;

        if (this.manager.state.searchResults.length === 0) {
            if (this.elements.searchResultsContainer) {
                this.elements.searchResultsContainer.classList.remove('active');
                this.elements.searchResultsGrid.innerHTML = window.recUtils.getEmptyState('search', 'No results found', 'Try different keywords or change search source');
            }
            this.updateTabContainerHeight();
            window.recUtils.refreshFeatherIcons();
            return;
        }

        this.elements.searchResultsGrid.innerHTML = this.manager.state.searchResults.map(content =>
            window.recUtils.createContentCard(content, 'search')
        ).join('');

        if (this.manager.state.totalPages > 1) {
            this.renderSearchPagination();
        }

        this.setupLazyLoadingForCards();

        if (this.elements.searchResultsContainer) {
            this.elements.searchResultsContainer.classList.add('active');
            const header = this.elements.searchResultsContainer.querySelector('.search-results-header');
            if (header) {
                header.style.display = 'flex';
            }
        }

        this.updateTabContainerHeight();
        window.recUtils.refreshFeatherIcons();
    }

    renderSearchPagination() {
        if (!this.elements.searchPagination) return;

        const currentPage = this.manager.state.currentPage;
        const totalPages = this.manager.state.totalPages;

        let paginationHTML = '';

        paginationHTML += `
            <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                    onclick="window.recSearch.changePage(${currentPage - 1})"
                    ${currentPage === 1 ? 'disabled' : ''}>
                <i data-feather="chevron-left"></i>
            </button>
        `;

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `
                <button class="pagination-btn" onclick="window.recSearch.changePage(1)">1</button>
            `;
            if (startPage > 2) {
                paginationHTML += `<span class="pagination-dots">...</span>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="window.recSearch.changePage(${i})">${i}</button>
            `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<span class="pagination-dots">...</span>`;
            }
            paginationHTML += `
                <button class="pagination-btn" onclick="window.recSearch.changePage(${totalPages})">${totalPages}</button>
            `;
        }

        paginationHTML += `
            <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                    onclick="window.recSearch.changePage(${currentPage + 1})"
                    ${currentPage === totalPages ? 'disabled' : ''}>
                <i data-feather="chevron-right"></i>
            </button>
        `;

        this.elements.searchPagination.innerHTML = paginationHTML;
        this.elements.searchPagination.style.display = 'flex';
        window.recUtils.refreshFeatherIcons();
    }

    setupLazyLoadingForCards(container = null) {
        const targetContainer = container || this.elements.searchResultsGrid;
        const cards = targetContainer?.querySelectorAll('.content-card img[data-src]');
        if (!cards || cards.length === 0) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const imgSrc = img.dataset.src;

                    if (imgSrc) {
                        const tempImg = new Image();
                        tempImg.onload = () => {
                            img.src = imgSrc;
                            img.classList.add('loaded');
                        };
                        tempImg.onerror = () => {
                            img.src = this.manager.placeholderImage;
                            img.classList.add('loaded');
                        };
                        tempImg.src = imgSrc;
                    }
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: this.manager.isMobile ? '50px' : '100px',
            threshold: 0.01
        });

        cards.forEach(img => observer.observe(img));
    }

    updateSearchResultsHeader(data) {
        if (this.elements.resultsCount) {
            const count = data.total_results || this.manager.state.searchResults.length;
            this.elements.resultsCount.textContent = `${this.manager.formatNumber(count)} results`;
        }

        if (this.elements.resultsSource) {
            const source = this.elements.searchSource?.value || 'TMDB';
            this.elements.resultsSource.textContent = source.toUpperCase();
        }
    }

    showSearchLoading() {
        if (this.elements.searchResultsContainer) {
            this.elements.searchResultsContainer.classList.add('active');

            if (this.elements.searchResultsGrid) {
                this.elements.searchResultsGrid.innerHTML = Array(12).fill(0).map(() => `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-poster">
                            <div class="skeleton-shimmer"></div>
                        </div>
                        <div class="skeleton-info">
                            <div class="skeleton skeleton-title">
                                <div class="skeleton-shimmer"></div>
                            </div>
                            <div class="skeleton skeleton-meta">
                                <div class="skeleton-shimmer"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
    }

    hideSearchLoading() {
        // Loading state handled by renderSearchResults
    }

    clearSearch() {
        if (this.elements.contentSearchInput) {
            this.elements.contentSearchInput.value = '';
            this.elements.contentSearchInput.focus();
        }
        if (this.elements.searchClear) {
            this.elements.searchClear.style.display = 'none';
        }
        this.clearSearchResults();
    }

    clearSearchResults() {
        this.manager.state.searchResults = [];
        this.manager.state.searchQuery = '';
        this.manager.state.currentPage = 1;
        this.manager.state.totalPages = 0;

        if (this.elements.searchResultsContainer) {
            this.elements.searchResultsContainer.classList.remove('active');
        }

        if (this.elements.searchPagination) {
            this.elements.searchPagination.style.display = 'none';
        }

        if (this.elements.searchClear) {
            this.elements.searchClear.style.display = 'none';
        }

        this.updateTabContainerHeight();
    }

    updateTabContainerHeight() {
        const contentTabs = document.querySelector('.content-tabs');
        const activeTabPane = document.querySelector('.tab-pane.active');

        if (contentTabs && activeTabPane) {
            const hasExpandedContent = activeTabPane.querySelector('.active');

            if (hasExpandedContent) {
                contentTabs.classList.add('has-expanded-content');
            } else {
                contentTabs.classList.remove('has-expanded-content');
            }
        }
    }

    showLoadingIndicator() {
        const indicator = document.getElementById('page-loading-indicator');
        if (indicator) {
            indicator.style.transform = 'scaleX(1)';
        }
    }

    hideLoadingIndicator() {
        setTimeout(() => {
            const indicator = document.getElementById('page-loading-indicator');
            if (indicator) {
                indicator.style.transform = 'scaleX(0)';
            }
        }, 300);
    }

    // Updated methods for template modal workflow
    async saveRecommendation(contentId) {
        try {
            const content = this.findContentById(contentId);
            if (!content) {
                this.manager.showError('Content not found');
                return;
            }

            // Directly open enhanced template modal instead of quick save
            this.manager.state.selectedContent = content;
            if (window.recUpcoming) {
                window.recUpcoming.showEnhancedCreateRecommendationModal(content);
            }

        } catch (error) {
            console.error('Save recommendation error:', error);
            this.manager.showError('Failed to save recommendation');
        }
    }

    async recommendContent(contentId) {
        try {
            const content = this.findContentById(contentId);
            if (!content) {
                this.manager.showError('Content not found');
                return;
            }

            this.manager.state.selectedContent = content;
            if (window.recUpcoming) {
                window.recUpcoming.showEnhancedCreateRecommendationModal(content);
            }

        } catch (error) {
            console.error('Recommend error:', error);
            this.manager.showError('Failed to open recommendation form');
        }
    }

    findContentById(contentId) {
        let content = this.manager.state.searchResults.find(c =>
            (c.id || c.tmdb_id || c.mal_id) == contentId
        );

        if (!content) {
            content = this.manager.state.upcomingRecommendations.find(r =>
                r.content_id == contentId || r.id == contentId)?.content;
        }

        return content;
    }
}

// Initialize and expose globally
window.recSearch = null;


4. rec-telegram.js


class RecTelegram {
    constructor(recommendationsManager) {
        this.manager = recommendationsManager;
        this.initializeModules();
        this.setupGlobalEventListeners();
        console.log('‚úÖ RecTelegram coordinator initialized');
    }

    initializeModules() {
        // Initialize all sub-modules
        window.recSearch = new RecSearch(this.manager);
        window.recRecommendations = new RecRecommendations(this.manager);
        window.recUpcoming = new RecUpcoming(this.manager);

        // Expose methods for backwards compatibility
        this.setupCompatibilityMethods();
    }

    setupCompatibilityMethods() {
        // Expose commonly used methods on the main RecTelegram class
        this.performContentSearch = () => window.recSearch.performContentSearch();
        this.renderSearchResults = () => window.recSearch.renderSearchResults();
        this.renderRecommendations = () => window.recRecommendations.renderRecommendations();
        this.renderUpcomingRecommendations = () => window.recUpcoming.renderUpcomingRecommendations();
        this.changePage = (page) => window.recSearch.changePage(page);
        this.saveRecommendation = (id) => window.recSearch.saveRecommendation(id);
        this.recommendContent = (id) => window.recSearch.recommendContent(id);
        this.editRecommendation = (id) => window.recRecommendations.editRecommendation(id);
        this.publishRecommendation = (id) => window.recUpcoming.publishDraftRecommendation(id);
        this.sendToTelegram = (id) => window.recRecommendations.sendToTelegram(id);
        this.showEnhancedCreateRecommendationModal = (content) => window.recUpcoming.showEnhancedCreateRecommendationModal(content);
        this.selectPublishTemplate = (template) => window.recUpcoming.selectPublishTemplate(template);
        this.refreshFeatherIcons = () => window.recUtils.refreshFeatherIcons();
    }

    setupGlobalEventListeners() {
        // Global keyboard shortcuts that work across all modules
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        if (this.manager.state.currentTab === 'search' && this.manager.state.searchResults.length > 0) {
                            e.preventDefault();
                            window.recSearch.saveRecommendation(this.manager.state.searchResults[0].id || this.manager.state.searchResults[0].tmdb_id);
                        }
                        break;
                    case 'n':
                        if (this.manager.state.currentTab === 'recommendations') {
                            e.preventDefault();
                            window.recUpcoming.showEnhancedCreateRecommendationModal();
                        }
                        break;
                }
            }
        });

        // Setup filter event listeners
        this.setupFilterListeners();
    }

    setupFilterListeners() {
        // Listen for filter changes and re-render accordingly
        const recommendationsFilter = document.getElementById('recommendationsFilter');
        const recommendationsSort = document.getElementById('recommendationsSort');
        const savedContentFilter = document.getElementById('savedContentFilter');

        recommendationsFilter?.addEventListener('change', () => {
            this.renderRecommendations();
        });

        recommendationsSort?.addEventListener('change', () => {
            this.renderRecommendations();
        });

        savedContentFilter?.addEventListener('change', () => {
            this.renderUpcomingRecommendations();
        });
    }

    // Cleanup method
    destroy() {
        // Clean up any global event listeners or resources
        console.log('üóëÔ∏è RecTelegram coordinator destroyed');
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    if (window.recommendationsManager) {
        setTimeout(() => {
            window.recTelegram = new RecTelegram(window.recommendationsManager);
        }, 100);
    }
});

window.addEventListener('beforeunload', () => {
    if (window.recTelegram) {
        window.recTelegram.destroy();
    }
});