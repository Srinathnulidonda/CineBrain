1. dashboard.js 
/**
 * CineBrain Admin Dashboard - Main Controller
 * Mobile-First Responsive Dashboard Management
 */

class AdminDashboard {
    constructor() {
        this.apiBase = window.CineBrainConfig.apiBase;
        this.refreshInterval = 8000;
        this.refreshTimer = null;
        this.isRefreshing = false;
        this.currentUser = null;
        this.isMobile = window.innerWidth <= 768;
        this.touchDevice = 'ontouchstart' in window;

        // Dashboard data
        this.dashboardData = {
            overview: null,
            analytics: null,
            supportDashboard: null
        };

        this.boostTimeout = null;

        // Initialize component classes
        this.systemMonitor = null;
        this.statisticsManager = null;

        this.init();
        this.handleResize();
    }

    async init() {
        try {
            // Check admin authentication
            if (!await this.checkAdminAuth()) {
                window.location.href = '/auth/login.html';
                return;
            }

            // Initialize components
            this.initializeElements();
            this.setupEventListeners();

            // Initialize system monitoring
            this.systemMonitor = new SystemMonitor(this);
            await this.systemMonitor.init();

            // Initialize statistics manager
            this.statisticsManager = new StatisticsManager(this);
            await this.statisticsManager.init();

            // Load initial data
            await this.loadAllData();

            // Start real-time updates
            this.startRealTimeUpdates();

            // Setup smart polling
            this.setupSmartPolling();

            console.log('‚úÖ CineBrain Admin Dashboard Real-time System initialized');

        } catch (error) {
            console.error('‚ùå Dashboard initialization error:', error);
            this.showError('Failed to initialize admin dashboard');
        }
    }

    handleResize() {
        window.addEventListener('resize', () => {
            const wasMobile = this.isMobile;
            this.isMobile = window.innerWidth <= 768;

            if (wasMobile !== this.isMobile) {
                this.reinitializeForDevice();
            }

            if (this.statisticsManager) {
                this.statisticsManager.resizeCharts();
            }
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                this.reinitializeForDevice();
                if (this.statisticsManager) {
                    this.statisticsManager.resizeCharts();
                }
            }, 100);
        });
    }

    reinitializeForDevice() {
        if (this.dashboardData.overview) {
            this.renderOverviewCards(this.dashboardData.overview);
            this.renderQuickActions();
        }

        if (this.dashboardData.analytics && this.statisticsManager) {
            this.statisticsManager.updateCharts(this.dashboardData.analytics);
        }
    }

    async checkAdminAuth() {
        try {
            const token = localStorage.getItem('cinebrain-token');
            const userStr = localStorage.getItem('cinebrain-user');

            if (!token || !userStr) {
                return false;
            }

            const user = JSON.parse(userStr);
            if (!user.is_admin) {
                return false;
            }

            this.currentUser = user;
            return true;

        } catch (error) {
            console.error('Auth check error:', error);
            return false;
        }
    }

    initializeElements() {
        this.elements = {
            // Status elements
            lastUpdate: document.getElementById('lastUpdate'),
            autoRefreshStatus: document.getElementById('autoRefreshStatus'),
            liveConnectionStatus: document.getElementById('liveConnectionStatus'),

            // Containers
            overviewCards: document.getElementById('overviewCards'),
            mobileOverviewCards: document.getElementById('mobileOverviewCards'),
            mobileStatsGrid: document.getElementById('mobileStatsGrid'),
            recentActivity: document.getElementById('recentActivity'),
            supportStats: document.getElementById('supportStats'),
            recentTickets: document.getElementById('recentTickets'),

            // Buttons
            refreshDashboard: document.getElementById('refreshDashboard'),
            viewAllActivity: document.getElementById('viewAllActivity'),
            viewSupportDashboard: document.getElementById('viewSupportDashboard'),

            // Period selector
            activityPeriod: document.getElementById('activityPeriod')
        };
    }

    setupEventListeners() {
        // Refresh button
        this.elements.refreshDashboard?.addEventListener('click', (e) => {
            e.preventDefault();
            this.refreshAllData();
            this.hapticFeedback('light');
        });

        // Navigation buttons
        this.elements.viewAllActivity?.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '/admin/analytics.html';
        });

        this.elements.viewSupportDashboard?.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '/admin/Support-Dashboard.html';
        });

        // Period selector
        this.elements.activityPeriod?.addEventListener('change', () => {
            this.updateChartsForPeriod();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        this.refreshAllData();
                        break;
                }
            }
        });

        // Window focus/blur for refresh
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.refreshAllData();
                if (this.systemMonitor) {
                    this.systemMonitor.checkMissedNotifications();
                }
            }
        });

        // Listen for notification events
        window.addEventListener('cinebrain-admin-event', (e) => {
            if (e.detail.type === 'refresh') {
                this.refreshAllData();
            }
        });

        // Mobile touch gestures
        if (this.touchDevice) {
            this.setupTouchGestures();
        }
    }

    setupTouchGestures() {
        let startY = 0;
        let currentY = 0;

        document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                startY = e.touches[0].pageY;
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (window.scrollY === 0 && startY) {
                currentY = e.touches[0].pageY;
                const pullDistance = currentY - startY;

                if (pullDistance > 100 && !this.isRefreshing) {
                    this.showPullToRefreshIndicator();
                }
            }
        }, { passive: true });

        document.addEventListener('touchend', () => {
            if (window.scrollY === 0 && startY && currentY) {
                const pullDistance = currentY - startY;

                if (pullDistance > 100 && !this.isRefreshing) {
                    this.refreshAllData();
                    this.hapticFeedback('medium');
                }
            }

            startY = 0;
            currentY = 0;
            this.hidePullToRefreshIndicator();
        }, { passive: true });
    }

    showPullToRefreshIndicator() {
        if (!document.getElementById('pullToRefreshIndicator')) {
            const indicator = document.createElement('div');
            indicator.id = 'pullToRefreshIndicator';
            indicator.innerHTML = '<i data-feather="refresh-cw"></i> Release to refresh';
            indicator.style.cssText = `
                position: fixed;
                top: calc(var(--topbar-height) + 10px);
                left: 50%;
                transform: translateX(-50%);
                background: var(--admin-primary);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            document.body.appendChild(indicator);

            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
    }

    hidePullToRefreshIndicator() {
        const indicator = document.getElementById('pullToRefreshIndicator');
        if (indicator) {
            indicator.remove();
        }
    }

    hapticFeedback(type = 'light') {
        if ('vibrate' in navigator) {
            const patterns = {
                light: 10,
                medium: 20,
                heavy: 50
            };
            navigator.vibrate(patterns[type] || patterns.light);
        }
    }

    async loadAllData() {
        this.showLoading(true);

        try {
            const promises = [
                this.loadDashboardOverview(),
                this.loadAnalytics(),
                this.loadSupportDashboard()
            ];

            await Promise.allSettled(promises);
            this.updateLastRefreshTime();
            this.validateDataIntegrity();

        } catch (error) {
            console.error('Error loading dashboard data:', error);
            this.showError('Failed to load some dashboard data');
        } finally {
            this.showLoading(false);
        }
    }

    validateDataIntegrity() {
        if (!this.dashboardData.overview || !this.dashboardData.overview.general_stats) {
            console.error('Invalid overview data, reloading...');
            this.loadDashboardOverview();
        }

        if (!this.dashboardData.analytics || !this.dashboardData.analytics.user_analytics) {
            console.error('Invalid analytics data, reloading...');
            this.loadAnalytics();
        }

        if (!this.dashboardData.supportDashboard || !this.dashboardData.supportDashboard.ticket_stats) {
            console.error('Invalid support data, reloading...');
            this.loadSupportDashboard();
        }
    }

    async loadDashboardOverview() {
        try {
            const response = await this.makeAuthenticatedRequest('/admin/dashboard');
            if (response.ok) {
                const data = await response.json();

                if (data && data.general_stats) {
                    this.dashboardData.overview = data;
                    this.renderOverviewCards(data);
                    this.renderRecentActivity(data.recent_activity);
                    this.renderQuickActions();

                    // Pass alerts to system monitor
                    if (data.alerts && data.alerts.length > 0 && this.systemMonitor) {
                        data.alerts.forEach(alert => this.systemMonitor.handleNewAlert(alert));
                    }
                } else {
                    throw new Error('Invalid dashboard data structure');
                }
            } else {
                throw new Error(`Dashboard request failed: ${response.status}`);
            }
        } catch (error) {
            console.error('Error loading dashboard overview:', error);
            this.showError('Failed to load dashboard overview');
        }
    }

    async loadAnalytics() {
        try {
            const response = await this.makeAuthenticatedRequest('/admin/analytics');
            if (response.ok) {
                const data = await response.json();

                if (data && (data.user_analytics || data.content_analytics)) {
                    this.dashboardData.analytics = data;
                    if (this.statisticsManager) {
                        this.statisticsManager.updateCharts(data);
                    }
                } else {
                    throw new Error('Invalid analytics data structure');
                }
            } else {
                throw new Error(`Analytics request failed: ${response.status}`);
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
            this.showError('Failed to load analytics');
        }
    }

    async loadSupportDashboard() {
        try {
            const response = await this.makeAuthenticatedRequest('/admin/support/dashboard');
            if (response.ok) {
                const data = await response.json();

                if (data && data.ticket_stats) {
                    this.dashboardData.supportDashboard = data;
                    this.renderSupportStats(data);
                    this.renderRecentTickets(data.recent_tickets || []);

                    // Create alert for urgent tickets
                    if (data.ticket_stats.urgent > 3 && this.systemMonitor) {
                        this.systemMonitor.handleNewAlert({
                            level: 'warning',
                            component: 'Support System',
                            message: `${data.ticket_stats.urgent} urgent tickets need attention`
                        });
                    }
                } else {
                    throw new Error('Invalid support data structure');
                }
            } else {
                throw new Error(`Support dashboard request failed: ${response.status}`);
            }
        } catch (error) {
            console.error('Error loading support dashboard:', error);
            this.showError('Failed to load support dashboard');
        }
    }

    renderQuickActions() {
        let quickActionsContainer = document.getElementById('quickActionsContainer');

        if (!quickActionsContainer) {
            const overviewCardsRow = document.getElementById('overviewCards')?.closest('.row');

            if (overviewCardsRow) {
                const quickActionsRow = document.createElement('div');
                quickActionsRow.className = 'row mb-4';
                quickActionsRow.innerHTML = `
                <div class="col-12">
                    <h2 class="section-title">
                        <i data-feather="zap"></i>
                        Quick Actions
                    </h2>
                </div>
                <div class="col-12">
                    <div id="quickActionsContainer" class="quick-actions"></div>
                </div>
            `;
                overviewCardsRow.parentNode.insertBefore(quickActionsRow, overviewCardsRow.nextSibling);
                quickActionsContainer = document.getElementById('quickActionsContainer');
            }
        }

        if (quickActionsContainer) {
            const actions = [
                { href: '/admin/content.html', icon: 'film', label: 'Content' },
                { href: '/admin/users.html', icon: 'users', label: 'Users' },
                { href: '/admin/Support-Dashboard.html', icon: 'message-circle', label: 'Support' },
                { href: '/admin/analytics.html', icon: 'bar-chart-2', label: 'Analytics' },
                { href: '/admin/recommendations.html', icon: 'star', label: 'Recommendations' },
                { href: '/admin/settings.html', icon: 'settings', label: 'Settings' }
            ];

            quickActionsContainer.innerHTML = actions.map(action => `
            <a href="${action.href}" class="action-btn">
                <i data-feather="${action.icon}"></i>
                <span>${action.label}</span>
            </a>
        `).join('');

            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
    }

    renderOverviewCards(data) {
        const stats = data.general_stats || {};
        const supportOverview = data.support_overview || {};

        const cards = [
            {
                title: 'Total Users',
                value: this.formatNumber(stats.total_users || 0),
                change: this.calculateChange(stats.new_users_month, stats.total_users),
                icon: 'users',
                color: '#113CCF'
            },
            {
                title: 'Total Content',
                value: this.formatNumber(stats.total_content || 0),
                change: '+' + this.formatNumber(stats.content_added_week || 0),
                icon: 'film',
                color: '#e50914'
            },
            {
                title: 'Active Users',
                value: this.formatNumber(stats.active_users_week || 0),
                change: this.calculateChange(stats.active_users_change || 0, stats.active_users_week),
                icon: 'activity',
                color: '#10b981'
            },
            {
                title: 'Support Tickets',
                value: this.formatNumber(supportOverview.open_tickets || 0),
                change: supportOverview.urgent_tickets > 0 ? `${supportOverview.urgent_tickets} urgent` : 'All handled',
                icon: 'headphones',
                color: supportOverview.urgent_tickets > 0 ? '#f59e0b' : '#10b981'
            },
            {
                title: 'Interactions',
                value: this.formatNumber(stats.total_interactions || 0),
                change: '+' + this.formatNumber(stats.interactions_today || 0) + ' today',
                icon: 'mouse-pointer',
                color: '#8b5cf6'
            },
            {
                title: 'Recommendations',
                value: this.formatNumber(stats.total_recommendations || 0),
                change: 'Active',
                icon: 'star',
                color: '#f59e0b'
            }
        ];

        // Render mobile cards
        if (this.elements.mobileOverviewCards && this.isMobile) {
            this.elements.mobileOverviewCards.innerHTML = cards.map(card => `
                <div class="mobile-overview-card" style="--card-color: ${card.color}">
                    <div class="mobile-card-value">${card.value}</div>
                    <div class="mobile-card-label">${card.title}</div>
                </div>
            `).join('');
        }

        // Render mobile stats grid
        if (this.elements.mobileStatsGrid && this.isMobile) {
            this.elements.mobileStatsGrid.innerHTML = cards.slice(0, 4).map(card => `
                <div class="mobile-stat-item" style="--stat-color: ${card.color}">
                    <div class="mobile-stat-value">${card.value}</div>
                    <div class="mobile-stat-label">${card.title.split(' ')[0]}</div>
                </div>
            `).join('');
        }

        // Render desktop cards
        if (this.elements.overviewCards && !this.isMobile) {
            this.elements.overviewCards.innerHTML = cards.map(card => `
                <div class="col-lg-2 col-md-4 col-6">
                    <div class="overview-card fade-in" style="--card-color: ${card.color}">
                        <div class="overview-card-header">
                            <div class="overview-card-title">
                                <i data-feather="${card.icon}" class="overview-card-icon"></i>
                                ${card.title}
                            </div>
                        </div>
                        <div class="overview-card-value">${card.value}</div>
                        <div class="overview-card-change ${this.getChangeClass(card.change)}">
                            <i data-feather="${this.getChangeIcon(card.change)}" class="change-icon"></i>
                            ${card.change}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    renderRecentActivity(activities) {
        if (!this.elements.recentActivity || !activities) return;

        this.showTableLoading(this.elements.recentActivity);

        const allActivities = [
            ...(activities.recent_content || []).map(item => ({
                type: 'content_added',
                title: `New ${item.type}: ${item.title}`,
                subtitle: `Rating: ${item.rating || 'N/A'}/10`,
                user: 'System',
                time: this.formatTimeAgo(item.created_at),
                timestamp: new Date(item.created_at),
                status: 'success'
            })),
            ...(activities.recent_users || []).map(item => ({
                type: 'user_registered',
                title: 'New user registered',
                subtitle: item.username,
                user: item.email,
                time: this.formatTimeAgo(item.created_at),
                timestamp: new Date(item.created_at),
                status: 'info'
            })),
            ...(activities.recent_recommendations || []).map(item => ({
                type: 'recommendation_created',
                title: 'Content recommended',
                subtitle: item.content_title,
                user: item.admin_name,
                time: this.formatTimeAgo(item.created_at),
                timestamp: new Date(item.created_at),
                status: 'warning'
            }))
        ].sort((a, b) => b.timestamp - a.timestamp).slice(0, this.isMobile ? 5 : 8);

        if (allActivities.length === 0) {
            this.elements.recentActivity.innerHTML = `
                <div class="table-empty-state">
                    <i data-feather="clock"></i>
                    <p>No recent activity</p>
                </div>
            `;
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            return;
        }

        let tableHtml = `
            <div class="table-responsive-mobile">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Activity</th>
                            <th class="d-none d-md-table-cell">User</th>
                            <th>Time</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        allActivities.forEach(activity => {
            tableHtml += `
                <tr class="slide-up activity-new">
                    <td>
                        <div class="activity-info">
                            <span class="activity-title">${this.truncateText(activity.title, this.isMobile ? 30 : 50)}</span>
                            <span class="activity-subtitle">${this.truncateText(activity.subtitle, this.isMobile ? 25 : 40)}</span>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell">
                        <span style="color: var(--text-secondary); font-size: var(--font-xs);">
                            ${this.truncateText(activity.user, 20)}
                        </span>
                    </td>
                    <td>
                        <span class="time-info">${activity.time}</span>
                    </td>
                    <td>
                        <span class="table-badge table-badge-${activity.status}">
                            ${activity.status}
                        </span>
                    </td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table></div>';
        this.elements.recentActivity.innerHTML = tableHtml;

        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    renderRecentTickets(tickets) {
        if (!this.elements.recentTickets || !tickets) return;

        this.showTableLoading(this.elements.recentTickets);

        if (tickets.length === 0) {
            this.elements.recentTickets.innerHTML = `
                <div class="table-empty-state">
                    <i data-feather="check-circle"></i>
                    <p>No recent tickets</p>
                </div>
            `;
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            return;
        }

        const displayTickets = tickets.slice(0, this.isMobile ? 3 : 6);

        let tableHtml = `
            <div class="table-responsive-mobile">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ticket</th>
                            <th class="d-none d-md-table-cell">User</th>
                            <th>Priority</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        displayTickets.forEach(ticket => {
            const priorityBadge = {
                'urgent': 'danger',
                'high': 'warning',
                'normal': 'info',
                'low': 'success'
            }[ticket.priority] || 'info';

            tableHtml += `
                <tr class="slide-up ${ticket.is_sla_breached ? 'sla-breached' : ''}">
                    <td>
                        <div class="ticket-info">
                            <a href="/admin/support/ticket/${ticket.id || ticket.ticket_number}" class="ticket-number">
                                #${ticket.ticket_number}
                            </a>
                            <span class="ticket-subject">
                                ${this.truncateText(ticket.subject, this.isMobile ? 30 : 45)}
                                ${ticket.is_sla_breached ? '<span class="table-badge table-badge-danger" style="font-size: 10px; margin-left: 4px;">SLA</span>' : ''}
                            </span>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell">
                        <span style="color: var(--text-secondary); font-size: var(--font-xs);">
                            ${this.truncateText(ticket.user_name, 15)}
                        </span>
                    </td>
                    <td>
                        <span class="table-badge table-badge-${priorityBadge}">
                            ${ticket.priority}
                        </span>
                    </td>
                    <td>
                        <span class="time-info">${this.formatTimeAgo(ticket.created_at)}</span>
                    </td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table></div>';
        this.elements.recentTickets.innerHTML = tableHtml;

        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    renderSupportStats(data) {
        if (!this.elements.supportStats || !data.ticket_stats) return;

        const stats = data.ticket_stats;

        const statItems = [
            { label: 'Total', value: stats.total || 0, color: '#113CCF' },
            { label: 'Open', value: stats.open || 0, color: '#f59e0b' },
            { label: 'Urgent', value: stats.urgent || 0, color: '#ef4444' },
            { label: 'Today', value: stats.today_created || 0, color: '#10b981' }
        ];

        this.elements.supportStats.innerHTML = statItems.map(stat => `
            <div class="support-stat">
                <div class="support-stat-value" style="--stat-color: ${stat.color}">${stat.value}</div>
                <div class="support-stat-label">${stat.label}</div>
            </div>
        `).join('');

        // Update urgent tickets badge
        const urgentBadge = document.getElementById('urgentTicketsBadge');
        if (urgentBadge) {
            if (stats.urgent > 0) {
                urgentBadge.textContent = stats.urgent;
                urgentBadge.style.display = 'inline-block';
            } else {
                urgentBadge.style.display = 'none';
            }
        }
    }

    // Real-time Updates
    startRealTimeUpdates() {
        this.refreshInterval = 8000;

        this.refreshTimer = setInterval(() => {
            if (!this.isRefreshing && !document.hidden) {
                this.refreshAllData();
            }
        }, this.refreshInterval);

        console.log(`‚úÖ HTTP polling started (${this.refreshInterval / 1000}s interval)`);
    }

    setupSmartPolling() {
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.refreshAllData();
                if (this.systemMonitor) {
                    this.systemMonitor.loadAllSystemData();
                }
                this.boostPollingFrequency();
            }
        });
    }

    boostPollingFrequency() {
        if (this.boostTimeout) {
            clearTimeout(this.boostTimeout);
        }

        const originalRefreshInterval = this.refreshInterval;
        this.refreshInterval = 3000;

        this.boostTimeout = setTimeout(() => {
            this.refreshInterval = originalRefreshInterval;
            console.log('‚úÖ Polling frequency normalized');
        }, 30000);

        console.log('‚ö° Polling frequency boosted for 30s');
    }

    stopRealTimeUpdates() {
        if (this.refreshTimer) {
            clearInterval(this.refreshTimer);
            this.refreshTimer = null;
            console.log('‚èπ Real-time updates stopped');
        }
    }

    async refreshAllData() {
        if (this.isRefreshing) return;

        this.isRefreshing = true;

        try {
            await this.loadAllData();
            if (this.systemMonitor) {
                await this.systemMonitor.loadAllSystemData();
            }
            this.showSuccess('Dashboard updated');
        } catch (error) {
            console.error('Refresh error:', error);
            this.showError('Failed to refresh dashboard');
        } finally {
            this.isRefreshing = false;
        }
    }

    updateChartsForPeriod() {
        this.loadAnalytics();
    }

    // Loading state for tables
    showTableLoading(element) {
        if (!element) return;

        element.innerHTML = `
            <div class="table-loading">
                <div class="table-skeleton-row">
                    <div class="table-skeleton-cell wide"></div>
                    <div class="table-skeleton-cell medium"></div>
                    <div class="table-skeleton-cell small"></div>
                </div>
                <div class="table-skeleton-row">
                    <div class="table-skeleton-cell wide"></div>
                    <div class="table-skeleton-cell medium"></div>
                    <div class="table-skeleton-cell small"></div>
                </div>
                <div class="table-skeleton-row">
                    <div class="table-skeleton-cell wide"></div>
                    <div class="table-skeleton-cell medium"></div>
                    <div class="table-skeleton-cell small"></div>
                </div>
            </div>
        `;
    }

    // Utility Methods
    async makeAuthenticatedRequest(endpoint, options = {}) {
        const token = localStorage.getItem('cinebrain-token');

        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        };

        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...(options.headers || {})
            }
        };

        const response = await fetch(`${this.apiBase}${endpoint}`, mergedOptions);

        if (response.status === 401) {
            localStorage.removeItem('cinebrain-token');
            localStorage.removeItem('cinebrain-user');
            window.location.href = '/auth/login.html';
            throw new Error('Authentication failed');
        }

        return response;
    }

    formatNumber(num) {
        if (num >= 1000000) {
            return `${(num / 1000000).toFixed(1)}M`;
        } else if (num >= 1000) {
            return `${(num / 1000).toFixed(this.isMobile ? 0 : 1)}K`;
        }
        return num.toString();
    }

    formatTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInMinutes = Math.floor((now - date) / (1000 * 60));

        if (diffInMinutes < 1) return 'Now';
        if (diffInMinutes < 60) return `${diffInMinutes}m`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h`;
        return `${Math.floor(diffInMinutes / 1440)}d`;
    }

    calculateChange(newValue, totalValue) {
        if (!newValue || !totalValue) return '0%';
        const percentage = ((newValue / totalValue) * 100).toFixed(1);
        return `+${percentage}%`;
    }

    getChangeClass(change) {
        if (change.includes('+')) return 'change-positive';
        if (change.includes('-')) return 'change-negative';
        return 'change-neutral';
    }

    getChangeIcon(change) {
        if (change.includes('+')) return 'trending-up';
        if (change.includes('-')) return 'trending-down';
        return 'minus';
    }

    truncateText(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    updateLastRefreshTime() {
        if (this.elements.lastUpdate) {
            const now = new Date();
            const timeString = this.isMobile ?
                now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) :
                now.toLocaleTimeString();
            this.elements.lastUpdate.textContent = timeString;
        }
    }

    showLoading(show) {
        const indicator = document.getElementById('page-loading-indicator');
        if (indicator) {
            indicator.style.transform = show ? 'scaleX(1)' : 'scaleX(0)';
        }
    }

    showSuccess(message) {
        this.showToast(message, 'success');
    }

    showError(message) {
        this.showToast(message, 'error');
    }

    showToast(message, type = 'info') {
        if (window.topbar && window.topbar.notificationSystem) {
            window.topbar.notificationSystem.show(message, type);
        } else {
            this.showMobileToast(message, type);
        }
    }

    showMobileToast(message, type) {
        const toast = document.createElement('div');
        const colors = {
            success: '#10b981',
            error: '#ef4444',
            warning: '#f59e0b',
            info: '#3b82f6'
        };

        toast.style.cssText = `
            position: fixed;
            bottom: calc(var(--mobile-nav-height, 60px) + env(safe-area-inset-bottom, 0) + 20px);
            left: 50%;
            transform: translateX(-50%);
            background: ${colors[type] || colors.info};
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10002;
            animation: fadeInUp 0.3s ease;
            max-width: calc(100vw - 40px);
            text-align: center;
        `;

        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'fadeOutDown 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);

        if (!document.getElementById('mobile-toast-animations')) {
            const style = document.createElement('style');
            style.id = 'mobile-toast-animations';
            style.textContent = `
                @keyframes fadeInUp {
                    from { transform: translate(-50%, 100%); opacity: 0; }
                    to { transform: translate(-50%, 0); opacity: 1; }
                }
                @keyframes fadeOutDown {
                    from { transform: translate(-50%, 0); opacity: 1; }
                    to { transform: translate(-50%, 100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Cleanup
    destroy() {
        this.stopRealTimeUpdates();

        if (this.systemMonitor) {
            this.systemMonitor.destroy();
        }

        if (this.statisticsManager) {
            this.statisticsManager.destroy();
        }

        window.removeEventListener('resize', this.handleResize);
        window.removeEventListener('orientationchange', this.handleResize);

        console.log('üóë Admin dashboard destroyed');
    }
}

// Initialize dashboard
let adminDashboard;

document.addEventListener('DOMContentLoaded', () => {
    adminDashboard = new AdminDashboard();
});

window.addEventListener('beforeunload', () => {
    if (adminDashboard) {
        adminDashboard.destroy();
    }
});

window.AdminDashboard = AdminDashboard;
window.adminDashboard = adminDashboard;



2. statistics.js 
/**
 * CineBrain Admin Dashboard - Statistics & Charts Manager
 * Handles all chart rendering and statistics visualization
 */

class StatisticsManager {
    constructor(dashboard) {
        this.dashboard = dashboard;
        this.charts = {};

        this.elements = this.initializeElements();
    }

    async init() {
        this.initializeCharts();
        console.log('‚úÖ Statistics Manager initialized');
    }

    initializeElements() {
        return {
            userGrowthChart: document.getElementById('userGrowthChart'),
            contentDistributionChart: document.getElementById('contentDistributionChart'),
            systemPerformanceChart: document.getElementById('systemPerformanceChart'),
            performanceIndicator: document.getElementById('performanceIndicator')
        };
    }

    initializeCharts() {
        const baseChartOptions = this.getBaseChartOptions();

        // User Growth Chart
        this.initializeUserGrowthChart(baseChartOptions);

        // Content Distribution Chart
        this.initializeContentDistributionChart();

        // System Performance Chart
        this.initializeSystemPerformanceChart(baseChartOptions);
    }

    getBaseChartOptions() {
        return {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 750
            },
            plugins: {
                legend: {
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                        usePointStyle: true,
                        font: {
                            size: this.dashboard.isMobile ? 11 : 12
                        },
                        padding: this.dashboard.isMobile ? 10 : 15
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                        font: {
                            size: this.dashboard.isMobile ? 10 : 11
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim(),
                        font: {
                            size: this.dashboard.isMobile ? 10 : 11
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            elements: {
                point: {
                    radius: this.dashboard.isMobile ? 3 : 4,
                    hoverRadius: this.dashboard.isMobile ? 5 : 6
                }
            }
        };
    }

    initializeUserGrowthChart(chartOptions) {
        const userGrowthCtx = this.elements.userGrowthChart?.getContext('2d');
        if (userGrowthCtx) {
            this.charts.userGrowth = new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'New Users',
                        data: [],
                        borderColor: '#113CCF',
                        backgroundColor: 'rgba(17, 60, 207, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: this.dashboard.isMobile ? 2 : 3
                    }, {
                        label: 'Active Users',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: this.dashboard.isMobile ? 2 : 3
                    }]
                },
                options: chartOptions
            });
        }
    }

    initializeContentDistributionChart() {
        const contentDistCtx = this.elements.contentDistributionChart?.getContext('2d');
        if (contentDistCtx) {
            this.charts.contentDistribution = new Chart(contentDistCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#113CCF',
                            '#e50914',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ef4444'
                        ],
                        borderWidth: 0,
                        hoverOffset: this.dashboard.isMobile ? 4 : 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: this.dashboard.isMobile ? '60%' : '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                                usePointStyle: true,
                                padding: this.dashboard.isMobile ? 10 : 15,
                                font: {
                                    size: this.dashboard.isMobile ? 10 : 11
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    initializeSystemPerformanceChart(baseOptions) {
        const ctx = this.elements.systemPerformanceChart?.getContext('2d');
        if (ctx) {
            this.charts.systemPerformance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: this.dashboard.isMobile ? 2 : 3
                    }, {
                        label: 'Memory Usage',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: this.dashboard.isMobile ? 2 : 3
                    }, {
                        label: 'Disk Usage',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: this.dashboard.isMobile ? 2 : 3
                    }]
                },
                options: {
                    ...baseOptions,
                    animation: {
                        duration: 500
                    },
                    scales: {
                        ...baseOptions.scales,
                        y: {
                            ...baseOptions.scales.y,
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                ...baseOptions.scales.y.ticks,
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    updateCharts(data) {
        // Update User Growth Chart
        this.updateUserGrowthChart(data);

        // Update Content Distribution Chart
        this.updateContentDistributionChart(data);
    }

    updateUserGrowthChart(data) {
        if (this.charts.userGrowth && data.user_analytics) {
            const userGrowthData = data.user_analytics.user_growth || [];
            const activeUsersData = data.user_analytics.active_users_trend || [];

            const maxLabels = this.dashboard.isMobile ? 7 : 14;
            const recentGrowthData = userGrowthData.slice(-maxLabels);
            const recentActiveData = activeUsersData.slice(-maxLabels);

            this.charts.userGrowth.data.labels = recentGrowthData.map(item =>
                new Date(item.date).toLocaleDateString('en-US', {
                    month: this.dashboard.isMobile ? 'numeric' : 'short',
                    day: 'numeric'
                })
            );
            this.charts.userGrowth.data.datasets[0].data = recentGrowthData.map(item => item.count);
            this.charts.userGrowth.data.datasets[1].data = recentActiveData.map(item => item.count);
            this.charts.userGrowth.update();
        }
    }

    updateContentDistributionChart(data) {
        if (this.charts.contentDistribution && data.content_analytics) {
            const contentDist = data.content_analytics.content_distribution || [];

            this.charts.contentDistribution.data.labels = contentDist.map(item =>
                this.dashboard.isMobile ? this.dashboard.capitalizeFirst(item.type) :
                    item.type.charAt(0).toUpperCase() + item.type.slice(1)
            );
            this.charts.contentDistribution.data.datasets[0].data = contentDist.map(item => item.count);
            this.charts.contentDistribution.update();
        }
    }

    updatePerformanceChart(data) {
        if (!this.charts.systemPerformance || !data.resources) return;

        const chart = this.charts.systemPerformance;
        const now = new Date();

        // Add new data point
        chart.data.labels.push(now.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
            second: this.dashboard.isMobile ? undefined : '2-digit'
        }));

        // Add performance data
        chart.data.datasets[0].data.push(data.resources.cpu_usage || 0);
        chart.data.datasets[1].data.push(data.resources.memory_usage || 0);
        chart.data.datasets[2].data.push(data.resources.disk_usage || 0);

        // Keep only last 20 data points
        const maxPoints = this.dashboard.isMobile ? 10 : 20;
        if (chart.data.labels.length > maxPoints) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(dataset => dataset.data.shift());
        }

        chart.update();
    }

    updatePerformanceIndicator(data) {
        const performanceIndicator = this.elements.performanceIndicator;
        const performanceDot = performanceIndicator?.querySelector('.performance-dot');
        const performanceText = performanceIndicator?.querySelector('.performance-text');

        if (!data.resources) return;

        const maxUsage = Math.max(
            data.resources.cpu_usage || 0,
            data.resources.memory_usage || 0,
            data.resources.disk_usage || 0
        );

        let status, text;
        if (maxUsage > 90) {
            status = 'danger';
            text = 'Critical';
        } else if (maxUsage > 70) {
            status = 'warning';
            text = 'Warning';
        } else {
            status = '';
            text = 'Optimal';
        }

        if (performanceDot) {
            performanceDot.className = `performance-dot ${status}`;
        }
        if (performanceText) {
            performanceText.textContent = text;
        }
    }

    resizeCharts() {
        Object.values(this.charts).forEach(chart => {
            if (chart && typeof chart.resize === 'function') {
                chart.resize();
            }
        });
    }

    // Theme update method for when theme changes
    updateChartsTheme() {
        const textPrimary = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
        const textMuted = getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim();

        Object.values(this.charts).forEach(chart => {
            if (chart && chart.options) {
                // Update legend colors
                if (chart.options.plugins?.legend?.labels) {
                    chart.options.plugins.legend.labels.color = textPrimary;
                }

                // Update scales colors
                if (chart.options.scales) {
                    Object.keys(chart.options.scales).forEach(scaleKey => {
                        if (chart.options.scales[scaleKey].ticks) {
                            chart.options.scales[scaleKey].ticks.color = textMuted;
                        }
                    });
                }

                chart.update();
            }
        });
    }

    // Export chart data for analytics
    exportChartData(chartType) {
        const chart = this.charts[chartType];
        if (!chart) return null;

        return {
            labels: chart.data.labels,
            datasets: chart.data.datasets.map(dataset => ({
                label: dataset.label,
                data: dataset.data
            }))
        };
    }

    // Get chart statistics
    getChartStats(chartType) {
        const chart = this.charts[chartType];
        if (!chart || !chart.data.datasets) return null;

        const stats = {};
        chart.data.datasets.forEach(dataset => {
            const data = dataset.data;
            if (data.length > 0) {
                stats[dataset.label] = {
                    total: data.reduce((sum, value) => sum + value, 0),
                    average: data.reduce((sum, value) => sum + value, 0) / data.length,
                    max: Math.max(...data),
                    min: Math.min(...data),
                    latest: data[data.length - 1]
                };
            }
        });

        return stats;
    }

    destroy() {
        Object.values(this.charts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') {
                chart.destroy();
            }
        });
        console.log('üóë Statistics manager destroyed');
    }
}

// Export for global access
window.StatisticsManager = StatisticsManager;



3. system.js
/**
 * CineBrain Admin Dashboard - System Monitoring
 * Real-time system health and alert management
 */

class SystemMonitor {
    constructor(dashboard) {
        this.dashboard = dashboard;
        this.apiBase = dashboard.apiBase;

        // System monitoring properties
        this.monitoring = {
            refreshRate: 5000,
            healthTimer: null,
            alertsTimer: null,
            performanceTimer: null,
            notificationTimer: null
        };

        this.systemData = {
            health: null,
            alerts: [],
            performance: null,
            services: null,
            lastAlertCheck: null
        };

        this.processedAlerts = new Set();
        this.notificationQueue = [];

        this.elements = this.initializeElements();
    }

    async init() {
        this.setupEventListeners();
        this.setupNotificationSystem();
        this.systemData.lastAlertCheck = new Date();
        this.startSystemMonitoring();
        await this.loadAllSystemData();
    }

    initializeElements() {
        return {
            mainStatusDot: document.getElementById('mainStatusDot'),
            mainStatusText: document.getElementById('mainStatusText'),
            dbStatus: document.getElementById('dbStatus'),
            cacheStatus: document.getElementById('cacheStatus'),
            apiStatus: document.getElementById('apiStatus'),
            alertsSection: document.getElementById('alertsSection'),
            realTimeAlerts: document.getElementById('realTimeAlerts'),
            activeAlertsCount: document.getElementById('activeAlertsCount'),
            servicesStatusGrid: document.getElementById('servicesStatusGrid'),
            adminActivityMetrics: document.getElementById('adminActivityMetrics'),
            systemNotificationsList: document.getElementById('systemNotificationsList')
        };
    }

    setupEventListeners() {
        // Quick health check
        const quickHealthCheck = document.getElementById('quickHealthCheck');
        quickHealthCheck?.addEventListener('click', () => {
            this.performQuickHealthCheck();
            this.dashboard.hapticFeedback('medium');
        });

        // Monitoring refresh rate
        const monitoringRefreshRate = document.getElementById('monitoringRefreshRate');
        monitoringRefreshRate?.addEventListener('change', (e) => {
            this.updateMonitoringRefreshRate(parseInt(e.target.value));
        });

        // Dismiss all alerts
        const dismissAllAlerts = document.getElementById('dismissAllAlerts');
        dismissAllAlerts?.addEventListener('click', () => {
            this.dismissAllAlerts();
        });

        // Mark all notifications read
        const markAllNotificationsRead = document.getElementById('markAllNotificationsRead');
        markAllNotificationsRead?.addEventListener('click', () => {
            this.markAllNotificationsAsRead();
        });
    }

    setupNotificationSystem() {
        setInterval(() => {
            this.processNotificationQueue();
        }, 1000);
    }

    startSystemMonitoring() {
        // Staggered polling to reduce server load
        this.monitoring.alertsTimer = setInterval(() => {
            this.loadSystemAlerts();
        }, 5000);

        setTimeout(() => {
            this.monitoring.notificationTimer = setInterval(() => {
                this.loadSystemNotifications();
            }, 8000);
        }, 2000);

        setTimeout(() => {
            this.monitoring.healthTimer = setInterval(() => {
                this.loadSystemHealth();
            }, 8000);
        }, 4000);

        setTimeout(() => {
            this.monitoring.performanceTimer = setInterval(() => {
                this.loadSystemPerformance();
                this.loadServicesStatus();
                this.loadAdminActivity();
            }, 15000);
        }, 6000);

        console.log('‚úÖ Optimized HTTP polling monitoring started');
        console.log('   - Alerts: 5s | Health/Notifications: 8s | Performance: 15s');
    }

    async loadAllSystemData() {
        try {
            await Promise.allSettled([
                this.loadSystemHealth(),
                this.loadSystemAlerts(),
                this.loadSystemPerformance(),
                this.loadServicesStatus(),
                this.loadAdminActivity(),
                this.loadSystemNotifications()
            ]);

            this.updateSystemStatusBar();
        } catch (error) {
            console.error('Error loading system data:', error);
        }
    }

    async loadSystemHealth() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/health/detailed');
            if (response.ok) {
                const data = await response.json();
                this.systemData.health = data;
                this.updateSystemHealthCards(data);
                this.updateSystemStatusBar(data);
            }
        } catch (error) {
            console.error('Error loading system health:', error);
            this.updateSystemStatusBar({ status: 'error' });
        }
    }

    async loadSystemAlerts() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/system/monitoring/alerts');
            if (response.ok) {
                const data = await response.json();
                const alerts = data.alerts || [];

                alerts.forEach(alert => {
                    const alertId = alert.id || `${alert.component}-${alert.message}`;
                    if (!this.processedAlerts.has(alertId)) {
                        this.processedAlerts.add(alertId);
                        this.handleNewAlert(alert);
                    }
                });

                this.systemData.alerts = alerts;
                this.updateSystemAlerts(alerts);
            }
        } catch (error) {
            console.error('Error loading system alerts:', error);
        }
    }

    async loadSystemPerformance() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/performance');
            if (response.ok) {
                const data = await response.json();
                this.systemData.performance = data;

                // Update statistics manager with performance data
                if (this.dashboard.statisticsManager) {
                    this.dashboard.statisticsManager.updatePerformanceChart(data);
                    this.dashboard.statisticsManager.updatePerformanceIndicator(data);
                }
            }
        } catch (error) {
            console.error('Error loading system performance:', error);
        }
    }

    async loadServicesStatus() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/system/services');
            if (response.ok) {
                const data = await response.json();
                this.systemData.services = data;
                this.updateServicesGrid(data);
            }
        } catch (error) {
            console.error('Error loading services status:', error);
        }
    }

    async loadAdminActivity() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/admin/monitoring/activity');
            if (response.ok) {
                const data = await response.json();
                this.updateAdminActivityMetrics(data);
            }
        } catch (error) {
            console.error('Error loading admin activity:', error);
        }
    }

    async loadSystemNotifications() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/admin/monitoring/notifications');
            if (response.ok) {
                const data = await response.json();
                this.updateSystemNotifications(data);

                const notifications = data.recent_notifications || [];
                const unreadCount = notifications.filter(n => !n.is_read).length;

                const notificationBadge = document.getElementById('notificationBadge');
                if (notificationBadge) {
                    if (unreadCount > 0) {
                        notificationBadge.textContent = unreadCount;
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }

                localStorage.setItem('cinebrain-admin-notifications', JSON.stringify(notifications));

                window.dispatchEvent(new CustomEvent('cinebrain-notifications-updated', {
                    detail: { notifications, unreadCount }
                }));
            }
        } catch (error) {
            console.error('Error loading system notifications:', error);
        }
    }

    handleNewAlert(alert) {
        this.notificationQueue.push({
            type: 'alert',
            title: `System Alert: ${alert.component || 'System'}`,
            message: alert.message,
            level: alert.level,
            timestamp: alert.timestamp || new Date().toISOString(),
            data: alert
        });
    }

    handleNewNotification(notification) {
        this.notificationQueue.push({
            type: 'notification',
            title: notification.title,
            message: notification.message,
            level: notification.is_urgent ? 'warning' : 'info',
            timestamp: notification.created_at || new Date().toISOString(),
            data: notification
        });
    }

    handleStatsUpdate(stats) {
        if (stats.overview) {
            this.dashboard.dashboardData.overview = { ...this.dashboard.dashboardData.overview, ...stats.overview };
            this.dashboard.renderOverviewCards(this.dashboard.dashboardData.overview);
        }
    }

    handleSupportUpdate(support) {
        if (support.ticket_stats) {
            if (this.dashboard.dashboardData.supportDashboard) {
                this.dashboard.dashboardData.supportDashboard.ticket_stats = support.ticket_stats;
                this.dashboard.renderSupportStats(this.dashboard.dashboardData.supportDashboard);
            }
        }
    }

    processNotificationQueue() {
        while (this.notificationQueue.length > 0) {
            const notification = this.notificationQueue.shift();
            this.sendNotificationToTopbar(notification);
        }
    }

    sendNotificationToTopbar(notification) {
        const notificationBadge = document.getElementById('notificationBadge');
        if (notificationBadge) {
            const currentCount = parseInt(notificationBadge.textContent || '0');
            notificationBadge.textContent = currentCount + 1;
            notificationBadge.style.display = 'block';
        }

        const notifications = JSON.parse(localStorage.getItem('cinebrain-admin-notifications') || '[]');
        notifications.unshift({
            id: Date.now(),
            ...notification,
            isRead: false,
            createdAt: new Date().toISOString()
        });

        if (notifications.length > 50) {
            notifications.splice(50);
        }

        localStorage.setItem('cinebrain-admin-notifications', JSON.stringify(notifications));

        setTimeout(() => {
            window.dispatchEvent(new CustomEvent('cinebrain-notification', {
                detail: notification,
                bubbles: true
            }));
        }, 100);

        if (notification.level === 'critical' || notification.level === 'error' || notification.level === 'urgent') {
            this.dashboard.showToast(notification.message, notification.level === 'critical' ? 'error' : 'warning');
        }
    }

    updateSystemHealthCards(data) {
        this.updateHealthCard('database', data.components?.database || {});
        this.updateHealthCard('cache', data.components?.cache || {});
        this.updateHealthCard('services', data.components?.external_apis || {});
        this.updateHealthCard('performance', data.resources || {});
    }

    updateHealthCard(type, data) {
        const healthStatus = document.getElementById(`${type}HealthStatus`);
        const healthDot = healthStatus?.querySelector('.health-dot');

        if (!healthDot) return;

        let status = 'healthy';
        if (type === 'database') {
            status = data.status === 'healthy' ? 'healthy' : 'danger';
            this.updateElement(`dbConnectionStatus`, data.connection || data.status || 'Unknown');
            this.updateElement(`dbResponseTime`, data.response_time_ms ? `${data.response_time_ms}ms` : '--');
            this.updateElement(`dbConnections`, data.active_connections || '--');
        } else if (type === 'cache') {
            status = data.functional ? 'healthy' : (data.configured ? 'warning' : 'danger');
            this.updateElement(`cacheType`, data.type || 'Not configured');
            this.updateElement(`cacheHitRate`, data.hit_rate || '--');
            this.updateElement(`cacheMemory`, data.memory_usage || '--');
        } else if (type === 'services') {
            const servicesHealthy = data.tmdb?.configured && data.youtube?.configured && data.cloudinary?.configured;
            status = servicesHealthy ? 'healthy' : 'warning';
            this.updateElement(`tmdbStatus`, data.tmdb?.configured ? '‚úì' : '‚úó');
            this.updateElement(`youtubeStatus`, data.youtube?.configured ? '‚úì' : '‚úó');
            this.updateElement(`cloudinaryStatus`, data.cloudinary?.configured ? '‚úì' : '‚úó');
        } else if (type === 'performance') {
            const maxUsage = Math.max(data.memory_usage || 0, data.cpu_usage || 0, data.disk_usage || 0);
            status = maxUsage > 90 ? 'danger' : (maxUsage > 70 ? 'warning' : 'healthy');
            this.updateElement(`cpuUsage`, data.cpu_usage ? `${data.cpu_usage}%` : '--%');
            this.updateElement(`memoryUsage`, data.memory_usage ? `${data.memory_usage}%` : '--%');
            this.updateElement(`diskUsage`, data.disk_usage ? `${data.disk_usage}%` : '--%');
        }

        healthDot.className = `health-dot ${status === 'healthy' ? '' : status}`;
    }

    updateSystemStatusBar(data) {
        const mainStatusDot = this.elements.mainStatusDot;
        const mainStatusText = this.elements.mainStatusText;

        if (data) {
            const status = data.status || 'unknown';
            if (mainStatusDot) {
                mainStatusDot.className = `status-dot ${status === 'healthy' ? 'pulse-green' :
                    status === 'degraded' ? 'pulse-yellow' : 'pulse-red'
                    }`;
            }
            if (mainStatusText) {
                mainStatusText.textContent = status === 'healthy' ? 'System Online' :
                    status === 'degraded' ? 'System Degraded' : 'System Issues';
            }
        }

        this.updateElement('dbStatus', data?.database === 'connected' ? 'Connected' : 'Error');
        this.updateElement('cacheStatus', data?.cache === 'connected' ? 'Active' : 'Inactive');
        this.updateElement('apiStatus', data?.api_keys?.tmdb ? 'Online' : 'Offline');
        this.updateElement('liveConnectionStatus', 'LIVE');
    }

    updateSystemAlerts(alerts) {
        const alertsSection = this.elements.alertsSection;
        const realTimeAlerts = this.elements.realTimeAlerts;
        const activeAlertsCount = this.elements.activeAlertsCount;

        if (!alerts || alerts.length === 0) {
            if (alertsSection) alertsSection.style.display = 'none';
            if (activeAlertsCount) activeAlertsCount.textContent = '0';
            return;
        }

        if (alertsSection) alertsSection.style.display = 'block';
        if (activeAlertsCount) activeAlertsCount.textContent = alerts.length;

        alerts.forEach(alert => {
            if (alert.level === 'critical' || alert.level === 'error') {
                this.sendNotificationToTopbar({
                    type: 'alert',
                    title: `System Alert: ${alert.component || 'System'}`,
                    message: alert.message,
                    level: alert.level,
                    timestamp: alert.timestamp || new Date().toISOString()
                });
            }
        });

        if (realTimeAlerts) {
            realTimeAlerts.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.level || 'info'}" data-alert-id="${alert.id || Date.now()}">
                    <div class="alert-icon">
                        <i data-feather="${this.getAlertIcon(alert.level)}"></i>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.component || 'System'}</div>
                        <div class="alert-message">${alert.message}</div>
                    </div>
                    <div class="alert-time">${this.dashboard.formatTimeAgo(alert.timestamp || new Date().toISOString())}</div>
                    <div class="alert-actions">
                        <button class="alert-dismiss" onclick="adminDashboard.systemMonitor.dismissAlert('${alert.id || Date.now()}')">
                            <i data-feather="x"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
    }

    updateServicesGrid(data) {
        const servicesGrid = this.elements.servicesStatusGrid;
        if (!servicesGrid || !data.application_services) return;

        const services = [
            { name: 'Auth', status: data.application_services.auth_service },
            { name: 'Admin', status: data.application_services.admin_service },
            { name: 'Support', status: data.application_services.support_service },
            { name: 'Content', status: data.application_services.content_service },
            { name: 'Analytics', status: data.application_services.analytics_service || true },
            { name: 'Cache', status: data.core_services.cache }
        ];

        servicesGrid.innerHTML = services.map(service => `
            <div class="service-item">
                <div class="service-status ${service.status ? '' : 'danger'}"></div>
                <div class="service-name">${service.name}</div>
                <div class="service-info">${service.status ? 'Online' : 'Offline'}</div>
            </div>
        `).join('');
    }

    updateAdminActivityMetrics(data) {
        const adminActivityMetrics = this.elements.adminActivityMetrics;
        if (!adminActivityMetrics || !data.admin_users) return;

        const metrics = [
            {
                label: 'Active Admins',
                value: data.admin_users.active_24h || 0,
                change: `${data.admin_users.activity_rate_24h || 0}%`
            },
            {
                label: 'Total Admins',
                value: data.admin_users.total_admins || 0,
                change: 'All time'
            },
            {
                label: 'Recommendations',
                value: data.admin_recommendations?.recent_7d || 0,
                change: 'This week'
            },
            {
                label: 'Active Rate',
                value: `${data.admin_users.activity_rate_24h || 0}%`,
                change: '24h rate'
            }
        ];

        adminActivityMetrics.innerHTML = metrics.map(metric => `
            <div class="activity-metric">
                <div class="activity-metric-value">${metric.value}</div>
                <div class="activity-metric-label">${metric.label}</div>
                <div class="activity-metric-change">${metric.change}</div>
            </div>
        `).join('');
    }

    updateSystemNotifications(data) {
        const notificationsList = this.elements.systemNotificationsList;
        if (!notificationsList) return;

        const notifications = data.recent_notifications || [];

        if (notifications.length === 0) {
            notificationsList.innerHTML = `
                <div class="table-empty-state">
                    <i data-feather="bell"></i>
                    <p>No system notifications</p>
                </div>
            `;
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            return;
        }

        notificationsList.innerHTML = notifications.slice(0, 5).map(notification => `
            <div class="notification-item ${notification.is_read ? '' : 'unread'} ${notification.is_urgent ? 'urgent' : ''}">
                <div class="notification-icon">
                    <i data-feather="${this.getNotificationIcon(notification.type)}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${this.dashboard.truncateText(notification.message, 60)}</div>
                    <div class="notification-time">${this.dashboard.formatTimeAgo(notification.created_at)}</div>
                </div>
            </div>
        `).join('');

        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    // Action Methods
    async performQuickHealthCheck() {
        this.dashboard.showToast('Running quick health check...', 'info');

        try {
            await Promise.all([
                this.loadSystemHealth(),
                this.loadServicesStatus(),
                this.loadSystemPerformance()
            ]);
            this.dashboard.showToast('Health check completed', 'success');
        } catch (error) {
            this.dashboard.showToast('Health check failed', 'error');
        }
    }

    updateMonitoringRefreshRate(newRate) {
        this.monitoring.refreshRate = newRate;

        this.stopSystemMonitoring();
        this.startSystemMonitoring();

        this.dashboard.showToast(`Monitoring refresh rate updated to ${newRate / 1000}s`, 'success');
    }

    checkMissedNotifications() {
        this.loadSystemNotifications();
        this.loadSystemAlerts();
    }

    dismissAlert(alertId) {
        const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
        if (alertElement) {
            alertElement.remove();
        }

        this.systemData.alerts = this.systemData.alerts.filter(alert =>
            (alert.id || Date.now().toString()) !== alertId
        );
    }

    dismissAllAlerts() {
        const alertsContainer = this.elements.realTimeAlerts;
        const alertsSection = this.elements.alertsSection;

        if (alertsContainer) {
            alertsContainer.innerHTML = '';
        }
        if (alertsSection) {
            alertsSection.style.display = 'none';
        }

        this.systemData.alerts = [];
        this.processedAlerts.clear();

        this.dashboard.showToast('All alerts dismissed', 'success');
    }

    async markAllNotificationsAsRead() {
        try {
            const response = await this.dashboard.makeAuthenticatedRequest('/admin/notifications/mark-all-read', {
                method: 'PUT'
            });

            if (response.ok) {
                this.dashboard.showToast('All notifications marked as read', 'success');
                this.loadSystemNotifications();

                const notificationBadge = document.getElementById('notificationBadge');
                if (notificationBadge) {
                    notificationBadge.style.display = 'none';
                    notificationBadge.textContent = '0';
                }
            }
        } catch (error) {
            this.dashboard.showToast('Failed to mark notifications as read', 'error');
        }
    }

    stopSystemMonitoring() {
        if (this.monitoring.healthTimer) {
            clearInterval(this.monitoring.healthTimer);
        }
        if (this.monitoring.alertsTimer) {
            clearInterval(this.monitoring.alertsTimer);
        }
        if (this.monitoring.performanceTimer) {
            clearInterval(this.monitoring.performanceTimer);
        }
        if (this.monitoring.notificationTimer) {
            clearInterval(this.monitoring.notificationTimer);
        }
    }

    // Utility Methods
    getAlertIcon(level) {
        const icons = {
            'critical': 'alert-circle',
            'error': 'x-circle',
            'warning': 'alert-triangle',
            'info': 'info',
            'success': 'check-circle'
        };
        return icons[level] || 'alert-circle';
    }

    getNotificationIcon(type) {
        const icons = {
            'new_ticket': 'message-circle',
            'urgent_ticket': 'alert-circle',
            'sla_breach': 'clock',
            'feedback_received': 'message-square',
            'system_alert': 'alert-triangle',
            'user_activity': 'users',
            'content_added': 'plus-circle'
        };
        return icons[type] || 'bell';
    }

    updateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    }

    destroy() {
        this.stopSystemMonitoring();
        console.log('üóë System monitor destroyed');
    }
}

// Export for global access
window.SystemMonitor = SystemMonitor;