<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <script>document.write('<script src="/includes/head.html"><\/script>');</script>
</head>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <!-- Main Content -->
    <main class="pt-16">
        <!-- Hero Section -->
        <section id="detailsHero" class="details-hero">
            <div class="details-overlay"></div>
            <div class="container">
                <div class="details-content">
                    <h1 id="contentTitle" class="details-title">Loading...</h1>
                    <div id="contentMeta" class="details-meta"></div>
                    <p id="contentOverview" class="details-overview"></p>
                    <div id="contentActions" class="details-actions"></div>
                </div>
            </div>
        </section>

        <div class="container py-8">
            <!-- Content Info Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <!-- Main Info -->
                <div class="lg:col-span-2">
                    <div class="content-info-section">
                        <h2 class="section-title mb-4">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            Details
                        </h2>
                        <div id="contentDetails" class="content-details-grid"></div>
                    </div>

                    <!-- Cast & Crew -->
                    <div class="content-info-section mt-8">
                        <h2 class="section-title mb-4">
                            <i class="fas fa-users text-purple-500"></i>
                            Cast & Crew
                        </h2>
                        <div id="castCrew" class="cast-crew-grid"></div>
                    </div>

                    <!-- Trailers & Videos -->
                    <div class="content-info-section mt-8">
                        <h2 class="section-title mb-4">
                            <i class="fas fa-play text-red-500"></i>
                            Trailers & Videos
                        </h2>
                        <div id="videos" class="videos-grid"></div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Poster -->
                    <div class="details-poster mb-6">
                        <img id="contentPoster" src="" alt="" class="w-full rounded-lg">
                    </div>

                    <!-- Quick Info -->
                    <div class="details-sidebar-info">
                        <div id="sidebarInfo" class="space-y-4"></div>
                    </div>

                    <!-- User Actions -->
                    <div class="details-user-actions mt-6">
                        <div id="userActions" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Similar Content -->
            <section class="mb-12">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="section-title">
                        <i class="fas fa-thumbs-up text-green-500"></i>
                        You Might Also Like
                    </h2>
                </div>
                <div id="similarContent">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <div data-include="footer"></div>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class DetailsManager {
            constructor() {
                this.contentId = null;
                this.contentData = null;
                this.init();
            }

            init() {
                this.contentId = this.getContentIdFromURL();
                if (!this.contentId) {
                    this.showError('Content not found');
                    return;
                }

                this.loadContentDetails();
            }

            getContentIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            }

            async loadContentDetails() {
                try {
                    this.contentData = await APIService.getContentDetails(this.contentId);
                    this.renderContent();
                    this.loadSimilarContent();
                } catch (error) {
                    console.error('Error loading content details:', error);
                    this.showError('Failed to load content details');
                }
            }

            renderContent() {
                const data = this.contentData;
                
                // Update page title
                document.title = `${data.title} | CineScope`;

                // Hero section
                this.renderHero(data);
                
                // Details grid
                this.renderDetails(data);
                
                // Cast & Crew
                this.renderCastCrew(data);
                
                // Videos
                this.renderVideos(data);
                
                // Sidebar
                this.renderSidebar(data);
            }

            renderHero(data) {
                // Background
                if (data.backdrop_path) {
                    document.getElementById('detailsHero').style.backgroundImage = 
                        `url('${data.backdrop_path}')`;
                }

                // Title
                document.getElementById('contentTitle').textContent = data.title;

                // Meta information
                const metaItems = [];
                if (data.release_date) {
                    metaItems.push(`<span class="meta-item"><i class="fas fa-calendar mr-1"></i> ${new Date(data.release_date).getFullYear()}</span>`);
                }
                if (data.runtime) {
                    metaItems.push(`<span class="meta-item"><i class="fas fa-clock mr-1"></i> ${data.runtime}m</span>`);
                }
                if (data.rating) {
                    metaItems.push(`<span class="meta-item rating"><i class="fas fa-star mr-1"></i> ${data.rating.toFixed(1)}</span>`);
                }
                metaItems.push(`<span class="badge">${data.content_type.toUpperCase()}</span>`);

                document.getElementById('contentMeta').innerHTML = metaItems.join('');

                // Overview
                document.getElementById('contentOverview').textContent = data.overview || 'No overview available';

                // Actions
                const actions = [];
                
                if (data.youtube_trailer) {
                    actions.push(`
                        <button class="btn btn-primary" onclick="window.open('${data.youtube_trailer}', '_blank')">
                            <i class="fas fa-play mr-2"></i>
                            Watch Trailer
                        </button>
                    `);
                }

                if (AuthManager.isAuthenticated()) {
                    actions.push(`
                        <button class="btn btn-secondary" onclick="ContentManager.addToWatchlist(${data.id})">
                            <i class="fas fa-bookmark mr-2"></i>
                            Add to Watchlist
                        </button>
                    `);
                    actions.push(`
                        <button class="btn btn-ghost" onclick="ContentManager.addToFavorites(${data.id})">
                            <i class="fas fa-heart mr-2"></i>
                            Add to Favorites
                        </button>
                    `);
                }

                document.getElementById('contentActions').innerHTML = actions.join('');
            }

            renderDetails(data) {
                const details = [];

                if (data.genres && data.genres.length > 0) {
                    details.push({
                        label: 'Genres',
                        value: data.genres.map(genre => `<span class="genre-tag">${genre}</span>`).join('')
                    });
                }

                if (data.languages && data.languages.length > 0) {
                    details.push({
                        label: 'Languages',
                        value: data.languages.join(', ')
                    });
                }

                if (data.content_type === 'anime' && data.anime_genres) {
                    details.push({
                        label: 'Anime Categories',
                        value: data.anime_genres.join(', ')
                    });
                }

                if (data.vote_count) {
                    details.push({
                        label: 'Vote Count',
                        value: data.vote_count.toLocaleString()
                    });
                }

                if (data.original_title && data.original_title !== data.title) {
                    details.push({
                        label: 'Original Title',
                        value: data.original_title
                    });
                }

                const detailsHTML = details.map(detail => `
                    <div class="detail-item">
                        <span class="detail-label">${detail.label}:</span>
                        <span class="detail-value">${detail.value}</span>
                    </div>
                `).join('');

                document.getElementById('contentDetails').innerHTML = detailsHTML;
            }

            renderCastCrew(data) {
                const castHTML = [];
                
                if (data.cast && data.cast.length > 0) {
                    castHTML.push('<h3 class="text-lg font-semibold mb-3">Cast</h3>');
                    castHTML.push('<div class="cast-grid">');
                    
                    data.cast.slice(0, 12).forEach(person => {
                        const profileImage = person.profile_path 
                            ? `https://image.tmdb.org/t/p/w200${person.profile_path}`
                            : '/assets/images/person-placeholder.jpg';
                        
                        castHTML.push(`
                            <div class="cast-card">
                                <img src="${profileImage}" alt="${person.name}" class="cast-image">
                                <div class="cast-info">
                                    <div class="cast-name">${person.name}</div>
                                    <div class="cast-character">${person.character || person.job || ''}</div>
                                </div>
                            </div>
                        `);
                    });
                    
                    castHTML.push('</div>');
                }

                if (data.crew && data.crew.length > 0) {
                    const keyCrewJobs = ['Director', 'Writer', 'Producer', 'Executive Producer'];
                    const keyCrew = data.crew.filter(person => keyCrewJobs.includes(person.job));
                    
                    if (keyCrew.length > 0) {
                        castHTML.push('<h3 class="text-lg font-semibold mb-3 mt-6">Key Crew</h3>');
                        castHTML.push('<div class="crew-list">');
                        
                        keyCrew.forEach(person => {
                            castHTML.push(`
                                <div class="crew-item">
                                    <span class="crew-name">${person.name}</span>
                                    <span class="crew-job">${person.job}</span>
                                </div>
                            `);
                        });
                        
                        castHTML.push('</div>');
                    }
                }

                document.getElementById('castCrew').innerHTML = castHTML.join('') || 
                    '<p class="text-gray-400">No cast and crew information available</p>';
            }

            renderVideos(data) {
                const videos = [];
                
                if (data.youtube_trailer) {
                    const videoId = data.youtube_trailer.split('v=')[1]?.split('&')[0];
                    if (videoId) {
                        videos.push({
                            name: 'Official Trailer',
                            key: videoId,
                            site: 'YouTube'
                        });
                    }
                }

                if (videos.length > 0) {
                    const videosHTML = videos.map(video => `
                        <div class="video-card">
                            <div class="video-thumbnail" onclick="this.innerHTML='<iframe src=&quot;https://www.youtube.com/embed/${video.key}&quot; frameborder=&quot;0&quot; allowfullscreen></iframe>'">
                                <img src="https://img.youtube.com/vi/${video.key}/hqdefault.jpg" alt="${video.name}">
                                <div class="video-play-button">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="video-info">
                                <div class="video-name">${video.name}</div>
                                <div class="video-site">${video.site}</div>
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('videos').innerHTML = videosHTML;
                } else {
                    document.getElementById('videos').innerHTML = 
                        '<p class="text-gray-400">No trailers or videos available</p>';
                }
            }

            renderSidebar(data) {
                // Poster
                const posterUrl = data.poster_path || '/assets/images/placeholder.jpg';
                const posterImg = document.getElementById('contentPoster');
                posterImg.src = posterUrl;
                posterImg.alt = data.title;

                // Sidebar info
                const sidebarInfo = [];

                if (data.rating) {
                    sidebarInfo.push(`
                        <div class="sidebar-info-item">
                            <strong>Rating</strong>
                            <div class="rating-display">
                                <span class="rating-score">${data.rating.toFixed(1)}</span>
                                <div class="rating-stars">
                                    ${this.generateStars(data.rating)}
                                </div>
                            </div>
                        </div>
                    `);
                }

                if (data.release_date) {
                    sidebarInfo.push(`
                        <div class="sidebar-info-item">
                            <strong>Release Date</strong>
                            <span>${new Date(data.release_date).toLocaleDateString()}</span>
                        </div>
                    `);
                }

                if (data.runtime) {
                    sidebarInfo.push(`
                        <div class="sidebar-info-item">
                            <strong>Runtime</strong>
                            <span>${Math.floor(data.runtime / 60)}h ${data.runtime % 60}m</span>
                        </div>
                    `);
                }

                document.getElementById('sidebarInfo').innerHTML = sidebarInfo.join('');

                // User actions for sidebar
                if (AuthManager.isAuthenticated()) {
                    const userActions = `
                        <button class="btn btn-primary w-full" onclick="ContentManager.addToWatchlist(${data.id})">
                            <i class="fas fa-bookmark mr-2"></i>
                            Add to Watchlist
                        </button>
                        <button class="btn btn-secondary w-full" onclick="ContentManager.addToFavorites(${data.id})">
                            <i class="fas fa-heart mr-2"></i>
                            Add to Favorites
                        </button>
                        <div class="rating-input">
                            <label class="text-sm font-medium">Rate this content:</label>
                            <div class="star-rating" data-rating="0">
                                ${[1,2,3,4,5].map(i => `<i class="fas fa-star star" data-rating="${i}"></i>`).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('userActions').innerHTML = userActions;
                    this.initializeRating();
                }
            }

            generateStars(rating) {
                const fullStars = Math.floor(rating / 2);
                const halfStar = rating % 2 >= 1;
                let stars = '';
                
                for (let i = 0; i < 5; i++) {
                    if (i < fullStars) {
                        stars += '<i class="fas fa-star"></i>';
                    } else if (i === fullStars && halfStar) {
                        stars += '<i class="fas fa-star-half-alt"></i>';
                    } else {
                        stars += '<i class="far fa-star"></i>';
                    }
                }
                
                return stars;
            }

            initializeRating() {
                const stars = document.querySelectorAll('.star-rating .star');
                stars.forEach(star => {
                    star.addEventListener('click', (e) => {
                        const rating = parseInt(e.target.dataset.rating);
                        this.setRating(rating);
                        this.submitRating(rating);
                    });
                });
            }

            setRating(rating) {
                const stars = document.querySelectorAll('.star-rating .star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }

            async submitRating(rating) {
                try {
                    await APIService.recordInteraction(this.contentId, 'rating', rating);
                    ContentManager.showToast('Rating submitted successfully', 'success');
                } catch (error) {
                    console.error('Error submitting rating:', error);
                    ContentManager.showToast('Failed to submit rating', 'error');
                }
            }

            async loadSimilarContent() {
                try {
                    const response = await APIService.getSimilarContent(this.contentId, 12);
                    const similarContent = response.recommendations || [];
                    
                    if (similarContent.length > 0) {
                        document.getElementById('similarContent').innerHTML = app.createContentGrid(similarContent);
                    } else {
                        document.getElementById('similarContent').innerHTML = 
                            '<p class="text-center text-gray-400 py-8">No similar content found</p>';
                    }
                } catch (error) {
                    console.error('Error loading similar content:', error);
                    document.getElementById('similarContent').innerHTML = 
                        '<p class="text-center text-gray-400 py-8">Failed to load similar content</p>';
                }
            }

            showError(message) {
                document.querySelector('main').innerHTML = `
                    <div class="container py-20 text-center">
                        <i class="fas fa-exclamation-triangle text-6xl text-gray-400 mb-4"></i>
                        <h1 class="text-2xl font-bold mb-2">Content Not Found</h1>
                        <p class="text-gray-400 mb-8">${message}</p>
                        <a href="/" class="btn btn-primary">Go Home</a>
                    </div>
                `;
            }
        }

        // Initialize details page
        document.addEventListener('DOMContentLoaded', () => {
            new DetailsManager();
        });
    </script>
</body>
</html>