<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Details - CineScope</title>
    
    <!-- Stylesheets -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
</head>
<body class="dark-theme">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-logo">
                <div class="logo-animation">
                    <span class="logo-text">CineScope</span>
                    <div class="loading-bars">
                        <div class="loading-bar" style="--delay: 0s"></div>
                        <div class="loading-bar" style="--delay: 0.1s"></div>
                        <div class="loading-bar" style="--delay: 0.2s"></div>
                        <div class="loading-bar" style="--delay: 0.3s"></div>
                        <div class="loading-bar" style="--delay: 0.4s"></div>
                    </div>
                </div>
            </div>
            <div class="loading-text">
                <p id="loadingText">Loading content details...</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <main class="details-main">
        <!-- Hero Section -->
        <section class="details-hero" id="detailsHero">
            <!-- Will be populated by JavaScript -->
        </section>

        <!-- Content Details -->
        <section class="details-content">
            <div class="details-container">
                <!-- Main Info -->
                <div class="details-info">
                    <div class="details-primary">
                        <div class="details-poster">
                            <img id="contentPoster" src="" alt="" class="poster-image">
                            <div class="poster-actions">
                                <button class="action-btn primary" id="playBtn" onclick="playTrailer()">
                                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    Play Trailer
                                </button>
                                <button class="action-btn secondary" id="watchlistBtn" onclick="toggleWatchlist()">
                                    <svg viewBox="0 0 24 24"><path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1z"/></svg>
                                    <span id="watchlistText">Add to Watchlist</span>
                                </button>
                                <button class="action-btn secondary" id="favoriteBtn" onclick="toggleFavorite()">
                                    <svg viewBox="0 0 24 24"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    <span id="favoriteText">Add to Favorites</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="details-text">
                            <h1 class="details-title" id="contentTitle"></h1>
                            <div class="details-meta" id="contentMeta"></div>
                            <div class="details-rating" id="contentRating"></div>
                            <div class="details-genres" id="contentGenres"></div>
                            <div class="details-overview">
                                <h3>Overview</h3>
                                <p id="contentOverview"></p>
                            </div>
                            <div class="user-rating-section" id="userRatingSection">
                                <h4>Rate this content</h4>
                                <div class="rating-stars" id="ratingStars">
                                    <span class="star" data-rating="1">★</span>
                                    <span class="star" data-rating="2">★</span>
                                    <span class="star" data-rating="3">★</span>
                                    <span class="star" data-rating="4">★</span>
                                    <span class="star" data-rating="5">★</span>
                                </div>
                                <span class="rating-text" id="ratingText">Click to rate</span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info -->
                    <div class="details-additional">
                        <!-- Cast -->
                        <div class="cast-section" id="castSection">
                            <h3>Cast</h3>
                            <div class="cast-grid" id="castGrid"></div>
                        </div>

                        <!-- Crew -->
                        <div class="crew-section" id="crewSection">
                            <h3>Crew</h3>
                            <div class="crew-list" id="crewList"></div>
                        </div>

                        <!-- Technical Details -->
                        <div class="technical-details" id="technicalDetails">
                            <h3>Details</h3>
                            <div class="tech-grid" id="techGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Similar Content -->
        <section class="similar-content-section" id="similarContentSection">
            <div class="section-header">
                <h2 class="section-title">More Like This</h2>
            </div>
            <div class="content-carousel-container">
                <div class="content-carousel" id="similarContentCarousel">
                    <!-- Will be populated by JavaScript -->
                </div>
                <button class="carousel-btn carousel-prev" onclick="scrollCarousel('similarContentCarousel', 'left')">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
                <button class="carousel-btn carousel-next" onclick="scrollCarousel('similarContentCarousel', 'right')">
                    <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </button>
            </div>
        </section>
    </main>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="videoModalTitle">Trailer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="video-container">
                        <iframe id="videoPlayer" width="100%" height="500" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/js/include.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/main.js"></script>

    <script>
        // Details page functionality
        class DetailsPage {
            constructor() {
                this.contentId = null;
                this.content = null;
                this.currentUser = null;
                this.videoModal = null;
                this.userRating = 0;
                this.init();
            }

            async init() {
                // Get content ID from URL
                this.contentId = this.getContentIdFromURL();
                if (!this.contentId) {
                    this.showError('Invalid content ID');
                    return;
                }

                // Check authentication
                this.currentUser = await Auth.checkExistingSession() ? Auth.currentUser : null;

                // Load includes
                await this.loadIncludes();

                // Load content details
                await this.loadContentDetails();

                // Setup UI
                this.setupUI();
                this.hideLoading();
            }

            getContentIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }

            async loadIncludes() {
                try {
                    await Promise.all([
                        includeHTML('header-container', '/includes/header.html'),
                        includeHTML('footer-container', '/includes/footer.html')
                    ]);
                } catch (error) {
                    console.error('Failed to load includes:', error);
                }
            }

            async loadContentDetails() {
                try {
                    this.content = await API.getContentDetails(this.contentId);
                    if (!this.content) {
                        throw new Error('Content not found');
                    }

                    this.renderContentDetails();
                    await this.loadSimilarContent();
                } catch (error) {
                    console.error('Error loading content details:', error);
                    this.showError('Failed to load content details');
                }
            }

            renderContentDetails() {
                // Update page title
                document.title = `${this.content.title} - CineScope`;

                // Render hero section
                this.renderHeroSection();

                // Render main details
                this.renderMainDetails();

                // Render cast and crew
                this.renderCastAndCrew();

                // Render technical details
                this.renderTechnicalDetails();
            }

            renderHeroSection() {
                const heroSection = document.getElementById('detailsHero');
                const backdropUrl = this.content.backdrop_path || this.content.poster_path || '';

                heroSection.innerHTML = `
                    <div class="hero-backdrop">
                        <img src="${backdropUrl}" alt="${this.content.title}" class="backdrop-image">
                        <div class="hero-overlay"></div>
                    </div>
                    <div class="hero-content">
                        <div class="hero-info">
                            <h1 class="hero-title">${this.content.title}</h1>
                            ${this.content.original_title && this.content.original_title !== this.content.title ? 
                                `<p class="hero-original-title">${this.content.original_title}</p>` : ''}
                            <div class="hero-meta">
                                <span class="content-type">${this.content.content_type?.toUpperCase() || 'MOVIE'}</span>
                                ${this.content.release_date ? `<span>${new Date(this.content.release_date).getFullYear()}</span>` : ''}
                                ${this.content.runtime ? `<span>${this.content.runtime} min</span>` : ''}
                                ${this.content.rating ? `<span class="rating">⭐ ${this.content.rating.toFixed(1)}</span>` : ''}
                            </div>
                            <div class="hero-actions">
                                ${this.content.youtube_trailer ? `
                                    <button class="hero-btn primary" onclick="playTrailer()">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        Watch Trailer
                                    </button>
                                ` : ''}
                                <button class="hero-btn secondary" onclick="scrollToDetails()">
                                    <svg viewBox="0 0 24 24"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/></svg>
                                    More Info
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderMainDetails() {
                // Poster
                const posterImg = document.getElementById('contentPoster');
                posterImg.src = this.content.poster_path || '/assets/images/placeholder-poster.jpg';
                posterImg.alt = this.content.title;

                // Title
                document.getElementById('contentTitle').textContent = this.content.title;

                // Meta information
                const metaInfo = [];
                if (this.content.release_date) {
                    metaInfo.push(new Date(this.content.release_date).getFullYear());
                }
                if (this.content.runtime) {
                    metaInfo.push(`${this.content.runtime} minutes`);
                }
                if (this.content.languages && this.content.languages.length > 0) {
                    metaInfo.push(this.content.languages.join(', '));
                }

                document.getElementById('contentMeta').innerHTML = metaInfo.map(info => 
                    `<span class="meta-item">${info}</span>`
                ).join('');

                // Rating
                const ratingElement = document.getElementById('contentRating');
                if (this.content.rating) {
                    ratingElement.innerHTML = `
                        <div class="rating-display">
                            <span class="rating-score">${this.content.rating.toFixed(1)}</span>
                            <div class="rating-stars-display">
                                ${this.renderStarRating(this.content.rating)}
                            </div>
                            <span class="rating-count">(${this.content.vote_count || 0} votes)</span>
                        </div>
                    `;
                } else {
                    ratingElement.innerHTML = '<span class="no-rating">No rating available</span>';
                }

                // Genres
                const genresElement = document.getElementById('contentGenres');
                if (this.content.genres && this.content.genres.length > 0) {
                    genresElement.innerHTML = this.content.genres.map(genre => 
                        `<span class="genre-badge">${genre}</span>`
                    ).join('');
                }

                // Overview
                document.getElementById('contentOverview').textContent = 
                    this.content.overview || 'No overview available.';

                // User rating section (only for logged-in users)
                const userRatingSection = document.getElementById('userRatingSection');
                if (this.currentUser) {
                    this.setupUserRating();
                } else {
                    userRatingSection.style.display = 'none';
                }
            }

            renderStarRating(rating) {
                const fullStars = Math.floor(rating / 2);
                const hasHalfStar = rating % 2 >= 1;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

                return '★'.repeat(fullStars) + 
                       (hasHalfStar ? '☆' : '') + 
                       '☆'.repeat(emptyStars);
            }

            renderCastAndCrew() {
                // Cast
                if (this.content.cast && this.content.cast.length > 0) {
                    const castGrid = document.getElementById('castGrid');
                    castGrid.innerHTML = this.content.cast.slice(0, 8).map(person => `
                        <div class="cast-member">
                            <img src="${person.profile_path || '/assets/images/placeholder-person.jpg'}" 
                                 alt="${person.name}" class="cast-photo">
                            <div class="cast-info">
                                <h4 class="cast-name">${person.name}</h4>
                                <p class="cast-character">${person.character || person.roles?.[0]?.role || ''}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('castSection').style.display = 'none';
                }

                // Crew
                if (this.content.crew && this.content.crew.length > 0) {
                    const crewList = document.getElementById('crewList');
                    crewList.innerHTML = this.content.crew.slice(0, 6).map(person => `
                        <div class="crew-member">
                            <span class="crew-name">${person.name}</span>
                            <span class="crew-job">${person.job || person.position || ''}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('crewSection').style.display = 'none';
                }
            }

            renderTechnicalDetails() {
                const techGrid = document.getElementById('techGrid');
                const details = [];

                if (this.content.release_date) {
                    details.push(['Release Date', new Date(this.content.release_date).toLocaleDateString()]);
                }
                if (this.content.runtime) {
                    details.push(['Runtime', `${this.content.runtime} minutes`]);
                }
                if (this.content.languages && this.content.languages.length > 0) {
                    details.push(['Languages', this.content.languages.join(', ')]);
                }
                if (this.content.genres && this.content.genres.length > 0) {
                    details.push(['Genres', this.content.genres.join(', ')]);
                }
                if (this.content.content_type) {
                    details.push(['Type', this.content.content_type.toUpperCase()]);
                }

                if (details.length > 0) {
                    techGrid.innerHTML = details.map(([label, value]) => `
                        <div class="tech-detail">
                            <span class="tech-label">${label}</span>
                            <span class="tech-value">${value}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('technicalDetails').style.display = 'none';
                }
            }

            async loadSimilarContent() {
                try {
                    const similarContent = await API.getSimilarContent(this.contentId, 15);
                    if (similarContent && similarContent.length > 0) {
                        this.renderSimilarContent(similarContent);
                    } else {
                        document.getElementById('similarContentSection').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading similar content:', error);
                    document.getElementById('similarContentSection').style.display = 'none';
                }
            }

            renderSimilarContent(content) {
                const carousel = document.getElementById('similarContentCarousel');
                carousel.innerHTML = content.map(item => Components.createContentCard(item)).join('');
            }

            setupUI() {
                // Initialize video modal
                const videoModalElement = document.getElementById('videoModal');
                if (videoModalElement) {
                    this.videoModal = new bootstrap.Modal(videoModalElement);
                }

                // Setup event listeners
                this.setupEventListeners();

                // Check if content is already in watchlist/favorites
                this.updateActionButtons();
            }

            setupEventListeners() {
                // User rating
                if (this.currentUser) {
                    const stars = document.querySelectorAll('.star');
                    stars.forEach(star => {
                        star.addEventListener('click', () => this.rateContent(parseInt(star.dataset.rating)));
                        star.addEventListener('mouseenter', () => this.highlightStars(parseInt(star.dataset.rating)));
                    });

                    const ratingContainer = document.getElementById('ratingStars');
                    ratingContainer.addEventListener('mouseleave', () => this.resetStars());
                }

                // Auto-play trailer if requested
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('autoplay') === 'trailer' && this.content.youtube_trailer) {
                    setTimeout(() => this.playTrailer(), 1000);
                }
            }

            setupUserRating() {
                // This would typically load the user's existing rating
                // For now, we'll just setup the interaction
                const ratingText = document.getElementById('ratingText');
                ratingText.textContent = 'Rate this content';
            }

            highlightStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('highlighted');
                    } else {
                        star.classList.remove('highlighted');
                    }
                });
            }

            resetStars() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.remove('highlighted');
                    if (index < this.userRating) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
            }

            async rateContent(rating) {
                if (!this.currentUser) return;

                try {
                    await API.rateContent(this.contentId, rating);
                    this.userRating = rating;
                    
                    const stars = document.querySelectorAll('.star');
                    stars.forEach((star, index) => {
                        if (index < rating) {
                            star.classList.add('filled');
                        } else {
                            star.classList.remove('filled');
                        }
                    });

                    document.getElementById('ratingText').textContent = `You rated this ${rating}/5`;
                    showNotification(`Rated ${rating}/5 stars!`, 'success');
                } catch (error) {
                    console.error('Error rating content:', error);
                    showNotification('Failed to save rating', 'error');
                }
            }

            async updateActionButtons() {
                if (!this.currentUser) return;

                try {
                    // This would typically check if content is in user's lists
                    // For now, we'll just enable the buttons
                    const watchlistBtn = document.getElementById('watchlistBtn');
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    
                    watchlistBtn.disabled = false;
                    favoriteBtn.disabled = false;
                } catch (error) {
                    console.error('Error updating action buttons:', error);
                }
            }

            playTrailer() {
                if (!this.content.youtube_trailer) {
                    showNotification('No trailer available', 'info');
                    return;
                }

                const videoPlayer = document.getElementById('videoPlayer');
                const videoModalTitle = document.getElementById('videoModalTitle');
                
                videoModalTitle.textContent = `${this.content.title} - Trailer`;
                videoPlayer.src = `https://www.youtube.com/embed/${this.content.youtube_trailer}?autoplay=1&rel=0`;
                
                this.videoModal.show();

                // Stop video when modal is closed
                document.getElementById('videoModal').addEventListener('hidden.bs.modal', () => {
                    videoPlayer.src = '';
                }, { once: true });
            }

            async toggleWatchlist() {
                if (!this.currentUser) {
                    showLogin();
                    return;
                }

                try {
                    await API.addToWatchlist(this.contentId);
                    showNotification('Added to watchlist!', 'success');
                    
                    const watchlistBtn = document.getElementById('watchlistBtn');
                    const watchlistText = document.getElementById('watchlistText');
                    watchlistText.textContent = 'In Watchlist';
                    watchlistBtn.classList.add('active');
                } catch (error) {
                    console.error('Error adding to watchlist:', error);
                    showNotification('Failed to add to watchlist', 'error');
                }
            }

            async toggleFavorite() {
                if (!this.currentUser) {
                    showLogin();
                    return;
                }

                try {
                    await API.addToFavorites(this.contentId);
                    showNotification('Added to favorites!', 'success');
                    
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    const favoriteText = document.getElementById('favoriteText');
                    favoriteText.textContent = 'In Favorites';
                    favoriteBtn.classList.add('active');
                } catch (error) {
                    console.error('Error adding to favorites:', error);
                    showNotification('Failed to add to favorites', 'error');
                }
            }

            showError(message) {
                document.querySelector('.details-main').innerHTML = `
                    <div class="error-container">
                        <div class="error-content">
                            <h1>Oops!</h1>
                            <p>${message}</p>
                            <a href="/" class="btn btn-primary">Go Home</a>
                        </div>
                    </div>
                `;
            }

            hideLoading() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                    }, 800);
                }
            }
        }

        // Global functions
        function playTrailer() {
            if (window.detailsPage) {
                window.detailsPage.playTrailer();
            }
        }

        function toggleWatchlist() {
            if (window.detailsPage) {
                window.detailsPage.toggleWatchlist();
            }
        }

        function toggleFavorite() {
            if (window.detailsPage) {
                window.detailsPage.toggleFavorite();
            }
        }

        function scrollToDetails() {
            document.querySelector('.details-content').scrollIntoView({ behavior: 'smooth' });
        }

        function scrollCarousel(carouselId, direction) {
            const carousel = document.getElementById(carouselId);
            if (!carousel) return;

            const scrollAmount = 220;
            const currentScroll = carousel.scrollLeft;
            
            let newScroll;
            if (direction === 'left') {
                newScroll = Math.max(0, currentScroll - scrollAmount * 3);
            } else {
                newScroll = currentScroll + scrollAmount * 3;
            }

            carousel.scrollTo({
                left: newScroll,
                behavior: 'smooth'
            });
        }

        // Initialize details page
        document.addEventListener('DOMContentLoaded', () => {
            window.detailsPage = new DetailsPage();
        });
    </script>
</body>
</html>