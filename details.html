<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Details - CineScope</title>
    
    <!-- Dynamic meta tags will be set by JavaScript -->
    <meta name="description" content="View detailed information about movies, TV shows, and anime on CineScope.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    
    <style>
        .details-hero {
            position: relative;
            min-height: 70vh;
            background: linear-gradient(135deg, var(--primary) 0%, #1a1a2e 100%);
            overflow: hidden;
            margin-top: 80px;
        }
        
        .details-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            filter: blur(2px);
        }
        
        .details-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(15, 23, 42, 0.9) 0%,
                rgba(15, 23, 42, 0.7) 50%,
                rgba(15, 23, 42, 0.9) 100%
            );
        }
        
        .details-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            min-height: 70vh;
            padding: var(--spacing-2xl);
            gap: var(--spacing-2xl);
        }
        
        .details-poster {
            flex-shrink: 0;
            width: 300px;
            height: 450px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            position: relative;
        }
        
        .details-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .poster-actions {
            position: absolute;
            bottom: var(--spacing-md);
            left: var(--spacing-md);
            right: var(--spacing-md);
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .details-info {
            flex: 1;
            max-width: 600px;
        }
        
        .content-badges {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .badge {
            background: rgba(107, 33, 168, 0.2);
            color: var(--accent);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge.trending {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .badge.new-release {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }
        
        .badge.critics-choice {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }
        
        .details-title {
            font-size: clamp(2rem, 4vw, 3.5rem);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            line-height: 1.1;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .details-subtitle {
            font-size: var(--font-size-lg);
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: var(--spacing-lg);
        }
        
        .details-meta {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-secondary);
        }
        
        .meta-item i {
            color: var(--accent);
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(0, 0, 0, 0.5);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
        }
        
        .rating-stars {
            display: flex;
            gap: 2px;
        }
        
        .star {
            color: #fbbf24;
            font-size: 18px;
        }
        
        .star.empty {
            color: var(--text-muted);
        }
        
        .details-overview {
            font-size: var(--font-size-md);
            line-height: 1.7;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
        }
        
        .details-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .action-button {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            font-weight: 600;
            text-decoration: none;
            transition: all var(--transition-normal);
            cursor: pointer;
            border: none;
            font-size: var(--font-size-md);
        }
        
        .action-primary {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: var(--text);
        }
        
        .action-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .action-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .details-sections {
            background: var(--surface);
            margin-top: var(--spacing-2xl);
        }
        
        .section-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
        }
        
        .section-tab {
            padding: var(--spacing-lg) var(--spacing-xl);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .section-tab.active {
            color: var(--text);
        }
        
        .section-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
        }
        
        .section-content {
            padding: var(--spacing-2xl);
            display: none;
        }
        
        .section-content.active {
            display: block;
        }
        
        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }
        
        .cast-member {
            text-align: center;
        }
        
        .cast-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto var(--spacing-sm);
            background: var(--surface-light);
        }
        
        .cast-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            font-size: var(--font-size-sm);
        }
        
        .cast-role {
            color: var(--text-muted);
            font-size: var(--font-size-xs);
        }
        
        .genres-list {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-top: var(--spacing-md);
        }
        
        .genre-tag-large {
            background: var(--secondary);
            color: var(--text);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        
        .similar-content {
            margin-top: var(--spacing-xl);
        }
        
        .loading-skeleton {
            background: var(--surface-light);
            border-radius: var(--radius-md);
            animation: shimmer 1.5s infinite;
        }
        
        .skeleton-poster {
            width: 300px;
            height: 450px;
        }
        
        .skeleton-title {
            height: 60px;
            width: 80%;
            margin-bottom: var(--spacing-md);
        }
        
        .skeleton-meta {
            height: 20px;
            width: 60%;
            margin-bottom: var(--spacing-sm);
        }
        
        .skeleton-overview {
            height: 100px;
            width: 100%;
            margin-bottom: var(--spacing-lg);
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .details-content {
                flex-direction: column;
                text-align: center;
                padding: var(--spacing-lg);
            }
            
            .details-poster {
                width: 250px;
                height: 375px;
            }
            
            .details-info {
                max-width: 100%;
            }
            
            .details-meta {
                justify-content: center;
            }
            
            .section-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .section-tab {
                flex-shrink: 0;
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .cast-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div id="navigation-container" data-include="header"></div>
    
    <main class="main-content">
        <!-- Content Details Hero -->
        <section class="details-hero" id="details-hero">
            <div class="details-backdrop" id="details-backdrop"></div>
            <div class="details-overlay"></div>
            
            <div class="details-content" id="details-content">
                <!-- Loading skeleton will be shown initially -->
                <div class="loading-skeleton skeleton-poster"></div>
                <div class="details-info">
                    <div class="loading-skeleton skeleton-title"></div>
                    <div class="loading-skeleton skeleton-meta"></div>
                    <div class="loading-skeleton skeleton-meta"></div>
                    <div class="loading-skeleton skeleton-overview"></div>
                </div>
            </div>
        </section>
        
        <!-- Detailed Information Tabs -->
        <section class="details-sections" id="details-sections" style="display: none;">
            <div class="section-tabs">
                <button class="section-tab active" onclick="switchTab('overview')">Overview</button>
                <button class="section-tab" onclick="switchTab('cast')">Cast & Crew</button>
                <button class="section-tab" onclick="switchTab('details')">Details</button>
                <button class="section-tab" onclick="switchTab('similar')">Similar</button>
            </div>
            
            <!-- Overview Tab -->
            <div class="section-content active" id="overview-content">
                <h3>Synopsis</h3>
                <p id="full-overview"></p>
                
                <h3 style="margin-top: var(--spacing-xl);">Genres</h3>
                <div class="genres-list" id="genres-list"></div>
                
                <div id="anime-genres-section" style="display: none;">
                    <h3 style="margin-top: var(--spacing-xl);">Anime Categories</h3>
                    <div class="genres-list" id="anime-genres-list"></div>
                </div>
            </div>
            
            <!-- Cast & Crew Tab -->
            <div class="section-content" id="cast-content">
                <h3>Cast</h3>
                <div class="cast-grid" id="cast-grid"></div>
                
                <h3 style="margin-top: var(--spacing-2xl);">Crew</h3>
                <div class="cast-grid" id="crew-grid"></div>
            </div>
            
            <!-- Details Tab -->
            <div class="section-content" id="details-content-tab">
                <div class="details-grid" id="content-details-grid"></div>
            </div>
            
            <!-- Similar Content Tab -->
            <div class="section-content" id="similar-content">
                <h3>You Might Also Like</h3>
                <div class="content-grid" id="similar-grid"></div>
            </div>
        </section>
    </main>
    
    <!-- Footer -->
    <div data-include="footer"></div>
    
    <!-- Global Loader -->
    <div id="global-loader">
        <div class="loader">
            <div class="loader-spinner"></div>
            <div class="loader-text">Loading content details...</div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <!-- Scripts -->
    <script src="/js/main.js"></script>
    
    <script>
        let currentContent = null;
        let currentTab = 'overview';
        
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');
            
            if (!contentId) {
                app.showNotification('Content ID not provided', 'error');
                app.navigateTo('/');
                return;
            }
            
            await loadContentDetails(contentId);
        });
        
        async function loadContentDetails(contentId) {
            app.showLoadingState('Loading content details...');
            
            try {
                const data = await app.getContentDetails(contentId);
                currentContent = data;
                
                // Update page title and meta
                document.title = `${data.title} - CineScope`;
                document.querySelector('meta[name="description"]').content = 
                    data.overview ? data.overview.substring(0, 160) + '...' : `Details for ${data.title}`;
                
                // Render content details
                renderContentDetails(data);
                
                // Record view interaction
                if (app.currentUser) {
                    await app.recordInteraction(contentId, 'view');
                }
                
            } catch (error) {
                console.error('Error loading content details:', error);
                app.showNotification('Failed to load content details', 'error');
                app.navigateTo('/');
            } finally {
                app.hideLoadingState();
            }
        }
        
        function renderContentDetails(content) {
            // Set backdrop
            const backdrop = document.getElementById('details-backdrop');
            if (content.backdrop_path) {
                backdrop.style.backgroundImage = `url(${content.backdrop_path})`;
            }
            
            // Build content badges
            const badges = [];
            if (content.is_trending) badges.push('<span class="badge trending">Trending</span>');
            if (content.is_new_release) badges.push('<span class="badge new-release">New Release</span>');
            if (content.is_critics_choice) badges.push('<span class="badge critics-choice">Critics\' Choice</span>');
            badges.push(`<span class="badge">${content.content_type.toUpperCase()}</span>`);
            
            // Build meta information
            const metaItems = [];
            if (content.release_date) {
                metaItems.push(`
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>${new Date(content.release_date).getFullYear()}</span>
                    </div>
                `);
            }
            if (content.runtime) {
                metaItems.push(`
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${content.runtime} min</span>
                    </div>
                `);
            }
            if (content.languages?.length) {
                metaItems.push(`
                    <div class="meta-item">
                        <i class="fas fa-language"></i>
                        <span>${content.languages.join(', ')}</span>
                    </div>
                `);
            }
            
            // Build rating display
            let ratingDisplay = '';
            if (content.rating) {
                const stars = generateStarRating(content.rating);
                ratingDisplay = `
                    <div class="rating-display">
                        <div class="rating-stars">${stars}</div>
                        <span>${content.rating.toFixed(1)}/10</span>
                        ${content.vote_count ? `<span class="text-muted">(${content.vote_count} votes)</span>` : ''}
                    </div>
                `;
            }
            
            // Build action buttons
            const actionButtons = [];
            
            if (content.youtube_trailer) {
                actionButtons.push(`
                    <button class="action-button action-primary" onclick="app.playTrailer('${content.youtube_trailer}')">
                        <i class="fas fa-play"></i> Watch Trailer
                    </button>
                `);
            }
            
            actionButtons.push(`
                <button class="action-button action-secondary" onclick="toggleWatchlist(${content.id})">
                    <i class="fas fa-bookmark"></i> Add to Watchlist
                </button>
            `);
            
            actionButtons.push(`
                <button class="action-button action-secondary" onclick="toggleFavorite(${content.id})">
                    <i class="fas fa-heart"></i> Add to Favorites
                </button>
            `);
            
            // Render main content
            document.getElementById('details-content').innerHTML = `
                <div class="details-poster">
                    <img src="${content.poster_path || '/assets/images/placeholder.jpg'}" 
                         alt="${content.title}" 
                         onerror="this.src='/assets/images/placeholder.jpg'">
                </div>
                
                <div class="details-info">
                    <div class="content-badges">
                        ${badges.join('')}
                    </div>
                    
                    <h1 class="details-title">${content.title}</h1>
                    
                    ${content.original_title && content.original_title !== content.title ? 
                        `<p class="details-subtitle">${content.original_title}</p>` : ''}
                    
                    <div class="details-meta">
                        ${metaItems.join('')}
                        ${ratingDisplay}
                    </div>
                    
                    <p class="details-overview">
                        ${content.overview || 'No overview available.'}
                    </p>
                    
                    <div class="details-actions">
                        ${actionButtons.join('')}
                    </div>
                </div>
            `;
            
            // Populate tab content
            populateOverviewTab(content);
            populateCastTab(content);
            populateDetailsTab(content);
            populateSimilarTab(content);
            
            // Show sections
            document.getElementById('details-sections').style.display = 'block';
        }
        
        function generateStarRating(rating) {
            const stars = [];
            const fullStars = Math.floor(rating / 2);
            const hasHalfStar = (rating / 2) % 1 >= 0.5;
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars.push('<i class="fas fa-star star"></i>');
                } else if (i === fullStars && hasHalfStar) {
                    stars.push('<i class="fas fa-star-half-alt star"></i>');
                } else {
                    stars.push('<i class="far fa-star star empty"></i>');
                }
            }
            
            return stars.join('');
        }
        
        function populateOverviewTab(content) {
            document.getElementById('full-overview').textContent = 
                content.overview || 'No detailed synopsis available.';
            
            // Render genres
            const genresList = document.getElementById('genres-list');
            if (content.genres?.length) {
                genresList.innerHTML = content.genres.map(genre => 
                    `<span class="genre-tag-large">${genre}</span>`
                ).join('');
            } else {
                genresList.innerHTML = '<span class="text-muted">No genres available</span>';
            }
            
            // Render anime genres if applicable
            if (content.content_type === 'anime' && content.anime_genres?.length) {
                document.getElementById('anime-genres-section').style.display = 'block';
                document.getElementById('anime-genres-list').innerHTML = 
                    content.anime_genres.map(genre => 
                        `<span class="genre-tag-large">${genre}</span>`
                    ).join('');
            }
        }
        
        function populateCastTab(content) {
            const castGrid = document.getElementById('cast-grid');
            const crewGrid = document.getElementById('crew-grid');
            
            if (content.cast?.length) {
                castGrid.innerHTML = content.cast.slice(0, 12).map(person => `
                    <div class="cast-member">
                        <img src="${person.profile_path ? 
                            `https://image.tmdb.org/t/p/w200${person.profile_path}` : 
                            '/assets/images/person-placeholder.jpg'}" 
                             alt="${person.name}" 
                             class="cast-photo"
                             onerror="this.src='/assets/images/person-placeholder.jpg'">
                        <div class="cast-name">${person.name}</div>
                        <div class="cast-role">${person.character || person.role || 'Actor'}</div>
                    </div>
                `).join('');
            } else {
                castGrid.innerHTML = '<p class="text-muted">Cast information not available</p>';
            }
            
            if (content.crew?.length) {
                crewGrid.innerHTML = content.crew.slice(0, 8).map(person => `
                    <div class="cast-member">
                        <img src="${person.profile_path ? 
                            `https://image.tmdb.org/t/p/w200${person.profile_path}` : 
                            '/assets/images/person-placeholder.jpg'}" 
                             alt="${person.name}" 
                             class="cast-photo"
                             onerror="this.src='/assets/images/person-placeholder.jpg'">
                        <div class="cast-name">${person.name}</div>
                        <div class="cast-role">${person.job || person.department || 'Crew'}</div>
                    </div>
                `).join('');
            } else {
                crewGrid.innerHTML = '<p class="text-muted">Crew information not available</p>';
            }
        }
        
        function populateDetailsTab(content) {
            const detailsGrid = document.getElementById('content-details-grid');
            
            const details = [];
            
            if (content.tmdb_id) details.push(['TMDB ID', content.tmdb_id]);
            if (content.mal_id) details.push(['MyAnimeList ID', content.mal_id]);
            if (content.release_date) details.push(['Release Date', new Date(content.release_date).toLocaleDateString()]);
            if (content.runtime) details.push(['Runtime', `${content.runtime} minutes`]);
            if (content.rating) details.push(['Rating', `${content.rating}/10`]);
            if (content.vote_count) details.push(['Vote Count', content.vote_count.toLocaleString()]);
            if (content.popularity) details.push(['Popularity Score', Math.round(content.popularity)]);
            if (content.languages?.length) details.push(['Languages', content.languages.join(', ')]);
            
            detailsGrid.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                    ${details.map(([label, value]) => `
                        <div style="background: var(--primary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                            <div style="color: var(--text-muted); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">${label}</div>
                            <div style="font-weight: 600;">${value}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function populateSimilarTab(content) {
            const similarGrid = document.getElementById('similar-grid');
            
            if (content.similar_content?.length) {
                app.renderContentGrid(content.similar_content, similarGrid, {
                    showTrailer: true,
                    showRating: true,
                    showGenres: false
                });
            } else {
                similarGrid.innerHTML = '<p class="text-muted">No similar content found</p>';
            }
        }
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update content visibility
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName === 'details' ? 'details-content-tab' : tabName}-content`).classList.add('active');
        }
        
        async function toggleWatchlist(contentId) {
            if (!app.requireAuth()) return;
            
            try {
                await app.toggleWatchlist(contentId);
                // Update button state here if needed
            } catch (error) {
                console.error('Error toggling watchlist:', error);
            }
        }
        
        async function toggleFavorite(contentId) {
            if (!app.requireAuth()) return;
            
            try {
                await app.toggleFavorite(contentId);
                // Update button state here if needed
            } catch (error) {
                console.error('Error toggling favorite:', error);
            }
        }
    </script>
</body>
</html>