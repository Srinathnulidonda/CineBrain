<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieFlix - Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --netflix-red: #E50914;
            --netflix-black: #141414;
            --netflix-gray: #2F2F2F;
            --text-gray: #B3B3B3;
            --card-bg: #181818;
            --success: #46d369;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Netflix Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--netflix-black);
            color: white;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            padding: 20px 50px;
            z-index: 1000;
            transition: background 0.3s;
        }

        .header.scrolled {
            background: var(--netflix-black);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--netflix-red);
            text-decoration: none;
        }

        .back-button {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: color 0.3s;
        }

        .back-button:hover {
            color: var(--netflix-red);
        }

        /* Hero Section */
        .hero {
            position: relative;
            height: 70vh;
            overflow: hidden;
        }

        .hero-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-gradient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 0%, var(--netflix-black) 100%);
        }

        .hero-content {
            position: absolute;
            bottom: 50px;
            left: 50px;
            right: 50px;
            z-index: 10;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .hero-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .rating {
            color: var(--success);
            font-weight: bold;
        }

        .genre-tag {
            background: rgba(255,255,255,0.1);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-play {
            background: white;
            color: black;
        }

        .btn-play:hover {
            background: rgba(255,255,255,0.8);
        }

        .btn-secondary {
            background: rgba(109, 109, 110, 0.7);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(109, 109, 110, 0.5);
        }

        /* Content Details */
        .details-container {
            padding: 50px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 50px;
            margin-bottom: 50px;
        }

        .poster {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }

        .details-info h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .overview {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-gray);
            margin-bottom: 30px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            padding: 15px;
            background: var(--card-bg);
            border-radius: 4px;
        }

        .info-label {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1rem;
            font-weight: bold;
        }

        /* Cast Section */
        .cast-section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .cast-card {
            text-align: center;
        }

        .cast-image {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            border-radius: 4px;
            background: var(--card-bg);
            margin-bottom: 10px;
        }

        .cast-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .cast-character {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        /* Trailers Section */
        .trailers-section {
            margin-bottom: 50px;
        }

        .trailers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .trailer-card {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .trailer-card:hover {
            transform: scale(1.05);
        }

        .trailer-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            position: relative;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .trailer-title {
            padding: 15px;
            font-weight: bold;
        }

        /* Reviews Section */
        .reviews-section {
            margin-bottom: 50px;
        }

        .review-form {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .review-input {
            width: 100%;
            padding: 12px;
            background: var(--netflix-gray);
            border: none;
            border-radius: 4px;
            color: white;
            margin-bottom: 15px;
            resize: vertical;
        }

        .star-rating {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .star {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-gray);
            transition: color 0.3s;
        }

        .star.active {
            color: gold;
        }

        .review-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .reviewer-name {
            font-weight: bold;
        }

        .review-rating {
            color: gold;
        }

        .review-text {
            color: var(--text-gray);
            line-height: 1.6;
        }

        /* Similar Content */
        .similar-section {
            margin-bottom: 50px;
        }

        .similar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .similar-card {
            position: relative;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .similar-card:hover {
            transform: scale(1.05);
        }

        .similar-card img {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
            font-size: 1.5rem;
            color: var(--text-gray);
        }

        .skeleton {
            background: linear-gradient(90deg, var(--card-bg) 25%, #2a2a2a 50%, var(--card-bg) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header, .details-container {
                padding: 20px;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .details-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .poster {
                max-width: 300px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" id="header">
        <div class="nav-container">
            <a href="/" class="logo">MovieFlix</a>
            <a href="/dashboard.html" class="back-button">
                ← Back to Browse
            </a>
        </div>
    </header>

    <!-- Loading State -->
    <div class="loading" id="loading">
        Loading...
    </div>

    <!-- Main Content -->
    <main id="main-content" style="display: none;">
        <!-- Hero Section -->
        <section class="hero">
            <img class="hero-backdrop" id="hero-backdrop" src="" alt="">
            <div class="hero-gradient"></div>
            <div class="hero-content">
                <h1 class="hero-title" id="hero-title"></h1>
                <div class="hero-meta" id="hero-meta">
                    <!-- Meta info will be inserted here -->
                </div>
                <div class="hero-buttons">
                    <button class="btn btn-play" id="play-btn">
                        ▶ Play
                    </button>
                    <button class="btn btn-secondary" id="watchlist-btn">
                        + My List
                    </button>
                    <button class="btn btn-secondary" id="favorite-btn">
                        ♥ Favorite
                    </button>
                </div>
            </div>
        </section>

        <!-- Details Container -->
        <div class="details-container">
            <!-- Main Details -->
            <div class="details-grid">
                <div>
                    <img class="poster" id="poster" src="" alt="">
                </div>
                <div class="details-info">
                    <h2 id="original-title"></h2>
                    <p class="overview" id="overview"></p>
                    
                    <div class="info-grid" id="info-grid">
                        <!-- Info items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Cast Section -->
            <section class="cast-section" id="cast-section" style="display: none;">
                <h2 class="section-title">Cast</h2>
                <div class="cast-grid" id="cast-grid"></div>
            </section>

            <!-- Trailers Section -->
            <section class="trailers-section" id="trailers-section" style="display: none;">
                <h2 class="section-title">Videos & Trailers</h2>
                <div class="trailers-grid" id="trailers-grid"></div>
            </section>

            <!-- Reviews Section -->
            <section class="reviews-section" id="reviews-section">
                <h2 class="section-title">Reviews</h2>
                
                <!-- Review Form -->
                <div class="review-form" id="review-form" style="display: none;">
                    <h3 class="mb-4">Write a Review</h3>
                    <div class="star-rating" id="star-rating">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                    <textarea class="review-input" id="review-text" rows="4" placeholder="Share your thoughts..."></textarea>
                    <button class="btn btn-play" onclick="submitReview()">Submit Review</button>
                </div>
                
                <div id="reviews-list"></div>
            </section>

            <!-- Similar Content Section -->
            <section class="similar-section" id="similar-section" style="display: none;">
                <h2 class="section-title">More Like This</h2>
                <div class="similar-grid" id="similar-grid"></div>
            </section>
        </div>
    </main>

    <script>
        // Global variables
        let auth = window.movieFlixAuth || null;
        let contentId = null;
        let contentData = null;
        let userRating = 0;
        const API_BASE = 'http://localhost:5000/api';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/';

        // Get content ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const paramId = urlParams.get('id');
        
        if (!paramId) {
            window.location.href = '/dashboard.html';
        }

        // Check if it's a TMDB ID or internal ID
        contentId = isNaN(paramId) ? paramId : parseInt(paramId);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            await loadContentDetails();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Header scroll effect
            window.addEventListener('scroll', () => {
                const header = document.getElementById('header');
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });

            // Star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', (e) => {
                    userRating = parseInt(e.target.dataset.rating);
                    updateStarDisplay(userRating);
                });
            });

            // Action buttons
            document.getElementById('play-btn').addEventListener('click', () => {
                alert('Play functionality coming soon!');
            });

            document.getElementById('watchlist-btn').addEventListener('click', addToWatchlist);
            document.getElementById('favorite-btn').addEventListener('click', addToFavorites);
        }

        // Load content details
        async function loadContentDetails() {
            try {
                // Try to load by internal ID first, then by TMDB ID
                let response = await fetch(`${API_BASE}/content/${contentId}`);
                
                if (!response.ok && isNaN(contentId)) {
                    // If it's not a number, it might be a TMDB ID
                    response = await fetch(`${API_BASE}/content/tmdb/${contentId}`);
                }

                if (!response.ok) {
                    throw new Error('Content not found');
                }

                const data = await response.json();
                contentData = data.content;
                
                // Update UI with content data
                updateUI(data);
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

                // Show review form if logged in
                if (auth && auth.token) {
                    document.getElementById('review-form').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 mb-4">Failed to load content</p>
                        <a href="/dashboard.html" class="btn btn-secondary">Back to Browse</a>
                    </div>
                `;
            }
        }

        // Update UI with content data
        function updateUI(data) {
            const content = data.content;
            
            // Hero section
            const backdropPath = content.backdrop_path || content.poster_path;
            if (backdropPath) {
                document.getElementById('hero-backdrop').src = `${TMDB_IMAGE_BASE}original${backdropPath}`;
            }
            
            document.getElementById('hero-title').textContent = content.title || content.name || '';
            
            // Hero meta
            const metaHtml = [];
            if (data.average_rating) {
                metaHtml.push(`<span class="rating">★ ${data.average_rating}</span>`);
            }
            if (content.release_date) {
                metaHtml.push(`<span>${new Date(content.release_date).getFullYear()}</span>`);
            }
            if (content.runtime) {
                const hours = Math.floor(content.runtime / 60);
                const minutes = content.runtime % 60;
                metaHtml.push(`<span>${hours}h ${minutes}m</span>`);
            }
            if (content.genres && content.genres.length > 0) {
                content.genres.slice(0, 3).forEach(genre => {
                    const genreName = genre.name || genre;
                    metaHtml.push(`<span class="genre-tag">${genreName}</span>`);
                });
            }
            document.getElementById('hero-meta').innerHTML = metaHtml.join('');
            
            // Poster
            if (content.poster_path) {
                document.getElementById('poster').src = `${TMDB_IMAGE_BASE}w500${content.poster_path}`;
            }
            
            // Details
            document.getElementById('original-title').textContent = content.original_title || '';
            document.getElementById('overview').textContent = content.overview || '';
            
            // Info grid
            const infoGrid = document.getElementById('info-grid');
            const infoItems = [];
            
            if (content.language) {
                const languages = {
                    'en': 'English', 'hi': 'Hindi', 'te': 'Telugu', 
                    'ta': 'Tamil', 'kn': 'Kannada', 'ja': 'Japanese', 'ko': 'Korean'
                };
                infoItems.push({
                    label: 'Language',
                    value: languages[content.language] || content.language.toUpperCase()
                });
            }
            
            if (content.rating) {
                infoItems.push({
                    label: 'TMDB Rating',
                    value: `${content.rating}/10`
                });
            }
            
            if (data.total_reviews) {
                infoItems.push({
                    label: 'User Reviews',
                    value: data.total_reviews
                });
            }
            
            if (content.popularity) {
                infoItems.push({
                    label: 'Popularity',
                    value: Math.round(content.popularity)
                });
            }
            
            infoItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'info-item';
                div.innerHTML = `
                    <div class="info-label">${item.label}</div>
                    <div class="info-value">${item.value}</div>
                `;
                infoGrid.appendChild(div);
            });
            
            // Cast
            if (content.cast && content.cast.length > 0) {
                document.getElementById('cast-section').style.display = 'block';
                const castGrid = document.getElementById('cast-grid');
                
                content.cast.slice(0, 12).forEach(person => {
                    const card = document.createElement('div');
                    card.className = 'cast-card';
                    card.innerHTML = `
                        <img class="cast-image" 
                             src="${person.profile_path ? `${TMDB_IMAGE_BASE}w185${person.profile_path}` : '/placeholder-person.jpg'}"
                             alt="${person.name}"
                             onerror="this.src='/placeholder-person.jpg'">
                        <div class="cast-name">${person.name}</div>
                        <div class="cast-character">${person.character || person.job || ''}</div>
                    `;
                    castGrid.appendChild(card);
                });
            }
            
            // Trailers
            if (content.trailers && content.trailers.length > 0) {
                document.getElementById('trailers-section').style.display = 'block';
                const trailersGrid = document.getElementById('trailers-grid');
                
                content.trailers.forEach(trailer => {
                    const card = document.createElement('div');
                    card.className = 'trailer-card';
                    card.innerHTML = `
                        <div class="trailer-thumbnail" style="position: relative;">
                            <img src="https://img.youtube.com/vi/${trailer.key}/hqdefault.jpg" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            <div class="play-overlay">▶</div>
                        </div>
                        <div class="trailer-title">${trailer.name}</div>
                    `;
                    card.addEventListener('click', () => {
                        window.open(trailer.url, '_blank');
                    });
                    trailersGrid.appendChild(card);
                });
            }
            
            // Reviews
            if (data.reviews && data.reviews.length > 0) {
                const reviewsList = document.getElementById('reviews-list');
                data.reviews.forEach(review => {
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';
                    reviewCard.innerHTML = `
                        <div class="review-header">
                            <span class="reviewer-name">${review.user.username}</span>
                            <span class="review-rating">${'★'.repeat(Math.round(review.rating))}</span>
                        </div>
                        <p class="review-text">${review.review || ''}</p>
                    `;
                    reviewsList.appendChild(reviewCard);
                });
            }
            
            // Similar content
            if (data.similar && data.similar.length > 0) {
                document.getElementById('similar-section').style.display = 'block';
                const similarGrid = document.getElementById('similar-grid');
                
                data.similar.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'similar-card';
                    card.innerHTML = `
                        <img src="${item.poster_path ? `${TMDB_IMAGE_BASE}w300${item.poster_path}` : '/placeholder.jpg'}"
                             alt="${item.title}"
                             onerror="this.src='/placeholder.jpg'">
                    `;
                    card.addEventListener('click', () => {
                        window.location.href = `/details.html?id=${item.id}`;
                    });
                    similarGrid.appendChild(card);
                });
            }
        }

        // Update star display
        function updateStarDisplay(rating) {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // Submit review
        window.submitReview = async function() {
            if (!auth || !auth.token) {
                alert('Please login to submit a review');
                return;
            }

            if (userRating === 0) {
                alert('Please select a rating');
                return;
            }

            const reviewText = document.getElementById('review-text').value.trim();

            try {
                const response = await fetch(`${API_BASE}/content/${contentData.id}/review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${auth.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rating: userRating,
                        review: reviewText
                    })
                });

                if (response.ok) {
                    alert('Review submitted successfully!');
                    document.getElementById('review-text').value = '';
                    updateStarDisplay(0);
                    userRating = 0;
                    
                    // Reload to show new review
                    await loadContentDetails();
                } else {
                    alert('Failed to submit review');
                }

            } catch (error) {
                console.error('Review submission error:', error);
                alert('Failed to submit review');
            }
        };

        // Add to watchlist
        async function addToWatchlist() {
            if (!auth || !auth.token) {
                alert('Please login to add to watchlist');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/interact`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${auth.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentData.id,
                        interaction_type: 'wishlist'
                    })
                });

                if (response.ok) {
                    alert('Added to watchlist!');
                    document.getElementById('watchlist-btn').textContent = '✓ In My List';
                } else {
                    alert('Failed to add to watchlist');
                }

            } catch (error) {
                console.error('Watchlist error:', error);
                alert('Failed to add to watchlist');
            }
        }

        // Add to favorites
        async function addToFavorites() {
            if (!auth || !auth.token) {
                alert('Please login to add to favorites');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/interact`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${auth.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentData.id,
                        interaction_type: 'favorite'
                    })
                });

                if (response.ok) {
                    alert('Added to favorites!');
                    document.getElementById('favorite-btn').textContent = '✓ Favorited';
                } else {
                    alert('Failed to add to favorites');
                }

            } catch (error) {
                console.error('Favorite error:', error);
                alert('Failed to add to favorites');
            }
        }
    </script>
</body>
</html>