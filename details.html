<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Details - CineScope</title>
    <meta name="description" content="Detailed information about movies, TV shows, and anime with cast, crew, and recommendations.">
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .details-hero {
            position: relative;
            min-height: 60vh;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }
        
        .details-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .backdrop-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.3;
        }
        
        .details-backdrop::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 0%, rgba(10, 10, 10, 0.8) 50%, rgba(10, 10, 10, 1) 100%);
        }
        
        .details-content {
            position: relative;
            z-index: 1;
            display: flex;
            gap: 2rem;
            padding: 2rem 0;
        }
        
        .details-poster {
            flex-shrink: 0;
        }
        
        .poster-image {
            width: 300px;
            height: 450px;
            object-fit: cover;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
        }
        
        .details-info {
            flex: 1;
            min-width: 0;
        }
        
        .details-title {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 0.5rem;
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .original-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .details-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .meta-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        
        .rating {
            color: #ffd700;
        }
        
        .genres {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .genre-tag {
            background: var(--gradient-purple);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
        }
        
        .overview {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            max-width: 600px;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .details-sections {
            padding: 3rem 0;
        }
        
        .details-section {
            margin-bottom: 3rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 0.5rem;
        }
        
        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .cast-member {
            text-align: center;
            background: var(--dark-surface);
            border-radius: var(--border-radius);
            padding: 1rem;
            transition: var(--transition-smooth);
        }
        
        .cast-member:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .cast-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 0.5rem;
        }
        
        .cast-name {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .cast-character {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .trailer-modal .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            padding: 1rem;
        }
        
        .trailer-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
        }
        
        .trailer-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .user-rating {
            background: var(--dark-surface);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        
        .rating-stars {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }
        
        .star {
            font-size: 1.5rem;
            color: #333;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .star.active,
        .star:hover {
            color: #ffd700;
        }
        
        .reviews-section {
            background: var(--dark-surface);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        
        .review-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 0;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .review-author {
            font-weight: 600;
        }
        
        .review-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .details-content {
                flex-direction: column;
                text-align: center;
            }
            
            .poster-image {
                width: 250px;
                height: 375px;
                margin: 0 auto;
            }
            
            .details-meta {
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .cast-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
        
        .skeleton-backdrop {
            width: 100%;
            height: 60vh;
            background: var(--dark-surface);
        }
        
        .skeleton-content {
            display: flex;
            gap: 2rem;
            padding: 2rem 0;
        }
        
        .skeleton-poster {
            width: 300px;
            height: 450px;
            background: var(--dark-surface-2);
            border-radius: var(--border-radius);
        }
        
        .skeleton-info {
            flex: 1;
        }
        
        .skeleton-title {
            height: 3rem;
            background: var(--dark-surface-2);
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .skeleton-meta {
            height: 2rem;
            background: var(--dark-surface-2);
            border-radius: 4px;
            margin-bottom: 1rem;
            width: 60%;
        }
        
        .skeleton-overview {
            height: 6rem;
            background: var(--dark-surface-2);
            border-radius: 4px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <main class="details-container" style="padding-top: 80px;">
        <!-- Content loaded dynamically -->
    </main>

    <!-- Footer -->
    <div data-include="footer"></div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Rate this content</h2>
            <div class="rating-stars" id="ratingStars">
                <i class="fas fa-star star" data-rating="1"></i>
                <i class="fas fa-star star" data-rating="2"></i>
                <i class="fas fa-star star" data-rating="3"></i>
                <i class="fas fa-star star" data-rating="4"></i>
                <i class="fas fa-star star" data-rating="5"></i>
                <i class="fas fa-star star" data-rating="6"></i>
                <i class="fas fa-star star" data-rating="7"></i>
                <i class="fas fa-star star" data-rating="8"></i>
                <i class="fas fa-star star" data-rating="9"></i>
                <i class="fas fa-star star" data-rating="10"></i>
            </div>
            <p id="ratingText">Click to rate (1-10)</p>
            <button class="btn btn-primary" onclick="submitRating()">Submit Rating</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/include.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/main.js"></script>

    <script>
        let currentContent = null;
        let currentRating = 0;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');
            
            if (contentId) {
                loadContentDetails(contentId);
            } else {
                showToast('Content not found', 'error');
                window.location.href = '/';
            }
        });

        async function loadContentDetails(contentId) {
            try {
                showDetailsSkeleton();
                
                const response = await ApiService.getContentDetails(contentId);
                
                if (response.success && response.data) {
                    currentContent = response.data;
                    renderContentDetails(response.data);
                    
                    // Update page title and meta
                    document.title = `${response.data.title} - CineScope`;
                    
                    // Record view interaction
                    if (isAuthenticated()) {
                        ApiService.recordInteraction(contentId, 'view');
                    }
                } else {
                    throw new Error('Content not found');
                }
            } catch (error) {
                console.error('Error loading content details:', error);
                showErrorMessage(document.querySelector('.details-container'), 'Failed to load content details');
            }
        }

        function renderContentDetails(content) {
            const container = document.querySelector('.details-container');
            if (!container) return;

            const trailerEmbed = content.youtube_trailer ? 
                `<iframe src="https://www.youtube.com/embed/${getYouTubeVideoId(content.youtube_trailer)}" 
                         frameborder="0" allowfullscreen class="trailer-video"></iframe>` : '';

            container.innerHTML = `
                <div class="details-hero">
                    <div class="details-backdrop">
                        <img src="${content.backdrop_path || content.poster_path || '/assets/images/placeholder.jpg'}" 
                             alt="${content.title}" class="backdrop-image">
                    </div>
                    <div class="container">
                        <div class="details-content">
                            <div class="details-poster">
                                <img src="${content.poster_path || '/assets/images/placeholder.jpg'}" 
                                     alt="${content.title}" class="poster-image">
                            </div>
                            <div class="details-info">
                                <h1 class="details-title">${content.title}</h1>
                                ${content.original_title && content.original_title !== content.title ? 
                                    `<p class="original-title">${content.original_title}</p>` : ''}
                                
                                <div class="details-meta">
                                    <span class="meta-item content-type">${content.content_type.toUpperCase()}</span>
                                    ${content.rating ? `<span class="meta-item rating">⭐ ${content.rating}/10</span>` : ''}
                                    ${content.release_date ? `<span class="meta-item">${new Date(content.release_date).getFullYear()}</span>` : ''}
                                    ${content.runtime ? `<span class="meta-item">${content.runtime} min</span>` : ''}
                                    ${content.vote_count ? `<span class="meta-item">${content.vote_count.toLocaleString()} votes</span>` : ''}
                                </div>

                                <div class="genres">
                                    ${content.genres.map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                                    ${content.anime_genres ? content.anime_genres.map(genre => `<span class="genre-tag">${genre}</span>`).join('') : ''}
                                </div>

                                <p class="overview">${content.overview || 'No description available.'}</p>

                                <div class="action-buttons">
                                    ${content.youtube_trailer ? `
                                        <button class="btn btn-primary" onclick="playTrailer('${content.youtube_trailer}')">
                                            <i class="fas fa-play"></i> Watch Trailer
                                        </button>
                                    ` : ''}
                                    ${isAuthenticated() ? `
                                        <button class="btn btn-outline" onclick="addToWatchlist(${content.id})">
                                            <i class="fas fa-bookmark"></i> Add to Watchlist
                                        </button>
                                        <button class="btn btn-outline" onclick="addToFavorites(${content.id})">
                                            <i class="fas fa-heart"></i> Add to Favorites
                                        </button>
                                        <button class="btn btn-secondary" onclick="openRatingModal()">
                                            <i class="fas fa-star"></i> Rate
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-ghost" onclick="shareContent()">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container">
                    <div class="details-sections">
                        ${isAuthenticated() ? `
                            <div class="user-rating">
                                <h3>Your Rating</h3>
                                <div class="rating-display">
                                    <span id="userRatingDisplay">Not rated yet</span>
                                    <button class="btn btn-outline" onclick="openRatingModal()">Rate Now</button>
                                </div>
                            </div>
                        ` : ''}

                        ${content.cast && content.cast.length > 0 ? `
                            <section class="details-section">
                                <h2 class="section-title">Cast</h2>
                                <div class="cast-grid">
                                    ${content.cast.slice(0, 12).map(actor => {
                                        const profilePath = actor.profile_path ? 
                                            `https://image.tmdb.org/t/p/w185${actor.profile_path}` : 
                                            '/assets/images/person-placeholder.jpg';
                                        return `
                                            <div class="cast-member">
                                                <img src="${profilePath}" alt="${actor.name}" class="cast-photo">
                                                <h4 class="cast-name">${actor.name}</h4>
                                                <p class="cast-character">${actor.character || actor.role || ''}</p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </section>
                        ` : ''}

                        ${content.crew && content.crew.length > 0 ? `
                            <section class="details-section">
                                <h2 class="section-title">Crew</h2>
                                <div class="cast-grid">
                                    ${content.crew.slice(0, 8).map(member => {
                                        const profilePath = member.profile_path ? 
                                            `https://image.tmdb.org/t/p/w185${member.profile_path}` : 
                                            '/assets/images/person-placeholder.jpg';
                                        return `
                                            <div class="cast-member">
                                                <img src="${profilePath}" alt="${member.name}" class="cast-photo">
                                                <h4 class="cast-name">${member.name}</h4>
                                                <p class="cast-character">${member.job || member.role || ''}</p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </section>
                        ` : ''}

                        <section class="details-section">
                            <h2 class="section-title">Similar Content</h2>
                            <div class="content-carousel" id="similarContent">
                                <!-- Similar content loaded separately -->
                            </div>
                        </section>

                        <section class="details-section">
                            <h2 class="section-title">Recommendations</h2>
                            <div class="content-carousel" id="recommendationsContent">
                                <!-- Recommendations loaded separately -->
                            </div>
                        </section>
                    </div>
                </div>

                ${trailerEmbed ? `
                    <div id="trailerModal" class="modal">
                        <div class="modal-content trailer-modal">
                            <button class="modal-close">&times;</button>
                            <div class="trailer-container">
                                ${trailerEmbed}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;

            // Load similar content and recommendations
            loadSimilarContent(content.id);
            loadRecommendations(content.id);

            // Re-initialize components
            initializeModals();
            initializeLazyLoading();
        }

        async function loadSimilarContent(contentId) {
            const container = document.getElementById('similarContent');
            if (!container) return;

            try {
                showLoadingSkeleton(container);
                
                const response = await ApiService.getSimilarContent(contentId, 15);
                
                if (response.success && response.data.recommendations) {
                    renderContentCarousel(container, response.data.recommendations);
                } else {
                    container.innerHTML = '<p class="text-secondary">No similar content found</p>';
                }
            } catch (error) {
                console.error('Error loading similar content:', error);
                container.innerHTML = '<p class="text-secondary">Unable to load similar content</p>';
            }
        }

        async function loadRecommendations(contentId) {
            const container = document.getElementById('recommendationsContent');
            if (!container) return;

            try {
                showLoadingSkeleton(container);
                
                // Load trending as recommendations
                const response = await ApiService.getTrending('all', 15);
                
                if (response.success && response.data.recommendations) {
                    renderContentCarousel(container, response.data.recommendations);
                } else {
                    container.innerHTML = '<p class="text-secondary">No recommendations available</p>';
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                container.innerHTML = '<p class="text-secondary">Unable to load recommendations</p>';
            }
        }

        function playTrailer(trailerUrl) {
            openModal('trailerModal');
        }

        function getYouTubeVideoId(url) {
            const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})/);
            return match ? match[1] : null;
        }

        function openRatingModal() {
            if (!requireAuth()) return;
            
            openModal('ratingModal');
            setupRatingStars();
        }

        function setupRatingStars() {
            const stars = document.querySelectorAll('#ratingStars .star');
            const ratingText = document.getElementById('ratingText');
            
            stars.forEach((star, index) => {
                star.addEventListener('mouseenter', () => {
                    highlightStars(index + 1);
                    ratingText.textContent = `Rating: ${index + 1}/10`;
                });
                
                star.addEventListener('click', () => {
                    currentRating = index + 1;
                    highlightStars(currentRating);
                    ratingText.textContent = `Your rating: ${currentRating}/10`;
                });
            });
            
            document.getElementById('ratingStars').addEventListener('mouseleave', () => {
                highlightStars(currentRating);
                ratingText.textContent = currentRating > 0 ? 
                    `Your rating: ${currentRating}/10` : 'Click to rate (1-10)';
            });
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
        }

        async function submitRating() {
            if (currentRating === 0) {
                showToast('Please select a rating', 'warning');
                return;
            }
            
            try {
                const response = await ApiService.recordInteraction(currentContent.id, 'rating', currentRating);
                
                if (response.success) {
                    showToast('Rating saved successfully!', 'success');
                    updateUserRatingDisplay(currentRating);
                    closeModal(document.getElementById('ratingModal'));
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                handleApiError(error, 'Failed to save rating');
            }
        }

        function updateUserRatingDisplay(rating) {
            const display = document.getElementById('userRatingDisplay');
            if (display) {
                display.textContent = `You rated this ${rating}/10`;
            }
        }

        async function addToWatchlist(contentId) {
            if (!requireAuth()) return;
            
            try {
                const response = await ApiService.recordInteraction(contentId, 'watchlist');
                if (response.success) {
                    showToast('Added to watchlist', 'success');
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                handleApiError(error, 'Failed to add to watchlist');
            }
        }

        async function addToFavorites(contentId) {
            if (!requireAuth()) return;
            
            try {
                const response = await ApiService.recordInteraction(contentId, 'favorite');
                if (response.success) {
                    showToast('Added to favorites', 'success');
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                handleApiError(error, 'Failed to add to favorites');
            }
        }

        function shareContent() {
            if (navigator.share) {
                navigator.share({
                    title: currentContent.title,
                    text: currentContent.overview,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showToast('Link copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Unable to share content', 'error');
                });
            }
        }

        // Override global functions
        window.playTrailer = playTrailer;
        window.openRatingModal = openRatingModal;
        window.submitRating = submitRating;
        window.shareContent = shareContent;
    </script>
</body>
</html>