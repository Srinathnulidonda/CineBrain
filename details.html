<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - CineScope</title>
    
    <!-- Same head includes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body class="bg-gray-950 text-gray-100">
    <!-- Header -->
    <div id="header-container"></div>

    <!-- Detail Content -->
    <main id="detailContent">
        <!-- Loading state -->
        <div class="loading-spinner"></div>
    </main>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal" onclick="closeVideoModal()">
        <div class="video-container" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeVideoModal()">
                <i class="fas fa-times"></i>
            </button>
            <div id="videoPlayer"></div>
        </div>
    </div>

    <script src="js/include.js"></script>
    <script src="js/main.js"></script>
    <script>
        let currentContent = null;

        async function loadContentDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id') || sessionStorage.getItem('selectedContentId');
            
            if (!contentId) {
                window.location.href = '/';
                return;
            }

            try {
                const data = await APIService.get(`/content/${contentId}`, false);
                currentContent = data;
                renderContentDetails(data);
            } catch (error) {
                console.error('Error loading content details:', error);
                showNotification('error', 'Failed to load content details');
            }
        }

        function renderContentDetails(content) {
            const detailContent = document.getElementById('detailContent');
            
            detailContent.innerHTML = `
                <!-- Backdrop -->
                <div class="detail-backdrop">
                    <img src="${getImageUrl(content.backdrop_path, 'original')}" 
                         alt="${content.title}">
                    <div class="detail-backdrop-overlay"></div>
                </div>

                <!-- Content Info -->
                <div class="detail-content container">
                    <div class="row">
                        <div class="col-md-4">
                            <img src="${getImageUrl(content.poster_path, 'w500')}" 
                                 alt="${content.title}" 
                                 class="detail-poster">
                        </div>
                        <div class="col-md-8 detail-info">
                            <h1 class="detail-title">${content.title}</h1>
                            ${content.original_title && content.original_title !== content.title ? 
                                `<p class="text-gray-400 mb-3">${content.original_title}</p>` : ''}
                            
                            <div class="detail-meta">
                                <span class="detail-rating">
                                    <i class="fas fa-star"></i> ${content.rating ? content.rating.toFixed(1) : 'N/A'}
                                </span>
                                <span>${content.content_type}</span>
                                <span>${content.release_date ? new Date(content.release_date).getFullYear() : 'N/A'}</span>
                                ${content.runtime ? `<span>${content.runtime} min</span>` : ''}
                                <span>${content.vote_count || 0} votes</span>
                            </div>

                            <div class="detail-genres">
                                ${content.genres.map(genre => 
                                    `<span class="genre-tag">${genre}</span>`
                                ).join('')}
                            </div>

                            <p class="detail-overview">${content.overview || 'No overview available.'}</p>

                            <div class="detail-actions">
                                ${content.youtube_trailer ? 
                                    `<button class="btn btn-primary" onclick="playTrailer('${content.youtube_trailer}')">
                                        <i class="fas fa-play"></i> Watch Trailer
                                    </button>` : ''}
                                <button class="btn btn-secondary" onclick="addToWatchlist(${content.id})">
                                    <i class="fas fa-plus"></i> Add to Watchlist
                                </button>
                                <button class="btn btn-secondary" onclick="addToFavorites(${content.id})">
                                    <i class="fas fa-heart"></i> Add to Favorites
                                </button>
                            </div>

                            ${content.languages && content.languages.length > 0 ? `
                                <div class="mt-4">
                                    <h3 class="mb-2">Languages</h3>
                                    <p>${content.languages.join(', ')}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Cast & Crew -->
                    ${content.cast && content.cast.length > 0 ? `
                        <section class="mt-5">
                            <h2 class="section-title mb-3">Cast</h2>
                            <div class="cast-grid">
                                ${content.cast.slice(0, 12).map(person => `
                                    <div class="cast-card">
                                        <img src="${person.profile_path ? 
                                            `https://image.tmdb.org/t/p/w185${person.profile_path}` : 
                                            '/assets/images/no-avatar.jpg'}" 
                                             alt="${person.name}" 
                                             class="cast-photo">
                                        <h4 class="cast-name">${person.name}</h4>
                                        <p class="cast-character">${person.character || person.character}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}

                    <!-- Similar Content -->
                    ${content.similar_content && content.similar_content.length > 0 ? `
                        <section class="mt-5">
                            <h2 class="section-title mb-3">Similar Content</h2>
                            <div class="content-carousel">
                                <div class="carousel-container">
                                    <button class="carousel-btn prev" onclick="scrollCarousel('similarCarousel', 'prev')">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="carousel-track" id="similarCarousel">
                                        ${content.similar_content.map(item => createContentCard(item)).join('')}
                                    </div>
                                    <button class="carousel-btn next" onclick="scrollCarousel('similarCarousel', 'next')">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </section>
                    ` : ''}
                </div>
            `;

            // Update page title
            document.title = `${content.title} - CineScope`;
        }

        function playTrailer(trailerUrl) {
            if (!trailerUrl) {
                showNotification('info', 'Trailer not available');
                return;
            }

            // Extract YouTube ID
            let videoId = '';
            if (trailerUrl.includes('youtube.com')) {
                videoId = trailerUrl.split('v=')[1];
            } else if (trailerUrl.includes('youtu.be')) {
                videoId = trailerUrl.split('/').pop();
            }

            if (videoId) {
                const videoModal = document.getElementById('videoModal');
                const videoPlayer = document.getElementById('videoPlayer');
                
                videoPlayer.innerHTML = `
                    <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                            frameborder="0" 
                            allow="autoplay; encrypted-media" 
                            allowfullscreen>
                    </iframe>
                `;
                
                videoModal.classList.add('active');
            } else {
                window.open(trailerUrl, '_blank');
            }
        }

        function closeVideoModal() {
            const videoModal = document.getElementById('videoModal');
            const videoPlayer = document.getElementById('videoPlayer');
            
            videoModal.classList.remove('active');
            videoPlayer.innerHTML = '';
        }

        async function addToFavorites(contentId) {
            if (!AppState.user) {
                showNotification('info', 'Please login to add to favorites');
                window.location.href = '/login';
                return;
            }

            try {
                await APIService.post('/interactions', {
                    content_id: contentId,
                    interaction_type: 'favorite'
                });
                
                showNotification('success', 'Added to favorites');
            } catch (error) {
                console.error('Error adding to favorites:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            await loadContentDetails();
        });
    </script>
</body>
</html>