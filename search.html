<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - CineScope</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <!-- Header -->
    <div data-include="/includes/header.html"></div>

    <main class="container py-8">
        <!-- Search Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-4">üîç Search</h1>
            <p class="text-gray-400 mb-6">Find your next favorite movie, TV show, or anime</p>
            
            <!-- Enhanced Search Bar -->
            <div class="max-w-4xl">
                <div class="relative">
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <input type="text" 
                           id="main-search-input"
                           class="w-full pl-12 pr-4 py-4 text-lg bg-gray-800 border-2 border-gray-700 rounded-xl focus:border-blue-500 focus:outline-none"
                           placeholder="Search for movies, TV shows, anime, actors, directors..."
                           autocomplete="off">
                    <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 btn btn-primary">
                        Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Filters -->
        <div class="flex flex-wrap gap-4 mb-8 p-4 bg-gray-800 rounded-lg">
            <select id="type-filter" class="form-select">
                <option value="multi">All Types</option>
                <option value="movie">Movies</option>
                <option value="tv">TV Shows</option>
                <option value="anime">Anime</option>
                <option value="person">People</option>
            </select>

            <select id="genre-filter" class="form-select">
                <option value="">All Genres</option>
                <option value="action">Action</option>
                <option value="adventure">Adventure</option>
                <option value="animation">Animation</option>
                <option value="comedy">Comedy</option>
                <option value="crime">Crime</option>
                <option value="documentary">Documentary</option>
                <option value="drama">Drama</option>
                <option value="family">Family</option>
                <option value="fantasy">Fantasy</option>
                <option value="history">History</option>
                <option value="horror">Horror</option>
                <option value="music">Music</option>
                <option value="mystery">Mystery</option>
                <option value="romance">Romance</option>
                <option value="science fiction">Science Fiction</option>
                <option value="thriller">Thriller</option>
                <option value="war">War</option>
                <option value="western">Western</option>
            </select>

            <select id="year-filter" class="form-select">
                <option value="">All Years</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
                <option value="2010s">2010-2019</option>
                <option value="2000s">2000-2009</option>
                <option value="1990s">1990-1999</option>
                <option value="older">Before 1990</option>
            </select>

            <select id="rating-filter" class="form-select">
                <option value="">All Ratings</option>
                <option value="9">9.0+ Excellent</option>
                <option value="8">8.0+ Very Good</option>
                <option value="7">7.0+ Good</option>
                <option value="6">6.0+ Fair</option>
            </select>

            <button id="clear-filters" class="btn btn-outline">Clear Filters</button>
        </div>

        <!-- Search Suggestions -->
        <div id="search-suggestions" class="mb-8 hidden">
            <h2 class="text-xl font-bold mb-4">Trending Searches</h2>
            <div class="flex flex-wrap gap-2">
                <button class="suggestion-chip" data-query="Marvel">Marvel</button>
                <button class="suggestion-chip" data-query="Studio Ghibli">Studio Ghibli</button>
                <button class="suggestion-chip" data-query="Christopher Nolan">Christopher Nolan</button>
                <button class="suggestion-chip" data-query="Attack on Titan">Attack on Titan</button>
                <button class="suggestion-chip" data-query="Breaking Bad">Breaking Bad</button>
                <button class="suggestion-chip" data-query="Dune">Dune</button>
                <button class="suggestion-chip" data-query="Stranger Things">Stranger Things</button>
                <button class="suggestion-chip" data-query="One Piece">One Piece</button>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="hidden">
            <!-- Results Header -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Search Results</h2>
                    <p class="text-gray-400" id="results-info">Found 0 results</p>
                </div>
                <div class="flex gap-4">
                    <button id="grid-view" class="btn btn-outline btn-sm active">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                        </svg>
                    </button>
                    <button id="list-view" class="btn btn-outline btn-sm">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Results Container -->
            <div id="results-container" class="grid-responsive">
                <!-- Results will be populated here -->
            </div>

            <!-- Pagination -->
            <div class="flex justify-center mt-8">
                <div class="pagination">
                    <button id="prev-page" class="pagination-item" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                        </svg>
                    </button>
                    <span id="page-info" class="pagination-item active">1</span>
                    <button id="next-page" class="pagination-item">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- No Results -->
        <div id="no-results" class="text-center py-16 hidden">
            <div class="text-6xl mb-4">ü§î</div>
            <h2 class="text-2xl font-bold mb-2">No results found</h2>
            <p class="text-gray-400 mb-6">Try adjusting your search terms or filters</p>
            <div class="flex justify-center gap-4">
                <button onclick="clearSearch()" class="btn btn-outline">Clear Search</button>
                <button onclick="showSuggestions()" class="btn btn-primary">Browse Suggestions</button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="search-loading" class="hidden">
            <div class="text-center py-16">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
                <p class="text-gray-400 mt-4">Searching...</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div data-include="/includes/footer.html"></div>

    <script src="/js/main.js"></script>
    <script>
        let currentQuery = '';
        let currentPage = 1;
        let totalPages = 1;
        let currentResults = [];
        let currentView = 'grid';
        let searchTimeout;

        const currentFilters = {
            type: 'multi',
            genre: '',
            year: '',
            rating: ''
        };

        document.addEventListener('DOMContentLoaded', function() {
            setupSearch();
            setupFilters();
            setupViewToggle();
            setupPagination();
            showSuggestions();
            
            // Check for URL parameters
            checkURLParams();
        });

        function setupSearch() {
            const searchInput = document.getElementById('main-search-input');
            const searchBtn = document.getElementById('search-btn');

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (e.target.value.trim().length >= 2) {
                        performSearch(e.target.value.trim());
                    } else if (e.target.value.trim().length === 0) {
                        showSuggestions();
                    }
                }, 300);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = e.target.value.trim();
                    if (query) {
                        performSearch(query);
                    }
                }
            });

            searchBtn.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) {
                    performSearch(query);
                }
            });

            // Setup suggestion chips
            const suggestionChips = document.querySelectorAll('.suggestion-chip');
            suggestionChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const query = chip.getAttribute('data-query');
                    searchInput.value = query;
                    performSearch(query);
                });
            });
        }

        function setupFilters() {
            const filters = ['type-filter', 'genre-filter', 'year-filter', 'rating-filter'];
            
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                filter.addEventListener('change', (e) => {
                    const filterType = filterId.replace('-filter', '');
                    currentFilters[filterType] = e.target.value;
                    
                    if (currentQuery) {
                        currentPage = 1;
                        performSearch(currentQuery);
                    }
                });
            });

            document.getElementById('clear-filters').addEventListener('click', () => {
                filters.forEach(filterId => {
                    document.getElementById(filterId).selectedIndex = 0;
                });
                
                Object.keys(currentFilters).forEach(key => {
                    currentFilters[key] = key === 'type' ? 'multi' : '';
                });
                
                if (currentQuery) {
                    currentPage = 1;
                    performSearch(currentQuery);
                }
            });
        }

        function setupViewToggle() {
            const gridView = document.getElementById('grid-view');
            const listView = document.getElementById('list-view');

            gridView.addEventListener('click', () => {
                currentView = 'grid';
                gridView.classList.add('active');
                listView.classList.remove('active');
                if (currentResults.length > 0) {
                    displayResults(currentResults);
                }
            });

            listView.addEventListener('click', () => {
                currentView = 'list';
                listView.classList.add('active');
                gridView.classList.remove('active');
                if (currentResults.length > 0) {
                    displayResults(currentResults);
                }
            });
        }

        function setupPagination() {
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    performSearch(currentQuery);
                }
            });

            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    performSearch(currentQuery);
                }
            });
        }

        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            const type = urlParams.get('type');
            
            if (query) {
                document.getElementById('main-search-input').value = query;
                if (type) {
                    document.getElementById('type-filter').value = type;
                    currentFilters.type = type;
                }
                performSearch(query);
            }
        }

        async function performSearch(query) {
            if (!query || query.length < 2) return;

            currentQuery = query;
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('q', query);
            url.searchParams.set('type', currentFilters.type);
            window.history.replaceState({}, '', url);

            // Show loading
            showLoading();

            try {
                const results = await apiClient.search(query, currentFilters.type, currentPage);
                
                // Apply additional filters
                let filteredResults = results;
                
                if (currentFilters.genre) {
                    filteredResults = filteredResults.filter(item => {
                        if (item.genres) {
                            const genres = typeof item.genres === 'string' ? JSON.parse(item.genres) : item.genres;
                            return genres.some(genre => genre.toLowerCase().includes(currentFilters.genre.toLowerCase()));
                        }
                        return false;
                    });
                }

                if (currentFilters.rating) {
                    const minRating = parseFloat(currentFilters.rating);
                    filteredResults = filteredResults.filter(item => item.rating && item.rating >= minRating);
                }

                if (currentFilters.year) {
                    filteredResults = filteredResults.filter(item => {
                        if (!item.release_date) return false;
                        const year = new Date(item.release_date).getFullYear();
                        
                        switch (currentFilters.year) {
                            case '2010s': return year >= 2010 && year <= 2019;
                            case '2000s': return year >= 2000 && year <= 2009;
                            case '1990s': return year >= 1990 && year <= 1999;
                            case 'older': return year < 1990;
                            default: return year.toString() === currentFilters.year;
                        }
                    });
                }

                currentResults = filteredResults;
                
                if (filteredResults.length > 0) {
                    displayResults(filteredResults);
                } else {
                    showNoResults();
                }

            } catch (error) {
                console.error('Search failed:', error);
                showNoResults();
                app.showToast('Search failed. Please try again.', 'error');
            }
        }

        function displayResults(results) {
            hideAllStates();
            document.getElementById('search-results').classList.remove('hidden');

            const resultsInfo = document.getElementById('results-info');
            resultsInfo.textContent = `Found ${results.length} result${results.length === 1 ? '' : 's'} for "${currentQuery}"`;

            const container = document.getElementById('results-container');
            
            if (currentView === 'grid') {
                container.className = 'grid-responsive';
                container.innerHTML = results.map(item => UIComponents.createContentCard(item)).join('');
            } else {
                container.className = 'space-y-4';
                container.innerHTML = results.map(item => createListItem(item)).join('');
            }

            updatePagination();
        }

        function createListItem(item) {
            const youtubeUrl = item.youtube_trailer ? `https://www.youtube.com/watch?v=${item.youtube_trailer}` : null;
            
            return `
                <div class="flex items-center gap-4 p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer"
                     onclick="app.goToDetails(${item.id})">
                    <img src="${app.getImageUrl(item.poster_path, 'w92')}" 
                         alt="${item.title}" 
                         class="w-16 h-24 object-cover rounded"
                         onerror="this.src='${app.getPlaceholderImage(92, 138)}'">
                    
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg mb-1">${item.title}</h3>
                        <div class="flex items-center gap-4 text-sm text-gray-400 mb-2">
                            <span class="px-2 py-1 bg-blue-600 rounded text-xs font-medium uppercase">
                                ${item.content_type}
                            </span>
                            ${item.rating ? `
                                <div class="flex items-center gap-1">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="text-yellow-400">
                                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                    </svg>
                                    <span>${item.rating.toFixed(1)}</span>
                                </div>
                            ` : ''}
                            <span>${item.release_date ? new Date(item.release_date).getFullYear() : 'Unknown'}</span>
                        </div>
                        <p class="text-sm text-gray-300 line-clamp-2">${item.overview || 'No description available.'}</p>
                    </div>
                    
                    <div class="flex gap-2">
                        ${youtubeUrl ? `
                            <button onclick="event.stopPropagation(); window.open('${youtubeUrl}', '_blank')" 
                                    class="btn btn-outline btn-sm">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                                </svg>
                            </button>
                        ` : ''}
                        <div data-auth="required">
                            <button onclick="event.stopPropagation(); userActions.addToWatchlist(${item.id})" 
                                    class="btn btn-outline btn-sm">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M2 2v13.5a.5.5 0 0 0 .74.439L8 13.069l5.26 2.87A.5.5 0 0 0 14 15.5V2a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showSuggestions() {
            hideAllStates();
            document.getElementById('search-suggestions').classList.remove('hidden');
        }

        function showLoading() {
            hideAllStates();
            document.getElementById('search-loading').classList.remove('hidden');
        }

        function showNoResults() {
            hideAllStates();
            document.getElementById('no-results').classList.remove('hidden');
        }

        function hideAllStates() {
            document.getElementById('search-suggestions').classList.add('hidden');
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('no-results').classList.add('hidden');
            document.getElementById('search-loading').classList.add('hidden');
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `Page ${currentPage}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function clearSearch() {
            document.getElementById('main-search-input').value = '';
            currentQuery = '';
            currentResults = [];
            showSuggestions();
            
            // Clear URL params
            const url = new URL(window.location);
            url.searchParams.delete('q');
            url.searchParams.delete('type');
            window.history.replaceState({}, '', url);
        }

        // Global functions
        window.clearSearch = clearSearch;
        window.showSuggestions = showSuggestions;
    </script>

    <style>
        .suggestion-chip {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .suggestion-chip:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn.active {
            background: var(--gradient-primary);
            color: white;
        }
    </style>
</body>
</html>
