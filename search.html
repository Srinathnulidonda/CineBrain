<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <script>
        fetch('/includes/head.html')
            .then(response => response.text())
            .then(data => {
                const head = document.querySelector('head');
                head.insertAdjacentHTML('beforeend', data);
            });
    </script>
</head>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <!-- Main Content -->
    <main class="container py-8 pt-24">
        <!-- Search Header -->
        <section class="search-header mb-8">
            <div class="max-w-4xl mx-auto text-center">
                <h1 class="text-4xl font-bold mb-4">
                    Search <span class="text-gradient">Everything</span>
                </h1>
                <p class="text-gray-400 text-lg mb-8">
                    Discover movies, TV shows, and anime from our vast collection
                </p>
                
                <!-- Search Form -->
                <div class="search-form-container">
                    <form class="search-form" onsubmit="performSearch(event)">
                        <div class="search-input-group">
                            <input type="text" 
                                   id="searchInput" 
                                   class="search-input-large" 
                                   placeholder="Search for movies, TV shows, anime..."
                                   autocomplete="off">
                            <button type="submit" class="search-button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        
                        <!-- Search Filters -->
                        <div class="search-filters">
                            <select id="contentTypeFilter" class="filter-select">
                                <option value="multi">All Content</option>
                                <option value="movie">Movies</option>
                                <option value="tv">TV Shows</option>
                                <option value="anime">Anime</option>
                            </select>
                            
                            <select id="genreFilter" class="filter-select">
                                <option value="">All Genres</option>
                                <option value="action">Action</option>
                                <option value="adventure">Adventure</option>
                                <option value="comedy">Comedy</option>
                                <option value="drama">Drama</option>
                                <option value="horror">Horror</option>
                                <option value="romance">Romance</option>
                                <option value="sci-fi">Sci-Fi</option>
                                <option value="thriller">Thriller</option>
                            </select>
                            
                            <select id="languageFilter" class="filter-select">
                                <option value="">All Languages</option>
                                <option value="english">English</option>
                                <option value="hindi">Hindi</option>
                                <option value="telugu">Telugu</option>
                                <option value="tamil">Tamil</option>
                                <option value="kannada">Kannada</option>
                                <option value="malayalam">Malayalam</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Search Results -->
        <section class="search-results">
            <!-- Results Header -->
            <div id="resultsHeader" class="results-header hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Search Results</h2>
                        <p class="text-gray-400" id="resultsCount">0 results found</p>
                    </div>
                    <div class="results-controls">
                        <select id="sortBy" class="filter-select" onchange="sortResults()">
                            <option value="relevance">Sort by Relevance</option>
                            <option value="rating">Sort by Rating</option>
                            <option value="year">Sort by Year</option>
                            <option value="title">Sort by Title</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="searchLoading" class="hidden">
                <div class="loading-large">
                    <div class="spinner-large"></div>
                    <p class="mt-4 text-gray-400">Searching...</p>
                </div>
            </div>

            <!-- Results Grid -->
            <div id="searchResultsGrid" class="search-results-grid hidden"></div>

            <!-- No Results -->
            <div id="noResults" class="no-results hidden">
                <div class="text-center py-12">
                    <i class="fas fa-search text-6xl text-gray-500 mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">No results found</h3>
                    <p class="text-gray-400 mb-6">Try adjusting your search terms or filters</p>
                    <div class="space-y-2">
                        <p class="text-sm text-gray-500">Suggestions:</p>
                        <ul class="text-sm text-gray-400 space-y-1">
                            <li>• Check your spelling</li>
                            <li>• Try broader search terms</li>
                            <li>• Remove some filters</li>
                            <li>• Search for similar content</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div id="searchPagination" class="pagination-container hidden"></div>
        </section>

        <!-- Search Suggestions -->
        <section class="search-suggestions mb-12">
            <h2 class="section-title mb-6">
                <i class="fas fa-lightbulb text-yellow-500"></i>
                Popular Searches
            </h2>
            <div class="suggestions-grid">
                <button class="suggestion-tag" onclick="searchFor('marvel')">Marvel Movies</button>
                <button class="suggestion-tag" onclick="searchFor('anime')">Popular Anime</button>
                <button class="suggestion-tag" onclick="searchFor('bollywood')">Bollywood Hits</button>
                <button class="suggestion-tag" onclick="searchFor('comedy')">Comedy Movies</button>
                <button class="suggestion-tag" onclick="searchFor('thriller')">Thriller Series</button>
                <button class="suggestion-tag" onclick="searchFor('horror')">Horror Movies</button>
                <button class="suggestion-tag" onclick="searchFor('sci-fi')">Sci-Fi Classics</button>
                <button class="suggestion-tag" onclick="searchFor('romance')">Romance Films</button>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div data-include="footer"></div>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class SearchManager {
            constructor() {
                this.currentQuery = '';
                this.currentPage = 1;
                this.currentResults = [];
                this.totalPages = 0;
                this.init();
            }

            init() {
                // Check URL for search query
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q');
                
                if (query) {
                    document.getElementById('searchInput').value = query;
                    this.performSearch(query);
                }

                // Setup input listeners
                this.setupSearchInput();
            }

            setupSearchInput() {
                const searchInput = document.getElementById('searchInput');
                let searchTimeout;

                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    if (query.length >= 2) {
                        searchTimeout = setTimeout(() => {
                            this.performSearch(query);
                        }, 500);
                    } else if (query.length === 0) {
                        this.clearResults();
                    }
                });
            }

            async performSearch(query = null, page = 1) {
                if (!query) {
                    query = document.getElementById('searchInput').value.trim();
                }

                if (!query) {
                    this.clearResults();
                    return;
                }

                this.currentQuery = query;
                this.currentPage = page;

                // Show loading state
                this.showLoading();

                // Update URL
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('q', query);
                if (page > 1) {
                    newUrl.searchParams.set('page', page);
                } else {
                    newUrl.searchParams.delete('page');
                }
                window.history.pushState({}, '', newUrl);

                try {
                    // Get filter values
                    const contentType = document.getElementById('contentTypeFilter').value;
                    const genre = document.getElementById('genreFilter').value;
                    const language = document.getElementById('languageFilter').value;

                    // Perform search
                    const response = await APIService.searchContent(query, contentType, page);
                    
                    if (response && response.results) {
                        this.currentResults = this.applyFilters(response.results, genre, language);
                        this.totalPages = response.total_pages;
                        this.displayResults();
                    } else {
                        this.showNoResults();
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    this.showError();
                } finally {
                    this.hideLoading();
                }
            }

            applyFilters(results, genre, language) {
                let filtered = [...results];

                if (genre) {
                    filtered = filtered.filter(item => 
                        item.genres && item.genres.some(g => 
                            g.toLowerCase().includes(genre.toLowerCase())
                        )
                    );
                }

                if (language) {
                    filtered = filtered.filter(item => 
                        item.languages && item.languages.some(l => 
                            l.toLowerCase().includes(language.toLowerCase())
                        )
                    );
                }

                return filtered;
            }

            displayResults() {
                const resultsGrid = document.getElementById('searchResultsGrid');
                const resultsHeader = document.getElementById('resultsHeader');
                const resultsCount = document.getElementById('resultsCount');

                if (this.currentResults.length === 0) {
                    this.showNoResults();
                    return;
                }

                // Show results header
                resultsHeader.classList.remove('hidden');
                resultsCount.textContent = `${this.currentResults.length} results found for "${this.currentQuery}"`;

                // Create results grid
                const resultsHTML = this.currentResults.map(item => this.createSearchResultCard(item)).join('');
                resultsGrid.innerHTML = resultsHTML;
                resultsGrid.classList.remove('hidden');

                // Setup pagination if needed
                if (this.totalPages > 1) {
                    this.setupPagination();
                }

                // Hide other states
                document.getElementById('noResults').classList.add('hidden');
            }

            createSearchResultCard(item) {
                const posterUrl = item.poster_path || '/assets/images/placeholder.jpg';
                const rating = item.rating ? item.rating.toFixed(1) : 'N/A';
                const year = item.release_date ? new Date(item.release_date).getFullYear() : '';
                const genres = Array.isArray(item.genres) ? item.genres.slice(0, 3).join(', ') : '';

                return `
                    <div class="search-result-card" onclick="window.location.href='/details?id=${item.id}'">
                        <div class="search-result-image">
                            <img src="${posterUrl}" alt="${item.title}" loading="lazy">
                            <div class="search-result-overlay">
                                <div class="search-result-actions">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); ContentManager.addToWatchlist(${item.id})">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); ContentManager.addToFavorites(${item.id})">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    ${item.youtube_trailer ? `
                                        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); ContentManager.playTrailer('${item.youtube_trailer}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="search-result-info">
                            <h3 class="search-result-title">${item.title}</h3>
                            <div class="search-result-meta">
                                <span class="rating">
                                    <i class="fas fa-star"></i> ${rating}
                                </span>
                                ${year ? `<span class="year">${year}</span>` : ''}
                                <span class="badge">${item.content_type.toUpperCase()}</span>
                            </div>
                            ${genres ? `<div class="search-result-genres">${genres}</div>` : ''}
                            ${item.overview ? `<p class="search-result-overview">${item.overview.substring(0, 120)}...</p>` : ''}
                        </div>
                    </div>
                `;
            }

            sortResults() {
                const sortBy = document.getElementById('sortBy').value;
                
                this.currentResults.sort((a, b) => {
                    switch (sortBy) {
                        case 'rating':
                            return (b.rating || 0) - (a.rating || 0);
                        case 'year':
                            const yearA = a.release_date ? new Date(a.release_date).getFullYear() : 0;
                            const yearB = b.release_date ? new Date(b.release_date).getFullYear() : 0;
                            return yearB - yearA;
                        case 'title':
                            return a.title.localeCompare(b.title);
                        default: // relevance
                            return 0;
                    }
                });

                this.displayResults();
            }

            setupPagination() {
                const paginationContainer = document.getElementById('searchPagination');
                const pagination = [];

                // Previous button
                if (this.currentPage > 1) {
                    pagination.push(`
                        <button class="pagination-btn" onclick="searchManager.performSearch('${this.currentQuery}', ${this.currentPage - 1})">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                    `);
                }

                // Page numbers
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(this.totalPages, this.currentPage + 2);

                for (let i = startPage; i <= endPage; i++) {
                    pagination.push(`
                        <button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" 
                                onclick="searchManager.performSearch('${this.currentQuery}', ${i})">
                            ${i}
                        </button>
                    `);
                }

                // Next button
                if (this.currentPage < this.totalPages) {
                    pagination.push(`
                        <button class="pagination-btn" onclick="searchManager.performSearch('${this.currentQuery}', ${this.currentPage + 1})">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    `);
                }

                paginationContainer.innerHTML = `<div class="pagination">${pagination.join('')}</div>`;
                paginationContainer.classList.remove('hidden');
            }

            showLoading() {
                document.getElementById('searchLoading').classList.remove('hidden');
                document.getElementById('searchResultsGrid').classList.add('hidden');
                document.getElementById('noResults').classList.add('hidden');
                document.getElementById('resultsHeader').classList.add('hidden');
            }

            hideLoading() {
                document.getElementById('searchLoading').classList.add('hidden');
            }

            showNoResults() {
                document.getElementById('noResults').classList.remove('hidden');
                document.getElementById('searchResultsGrid').classList.add('hidden');
                document.getElementById('resultsHeader').classList.add('hidden');
            }

            showError() {
                const noResults = document.getElementById('noResults');
                noResults.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2">Search Error</h3>
                        <p class="text-gray-400 mb-6">Something went wrong. Please try again.</p>
                        <button class="btn btn-primary" onclick="searchManager.performSearch('${this.currentQuery}')">
                            Try Again
                        </button>
                    </div>
                `;
                noResults.classList.remove('hidden');
                document.getElementById('searchResultsGrid').classList.add('hidden');
                document.getElementById('resultsHeader').classList.add('hidden');
            }

            clearResults() {
                document.getElementById('searchResultsGrid').classList.add('hidden');
                document.getElementById('noResults').classList.add('hidden');
                document.getElementById('resultsHeader').classList.add('hidden');
                document.getElementById('searchPagination').classList.add('hidden');
            }
        }

        // Global functions
        function performSearch(event) {
            if (event) {
                event.preventDefault();
            }
            searchManager.performSearch();
        }

        function searchFor(query) {
            document.getElementById('searchInput').value = query;
            searchManager.performSearch(query);
        }

        // Initialize search manager
        let searchManager;
        document.addEventListener('DOMContentLoaded', () => {
            searchManager = new SearchManager();
        });
    </script>
</body>
</html>