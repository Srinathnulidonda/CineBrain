<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - CineScope</title>
    <meta name="description" content="Search for movies, TV shows, and anime on CineScope.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Search...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Search Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">Search CineScope</h1>
            <p class="text-gray-400 text-lg">Discover movies, TV shows, and anime</p>
        </div>

        <!-- Advanced Search -->
        <div class="card mb-8">
            <div class="card-content">
                <div class="grid grid-1 lg:grid-4 gap-6">
                    <!-- Search Input -->
                    <div class="lg:col-span-2">
                        <label class="form-label">Search</label>
                        <div class="relative">
                            <input type="search" id="searchInput" class="form-input pr-12" 
                                   placeholder="Enter movie, TV show, or anime title...">
                            <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
                                    onclick="performSearch()">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Content Type Filter -->
                    <div>
                        <label class="form-label">Content Type</label>
                        <select id="contentType" class="form-input">
                            <option value="multi">All</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div>
                        <label class="form-label">Sort By</label>
                        <select id="sortBy" class="form-input">
                            <option value="relevance">Relevance</option>
                            <option value="rating">Rating</option>
                            <option value="release_date">Release Date</option>
                            <option value="popularity">Popularity</option>
                        </select>
                    </div>
                </div>

                <!-- Advanced Filters (Collapsible) -->
                <div class="mt-6">
                    <button class="flex items-center gap-2 text-primary hover:text-primary-light transition-colors"
                            onclick="toggleAdvancedFilters()">
                        <span>Advanced Filters</span>
                        <svg id="filterIcon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="advancedFilters" class="mt-4 space-y-4 hidden">
                        <div class="grid grid-1 md:grid-3 gap-6">
                            <!-- Genre Filter -->
                            <div>
                                <label class="form-label">Genre</label>
                                <select id="genreFilter" class="form-input">
                                    <option value="">All Genres</option>
                                    <option value="action">Action</option>
                                    <option value="comedy">Comedy</option>
                                    <option value="drama">Drama</option>
                                    <option value="thriller">Thriller</option>
                                    <option value="romance">Romance</option>
                                    <option value="sci-fi">Sci-Fi</option>
                                    <option value="horror">Horror</option>
                                    <option value="fantasy">Fantasy</option>
                                    <option value="animation">Animation</option>
                                </select>
                            </div>

                            <!-- Language Filter -->
                            <div>
                                <label class="form-label">Language</label>
                                <select id="languageFilter" class="form-input">
                                    <option value="">All Languages</option>
                                    <option value="english">English</option>
                                    <option value="hindi">Hindi</option>
                                    <option value="telugu">Telugu</option>
                                    <option value="tamil">Tamil</option>
                                    <option value="kannada">Kannada</option>
                                    <option value="malayalam">Malayalam</option>
                                    <option value="japanese">Japanese</option>
                                </select>
                            </div>

                            <!-- Year Range -->
                            <div>
                                <label class="form-label">Release Year</label>
                                <div class="flex gap-2">
                                    <input type="number" id="yearFrom" class="form-input" placeholder="From" min="1900" max="2025">
                                    <input type="number" id="yearTo" class="form-input" placeholder="To" min="1900" max="2025">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-1 md:grid-2 gap-6">
                            <!-- Rating Range -->
                            <div>
                                <label class="form-label">Minimum Rating</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" id="ratingRange" class="flex-1" min="0" max="10" step="0.5" value="0">
                                    <span id="ratingValue" class="text-sm font-medium">0+</span>
                                </div>
                            </div>

                            <!-- Content Tags -->
                            <div>
                                <label class="form-label">Special Categories</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="trending" class="rounded border-gray-600 bg-gray-700 text-primary">
                                        <span class="ml-2 text-sm">Trending</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="newReleases" class="rounded border-gray-600 bg-gray-700 text-primary">
                                        <span class="ml-2 text-sm">New Releases</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="criticsChoice" class="rounded border-gray-600 bg-gray-700 text-primary">
                                        <span class="ml-2 text-sm">Critics' Choice</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results Header -->
        <div id="resultsHeader" class="flex items-center justify-between mb-6" style="display: none;">
            <div>
                <h2 class="text-2xl font-semibold">Search Results</h2>
                <p class="text-gray-400" id="resultsCount">0 results found</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- View Toggle -->
                <div class="flex border border-gray-700 rounded-lg overflow-hidden">
                    <button class="p-2 bg-primary text-white" id="gridViewBtn" onclick="setView('grid')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                    </button>
                    <button class="p-2 bg-gray-800 text-gray-400" id="listViewBtn" onclick="setView('list')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="searchResults" class="content-grid">
            <!-- Initial state -->
            <div class="col-span-full">
                <div class="empty-state">
                    <div class="empty-state-icon">🔍</div>
                    <h3 class="empty-state-title">Start Your Search</h3>
                    <p class="empty-state-description">Enter a movie, TV show, or anime title to begin discovering content.</p>
                </div>
            </div>
        </div>

        <!-- Load More Button -->
        <div id="loadMoreContainer" class="text-center mt-8" style="display: none;">
            <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMoreResults()">
                Load More Results
            </button>
        </div>

        <!-- Popular Searches -->
        <section class="section mt-12">
            <h2 class="section-title">Popular Searches</h2>
            <div class="flex flex-wrap gap-2">
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Marvel')">Marvel</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('DC')">DC</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Studio Ghibli')">Studio Ghibli</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Bollywood')">Bollywood</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Christopher Nolan')">Christopher Nolan</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Netflix')">Netflix</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Anime')">Anime</button>
                <button class="badge badge-ghost hover:badge-primary transition-colors cursor-pointer" 
                        onclick="quickSearch('Horror')">Horror</button>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let currentPage = 1;
        let currentQuery = '';
        let currentResults = [];
        let isLoading = false;
        let currentView = 'grid';

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadInitialState();
        });

        function setupEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('searchInput');
            const debouncedSearch = Utils.debounce(performSearch, 500);
            
            searchInput.addEventListener('input', debouncedSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });

            // Filter changes
            document.getElementById('contentType').addEventListener('change', performSearch);
            document.getElementById('sortBy').addEventListener('change', performSearch);
            document.getElementById('genreFilter').addEventListener('change', performSearch);
            document.getElementById('languageFilter').addEventListener('change', performSearch);
            document.getElementById('yearFrom').addEventListener('change', performSearch);
            document.getElementById('yearTo').addEventListener('change', performSearch);

            // Rating range
            const ratingRange = document.getElementById('ratingRange');
            ratingRange.addEventListener('input', (e) => {
                document.getElementById('ratingValue').textContent = e.target.value + '+';
                debouncedSearch();
            });

            // Checkboxes
            ['trending', 'newReleases', 'criticsChoice'].forEach(id => {
                document.getElementById(id).addEventListener('change', performSearch);
            });
        }

        function loadInitialState() {
            const urlParams = Utils.getURLParams();
            if (urlParams.q) {
                document.getElementById('searchInput').value = urlParams.q;
                performSearch();
            }
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                resetResults();
                return;
            }

            if (isLoading) return;

            try {
                isLoading = true;
                currentQuery = query;
                currentPage = 1;
                
                // Show loading
                showLoadingResults();
                
                // Build search parameters
                const params = buildSearchParams();
                
                // Perform search
                const response = await api.search(query, params.type, currentPage);
                
                currentResults = response.results || [];
                displayResults(currentResults, response.total_results || 0);
                
                // Update URL
                Utils.setURLParam('q', query);
                
            } catch (error) {
                console.error('Search error:', error);
                showErrorResults();
            } finally {
                isLoading = false;
            }
        }

        function buildSearchParams() {
            return {
                type: document.getElementById('contentType').value,
                sort: document.getElementById('sortBy').value,
                genre: document.getElementById('genreFilter').value,
                language: document.getElementById('languageFilter').value,
                yearFrom: document.getElementById('yearFrom').value,
                yearTo: document.getElementById('yearTo').value,
                minRating: document.getElementById('ratingRange').value,
                trending: document.getElementById('trending').checked,
                newReleases: document.getElementById('newReleases').checked,
                criticsChoice: document.getElementById('criticsChoice').checked
            };
        }

        function showLoadingResults() {
            const container = document.getElementById('searchResults');
            const header = document.getElementById('resultsHeader');
            
            header.style.display = 'flex';
            document.getElementById('resultsCount').textContent = 'Searching...';
            
            UI.showSkeleton(container, 12);
        }

        function displayResults(results, totalResults) {
            const container = document.getElementById('searchResults');
            const header = document.getElementById('resultsHeader');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            
            header.style.display = 'flex';
            document.getElementById('resultsCount').textContent = 
                `${totalResults.toLocaleString()} result${totalResults !== 1 ? 's' : ''} found`;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <h3 class="empty-state-title">No results found</h3>
                            <p class="empty-state-description">
                                Try adjusting your search terms or filters.
                            </p>
                            <button class="btn btn-primary mt-4" onclick="clearFilters()">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                `;
                loadMoreContainer.style.display = 'none';
                return;
            }

            if (currentView === 'grid') {
                displayGridResults(container, results);
            } else {
                displayListResults(container, results);
            }

            // Show load more if there are more results
            loadMoreContainer.style.display = results.length >= 20 ? 'block' : 'none';
            
            // Initialize lazy loading
            Utils.lazyLoadImages();
        }

        function displayGridResults(container, results) {
            container.className = 'content-grid';
            container.innerHTML = results.map(item => {
                const card = UI.createMovieCard(item);
                return card.outerHTML;
            }).join('');
        }

        function displayListResults(container, results) {
            container.className = 'space-y-4';
            container.innerHTML = results.map(item => `
                <div class="card cursor-pointer hover:scale-[1.02] transition-transform" 
                     onclick="Router.navigate('/details?id=${item.id}')">
                    <div class="card-content">
                        <div class="flex gap-4">
                            <img src="${item.poster_path || Utils.getPlaceholderImage(100, 150)}" 
                                 alt="${Utils.sanitizeHTML(item.title)}" 
                                 class="w-20 h-30 object-cover rounded"
                                 onerror="this.src='${Utils.getPlaceholderImage(100, 150)}'">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold mb-2 truncate">${Utils.sanitizeHTML(item.title)}</h3>
                                <div class="flex items-center gap-4 mb-2 text-sm text-gray-400">
                                    ${item.rating ? `<span class="flex items-center gap-1">⭐ ${Utils.formatRating(item.rating)}</span>` : ''}
                                    ${item.release_date ? `<span>${Utils.formatDate(item.release_date)}</span>` : ''}
                                    <span class="badge badge-ghost">${item.content_type?.toUpperCase() || 'MOVIE'}</span>
                                </div>
                                <p class="text-gray-300 text-sm leading-relaxed">
                                    ${Utils.truncateText(item.overview, 200)}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadMoreResults() {
            if (isLoading || !currentQuery) return;

            try {
                isLoading = true;
                currentPage++;
                
                const button = document.getElementById('loadMoreBtn');
                button.disabled = true;
                button.textContent = 'Loading...';
                
                const params = buildSearchParams();
                const response = await api.search(currentQuery, params.type, currentPage);
                
                const newResults = response.results || [];
                currentResults = [...currentResults, ...newResults];
                
                // Append new results
                const container = document.getElementById('searchResults');
                if (currentView === 'grid') {
                    container.insertAdjacentHTML('beforeend', 
                        newResults.map(item => UI.createMovieCard(item).outerHTML).join('')
                    );
                } else {
                    // For list view, recreate all results
                    displayListResults(container, currentResults);
                }
                
                // Hide load more if no more results
                if (newResults.length < 20) {
                    document.getElementById('loadMoreContainer').style.display = 'none';
                }
                
                Utils.lazyLoadImages();
                
            } catch (error) {
                console.error('Load more error:', error);
                UI.showToast('Failed to load more results', 'error');
            } finally {
                isLoading = false;
                const button = document.getElementById('loadMoreBtn');
                button.disabled = false;
                button.textContent = 'Load More Results';
            }
        }

        function setView(view) {
            currentView = view;
            
            // Update buttons
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (view === 'grid') {
                gridBtn.classList.add('bg-primary', 'text-white');
                gridBtn.classList.remove('bg-gray-800', 'text-gray-400');
                listBtn.classList.add('bg-gray-800', 'text-gray-400');
                listBtn.classList.remove('bg-primary', 'text-white');
            } else {
                listBtn.classList.add('bg-primary', 'text-white');
                listBtn.classList.remove('bg-gray-800', 'text-gray-400');
                gridBtn.classList.add('bg-gray-800', 'text-gray-400');
                gridBtn.classList.remove('bg-primary', 'text-white');
            }
            
            // Re-render results if we have them
            if (currentResults.length > 0) {
                const container = document.getElementById('searchResults');
                if (view === 'grid') {
                    displayGridResults(container, currentResults);
                } else {
                    displayListResults(container, currentResults);
                }
            }
        }

        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            const icon = document.getElementById('filterIcon');
            
            if (filters.classList.contains('hidden')) {
                filters.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                filters.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function clearFilters() {
            // Reset all filters
            document.getElementById('contentType').value = 'multi';
            document.getElementById('sortBy').value = 'relevance';
            document.getElementById('genreFilter').value = '';
            document.getElementById('languageFilter').value = '';
            document.getElementById('yearFrom').value = '';
            document.getElementById('yearTo').value = '';
            document.getElementById('ratingRange').value = 0;
            document.getElementById('ratingValue').textContent = '0+';
            document.getElementById('trending').checked = false;
            document.getElementById('newReleases').checked = false;
            document.getElementById('criticsChoice').checked = false;
            
            // Re-search if there's a query
            if (currentQuery) {
                performSearch();
            }
        }

        function quickSearch(query) {
            document.getElementById('searchInput').value = query;
            performSearch();
        }

        function resetResults() {
            const container = document.getElementById('searchResults');
            const header = document.getElementById('resultsHeader');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            
            header.style.display = 'none';
            loadMoreContainer.style.display = 'none';
            
            container.className = 'content-grid';
            container.innerHTML = `
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <h3 class="empty-state-title">Start Your Search</h3>
                        <p class="empty-state-description">Enter a movie, TV show, or anime title to begin discovering content.</p>
                    </div>
                </div>
            `;
            
            currentResults = [];
            currentPage = 1;
        }

        function showErrorResults() {
            const container = document.getElementById('searchResults');
            container.innerHTML = `
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <h3 class="empty-state-title">Search Error</h3>
                        <p class="empty-state-description">Something went wrong. Please try again.</p>
                        <button class="btn btn-primary mt-4" onclick="performSearch()">Retry Search</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>