<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Account Settings - CineScope">
    <title>Account Settings - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="topbar">
        <div class="topbar-left">
            <a href="/" class="logo">CineScope</a>
            <button class="back-btn" onclick="goToProfile()">‚Üê Profile</button>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search..." id="headerSearch">
        </div>
        <div class="topbar-right" id="userSection"></div>
    </nav>

    <main class="settings-page">
        <div class="container">
            <div class="settings-layout">
                <!-- Settings Sidebar -->
                <div class="settings-sidebar">
                    <div class="user-profile">
                        <img src="${window.auth.getUserAvatar()}" alt="${window.auth.getUser().username}" class="profile-avatar">
                        <h3>${window.auth.getUser().username}</h3>
                        <p class="profile-email">${window.auth.getUser().email}</p>
                    </div>
                    
                    <nav class="settings-nav">
                        <a href="#profile" class="nav-item active" onclick="switchTab('profile')">
                            <span class="nav-icon">üë§</span>
                            <span class="nav-label">Profile</span>
                        </a>
                        <a href="#preferences" class="nav-item" onclick="switchTab('preferences')">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-label">Preferences</span>
                        </a>
                        <a href="#notifications" class="nav-item" onclick="switchTab('notifications')">
                            <span class="nav-icon">üîî</span>
                            <span class="nav-label">Notifications</span>
                        </a>
                        <a href="#privacy" class="nav-item" onclick="switchTab('privacy')">
                            <span class="nav-icon">üîí</span>
                            <span class="nav-label">Privacy</span>
                        </a>
                        <a href="#security" class="nav-item" onclick="switchTab('security')">
                            <span class="nav-icon">üõ°Ô∏è</span>
                            <span class="nav-label">Security</span>
                        </a>
                    </nav>
                </div>

                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- Profile Tab -->
                    <div class="settings-tab active" id="profile-tab">
                        <h2>Profile Settings</h2>
                        
                        <form class="settings-form" id="profileForm">
                            <div class="form-group">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" 
                                       id="username" 
                                       class="form-input" 
                                       value="${window.auth.getUser().username}"
                                       required>
                                <div class="form-hint">This is your public display name</div>
                            </div>

                            <div class="form-group">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" 
                                       id="email" 
                                       class="form-input" 
                                       value="${window.auth.getUser().email}"
                                       required>
                                <div class="form-hint">We'll use this for account notifications</div>
                            </div>

                            <div class="form-group">
                                <label for="bio" class="form-label">Bio</label>
                                <textarea id="bio" 
                                          class="form-textarea" 
                                          rows="4" 
                                          placeholder="Tell us about yourself...">${window.auth.getUser().bio || ''}</textarea>
                                <div class="form-hint">Max 200 characters</div>
                            </div>

                            <div class="form-group">
                                <label for="language" class="form-label">Preferred Language</label>
                                <select id="language" class="form-select">
                                    <option value="en" selected>English</option>
                                    <option value="es">Espa√±ol</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="de">Deutsch</option>
                                    <option value="ja">Êó•Êú¨Ë™û</option>
                                    <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                                    <option value="zh">‰∏≠Êñá</option>
                                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                                    <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                                    <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                                    <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                                </select>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-outline" onclick="resetProfileForm()">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Preferences Tab -->
                    <div class="settings-tab" id="preferences-tab">
                        <h2>Content Preferences</h2>
                        
                        <form class="settings-form" id="preferencesForm">
                            <div class="form-group">
                                <label class="form-label">Preferred Genres</label>
                                <div class="genre-grid">
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="action">
                                        <span>Action</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="comedy">
                                        <span>Comedy</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="drama">
                                        <span>Drama</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="horror">
                                        <span>Horror</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="romance">
                                        <span>Romance</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="sci-fi">
                                        <span>Sci-Fi</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="thriller">
                                        <span>Thriller</span>
                                    </label>
                                    <label class="genre-checkbox">
                                        <input type="checkbox" name="genres" value="animation">
                                        <span>Animation</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Content Types</label>
                                <div class="content-types">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="contentTypes" value="movies" checked>
                                        <span>Movies</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="contentTypes" value="tv" checked>
                                        <span>TV Shows</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="contentTypes" value="anime" checked>
                                        <span>Anime</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="quality" class="form-label">Preferred Quality</label>
                                <select id="quality" class="form-select">
                                    <option value="auto">Auto (Recommended)</option>
                                    <option value="1080p">1080p Full HD</option>
                                    <option value="720p">720p HD</option>
                                    <option value="480p">480p SD</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="subtitle" class="form-label">Subtitle Preferences</label>
                                <select id="subtitle" class="form-select">
                                    <option value="auto">Auto-detect</option>
                                    <option value="english">English</option>
                                    <option value="spanish">Espa√±ol</option>
                                    <option value="french">Fran√ßais</option>
                                    <option value="german">Deutsch</option>
                                    <option value="japanese">Êó•Êú¨Ë™û</option>
                                    <option value="chinese">‰∏≠Êñá</option>
                                    <option value="hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                                    <option value="telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                                    <option value="tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                                </select>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Preferences</button>
                                <button type="button" class="btn btn-outline" onclick="resetPreferencesForm()">Reset to Default</button>
                            </div>
                        </form>
                    </div>

                    <!-- Notifications Tab -->
                    <div class="settings-tab" id="notifications-tab">
                        <h2>Notification Settings</h2>
                        
                        <form class="settings-form" id="notificationsForm">
                            <div class="form-group">
                                <label class="form-label">Email Notifications</label>
                                <div class="notification-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="emailNotifications" value="newContent" checked>
                                        <span>New Content Recommendations</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="emailNotifications" value="weeklyDigest" checked>
                                        <span>Weekly Digest</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="emailNotifications" value="accountUpdates">
                                        <span>Account Updates</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="emailNotifications" value="promotions">
                                        <span>Promotions & Offers</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Push Notifications</label>
                                <div class="notification-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="pushNotifications" value="newEpisodes" checked>
                                        <span>New Episodes</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="pushNotifications" value="trendingUpdates" checked>
                                        <span>Trending Updates</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="pushNotifications" value="watchlistReminders">
                                        <span>Watchlist Reminders</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">SMS Notifications</label>
                                <div class="notification-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="smsNotifications" value="securityAlerts" checked>
                                        <span>Security Alerts</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="smsNotifications" value="promotions">
                                        <span>Promotions & Offers</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Notification Settings</button>
                                <button type="button" class="btn btn-outline" onclick="resetNotificationsForm()">Reset to Default</button>
                            </div>
                        </form>
                    </div>

                    <!-- Privacy Tab -->
                    <div class="settings-tab" id="privacy-tab">
                        <h2>Privacy Settings</h2>
                        
                        <form class="settings-form" id="privacyForm">
                            <div class="form-group">
                                <label class="form-label">Profile Visibility</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="profileVisibility" value="public" checked>
                                        <span>Public - Anyone can see your profile</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="profileVisibility" value="friends">
                                        <span>Friends Only - Only connections can see your profile</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="profileVisibility" value="private">
                                        <span>Private - Only you can see your profile</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Activity Visibility</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="activityVisibility" value="everyone" checked>
                                        <span>Everyone can see your activity</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="activityVisibility" value="friends">
                                        <span>Only friends can see your activity</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="activityVisibility" value="nobody">
                                        <span>Nobody can see your activity</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Data & Analytics</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="analytics" value="usage" checked>
                                        <span>Share usage data to improve recommendations</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="analytics" value="crashes" checked>
                                        <span>Share crash reports to improve stability</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Privacy Settings</button>
                                <button type="button" class="btn btn-outline" onclick="resetPrivacyForm()">Reset to Default</button>
                            </div>
                        </form>
                    </div>

                    <!-- Security Tab -->
                    <div class="settings-tab" id="security-tab">
                        <h2>Security Settings</h2>
                        
                        <form class="settings-form" id="securityForm">
                            <div class="form-group">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input type="password" 
                                       id="currentPassword" 
                                       class="form-input" 
                                       placeholder="Enter current password">
                            </div>

                            <div class="form-group">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" 
                                       id="newPassword" 
                                       class="form-input" 
                                       placeholder="Enter new password">
                                <div class="password-strength">
                                    <div class="strength-bar">
                                        <div class="strength-fill" id="passwordStrength"></div>
                                    </div>
                                    <span class="strength-text" id="strengthText">Password strength</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                <input type="password" 
                                       id="confirmPassword" 
                                       class="form-input" 
                                       placeholder="Confirm new password">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Two-Factor Authentication</label>
                                <div class="security-option">
                                    <div class="security-info">
                                        <h4>Enable 2FA</h4>
                                        <p>Add an extra layer of security to your account</p>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="setup2FA()">
                                        Enable 2FA
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Active Sessions</label>
                                <div class="active-sessions">
                                    <div class="session-item">
                                        <div class="session-info">
                                            <span class="session-device">Chrome on Windows</span>
                                            <span class="session-location">New York, USA</span>
                                            <span class="session-time">Active now</span>
                                        </div>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="revokeSession('current')">
                                            Revoke
                                        </button>
                                    </div>
                                    <div class="session-item">
                                        <div class="session-info">
                                            <span class="session-device">Safari on iPhone</span>
                                            <span class="session-location">San Francisco, USA</span>
                                            <span class="session-time">Last seen 2 hours ago</span>
                                        </div>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="revokeSession('mobile')">
                                            Revoke
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Update Security Settings</button>
                                <button type="button" class="btn btn-outline" onclick="resetSecurityForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="/" class="mobile-nav-item">
            <span class="mobile-nav-icon">üè†</span>
            <span class="mobile-nav-label">Home</span>
        </a>
        <a href="/content/search.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">üîç</span>
            <span class="mobile-nav-label">Search</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="requireAuth(() => goToWatchlist())">
            <span class="mobile-nav-icon">üìö</span>
            <span class="mobile-nav-label">Watchlist</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="requireAuth(() => goToFavorites())">
            <span class="mobile-nav-icon">‚ù§Ô∏è</span>
            <span class="mobile-nav-label">Favorites</span>
        </a>
        <a href="#" class="mobile-nav-item active" onclick="requireAuth(() => goToProfile())">
            <span class="mobile-nav-icon">üë§</span>
            <span class="mobile-nav-label">Profile</span>
        </a>
    </nav>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let currentTab = 'profile';

        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/auth/login.html';
                return;
            }

            // Verify URL username matches current user
            const pathUsername = window.location.pathname.split('/')[1];
            const currentUser = window.auth.getUser();
            
            if (pathUsername !== currentUser.username) {
                window.location.href = `/${currentUser.username}/settings`;
                return;
            }

            updateUserSection();
            setupHeaderSearch();
            loadUserPreferences();
        });

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.settings-nav .nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === `#${tabName}`) {
                    item.classList.add('active');
                }
            });
            
            currentTab = tabName;
        }

        async function loadUserPreferences() {
            try {
                // Load user preferences from real API
                const preferences = await window.api.getUserPreferences();
                
                // Apply preferences to forms
                if (preferences.genres) {
                    document.querySelectorAll('input[name="genres"]').forEach(checkbox => {
                        if (preferences.genres.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                if (preferences.contentTypes) {
                    document.querySelectorAll('input[name="contentTypes"]').forEach(checkbox => {
                        if (preferences.contentTypes.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                if (preferences.quality) {
                    document.getElementById('quality').value = preferences.quality;
                }
                
                if (preferences.subtitle) {
                    document.getElementById('subtitle').value = preferences.subtitle;
                }
                
            } catch (error) {
                console.error('Failed to load preferences:', error);
            }
        }

        // Form Handlers
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const profileData = {
                username: formData.get('username'),
                email: formData.get('email'),
                bio: formData.get('bio'),
                language: formData.get('language')
            };
            
            try {
                await window.api.updateUserProfile(profileData);
                showToast('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Failed to update profile:', error);
                showToast('Failed to update profile', 'error');
            }
        });

        document.getElementById('preferencesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const preferences = {
                genres: formData.getAll('genres'),
                contentTypes: formData.getAll('contentTypes'),
                quality: formData.get('quality'),
                subtitle: formData.get('subtitle')
            };
            
            try {
                await window.api.updateUserPreferences(preferences);
                showToast('Preferences saved successfully!', 'success');
            } catch (error) {
                console.error('Failed to save preferences:', error);
                showToast('Failed to save preferences', 'error');
            }
        });

        document.getElementById('notificationsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const notifications = {
                email: formData.getAll('emailNotifications'),
                push: formData.getAll('pushNotifications'),
                sms: formData.getAll('smsNotifications')
            };
            
            try {
                await window.api.updateNotificationSettings(notifications);
                showToast('Notification settings updated!', 'success');
            } catch (error) {
                console.error('Failed to update notifications:', error);
                showToast('Failed to update notifications', 'error');
            }
        });

        document.getElementById('privacyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const privacy = {
                profileVisibility: formData.get('profileVisibility'),
                activityVisibility: formData.get('activityVisibility'),
                analytics: formData.getAll('analytics')
            };
            
            try {
                await window.api.updatePrivacySettings(privacy);
                showToast('Privacy settings updated!', 'success');
            } catch (error) {
                console.error('Failed to update privacy:', error);
                showToast('Failed to update privacy', 'error');
            }
        });

        document.getElementById('securityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                await window.api.changePassword(currentPassword, newPassword);
                showToast('Password changed successfully!', 'success');
                e.target.reset();
            } catch (error) {
                console.error('Failed to change password:', error);
                showToast('Failed to change password', 'error');
            }
        });

        // Password strength checker
        document.getElementById('newPassword').addEventListener('input', (e) => {
            const password = e.target.value;
            const strength = calculatePasswordStrength(password);
            updatePasswordStrength(strength);
        });

        function calculatePasswordStrength(password) {
            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            return Math.min(strength, 5);
        }

        function updatePasswordStrength(strength) {
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');
            
            const strengths = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong', 'Very Strong'];
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#10b981'];
            
            strengthBar.style.width = `${(strength / 5) * 100}%`;
            strengthBar.style.backgroundColor = colors[strength];
            strengthText.textContent = strengths[strength];
            strengthText.style.color = colors[strength];
        }

        // Utility Functions
        function updateUserSection() {
            const userSection = document.getElementById('userSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <img src="${window.auth.getUserAvatar()}" 
                         alt="${user.username}" 
                         class="user-avatar"
                         onclick="toggleUserMenu()">
                    <div class="user-dropdown" id="userDropdown" style="display: none;">
                        <a href="/${user.username}/profile" class="dropdown-item">Profile</a>
                        <a href="/${user.username}/watchlist" class="dropdown-item">Watchlist</a>
                        <a href="/${user.username}/favorites" class="dropdown-item">Favorites</a>
                        <a href="/${user.username}/activity" class="dropdown-item">Activity</a>
                        <a href="/${user.username}/settings" class="dropdown-item active">Settings</a>
                        ${user.is_admin ? '<a href="/admin/" class="dropdown-item">Admin</a>' : ''}
                        <hr>
                        <a href="#" onclick="window.auth.logout()" class="dropdown-item">Logout</a>
                    </div>
                `;
            }
        }

        function setupHeaderSearch() {
            const searchInput = document.getElementById('headerSearch');
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        window.location.href = `/content/search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function goToProfile() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/profile`;
        }

        function goToWatchlist() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/watchlist`;
        }

        function goToFavorites() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/favorites`;
        }

        function requireAuth(callback) {
            if (window.auth.isAuthenticated()) {
                callback();
            } else {
                window.location.href = '/auth/login.html';
            }
        }

        // Reset functions
        function resetProfileForm() {
            document.getElementById('profileForm').reset();
            const user = window.auth.getUser();
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
        }

        function resetPreferencesForm() {
            document.getElementById('preferencesForm').reset();
            document.querySelectorAll('input[name="genres"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="contentTypes"]').forEach(cb => cb.checked = true);
            document.getElementById('quality').value = 'auto';
            document.getElementById('subtitle').value = 'auto';
        }

        function resetNotificationsForm() {
            document.getElementById('notificationsForm').reset();
            document.querySelectorAll('input[name="emailNotifications"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="pushNotifications"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="smsNotifications"]').forEach(cb => cb.checked = false);
        }

        function resetPrivacyForm() {
            document.getElementById('privacyForm').reset();
            document.querySelector('input[name="profileVisibility"][value="public"]').checked = true;
            document.querySelector('input[name="activityVisibility"][value="everyone"]').checked = true;
            document.querySelectorAll('input[name="analytics"]').forEach(cb => cb.checked = true);
        }

        function resetSecurityForm() {
            document.getElementById('securityForm').reset();
            document.getElementById('passwordStrength').style.width = '0%';
            document.getElementById('strengthText').textContent = 'Password strength';
        }

        function setup2FA() {
            showToast('2FA setup would be implemented', 'info');
        }

        function revokeSession(sessionId) {
            showToast(`Session ${sessionId} revoked`, 'success');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.topbar-right')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>