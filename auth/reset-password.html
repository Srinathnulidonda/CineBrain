<!DOCTYPE html>
<html lang="en" data-theme="dark" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - CineBrain</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-icon-180x180.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="/assets/css/auth/auth.css">
</head>

<body>
    <div class="reset-card">
        <div class="brand">
            <h1 class="brand-name">CineBrain</h1>
            <p class="brand-tagline">The Mind Behind Your Next Favorite</p>
        </div>

        <div id="mainContent">
            <div class="page-title">
                <h2>Reset Your Password</h2>
            </div>
            <p class="page-description">
                Enter your new password below. Make sure it's strong and secure.
            </p>

            <div class="alert" id="alertBox"></div>

            <form id="resetForm" novalidate>
                <div class="form-group">
                    <label for="password" class="form-label">New Password</label>
                    <div class="input-wrapper">
                        <input type="password" id="password" name="password" class="form-input"
                            placeholder="Enter new password" required autocomplete="new-password">
                        <button type="button" class="password-toggle" id="passwordToggle">
                            <i data-feather="eye" class="eye-icon"></i>
                            <i data-feather="eye-off" class="eye-off-icon" style="display: none;"></i>
                        </button>
                    </div>
                    <div class="password-requirements">
                        <div class="requirement" id="req-length">
                            <span class="requirement-icon">
                                <i data-feather="circle" class="circle"></i>
                                <i data-feather="check-circle" class="check"></i>
                            </span>
                            At least 8 characters
                        </div>
                        <div class="requirement" id="req-uppercase">
                            <span class="requirement-icon">
                                <i data-feather="circle" class="circle"></i>
                                <i data-feather="check-circle" class="check"></i>
                            </span>
                            One uppercase letter
                        </div>
                        <div class="requirement" id="req-lowercase">
                            <span class="requirement-icon">
                                <i data-feather="circle" class="circle"></i>
                                <i data-feather="check-circle" class="check"></i>
                            </span>
                            One lowercase letter
                        </div>
                        <div class="requirement" id="req-number">
                            <span class="requirement-icon">
                                <i data-feather="circle" class="circle"></i>
                                <i data-feather="check-circle" class="check"></i>
                            </span>
                            One number
                        </div>
                        <div class="requirement" id="req-special">
                            <span class="requirement-icon">
                                <i data-feather="circle" class="circle"></i>
                                <i data-feather="check-circle" class="check"></i>
                            </span>
                            One special character
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <div class="input-wrapper">
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-input"
                            placeholder="Confirm new password" required autocomplete="new-password">
                        <button type="button" class="password-toggle" id="confirmPasswordToggle">
                            <i data-feather="eye" class="eye-icon"></i>
                            <i data-feather="eye-off" class="eye-off-icon" style="display: none;"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="submit-button" id="submitButton">
                    <div class="submit-button-content">
                        <span class="button-text">Reset Password</span>
                        <div class="spinner"></div>
                    </div>
                </button>
            </form>
        </div>
    </div>
    <script src="/assets/js/config.js"></script>
    <script>
        const API_BASE = window.CineBrainConfig.apiBase;

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        function detectAndApplyTheme() {
            const savedTheme = localStorage.getItem('cinebrain-theme');
            let theme = savedTheme || 'dark';

            if (!savedTheme && window.matchMedia) {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                theme = prefersDark ? 'dark' : 'light';
            }

            applyTheme(theme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-bs-theme', theme);
            document.body.setAttribute('data-theme', theme);
            document.body.setAttribute('data-bs-theme', theme);
        }

        window.addEventListener('storage', (e) => {
            if (e.key === 'cinebrain-theme' && e.newValue) {
                applyTheme(e.newValue);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            detectAndApplyTheme();

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            if (!token) {
                showExpiredToken();
                return;
            }

            verifyToken();

            setupPasswordToggles();
            setupPasswordValidation();
            setupResetForm();
        });

        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/verify-reset-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (!data.valid) {
                    showExpiredToken();
                }
            } catch (error) {
                console.error('CineBrain token verification error:', error);
                showAlert('Failed to verify token. Please try again.', 'error');
            }
        }

        function showExpiredToken() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="expired-token">
                    <div class="expired-icon">‚è∞</div>
                    <h3 class="expired-title">Link Expired</h3>
                    <p class="expired-message">
                        This CineBrain password reset link has expired or is invalid.
                        Please request a new link to reset your password.
                    </p>
                    <a href="/auth/forgot-password.html" class="request-new-link">
                        <i data-feather="refresh-cw"></i>
                        Request New Link
                    </a>
                </div>
            `;
            feather.replace();
        }

        function setupPasswordToggles() {
            const passwordToggle = document.getElementById('passwordToggle');
            const passwordInput = document.getElementById('password');

            if (passwordToggle) {
                passwordToggle.addEventListener('click', () => {
                    togglePasswordVisibility(passwordInput, passwordToggle);
                });
            }

            const confirmPasswordToggle = document.getElementById('confirmPasswordToggle');
            const confirmPasswordInput = document.getElementById('confirmPassword');

            if (confirmPasswordToggle) {
                confirmPasswordToggle.addEventListener('click', () => {
                    togglePasswordVisibility(confirmPasswordInput, confirmPasswordToggle);
                });
            }
        }

        function togglePasswordVisibility(input, button) {
            const eyeIcon = button.querySelector('.eye-icon');
            const eyeOffIcon = button.querySelector('.eye-off-icon');

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.style.display = 'none';
                eyeOffIcon.style.display = 'block';
            } else {
                input.type = 'password';
                eyeIcon.style.display = 'block';
                eyeOffIcon.style.display = 'none';
            }
        }

        function setupPasswordValidation() {
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');

            if (passwordInput) {
                passwordInput.addEventListener('input', () => {
                    checkPasswordRequirements(passwordInput.value);
                    hideAlert();
                });
            }

            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', () => {
                    hideAlert();
                });
            }
        }

        function checkPasswordRequirements(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            document.getElementById('req-length').classList.toggle('met', requirements.length);
            document.getElementById('req-uppercase').classList.toggle('met', requirements.uppercase);
            document.getElementById('req-lowercase').classList.toggle('met', requirements.lowercase);
            document.getElementById('req-number').classList.toggle('met', requirements.number);
            document.getElementById('req-special').classList.toggle('met', requirements.special);

            feather.replace();

            return Object.values(requirements).every(req => req);
        }

        function validateForm(password, confirmPassword) {
            if (!password) {
                showAlert('Password is required', 'error');
                return false;
            }

            if (!checkPasswordRequirements(password)) {
                showAlert('Please meet all password requirements', 'error');
                return false;
            }

            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return false;
            }

            return true;
        }

        function setupResetForm() {
            const resetForm = document.getElementById('resetForm');

            if (resetForm) {
                resetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (!validateForm(password, confirmPassword)) {
                        return;
                    }

                    await resetPassword(password, confirmPassword);
                });
            }
        }

        async function resetPassword(password, confirmPassword) {
            const submitButton = document.getElementById('submitButton');

            try {
                submitButton.classList.add('loading');
                submitButton.disabled = true;
                hideAlert();

                const response = await fetch(`${API_BASE}/auth/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token,
                        password,
                        confirmPassword
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('CineBrain password reset successful! Redirecting to login...', 'success');

                    if (data.token) {
                        localStorage.setItem('cinebrain-token', data.token);
                        localStorage.setItem('cinebrain-user', JSON.stringify(data.user));
                        localStorage.setItem('cinebrain-role', data.user.is_admin ? 'admin' : 'user');

                        setTimeout(() => {
                            window.location.href = '/index.html';
                        }, 1500);
                    } else {
                        setTimeout(() => {
                            window.location.href = '/auth/login.html';
                        }, 2000);
                    }
                } else {
                    showAlert(data.error || 'Failed to reset CineBrain password', 'error');
                    if (data.error && data.error.includes('expired')) {
                        setTimeout(showExpiredToken, 2000);
                    }
                }
            } catch (error) {
                console.error('CineBrain reset password error:', error);
                showAlert('Network error. Please check your connection and try again.', 'error');
            } finally {
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
            }
        }

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById('alertBox');
            if (alertBox) {
                alertBox.textContent = message;
                alertBox.className = `alert alert-${type} show`;

                if (type === 'success') {
                    setTimeout(() => hideAlert(), 5000);
                }
            }
        }

        function hideAlert() {
            const alertBox = document.getElementById('alertBox');
            if (alertBox) {
                alertBox.classList.remove('show');
            }
        }
    </script>
</body>

</html>