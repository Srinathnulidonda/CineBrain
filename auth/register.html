<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Join CineBrain - Create your account for personalized movie, TV show, and anime recommendations">
    <meta name="robots" content="noindex, nofollow">

    <title>Sign Up - CineBrain</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
</head>

<body>
    <!-- Auth Layout -->
    <div class="auth-layout">
        <div class="auth-card fade-in" style="max-width: 500px;">
            <!-- Logo -->
            <div class="text-center mb-4">
                <h1 class="h3 gradient-text fw-bold">Join CineBrain</h1>
                <p class="text-muted small">Discover your next favorite with AI-powered recommendations</p>
            </div>

            <!-- Registration Form -->
            <form id="registerForm" class="needs-validation" novalidate>
                <!-- Personal Information -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="username" class="form-label text-white">Username <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" name="username" required
                            placeholder="Choose a username" autocomplete="username" minlength="3" maxlength="20">
                        <div class="invalid-feedback">Username must be 3-20 characters long.</div>
                        <div class="valid-feedback">Username is available!</div>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label text-white">Email <span
                                class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" required
                            placeholder="your@email.com" autocomplete="email">
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                        <div class="valid-feedback">Email looks good!</div>
                    </div>
                </div>

                <!-- Password Fields -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="password" class="form-label text-white">Password <span
                                class="text-danger">*</span></label>
                        <div class="position-relative">
                            <input type="password" class="form-control" id="password" name="password" required
                                placeholder="Create password" autocomplete="new-password" minlength="6">
                            <button type="button"
                                class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-muted"
                                onclick="togglePasswordVisibility('password')">
                                <i class="fas fa-eye" id="passwordToggleIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">Password must be at least 6 characters long.</div>
                        <div class="form-text text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            Use at least 6 characters with a mix of letters and numbers
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="confirmPassword" class="form-label text-white">Confirm Password <span
                                class="text-danger">*</span></label>
                        <div class="position-relative">
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                required placeholder="Confirm password" autocomplete="new-password">
                            <button type="button"
                                class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-muted"
                                onclick="togglePasswordVisibility('confirmPassword')">
                                <i class="fas fa-eye" id="confirmPasswordToggleIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="mb-4">
                    <h6 class="text-white mb-3">
                        <i class="fas fa-heart me-2 text-primary"></i>
                        Your Preferences (Optional)
                    </h6>

                    <!-- Preferred Languages -->
                    <div class="mb-3">
                        <label class="form-label text-white small">Preferred Languages</label>
                        <div class="row g-2">
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="english" id="langEnglish"
                                        name="languages">
                                    <label class="form-check-label text-white" for="langEnglish">English</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="hindi" id="langHindi"
                                        name="languages">
                                    <label class="form-check-label text-white" for="langHindi">Hindi</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="telugu" id="langTelugu"
                                        name="languages">
                                    <label class="form-check-label text-white" for="langTelugu">Telugu</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="tamil" id="langTamil"
                                        name="languages">
                                    <label class="form-check-label text-white" for="langTamil">Tamil</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="kannada" id="langKannada"
                                        name="languages">
                                    <label class="form-check-label text-white" for="langKannada">Kannada</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="japanese" id="langJapanese"
                                        name="languages">
                                    <label class="form-check-label text-white" for="langJapanese">Japanese</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preferred Genres -->
                    <div class="mb-3">
                        <label class="form-label text-white small">Favorite Genres</label>
                        <div class="row g-2">
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Action" id="genreAction"
                                        name="genres">
                                    <label class="form-check-label text-white" for="genreAction">Action</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Comedy" id="genreComedy"
                                        name="genres">
                                    <label class="form-check-label text-white" for="genreComedy">Comedy</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Drama" id="genreDrama"
                                        name="genres">
                                    <label class="form-check-label text-white" for="genreDrama">Drama</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Horror" id="genreHorror"
                                        name="genres">
                                    <label class="form-check-label text-white" for="genreHorror">Horror</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Romance" id="genreRomance"
                                        name="genres">
                                    <label class="form-check-label text-white" for="genreRomance">Romance</label>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="Sci-Fi" id="genreSciFi"
                                        name="genres">
                                    <label class="form-check-label text-white" for="genreSciFi">Sci-Fi</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms and Privacy -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="agreeTerms" name="agreeTerms" required>
                        <label class="form-check-label text-white" for="agreeTerms">
                            I agree to the <a href="/legal/terms.html" class="text-primary" target="_blank">Terms of
                                Service</a>
                            and <a href="/legal/privacy.html" class="text-primary" target="_blank">Privacy Policy</a>
                            <span class="text-danger">*</span>
                        </label>
                        <div class="invalid-feedback">You must agree to the terms and privacy policy.</div>
                    </div>
                </div>

                <!-- Newsletter Subscription -->
                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="subscribeNewsletter"
                            name="subscribeNewsletter" checked>
                        <label class="form-check-label text-white" for="subscribeNewsletter">
                            <i class="fas fa-envelope me-1"></i>
                            Send me updates about new features and recommendations
                        </label>
                    </div>
                </div>

                <!-- Error Alert -->
                <div id="registerError" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="registerErrorMessage"></span>
                </div>

                <!-- Success Alert -->
                <div id="registerSuccess" class="alert alert-success d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    Account created successfully! Redirecting...
                </div>

                <button type="submit" class="btn btn-primary w-100 mb-3" id="registerButton">
                    <span class="register-text">
                        <i class="fas fa-user-plus me-2"></i>
                        Create Account
                    </span>
                    <span class="register-loading d-none">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Creating account...
                    </span>
                </button>
            </form>

            <!-- Alternative Actions -->
            <div class="text-center">
                <p class="mb-0">
                    Already have an account?
                    <a href="/auth/login.html" class="text-primary text-decoration-none fw-semibold">
                        Sign in here
                    </a>
                </p>
            </div>

            <!-- Back to Home -->
            <div class="text-center mt-4">
                <a href="/" class="text-muted text-decoration-none">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Page-specific JavaScript -->
    <script>
        (function () {
            let isSubmitting = false;
            let usernameCheckTimeout;

            // Initialize registration page
            function initRegisterPage() {
                setupFormValidation();
                setupRealTimeValidation();
                setupFormSubmission();
                checkExistingAuth();
            }

            // Setup form validation
            function setupFormValidation() {
                const form = document.getElementById('registerForm');
                const inputs = form.querySelectorAll('input[required]');

                inputs.forEach(input => {
                    input.addEventListener('blur', validateField);
                    input.addEventListener('input', clearFieldError);
                });

                // Password confirmation validation
                const password = document.getElementById('password');
                const confirmPassword = document.getElementById('confirmPassword');

                confirmPassword.addEventListener('input', validatePasswordMatch);
                password.addEventListener('input', validatePasswordMatch);

                form.addEventListener('submit', handleFormSubmit);
            }

            // Setup real-time validation
            function setupRealTimeValidation() {
                const username = document.getElementById('username');
                const email = document.getElementById('email');

                username.addEventListener('input', function () {
                    clearTimeout(usernameCheckTimeout);
                    const value = this.value.trim();

                    if (value.length >= 3) {
                        usernameCheckTimeout = setTimeout(() => {
                            checkUsernameAvailability(value);
                        }, 500);
                    }
                });

                email.addEventListener('blur', validateEmailFormat);
            }

            // Check username availability
            async function checkUsernameAvailability(username) {
                const usernameField = document.getElementById('username');

                try {
                    // Simple client-side validation first
                    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                        usernameField.classList.add('is-invalid');
                        usernameField.classList.remove('is-valid');
                        return;
                    }

                    // Mock check since we don't have a dedicated endpoint
                    // In production, you'd call an actual availability check endpoint
                    const response = await fetch(`${API_ENDPOINTS.BASE_URL}/users/check-username`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username })
                    });

                    if (response.ok) {
                        usernameField.classList.remove('is-invalid');
                        usernameField.classList.add('is-valid');
                    } else {
                        usernameField.classList.add('is-invalid');
                        usernameField.classList.remove('is-valid');
                    }
                } catch (error) {
                    // If check fails, just mark as valid to not block registration
                    usernameField.classList.remove('is-invalid');
                    usernameField.classList.add('is-valid');
                }
            }

            // Validate email format
            function validateEmailFormat() {
                const emailField = document.getElementById('email');
                const emailValue = emailField.value.trim();

                if (emailValue && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
                    emailField.classList.remove('is-invalid');
                    emailField.classList.add('is-valid');
                } else if (emailValue) {
                    emailField.classList.add('is-invalid');
                    emailField.classList.remove('is-valid');
                }
            }

            // Validate password match
            function validatePasswordMatch() {
                const password = document.getElementById('password');
                const confirmPassword = document.getElementById('confirmPassword');

                if (confirmPassword.value && password.value !== confirmPassword.value) {
                    confirmPassword.classList.add('is-invalid');
                    confirmPassword.classList.remove('is-valid');
                } else if (confirmPassword.value) {
                    confirmPassword.classList.remove('is-invalid');
                    confirmPassword.classList.add('is-valid');
                }
            }

            // Validate individual field
            function validateField(event) {
                const field = event.target;
                const isValid = field.checkValidity();

                if (field.id === 'confirmPassword') {
                    const password = document.getElementById('password');
                    const passwordsMatch = password.value === field.value;

                    if (isValid && passwordsMatch) {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                    } else {
                        field.classList.remove('is-valid');
                        field.classList.add('is-invalid');
                    }
                } else if (isValid) {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                } else {
                    field.classList.remove('is-valid');
                    field.classList.add('is-invalid');
                }
            }

            // Clear field error state
            function clearFieldError(event) {
                const field = event.target;
                if (field.classList.contains('is-invalid')) {
                    field.classList.remove('is-invalid');
                }
                hideError();
            }

            // Setup form submission
            function setupFormSubmission() {
                const form = document.getElementById('registerForm');
                form.addEventListener('submit', handleFormSubmit);
            }

            // Handle form submission
            async function handleFormSubmit(event) {
                event.preventDefault();

                if (isSubmitting) return;

                const form = event.target;
                const formData = new FormData(form);

                // Validate form
                if (!form.checkValidity()) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    showError('Please fill in all required fields correctly.');
                    return;
                }

                // Check password match
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');

                if (password !== confirmPassword) {
                    showError('Passwords do not match.');
                    return;
                }

                // Collect preferences
                const languages = [];
                const genres = [];

                formData.getAll('languages').forEach(lang => languages.push(lang));
                formData.getAll('genres').forEach(genre => genres.push(genre));

                // Prepare registration data
                const registrationData = {
                    username: formData.get('username').trim(),
                    email: formData.get('email').trim(),
                    password: password,
                    preferred_languages: languages,
                    preferred_genres: genres
                };

                try {
                    await performRegistration(registrationData);
                } catch (error) {
                    console.error('Registration submission error:', error);
                    showError('An unexpected error occurred. Please try again.');
                }
            }

            // Perform registration
            async function performRegistration(registrationData) {
                setSubmittingState(true);
                hideError();

                try {
                    const result = await window.auth.register(registrationData);

                    if (result.success) {
                        showSuccess();

                        // Small delay for user feedback
                        setTimeout(() => {
                            // Redirect will be handled by auth system
                            const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/';
                            window.location.href = redirectUrl;
                        }, 1500);
                    } else {
                        throw new Error(result.error || 'Registration failed');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    setSubmittingState(false);

                    let errorMessage = 'Registration failed. Please try again.';

                    if (error.message.includes('Username already exists')) {
                        errorMessage = 'This username is already taken. Please choose another.';
                    } else if (error.message.includes('Email already exists')) {
                        errorMessage = 'This email is already registered. Please use a different email or sign in.';
                    } else if (error.message.includes('Invalid email')) {
                        errorMessage = 'Please enter a valid email address.';
                    } else if (error.message.includes('Network')) {
                        errorMessage = 'Network error. Please check your connection and try again.';
                    }

                    showError(errorMessage);

                    // Shake animation for error feedback
                    const authCard = document.querySelector('.auth-card');
                    authCard.classList.add('shake');
                    setTimeout(() => {
                        authCard.classList.remove('shake');
                    }, 500);
                }
            }

            // Set submitting state
            function setSubmittingState(submitting) {
                isSubmitting = submitting;
                const button = document.getElementById('registerButton');
                const registerText = button.querySelector('.register-text');
                const registerLoading = button.querySelector('.register-loading');

                if (submitting) {
                    button.disabled = true;
                    registerText.classList.add('d-none');
                    registerLoading.classList.remove('d-none');
                } else {
                    button.disabled = false;
                    registerText.classList.remove('d-none');
                    registerLoading.classList.add('d-none');
                }
            }

            // Show error message
            function showError(message) {
                const errorAlert = document.getElementById('registerError');
                const errorMessage = document.getElementById('registerErrorMessage');
                const successAlert = document.getElementById('registerSuccess');

                successAlert.classList.add('d-none');
                errorMessage.textContent = message;
                errorAlert.classList.remove('d-none');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    hideError();
                }, 5000);
            }

            // Hide error message
            function hideError() {
                const errorAlert = document.getElementById('registerError');
                errorAlert.classList.add('d-none');
            }

            // Show success message
            function showSuccess() {
                const errorAlert = document.getElementById('registerError');
                const successAlert = document.getElementById('registerSuccess');

                errorAlert.classList.add('d-none');
                successAlert.classList.remove('d-none');
            }

            // Check if user is already authenticated
            function checkExistingAuth() {
                if (window.auth && window.auth.isAuthenticated()) {
                    // User is already logged in, redirect
                    const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/';
                    window.location.href = redirectUrl;
                    return;
                }
            }

            // Toggle password visibility
            window.togglePasswordVisibility = function (inputId) {
                const input = document.getElementById(inputId);
                const icon = document.getElementById(inputId + 'ToggleIcon');

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            };

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initRegisterPage);
            } else {
                initRegisterPage();
            }

            // Handle Enter key in form
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && event.target.form === document.getElementById('registerForm')) {
                    event.preventDefault();
                    document.getElementById('registerForm').dispatchEvent(new Event('submit'));
                }
            });
        })();
    </script>
</body>

</html>