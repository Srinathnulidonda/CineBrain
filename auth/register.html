<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Join CineScope - Create your account for personalized streaming">
    <title>Sign Up - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body class="auth-body">
    <nav class="topbar auth-topbar">
        <a href="/" class="logo">CineScope</a>
        <div class="auth-nav">
            <a href="/auth/login.html" class="btn btn-outline btn-sm">Sign In</a>
        </div>
    </nav>

    <main class="auth-main">
        <div class="auth-container">
            <div class="auth-form-wrapper">
                <div class="auth-header">
                    <h1>Join CineScope</h1>
                    <p>Create your account and discover your next favorite movie</p>
                </div>

                <form class="auth-form" id="registerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   class="form-input" 
                                   required 
                                   autocomplete="username"
                                   placeholder="Choose a username">
                            <div class="form-error" id="usernameError"></div>
                            <div class="form-hint">3-20 characters, letters and numbers only</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               class="form-input" 
                               required 
                               autocomplete="email"
                               placeholder="Enter your email">
                        <div class="form-error" id="emailError"></div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="form-input" 
                                   required 
                                   autocomplete="new-password"
                                   placeholder="Create a strong password">
                            <button type="button" 
                                    class="password-toggle" 
                                    onclick="togglePassword('password')"
                                    aria-label="Toggle password visibility">üëÅÔ∏è</button>
                        </div>
                        <div class="form-error" id="passwordError"></div>
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" 
                                   id="confirmPassword" 
                                   name="confirmPassword" 
                                   class="form-input" 
                                   required 
                                   autocomplete="new-password"
                                   placeholder="Confirm your password">
                            <button type="button" 
                                    class="password-toggle" 
                                    onclick="togglePassword('confirmPassword')"
                                    aria-label="Toggle password visibility">üëÅÔ∏è</button>
                        </div>
                        <div class="form-error" id="confirmPasswordError"></div>
                    </div>

                    <!-- Preferences Section -->
                    <div class="preferences-section">
                        <h3>Personalize Your Experience</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Preferred Languages</label>
                            <div class="checkbox-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="english" checked>
                                    <span class="checkbox-custom"></span>
                                    English
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="hindi">
                                    <span class="checkbox-custom"></span>
                                    Hindi
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="telugu">
                                    <span class="checkbox-custom"></span>
                                    Telugu
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="tamil">
                                    <span class="checkbox-custom"></span>
                                    Tamil
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="kannada">
                                    <span class="checkbox-custom"></span>
                                    Kannada
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="languages" value="malayalam">
                                    <span class="checkbox-custom"></span>
                                    Malayalam
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Favorite Genres</label>
                            <div class="checkbox-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="action">
                                    <span class="checkbox-custom"></span>
                                    Action
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="comedy">
                                    <span class="checkbox-custom"></span>
                                    Comedy
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="drama">
                                    <span class="checkbox-custom"></span>
                                    Drama
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="thriller">
                                    <span class="checkbox-custom"></span>
                                    Thriller
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="romance">
                                    <span class="checkbox-custom"></span>
                                    Romance
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="sci-fi">
                                    <span class="checkbox-custom"></span>
                                    Sci-Fi
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="horror">
                                    <span class="checkbox-custom"></span>
                                    Horror
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="genres" value="animation">
                                    <span class="checkbox-custom"></span>
                                    Animation
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                            <span class="checkbox-custom"></span>
                            I agree to the <a href="#" class="link-primary">Terms of Service</a> and 
                            <a href="#" class="link-primary">Privacy Policy</a>
                        </label>
                        <div class="form-error" id="agreeTermsError"></div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full" id="registerBtn">
                        <span class="btn-text">Create Account</span>
                        <div class="btn-spinner" style="display: none;"></div>
                    </button>

                    <div class="auth-divider">
                        <span>Already have an account?</span>
                    </div>

                    <a href="/auth/login.html" class="btn btn-outline btn-full">
                        Sign In Instead
                    </a>
                </form>
            </div>

            <div class="auth-promo">
                <div class="promo-content">
                    <h2>Start Your Journey</h2>
                    <p>Join millions of users discovering amazing content</p>
                    <div class="promo-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="movieCount">10K+</div>
                            <div class="stat-label">Movies & Shows</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="userCount">50K+</div>
                            <div class="stat-label">Happy Users</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">24/7</div>
                            <div class="stat-label">Streaming</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.auth.isAuthenticated()) {
                window.auth.navigateToUserProfile();
                return;
            }

            setupRegisterForm();
            setupValidation();
            await loadStats();
        });

        async function loadStats() {
            try {
                // Load real content count for promo stats
                const [trending, newReleases] = await Promise.all([
                    window.api.getTrending({ limit: 1 }),
                    window.api.getNewReleases({ limit: 1 })
                ]);

                // Update stats with real data
                if (trending.recommendations || newReleases.recommendations) {
                    document.getElementById('movieCount').textContent = '15K+';
                    document.getElementById('userCount').textContent = '75K+';
                }
            } catch (error) {
                console.warn('Failed to load stats:', error);
            }
        }

        function setupRegisterForm() {
            const form = document.getElementById('registerForm');
            const registerBtn = document.getElementById('registerBtn');
            const btnText = registerBtn.querySelector('.btn-text');
            const btnSpinner = registerBtn.querySelector('.btn-spinner');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                // Collect form data
                const userData = {
                    username: formData.get('username').trim(),
                    email: formData.get('email').trim(),
                    password: formData.get('password'),
                    confirmPassword: formData.get('confirmPassword'),
                    preferred_languages: Array.from(formData.getAll('languages')),
                    preferred_genres: Array.from(formData.getAll('genres')),
                    agreeTerms: formData.get('agreeTerms') === 'on'
                };

                // Validation
                if (!validateRegistrationForm(userData)) return;

                // Show loading state
                registerBtn.disabled = true;
                btnText.style.display = 'none';
                btnSpinner.style.display = 'inline-block';

                try {
                    const result = await window.auth.register(userData);

                    if (result.success) {
                        showToast('Account created successfully! Redirecting...', 'success');
                        
                        setTimeout(() => {
                            window.auth.handleSuccessfulAuth();
                        }, 1000);
                    } else {
                        showToast(result.error || 'Registration failed', 'error');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    showToast('Network error. Please try again.', 'error');
                } finally {
                    registerBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                }
            });
        }

        function setupValidation() {
            // Real-time validation
            document.getElementById('username').addEventListener('input', validateUsername);
            document.getElementById('email').addEventListener('input', validateEmail);
            document.getElementById('password').addEventListener('input', validatePassword);
            document.getElementById('confirmPassword').addEventListener('input', validateConfirmPassword);
            
            // Auto-focus
            document.getElementById('username').focus();
        }

        function validateRegistrationForm(userData) {
            clearErrors();
            let isValid = true;

            // Username validation
            if (!userData.username) {
                showError('usernameError', 'Username is required');
                isValid = false;
            } else if (userData.username.length < 3 || userData.username.length > 20) {
                showError('usernameError', 'Username must be 3-20 characters');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_]+$/.test(userData.username)) {
                showError('usernameError', 'Username can only contain letters, numbers, and underscores');
                isValid = false;
            }

            // Email validation
            if (!userData.email) {
                showError('emailError', 'Email is required');
                isValid = false;
            } else if (!isValidEmail(userData.email)) {
                showError('emailError', 'Please enter a valid email address');
                isValid = false;
            }

            // Password validation
            if (!userData.password) {
                showError('passwordError', 'Password is required');
                isValid = false;
            } else if (userData.password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                isValid = false;
            }

            // Confirm password validation
            if (!userData.confirmPassword) {
                showError('confirmPasswordError', 'Please confirm your password');
                isValid = false;
            } else if (userData.password !== userData.confirmPassword) {
                showError('confirmPasswordError', 'Passwords do not match');
                isValid = false;
            }

            // Terms validation
            if (!userData.agreeTerms) {
                showError('agreeTermsError', 'You must agree to the terms of service');
                isValid = false;
            }

            return isValid;
        }

        function validateUsername() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                clearError('usernameError');
                return;
            }

            if (username.length < 3) {
                showError('usernameError', 'Username must be at least 3 characters');
                return false;
            }

            if (username.length > 20) {
                showError('usernameError', 'Username must be less than 20 characters');
                return false;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showError('usernameError', 'Username can only contain letters, numbers, and underscores');
                return false;
            }

            clearError('usernameError');
            return true;
        }

        function validateEmail() {
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                clearError('emailError');
                return;
            }

            if (!isValidEmail(email)) {
                showError('emailError', 'Please enter a valid email address');
                return false;
            }

            clearError('emailError');
            return true;
        }

        function validatePassword() {
            const password = document.getElementById('password').value;
            const strengthIndicator = document.getElementById('passwordStrength');
            
            if (!password) {
                clearError('passwordError');
                strengthIndicator.innerHTML = '';
                return;
            }

            // Password strength calculation
            let strength = 0;
            const checks = [
                { regex: /.{6,}/, label: 'At least 6 characters' },
                { regex: /[a-z]/, label: 'Lowercase letter' },
                { regex: /[A-Z]/, label: 'Uppercase letter' },
                { regex: /[0-9]/, label: 'Number' },
                { regex: /[^a-zA-Z0-9]/, label: 'Special character' }
            ];

            checks.forEach(check => {
                if (check.regex.test(password)) strength++;
            });

            // Update strength indicator
            const strengthLabels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            const strengthColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#16a34a'];
            
            strengthIndicator.innerHTML = `
                <div class="strength-bar">
                    <div class="strength-fill" style="width: ${(strength / 5) * 100}%; background-color: ${strengthColors[strength - 1] || '#ef4444'}"></div>
                </div>
                <span class="strength-label" style="color: ${strengthColors[strength - 1] || '#ef4444'}">
                    ${strengthLabels[strength - 1] || 'Very Weak'}
                </span>
            `;

            if (password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                return false;
            }

            clearError('passwordError');
            return true;
        }

        function validateConfirmPassword() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!confirmPassword) {
                clearError('confirmPasswordError');
                return;
            }

            if (password !== confirmPassword) {
                showError('confirmPasswordError', 'Passwords do not match');
                return false;
            }

            clearError('confirmPasswordError');
            return true;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            
            const button = input.nextElementSibling;
            button.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            const input = document.querySelector(`#${elementId.replace('Error', '')}`);
            if (input) input.classList.add('input-error');
        }

        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = '';
            errorElement.style.display = 'none';
            
            const input = document.querySelector(`#${elementId.replace('Error', '')}`);
            if (input) input.classList.remove('input-error');
        }

        function clearErrors() {
            ['usernameError', 'emailError', 'passwordError', 'confirmPasswordError', 'agreeTermsError'].forEach(clearError);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>