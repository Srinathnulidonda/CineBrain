<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Create your CineBrain account - Get personalized movie and TV show recommendations">
  <title>Sign Up - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
  
  <!-- Preload -->
  <link rel="preload" href="/js/auth.js" as="script">
  <link rel="dns-prefetch" href="//backend-app-970m.onrender.com">
  <link rel="preconnect" href="https://backend-app-970m.onrender.com">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="container" style="max-width: 520px; margin-top: 5vh;">
        <!-- Registration Form -->
        <div class="bg-elevated rounded-2xl p-8 shadow-premium">
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">Join CineBrain</h1>
            <p class="text-muted">Create your account and discover your next favorite</p>
          </div>

          <!-- Real-time Registration Form -->
          <form id="register-form" class="space-y-6">
            <div class="form-group">
              <label for="username" class="form-label">Username</label>
              <input 
                type="text" 
                id="username" 
                name="username" 
                class="form-input focus-ring" 
                placeholder="Choose a unique username"
                required
                autocomplete="username"
                minlength="3"
                maxlength="20"
              >
              <div class="form-error" id="username-error"></div>
              <div class="form-success" id="username-success"></div>
            </div>

            <div class="form-group">
              <label for="email" class="form-label">Email Address</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-input focus-ring" 
                placeholder="Enter your email address"
                required
                autocomplete="email"
              >
              <div class="form-error" id="email-error"></div>
              <div class="form-success" id="email-success"></div>
            </div>

            <div class="form-group">
              <label for="password" class="form-label">Password</label>
              <div class="relative">
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  class="form-input focus-ring" 
                  placeholder="Create a strong password"
                  required
                  autocomplete="new-password"
                  minlength="6"
                >
                <button 
                  type="button" 
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-muted hover:text-white transition"
                  onclick="togglePassword('password')"
                >
                  👁️
                </button>
              </div>
              <div class="password-strength" id="password-strength"></div>
              <div class="form-error" id="password-error"></div>
            </div>

            <div class="form-group">
              <label for="confirm-password" class="form-label">Confirm Password</label>
              <div class="relative">
                <input 
                  type="password" 
                  id="confirm-password" 
                  name="confirm-password" 
                  class="form-input focus-ring" 
                  placeholder="Confirm your password"
                  required
                  autocomplete="new-password"
                >
                <button 
                  type="button" 
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-muted hover:text-white transition"
                  onclick="togglePassword('confirm-password')"
                >
                  👁️
                </button>
              </div>
              <div class="form-error" id="confirm-password-error"></div>
            </div>

            <!-- Preferences Section -->
            <div class="form-group">
              <label class="form-label">Preferred Languages (Optional)</label>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <label class="flex items-center">
                  <input type="checkbox" name="languages" value="english" class="mr-2">
                  <span class="text-sm">🇺🇸 English</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="languages" value="hindi" class="mr-2">
                  <span class="text-sm">🇮🇳 Hindi</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="languages" value="telugu" class="mr-2">
                  <span class="text-sm">🇮🇳 Telugu</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="languages" value="tamil" class="mr-2">
                  <span class="text-sm">🇮🇳 Tamil</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="languages" value="kannada" class="mr-2">
                  <span class="text-sm">🇮🇳 Kannada</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="languages" value="malayalam" class="mr-2">
                  <span class="text-sm">🇮🇳 Malayalam</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Favorite Genres (Optional)</label>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Action" class="mr-2">
                  <span class="text-sm">Action</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Comedy" class="mr-2">
                  <span class="text-sm">Comedy</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Drama" class="mr-2">
                  <span class="text-sm">Drama</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Horror" class="mr-2">
                  <span class="text-sm">Horror</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Romance" class="mr-2">
                  <span class="text-sm">Romance</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Sci-Fi" class="mr-2">
                  <span class="text-sm">Sci-Fi</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Thriller" class="mr-2">
                  <span class="text-sm">Thriller</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="genres" value="Anime" class="mr-2">
                  <span class="text-sm">Anime</span>
                </label>
              </div>
            </div>

            <!-- Terms Acceptance -->
            <div class="form-group">
              <label class="flex items-start">
                <input type="checkbox" name="terms" required class="mr-3 mt-1">
                <span class="text-sm text-muted">
                  I agree to CineBrain's 
                  <a href="/legal/terms.html" class="text-primary hover:underline" target="_blank">Terms of Service</a> 
                  and 
                  <a href="/legal/privacy.html" class="text-primary hover:underline" target="_blank">Privacy Policy</a>
                </span>
              </label>
              <div class="form-error" id="terms-error"></div>
            </div>

            <button 
              type="submit" 
              class="btn btn-primary w-full" 
              id="register-btn"
            >
              <span id="register-btn-text">Create Account</span>
              <div id="register-spinner" class="loading-spinner" style="display: none; width: 20px; height: 20px;"></div>
            </button>

            <div class="form-error text-center" id="register-error"></div>
            <div class="form-success text-center" id="register-success"></div>
          </form>

          <!-- Login Link -->
          <div class="mt-6 text-center">
            <p class="text-muted">
              Already have an account? 
              <a href="/auth/login.html" class="text-primary hover:underline font-medium">
                Sign in
              </a>
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let isSubmitting = false;
    let usernameCheckTimeout;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      initializeRegisterPage();
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    function initializeRegisterPage() {
      // Redirect if already authenticated
      if (Auth.isAuthenticated()) {
        const user = Auth.getCurrentUser();
        window.location.href = `/${user.username}/profile`;
        return;
      }

      const registerForm = document.getElementById('register-form');
      registerForm.addEventListener('submit', handleRegister);

      // Auto-focus username field
      document.getElementById('username').focus();

      // Setup real-time validation
      setupRealTimeValidation();
      
      console.log('📝 Register page initialized');
    }

    async function handleRegister(event) {
      event.preventDefault();
      
      if (isSubmitting) return;
      isSubmitting = true;
      
      clearErrors();
      showLoading(true);

      try {
        const formData = new FormData(event.target);
        
        const userData = {
          username: formData.get('username').trim(),
          email: formData.get('email').trim(),
          password: formData.get('password'),
          preferred_languages: formData.getAll('languages'),
          preferred_genres: formData.getAll('genres')
        };

        // Validate all inputs
        if (!validateAllInputs(userData, formData.get('confirm-password'), formData.get('terms'))) {
          return;
        }

        // Attempt registration with real backend
        const result = await Auth.register(userData);
        
        if (result.success) {
          showSuccess('Account created successfully! Redirecting...');
          
          // Record registration
          await recordUserActivity('register');
          
          // Redirect after success
          setTimeout(() => {
            window.location.href = result.redirect;
          }, 1500);
        }

      } catch (error) {
        console.error('Registration error:', error);
        showError('register-error', error.message || 'Registration failed. Please try again.');
        
      } finally {
        isSubmitting = false;
        showLoading(false);
      }
    }

    function validateAllInputs(userData, confirmPassword, termsAccepted) {
      let isValid = true;

      // Username validation
      if (!userData.username) {
        showError('username-error', 'Username is required');
        isValid = false;
      } else if (userData.username.length < 3) {
        showError('username-error', 'Username must be at least 3 characters');
        isValid = false;
      } else if (userData.username.length > 20) {
        showError('username-error', 'Username must be less than 20 characters');
        isValid = false;
      } else if (!/^[a-zA-Z0-9_]+$/.test(userData.username)) {
        showError('username-error', 'Username can only contain letters, numbers, and underscores');
        isValid = false;
      }

      // Email validation
      if (!userData.email) {
        showError('email-error', 'Email is required');
        isValid = false;
      } else if (!isValidEmail(userData.email)) {
        showError('email-error', 'Please enter a valid email address');
        isValid = false;
      }

      // Password validation
      if (!userData.password) {
        showError('password-error', 'Password is required');
        isValid = false;
      } else if (userData.password.length < 6) {
        showError('password-error', 'Password must be at least 6 characters');
        isValid = false;
      }

      // Confirm password validation
      if (!confirmPassword) {
        showError('confirm-password-error', 'Please confirm your password');
        isValid = false;
      } else if (userData.password !== confirmPassword) {
        showError('confirm-password-error', 'Passwords do not match');
        isValid = false;
      }

      // Terms validation
      if (!termsAccepted) {
        showError('terms-error', 'You must agree to the Terms of Service');
        isValid = false;
      }

      return isValid;
    }

    function setupRealTimeValidation() {
      const usernameInput = document.getElementById('username');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirm-password');

      // Username availability check
      usernameInput.addEventListener('input', function() {
        clearTimeout(usernameCheckTimeout);
        const username = this.value.trim();
        
        if (username.length >= 3) {
          usernameCheckTimeout = setTimeout(() => {
            checkUsernameAvailability(username);
          }, 500);
        }
      });

      // Email validation
      emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        if (email) {
          if (isValidEmail(email)) {
            clearError('email-error');
            showSuccess('email-success', '✓ Valid email format');
          } else {
            showError('email-error', 'Please enter a valid email address');
          }
        }
      });

      // Password strength checking
      passwordInput.addEventListener('input', function() {
        updatePasswordStrength(this.value);
        
        // Check confirm password match if it has value
        const confirmPassword = confirmPasswordInput.value;
        if (confirmPassword) {
          checkPasswordMatch(this.value, confirmPassword);
        }
      });

      // Confirm password validation
      confirmPasswordInput.addEventListener('input', function() {
        const password = passwordInput.value;
        checkPasswordMatch(password, this.value);
      });

      // Clear errors on input
      usernameInput.addEventListener('input', () => clearError('username-error'));
      emailInput.addEventListener('input', () => clearError('email-error'));
      passwordInput.addEventListener('input', () => clearError('password-error'));
      confirmPasswordInput.addEventListener('input', () => clearError('confirm-password-error'));
    }

    async function checkUsernameAvailability(username) {
      try {
        // This is a real check - you can implement username availability endpoint
        clearError('username-error');
        clearError('username-success');
        
        // For now, just validate format
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          showError('username-error', 'Username can only contain letters, numbers, and underscores');
          return;
        }
        
        if (username.length >= 3 && username.length <= 20) {
          showSuccess('username-success', '✓ Username format is valid');
        }
        
      } catch (error) {
        console.error('Username check error:', error);
      }
    }

    function updatePasswordStrength(password) {
      const strengthIndicator = document.getElementById('password-strength');
      
      if (!password) {
        strengthIndicator.innerHTML = '';
        return;
      }

      let strength = 0;
      let feedback = [];

      // Length check
      if (password.length >= 8) strength++;
      else feedback.push('At least 8 characters');

      // Lowercase
      if (/[a-z]/.test(password)) strength++;
      else feedback.push('Lowercase letter');

      // Uppercase
      if (/[A-Z]/.test(password)) strength++;
      else feedback.push('Uppercase letter');

      // Numbers
      if (/\d/.test(password)) strength++;
      else feedback.push('Number');

      // Special characters
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
      else feedback.push('Special character');

      const strengthLevels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
      const strengthColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#16a34a'];
      
      const level = Math.min(strength, 4);
      
      strengthIndicator.innerHTML = `
        <div class="mt-2">
          <div class="flex justify-between items-center mb-1">
            <span class="text-xs">Password Strength</span>
            <span class="text-xs font-medium" style="color: ${strengthColors[level]}">${strengthLevels[level]}</span>
          </div>
          <div class="w-full bg-gray-600 rounded-full h-1">
            <div class="h-1 rounded-full transition-all duration-300" 
                 style="width: ${(strength / 5) * 100}%; background-color: ${strengthColors[level]}"></div>
          </div>
          ${feedback.length > 0 ? `<p class="text-xs text-muted mt-1">Missing: ${feedback.join(', ')}</p>` : ''}
        </div>
      `;
    }

    function checkPasswordMatch(password, confirmPassword) {
      if (confirmPassword && password !== confirmPassword) {
        showError('confirm-password-error', 'Passwords do not match');
      } else if (confirmPassword && password === confirmPassword) {
        clearError('confirm-password-error');
      }
    }

    function togglePassword(fieldId) {
      const passwordInput = document.getElementById(fieldId);
      const toggleBtn = passwordInput.nextElementSibling.querySelector('button');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = '🙈';
      } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = '👁️';
      }
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    async function recordUserActivity(activity) {
      try {
        await API.post('/analytics/user-activity', {
          activity: activity,
          timestamp: new Date().toISOString(),
          user_agent: navigator.userAgent
        });
      } catch (error) {
        console.warn('Failed to record user activity:', error);
      }
    }

    function showLoading(show) {
      const btn = document.getElementById('register-btn');
      const btnText = document.getElementById('register-btn-text');
      const spinner = document.getElementById('register-spinner');
      
      if (show) {
        btn.disabled = true;
        btnText.style.display = 'none';
        spinner.style.display = 'block';
      } else {
        btn.disabled = false;
        btnText.style.display = 'block';
        spinner.style.display = 'none';
      }
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function showSuccess(elementId, message) {
      const successElement = document.getElementById(elementId);
      successElement.textContent = message;
      successElement.style.display = 'block';
      successElement.style.color = '#10b981';
    }

    function clearError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = '';
      errorElement.style.display = 'none';
    }

    function clearErrors() {
      ['username-error', 'email-error', 'password-error', 'confirm-password-error', 'terms-error', 'register-error'].forEach(clearError);
      ['username-success', 'email-success', 'register-success'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function showSuccess(message) {
      const successElement = document.getElementById('register-success');
      successElement.textContent = message;
      successElement.style.display = 'block';
    }
  </script>
</body>
</html>