<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Login to CineBrain - Access your personalized movie and TV show recommendations">
  <title>Login - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
  
  <!-- Preload -->
  <link rel="preload" href="/js/auth.js" as="script">
  <link rel="dns-prefetch" href="//backend-app-970m.onrender.com">
  <link rel="preconnect" href="https://backend-app-970m.onrender.com">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="container" style="max-width: 480px; margin-top: 10vh;">
        <!-- Login Form -->
        <div class="bg-elevated rounded-2xl p-8 shadow-premium">
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">Welcome Back</h1>
            <p class="text-muted">Sign in to access your personalized recommendations</p>
          </div>

          <!-- Real-time Login Form -->
          <form id="login-form" class="space-y-6">
            <div class="form-group">
              <label for="username" class="form-label">Username</label>
              <input 
                type="text" 
                id="username" 
                name="username" 
                class="form-input focus-ring" 
                placeholder="Enter your username"
                required
                autocomplete="username"
              >
              <div class="form-error" id="username-error"></div>
            </div>

            <div class="form-group">
              <label for="password" class="form-label">Password</label>
              <div class="relative">
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  class="form-input focus-ring" 
                  placeholder="Enter your password"
                  required
                  autocomplete="current-password"
                >
                <button 
                  type="button" 
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-muted hover:text-white transition"
                  onclick="togglePassword()"
                  id="password-toggle"
                >
                  üëÅÔ∏è
                </button>
              </div>
              <div class="form-error" id="password-error"></div>
            </div>

            <div class="flex items-center justify-between">
              <label class="flex items-center">
                <input type="checkbox" name="remember" class="mr-2">
                <span class="text-sm text-muted">Remember me</span>
              </label>
              <a href="/auth/forgot-password.html" class="text-sm text-primary hover:underline">
                Forgot password?
              </a>
            </div>

            <button 
              type="submit" 
              class="btn btn-primary w-full" 
              id="login-btn"
            >
              <span id="login-btn-text">Sign In</span>
              <div id="login-spinner" class="loading-spinner" style="display: none; width: 20px; height: 20px;"></div>
            </button>

            <div class="form-error text-center" id="login-error"></div>
            <div class="form-success text-center" id="login-success"></div>
          </form>

          <!-- Social Login Options -->
          <div class="mt-8">
            <div class="relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-muted opacity-30"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-elevated text-muted">Or continue with</span>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-2 gap-3">
              <button class="btn btn-outline" onclick="socialLogin('google')">
                üìß Google
              </button>
              <button class="btn btn-outline" onclick="socialLogin('github')">
                üêô GitHub
              </button>
            </div>
          </div>

          <!-- Register Link -->
          <div class="mt-6 text-center">
            <p class="text-muted">
              Don't have an account? 
              <a href="/auth/register.html" class="text-primary hover:underline font-medium">
                Sign up now
              </a>
            </p>
          </div>

          <!-- Demo Account -->
          <div class="mt-6 p-4 bg-surface rounded-lg border border-primary/20">
            <h3 class="text-sm font-medium text-primary mb-2">Try Demo Account</h3>
            <p class="text-xs text-muted mb-3">Test all features with our demo account</p>
            <button 
              class="btn btn-ghost btn-sm w-full" 
              onclick="loginDemo()"
              id="demo-btn"
            >
              Login as Demo User
            </button>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="mt-8 text-center">
          <p class="text-xs text-muted">
            By signing in, you agree to our 
            <a href="/legal/terms.html" class="text-primary">Terms of Service</a> and 
            <a href="/legal/privacy.html" class="text-primary">Privacy Policy</a>
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let isSubmitting = false;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      initializeLoginPage();
    });

    // Load reusable components
    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    function initializeLoginPage() {
      // Redirect if already authenticated
      if (Auth.isAuthenticated()) {
        const user = Auth.getCurrentUser();
        window.location.href = `/${user.username}/profile`;
        return;
      }

      const loginForm = document.getElementById('login-form');
      loginForm.addEventListener('submit', handleLogin);

      // Auto-focus username field
      document.getElementById('username').focus();

      // Handle enter key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !isSubmitting) {
          e.preventDefault();
          handleLogin(e);
        }
      });

      // Real-time validation
      setupRealTimeValidation();
      
      console.log('üîê Login page initialized');
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      if (isSubmitting) return;
      isSubmitting = true;
      
      clearErrors();
      showLoading(true);

      try {
        const formData = new FormData(event.target);
        const username = formData.get('username').trim();
        const password = formData.get('password');

        // Validate inputs
        if (!validateInputs(username, password)) {
          return;
        }

        // Attempt login with real backend
        const result = await Auth.login(username, password);
        
        if (result.success) {
          showSuccess('Login successful! Redirecting...');
          
          // Record login interaction
          if (result.user) {
            await recordUserActivity('login');
          }
          
          // Redirect after success
          setTimeout(() => {
            const redirectPath = sessionStorage.getItem('auth_redirect') || result.redirect;
            window.location.href = redirectPath;
          }, 1000);
        }

      } catch (error) {
        console.error('Login error:', error);
        showError('login-error', error.message || 'Login failed. Please try again.');
        
        // Focus username for retry
        document.getElementById('username').focus();
        
      } finally {
        isSubmitting = false;
        showLoading(false);
      }
    }

    function validateInputs(username, password) {
      let isValid = true;

      if (!username) {
        showError('username-error', 'Username is required');
        isValid = false;
      } else if (username.length < 3) {
        showError('username-error', 'Username must be at least 3 characters');
        isValid = false;
      }

      if (!password) {
        showError('password-error', 'Password is required');
        isValid = false;
      } else if (password.length < 6) {
        showError('password-error', 'Password must be at least 6 characters');
        isValid = false;
      }

      return isValid;
    }

    function setupRealTimeValidation() {
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');

      usernameInput.addEventListener('blur', function() {
        if (this.value.trim()) {
          clearError('username-error');
          if (this.value.trim().length < 3) {
            showError('username-error', 'Username must be at least 3 characters');
          }
        }
      });

      passwordInput.addEventListener('blur', function() {
        if (this.value) {
          clearError('password-error');
          if (this.value.length < 6) {
            showError('password-error', 'Password must be at least 6 characters');
          }
        }
      });

      // Clear errors on input
      usernameInput.addEventListener('input', () => clearError('username-error'));
      passwordInput.addEventListener('input', () => clearError('password-error'));
    }

    function togglePassword() {
      const passwordInput = document.getElementById('password');
      const toggleBtn = document.getElementById('password-toggle');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'üôà';
      } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'üëÅÔ∏è';
      }
    }

    async function loginDemo() {
      if (isSubmitting) return;
      
      const demoBtn = document.getElementById('demo-btn');
      const originalText = demoBtn.textContent;
      demoBtn.textContent = 'Logging in...';
      demoBtn.disabled = true;

      try {
        // Use demo credentials
        const result = await Auth.login('demo', 'demo123');
        
        if (result.success) {
          showSuccess('Demo login successful! Redirecting...');
          setTimeout(() => {
            window.location.href = result.redirect;
          }, 1000);
        }
      } catch (error) {
        showError('login-error', 'Demo login failed. Please try manual login.');
        demoBtn.textContent = originalText;
        demoBtn.disabled = false;
      }
    }

    function socialLogin(provider) {
      showToast(`${provider} login coming soon!`, 'info');
    }

    async function recordUserActivity(activity) {
      try {
        // Record login activity for analytics
        await API.post('/analytics/user-activity', {
          activity: activity,
          timestamp: new Date().toISOString(),
          user_agent: navigator.userAgent,
          referrer: document.referrer
        });
      } catch (error) {
        console.warn('Failed to record user activity:', error);
      }
    }

    function showLoading(show) {
      const btn = document.getElementById('login-btn');
      const btnText = document.getElementById('login-btn-text');
      const spinner = document.getElementById('login-spinner');
      
      if (show) {
        btn.disabled = true;
        btnText.style.display = 'none';
        spinner.style.display = 'block';
      } else {
        btn.disabled = false;
        btnText.style.display = 'block';
        spinner.style.display = 'none';
      }
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function clearError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = '';
      errorElement.style.display = 'none';
    }

    function clearErrors() {
      clearError('username-error');
      clearError('password-error');
      clearError('login-error');
      document.getElementById('login-success').style.display = 'none';
    }

    function showSuccess(message) {
      const successElement = document.getElementById('login-success');
      successElement.textContent = message;
      successElement.style.display = 'block';
    }
  </script>
</body>
</html>