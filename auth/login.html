<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Login to CineScope - Access your personalized streaming experience">
    <title>Login - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body class="auth-body">
    <!-- Minimal Top Bar -->
    <nav class="topbar auth-topbar">
        <a href="/" class="logo">CineScope</a>
        <div class="auth-nav">
            <a href="/auth/register.html" class="btn btn-outline btn-sm">Sign Up</a>
        </div>
    </nav>

    <main class="auth-main">
        <div class="auth-container">
            <div class="auth-form-wrapper">
                <div class="auth-header">
                    <h1>Welcome Back</h1>
                    <p>Sign in to continue your cinematic journey</p>
                </div>

                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" 
                               id="username" 
                               name="username" 
                               class="form-input" 
                               required 
                               autocomplete="username"
                               placeholder="Enter your username">
                        <div class="form-error" id="usernameError"></div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="form-input" 
                                   required 
                                   autocomplete="current-password"
                                   placeholder="Enter your password">
                            <button type="button" 
                                    class="password-toggle" 
                                    onclick="togglePassword('password')"
                                    aria-label="Toggle password visibility">üëÅÔ∏è</button>
                        </div>
                        <div class="form-error" id="passwordError"></div>
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe" name="rememberMe">
                            <span class="checkbox-custom"></span>
                            Remember me
                        </label>
                        <a href="/auth/forgot-password.html" class="link-secondary">Forgot password?</a>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full" id="loginBtn">
                        <span class="btn-text">Sign In</span>
                        <div class="btn-spinner" style="display: none;"></div>
                    </button>

                    <div class="auth-divider">
                        <span>New to CineScope?</span>
                    </div>

                    <a href="/auth/register.html" class="btn btn-outline btn-full">
                        Create New Account
                    </a>
                </form>

                <div class="auth-footer">
                    <p class="auth-disclaimer">
                        By signing in, you agree to our 
                        <a href="#" class="link-primary">Terms of Service</a> and 
                        <a href="#" class="link-primary">Privacy Policy</a>
                    </p>
                </div>
            </div>

            <!-- Promotional Content -->
            <div class="auth-promo" id="authPromo">
                <div class="promo-content">
                    <h2>Discover Your Next Favorite</h2>
                    <p>Get personalized recommendations powered by advanced machine learning</p>
                    <ul class="promo-features">
                        <li>‚ú® AI-powered recommendations</li>
                        <li>üé¨ Unlimited streaming</li>
                        <li>üì± Watch anywhere, anytime</li>
                        <li>üéØ Personalized experience</li>
                    </ul>
                </div>
                <div class="promo-image" id="promoImage">
                    <!-- Dynamic content loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if already authenticated
            if (window.auth.isAuthenticated()) {
                window.auth.navigateToUserProfile();
                return;
            }

            // Load promotional content
            await loadPromoContent();

            // Setup form handling
            setupLoginForm();

            // Setup UI interactions
            setupUIInteractions();
        });

        async function loadPromoContent() {
            try {
                // Load trending content for promo
                const trending = await window.api.getTrending({ limit: 5 });
                const promoImage = document.getElementById('promoImage');
                
                if (trending.recommendations && trending.recommendations.length > 0) {
                    const randomContent = trending.recommendations[Math.floor(Math.random() * trending.recommendations.length)];
                    
                    promoImage.style.backgroundImage = `url('${randomContent.poster_path}')`;
                    promoImage.style.backgroundSize = 'cover';
                    promoImage.style.backgroundPosition = 'center';
                    promoImage.style.height = '300px';
                    promoImage.style.borderRadius = '12px';
                    
                    // Add overlay with content info
                    promoImage.innerHTML = `
                        <div class="promo-overlay">
                            <h3>${randomContent.title}</h3>
                            <p>‚òÖ ${randomContent.rating || 'N/A'} ‚Ä¢ ${randomContent.content_type}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.warn('Failed to load promo content:', error);
            }
        }

        function setupLoginForm() {
            const form = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            const btnText = loginBtn.querySelector('.btn-text');
            const btnSpinner = loginBtn.querySelector('.btn-spinner');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const credentials = {
                    username: formData.get('username').trim(),
                    password: formData.get('password')
                };

                // Validation
                if (!validateForm(credentials)) return;

                // Show loading state
                loginBtn.disabled = true;
                btnText.style.display = 'none';
                btnSpinner.style.display = 'inline-block';

                try {
                    const result = await window.auth.login(credentials);

                    if (result.success) {
                        showToast('Login successful! Redirecting...', 'success');
                        
                        // Small delay for UX
                        setTimeout(() => {
                            window.auth.handleSuccessfulAuth();
                        }, 1000);
                    } else {
                        showError('loginError', result.error || 'Login failed');
                        showToast(result.error || 'Login failed', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showError('loginError', 'Network error. Please try again.');
                    showToast('Network error. Please try again.', 'error');
                } finally {
                    // Reset button state
                    loginBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                }
            });
        }

        function validateForm(credentials) {
            clearErrors();

            let isValid = true;

            if (!credentials.username) {
                showError('usernameError', 'Username is required');
                isValid = false;
            }

            if (!credentials.password) {
                showError('passwordError', 'Password is required');
                isValid = false;
            }

            return isValid;
        }

        function setupUIInteractions() {
            // Auto-focus first input
            document.getElementById('username').focus();

            // Enter key navigation
            document.getElementById('username').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('password').focus();
                }
            });

            // Real-time validation
            document.getElementById('username').addEventListener('blur', validateUsername);
            document.getElementById('password').addEventListener('blur', validatePassword);
        }

        function validateUsername() {
            const username = document.getElementById('username').value.trim();
            const errorElement = document.getElementById('usernameError');
            
            if (username && username.length < 3) {
                showError('usernameError', 'Username must be at least 3 characters');
                return false;
            }
            
            clearError('usernameError');
            return true;
        }

        function validatePassword() {
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('passwordError');
            
            if (password && password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                return false;
            }
            
            clearError('passwordError');
            return true;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            
            // Update icon
            const button = input.nextElementSibling;
            button.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Add error class to input
            const input = document.querySelector(`#${elementId.replace('Error', '')}`);
            if (input) input.classList.add('input-error');
        }

        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = '';
            errorElement.style.display = 'none';
            
            // Remove error class from input
            const input = document.querySelector(`#${elementId.replace('Error', '')}`);
            if (input) input.classList.remove('input-error');
        }

        function clearErrors() {
            ['usernameError', 'passwordError', 'loginError'].forEach(clearError);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>