<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Login to CineScope - Access your personalized movie and TV recommendations">

    <title>Login - CineScope</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/bootstrap-overrides.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body class="bg-black">
    <!-- Login Container -->
    <div class="min-vh-100 d-flex align-items-center justify-content-center position-relative">
        <!-- Background Animation -->
        <div class="position-absolute w-100 h-100 overflow-hidden" style="z-index: -1;">
            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 30% 20%, rgba(37, 99, 235, 0.1) 0%, transparent 50%), 
                                 radial-gradient(circle at 70% 80%, rgba(147, 51, 234, 0.1) 0%, transparent 50%);">
            </div>
        </div>

        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5 col-xl-4">
                    <!-- Login Card -->
                    <div class="card bg-dark border-secondary shadow-xl animate-scale-in">
                        <div class="card-body p-5">
                            <!-- Brand -->
                            <div class="text-center mb-4">
                                <h1 class="display-6 fw-bold text-gradient-animate mb-2">
                                    <i class="bi bi-film me-2"></i>CineScope
                                </h1>
                                <p class="text-muted">Welcome back to your cinematic journey</p>
                            </div>

                            <!-- Login Form -->
                            <form id="login-form" novalidate>
                                <div class="mb-3">
                                    <label for="username" class="form-label text-white">Username</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-dark border-secondary">
                                            <i class="bi bi-person"></i>
                                        </span>
                                        <input type="text" class="form-control bg-dark border-secondary text-white"
                                            id="username" name="username" placeholder="Enter your username" required
                                            autocomplete="username">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="password" class="form-label text-white">Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-dark border-secondary">
                                            <i class="bi bi-lock"></i>
                                        </span>
                                        <input type="password" class="form-control bg-dark border-secondary text-white"
                                            id="password" name="password" placeholder="Enter your password" required
                                            autocomplete="current-password">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <!-- Remember Me -->
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="remember-me">
                                    <label class="form-check-label text-muted" for="remember-me">
                                        Remember me
                                    </label>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-primary w-100 mb-3" id="login-btn">
                                    <span class="login-btn-text">Sign In</span>
                                    <div class="spinner-border spinner-border-sm d-none" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </button>

                                <!-- Error Alert -->
                                <div id="error-alert" class="alert alert-danger d-none" role="alert">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span class="error-message"></span>
                                </div>
                            </form>

                            <!-- Divider -->
                            <hr class="my-4">

                            <!-- Register Link -->
                            <div class="text-center">
                                <p class="text-muted mb-3">Don't have an account?</p>
                                <a href="/auth/register" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-person-plus me-2"></i>Create Account
                                </a>
                            </div>

                            <!-- Back to Home -->
                            <div class="text-center mt-4">
                                <a href="/" class="text-muted text-decoration-none">
                                    <i class="bi bi-arrow-left me-2"></i>Back to Home
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Demo Credentials Info -->
                    <div class="card bg-dark border-warning mt-4 animate-fade-in-up" style="animation-delay: 0.2s;">
                        <div class="card-body p-3">
                            <h6 class="text-warning mb-2">
                                <i class="bi bi-info-circle me-2"></i>Demo Credentials
                            </h6>
                            <p class="text-muted small mb-2">Use these credentials to explore the platform:</p>
                            <div class="row g-2 small">
                                <div class="col-6">
                                    <strong class="text-white">Admin:</strong><br>
                                    Username: <code>admin</code><br>
                                    Password: <code>admin123</code>
                                </div>
                                <div class="col-6">
                                    <strong class="text-white">User:</strong><br>
                                    Username: <code>demo</code><br>
                                    Password: <code>demo123</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core JavaScript -->
    <script src="/js/config.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>

    <!-- Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🔑 Loading Login Page...');

            // Set page title
            CineScope.UI.updatePageTitle('Login');

            // Check if already logged in
            if (CineScope.Storage.user.isLoggedIn()) {
                const user = CineScope.Storage.user.get();
                console.log('👤 User already logged in, redirecting...');
                window.location.href = `/${user.username}/profile`;
                return;
            }

            // Initialize form
            initializeLoginForm();

            // Initialize password toggle
            initializePasswordToggle();

            // Handle return URL
            handleReturnUrl();

            console.log('✅ Login page loaded');
        });

        function initializeLoginForm() {
            const form = document.getElementById('login-form');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const errorAlert = document.getElementById('error-alert');

            if (!form) return;

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Reset validation
                clearValidation();
                hideError();

                // Get form data
                const formData = new FormData(form);
                const credentials = {
                    username: formData.get('username').trim(),
                    password: formData.get('password')
                };

                // Validate
                if (!validateForm(credentials)) {
                    return;
                }

                try {
                    // Show loading state
                    showLoading(loginBtn);

                    console.log('🔐 Attempting login...');

                    // Attempt login
                    const response = await CineScope.App.login(credentials);

                    console.log('✅ Login successful:', response.user.username);
                    CineScope.UI.toast.success(`Welcome back, ${response.user.username}!`);

                    // Handle remember me
                    if (document.getElementById('remember-me').checked) {
                        localStorage.setItem('cinescope_remember_user', response.user.username);
                    }

                    // Redirect will be handled by CineScope.App.login

                } catch (error) {
                    console.error('❌ Login failed:', error);
                    showError(error.message || 'Login failed. Please try again.');
                } finally {
                    hideLoading(loginBtn);
                }
            });

            // Auto-fill remembered username
            const rememberedUser = localStorage.getItem('cinescope_remember_user');
            if (rememberedUser && usernameInput) {
                usernameInput.value = rememberedUser;
                if (passwordInput) {
                    passwordInput.focus();
                }
            }
        }

        function initializePasswordToggle() {
            const toggleBtn = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');

            if (!toggleBtn || !passwordInput) return;

            toggleBtn.addEventListener('click', function () {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;

                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    icon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
                }
            });
        }

        function validateForm(credentials) {
            let isValid = true;

            // Username validation
            if (!credentials.username) {
                showFieldError('username', 'Username is required');
                isValid = false;
            } else if (credentials.username.length < 3) {
                showFieldError('username', 'Username must be at least 3 characters');
                isValid = false;
            }

            // Password validation
            if (!credentials.password) {
                showFieldError('password', 'Password is required');
                isValid = false;
            } else if (credentials.password.length < 6) {
                showFieldError('password', 'Password must be at least 6 characters');
                isValid = false;
            }

            return isValid;
        }

        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            const feedback = field.parentNode.querySelector('.invalid-feedback');

            field.classList.add('is-invalid');
            if (feedback) {
                feedback.textContent = message;
            }
        }

        function clearValidation() {
            const fields = document.querySelectorAll('.form-control');
            fields.forEach(field => {
                field.classList.remove('is-invalid', 'is-valid');
            });
        }

        function showError(message) {
            const errorAlert = document.getElementById('error-alert');
            const errorMessage = errorAlert.querySelector('.error-message');

            if (errorAlert && errorMessage) {
                errorMessage.textContent = message;
                errorAlert.classList.remove('d-none');
                errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function hideError() {
            const errorAlert = document.getElementById('error-alert');
            if (errorAlert) {
                errorAlert.classList.add('d-none');
            }
        }

        function showLoading(button) {
            const text = button.querySelector('.login-btn-text');
            const spinner = button.querySelector('.spinner-border');

            if (text) text.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');

            button.disabled = true;
        }

        function hideLoading(button) {
            const text = button.querySelector('.login-btn-text');
            const spinner = button.querySelector('.spinner-border');

            if (text) text.classList.remove('d-none');
            if (spinner) spinner.classList.add('d-none');

            button.disabled = false;
        }

        function handleReturnUrl() {
            // Get return URL from query params
            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('return');

            if (returnUrl) {
                // Store return URL for after login
                sessionStorage.setItem('cinescope_return_url', returnUrl);
            }
        }

        // Demo credentials quick fill
        document.addEventListener('keydown', function (e) {
            // Press Alt+D for demo user, Alt+A for admin
            if (e.altKey && (e.key === 'd' || e.key === 'D')) {
                e.preventDefault();
                document.getElementById('username').value = 'demo';
                document.getElementById('password').value = 'demo123';
                CineScope.UI.toast.info('Demo credentials filled');
            } else if (e.altKey && (e.key === 'a' || e.key === 'A')) {
                e.preventDefault();
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = 'admin123';
                CineScope.UI.toast.info('Admin credentials filled');
            }
        });
    </script>
</body>

</html>