<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - CineBrain</title>

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Login to CineBrain and get personalized movie, TV show, and anime recommendations powered by AI.">
    <meta name="keywords" content="login, signin, account, personalized recommendations">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- CSS Files -->
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/layouts.css" rel="stylesheet">
    <link href="/css/animations.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
</head>

<body data-page="login">

    <!-- Navigation -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Login Section -->
        <section class="login-section min-vh-100 d-flex align-items-center">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-5 col-md-7">

                        <!-- Login Card -->
                        <div class="login-card bg-theater rounded-4 shadow-2xl p-5 border border-royal">

                            <!-- Brand Header -->
                            <div class="text-center mb-5">
                                <div class="brand-logo text-primary fs-1 fw-bold mb-2">CineBrain</div>
                                <p class="brand-tagline text-muted">The Mind Behind Your Next Favorite</p>
                                <h2 class="text-white fw-semibold">Welcome Back</h2>
                                <p class="text-gray-400">Sign in to get personalized recommendations</p>
                            </div>

                            <!-- Login Form -->
                            <form id="loginForm" class="needs-validation" novalidate>

                                <!-- Username Field -->
                                <div class="mb-4">
                                    <label for="username" class="form-label text-white fw-medium">
                                        <i class="bi bi-person me-2"></i>Username
                                    </label>
                                    <input type="text"
                                        class="form-control form-control-lg bg-velvet border-royal text-white"
                                        id="username" name="username" placeholder="Enter your username" required
                                        autocomplete="username">
                                    <div class="invalid-feedback" id="username-error"></div>
                                </div>

                                <!-- Password Field -->
                                <div class="mb-4">
                                    <label for="password" class="form-label text-white fw-medium">
                                        <i class="bi bi-lock me-2"></i>Password
                                    </label>
                                    <div class="input-group">
                                        <input type="password"
                                            class="form-control form-control-lg bg-velvet border-royal text-white"
                                            id="password" name="password" placeholder="Enter your password" required
                                            autocomplete="current-password">
                                        <button class="btn btn-outline-royal password-toggle" type="button">
                                            <i class="bi bi-eye password-toggle-icon"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" id="password-error"></div>
                                </div>

                                <!-- Remember Me & Forgot Password -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rememberMe"
                                            name="rememberMe">
                                        <label class="form-check-label text-gray-400" for="rememberMe">
                                            Remember me
                                        </label>
                                    </div>
                                    <a href="/auth/forgot-password.html" class="text-primary text-decoration-none">
                                        Forgot password?
                                    </a>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-primary btn-lg w-100 mb-4 btn-press">
                                    <span class="login-btn-text">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                                    </span>
                                    <div class="spinner-border spinner-border-sm d-none" role="status">
                                        <span class="visually-hidden">Signing in...</span>
                                    </div>
                                </button>

                                <!-- Error Alert -->
                                <div class="alert alert-danger d-none" id="loginError" role="alert">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span class="error-message">Invalid credentials. Please try again.</span>
                                </div>

                                <!-- Success Alert -->
                                <div class="alert alert-success d-none" id="loginSuccess" role="alert">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span class="success-message">Login successful! Redirecting...</span>
                                </div>
                            </form>

                            <!-- Divider -->
                            <div class="divider my-4">
                                <hr class="border-royal">
                                <span class="divider-text bg-theater text-gray-400 px-3">or</span>
                            </div>

                            <!-- Social Login Options -->
                            <div class="social-login mb-4">
                                <button class="btn btn-outline-light w-100 mb-3 social-btn" data-provider="google">
                                    <i class="bi bi-google me-2"></i>Continue with Google
                                </button>
                                <button class="btn btn-outline-light w-100 social-btn" data-provider="github">
                                    <i class="bi bi-github me-2"></i>Continue with GitHub
                                </button>
                            </div>

                            <!-- Sign Up Link -->
                            <div class="text-center">
                                <p class="text-gray-400 mb-0">
                                    Don't have an account?
                                    <a href="/auth/register.html" class="text-primary text-decoration-none fw-semibold">
                                        Sign up for free
                                    </a>
                                </p>
                            </div>
                        </div>

                        <!-- Demo Credentials -->
                        <div class="demo-credentials bg-velvet rounded-3 p-3 mt-4 text-center">
                            <small class="text-muted d-block mb-2">Demo Credentials:</small>
                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-sm btn-outline-info demo-fill" data-username="demo"
                                    data-password="demo123">
                                    Demo User
                                </button>
                                <button class="btn btn-sm btn-outline-warning demo-fill" data-username="admin"
                                    data-password="admin123">
                                    Admin User
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>

    <script>
        // Login Page Controller
        class LoginPage {
            constructor() {
                this.form = null;
                this.isSubmitting = false;
                this.initialize();
            }

            async initialize() {
                try {
                    // Redirect if already authenticated
                    if (auth.isAuthenticated()) {
                        const user = auth.getCurrentUser();
                        window.location.href = `/${user.username}/profile`;
                        return;
                    }

                    // Load navigation components
                    await this.loadComponents();

                    // Setup form
                    this.form = document.getElementById('loginForm');

                    // Setup event listeners
                    this.setupEventListeners();

                    // Setup form validation
                    this.setupValidation();

                    // Check for redirect parameter
                    this.handleRedirectParam();

                    console.log('Login page loaded successfully');

                } catch (error) {
                    console.error('Error initializing login page:', error);
                }
            }

            async loadComponents() {
                try {
                    // Load topbar
                    const topbarResponse = await fetch('/components/layout/topbar.html');
                    const topbarHTML = await topbarResponse.text();
                    document.getElementById('topbar-container').innerHTML = topbarHTML;

                    // Load mobile navigation
                    const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
                    const mobileNavHTML = await mobileNavResponse.text();
                    document.getElementById('mobile-nav-container').innerHTML = mobileNavHTML;

                } catch (error) {
                    console.error('Error loading components:', error);
                }
            }

            setupEventListeners() {
                // Form submission
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Password toggle
                const passwordToggle = document.querySelector('.password-toggle');
                passwordToggle.addEventListener('click', () => {
                    this.togglePasswordVisibility();
                });

                // Real-time validation
                const inputs = this.form.querySelectorAll('input[required]');
                inputs.forEach(input => {
                    input.addEventListener('blur', () => {
                        this.validateField(input);
                    });

                    input.addEventListener('input', () => {
                        this.clearFieldError(input);
                    });
                });

                // Demo credential buttons
                const demoButtons = document.querySelectorAll('.demo-fill');
                demoButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.fillDemoCredentials(btn.dataset.username, btn.dataset.password);
                    });
                });

                // Social login buttons
                const socialBtns = document.querySelectorAll('.social-btn');
                socialBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.handleSocialLogin(btn.dataset.provider);
                    });
                });

                // Enter key on username field
                document.getElementById('username').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('password').focus();
                    }
                });
            }

            setupValidation() {
                // Custom Bootstrap validation
                const form = this.form;

                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            }

            handleRedirectParam() {
                const urlParams = new URLSearchParams(window.location.search);
                const redirect = urlParams.get('redirect');

                if (redirect) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'alert alert-info mb-4';
                    messageDiv.innerHTML = `
                    <i class="bi bi-info-circle me-2"></i>
                    Please log in to access this page.
                `;

                    this.form.insertBefore(messageDiv, this.form.firstChild);

                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        messageDiv.remove();
                    }, 5000);
                }
            }

            async handleLogin() {
                if (this.isSubmitting) return;

                // Validate form
                if (!this.validateForm()) {
                    return;
                }

                const formData = new FormData(this.form);
                const credentials = {
                    username: formData.get('username').trim(),
                    password: formData.get('password')
                };

                try {
                    this.setSubmittingState(true);
                    this.hideAlerts();

                    // Attempt login via API
                    const result = await auth.login(credentials);

                    if (result.success) {
                        this.showSuccess('Login successful! Redirecting...');

                        // Wait for success message to be visible
                        await this.delay(1000);

                        // Redirect based on user role and URL params
                        this.handleSuccessfulLogin(result.user);

                    } else {
                        this.showError(result.error || 'Login failed. Please try again.');
                    }

                } catch (error) {
                    console.error('Login error:', error);
                    this.showError('Network error. Please check your connection and try again.');
                } finally {
                    this.setSubmittingState(false);
                }
            }

            handleSuccessfulLogin(user) {
                const urlParams = new URLSearchParams(window.location.search);
                const redirect = urlParams.get('redirect');

                if (redirect) {
                    // Decode and validate redirect URL
                    try {
                        const decodedRedirect = decodeURIComponent(redirect);

                        // Ensure redirect is internal
                        if (decodedRedirect.startsWith('/')) {
                            window.location.href = decodedRedirect;
                            return;
                        }
                    } catch (error) {
                        console.warn('Invalid redirect parameter:', error);
                    }
                }

                // Default redirect based on user role
                if (user.is_admin) {
                    window.location.href = '/admin/index.html';
                } else {
                    window.location.href = `/${user.username}/profile`;
                }
            }

            validateForm() {
                let isValid = true;

                // Validate username
                const username = document.getElementById('username').value.trim();
                if (!username) {
                    this.showFieldError('username', 'Username is required');
                    isValid = false;
                } else if (!FormValidator.isValidUsername(username)) {
                    this.showFieldError('username', 'Invalid username format');
                    isValid = false;
                }

                // Validate password
                const password = document.getElementById('password').value;
                if (!password) {
                    this.showFieldError('password', 'Password is required');
                    isValid = false;
                } else if (password.length < 6) {
                    this.showFieldError('password', 'Password must be at least 6 characters');
                    isValid = false;
                }

                return isValid;
            }

            validateField(input) {
                const value = input.value.trim();
                const fieldName = input.name;

                switch (fieldName) {
                    case 'username':
                        if (!value) {
                            this.showFieldError(fieldName, 'Username is required');
                            return false;
                        } else if (!FormValidator.isValidUsername(value)) {
                            this.showFieldError(fieldName, 'Username must be 3-20 characters (letters, numbers, underscore only)');
                            return false;
                        }
                        break;

                    case 'password':
                        if (!value) {
                            this.showFieldError(fieldName, 'Password is required');
                            return false;
                        } else if (value.length < 6) {
                            this.showFieldError(fieldName, 'Password must be at least 6 characters');
                            return false;
                        }
                        break;
                }

                this.showFieldSuccess(fieldName);
                return true;
            }

            showFieldError(fieldName, message) {
                FormValidator.showError(fieldName, message);
            }

            showFieldSuccess(fieldName) {
                FormValidator.showSuccess(fieldName);
            }

            clearFieldError(input) {
                FormValidator.clearValidation(input.name);
            }

            togglePasswordVisibility() {
                const passwordInput = document.getElementById('password');
                const toggleIcon = document.querySelector('.password-toggle-icon');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('bi-eye');
                    toggleIcon.classList.add('bi-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('bi-eye-slash');
                    toggleIcon.classList.add('bi-eye');
                }
            }

            fillDemoCredentials(username, password) {
                document.getElementById('username').value = username;
                document.getElementById('password').value = password;

                // Clear any existing validation states
                FormValidator.clearValidation('username');
                FormValidator.clearValidation('password');

                // Focus password field for immediate login
                document.getElementById('password').focus();
            }

            handleSocialLogin(provider) {
                // Placeholder for social login implementation
                this.showError(`Social login with ${provider} is not yet implemented. Please use the demo credentials or contact support.`);
            }

            setSubmittingState(isSubmitting) {
                this.isSubmitting = isSubmitting;

                const submitBtn = this.form.querySelector('button[type="submit"]');
                const btnText = submitBtn.querySelector('.login-btn-text');
                const spinner = submitBtn.querySelector('.spinner-border');

                if (isSubmitting) {
                    submitBtn.disabled = true;
                    btnText.classList.add('d-none');
                    spinner.classList.remove('d-none');
                } else {
                    submitBtn.disabled = false;
                    btnText.classList.remove('d-none');
                    spinner.classList.add('d-none');
                }
            }

            showError(message) {
                const errorAlert = document.getElementById('loginError');
                const errorMessage = errorAlert.querySelector('.error-message');

                errorMessage.textContent = message;
                errorAlert.classList.remove('d-none');

                // Auto-hide after 10 seconds
                setTimeout(() => {
                    errorAlert.classList.add('d-none');
                }, 10000);
            }

            showSuccess(message) {
                const successAlert = document.getElementById('loginSuccess');
                const successMessage = successAlert.querySelector('.success-message');

                successMessage.textContent = message;
                successAlert.classList.remove('d-none');
            }

            hideAlerts() {
                document.getElementById('loginError').classList.add('d-none');
                document.getElementById('loginSuccess').classList.add('d-none');
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize login page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            window.loginPage = new LoginPage();
        });
    </script>

    <style>
        /* Login Page Specific Styles */
        .login-section {
            background: linear-gradient(135deg, var(--cinema-black) 0%, var(--theater-dark) 50%, var(--velvet-dark) 100%);
            position: relative;
            overflow: hidden;
        }

        .login-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .login-card {
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .login-card:hover {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
        }

        .form-control:focus {
            background-color: rgba(30, 30, 35, 0.9);
            border-color: var(--platinum-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            color: white;
        }

        .form-control::placeholder {
            color: rgba(156, 163, 175, 0.7);
        }

        .password-toggle {
            border-left: none;
            color: rgba(156, 163, 175, 0.8);
        }

        .password-toggle:hover {
            color: var(--platinum-blue);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            background: var(--hero-gradient);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--premium-glow);
        }

        .btn-press:active {
            transform: translateY(0px);
        }

        .divider {
            position: relative;
        }

        .divider-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 0 1rem;
        }

        .social-btn {
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .social-btn:hover {
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .demo-credentials {
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .demo-fill {
            transition: all 0.3s ease;
        }

        .demo-fill:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Form Validation Styles */
        .was-validated .form-control:valid {
            border-color: #198754;
            background-image: none;
        }

        .was-validated .form-control:invalid {
            border-color: #dc3545;
            background-image: none;
        }

        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Alert Enhancements */
        .alert {
            border: none;
            border-radius: 8px;
            animation: slideInDown 0.3s ease-out;
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: #f5c6cb;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .alert-success {
            background: rgba(25, 135, 84, 0.1);
            color: #d1e7dd;
            border: 1px solid rgba(25, 135, 84, 0.3);
        }

        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            color: #b6d4fe;
            border: 1px solid rgba(13, 110, 253, 0.3);
        }

        /* Responsive Adjustments */
        @media (max-width: 576px) {
            .login-card {
                margin: 1rem;
                padding: 2rem 1.5rem;
            }

            .brand-logo {
                font-size: 2rem;
            }

            .demo-credentials {
                margin: 0 1rem;
            }

            .demo-credentials .d-flex {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Animation Keyframes */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</body>

</html>