<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Search - CineBrain</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body class="bg-gray-900 text-white">
    <!-- Fixed Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="pt-20 pb-20 md:pb-8">
        <div class="container-fluid px-3 px-md-4">
            <!-- Search Header -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-8">
                    <div class="text-center mb-4">
                        <h1 class="text-white fw-bold mb-2">Discover Your Next Favorite</h1>
                        <p class="text-muted">Search through millions of movies, TV shows, and anime</p>
                    </div>

                    <!-- Advanced Search -->
                    <div class="card glass-effect border-0 mb-4">
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-transparent border-secondary text-white">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control search-input" id="mainSearch"
                                            placeholder="Search movies, TV shows, anime..." autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select search-input" id="contentTypeFilter">
                                        <option value="multi">All Content</option>
                                        <option value="movie">Movies</option>
                                        <option value="tv">TV Shows</option>
                                        <option value="anime">Anime</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Advanced Filters -->
                            <div class="mt-3">
                                <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#advancedFilters">
                                    <i class="fas fa-filter me-2"></i>Advanced Filters
                                </button>
                            </div>

                            <div class="collapse mt-3" id="advancedFilters">
                                <div class="border-top border-secondary pt-3">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label text-white">Genre</label>
                                            <select class="form-select search-input" id="genreFilter">
                                                <option value="">All Genres</option>
                                                <option value="action">Action</option>
                                                <option value="comedy">Comedy</option>
                                                <option value="drama">Drama</option>
                                                <option value="horror">Horror</option>
                                                <option value="romance">Romance</option>
                                                <option value="thriller">Thriller</option>
                                                <option value="sci-fi">Sci-Fi</option>
                                                <option value="fantasy">Fantasy</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-white">Language</label>
                                            <select class="form-select search-input" id="languageFilter">
                                                <option value="">All Languages</option>
                                                <option value="english">English</option>
                                                <option value="hindi">Hindi</option>
                                                <option value="telugu">Telugu</option>
                                                <option value="tamil">Tamil</option>
                                                <option value="kannada">Kannada</option>
                                                <option value="malayalam">Malayalam</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-white">Sort By</label>
                                            <select class="form-select search-input" id="sortFilter">
                                                <option value="popularity">Popularity</option>
                                                <option value="rating">Rating</option>
                                                <option value="release_date">Release Date</option>
                                                <option value="title">Title</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Stats -->
            <div class="row mb-4" id="searchStats" style="display: none;">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">Search results for: </span>
                            <span class="text-white fw-bold" id="searchQuery"></span>
                        </div>
                        <div class="text-muted" id="resultCount"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Search Suggestions -->
            <div class="row mb-4" id="searchSuggestions">
                <div class="col-12">
                    <h5 class="text-white mb-3">Popular Searches</h5>
                    <div class="d-flex flex-wrap gap-2" id="popularSearches">
                        <!-- Popular searches will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div class="row" id="searchResults">
                <!-- Initial state -->
                <div class="col-12" id="initialState">
                    <div class="text-center py-5">
                        <i class="fas fa-search text-muted mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-white mb-3">Start Searching</h4>
                        <p class="text-muted">Enter a movie, TV show, or anime title to begin discovering amazing
                            content.</p>
                    </div>
                </div>

                <!-- Loading state -->
                <div class="col-12 d-none" id="loadingState">
                    <div class="text-center py-5">
                        <div class="spinner-border text-danger mb-3" role="status">
                            <span class="visually-hidden">Searching...</span>
                        </div>
                        <h5 class="text-white">Searching...</h5>
                    </div>
                </div>

                <!-- Results grid -->
                <div class="col-12 d-none" id="resultsGrid">
                    <div class="row" id="resultsContainer">
                        <!-- Search results will be rendered here -->
                    </div>

                    <!-- Load More Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-light" id="loadMoreBtn" style="display: none;">
                            Load More Results
                        </button>
                    </div>
                </div>

                <!-- No results state -->
                <div class="col-12 d-none" id="noResultsState">
                    <div class="text-center py-5">
                        <i class="fas fa-search-minus text-muted mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-white mb-3">No Results Found</h4>
                        <p class="text-muted mb-4">We couldn't find any content matching your search. Try different
                            keywords or check your spelling.</p>
                        <button class="btn btn-primary-custom" onclick="clearSearch()">
                            Try New Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        class SearchHandler {
            constructor() {
                this.currentQuery = '';
                this.currentPage = 1;
                this.isLoading = false;
                this.hasMorePages = false;
                this.allResults = [];

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadPopularSearches();

                // Check for URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q');
                if (query) {
                    document.getElementById('mainSearch').value = query;
                    this.performSearch(query);
                }
            }

            setupEventListeners() {
                const searchInput = document.getElementById('mainSearch');
                const clearBtn = document.getElementById('clearSearch');
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                const contentTypeFilter = document.getElementById('contentTypeFilter');

                // Debounced search
                const debouncedSearch = Utils.debounce((query) => {
                    if (query.length >= 2) {
                        this.performSearch(query);
                    } else if (query.length === 0) {
                        this.showInitialState();
                    }
                }, 500);

                searchInput.addEventListener('input', (e) => {
                    debouncedSearch(e.target.value.trim());
                });

                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.performSearch(searchInput.value.trim());
                    }
                });

                clearBtn.addEventListener('click', () => {
                    this.clearSearch();
                });

                loadMoreBtn.addEventListener('click', () => {
                    this.loadMoreResults();
                });

                // Filter change handlers
                [contentTypeFilter, document.getElementById('genreFilter'),
                    document.getElementById('languageFilter'), document.getElementById('sortFilter')].forEach(filter => {
                        filter.addEventListener('change', () => {
                            if (this.currentQuery) {
                                this.performSearch(this.currentQuery);
                            }
                        });
                    });
            }

            async loadPopularSearches() {
                try {
                    // Get trending content to create popular searches
                    const trending = await apiClient.getTrending('all', 10);
                    const popularSearches = trending.recommendations.slice(0, 8);

                    const container = document.getElementById('popularSearches');
                    container.innerHTML = popularSearches.map(item => `
                        <button class="btn btn-outline-secondary btn-sm" 
                                onclick="searchHandler.performSearch('${item.title.replace(/'/g, "\\'")}')">
                            ${item.title}
                        </button>
                    `).join('');
                } catch (error) {
                    console.error('Failed to load popular searches:', error);
                }
            }

            async performSearch(query) {
                if (!query || query.length < 2) return;

                this.currentQuery = query;
                this.currentPage = 1;
                this.allResults = [];
                this.isLoading = true;

                this.showLoadingState();
                this.updateSearchStats(query, 0);

                try {
                    const contentType = document.getElementById('contentTypeFilter').value;
                    const results = await apiClient.searchContent(query, contentType, 1);

                    if (results.results && results.results.length > 0) {
                        this.allResults = results.results;
                        this.hasMorePages = results.current_page < results.total_pages;
                        this.renderResults(results.results);
                        this.updateSearchStats(query, results.total_results);
                        this.showResultsState();
                    } else {
                        this.showNoResultsState();
                    }

                    // Update URL
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('q', query);
                    window.history.pushState({}, '', newUrl);

                } catch (error) {
                    console.error('Search error:', error);
                    Utils.showToast('Search failed. Please try again.', 'error');
                    this.showNoResultsState();
                } finally {
                    this.isLoading = false;
                }
            }

            async loadMoreResults() {
                if (this.isLoading || !this.hasMorePages) return;

                this.isLoading = true;
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                const originalText = loadMoreBtn.textContent;
                loadMoreBtn.textContent = 'Loading...';
                loadMoreBtn.disabled = true;

                try {
                    this.currentPage++;
                    const contentType = document.getElementById('contentTypeFilter').value;
                    const results = await apiClient.searchContent(this.currentQuery, contentType, this.currentPage);

                    if (results.results && results.results.length > 0) {
                        this.allResults = [...this.allResults, ...results.results];
                        this.appendResults(results.results);
                        this.hasMorePages = this.currentPage < results.total_pages;

                        if (!this.hasMorePages) {
                            loadMoreBtn.style.display = 'none';
                        }
                    }

                } catch (error) {
                    console.error('Load more error:', error);
                    Utils.showToast('Failed to load more results', 'error');
                    this.currentPage--; // Revert page increment
                } finally {
                    this.isLoading = false;
                    loadMoreBtn.textContent = originalText;
                    loadMoreBtn.disabled = false;
                }
            }

            renderResults(results) {
                const container = document.getElementById('resultsContainer');
                container.innerHTML = '';
                this.appendResults(results);
            }

            appendResults(results) {
                const container = document.getElementById('resultsContainer');

                const resultsHtml = results.map(item => `
                    <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                        <div class="content-card h-100" onclick="window.location.href='details.html?id=${item.id}'">
                            <div class="position-relative">
                                <img src="${Utils.getImageUrl(item.poster_path)}" 
                                     alt="${item.title}" class="content-card-image w-100"
                                     loading="lazy" onerror="this.src='${Utils.getImageUrl(null)}'">
                                
                                ${item.rating ? `
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="${Utils.formatRating(item.rating).className}">
                                            ${Utils.formatRating(item.rating).value}
                                        </span>
                                    </div>
                                ` : ''}

                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="type-badge">${Utils.formatContentType(item.content_type)}</span>
                                </div>
                            </div>
                            
                            <div class="p-3">
                                <h6 class="text-white mb-2 fw-bold">${item.title}</h6>
                                <p class="text-muted small mb-2">${Utils.formatDate(item.release_date)}</p>
                                
                                ${item.genres && item.genres.length > 0 ? `
                                    <div class="mb-2">
                                        ${item.genres.slice(0, 2).map(genre =>
                    `<span class="genre-chip">${genre}</span>`
                ).join('')}
                                    </div>
                                ` : ''}
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-primary-custom flex-grow-1" 
                                            onclick="event.stopPropagation(); Components.addToWatchlist(${item.id})">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    ${item.youtube_trailer ? `
                                        <button class="btn btn-sm btn-secondary-custom" 
                                                onclick="event.stopPropagation(); Components.openTrailer('${Utils.extractYouTubeId(item.youtube_trailer)}', '${item.title}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.insertAdjacentHTML('beforeend', resultsHtml);

                // Show load more button if there are more pages
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (this.hasMorePages) {
                    loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            }

            updateSearchStats(query, count) {
                document.getElementById('searchQuery').textContent = query;
                document.getElementById('resultCount').textContent =
                    count > 0 ? `${count.toLocaleString()} results found` : '';
            }

            showInitialState() {
                this.hideAllStates();
                document.getElementById('initialState').classList.remove('d-none');
                document.getElementById('searchSuggestions').style.display = 'block';
                document.getElementById('searchStats').style.display = 'none';
            }

            showLoadingState() {
                this.hideAllStates();
                document.getElementById('loadingState').classList.remove('d-none');
                document.getElementById('searchSuggestions').style.display = 'none';
                document.getElementById('searchStats').style.display = 'block';
            }

            showResultsState() {
                this.hideAllStates();
                document.getElementById('resultsGrid').classList.remove('d-none');
                document.getElementById('searchSuggestions').style.display = 'none';
                document.getElementById('searchStats').style.display = 'block';
            }

            showNoResultsState() {
                this.hideAllStates();
                document.getElementById('noResultsState').classList.remove('d-none');
                document.getElementById('searchSuggestions').style.display = 'none';
                document.getElementById('searchStats').style.display = 'block';
            }

            hideAllStates() {
                ['initialState', 'loadingState', 'resultsGrid', 'noResultsState'].forEach(stateId => {
                    document.getElementById(stateId).classList.add('d-none');
                });
            }

            clearSearch() {
                document.getElementById('mainSearch').value = '';
                this.currentQuery = '';
                this.allResults = [];
                this.showInitialState();

                // Clear URL parameters
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('q');
                window.history.pushState({}, '', newUrl);
            }
        }

        // Global functions
        function clearSearch() {
            window.searchHandler.clearSearch();
        }

        // Initialize search handler
        document.addEventListener('DOMContentLoaded', () => {
            window.searchHandler = new SearchHandler();
        });
    </script>
</body>

</html>