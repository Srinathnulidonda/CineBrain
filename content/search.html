<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - CineBrain</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/components.css">
</head>

<body class="bg-[#0a0a0f] text-[#e0e0ff] pt-5">
    <!-- Topbar -->
    <nav id="main-topbar"></nav>

    <main class="container-fluid px-3 px-md-4 px-lg-5 py-4 mt-5">
        <!-- Search Header -->
        <div class="row mb-4">
            <div class="col-12 col-md-8">
                <h1 class="text-3xl font-bold text-[#60a5fa] mb-2">Search Results</h1>
                <p id="search-query-display" class="text-[#a78bfa]"></p>
            </div>
            <div class="col-12 col-md-4 text-md-end">
                <button class="btn btn-outline-primary" onclick="openFilterModal()">
                    <svg class="w-4 h-4 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                        </path>
                    </svg>
                    Filters
                </button>
            </div>
        </div>

        <!-- Results Grid -->
        <div id="search-results" class="row g-3">
            <!-- Results will be loaded here -->
        </div>

        <!-- Infinite Scroll Sentinel -->
        <div id="infinite-scroll-sentinel" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading more...</span>
            </div>
        </div>
    </main>

    <!-- Filter Modal -->
    <div id="filter-modal-container"></div>

    <!-- Mobile Nav -->
    <nav id="mobile-nav" class="d-md-none"></nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;

        // Get query from URL
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('q') || '';

        // Initialize page
        async function initSearchPage() {
            // Load components
            await Promise.all([
                loadComponent('main-topbar', '../components/layout/topbar.html'),
                loadComponent('mobile-nav', '../components/layout/mobile-nav.html'),
                loadComponent('filter-modal-container', '../components/modals/filter-modal.html')
            ]);

            // Display query
            document.getElementById('search-query-display').textContent =
                searchQuery ? `Showing results for "${searchQuery}"` : 'Browse all content';

            // Load initial results
            await loadSearchResults();

            // Setup infinite scroll
            setupInfiniteScroll();
        }

        // Load search results
        async function loadSearchResults(append = false) {
            if (isLoading || !hasMore) return;

            isLoading = true;
            const sentinel = document.getElementById('infinite-scroll-sentinel');
            sentinel.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/search?query=${encodeURIComponent(searchQuery)}&page=${currentPage}`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    renderResults(data.results, append);
                    currentPage++;
                    hasMore = currentPage <= data.total_pages;
                } else {
                    hasMore = false;
                    if (!append) {
                        showNoResults();
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                showError();
            } finally {
                isLoading = false;
                if (!hasMore) {
                    sentinel.style.display = 'none';
                }
            }
        }

        // Render results
        function renderResults(results, append = false) {
            const container = document.getElementById('search-results');
            const html = results.map(item => createSearchCard(item)).join('');

            if (append) {
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }

        // Create search result card
        function createSearchCard(item) {
            return `
                <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                    <article class="content-card rounded-2xl overflow-hidden bg-[#1a1a2e] hover:scale-105 transition-transform cursor-pointer"
                             onclick="window.location.href='/content/details.html?id=${item.id}'">
                        <img class="w-100" style="aspect-ratio: 2/3;" 
                             src="${item.poster_path || '/api/placeholder/300/450'}" 
                             alt="${item.title}" 
                             loading="lazy">
                        <div class="p-3">
                            <h3 class="text-sm font-semibold text-truncate">${item.title}</h3>
                            <div class="text-xs text-[#a78bfa]">
                                ${item.content_type} • ${item.rating ? `⭐ ${item.rating}` : 'Not rated'}
                            </div>
                        </div>
                    </article>
                </div>
            `;
        }

        // Setup infinite scroll
        function setupInfiniteScroll() {
            const observer = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting && !isLoading && hasMore) {
                    loadSearchResults(true);
                }
            }, { threshold: 0.1 });

            observer.observe(document.getElementById('infinite-scroll-sentinel'));
        }

        // Show no results message
        function showNoResults() {
            document.getElementById('search-results').innerHTML = `
                <div class="col-12 text-center py-5">
                    <h3 class="text-[#a78bfa]">No results found</h3>
                    <p class="text-[#60a5fa]">Try adjusting your search or filters</p>
                </div>
            `;
        }

        // Show error message
        function showError() {
            document.getElementById('search-results').innerHTML = `
                <div class="col-12 text-center py-5">
                    <h3 class="text-danger">Something went wrong</h3>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        // Open filter modal
        function openFilterModal() {
            const modal = new bootstrap.Modal(document.getElementById('filterModal'));
            modal.show();
        }

        // Load component helper
        async function loadComponent(id, path) {
            try {
                const response = await fetch(path);
                const html = await response.text();
                document.getElementById(id).innerHTML = html;
            } catch (error) {
                console.error(`Failed to load component ${path}:`, error);
            }
        }

        // Listen for filter changes
        document.addEventListener('filters:changed', function (e) {
            currentPage = 1;
            hasMore = true;
            loadSearchResults();
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initSearchPage);
    </script>
</body>

</html>