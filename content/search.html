<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Search - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/bootstrap-overrides.css" rel="stylesheet">
    <link href="/css/tailwind.css" rel="stylesheet">
    <link href="/css/animation.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    <link href="/css/utilities.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <!-- Search Header -->
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <h1 class="h3 mb-4">Search Content</h1>

                <!-- Search Bar -->
                <div class="search-container mb-4">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-lg" id="search-input"
                            placeholder="Search movies, TV shows, anime..." value="">
                        <button class="btn btn-primary" type="button" id="search-btn">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="d-flex gap-2 flex-wrap mb-4">
                    <button class="btn btn-sm btn-outline-primary active" data-type="multi">All</button>
                    <button class="btn btn-sm btn-outline-primary" data-type="movie">Movies</button>
                    <button class="btn btn-sm btn-outline-primary" data-type="tv">TV Shows</button>
                    <button class="btn btn-sm btn-outline-primary" data-type="anime">Anime</button>
                </div>

                <!-- Recent Searches -->
                <div id="recent-searches" class="mb-4" style="display: none;">
                    <h6 class="text-muted mb-2">Recent Searches</h6>
                    <div class="d-flex gap-2 flex-wrap" id="recent-searches-list">
                        <!-- Recent searches will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="row">
            <div class="col-12">
                <div id="search-results-info" class="mb-3" style="display: none;">
                    <p class="text-muted mb-0">
                        Found <span id="result-count">0</span> results for "<span id="search-term"></span>"
                    </p>
                </div>

                <div id="search-results" class="content-grid">
                    <!-- Initial trending content or search results -->
                </div>

                <!-- Pagination -->
                <div id="pagination-container" class="mt-4"></div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>

    <!-- Page Specific Script -->
    <script>
        let currentPage = 1;
        let currentQuery = '';
        let currentType = 'multi';
        let totalPages = 1;

        // Initialize search from URL params
        function initializeSearch() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            const type = urlParams.get('type') || 'multi';
            const sort = urlParams.get('sort');

            currentType = type;

            // Update filter buttons
            document.querySelectorAll('[data-type]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === currentType);
            });

            if (query) {
                document.getElementById('search-input').value = query;
                performSearch(query);
            } else if (sort) {
                // Handle sorted views
                loadSortedContent(sort);
            } else {
                // Show trending by default
                loadDefaultContent();
            }

            // Load recent searches
            loadRecentSearches();
        }

        // Perform search
        async function performSearch(query, page = 1) {
            currentQuery = query;
            currentPage = page;

            if (!query.trim()) return;

            // Add to recent searches
            storage.addRecentSearch(query);

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('q', query);
            url.searchParams.set('type', currentType);
            window.history.pushState({}, '', url);

            // Show loading
            ui.showSkeletonGrid('search-results');

            try {
                const response = await api.search(query, currentType, page);

                // Update results info
                document.getElementById('search-results-info').style.display = 'block';
                document.getElementById('result-count').textContent = response.total_results || 0;
                document.getElementById('search-term').textContent = query;

                // Display results
                if (response.results && response.results.length > 0) {
                    ui.createContentGrid(response.results, 'search-results');

                    // Update pagination
                    totalPages = response.total_pages || 1;
                    updatePagination();
                } else {
                    document.getElementById('search-results').innerHTML = '';
                    document.getElementById('search-results').appendChild(
                        ui.createEmptyState('No results found', 'bi-search')
                    );
                }
            } catch (error) {
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('search-results').appendChild(
                    ui.createErrorState('Failed to search', () => performSearch(query, page))
                );
            }
        }

        // Load sorted content
        async function loadSortedContent(sort) {
            ui.showSkeletonGrid('search-results');

            try {
                let response;
                switch (sort) {
                    case 'trending':
                        response = await api.getTrending({ type: currentType });
                        break;
                    case 'new':
                        response = await api.getNewReleases({ type: currentType });
                        break;
                    case 'rating':
                        response = await api.getCriticsChoice({ type: currentType });
                        break;
                    case 'admin':
                        response = await api.getAdminChoice({ type: currentType });
                        break;
                    default:
                        response = await api.getTrending({ type: currentType });
                }

                if (response.recommendations && response.recommendations.length > 0) {
                    ui.createContentGrid(response.recommendations, 'search-results');
                }
            } catch (error) {
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('search-results').appendChild(
                    ui.createErrorState('Failed to load content')
                );
            }
        }

        // Load default content (trending)
        async function loadDefaultContent() {
            ui.showSkeletonGrid('search-results');

            try {
                const response = await api.getTrending({ type: currentType });
                if (response.recommendations && response.recommendations.length > 0) {
                    ui.createContentGrid(response.recommendations, 'search-results');
                }
            } catch (error) {
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('search-results').appendChild(
                    ui.createErrorState('Failed to load trending content')
                );
            }
        }

        // Load recent searches
        function loadRecentSearches() {
            const searches = storage.getRecentSearches();
            if (searches.length === 0) return;

            document.getElementById('recent-searches').style.display = 'block';
            const container = document.getElementById('recent-searches-list');
            container.innerHTML = '';

            searches.forEach(search => {
                const chip = document.createElement('button');
                chip.className = 'btn btn-sm btn-outline-secondary';
                chip.textContent = search;
                chip.onclick = () => {
                    document.getElementById('search-input').value = search;
                    performSearch(search);
                };
                container.appendChild(chip);
            });
        }

        // Update pagination
        function updatePagination() {
            const container = document.getElementById('pagination-container');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '';
            container.appendChild(ui.createPagination(currentPage, totalPages, (page) => {
                performSearch(currentQuery, page);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }));
        }

        // Event listeners
        document.getElementById('search-btn').addEventListener('click', () => {
            const query = document.getElementById('search-input').value;
            performSearch(query);
        });

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(e.target.value);
            }
        });

        // Type filter buttons
        document.querySelectorAll('[data-type]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentType = btn.dataset.type;

                if (currentQuery) {
                    performSearch(currentQuery);
                } else {
                    loadDefaultContent();
                }
            });
        });

        // Initialize
        initializeSearch();
    </script>
</body>

</html>