<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Movie and TV Show Details - CineBrain">
  <title id="page-title">Loading... - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
  
  <!-- Preload -->
  <link rel="dns-prefetch" href="//backend-app-970m.onrender.com">
  <link rel="preconnect" href="https://backend-app-970m.onrender.com">
  <link rel="preconnect" href="https://image.tmdb.org">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <!-- Hero Section with Content Backdrop -->
      <section class="hero-section" id="content-hero" style="height: 60vh;">
        <div class="hero-backdrop">
          <img id="content-backdrop" src="" alt="" loading="eager">
        </div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="detail-layout">
            <div class="detail-hero">
              <div class="flex gap-6 items-start">
                <!-- Poster -->
                <div class="flex-shrink-0">
                  <img 
                    id="content-poster" 
                    src="" 
                    alt="" 
                    class="w-48 h-72 object-cover rounded-xl shadow-xl border-2 border-white/20"
                    loading="eager"
                  >
                </div>
                
                <!-- Content Info -->
                <div class="flex-1 text-white">
                  <h1 id="content-title" class="text-5xl font-bold mb-4 text-shadow">Loading...</h1>
                  
                  <div class="flex items-center gap-4 mb-6" id="content-meta">
                    <div class="rating-badge text-lg">
                      <span>‚≠ê</span>
                      <span id="content-rating">0.0</span>
                    </div>
                    <div class="type-badge" id="content-type">MOVIE</div>
                    <div class="badge badge-outline" id="content-year">2024</div>
                    <div class="badge badge-outline" id="content-runtime">120 min</div>
                  </div>
                  
                  <p id="content-overview" class="text-lg leading-relaxed mb-8 max-w-2xl opacity-90">
                    Loading content description...
                  </p>
                  
                  <div class="flex gap-4 mb-6" id="content-actions">
                    <button class="hero-btn hero-btn-primary" id="play-trailer-btn" onclick="playContentTrailer()">
                      ‚ñ∂Ô∏è Watch Trailer
                    </button>
                    <button class="hero-btn hero-btn-secondary" id="add-watchlist-btn" onclick="addToWatchlist()">
                      üìã Add to List
                    </button>
                    <button class="hero-btn hero-btn-secondary" id="add-favorite-btn" onclick="addToFavorites()">
                      ‚ù§Ô∏è Favorite
                    </button>
                    <button class="hero-btn hero-btn-secondary" onclick="shareContent()">
                      üîó Share
                    </button>
                  </div>
                  
                  <div id="content-genres" class="flex flex-wrap gap-2">
                    <!-- Real genres loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Content Details Section -->
      <section class="container py-12">
        <div class="detail-layout">
          <!-- Main Content -->
          <div class="detail-content">
            
            <!-- Cast & Crew -->
            <div class="content-section" id="cast-section">
              <h2 class="section-title">Cast & Crew</h2>
              <div class="carousel-wrapper">
                <div class="content-carousel" id="cast-carousel">
                  <div class="carousel-container">
                    <div class="carousel-track" id="cast-track">
                      <!-- Real cast data loaded here -->
                      <div class="loading-skeleton skeleton-card"></div>
                      <div class="loading-skeleton skeleton-card"></div>
                      <div class="loading-skeleton skeleton-card"></div>
                    </div>
                  </div>
                  <button class="carousel-btn carousel-prev" onclick="castCarousel.prev()">‚Äπ</button>
                  <button class="carousel-btn carousel-next" onclick="castCarousel.next()">‚Ä∫</button>
                </div>
              </div>
            </div>

            <!-- Similar Content -->
            <div class="content-section" id="similar-section">
              <h2 class="section-title">More Like This</h2>
              <div class="carousel-wrapper">
                <div class="content-carousel" id="similar-carousel">
                  <div class="carousel-container">
                    <div class="carousel-track" id="similar-track">
                      <!-- Real similar content loaded here -->
                      <div class="loading-skeleton skeleton-card"></div>
                      <div class="loading-skeleton skeleton-card"></div>
                      <div class="loading-skeleton skeleton-card"></div>
                    </div>
                  </div>
                  <button class="carousel-btn carousel-prev" onclick="similarCarousel.prev()">‚Äπ</button>
                  <button class="carousel-btn carousel-next" onclick="similarCarousel.next()">‚Ä∫</button>
                </div>
              </div>
            </div>

            <!-- User Reviews Section -->
            <div class="content-section" id="reviews-section">
              <h2 class="section-title">Reviews</h2>
              
              <!-- Add Review (Auth Users) -->
              <div id="add-review-section" style="display: none;" class="mb-8 p-6 bg-elevated rounded-xl">
                <h3 class="text-xl font-semibold mb-4">Write a Review</h3>
                <form id="review-form">
                  <div class="flex items-center gap-4 mb-4">
                    <span class="text-sm font-medium">Your Rating:</span>
                    <div class="rating-input" id="rating-input">
                      <button type="button" class="star-btn" data-rating="1">‚≠ê</button>
                      <button type="button" class="star-btn" data-rating="2">‚≠ê</button>
                      <button type="button" class="star-btn" data-rating="3">‚≠ê</button>
                      <button type="button" class="star-btn" data-rating="4">‚≠ê</button>
                      <button type="button" class="star-btn" data-rating="5">‚≠ê</button>
                    </div>
                    <span id="rating-text" class="text-sm text-muted">No rating</span>
                  </div>
                  <textarea 
                    name="review" 
                    placeholder="Share your thoughts about this content..."
                    class="form-input w-full h-24 mb-4"
                    maxlength="500"
                  ></textarea>
                  <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
              </div>

              <!-- Reviews List -->
              <div id="reviews-list">
                <div class="text-center py-8 text-muted">
                  <p>Reviews feature coming soon!</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="detail-sidebar">
            <div class="bg-elevated rounded-xl p-6 mb-6">
              <h3 class="text-lg font-semibold mb-4">Details</h3>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-muted">Release Date:</span>
                  <span id="release-date">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-muted">Runtime:</span>
                  <span id="runtime-detail">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-muted">Languages:</span>
                  <span id="languages">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-muted">Rating:</span>
                  <span id="rating-detail">-</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-muted">Votes:</span>
                  <span id="vote-count">-</span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-3">
              <button class="btn btn-primary w-full" onclick="playContentTrailer()">
                ‚ñ∂Ô∏è Watch Trailer
              </button>
              <button class="btn btn-outline w-full" id="watchlist-btn" onclick="toggleWatchlist()">
                üìã Add to Watchlist
              </button>
              <button class="btn btn-outline w-full" id="favorite-btn" onclick="toggleFavorite()">
                ‚ù§Ô∏è Add to Favorites
              </button>
            </div>

            <!-- Share Section -->
            <div class="bg-elevated rounded-xl p-6 mt-6">
              <h3 class="text-lg font-semibold mb-4">Share</h3>
              <div class="flex gap-2">
                <button class="btn btn-ghost flex-1 text-xs" onclick="shareToTwitter()">üê¶</button>
                <button class="btn btn-ghost flex-1 text-xs" onclick="shareToFacebook()">üë•</button>
                <button class="btn btn-ghost flex-1 text-xs" onclick="copyShareLink()">üîó</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let currentContent = null;
    let castCarousel, similarCarousel;
    let userRating = 0;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeDetailsPage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeDetailsPage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    async function initializeDetailsPage() {
      const contentId = getContentIdFromURL();
      
      if (!contentId) {
        showError('Content not found');
        return;
      }

      try {
        // Initialize carousels
        castCarousel = new ContentCarousel(document.getElementById('cast-carousel'));
        similarCarousel = new ContentCarousel(document.getElementById('similar-carousel'));
        
        // Load content details
        await loadContentDetails(contentId);
        
        // Setup rating system
        setupRatingSystem();
        
        // Setup auth-dependent features
        setupAuthFeatures();
        
        console.log('üé¨ Details page initialized for content:', contentId);
        
      } catch (error) {
        console.error('Details page initialization error:', error);
        showError('Failed to load content details');
      }
    }

    function getContentIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    async function loadContentDetails(contentId) {
      try {
        // Load main content details
        const content = await ContentAPI.getDetails(contentId);
        currentContent = content;
        
        // Update page with real content data
        updateContentDisplay(content);
        
        // Load similar content in parallel
        loadSimilarContent(contentId);
        
        // Record view interaction
        recordViewInteraction(contentId);
        
      } catch (error) {
        console.error('Content details error:', error);
        throw error;
      }
    }

    function updateContentDisplay(content) {
      // Update page title
      document.title = `${content.title} - CineBrain`;
      document.getElementById('page-title').textContent = `${content.title} - CineBrain`;
      
      // Update hero section
      document.getElementById('content-title').textContent = content.title;
      document.getElementById('content-overview').textContent = content.overview || 'No description available.';
      document.getElementById('content-rating').textContent = content.rating?.toFixed(1) || 'N/A';
      document.getElementById('content-type').textContent = content.content_type?.toUpperCase() || 'CONTENT';
      
      // Update images
      if (content.poster_path) {
        const posterUrl = content.poster_path.startsWith('http') 
          ? content.poster_path 
          : `https://image.tmdb.org/t/p/w500${content.poster_path}`;
        document.getElementById('content-poster').src = posterUrl;
        document.getElementById('content-poster').alt = content.title;
      }
      
      if (content.backdrop_path) {
        const backdropUrl = content.backdrop_path.startsWith('http') 
          ? content.backdrop_path 
          : `https://image.tmdb.org/t/p/w1280${content.backdrop_path}`;
        document.getElementById('content-backdrop').src = backdropUrl;
        document.getElementById('content-backdrop').alt = content.title;
      }
      
      // Update metadata
      if (content.release_date) {
        const year = new Date(content.release_date).getFullYear();
        document.getElementById('content-year').textContent = year;
        document.getElementById('release-date').textContent = new Date(content.release_date).toLocaleDateString();
      }
      
      if (content.runtime) {
        const hours = Math.floor(content.runtime / 60);
        const minutes = content.runtime % 60;
        const runtimeText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        document.getElementById('content-runtime').textContent = runtimeText;
        document.getElementById('runtime-detail').textContent = runtimeText;
      }
      
      // Update genres
      if (content.genres && content.genres.length > 0) {
        const genresContainer = document.getElementById('content-genres');
        genresContainer.innerHTML = content.genres.map(genre => 
          `<span class="genre-chip">${genre}</span>`
        ).join('');
      }
      
      // Update sidebar details
      if (content.languages) {
        document.getElementById('languages').textContent = content.languages.join(', ');
      }
      
      document.getElementById('rating-detail').textContent = content.rating?.toFixed(1) || 'N/A';
      document.getElementById('vote-count').textContent = content.vote_count?.toLocaleString() || 'N/A';
      
      // Update cast if available
      if (content.cast && content.cast.length > 0) {
        renderCastList(content.cast);
      }
    }

    function renderCastList(cast) {
      const castTrack = document.getElementById('cast-track');
      castTrack.innerHTML = '';
      
      cast.slice(0, 10).forEach(person => {
        const castCard = document.createElement('div');
        castCard.className = 'flex-shrink-0 w-32 text-center';
        
        const profileUrl = person.profile_path 
          ? `https://image.tmdb.org/t/p/w185${person.profile_path}`
          : `https://ui-avatars.com/api/?name=${encodeURIComponent(person.name)}&background=3b82f6&color=ffffff&size=185`;
        
        castCard.innerHTML = `
          <img src="${profileUrl}" alt="${person.name}" class="w-24 h-24 rounded-full mx-auto mb-2 object-cover">
          <h4 class="text-sm font-medium text-white">${person.name}</h4>
          <p class="text-xs text-muted">${person.character || person.job || 'Cast'}</p>
        `;
        
        castTrack.appendChild(castCard);
      });
      
      castCarousel.updateItems();
    }

    async function loadSimilarContent(contentId) {
      try {
        const similarData = await ContentAPI.getSimilar(contentId, 15);
        const similarContent = similarData.recommendations || similarData;
        
        if (similarContent && similarContent.length > 0) {
          renderSimilarContent(similarContent);
        } else {
          // Fallback to genre-based recommendations
          if (currentContent && currentContent.genres && currentContent.genres.length > 0) {
            const genreRecs = await API.get(`/recommendations/genre/${currentContent.genres[0]}`, { limit: 10 });
            renderSimilarContent(genreRecs.recommendations || []);
          }
        }
      } catch (error) {
        console.error('Similar content error:', error);
        document.getElementById('similar-track').innerHTML = '<div class="error-state"><p>Failed to load similar content</p></div>';
      }
    }

    function renderSimilarContent(content) {
      const similarTrack = document.getElementById('similar-track');
      similarTrack.innerHTML = '';
      
      content.forEach(item => {
        const card = app.createContentCard(item);
        similarTrack.appendChild(card);
      });
      
      similarCarousel.updateItems();
    }

    function setupRatingSystem() {
      const starButtons = document.querySelectorAll('.star-btn');
      const ratingText = document.getElementById('rating-text');
      
      starButtons.forEach((star, index) => {
        star.addEventListener('click', function() {
          userRating = index + 1;
          updateStarDisplay();
          ratingText.textContent = `${userRating} star${userRating !== 1 ? 's' : ''}`;
        });
        
        star.addEventListener('mouseenter', function() {
          highlightStars(index + 1);
        });
      });
      
      document.getElementById('rating-input').addEventListener('mouseleave', function() {
        updateStarDisplay();
      });
    }

    function highlightStars(rating) {
      const starButtons = document.querySelectorAll('.star-btn');
      starButtons.forEach((star, index) => {
        star.style.opacity = index < rating ? '1' : '0.3';
      });
    }

    function updateStarDisplay() {
      highlightStars(userRating);
    }

    function setupAuthFeatures() {
      if (Auth.isAuthenticated()) {
        document.getElementById('add-review-section').style.display = 'block';
        
        // Setup review form
        document.getElementById('review-form').addEventListener('submit', submitReview);
      }
    }

    async function submitReview(event) {
      event.preventDefault();
      
      if (!currentContent || !Auth.isAuthenticated()) return;
      
      const formData = new FormData(event.target);
      const reviewText = formData.get('review').trim();
      
      if (!userRating) {
        showToast('Please select a rating', 'warning');
        return;
      }
      
      if (!reviewText) {
        showToast('Please write a review', 'warning');
        return;
      }
      
      try {
        // Submit rating as interaction
        await Auth.recordInteraction(currentContent.id, 'rating', userRating);
        
        showToast('Review submitted successfully!', 'success');
        
        // Reset form
        event.target.reset();
        userRating = 0;
        updateStarDisplay();
        document.getElementById('rating-text').textContent = 'No rating';
        
      } catch (error) {
        console.error('Review submission error:', error);
        showToast('Failed to submit review', 'error');
      }
    }

    // Action handlers
    function playContentTrailer() {
      if (currentContent && currentContent.youtube_trailer) {
        app.trailerModal.show(currentContent.youtube_trailer, currentContent.title);
      } else {
        showToast('Trailer not available', 'warning');
      }
    }

    async function addToWatchlist() {
      if (!Auth.isAuthenticated()) {
        showToast('Please log in to add to watchlist', 'warning');
        window.location.href = '/auth/login.html';
        return;
      }
      
      if (currentContent) {
        await app.toggleWishlist(currentContent.id);
      }
    }

    async function addToFavorites() {
      if (!Auth.isAuthenticated()) {
        showToast('Please log in to add to favorites', 'warning');
        window.location.href = '/auth/login.html';
        return;
      }
      
      if (currentContent) {
        await app.toggleFavorite(currentContent.id);
      }
    }

    async function toggleWatchlist() {
      await addToWatchlist();
    }

    async function toggleFavorite() {
      await addToFavorites();
    }

    function shareContent() {
      if (navigator.share && currentContent) {
        navigator.share({
          title: currentContent.title,
          text: currentContent.overview,
          url: window.location.href
        });
      } else {
        copyShareLink();
      }
    }

    function shareToTwitter() {
      if (currentContent) {
        const text = `Check out "${currentContent.title}" on CineBrain!`;
        const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`;
        window.open(url, '_blank');
      }
    }

    function shareToFacebook() {
      const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`;
      window.open(url, '_blank');
    }

    function copyShareLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        showToast('Link copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    async function recordViewInteraction(contentId) {
      try {
        if (Auth.isAuthenticated()) {
          await Auth.recordInteraction(contentId, 'view');
        } else {
          // Record anonymous interaction
          await API.post('/analytics/anonymous-interaction', {
            content_id: contentId,
            interaction_type: 'view',
            timestamp: new Date().toISOString()
          });
        }
      } catch (error) {
        console.warn('Failed to record view interaction:', error);
      }
    }

    function showError(message) {
      document.getElementById('content-title').textContent = 'Error';
      document.getElementById('content-overview').textContent = message;
      showToast(message, 'error');
    }
  </script>
</body>
</html>