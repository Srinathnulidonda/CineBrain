<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Details - CineBrain</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body class="bg-gray-900 text-white">
    <!-- Fixed Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="pt-16 pb-20 md:pb-8">
        <!-- Loading State -->
        <div id="loadingState" class="container-fluid py-5">
            <div class="text-center">
                <div class="spinner-border text-danger mb-3" role="status">
                    <span class="visually-hidden">Loading content details...</span>
                </div>
                <h5 class="text-white">Loading content details...</h5>
            </div>
        </div>

        <!-- Content Details -->
        <div id="contentDetails" class="d-none">
            <!-- Hero Section -->
            <section class="position-relative" id="heroSection">
                <div class="hero-backdrop position-absolute top-0 start-0 w-100 h-100"
                    style="background-size: cover; background-position: center;">
                    <div class="position-absolute top-0 start-0 w-100 h-100"
                        style="background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.8) 100%);">
                    </div>
                </div>

                <div class="container-fluid position-relative" style="z-index: 10; min-height: 60vh;">
                    <div class="row align-items-center py-5">
                        <div class="col-md-4 text-center text-md-start mb-4 mb-md-0">
                            <img id="posterImage" src="" alt="" class="img-fluid rounded shadow-lg"
                                style="max-width: 300px; width: 100%;" onerror="this.src='${Utils.getImageUrl(null)}'">
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <h1 id="contentTitle" class="display-4 text-white fw-bold mb-2"></h1>
                                <p id="originalTitle" class="text-muted fs-5"></p>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-3 mb-4" id="contentMeta">
                                <!-- Meta information will be populated here -->
                            </div>

                            <p id="contentOverview" class="lead text-white mb-4"></p>

                            <div class="d-flex flex-wrap gap-3 mb-4" id="actionButtons">
                                <!-- Action buttons will be populated here -->
                            </div>

                            <div id="genresContainer" class="mb-4">
                                <!-- Genres will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Content Information Tabs -->
            <section class="container-fluid px-3 px-md-4 py-4">
                <ul class="nav nav-pills nav-fill glass-effect mb-4" id="contentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="pill"
                            data-bs-target="#overview" type="button" role="tab">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cast-tab" data-bs-toggle="pill" data-bs-target="#cast"
                            type="button" role="tab">Cast & Crew</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="similar-tab" data-bs-toggle="pill" data-bs-target="#similar"
                            type="button" role="tab">More Like This</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="pill" data-bs-target="#reviews"
                            type="button" role="tab">Reviews</button>
                    </li>
                </ul>

                <div class="tab-content" id="contentTabsContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card glass-effect border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="text-white mb-3">Synopsis</h5>
                                        <p id="fullOverview" class="text-white"></p>
                                    </div>
                                </div>

                                <!-- Trailer Section -->
                                <div class="card glass-effect border-0 mb-4" id="trailerSection" style="display: none;">
                                    <div class="card-body">
                                        <h5 class="text-white mb-3">Official Trailer</h5>
                                        <div class="video-player" id="trailerContainer">
                                            <!-- Trailer will be embedded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <!-- Content Details -->
                                <div class="card glass-effect border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="text-white mb-3">Details</h5>
                                        <div id="contentDetailsInfo">
                                            <!-- Detailed information will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="card glass-effect border-0">
                                    <div class="card-body">
                                        <h5 class="text-white mb-3">Quick Actions</h5>
                                        <div class="d-grid gap-2" id="quickActions">
                                            <!-- Quick action buttons will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cast & Crew Tab -->
                    <div class="tab-pane fade" id="cast" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h5 class="text-white mb-3">Cast</h5>
                                <div id="castList">
                                    <!-- Cast will be populated here -->
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5 class="text-white mb-3">Crew</h5>
                                <div id="crewList">
                                    <!-- Crew will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Similar Content Tab -->
                    <div class="tab-pane fade" id="similar" role="tabpanel">
                        <div class="row" id="similarContent">
                            <!-- Similar content will be populated here -->
                        </div>
                    </div>

                    <!-- Reviews Tab -->
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div id="reviewsContent">
                            <div class="text-center py-4">
                                <i class="fas fa-star text-muted mb-3" style="font-size: 3rem;"></i>
                                <h5 class="text-white mb-2">Reviews Coming Soon</h5>
                                <p class="text-muted">User reviews and ratings will be available in future updates.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Error State -->
        <div id="errorState" class="d-none">
            <div class="container-fluid py-5">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 4rem;"></i>
                    <h4 class="text-white mb-3">Content Not Found</h4>
                    <p class="text-muted mb-4">The content you're looking for doesn't exist or has been removed.</p>
                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-primary-custom" onclick="window.history.back()">
                            <i class="fas fa-arrow-left me-2"></i>Go Back
                        </button>
                        <a href="../index.html" class="btn btn-secondary-custom">
                            <i class="fas fa-home me-2"></i>Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        class ContentDetailsHandler {
            constructor() {
                this.contentId = null;
                this.contentData = null;
                this.init();
            }

            init() {
                // Get content ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.contentId = urlParams.get('id');

                if (!this.contentId) {
                    this.showErrorState();
                    return;
                }

                this.loadContentDetails();
            }

            async loadContentDetails() {
                try {
                    this.contentData = await apiClient.getContentDetails(this.contentId);

                    // Record view interaction
                    this.recordViewInteraction();

                    this.renderContentDetails();
                    this.loadSimilarContent();
                    this.showContentState();

                } catch (error) {
                    console.error('Failed to load content details:', error);
                    this.showErrorState();
                }
            }

            async recordViewInteraction() {
                try {
                    if (Utils.getStorage('auth_token')) {
                        await apiClient.recordInteraction(this.contentId, 'view');
                    }
                } catch (error) {
                    console.warn('Failed to record interaction:', error);
                }
            }

            renderContentDetails() {
                const content = this.contentData;

                // Update page title
                document.title = `${content.title} - CineBrain`;

                // Hero section
                this.renderHeroSection(content);

                // Overview tab
                this.renderOverviewTab(content);

                // Cast & Crew tab
                this.renderCastAndCrew(content);

                // Content details sidebar
                this.renderContentDetailsInfo(content);

                // Quick actions
                this.renderQuickActions(content);
            }

            renderHeroSection(content) {
                // Backdrop
                if (content.backdrop_path) {
                    const heroBackdrop = document.querySelector('.hero-backdrop');
                    heroBackdrop.style.backgroundImage = `url('${Utils.getImageUrl(content.backdrop_path, 'w1280')}')`;
                }

                // Poster
                document.getElementById('posterImage').src = Utils.getImageUrl(content.poster_path, 'w500');
                document.getElementById('posterImage').alt = content.title;

                // Title
                document.getElementById('contentTitle').textContent = content.title;

                if (content.original_title && content.original_title !== content.title) {
                    document.getElementById('originalTitle').textContent = content.original_title;
                } else {
                    document.getElementById('originalTitle').style.display = 'none';
                }

                // Meta information
                this.renderContentMeta(content);

                // Overview
                document.getElementById('contentOverview').textContent =
                    Utils.truncateText(content.overview, 200) || 'No overview available.';

                // Action buttons
                this.renderActionButtons(content);

                // Genres
                this.renderGenres(content);
            }

            renderContentMeta(content) {
                const metaContainer = document.getElementById('contentMeta');
                const metaItems = [];

                // Rating
                if (content.rating) {
                    const ratingInfo = Utils.formatRating(content.rating);
                    metaItems.push(`<span class="${ratingInfo.className}">${ratingInfo.value}</span>`);
                }

                // Content type
                metaItems.push(`<span class="type-badge">${Utils.formatContentType(content.content_type)}</span>`);

                // Release date
                if (content.release_date) {
                    metaItems.push(`<span class="text-muted">${Utils.formatDate(content.release_date)}</span>`);
                }

                // Runtime (for movies)
                if (content.runtime) {
                    const hours = Math.floor(content.runtime / 60);
                    const minutes = content.runtime % 60;
                    metaItems.push(`<span class="text-muted">${hours}h ${minutes}m</span>`);
                }

                // Languages
                if (content.languages && content.languages.length > 0) {
                    metaItems.push(`<span class="text-muted">${content.languages.slice(0, 2).join(', ')}</span>`);
                }

                metaContainer.innerHTML = metaItems.join('');
            }

            renderActionButtons(content) {
                const buttonsContainer = document.getElementById('actionButtons');
                const buttons = [];

                // Watch Trailer button
                if (content.youtube_trailer) {
                    const youtubeId = Utils.extractYouTubeId(content.youtube_trailer);
                    buttons.push(`
                        <button class="btn btn-primary-custom btn-lg" 
                                onclick="this.openTrailerEmbed('${youtubeId}')">
                            <i class="fas fa-play me-2"></i>Watch Trailer
                        </button>
                    `);
                }

                // Add to Watchlist
                buttons.push(`
                    <button class="btn btn-secondary-custom btn-lg" 
                            onclick="Components.addToWatchlist(${content.id})">
                        <i class="fas fa-plus me-2"></i>Add to Watchlist
                    </button>
                `);

                // Add to Favorites
                buttons.push(`
                    <button class="btn btn-outline-light btn-lg" 
                            onclick="Components.addToFavorites(${content.id})">
                        <i class="fas fa-heart me-2"></i>Favorite
                    </button>
                `);

                buttonsContainer.innerHTML = buttons.join('');
            }

            renderGenres(content) {
                const genresContainer = document.getElementById('genresContainer');
                if (content.genres && content.genres.length > 0) {
                    const genresHtml = content.genres.map(genre =>
                        `<span class="genre-chip me-2 mb-2">${genre}</span>`
                    ).join('');
                    genresContainer.innerHTML = genresHtml;
                } else {
                    genresContainer.style.display = 'none';
                }
            }

            renderOverviewTab(content) {
                document.getElementById('fullOverview').textContent =
                    content.overview || 'No detailed synopsis available for this content.';

                // Show trailer in overview if available
                if (content.youtube_trailer) {
                    const trailerSection = document.getElementById('trailerSection');
                    trailerSection.style.display = 'block';

                    const youtubeId = Utils.extractYouTubeId(content.youtube_trailer);
                    document.getElementById('trailerContainer').innerHTML = `
                        <iframe src="https://www.youtube.com/embed/${youtubeId}?rel=0" 
                                allowfullscreen allow="autoplay"></iframe>
                    `;
                }
            }

            renderCastAndCrew(content) {
                // Cast
                const castContainer = document.getElementById('castList');
                if (content.cast && content.cast.length > 0) {
                    const castHtml = content.cast.map(member => `
                        <div class="d-flex align-items-center mb-3 p-3 glass-effect rounded">
                            <img src="${member.profile_path ? `https://image.tmdb.org/t/p/w185${member.profile_path}` : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(member.name || 'Unknown') + '&background=374151&color=fff'}" 
                                 alt="${member.name || 'Unknown'}" class="rounded-circle me-3" width="60" height="60"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(member.name || 'Unknown')}&background=374151&color=fff'">
                            <div>
                                <h6 class="text-white mb-1">${member.name || 'Unknown'}</h6>
                                <p class="text-muted mb-0 small">${member.character || member.job || 'Cast Member'}</p>
                            </div>
                        </div>
                    `).join('');
                    castContainer.innerHTML = castHtml;
                } else {
                    castContainer.innerHTML = '<p class="text-muted">Cast information not available.</p>';
                }

                // Crew
                const crewContainer = document.getElementById('crewList');
                if (content.crew && content.crew.length > 0) {
                    const crewHtml = content.crew.map(member => `
                        <div class="d-flex align-items-center mb-3 p-3 glass-effect rounded">
                            <img src="${member.profile_path ? `https://image.tmdb.org/t/p/w185${member.profile_path}` : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(member.name || 'Unknown') + '&background=374151&color=fff'}" 
                                 alt="${member.name || 'Unknown'}" class="rounded-circle me-3" width="60" height="60"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(member.name || 'Unknown')}&background=374151&color=fff'">
                            <div>
                                <h6 class="text-white mb-1">${member.name || 'Unknown'}</h6>
                                <p class="text-muted mb-0 small">${member.job || 'Crew Member'}</p>
                            </div>
                        </div>
                    `).join('');
                    crewContainer.innerHTML = crewHtml;
                } else {
                    crewContainer.innerHTML = '<p class="text-muted">Crew information not available.</p>';
                }
            }

            renderContentDetailsInfo(content) {
                const detailsContainer = document.getElementById('contentDetailsInfo');
                const details = [];

                if (content.content_type) {
                    details.push(`<p><strong>Type:</strong> ${Utils.formatContentType(content.content_type)}</p>`);
                }

                if (content.release_date) {
                    details.push(`<p><strong>Release Date:</strong> ${new Date(content.release_date).toLocaleDateString()}</p>`);
                }

                if (content.runtime) {
                    const hours = Math.floor(content.runtime / 60);
                    const minutes = content.runtime % 60;
                    details.push(`<p><strong>Runtime:</strong> ${hours}h ${minutes}m</p>`);
                }

                if (content.vote_count) {
                    details.push(`<p><strong>Vote Count:</strong> ${content.vote_count.toLocaleString()}</p>`);
                }

                if (content.languages && content.languages.length > 0) {
                    details.push(`<p><strong>Languages:</strong> ${content.languages.join(', ')}</p>`);
                }

                if (content.tmdb_id) {
                    details.push(`<p><strong>TMDB ID:</strong> ${content.tmdb_id}</p>`);
                }

                if (content.mal_id) {
                    details.push(`<p><strong>MAL ID:</strong> ${content.mal_id}</p>`);
                }

                detailsContainer.innerHTML = details.length > 0 ? details.join('') : '<p class="text-muted">No additional details available.</p>';
            }

            renderQuickActions(content) {
                const actionsContainer = document.getElementById('quickActions');
                const actions = [
                    `<button class="btn btn-outline-light" onclick="Components.addToWatchlist(${content.id})">
                        <i class="fas fa-bookmark me-2"></i>Add to Watchlist
                    </button>`,
                    `<button class="btn btn-outline-light" onclick="Components.addToFavorites(${content.id})">
                        <i class="fas fa-heart me-2"></i>Add to Favorites
                    </button>`,
                    `<button class="btn btn-outline-light" onclick="this.shareContent()">
                        <i class="fas fa-share me-2"></i>Share
                    </button>`
                ];

                actionsContainer.innerHTML = actions.join('');
            }

            async loadSimilarContent() {
                try {
                    const similar = await apiClient.getSimilarRecommendations(this.contentId, 12);
                    this.renderSimilarContent(similar.recommendations || []);
                } catch (error) {
                    console.error('Failed to load similar content:', error);
                    document.getElementById('similarContent').innerHTML =
                        '<div class="col-12"><p class="text-muted text-center">Similar content not available.</p></div>';
                }
            }

            renderSimilarContent(similarContent) {
                const container = document.getElementById('similarContent');

                if (!similarContent || similarContent.length === 0) {
                    container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No similar content found.</p></div>';
                    return;
                }

                const similarHtml = similarContent.map(item => `
                    <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                        ${Components.createContentCard(item)}
                    </div>
                `).join('');

                container.innerHTML = similarHtml;
            }

            openTrailerEmbed(youtubeId) {
                Components.openTrailer(youtubeId, this.contentData.title);
            }

            shareContent() {
                if (navigator.share) {
                    navigator.share({
                        title: this.contentData.title,
                        text: `Check out ${this.contentData.title} on CineBrain`,
                        url: window.location.href
                    });
                } else {
                    // Fallback to clipboard
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        Utils.showToast('Link copied to clipboard!', 'success');
                    });
                }
            }

            showContentState() {
                document.getElementById('loadingState').classList.add('d-none');
                document.getElementById('errorState').classList.add('d-none');
                document.getElementById('contentDetails').classList.remove('d-none');
            }

            showErrorState() {
                document.getElementById('loadingState').classList.add('d-none');
                document.getElementById('contentDetails').classList.add('d-none');
                document.getElementById('errorState').classList.remove('d-none');
            }
        }

        // Initialize content details handler
        document.addEventListener('DOMContentLoaded', () => {
            window.contentDetailsHandler = new ContentDetailsHandler();
        });
    </script>
</body>

</html>