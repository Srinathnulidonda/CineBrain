<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Details - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="content-details" id="contentDetails">
                <!-- Loading skeleton -->
                <div class="content-details__backdrop">
                    <div class="skeleton" style="height: 100%;"></div>
                </div>
                <div class="container">
                    <div class="content-details__main">
                        <div class="content-details__header">
                            <div class="skeleton" style="height: 450px; border-radius: var(--border-radius-lg);"></div>
                            <div>
                                <div class="skeleton mb-md" style="height: 40px; width: 300px;"></div>
                                <div class="skeleton mb-md" style="height: 20px; width: 200px;"></div>
                                <div class="skeleton" style="height: 100px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item" id="mobileWatchlistItem">
                    <a href="/auth/login.html" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item" id="mobileProfileItem">
                    <a href="/auth/login.html" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Trailer Modal -->
    <div class="modal" id="trailerModal">
        <div class="modal__content" style="max-width: 900px;">
            <div class="modal__header">
                <h3 class="modal__title">Trailer</h3>
                <button class="modal__close" onclick="closeTrailerModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal__body p-0">
                <div class="ratio ratio-16x9">
                    <iframe id="trailerIframe" src="" frameborder="0" allowfullscreen
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        let currentContent = null;
        let isInWatchlist = false;
        let isInFavorites = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Update navigation
            updateNavigation();

            // Get content ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');

            if (!contentId) {
                window.location.href = '/';
                return;
            }

            // Load content details
            await loadContentDetails(contentId);

            // Check user lists if authenticated
            if (auth.isAuthenticated()) {
                checkUserLists();
            }
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const mobileWatchlistItem = document.getElementById('mobileWatchlistItem');
            const mobileProfileItem = document.getElementById('mobileProfileItem');

            if (auth.isAuthenticated()) {
                const user = auth.getUser();
                navbarUser.innerHTML = `
                    <a href="${auth.getUserUrl('watchlist')}" class="navbar__link">
                        <i class="bi bi-bookmark"></i>
                    </a>
                    <a href="${auth.getUserUrl('favorites')}" class="navbar__link">
                        <i class="bi bi-heart"></i>
                    </a>
                    <div class="navbar__avatar">
                        <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                    </div>
                `;

                mobileWatchlistItem.innerHTML = `
                    <a href="${auth.getUserUrl('watchlist')}" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                `;

                mobileProfileItem.innerHTML = `
                    <a href="${auth.getUserUrl('profile')}" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                `;
            } else {
                navbarUser.innerHTML = `
                    <a href="/auth/login.html" class="btn btn-primary">Sign In</a>
                `;
            }
        }

        async function loadContentDetails(contentId) {
            try {
                // Fetch content details
                currentContent = await api.getContentDetails(contentId);

                // Update page title
                document.title = `${currentContent.title} - CineScope`;

                // Render content
                renderContentDetails();

                // Load similar content
                loadSimilarContent();

                // Record view interaction if authenticated
                if (auth.isAuthenticated()) {
                    api.recordInteraction(contentId, Config.INTERACTIONS.VIEW);
                }

                // Add to recently viewed
                Storage.addToRecentlyViewed(currentContent);

            } catch (error) {
                console.error('Failed to load content details:', error);
                showToast('Failed to load content details', 'error');
            }
        }

        function renderContentDetails() {
            const detailsContainer = document.getElementById('contentDetails');

            // Format backdrop URL
            const backdropUrl = currentContent.backdrop_path || currentContent.poster_path;

            detailsContainer.innerHTML = `
                <!-- Backdrop -->
                <div class="content-details__backdrop">
                    ${backdropUrl ? `
                        <img src="${backdropUrl}" 
                             alt="${currentContent.title}" 
                             class="content-details__backdrop-image">
                    ` : ''}
                    <div class="content-details__backdrop-gradient"></div>
                </div>
                
                <div class="container">
                    <div class="content-details__main animate-fadeInUp">
                        <!-- Header -->
                        <div class="content-details__header">
                            <!-- Poster -->
                            <div class="content-details__poster">
                                <img src="${currentContent.poster_path || '/assets/images/placeholder-poster.jpg'}" 
                                     alt="${currentContent.title}">
                            </div>
                            
                            <!-- Info -->
                            <div class="content-details__info">
                                <!-- Badges -->
                                <div class="content-details__badges">
                                    ${currentContent.is_new_release ? '<span class="content-card__badge">NEW RELEASE</span>' : ''}
                                    ${currentContent.is_critics_choice ? '<span class="content-card__badge">CRITICS CHOICE</span>' : ''}
                                    ${currentContent.is_trending ? '<span class="content-card__badge">TRENDING</span>' : ''}
                                </div>
                                
                                <h1>${currentContent.title}</h1>
                                ${currentContent.original_title && currentContent.original_title !== currentContent.title ?
                    `<p class="text-muted mb-md">${currentContent.original_title}</p>` : ''}
                                
                                <!-- Meta Info -->
                                <div class="content-details__meta">
                                    <span class="content-card__rating">
                                        <i class="bi bi-star-fill content-card__rating-star"></i>
                                        ${currentContent.rating || 'N/A'}
                                    </span>
                                    ${currentContent.vote_count ? `<span>${currentContent.vote_count.toLocaleString()} votes</span>` : ''}
                                    ${currentContent.release_date ? `<span>${new Date(currentContent.release_date).getFullYear()}</span>` : ''}
                                    ${currentContent.runtime ? `<span>${formatRuntime(currentContent.runtime)}</span>` : ''}
                                    <span>${currentContent.content_type.toUpperCase()}</span>
                                </div>
                                
                                <!-- Genres -->
                                ${currentContent.genres && currentContent.genres.length > 0 ? `
                                    <div class="content-details__genres">
                                        ${currentContent.genres.map(genre => `
                                            <a href="/content/genre.html?genre=${encodeURIComponent(genre.toLowerCase())}" 
                                               class="filter-chip">${genre}</a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                <!-- Languages -->
                                ${currentContent.languages && currentContent.languages.length > 0 ? `
                                    <p class="text-sm text-muted mb-lg">
                                        <i class="bi bi-translate"></i> 
                                        ${currentContent.languages.join(', ')}
                                    </p>
                                ` : ''}
                                
                                <!-- Actions -->
                                <div class="content-details__actions">
                                    <button class="btn btn-primary" onclick="playContent()">
                                        <i class="bi bi-play-fill"></i> Play Now
                                    </button>
                                    ${currentContent.youtube_trailer ? `
                                        <button class="btn btn-secondary" onclick="playTrailer('${currentContent.youtube_trailer}')">
                                            <i class="bi bi-play-circle"></i> Watch Trailer
                                        </button>
                                    ` : ''}
                                    ${auth.isAuthenticated() ? `
                                        <button class="btn btn-secondary" onclick="toggleWatchlist()" id="watchlistBtn">
                                            <i class="bi bi-bookmark${isInWatchlist ? '-fill' : ''}"></i> 
                                            <span>${isInWatchlist ? 'In Watchlist' : 'Add to Watchlist'}</span>
                                        </button>
                                        <button class="btn btn-secondary" onclick="toggleFavorite()" id="favoriteBtn">
                                            <i class="bi bi-heart${isInFavorites ? '-fill' : ''}"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-secondary" onclick="shareContent()">
                                        <i class="bi bi-share"></i>
                                    </button>
                                </div>
                                
                                <!-- Overview -->
                                ${currentContent.overview ? `
                                    <div class="mt-xl">
                                        <h3 class="mb-md">Synopsis</h3>
                                        <p class="text-secondary">${currentContent.overview}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Additional Sections -->
                        <div class="content-details__sections">
                            <!-- Cast -->
                            ${currentContent.cast && currentContent.cast.length > 0 ? `
                                <section>
                                    <h3 class="mb-lg">Cast</h3>
                                    <div class="d-flex gap-lg overflow-x-auto pb-md">
                                        ${currentContent.cast.slice(0, 10).map(person => `
                                            <div class="text-center" style="min-width: 120px;">
                                                <div class="rounded-full overflow-hidden mb-sm mx-auto" style="width: 80px; height: 80px;">
                                                    <img src="${person.profile_path ? `https://image.tmdb.org/t/p/w185${person.profile_path}` : '/assets/images/default-avatar.png'}" 
                                                         alt="${person.name}"
                                                         class="w-100 h-100 object-cover">
                                                </div>
                                                <p class="font-weight-semibold text-sm mb-xs">${person.name}</p>
                                                <p class="text-xs text-muted">${person.character || person.role || ''}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </section>
                            ` : ''}
                            
                            <!-- Similar Content -->
                            <section>
                                <h3 class="mb-lg">You Might Also Like</h3>
                                <div class="content-grid content-grid--movies" id="similarContent">
                                    <!-- Dynamic content -->
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadSimilarContent() {
            try {
                const similar = currentContent.similar_content || [];
                const similarGrid = document.getElementById('similarContent');

                if (similar.length === 0) {
                    // Fetch from API if not included
                    const response = await api.getSimilarContent(currentContent.id);
                    similar.push(...response.recommendations);
                }

                similarGrid.innerHTML = similar.slice(0, 6).map(item => `
                    <div class="content-card" onclick="navigateToContentDetails(${item.id})">
                        <div class="content-card__image-wrapper">
                            <img src="${item.poster_path}" 
                                 alt="${item.title}" 
                                 class="content-card__image"
                                 loading="lazy">
                        </div>
                        <div class="content-card__body">
                            <h3 class="content-card__title">${item.title}</h3>
                            <div class="content-card__meta">
                                <span class="content-card__rating">
                                    <i class="bi bi-star-fill content-card__rating-star"></i>
                                    ${item.rating || 'N/A'}
                                </span>
                                <span>${item.content_type}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load similar content:', error);
            }
        }

        async function checkUserLists() {
            try {
                // Check watchlist
                const watchlistResponse = await api.getWatchlist();
                isInWatchlist = watchlistResponse.watchlist.some(item => item.id === currentContent.id);

                // Check favorites
                const favoritesResponse = await api.getFavorites();
                isInFavorites = favoritesResponse.favorites.some(item => item.id === currentContent.id);

                // Update buttons
                updateListButtons();
            } catch (error) {
                console.error('Failed to check user lists:', error);
            }
        }

        function updateListButtons() {
            const watchlistBtn = document.getElementById('watchlistBtn');
            const favoriteBtn = document.getElementById('favoriteBtn');

            if (watchlistBtn) {
                const icon = watchlistBtn.querySelector('i');
                const text = watchlistBtn.querySelector('span');
                icon.className = `bi bi-bookmark${isInWatchlist ? '-fill' : ''}`;
                text.textContent = isInWatchlist ? 'In Watchlist' : 'Add to Watchlist';
            }

            if (favoriteBtn) {
                const icon = favoriteBtn.querySelector('i');
                icon.className = `bi bi-heart${isInFavorites ? '-fill' : ''}`;
            }
        }

        async function toggleWatchlist() {
            try {
                if (isInWatchlist) {
                    // Remove from watchlist
                    await api.recordInteraction(currentContent.id, 'remove_watchlist');
                    isInWatchlist = false;
                    showToast('Removed from watchlist', 'success');
                } else {
                    // Add to watchlist
                    await api.recordInteraction(currentContent.id, Config.INTERACTIONS.WATCHLIST);
                    isInWatchlist = true;
                    showToast('Added to watchlist', 'success');
                }
                updateListButtons();
            } catch (error) {
                showToast('Failed to update watchlist', 'error');
            }
        }

        async function toggleFavorite() {
            try {
                if (isInFavorites) {
                    // Remove from favorites
                    await api.recordInteraction(currentContent.id, 'remove_favorite');
                    isInFavorites = false;
                    showToast('Removed from favorites', 'success');
                } else {
                    // Add to favorites
                    await api.recordInteraction(currentContent.id, Config.INTERACTIONS.FAVORITE);
                    isInFavorites = true;
                    showToast('Added to favorites', 'success');
                }
                updateListButtons();
            } catch (error) {
                showToast('Failed to update favorites', 'error');
            }
        }

        function playContent() {
            // In production, this would integrate with video player
            showToast('Video player coming soon!', 'info');
        }

        function playTrailer(youtubeUrl) {
            const modal = document.getElementById('trailerModal');
            const iframe = document.getElementById('trailerIframe');

            // Extract video ID
            const videoId = youtubeUrl.includes('watch?v=')
                ? youtubeUrl.split('watch?v=')[1].split('&')[0]
                : youtubeUrl.split('/').pop();

            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            modal.classList.add('modal--open');
        }

        function closeTrailerModal() {
            const modal = document.getElementById('trailerModal');
            const iframe = document.getElementById('trailerIframe');

            modal.classList.remove('modal--open');
            setTimeout(() => {
                iframe.src = '';
            }, 300);
        }

        function shareContent() {
            if (navigator.share) {
                navigator.share({
                    title: currentContent.title,
                    text: `Check out ${currentContent.title} on CineScope!`,
                    url: window.location.href
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(window.location.href);
                showToast('Link copied to clipboard!', 'success');
            }
        }

        function formatRuntime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }

        // Close modal on click outside
        document.getElementById('trailerModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeTrailerModal();
            }
        });
    </script>
</body>

</html>