<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Details - CineBrain</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Detailed information about movies, TV shows, and anime on CineBrain">
    <meta name="keywords" content="movie details, tv show info, anime details, cast, crew, ratings">

    <!-- Open Graph -->
    <meta property="og:title" content="Content Details - CineBrain">
    <meta property="og:description" content="Get detailed information about your favorite content">
    <meta property="og:type" content="article">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- CSS Files -->
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/layouts.css" rel="stylesheet">
    <link href="/css/animations.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
</head>

<body data-page="content-details">

    <!-- Navigation -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Content Loading State -->
        <div class="loading-container d-flex align-items-center justify-content-center" style="min-height: 60vh;">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading content...</span>
                </div>
                <p class="text-muted">Loading content details...</p>
            </div>
        </div>

        <!-- Content Details Container -->
        <div class="content-details-container d-none">

            <!-- Hero Section with Backdrop -->
            <section class="content-hero position-relative overflow-hidden">
                <div class="hero-backdrop position-absolute top-0 start-0 w-100 h-100">
                    <img src="" alt="" class="w-100 h-100 object-fit-cover backdrop-image">
                    <div class="backdrop-overlay position-absolute top-0 start-0 w-100 h-100 bg-black bg-opacity-60">
                    </div>
                </div>

                <div class="container position-relative py-5" style="z-index: 2;">
                    <div class="row align-items-center min-vh-75">

                        <!-- Poster Column -->
                        <div class="col-lg-4 col-md-5 mb-4 mb-md-0">
                            <div class="poster-container position-relative">
                                <img src="" alt="" class="poster-image w-100 rounded-3 shadow-lg">

                                <!-- Play Trailer Button Overlay -->
                                <div
                                    class="poster-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-black bg-opacity-50 opacity-0 rounded-3 transition-opacity">
                                    <button class="btn btn-primary btn-lg rounded-circle play-trailer-hero"
                                        data-video-id="" data-title="">
                                        <i class="bi bi-play-fill fs-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Details Column -->
                        <div class="col-lg-8 col-md-7">
                            <div class="content-info text-white">

                                <!-- Title and Type -->
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="content-type-badge me-3"></span>
                                        <div class="content-rating-badge"></div>
                                    </div>
                                    <h1 class="content-title display-4 fw-bold mb-2"></h1>
                                    <p class="content-original-title text-muted fs-5 mb-0"></p>
                                </div>

                                <!-- Meta Information -->
                                <div class="content-meta row g-3 mb-4">
                                    <div class="col-auto">
                                        <small class="text-muted d-block">Release Date</small>
                                        <span class="content-release-date fw-semibold"></span>
                                    </div>
                                    <div class="col-auto">
                                        <small class="text-muted d-block">Runtime</small>
                                        <span class="content-runtime fw-semibold"></span>
                                    </div>
                                    <div class="col-auto">
                                        <small class="text-muted d-block">Rating</small>
                                        <span class="content-rating fw-semibold"></span>
                                    </div>
                                </div>

                                <!-- Genres -->
                                <div class="content-genres-container mb-4"></div>

                                <!-- Overview -->
                                <div class="content-overview mb-4">
                                    <h5 class="mb-3">Overview</h5>
                                    <p class="lead content-overview-text"></p>
                                </div>

                                <!-- Action Buttons -->
                                <div class="content-actions d-flex flex-wrap gap-3">
                                    <button class="btn btn-primary btn-lg add-to-watchlist" data-content-id="">
                                        <i class="bi bi-bookmark me-2"></i>Add to Watchlist
                                    </button>
                                    <button class="btn btn-outline-danger btn-lg add-to-favorites" data-content-id="">
                                        <i class="bi bi-heart me-2"></i>Add to Favorites
                                    </button>
                                    <button class="btn btn-outline-light btn-lg play-trailer" data-video-id=""
                                        data-title="" style="display: none;">
                                        <i class="bi bi-play-circle me-2"></i>Watch Trailer
                                    </button>
                                    <button class="btn btn-outline-info btn-lg share-content" data-content-id="">
                                        <i class="bi bi-share me-2"></i>Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Content Sections -->
            <div class="container py-5">

                <!-- Cast and Crew Section -->
                <section class="cast-crew-section mb-5">
                    <h2 class="text-white fw-bold mb-4">
                        <i class="bi bi-people me-2"></i>Cast & Crew
                    </h2>

                    <!-- Cast Tabs -->
                    <ul class="nav nav-pills mb-4" id="castTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cast-tab" data-bs-toggle="pill"
                                data-bs-target="#cast">Cast</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="crew-tab" data-bs-toggle="pill"
                                data-bs-target="#crew">Crew</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="castTabContent">
                        <!-- Cast Tab -->
                        <div class="tab-pane fade show active" id="cast" role="tabpanel">
                            <div class="cast-container horizontal-scroll">
                                <!-- Dynamic cast cards -->
                            </div>
                        </div>

                        <!-- Crew Tab -->
                        <div class="tab-pane fade" id="crew" role="tabpanel">
                            <div class="crew-container horizontal-scroll">
                                <!-- Dynamic crew cards -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- User Reviews Section -->
                <section class="reviews-section mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="text-white fw-bold mb-0">
                            <i class="bi bi-chat-square-text me-2"></i>User Reviews
                        </h2>
                        <button class="btn btn-outline-primary auth-required d-none" data-bs-toggle="modal"
                            data-bs-target="#reviewModal">
                            <i class="bi bi-pencil me-2"></i>Write Review
                        </button>
                    </div>

                    <!-- Reviews Container -->
                    <div class="reviews-container">
                        <!-- Dynamic reviews -->
                    </div>

                    <!-- Load More Reviews -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-light load-more-reviews d-none">
                            Load More Reviews
                        </button>
                    </div>
                </section>

                <!-- Similar Content Section -->
                <section class="similar-content-section mb-5">
                    <h2 class="text-white fw-bold mb-4">
                        <i class="bi bi-collection me-2"></i>Similar Content
                    </h2>

                    <div class="similar-content-container horizontal-scroll">
                        <!-- Dynamic similar content cards -->
                    </div>
                </section>

                <!-- Recommendations Section -->
                <section class="recommendations-section">
                    <h2 class="text-white fw-bold mb-4">
                        <i class="bi bi-brain me-2"></i>You Might Also Like
                    </h2>

                    <div class="recommendations-container content-grid">
                        <!-- Dynamic recommendation cards -->
                    </div>
                </section>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-container d-none">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center py-5">
                        <i class="bi bi-exclamation-triangle text-warning fs-1 mb-4"></i>
                        <h2 class="text-white mb-3">Content Not Found</h2>
                        <p class="text-muted mb-4">The content you're looking for doesn't exist or has been removed.</p>
                        <a href="/" class="btn btn-primary">
                            <i class="bi bi-house me-2"></i>Go Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-theater border-royal">
                <div class="modal-header border-royal">
                    <h5 class="modal-title text-white" id="reviewModalLabel">Write a Review</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reviewForm">
                        <!-- Rating Selection -->
                        <div class="mb-3">
                            <label class="form-label text-white">Your Rating</label>
                            <div class="rating-input d-flex gap-1 mb-2">
                                <button type="button" class="btn btn-outline-warning star-btn" data-rating="1">
                                    <i class="bi bi-star"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning star-btn" data-rating="2">
                                    <i class="bi bi-star"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning star-btn" data-rating="3">
                                    <i class="bi bi-star"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning star-btn" data-rating="4">
                                    <i class="bi bi-star"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning star-btn" data-rating="5">
                                    <i class="bi bi-star"></i>
                                </button>
                            </div>
                            <input type="hidden" id="userRating" value="0">
                        </div>

                        <!-- Review Text -->
                        <div class="mb-3">
                            <label for="reviewText" class="form-label text-white">Your Review</label>
                            <textarea class="form-control bg-velvet border-royal text-white" id="reviewText" rows="4"
                                placeholder="Share your thoughts about this content..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-royal">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary submit-review">Submit Review</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trailer Modal Container -->
    <div id="trailer-modal-container"></div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>

    <script>
        // Content Details Page Controller
        class ContentDetailsPage {
            constructor() {
                this.contentId = null;
                this.contentData = null;
                this.userRating = 0;
                this.reviewsPage = 1;
                this.reviewsPerPage = 10;
                this.initialize();
            }

            async initialize() {
                try {
                    // Get content ID from URL
                    this.contentId = this.getContentIdFromURL();

                    if (!this.contentId) {
                        this.showError();
                        return;
                    }

                    // Load navigation components
                    await this.loadComponents();

                    // Load content details
                    await this.loadContentDetails();

                    // Setup event listeners
                    this.setupEventListeners();

                    // Initialize review modal
                    this.initializeReviewModal();

                    console.log('Content details page loaded successfully');

                } catch (error) {
                    console.error('Error initializing content details page:', error);
                    this.showError();
                }
            }

            getContentIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }

            async loadComponents() {
                try {
                    // Load topbar
                    const topbarResponse = await fetch('/components/layout/topbar.html');
                    const topbarHTML = await topbarResponse.text();
                    document.getElementById('topbar-container').innerHTML = topbarHTML;

                    // Load mobile navigation
                    const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
                    const mobileNavHTML = await mobileNavResponse.text();
                    document.getElementById('mobile-nav-container').innerHTML = mobileNavHTML;

                    // Load trailer modal
                    const trailerModalResponse = await fetch('/components/modals/trailer-modal.html');
                    const trailerModalHTML = await trailerModalResponse.text();
                    document.getElementById('trailer-modal-container').innerHTML = trailerModalHTML;

                } catch (error) {
                    console.error('Error loading components:', error);
                }
            }

            async loadContentDetails() {
                try {
                    // Show loading state
                    this.showLoading();

                    // Fetch content details from API
                    const response = await api.getContentDetails(this.contentId);
                    this.contentData = response;

                    // Update page title and meta
                    this.updatePageMeta();

                    // Render content details
                    this.renderContentDetails();

                    // Load additional sections
                    await Promise.all([
                        this.loadCastAndCrew(),
                        this.loadSimilarContent(),
                        this.loadRecommendations(),
                        this.loadUserReviews()
                    ]);

                    // Record view interaction
                    if (auth.isAuthenticated()) {
                        await auth.viewContent(this.contentId);
                    }

                    // Hide loading and show content
                    this.hideLoading();
                    this.showContent();

                } catch (error) {
                    console.error('Error loading content details:', error);
                    this.showError();
                }
            }

            updatePageMeta() {
                // Update page title
                document.title = `${this.contentData.title} - CineBrain`;

                // Update meta description
                const metaDescription = document.querySelector('meta[name="description"]');
                if (metaDescription) {
                    metaDescription.content = `${this.contentData.title} - ${UTILS.truncateText(this.contentData.overview, 150)}`;
                }

                // Update Open Graph
                const ogTitle = document.querySelector('meta[property="og:title"]');
                const ogDescription = document.querySelector('meta[property="og:description"]');

                if (ogTitle) ogTitle.content = `${this.contentData.title} - CineBrain`;
                if (ogDescription) ogDescription.content = UTILS.truncateText(this.contentData.overview, 200);
            }

            renderContentDetails() {
                // Update backdrop image
                const backdropImage = document.querySelector('.backdrop-image');
                const backdropUrl = this.contentData.backdrop_path || this.contentData.poster_path || IMAGE_CONFIG.PLACEHOLDER;
                backdropImage.src = backdropUrl;
                backdropImage.alt = this.contentData.title;

                // Update poster image
                const posterImage = document.querySelector('.poster-image');
                const posterUrl = this.contentData.poster_path || IMAGE_CONFIG.PLACEHOLDER;
                posterImage.src = posterUrl;
                posterImage.alt = this.contentData.title;

                // Add hover effect to poster
                const posterContainer = document.querySelector('.poster-container');
                posterContainer.addEventListener('mouseenter', () => {
                    const overlay = posterContainer.querySelector('.poster-overlay');
                    overlay.classList.remove('opacity-0');
                    overlay.classList.add('opacity-100');
                });
                posterContainer.addEventListener('mouseleave', () => {
                    const overlay = posterContainer.querySelector('.poster-overlay');
                    overlay.classList.add('opacity-0');
                    overlay.classList.remove('opacity-100');
                });

                // Update content type badge using TypeBadge component
                const typeBadgeContainer = document.querySelector('.content-type-badge');
                const typeBadge = TypeBadge.createFromData(this.contentData);
                typeBadgeContainer.appendChild(typeBadge);

                // Update rating badge using RatingBadge component
                const ratingBadgeContainer = document.querySelector('.content-rating-badge');
                const ratingBadgeHTML = `
                <div class="rating-badge-component d-inline-flex align-items-center" data-rating="${this.contentData.rating}">
                    <div class="star-rating me-2">
                        <div class="stars-container position-relative">
                            <div class="stars-bg">
                                <i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i>
                            </div>
                            <div class="stars-filled position-absolute top-0 start-0" style="overflow: hidden; width: ${(this.contentData.rating / 10) * 100}%;">
                                <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                            </div>
                        </div>
                    </div>
                    <span class="rating-number fw-bold">${UTILS.formatRating(this.contentData.rating)}</span>
                    <span class="vote-count text-muted ms-1 text-sm">
                        (${this.contentData.vote_count || 0})
                    </span>
                </div>
            `;
                ratingBadgeContainer.innerHTML = ratingBadgeHTML;

                // Update title and original title
                document.querySelector('.content-title').textContent = this.contentData.title;
                const originalTitle = document.querySelector('.content-original-title');
                if (this.contentData.original_title && this.contentData.original_title !== this.contentData.title) {
                    originalTitle.textContent = `(${this.contentData.original_title})`;
                } else {
                    originalTitle.style.display = 'none';
                }

                // Update meta information
                document.querySelector('.content-release-date').textContent =
                    this.contentData.release_date ? UTILS.formatDate(this.contentData.release_date) : 'TBA';

                document.querySelector('.content-runtime').textContent =
                    this.contentData.runtime ? `${this.contentData.runtime} min` : 'N/A';

                document.querySelector('.content-rating').textContent =
                    this.contentData.rating ? `${UTILS.formatRating(this.contentData.rating)}/10` : 'Not rated';

                // Update genres using GenreChips component
                const genresContainer = document.querySelector('.content-genres-container');
                if (this.contentData.genres && this.contentData.genres.length > 0) {
                    genresContainer.innerHTML = `<div class="genre-chips-container d-flex flex-wrap gap-2"></div>`;
                    GenreChips.createFromArray(this.contentData.genres, genresContainer.firstElementChild, 8);
                }

                // Update overview
                document.querySelector('.content-overview-text').textContent =
                    this.contentData.overview || 'No overview available.';

                // Update action buttons data attributes
                document.querySelectorAll('[data-content-id]').forEach(btn => {
                    btn.dataset.contentId = this.contentId;
                });

                // Setup trailer buttons
                if (this.contentData.youtube_trailer) {
                    const videoId = this.extractVideoId(this.contentData.youtube_trailer);
                    if (videoId) {
                        const trailerButtons = document.querySelectorAll('.play-trailer, .play-trailer-hero');
                        trailerButtons.forEach(btn => {
                            btn.dataset.videoId = videoId;
                            btn.dataset.title = this.contentData.title;
                            btn.dataset.contentId = this.contentId;
                            btn.style.display = '';
                        });
                    }
                }
            }

            async loadCastAndCrew() {
                try {
                    // Cast and crew data should be in the content details response
                    const cast = this.contentData.cast || [];
                    const crew = this.contentData.crew || [];

                    // Render cast
                    this.renderCast(cast);

                    // Render crew
                    this.renderCrew(crew);

                } catch (error) {
                    console.error('Error loading cast and crew:', error);
                }
            }

            renderCast(cast) {
                const castContainer = document.querySelector('.cast-container');

                if (cast.length === 0) {
                    castContainer.innerHTML = '<p class="text-muted text-center py-4">No cast information available.</p>';
                    return;
                }

                castContainer.innerHTML = cast.slice(0, 20).map(member => `
                <div class="cast-member-card bg-theater rounded-3 p-3 text-center flex-shrink-0" style="width: 200px;">
                    <img src="${member.profile_path || IMAGE_CONFIG.PLACEHOLDER}" 
                         alt="${member.name}" 
                         class="cast-photo rounded-circle mb-3" 
                         style="width: 80px; height: 80px; object-fit: cover;"
                         loading="lazy">
                    <h6 class="text-white mb-1">${member.name}</h6>
                    <p class="text-muted text-sm mb-0">${member.character || member.job || 'Actor'}</p>
                </div>
            `).join('');
            }

            renderCrew(crew) {
                const crewContainer = document.querySelector('.crew-container');

                if (crew.length === 0) {
                    crewContainer.innerHTML = '<p class="text-muted text-center py-4">No crew information available.</p>';
                    return;
                }

                // Filter key crew members (Director, Producer, Writer, etc.)
                const keyCrew = crew.filter(member =>
                    ['Director', 'Producer', 'Executive Producer', 'Writer', 'Screenplay', 'Music', 'Cinematography']
                        .includes(member.job)
                ).slice(0, 15);

                crewContainer.innerHTML = keyCrew.map(member => `
                <div class="crew-member-card bg-theater rounded-3 p-3 text-center flex-shrink-0" style="width: 200px;">
                    <img src="${member.profile_path || IMAGE_CONFIG.PLACEHOLDER}" 
                         alt="${member.name}" 
                         class="crew-photo rounded-circle mb-3" 
                         style="width: 80px; height: 80px; object-fit: cover;"
                         loading="lazy">
                    <h6 class="text-white mb-1">${member.name}</h6>
                    <p class="text-muted text-sm mb-0">${member.job}</p>
                </div>
            `).join('');
            }

            async loadSimilarContent() {
                try {
                    const response = await api.getSimilarRecommendations(this.contentId, { limit: 12 });
                    const similarContent = response.recommendations || [];

                    this.renderSimilarContent(similarContent);

                } catch (error) {
                    console.error('Error loading similar content:', error);
                    this.showSectionError('.similar-content-container');
                }
            }

            renderSimilarContent(content) {
                const container = document.querySelector('.similar-content-container');

                if (content.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No similar content found.</p>';
                    return;
                }

                container.innerHTML = content.map(item => this.createContentCard(item, 'mini')).join('');
                this.initializeContentCards(container);
            }

            async loadRecommendations() {
                try {
                    let recommendations = [];

                    if (auth.isAuthenticated()) {
                        // Get personalized recommendations for authenticated users
                        const response = await api.getPersonalizedRecommendations({ limit: 16 });
                        recommendations = response.recommendations || [];
                    } else {
                        // Get trending recommendations for anonymous users
                        const response = await api.getTrending({ limit: 16 });
                        recommendations = response.recommendations || [];
                    }

                    this.renderRecommendations(recommendations);

                } catch (error) {
                    console.error('Error loading recommendations:', error);
                    this.showSectionError('.recommendations-container');
                }
            }

            renderRecommendations(content) {
                const container = document.querySelector('.recommendations-container');

                if (content.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No recommendations available.</p>';
                    return;
                }

                container.innerHTML = content.map(item => this.createContentCard(item)).join('');
                this.initializeContentCards(container);
            }

            async loadUserReviews() {
                try {
                    // For now, show placeholder reviews since we don't have a reviews endpoint
                    // In a real implementation, this would fetch from /content/{id}/reviews
                    this.renderPlaceholderReviews();

                } catch (error) {
                    console.error('Error loading user reviews:', error);
                }
            }

            renderPlaceholderReviews() {
                const container = document.querySelector('.reviews-container');

                // Show message about reviews functionality
                container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-chat-square-text text-muted fs-2 mb-3"></i>
                    <h5 class="text-white mb-2">User Reviews</h5>
                    <p class="text-muted">Reviews feature coming soon. Share your thoughts about this content!</p>
                    ${auth.isAuthenticated() ? `
                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#reviewModal">
                            <i class="bi bi-pencil me-2"></i>Be the First to Review
                        </button>
                    ` : `
                        <a href="/auth/login.html" class="btn btn-primary mt-3">
                            <i class="bi bi-person me-2"></i>Login to Review
                        </a>
                    `}
                </div>
            `;
            }

            createContentCard(item, variant = 'full') {
                if (variant === 'mini') {
                    return `
                    <div class="card-mini bg-theater rounded-2 overflow-hidden shadow-md hover-lift position-relative d-flex flex-shrink-0" 
                         style="width: 280px; height: 120px;" data-content-id="${item.id}">
                        <div class="mini-poster position-relative flex-shrink-0" style="width: 80px;">
                            <img src="${item.poster_path || IMAGE_CONFIG.PLACEHOLDER}" 
                                 alt="${item.title}" 
                                 class="w-100 h-100 object-fit-cover"
                                 loading="lazy">
                        </div>
                        <div class="flex-grow-1 p-2 d-flex flex-column justify-content-between">
                            <div>
                                <h6 class="mini-title text-white mb-1 text-truncate" style="font-size: 0.85rem;" title="${item.title}">
                                    ${item.title}
                                </h6>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="mini-type text-xs text-gray-400">${item.content_type.toUpperCase()}</span>
                                    <span class="mini-year text-xs text-gray-400">${item.release_date ? new Date(item.release_date).getFullYear() : 'TBA'}</span>
                                </div>
                                <div class="rating text-xs text-yellow-500">
                                    ${item.rating ? `‚≠ê ${UTILS.formatRating(item.rating)}` : 'No rating'}
                                </div>
                            </div>
                            <div class="d-flex gap-1 mt-2">
                                <button class="btn btn-outline-primary btn-xs flex-fill add-to-watchlist-mini" data-content-id="${item.id}" title="Watchlist">
                                    <i class="bi bi-bookmark"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-xs flex-fill add-to-favorites-mini" data-content-id="${item.id}" title="Favorite">
                                    <i class="bi bi-heart"></i>
                                </button>
                                <a href="/content/details.html?id=${item.id}" class="btn btn-primary btn-xs" title="Details">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                }

                // Full content card
                return `
                <div class="content-card bg-theater rounded-3 overflow-hidden shadow-lg hover-lift position-relative" 
                     data-content-id="${item.id}">
                    <div class="content-card-poster position-relative">
                        <img src="${item.poster_path || IMAGE_CONFIG.PLACEHOLDER}" 
                             alt="${item.title}" 
                             class="w-100 h-100 object-fit-cover"
                             loading="lazy">
                        
                        <div class="rating-badge position-absolute top-0 end-0 m-2">
                            <span class="rating-value ${UTILS.getRatingColorClass(item.rating)}">${UTILS.formatRating(item.rating)}</span>
                        </div>
                        
                        <div class="position-absolute top-0 start-0 m-2">
                            <span class="type-badge type-badge-${item.content_type}">${item.content_type.toUpperCase()}</span>
                        </div>
                    </div>

                    <div class="p-3">
                        <h6 class="card-title text-white mb-2 text-truncate" title="${item.title}">
                            ${item.title}
                        </h6>
                        
                        ${item.genres ? `
                            <div class="genre-container mb-2">
                                ${item.genres.slice(0, 2).map(genre => `
                                    <span class="genre-chip ${UTILS.getGenreColorClass(genre)}">${genre}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="d-flex justify-content-between align-items-center text-sm text-gray-400 mb-2">
                            <span class="release-date">${item.release_date ? new Date(item.release_date).getFullYear() : 'TBA'}</span>
                            <span class="content-type-text">${item.content_type.charAt(0).toUpperCase() + item.content_type.slice(1)}</span>
                        </div>
                        
                        <p class="card-text text-gray-300 text-sm mb-3" style="font-size: 0.875rem; line-height: 1.4;">
                            ${UTILS.truncateText(item.overview, 100)}
                        </p>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-fill add-to-watchlist" 
                                    data-content-id="${item.id}" title="Add to Watchlist">
                                <i class="bi bi-bookmark me-1"></i>
                                <span class="d-none d-md-inline">Watchlist</span>
                            </button>
                            <button class="btn btn-outline-danger btn-sm flex-fill add-to-favorites" 
                                    data-content-id="${item.id}" title="Add to Favorites">
                                <i class="bi bi-heart me-1"></i>
                                <span class="d-none d-md-inline">Favorite</span>
                            </button>
                            <a href="/content/details.html?id=${item.id}" 
                               class="btn btn-primary btn-sm" title="View Details">
                                <i class="bi bi-info-circle"></i>
                                <span class="d-none d-lg-inline ms-1">Details</span>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            }

            initializeContentCards(container) {
                // Add event listeners for content cards
                const cards = container.querySelectorAll('.content-card, .card-mini');
                cards.forEach(card => {
                    // Watchlist functionality
                    const watchlistBtns = card.querySelectorAll('.add-to-watchlist, .add-to-watchlist-mini');
                    watchlistBtns.forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleWatchlistAction(btn, card.dataset.contentId);
                        });
                    });

                    // Favorites functionality  
                    const favoritesBtns = card.querySelectorAll('.add-to-favorites, .add-to-favorites-mini');
                    favoritesBtns.forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleFavoritesAction(btn, card.dataset.contentId);
                        });
                    });

                    // Card click to details (only for different content)
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('button, a') && card.dataset.contentId !== this.contentId) {
                            window.location.href = `/content/details.html?id=${card.dataset.contentId}`;
                        }
                    });
                });
            }

            async handleWatchlistAction(btn, contentId) {
                if (!auth.isAuthenticated()) {
                    window.location.href = '/auth/login.html';
                    return;
                }

                try {
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                    btn.disabled = true;

                    await auth.addToWatchlist(contentId);

                    btn.innerHTML = '<i class="bi bi-check-lg"></i>';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');

                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('Error adding to watchlist:', error);
                    this.showToast('Failed to add to watchlist', 'error');
                }
            }

            async handleFavoritesAction(btn, contentId) {
                if (!auth.isAuthenticated()) {
                    window.location.href = '/auth/login.html';
                    return;
                }

                try {
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                    btn.disabled = true;

                    await auth.addToFavorites(contentId);

                    btn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');

                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-danger');
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('Error adding to favorites:', error);
                    this.showToast('Failed to add to favorites', 'error');
                }
            }

            setupEventListeners() {
                // Main action buttons
                const watchlistBtn = document.querySelector('.content-actions .add-to-watchlist');
                const favoritesBtn = document.querySelector('.content-actions .add-to-favorites');
                const shareBtn = document.querySelector('.share-content');

                if (watchlistBtn) {
                    watchlistBtn.addEventListener('click', async () => {
                        await this.handleWatchlistAction(watchlistBtn, this.contentId);
                    });
                }

                if (favoritesBtn) {
                    favoritesBtn.addEventListener('click', async () => {
                        await this.handleFavoritesAction(favoritesBtn, this.contentId);
                    });
                }

                if (shareBtn) {
                    shareBtn.addEventListener('click', () => {
                        this.shareContent();
                    });
                }
            }

            initializeReviewModal() {
                // Star rating functionality
                const starBtns = document.querySelectorAll('.star-btn');
                const userRatingInput = document.getElementById('userRating');

                starBtns.forEach((btn, index) => {
                    btn.addEventListener('click', () => {
                        this.userRating = index + 1;
                        userRatingInput.value = this.userRating;

                        // Update star display
                        starBtns.forEach((starBtn, starIndex) => {
                            const icon = starBtn.querySelector('i');
                            if (starIndex <= index) {
                                icon.classList.remove('bi-star');
                                icon.classList.add('bi-star-fill');
                                starBtn.classList.remove('btn-outline-warning');
                                starBtn.classList.add('btn-warning');
                            } else {
                                icon.classList.remove('bi-star-fill');
                                icon.classList.add('bi-star');
                                starBtn.classList.remove('btn-warning');
                                starBtn.classList.add('btn-outline-warning');
                            }
                        });
                    });
                });

                // Submit review functionality
                const submitBtn = document.querySelector('.submit-review');
                if (submitBtn) {
                    submitBtn.addEventListener('click', async () => {
                        await this.submitReview();
                    });
                }
            }

            async submitReview() {
                if (!auth.isAuthenticated()) {
                    window.location.href = '/auth/login.html';
                    return;
                }

                const reviewText = document.getElementById('reviewText').value.trim();

                if (this.userRating === 0) {
                    this.showToast('Please select a rating', 'warning');
                    return;
                }

                if (!reviewText) {
                    this.showToast('Please write a review', 'warning');
                    return;
                }

                try {
                    const submitBtn = document.querySelector('.submit-review');
                    const originalText = submitBtn.textContent;
                    submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Submitting...';
                    submitBtn.disabled = true;

                    // Submit rating through interaction endpoint
                    await auth.rateContent(this.contentId, this.userRating * 2); // Convert 5-star to 10-point scale

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
                    modal.hide();

                    // Reset form
                    document.getElementById('reviewForm').reset();
                    this.userRating = 0;

                    // Reset stars
                    document.querySelectorAll('.star-btn').forEach(btn => {
                        const icon = btn.querySelector('i');
                        icon.classList.remove('bi-star-fill');
                        icon.classList.add('bi-star');
                        btn.classList.remove('btn-warning');
                        btn.classList.add('btn-outline-warning');
                    });

                    this.showToast('Review submitted successfully!', 'success');

                    // Reset button
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;

                } catch (error) {
                    console.error('Error submitting review:', error);
                    this.showToast('Failed to submit review', 'error');
                }
            }

            shareContent() {
                if (navigator.share) {
                    navigator.share({
                        title: this.contentData.title,
                        text: `Check out ${this.contentData.title} on CineBrain`,
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        this.showToast('Link copied to clipboard!', 'success');
                    }).catch(() => {
                        this.showToast('Unable to copy link', 'error');
                    });
                }
            }

            extractVideoId(url) {
                if (!url) return null;
                const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
                return match ? match[1] : null;
            }

            showLoading() {
                document.querySelector('.loading-container').classList.remove('d-none');
                document.querySelector('.content-details-container').classList.add('d-none');
                document.querySelector('.error-container').classList.add('d-none');
            }

            hideLoading() {
                document.querySelector('.loading-container').classList.add('d-none');
            }

            showContent() {
                document.querySelector('.content-details-container').classList.remove('d-none');
                document.querySelector('.error-container').classList.add('d-none');
            }

            showError() {
                document.querySelector('.loading-container').classList.add('d-none');
                document.querySelector('.content-details-container').classList.add('d-none');
                document.querySelector('.error-container').classList.remove('d-none');
            }

            showSectionError(selector) {
                const container = document.querySelector(selector);
                if (container) {
                    container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle text-warning fs-4 mb-2"></i>
                        <p class="text-muted">Failed to load this section.</p>
                    </div>
                `;
                }
            }

            showToast(message, type = 'info') {
                const toastClass = type === 'success' ? 'alert-success' :
                    type === 'error' ? 'alert-danger' :
                        type === 'warning' ? 'alert-warning' : 'alert-info';

                const toast = document.createElement('div');
                toast.className = `alert ${toastClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 5000);
            }
        }

        // Initialize content details page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            window.contentDetailsPage = new ContentDetailsPage();
        });
    </script>

    <style>
        /* Content Details Specific Styles */
        .content-hero {
            min-height: 80vh;
            background: linear-gradient(135deg, var(--cinema-black), var(--theater-dark));
        }

        .hero-backdrop img {
            filter: brightness(0.3) blur(1px);
        }

        .poster-container {
            max-width: 400px;
        }

        .poster-image {
            aspect-ratio: 2/3;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .poster-overlay {
            transition: opacity 0.3s ease;
            border-radius: 12px;
        }

        .content-actions .btn {
            min-width: 150px;
        }

        .cast-member-card,
        .crew-member-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .cast-member-card:hover,
        .crew-member-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .cast-photo,
        .crew-photo {
            border: 3px solid rgba(139, 92, 246, 0.3);
            transition: border-color 0.3s ease;
        }

        .cast-member-card:hover .cast-photo,
        .crew-member-card:hover .crew-photo {
            border-color: rgba(139, 92, 246, 0.6);
        }

        /* Review Modal Styles */
        .star-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .star-btn:hover {
            transform: scale(1.1);
        }

        /* Genre Grid for Recommendations */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .content-hero {
                min-height: 70vh;
            }

            .content-title {
                font-size: 2rem;
            }

            .content-actions {
                flex-direction: column;
            }

            .content-actions .btn {
                min-width: auto;
                width: 100%;
            }

            .cast-container,
            .crew-container,
            .similar-content-container {
                gap: 0.75rem;
            }

            .cast-member-card,
            .crew-member-card {
                width: 150px;
            }
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--theater-dark) 25%, rgba(255, 255, 255, 0.1) 50%, var(--theater-dark) 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Error State */
        .error-container {
            min-height: 60vh;
            display: flex;
            align-items: center;
        }
    </style>
</body>

</html>