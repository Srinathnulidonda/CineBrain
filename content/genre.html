<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse movies, TV shows, and anime by genre on CineBrain">
    <meta name="keywords" content="movie genres, TV show genres, action movies, comedy shows, drama series">

    <title>Browse by Genre - CineBrain</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
</head>

<body>
    <!-- Fixed Topbar -->
    <div id="topbarContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Genre Hero Section -->
        <section class="hero-section py-5" style="min-height: auto;">
            <div class="container">
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-white mb-3" id="genreTitle">
                        <i class="fas fa-theater-masks text-primary me-3"></i>
                        Loading Genre...
                    </h1>
                    <p class="lead text-muted" id="genreDescription">Discover amazing content in this genre</p>
                </div>

                <!-- Genre Grid -->
                <div class="genre-grid mb-5" id="allGenresGrid">
                    <!-- All genres will be displayed here -->
                </div>

                <!-- Content Type Filter -->
                <div class="d-flex justify-content-center gap-2 mb-4">
                    <button class="btn btn-primary content-filter active" data-type="all"
                        onclick="filterContentType('all')">
                        <i class="fas fa-th me-1"></i>All Content
                    </button>
                    <button class="btn btn-outline-primary content-filter" data-type="movie"
                        onclick="filterContentType('movie')">
                        <i class="fas fa-film me-1"></i>Movies
                    </button>
                    <button class="btn btn-outline-primary content-filter" data-type="tv"
                        onclick="filterContentType('tv')">
                        <i class="fas fa-tv me-1"></i>TV Shows
                    </button>
                    <button class="btn btn-outline-primary content-filter" data-type="anime"
                        onclick="filterContentType('anime')">
                        <i class="fas fa-dragon me-1"></i>Anime
                    </button>
                </div>

                <!-- Sort Options -->
                <div class="d-flex justify-content-end mb-4">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="sortBy"
                        onchange="sortContent()" style="max-width: 200px;">
                        <option value="popularity">Most Popular</option>
                        <option value="rating">Highest Rated</option>
                        <option value="release_date">Latest Release</option>
                        <option value="title">Title (A-Z)</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Genre Content Section -->
        <section class="py-5">
            <div class="container">
                <div id="genreContentContainer" class="row">
                    <div class="col-12 text-center py-4">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-muted">Loading content...</p>
                    </div>
                </div>

                <!-- Load More Button -->
                <div id="loadMoreContainer" class="text-center mt-4 d-none">
                    <button class="btn btn-outline-primary" id="loadMoreBtn" onclick="loadMoreContent()">
                        <i class="fas fa-plus me-2"></i>Load More
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- JavaScript Files -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Page-specific JavaScript -->
    <script>
        (function () {
            let currentGenre = '';
            let currentContentType = 'all';
            let currentSort = 'popularity';
            let currentPage = 1;
            let isLoading = false;
            let hasMoreContent = true;

            // Genre information
            const genreInfo = {
                'action': {
                    title: 'Action',
                    description: 'High-octane adventures filled with excitement and thrills',
                    icon: 'fa-fist-raised',
                    color: 'danger'
                },
                'adventure': {
                    title: 'Adventure',
                    description: 'Epic journeys and exciting quests await',
                    icon: 'fa-compass',
                    color: 'success'
                },
                'animation': {
                    title: 'Animation',
                    description: 'Animated stories for all ages',
                    icon: 'fa-palette',
                    color: 'warning'
                },
                'comedy': {
                    title: 'Comedy',
                    description: 'Laugh out loud with hilarious comedies',
                    icon: 'fa-laugh',
                    color: 'info'
                },
                'crime': {
                    title: 'Crime',
                    description: 'Gripping crime stories and investigations',
                    icon: 'fa-user-secret',
                    color: 'dark'
                },
                'documentary': {
                    title: 'Documentary',
                    description: 'Real stories and factual content',
                    icon: 'fa-video',
                    color: 'secondary'
                },
                'drama': {
                    title: 'Drama',
                    description: 'Emotional and powerful dramatic stories',
                    icon: 'fa-theater-masks',
                    color: 'primary'
                },
                'family': {
                    title: 'Family',
                    description: 'Entertainment for the whole family',
                    icon: 'fa-home',
                    color: 'success'
                },
                'fantasy': {
                    title: 'Fantasy',
                    description: 'Magical worlds and mythical adventures',
                    icon: 'fa-magic',
                    color: 'info'
                },
                'horror': {
                    title: 'Horror',
                    description: 'Spine-chilling scares and suspense',
                    icon: 'fa-ghost',
                    color: 'danger'
                },
                'mystery': {
                    title: 'Mystery',
                    description: 'Intriguing puzzles and mysterious tales',
                    icon: 'fa-question-circle',
                    color: 'dark'
                },
                'romance': {
                    title: 'Romance',
                    description: 'Love stories that touch the heart',
                    icon: 'fa-heart',
                    color: 'danger'
                },
                'sci-fi': {
                    title: 'Science Fiction',
                    description: 'Futuristic tales and scientific wonders',
                    icon: 'fa-rocket',
                    color: 'info'
                },
                'thriller': {
                    title: 'Thriller',
                    description: 'Edge-of-your-seat suspense and tension',
                    icon: 'fa-exclamation-triangle',
                    color: 'warning'
                },
                'war': {
                    title: 'War',
                    description: 'Stories of conflict and courage',
                    icon: 'fa-shield-alt',
                    color: 'secondary'
                },
                'western': {
                    title: 'Western',
                    description: 'Tales from the Old West',
                    icon: 'fa-hat-cowboy',
                    color: 'warning'
                }
            };

            // Initialize genre page
            async function initGenrePage() {
                try {
                    await loadComponents();
                    getGenreFromURL();
                    setupGenrePage();
                    await loadGenreContent();
                } catch (error) {
                    console.error('Genre page initialization failed:', error);
                }
            }

            // Load reusable components
            async function loadComponents() {
                try {
                    // Load topbar
                    const topbarResponse = await fetch('/components/layout/topbar.html');
                    const topbarHTML = await topbarResponse.text();
                    document.getElementById('topbarContainer').innerHTML = topbarHTML;

                    // Load mobile navigation
                    const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
                    const mobileNavHTML = await mobileNavResponse.text();
                    document.getElementById('mobileNavContainer').innerHTML = mobileNavHTML;

                    // Execute component scripts
                    const scripts = document.querySelectorAll('#topbarContainer script, #mobileNavContainer script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.head.appendChild(newScript);
                    });
                } catch (error) {
                    console.error('Failed to load components:', error);
                }
            }

            // Get genre from URL
            function getGenreFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                currentGenre = urlParams.get('genre') || '';

                if (!currentGenre) {
                    // If no genre specified, show all genres
                    showAllGenres();
                }
            }

            // Setup genre page
            function setupGenrePage() {
                if (!currentGenre) return;

                const info = genreInfo[currentGenre.toLowerCase()] || {
                    title: currentGenre,
                    description: `Explore ${currentGenre} content`,
                    icon: 'fa-film',
                    color: 'primary'
                };

                // Update page title and meta
                document.title = `${info.title} - CineBrain`;

                // Update hero section
                const genreTitle = document.getElementById('genreTitle');
                genreTitle.innerHTML = `
                <i class="fas ${info.icon} text-${info.color} me-3"></i>
                ${info.title}
            `;

                document.getElementById('genreDescription').textContent = info.description;

                // Hide all genres grid
                document.getElementById('allGenresGrid').style.display = 'none';
            }

            // Show all genres
            function showAllGenres() {
                // Update page title
                document.title = 'Browse by Genre - CineBrain';

                const genreTitle = document.getElementById('genreTitle');
                genreTitle.innerHTML = `
                <i class="fas fa-theater-masks text-primary me-3"></i>
                Browse by Genre
            `;

                document.getElementById('genreDescription').textContent = 'Select a genre to explore';

                // Show genre grid
                const allGenresGrid = document.getElementById('allGenresGrid');
                allGenresGrid.style.display = 'grid';

                // Populate genre grid
                const genreHTML = Object.entries(genreInfo).map(([key, info]) => `
                <div class="genre-card" onclick="selectGenre('${key}')">
                    <div class="genre-card-inner">
                        <i class="fas ${info.icon} text-${info.color} genre-icon"></i>
                        <h5 class="text-white mt-2 mb-1">${info.title}</h5>
                        <p class="text-muted small mb-0">${info.description}</p>
                    </div>
                </div>
            `).join('');

                allGenresGrid.innerHTML = genreHTML;

                // Hide content filters and sort
                document.querySelector('.content-filter').parentElement.style.display = 'none';
                document.getElementById('sortBy').parentElement.style.display = 'none';

                // Hide content container
                document.getElementById('genreContentContainer').style.display = 'none';
            }

            // Select genre
            window.selectGenre = function (genre) {
                window.location.href = `/content/genre.html?genre=${genre}`;
            };

            // Load genre content
            async function loadGenreContent(append = false) {
                if (!currentGenre || isLoading) return;

                isLoading = true;
                const container = document.getElementById('genreContentContainer');

                if (!append) {
                    container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-muted">Loading ${currentGenre} content...</p>
                    </div>
                `;
                }

                try {
                    const params = {
                        limit: 24,
                        page: currentPage,
                        sort_by: currentSort
                    };

                    if (currentContentType !== 'all') {
                        params.content_type = currentContentType;
                    }

                    const genreData = await window.api.getRecommendations('genre', {
                        genre: currentGenre,
                        ...params
                    });

                    if (genreData && genreData.length > 0) {
                        const contentHTML = await renderGenreContent(genreData);

                        if (append) {
                            container.insertAdjacentHTML('beforeend', contentHTML);
                        } else {
                            container.innerHTML = contentHTML;
                        }

                        initializeContentCards();

                        // Show/hide load more button
                        if (genreData.length < 24) {
                            hasMoreContent = false;
                            document.getElementById('loadMoreContainer').classList.add('d-none');
                        } else {
                            document.getElementById('loadMoreContainer').classList.remove('d-none');
                        }
                    } else {
                        if (!append) {
                            showNoContent();
                        }
                        hasMoreContent = false;
                        document.getElementById('loadMoreContainer').classList.add('d-none');
                    }
                } catch (error) {
                    console.error('Failed to load genre content:', error);
                    if (!append) {
                        showErrorState();
                    }
                } finally {
                    isLoading = false;
                }
            }

            // Filter content type
            window.filterContentType = async function (type) {
                if (currentContentType === type || !currentGenre) return;

                currentContentType = type;
                currentPage = 1;
                hasMoreContent = true;

                // Update active button
                document.querySelectorAll('.content-filter').forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.classList.add('btn-outline-primary');
                    if (btn.dataset.type === type) {
                        btn.classList.add('active', 'btn-primary');
                        btn.classList.remove('btn-outline-primary');
                    }
                });

                await loadGenreContent();
            };

            // Sort content
            window.sortContent = async function () {
                currentSort = document.getElementById('sortBy').value;
                currentPage = 1;
                hasMoreContent = true;
                await loadGenreContent();
            };

            // Load more content
            window.loadMoreContent = async function () {
                if (!hasMoreContent || isLoading) return;

                const button = document.getElementById('loadMoreBtn');
                button.disabled = true;
                button.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading...';

                currentPage++;
                await loadGenreContent(true);

                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plus me-2"></i>Load More';
            };

            // Render genre content
            async function renderGenreContent(contentData) {
                return contentData.map((item, index) => {
                    const typeColor = item.content_type === 'movie' ? 'primary' :
                        item.content_type === 'tv' ? 'success' : 'warning';

                    return `
                    <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-4 content-card-wrapper" style="animation-delay: ${index * 0.05}s;">
                        <div class="content-card card bg-dark border-secondary h-100" 
                             onclick="viewContentDetails(${item.id})"
                             style="cursor: pointer; transition: all 0.3s ease;">
                            <div class="position-relative overflow-hidden">
                                <img src="${item.poster_path || '/assets/no-poster.jpg'}" 
                                     class="card-img-top" 
                                     style="height: 300px; object-fit: cover;" 
                                     alt="${item.title}"
                                     loading="lazy"
                                     onerror="this.src='/assets/no-poster.jpg'">
                                
                                <!-- Content Type Badge -->
                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="badge bg-${typeColor}">
                                        ${item.content_type.toUpperCase()}
                                    </span>
                                </div>
                                
                                <!-- Rating Badge -->
                                ${item.rating ? `
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-star"></i> ${parseFloat(item.rating).toFixed(1)}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="card-body p-3">
                                <h6 class="card-title text-white fw-semibold mb-2" 
                                    style="overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    ${item.title}
                                </h6>
                                
                                ${item.genres && item.genres.length > 0 ? `
                                    <div class="mb-2">
                                        ${item.genres.slice(0, 2).map(genre =>
                        `<span class="badge bg-secondary me-1 mb-1" style="font-size: 0.7rem;">${genre}</span>`
                    ).join('')}
                                    </div>
                                ` : ''}
                                
                                <div class="d-flex gap-2 mt-auto">
                                    <button class="btn btn-${typeColor} btn-sm flex-grow-1" onclick="event.stopPropagation(); viewContentDetails(${item.id})">
                                        <i class="fas fa-info-circle me-1"></i>Details
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); toggleFavorite(${item.id}, this)">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Initialize content cards
            function initializeContentCards() {
                const cards = document.querySelectorAll('.content-card');
                cards.forEach(card => {
                    card.addEventListener('mouseenter', function () {
                        this.style.transform = 'translateY(-8px) scale(1.02)';
                        this.style.boxShadow = '0 15px 35px rgba(59, 130, 246, 0.3)';
                    });

                    card.addEventListener('mouseleave', function () {
                        this.style.transform = 'translateY(0) scale(1)';
                        this.style.boxShadow = '';
                    });
                });

                // Add stagger animation
                const wrappers = document.querySelectorAll('.content-card-wrapper');
                wrappers.forEach((wrapper, index) => {
                    setTimeout(() => {
                        wrapper.classList.add('fade-in-up');
                    }, index * 30);
                });
            }

            // Show no content
            function showNoContent() {
                const container = document.getElementById('genreContentContainer');
                container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-film text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">No ${currentGenre} content available</h5>
                    <p class="text-muted">Try selecting a different content type or check back later</p>
                </div>
            `;
            }

            // Show error state
            function showErrorState() {
                const container = document.getElementById('genreContentContainer');
                container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">Failed to load content</h5>
                    <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
                        <i class="fas fa-refresh me-1"></i>Try Again
                    </button>
                </div>
            `;
            }

            // Global functions
            window.viewContentDetails = function (contentId) {
                window.location.href = `/content/details.html?id=${contentId}`;
            };

            window.toggleFavorite = async function (contentId, button) {
                try {
                    if (!window.auth || !window.auth.isAuthenticated()) {
                        window.location.href = '/auth/login.html';
                        return;
                    }

                    await window.api.recordInteraction(contentId, 'favorite');

                    const icon = button.querySelector('i');
                    icon.classList.add('heart-beat');
                    button.classList.toggle('btn-outline-danger');
                    button.classList.toggle('btn-danger');

                    setTimeout(() => {
                        icon.classList.remove('heart-beat');
                    }, 600);

                    if (window.showToast) {
                        window.showToast('Added to favorites!', 'success');
                    }
                } catch (error) {
                    console.error('Failed to toggle favorite:', error);
                    if (window.showToast) {
                        window.showToast('Failed to update favorites', 'error');
                    }
                }
            };

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initGenrePage);
            } else {
                initGenrePage();
            }
        })();
    </script>

    <!-- Genre-specific Styles -->
    <style>
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .genre-card {
            background: linear-gradient(135deg, rgba(20, 20, 24, 0.9) 0%, rgba(30, 30, 35, 0.8) 100%);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .genre-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 30, 35, 0.9) 100%);
        }

        .genre-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .content-card-wrapper {
            opacity: 0;
        }

        .content-card-wrapper.fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @media (max-width: 576px) {
            .genre-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }

            .genre-card {
                padding: 1.5rem;
            }

            .genre-icon {
                font-size: 2rem;
            }
        }
    </style>
</body>

</html>