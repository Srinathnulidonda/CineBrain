<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse by Genre - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-header__title" id="genreTitle">Browse by Genre</h1>
                    <p class="page-header__description" id="genreDescription">
                        Select a genre to explore
                    </p>
                </div>

                <!-- Genre Grid -->
                <section class="mb-2xl" id="genreSelection">
                    <div class="genre-grid">
                        <div class="genre-card" onclick="loadGenreContent('action')">
                            <div class="genre-card__icon">‚ö°</div>
                            <h3 class="genre-card__title">Action</h3>
                            <p class="genre-card__count">Explosive thrills</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('comedy')">
                            <div class="genre-card__icon">üòÇ</div>
                            <h3 class="genre-card__title">Comedy</h3>
                            <p class="genre-card__count">Laugh out loud</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('drama')">
                            <div class="genre-card__icon">üé≠</div>
                            <h3 class="genre-card__title">Drama</h3>
                            <p class="genre-card__count">Emotional stories</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('horror')">
                            <div class="genre-card__icon">üëª</div>
                            <h3 class="genre-card__title">Horror</h3>
                            <p class="genre-card__count">Spine-chilling</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('romance')">
                            <div class="genre-card__icon">üíï</div>
                            <h3 class="genre-card__title">Romance</h3>
                            <p class="genre-card__count">Love stories</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('sci-fi')">
                            <div class="genre-card__icon">üöÄ</div>
                            <h3 class="genre-card__title">Sci-Fi</h3>
                            <p class="genre-card__count">Future worlds</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('thriller')">
                            <div class="genre-card__icon">üîç</div>
                            <h3 class="genre-card__title">Thriller</h3>
                            <p class="genre-card__count">Edge of seat</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('documentary')">
                            <div class="genre-card__icon">üìπ</div>
                            <h3 class="genre-card__title">Documentary</h3>
                            <p class="genre-card__count">Real stories</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('animation')">
                            <div class="genre-card__icon">üé®</div>
                            <h3 class="genre-card__title">Animation</h3>
                            <p class="genre-card__count">Animated magic</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('mystery')">
                            <div class="genre-card__icon">üïµÔ∏è</div>
                            <h3 class="genre-card__title">Mystery</h3>
                            <p class="genre-card__count">Solve puzzles</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('fantasy')">
                            <div class="genre-card__icon">üßô</div>
                            <h3 class="genre-card__title">Fantasy</h3>
                            <p class="genre-card__count">Magical realms</p>
                        </div>
                        <div class="genre-card" onclick="loadGenreContent('western')">
                            <div class="genre-card__icon">ü§†</div>
                            <h3 class="genre-card__title">Western</h3>
                            <p class="genre-card__count">Wild west</p>
                        </div>
                    </div>
                </section>

                <!-- Genre Content -->
                <section id="genreContent" style="display: none;">
                    <div class="d-flex justify-between align-center mb-xl">
                        <div>
                            <h2 id="genreContentTitle">Genre Movies</h2>
                            <p class="text-muted" id="genreContentCount">0 results</p>
                        </div>
                        <div class="d-flex gap-sm">
                            <select class="form-control" id="contentType" style="width: auto;">
                                <option value="movie">Movies</option>
                                <option value="tv">TV Shows</option>
                            </select>
                            <button class="btn btn-secondary" onclick="resetGenre()">
                                <i class="bi bi-arrow-left"></i> All Genres
                            </button>
                        </div>
                    </div>

                    <div class="content-grid content-grid--movies" id="genreGrid">
                        <!-- Dynamic content -->
                    </div>

                    <!-- Load More -->
                    <div class="text-center mt-xl" id="loadMoreContainer" style="display: none;">
                        <button class="btn btn-secondary" onclick="loadMore()" id="loadMoreBtn">
                            Load More
                        </button>
                    </div>
                </section>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item" id="mobileWatchlistItem">
                    <a href="/auth/login.html" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item" id="mobileProfileItem">
                    <a href="/auth/login.html" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <style>
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }

        .genre-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 2px solid transparent;
        }

        .genre-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .genre-card__icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .genre-card__title {
            font-size: 1.25rem;
            margin-bottom: var(--spacing-xs);
        }

        .genre-card__count {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin: 0;
        }
    </style>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        let currentGenre = '';
        let currentContentType = 'movie';
        let allContent = [];
        let displayedItems = 20;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            updateNavigation();

            // Check for genre in URL
            const urlParams = new URLSearchParams(window.location.search);
            const genre = urlParams.get('genre');
            if (genre) {
                loadGenreContent(genre);
            }

            // Setup content type filter
            document.getElementById('contentType').addEventListener('change', (e) => {
                currentContentType = e.target.value;
                if (currentGenre) {
                    displayedItems = 20;
                    loadGenreContent(currentGenre);
                }
            });
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const mobileWatchlistItem = document.getElementById('mobileWatchlistItem');
            const mobileProfileItem = document.getElementById('mobileProfileItem');

            if (auth.isAuthenticated()) {
                const user = auth.getUser();
                navbarUser.innerHTML = `
                    <a href="${auth.getUserUrl('watchlist')}" class="navbar__link">
                        <i class="bi bi-bookmark"></i>
                    </a>
                    <a href="${auth.getUserUrl('favorites')}" class="navbar__link">
                        <i class="bi bi-heart"></i>
                    </a>
                    <div class="navbar__avatar">
                        <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                    </div>
                `;

                mobileWatchlistItem.innerHTML = `
                    <a href="${auth.getUserUrl('watchlist')}" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                `;

                mobileProfileItem.innerHTML = `
                    <a href="${auth.getUserUrl('profile')}" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                `;
            } else {
                navbarUser.innerHTML = `
                    <a href="/auth/login.html" class="btn btn-primary">Sign In</a>
                `;
            }
        }

        async function loadGenreContent(genre) {
            currentGenre = genre;

            // Update URL
            router.updateParams({ genre });

            // Show content section, hide selection
            document.getElementById('genreSelection').style.display = 'none';
            document.getElementById('genreContent').style.display = 'block';

            // Update titles
            const genreName = genre.charAt(0).toUpperCase() + genre.slice(1).replace('-', ' ');
            document.getElementById('genreTitle').textContent = genreName;
            document.getElementById('genreDescription').textContent = `Explore the best of ${genreName} ${currentContentType === 'tv' ? 'TV shows' : 'movies'}`;
            document.getElementById('genreContentTitle').textContent = `${genreName} ${currentContentType === 'tv' ? 'TV Shows' : 'Movies'}`;

            // Show loading
            document.getElementById('genreGrid').innerHTML = `
                <div class="content-card skeleton" style="height: 400px;"></div>
                <div class="content-card skeleton" style="height: 400px;"></div>
                <div class="content-card skeleton" style="height: 400px;"></div>
                <div class="content-card skeleton" style="height: 400px;"></div>
            `;

            try {
                // Load content
                const response = await api.getGenreRecommendations(genre, currentContentType, 100);
                allContent = response.recommendations || [];

                document.getElementById('genreContentCount').textContent = `${allContent.length} results`;

                renderContent();

            } catch (error) {
                console.error('Failed to load genre content:', error);
                showToast('Failed to load content', 'error');
            }
        }

        function renderContent() {
            const grid = document.getElementById('genreGrid');
            const itemsToShow = allContent.slice(0, displayedItems);

            grid.innerHTML = itemsToShow.map((item, index) => `
                <div class="content-card animate-fadeInUp" style="animation-delay: ${Math.min(index * 0.05, 0.5)}s">
                    <div class="content-card__image-wrapper" onclick="navigateToContentDetails(${item.id})">
                        <img src="${item.poster_path || '/assets/images/placeholder-poster.jpg'}" 
                             alt="${item.title}" 
                             class="content-card__image"
                             loading="lazy">
                    </div>
                    <div class="content-card__body">
                        <h3 class="content-card__title">${item.title}</h3>
                        <div class="content-card__meta">
                            <span class="content-card__rating">
                                <i class="bi bi-star-fill content-card__rating-star"></i>
                                ${item.rating || 'N/A'}
                            </span>
                            <span>${item.content_type}</span>
                        </div>
                    </div>
                    <div class="content-card__overlay">
                        <p class="text-sm mb-sm">${item.overview || 'No description available.'}</p>
                        <div class="content-card__actions">
                            ${auth.isAuthenticated() ? `
                                <button class="content-card__action-btn" onclick="event.stopPropagation(); addToWatchlist(${item.id})">
                                    <i class="bi bi-plus"></i> Watchlist
                                </button>
                            ` : ''}
                            ${item.youtube_trailer ? `
                                <button class="content-card__action-btn" onclick="event.stopPropagation(); window.open('${item.youtube_trailer}', '_blank')">
                                    <i class="bi bi-play"></i> Trailer
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // Show/hide load more button
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (allContent.length > displayedItems) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function loadMore() {
            displayedItems += 20;
            renderContent();

            if (displayedItems >= allContent.length) {
                document.getElementById('loadMoreContainer').style.display = 'none';
            }
        }

        function resetGenre() {
            currentGenre = '';
            document.getElementById('genreSelection').style.display = 'block';
            document.getElementById('genreContent').style.display = 'none';
            document.getElementById('genreTitle').textContent = 'Browse by Genre';
            document.getElementById('genreDescription').textContent = 'Select a genre to explore';
            router.updateParams({ genre: null });
        }

        async function addToWatchlist(contentId) {
            try {
                await api.recordInteraction(contentId, Config.INTERACTIONS.WATCHLIST);
                showToast('Added to watchlist', 'success');
            } catch (error) {
                showToast('Failed to add to watchlist', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>

</html>