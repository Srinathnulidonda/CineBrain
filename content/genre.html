<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Browse by Genre - CineScope">
    <title>Genre Browser - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="topbar">
        <div class="topbar-left">
            <a href="/" class="logo">CineScope</a>
            <button class="back-btn" onclick="history.back()">‚Üê Back</button>
        </div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search..." id="headerSearch">
        </div>
        <div class="topbar-right" id="userSection"></div>
    </nav>

    <main class="genre-page">
        <div class="container">
            <!-- Genre Header -->
            <div class="genre-header">
                <div class="header-content">
                    <h1 class="page-title" id="genreTitle">Browse by Genre</h1>
                    <p class="page-description" id="genreDescription">Explore content across different genres</p>
                </div>
            </div>

            <!-- Genre Selection -->
            <div class="genre-selection" id="genreSelection">
                <div class="genre-grid">
                    <div class="genre-card" onclick="selectGenre('action')">
                        <div class="genre-icon">‚ö°</div>
                        <div class="genre-name">Action</div>
                        <div class="genre-count" id="actionCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('adventure')">
                        <div class="genre-icon">üó∫Ô∏è</div>
                        <div class="genre-name">Adventure</div>
                        <div class="genre-count" id="adventureCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('animation')">
                        <div class="genre-icon">üé®</div>
                        <div class="genre-name">Animation</div>
                        <div class="genre-count" id="animationCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('comedy')">
                        <div class="genre-icon">üòÑ</div>
                        <div class="genre-name">Comedy</div>
                        <div class="genre-count" id="comedyCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('crime')">
                        <div class="genre-icon">üîç</div>
                        <div class="genre-name">Crime</div>
                        <div class="genre-count" id="crimeCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('documentary')">
                        <div class="genre-icon">üìπ</div>
                        <div class="genre-name">Documentary</div>
                        <div class="genre-count" id="documentaryCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('drama')">
                        <div class="genre-icon">üé≠</div>
                        <div class="genre-name">Drama</div>
                        <div class="genre-count" id="dramaCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('family')">
                        <div class="genre-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="genre-name">Family</div>
                        <div class="genre-count" id="familyCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('fantasy')">
                        <div class="genre-icon">üßô‚Äç‚ôÇÔ∏è</div>
                        <div class="genre-name">Fantasy</div>
                        <div class="genre-count" id="fantasyCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('horror')">
                        <div class="genre-icon">üëª</div>
                        <div class="genre-name">Horror</div>
                        <div class="genre-count" id="horrorCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('mystery')">
                        <div class="genre-icon">üïµÔ∏è</div>
                        <div class="genre-name">Mystery</div>
                        <div class="genre-count" id="mysteryCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('romance')">
                        <div class="genre-icon">üíï</div>
                        <div class="genre-name">Romance</div>
                        <div class="genre-count" id="romanceCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('sci-fi')">
                        <div class="genre-icon">üöÄ</div>
                        <div class="genre-name">Sci-Fi</div>
                        <div class="genre-count" id="sci-fiCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('thriller')">
                        <div class="genre-icon">üî™</div>
                        <div class="genre-name">Thriller</div>
                        <div class="genre-count" id="thrillerCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('war')">
                        <div class="genre-icon">‚öîÔ∏è</div>
                        <div class="genre-name">War</div>
                        <div class="genre-count" id="warCount">Loading...</div>
                    </div>
                    <div class="genre-card" onclick="selectGenre('western')">
                        <div class="genre-icon">ü§†</div>
                        <div class="genre-name">Western</div>
                        <div class="genre-count" id="westernCount">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Genre Content -->
            <div class="genre-content" id="genreContent" style="display: none;">
                <!-- Back to genres button -->
                <button class="btn btn-outline btn-sm mb-3" onclick="showGenreSelection()">
                    ‚Üê Back to Genres
                </button>

                <!-- Content Filters -->
                <div class="content-filters">
                    <div class="filters-left">
                        <select id="sortSelect" class="filter-select" onchange="sortContent()">
                            <option value="popularity">Most Popular</option>
                            <option value="rating">Highest Rated</option>
                            <option value="recent">Recently Added</option>
                            <option value="title">Title A-Z</option>
                        </select>
                        
                        <select id="typeFilter" class="filter-select" onchange="filterContent()">
                            <option value="all">All Types</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                        </select>

                        <select id="yearFilter" class="filter-select" onchange="filterContent()">
                            <option value="all">All Years</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2010s">2010-2019</option>
                            <option value="2000s">2000-2009</option>
                            <option value="1990s">1990-1999</option>
                            <option value="classics">Before 1990</option>
                        </select>
                    </div>

                    <div class="filters-right">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid" onclick="switchView('grid')">
                                <span class="view-icon">‚äû</span> Grid
                            </button>
                            <button class="view-btn" data-view="list" onclick="switchView('list')">
                                <span class="view-icon">‚ò∞</span> List
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="content-results" id="contentResults">
                    <div class="loading" id="loadingState">
                        <div class="spinner"></div>
                        <p>Loading content...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="/" class="mobile-nav-item">
            <span class="mobile-nav-icon">üè†</span>
            <span class="mobile-nav-label">Home</span>
        </a>
        <a href="/content/search.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">üîç</span>
            <span class="mobile-nav-label">Search</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="requireAuth(() => goToWatchlist())">
            <span class="mobile-nav-icon">üìö</span>
            <span class="mobile-nav-label">Watchlist</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="requireAuth(() => goToFavorites())">
            <span class="mobile-nav-icon">‚ù§Ô∏è</span>
            <span class="mobile-nav-label">Favorites</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="requireAuth(() => goToProfile())">
            <span class="mobile-nav-icon">üë§</span>
            <span class="mobile-nav-label">Profile</span>
        </a>
    </nav>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let currentGenre = null;
        let allContent = [];
        let filteredContent = [];
        let currentView = 'grid';
        let genreCounts = {};

        document.addEventListener('DOMContentLoaded', async () => {
            updateUserSection();
            setupHeaderSearch();
            
            // Check if genre is specified in URL
            const params = new URLSearchParams(window.location.search);
            const genre = params.get('genre');
            
            if (genre) {
                selectGenre(genre);
            } else {
                await loadGenreCounts();
            }
        });

        async function loadGenreCounts() {
            // Load sample content from each genre to get counts
            const genres = ['action', 'adventure', 'animation', 'comedy', 'crime', 'documentary', 
                          'drama', 'family', 'fantasy', 'horror', 'mystery', 'romance', 
                          'sci-fi', 'thriller', 'war', 'western'];
            
            // For now, we'll use placeholder counts since loading all genres would be too many API calls
            // In a real implementation, this would come from a dedicated API endpoint
            genres.forEach(genre => {
                const count = Math.floor(Math.random() * 500) + 100; // Random count between 100-600
                genreCounts[genre] = count;
                const countElement = document.getElementById(`${genre}Count`);
                if (countElement) {
                    countElement.textContent = `${count} titles`;
                }
            });
        }

        async function selectGenre(genre) {
            currentGenre = genre;
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('genre', genre);
            window.history.pushState({}, '', url);
            
            // Update UI
            document.getElementById('genreSelection').style.display = 'none';
            document.getElementById('genreContent').style.display = 'block';
            
            // Update page title
            const genreNames = {
                'action': 'Action',
                'adventure': 'Adventure',
                'animation': 'Animation',
                'comedy': 'Comedy',
                'crime': 'Crime',
                'documentary': 'Documentary',
                'drama': 'Drama',
                'family': 'Family',
                'fantasy': 'Fantasy',
                'horror': 'Horror',
                'mystery': 'Mystery',
                'romance': 'Romance',
                'sci-fi': 'Science Fiction',
                'thriller': 'Thriller',
                'war': 'War',
                'western': 'Western'
            };
            
            document.getElementById('genreTitle').textContent = `${genreNames[genre] || genre} Movies & Shows`;
            document.getElementById('genreDescription').textContent = `Explore the best ${genreNames[genre] || genre} content`;
            
            await loadGenreContent();
        }

        function showGenreSelection() {
            document.getElementById('genreSelection').style.display = 'block';
            document.getElementById('genreContent').style.display = 'none';
            
            // Reset URL
            const url = new URL(window.location);
            url.searchParams.delete('genre');
            window.history.pushState({}, '', url);
            
            // Reset page title
            document.getElementById('genreTitle').textContent = 'Browse by Genre';
            document.getElementById('genreDescription').textContent = 'Explore content across different genres';
        }

        async function loadGenreContent() {
            const loadingState = document.getElementById('loadingState');
            loadingState.style.display = 'flex';

            try {
                const response = await window.api.getGenreRecommendations(currentGenre, {
                    type: 'all',
                    limit: 50
                });

                allContent = response.recommendations || [];
                filteredContent = [...allContent];

                renderContent();
                loadingState.style.display = 'none';

            } catch (error) {
                console.error('Failed to load genre content:', error);
                showError('Failed to load content for this genre');
                loadingState.style.display = 'none';
            }
        }

        function renderContent() {
            const container = document.getElementById('contentResults');
            
            if (filteredContent.length === 0) {
                container.innerHTML = `
                    <div class="empty-results">
                        <div class="empty-icon">üîç</div>
                        <h3>No content found</h3>
                        <p>Try adjusting your filters or explore other genres.</p>
                        <button class="btn btn-outline" onclick="clearFilters()">Clear Filters</button>
                    </div>
                `;
                return;
            }

            if (currentView === 'grid') {
                container.innerHTML = `
                    <div class="content-grid">
                        ${filteredContent.map(item => renderGridItem(item)).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="content-list">
                        ${filteredContent.map(item => renderListItem(item)).join('')}
                    </div>
                `;
            }
        }

        function renderGridItem(item) {
            return `
                <div class="content-card" data-id="${item.id}" onclick="viewContent(${item.id})">
                    <div class="card-image">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                        <div class="card-overlay">
                            <button class="play-btn" onclick="event.stopPropagation(); playTrailer(${item.id})">‚ñ∂</button>
                        </div>
                        <div class="card-badges">
                            ${item.rating ? `<span class="rating-badge">‚òÖ ${item.rating}</span>` : ''}
                            <span class="type-badge">${item.content_type}</span>
                        </div>
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${item.title}</h3>
                        <div class="card-meta">
                            ${item.release_date ? `<span class="year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); addToWatchlist(${item.id})">
                                + Watchlist
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); addToFavorites(${item.id})">
                                ‚ô° Favorite
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderListItem(item) {
            return `
                <div class="content-list-item" data-id="${item.id}">
                    <div class="list-poster" onclick="viewContent(${item.id})">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                    </div>
                    
                    <div class="list-content">
                        <div class="list-header">
                            <h3 class="list-title" onclick="viewContent(${item.id})">${item.title}</h3>
                            <div class="list-badges">
                                ${item.rating ? `<span class="rating-badge">‚òÖ ${item.rating}</span>` : ''}
                                <span class="type-badge">${item.content_type}</span>
                            </div>
                        </div>
                        
                        <div class="list-meta">
                            ${item.release_date ? `<span class="year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                            ${item.runtime ? `<span class="runtime">${item.runtime} min</span>` : ''}
                        </div>
                        
                        <p class="list-overview">${(item.overview || '').substring(0, 200)}${item.overview && item.overview.length > 200 ? '...' : ''}</p>
                        
                        <div class="list-actions">
                            <button class="btn btn-sm btn-primary" onclick="playTrailer(${item.id})">
                                ‚ñ∂ Watch Trailer
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="addToWatchlist(${item.id})">
                                + Add to Watchlist
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="addToFavorites(${item.id})">
                                ‚ô° Add to Favorites
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewContent(${item.id})">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Filtering and Sorting Functions
        function sortContent() {
            const sortValue = document.getElementById('sortSelect').value;
            
            switch (sortValue) {
                case 'rating':
                    filteredContent.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'recent':
                    filteredContent.sort((a, b) => {
                        const dateA = a.release_date ? new Date(a.release_date) : new Date(0);
                        const dateB = b.release_date ? new Date(b.release_date) : new Date(0);
                        return dateB - dateA;
                    });
                    break;
                case 'title':
                    filteredContent.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                default: // popularity
                    // Keep original order
                    break;
            }
            
            renderContent();
        }

        function filterContent() {
            const typeFilter = document.getElementById('typeFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            filteredContent = allContent.filter(item => {
                // Type filter
                if (typeFilter !== 'all' && item.content_type !== typeFilter) {
                    return false;
                }
                
                // Year filter
                if (yearFilter !== 'all') {
                    const year = item.release_date ? new Date(item.release_date).getFullYear() : 0;
                    
                    switch (yearFilter) {
                        case '2024':
                        case '2023':
                        case '2022':
                        case '2021':
                        case '2020':
                            if (year !== parseInt(yearFilter)) return false;
                            break;
                        case '2010s':
                            if (year < 2010 || year > 2019) return false;
                            break;
                        case '2000s':
                            if (year < 2000 || year > 2009) return false;
                            break;
                        case '1990s':
                            if (year < 1990 || year > 1999) return false;
                            break;
                        case 'classics':
                            if (year >= 1990) return false;
                            break;
                    }
                }
                
                return true;
            });
            
            sortContent();
        }

        function clearFilters() {
            document.getElementById('sortSelect').value = 'popularity';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('yearFilter').value = 'all';
            
            filteredContent = [...allContent];
            renderContent();
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            renderContent();
        }

        // Action Functions
        async function viewContent(contentId) {
            window.location.href = `/content/details.html?id=${contentId}`;
        }

        async function playTrailer(contentId) {
            try {
                const content = await window.api.getContentDetails(contentId);
                
                if (content.youtube_trailer) {
                    const modal = document.createElement('div');
                    modal.className = 'modal modal-large';
                    modal.innerHTML = `
                        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${content.title} - Trailer</h3>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <iframe 
                                    src="https://www.youtube.com/embed/${content.youtube_trailer_id}?autoplay=1"
                                    frameborder="0" 
                                    allowfullscreen
                                    width="100%" 
                                    height="400">
                                </iframe>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    modal.style.display = 'flex';
                } else {
                    showToast('Trailer not available', 'warning');
                }
            } catch (error) {
                console.error('Failed to play trailer:', error);
                showToast('Failed to load trailer', 'error');
            }
        }

        async function addToWatchlist(contentId) {
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/auth/login.html';
                return;
            }

            try {
                await window.api.recordInteraction({
                    content_id: contentId,
                    interaction_type: 'watchlist'
                });
                
                showToast('Added to watchlist', 'success');
            } catch (error) {
                console.error('Failed to add to watchlist:', error);
                showToast('Failed to add to watchlist', 'error');
            }
        }

        async function addToFavorites(contentId) {
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/auth/login.html';
                return;
            }

            try {
                await window.api.recordInteraction({
                    content_id: contentId,
                    interaction_type: 'favorite'
                });
                
                showToast('Added to favorites', 'success');
            } catch (error) {
                console.error('Failed to add to favorites:', error);
                showToast('Failed to add to favorites', 'error');
            }
        }

        // Utility Functions
        function updateUserSection() {
            const userSection = document.getElementById('userSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <img src="${window.auth.getUserAvatar()}" 
                         alt="${user.username}" 
                         class="user-avatar"
                         onclick="toggleUserMenu()">
                    <div class="user-dropdown" id="userDropdown" style="display: none;">
                        <a href="/${user.username}/profile" class="dropdown-item">Profile</a>
                        <a href="/${user.username}/watchlist" class="dropdown-item">Watchlist</a>
                        <a href="/${user.username}/favorites" class="dropdown-item">Favorites</a>
                        <a href="/${user.username}/settings" class="dropdown-item">Settings</a>
                        ${user.is_admin ? '<a href="/admin/" class="dropdown-item">Admin</a>' : ''}
                        <hr>
                        <a href="#" onclick="window.auth.logout()" class="dropdown-item">Logout</a>
                    </div>
                `;
            } else {
                userSection.innerHTML = `
                    <a href="/auth/login.html" class="btn btn-outline btn-sm">Login</a>
                `;
            }
        }

        function setupHeaderSearch() {
            const searchInput = document.getElementById('headerSearch');
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        window.location.href = `/content/search.html?q=${encodeURIComponent(query)}`;
                    }
                }
            });
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function goToWatchlist() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/watchlist`;
        }

        function goToFavorites() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/favorites`;
        }

        function goToProfile() {
            const user = window.auth.getUser();
            window.location.href = `/${user.username}/profile`;
        }

        function requireAuth(callback) {
            if (window.auth.isAuthenticated()) {
                callback();
            } else {
                window.location.href = '/auth/login.html';
            }
        }

        function showError(message) {
            document.getElementById('contentResults').innerHTML = `
                <div class="error-message">
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.topbar-right')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>