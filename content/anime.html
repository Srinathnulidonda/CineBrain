<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Anime Collection - CineBrain">
  <title>Anime - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="container py-8">
        <!-- Header -->
        <div class="text-center mb-12">
          <h1 class="text-5xl font-bold mb-4">üéå Anime Collection</h1>
          <p class="text-xl text-muted">Discover amazing anime series and movies</p>
        </div>

        <!-- Genre Filters -->
        <div class="flex justify-center mb-8">
          <div class="search-filters">
            <button class="filter-chip active" data-genre="" onclick="setAnimeGenre('')">All Anime</button>
            <button class="filter-chip" data-genre="action" onclick="setAnimeGenre('action')">Action</button>
            <button class="filter-chip" data-genre="romance" onclick="setAnimeGenre('romance')">Romance</button>
            <button class="filter-chip" data-genre="comedy" onclick="setAnimeGenre('comedy')">Comedy</button>
            <button class="filter-chip" data-genre="drama" onclick="setAnimeGenre('drama')">Drama</button>
            <button class="filter-chip" data-genre="fantasy" onclick="setAnimeGenre('fantasy')">Fantasy</button>
            <button class="filter-chip" data-genre="thriller" onclick="setAnimeGenre('thriller')">Thriller</button>
          </div>
        </div>

        <!-- Sort Options -->
        <div class="flex justify-center mb-8">
          <select id="sort-select" class="form-input" onchange="sortAnime()">
            <option value="popularity">Sort by Popularity</option>
            <option value="rating">Sort by Rating</option>
            <option value="title">Sort by Title</option>
            <option value="year">Sort by Year</option>
          </select>
        </div>

        <!-- Loading State -->
        <div class="text-center py-12" id="anime-loading">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-muted">Loading anime collection...</p>
        </div>

        <!-- Anime Grid -->
        <div class="content-grid" id="anime-grid" style="display: none;">
          <!-- Real anime content loaded here -->
        </div>

        <!-- Load More Section -->
        <div class="text-center mt-12" id="load-more-section" style="display: none;">
          <button class="btn btn-outline" id="load-more-btn" onclick="loadMoreAnime()">
            Load More Anime
          </button>
        </div>

        <!-- Popular Anime Categories -->
        <section class="content-section mt-16" id="popular-categories">
          <h2 class="section-title">Popular Categories</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-elevated rounded-xl p-6 text-center cursor-pointer hover:bg-surface transition" onclick="setAnimeGenre('shonen')">
              <div class="text-3xl mb-2">‚öîÔ∏è</div>
              <h3 class="font-semibold">Shonen</h3>
              <p class="text-sm text-muted">Action & Adventure</p>
            </div>
            <div class="bg-elevated rounded-xl p-6 text-center cursor-pointer hover:bg-surface transition" onclick="setAnimeGenre('romance')">
              <div class="text-3xl mb-2">üíù</div>
              <h3 class="font-semibold">Romance</h3>
              <p class="text-sm text-muted">Love Stories</p>
            </div>
            <div class="bg-elevated rounded-xl p-6 text-center cursor-pointer hover:bg-surface transition" onclick="setAnimeGenre('slice-of-life')">
              <div class="text-3xl mb-2">üå∏</div>
              <h3 class="font-semibold">Slice of Life</h3>
              <p class="text-sm text-muted">Daily Life</p>
            </div>
            <div class="bg-elevated rounded-xl p-6 text-center cursor-pointer hover:bg-surface transition" onclick="setAnimeGenre('supernatural')">
              <div class="text-3xl mb-2">üîÆ</div>
              <h3 class="font-semibold">Supernatural</h3>
              <p class="text-sm text-muted">Magic & Mystery</p>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let currentGenre = '';
    let currentSort = 'popularity';
    let animeData = [];
    let isLoading = false;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeAnimePage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeAnimePage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    async function initializeAnimePage() {
      await loadAnimeContent();
      console.log('üéå Anime page initialized');
    }

    async function loadAnimeContent() {
      if (isLoading) return;
      
      isLoading = true;
      showLoading(true);

      try {
        const data = await ContentAPI.getAnime(currentGenre, 40);
        animeData = data.recommendations || data;
        
        if (animeData && animeData.length > 0) {
          sortAndDisplayAnime();
        } else {
          showEmptyState();
        }
        
      } catch (error) {
        console.error('Anime content error:', error);
        showErrorState();
      } finally {
        isLoading = false;
        showLoading(false);
      }
    }

    function sortAndDisplayAnime() {
      let sortedData = [...animeData];
      
      switch (currentSort) {
        case 'rating':
          sortedData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
          break;
        case 'title':
          sortedData.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'year':
          sortedData.sort((a, b) => {
            const yearA = a.release_date ? new Date(a.release_date).getFullYear() : 0;
            const yearB = b.release_date ? new Date(b.release_date).getFullYear() : 0;
            return yearB - yearA;
          });
          break;
        default: // popularity
          // Keep original order (already sorted by popularity from API)
          break;
      }
      
      displayAnimeGrid(sortedData);
    }

    function displayAnimeGrid(anime) {
      const grid = document.getElementById('anime-grid');
      const loadMoreSection = document.getElementById('load-more-section');
      
      grid.innerHTML = '';
      grid.style.display = 'grid';
      
      anime.forEach((item, index) => {
        const card = createAnimeCard(item);
        card.style.animationDelay = `${index * 0.05}s`;
        card.classList.add('animate-on-scroll');
        grid.appendChild(card);
      });
      
      // Show load more if we have enough content
      loadMoreSection.style.display = anime.length >= 20 ? 'block' : 'none';
      
      // Trigger animations
      setTimeout(() => {
        document.querySelectorAll('.animate-on-scroll').forEach(el => {
          el.classList.add('in-view');
        });
      }, 100);
    }

    function createAnimeCard(anime) {
      const card = app.createContentCard(anime);
      
      // Add anime-specific styling
      card.classList.add('anime-card');
      
      // Add anime genres if available
      if (anime.anime_genres && anime.anime_genres.length > 0) {
        const genresContainer = card.querySelector('.card-genres');
        if (genresContainer) {
          const animeGenreChips = anime.anime_genres.map(genre => 
            `<span class="genre-chip anime-genre">${genre}</span>`
          ).join('');
          genresContainer.innerHTML += animeGenreChips;
        }
      }
      
      return card;
    }

    async function loadMoreAnime() {
      if (isLoading) return;
      
      const loadMoreBtn = document.getElementById('load-more-btn');
      const originalText = loadMoreBtn.textContent;
      loadMoreBtn.textContent = 'Loading...';
      loadMoreBtn.disabled = true;

      try {
        const data = await ContentAPI.getAnime(currentGenre, 20);
        const newAnime = data.recommendations || data;
        
        if (newAnime && newAnime.length > 0) {
          // Filter out duplicates
          const existingIds = new Set(animeData.map(item => item.id));
          const uniqueNewAnime = newAnime.filter(item => !existingIds.has(item.id));
          
          if (uniqueNewAnime.length > 0) {
            animeData = [...animeData, ...uniqueNewAnime];
            appendAnimeToGrid(uniqueNewAnime);
          } else {
            loadMoreBtn.style.display = 'none';
            showToast('No more anime available', 'info');
          }
        } else {
          loadMoreBtn.style.display = 'none';
          showToast('No more anime available', 'info');
        }
        
      } catch (error) {
        console.error('Load more anime error:', error);
        showToast('Failed to load more anime', 'error');
      } finally {
        loadMoreBtn.textContent = originalText;
        loadMoreBtn.disabled = false;
      }
    }

    function appendAnimeToGrid(newAnime) {
      const grid = document.getElementById('anime-grid');
      const currentCount = grid.children.length;
      
      newAnime.forEach((item, index) => {
        const card = createAnimeCard(item);
        card.style.animationDelay = `${index * 0.05}s`;
        card.classList.add('animate-on-scroll');
        grid.appendChild(card);
      });
      
      // Animate new items
      setTimeout(() => {
        const newItems = Array.from(grid.children).slice(currentCount);
        newItems.forEach(el => el.classList.add('in-view'));
      }, 100);
    }

    function setAnimeGenre(genre) {
      if (genre === currentGenre) return;
      
      currentGenre = genre;
      
      // Update active filter
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      document.querySelector(`[data-genre="${genre}"]`).classList.add('active');
      
      loadAnimeContent();
    }

    function sortAnime() {
      const newSort = document.getElementById('sort-select').value;
      if (newSort === currentSort) return;
      
      currentSort = newSort;
      
      if (animeData.length > 0) {
        sortAndDisplayAnime();
      }
    }

    function showLoading(show) {
      document.getElementById('anime-loading').style.display = show ? 'block' : 'none';
      document.getElementById('anime-grid').style.display = show ? 'none' : 'grid';
      document.getElementById('popular-categories').style.display = show ? 'none' : 'block';
    }

    function showEmptyState() {
      const grid = document.getElementById('anime-grid');
      grid.innerHTML = `
        <div class="col-span-full">
          <div class="empty-state">
            <h3>üå∏ No Anime Found</h3>
            <p>No anime found for the selected genre</p>
            <button class="btn btn-primary mt-4" onclick="setAnimeGenre('')">View All Anime</button>
          </div>
        </div>
      `;
      grid.style.display = 'grid';
    }

    function showErrorState() {
      const grid = document.getElementById('anime-grid');
      grid.innerHTML = `
        <div class="col-span-full">
          <div class="error-state">
            <h3>‚ö†Ô∏è Loading Error</h3>
            <p>Failed to load anime content</p>
            <button class="btn btn-primary mt-4" onclick="loadAnimeContent()">Try Again</button>
          </div>
        </div>
      `;
      grid.style.display = 'grid';
    }
  </script>

  <style>
    .anime-card {
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .anime-card:hover {
      border-color: rgba(139, 92, 246, 0.5);
    }
    
    .anime-genre {
      background: rgba(139, 92, 246, 0.2);
      color: #a855f7;
    }
  </style>
</body>
</html>