<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trending - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope</a>

                <div class="navbar__menu">
                    <a href="/content/trending.html" class="navbar__link navbar__link--active">Trending</a>
                    <a href="/content/search.html" class="navbar__link">Browse</a>
                    <a href="/content/anime.html" class="navbar__link">Anime</a>
                    <a href="/content/regional.html" class="navbar__link">Regional</a>
                </div>

                <div class="navbar__user" id="navbarUser">
                    <!-- Dynamic user menu -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="app-layout__main">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-header__title">
                        <i class="bi bi-fire text-gold"></i> Trending Now
                    </h1>
                    <p class="page-header__description">
                        Discover what everyone's watching right now
                    </p>
                </div>

                <!-- Filter Tabs -->
                <div class="tabs mb-xl">
                    <ul class="tabs__list">
                        <li class="tabs__item tabs__item--active" data-type="all">All</li>
                        <li class="tabs__item" data-type="movie">Movies</li>
                        <li class="tabs__item" data-type="tv">TV Shows</li>
                    </ul>
                </div>

                <!-- Time Filter -->
                <div class="d-flex justify-between align-center mb-xl">
                    <div class="d-flex gap-sm">
                        <button class="filter-chip filter-chip--active" data-time="day">Today</button>
                        <button class="filter-chip" data-time="week">This Week</button>
                    </div>
                    <select class="form-control" id="regionFilter" style="width: auto;">
                        <option value="">All Regions</option>
                        <option value="US">United States</option>
                        <option value="IN">India</option>
                        <option value="GB">United Kingdom</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                    </select>
                </div>

                <!-- Trending Grid -->
                <div class="content-grid content-grid--movies stagger-animation" id="trendingGrid">
                    <!-- Loading skeletons -->
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                </div>

                <!-- Load More -->
                <div class="text-center mt-xl" id="loadMoreContainer" style="display: none;">
                    <button class="btn btn-secondary" onclick="loadMore()" id="loadMoreBtn">
                        Load More
                    </button>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav__list">
                <li class="mobile-nav__item">
                    <a href="/" class="mobile-nav__link">
                        <i class="bi bi-house mobile-nav__icon"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/search.html" class="mobile-nav__link">
                        <i class="bi bi-search mobile-nav__icon"></i>
                        <span>Search</span>
                    </a>
                </li>
                <li class="mobile-nav__item">
                    <a href="/content/trending.html" class="mobile-nav__link mobile-nav__link--active">
                        <i class="bi bi-fire mobile-nav__icon"></i>
                        <span>Trending</span>
                    </a>
                </li>
                <li class="mobile-nav__item" id="mobileWatchlistItem">
                    <a href="/auth/login.html" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                </li>
                <li class="mobile-nav__item" id="mobileProfileItem">
                    <a href="/auth/login.html" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        let currentType = 'all';
        let currentTime = 'day';
        let currentRegion = '';
        let allContent = [];
        let displayedItems = 20;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            updateNavigation();
            setupFilters();
            loadTrending();
        });

        function updateNavigation() {
            const navbarUser = document.getElementById('navbarUser');
            const mobileWatchlistItem = document.getElementById('mobileWatchlistItem');
            const mobileProfileItem = document.getElementById('mobileProfileItem');

            if (auth.isAuthenticated()) {
                const user = auth.getUser();
                navbarUser.innerHTML = `
                    <a href="${auth.getUserUrl('watchlist')}" class="navbar__link">
                        <i class="bi bi-bookmark"></i>
                    </a>
                    <a href="${auth.getUserUrl('favorites')}" class="navbar__link">
                        <i class="bi bi-heart"></i>
                    </a>
                    <div class="navbar__avatar">
                        <img src="${user.avatar || '/assets/images/default-avatar.png'}" alt="${user.username}">
                    </div>
                `;

                mobileWatchlistItem.innerHTML = `
                    <a href="${auth.getUserUrl('watchlist')}" class="mobile-nav__link">
                        <i class="bi bi-bookmark mobile-nav__icon"></i>
                        <span>Watchlist</span>
                    </a>
                `;

                mobileProfileItem.innerHTML = `
                    <a href="${auth.getUserUrl('profile')}" class="mobile-nav__link">
                        <i class="bi bi-person mobile-nav__icon"></i>
                        <span>Profile</span>
                    </a>
                `;
            } else {
                navbarUser.innerHTML = `
                    <a href="/auth/login.html" class="btn btn-primary">Sign In</a>
                `;
            }
        }

        function setupFilters() {
            // Content type tabs
            document.querySelectorAll('.tabs__item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tabs__item').forEach(t => t.classList.remove('tabs__item--active'));
                    tab.classList.add('tabs__item--active');
                    currentType = tab.dataset.type;
                    displayedItems = 20;
                    loadTrending();
                });
            });

            // Time filter
            document.querySelectorAll('[data-time]').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('[data-time]').forEach(c => c.classList.remove('filter-chip--active'));
                    chip.classList.add('filter-chip--active');
                    currentTime = chip.dataset.time;
                    displayedItems = 20;
                    loadTrending();
                });
            });

            // Region filter
            document.getElementById('regionFilter').addEventListener('change', (e) => {
                currentRegion = e.target.value;
                displayedItems = 20;
                loadTrending();
            });
        }

        async function loadTrending() {
            try {
                // Show loading
                document.getElementById('trendingGrid').innerHTML = `
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                    <div class="content-card skeleton" style="height: 400px;"></div>
                `;

                // Fetch trending content
                const response = await api.getTrending(currentType, 100);
                allContent = response.recommendations || [];

                // Apply filters
                let filteredContent = [...allContent];

                // Region filter (would need region data from API)
                if (currentRegion) {
                    // In production, filter by region
                }

                renderContent();

            } catch (error) {
                console.error('Failed to load trending:', error);
                showToast('Failed to load trending content', 'error');
            }
        }

        function renderContent() {
            const grid = document.getElementById('trendingGrid');
            const itemsToShow = allContent.slice(0, displayedItems);

            grid.innerHTML = itemsToShow.map((item, index) => `
                <div class="content-card animate-fadeInUp" style="animation-delay: ${Math.min(index * 0.05, 0.5)}s">
                    <div class="position-relative">
                        <div class="position-absolute top-0 left-0 p-sm z-10">
                            <span class="badge bg-gradient-primary">
                                <i class="bi bi-fire"></i> #${index + 1}
                            </span>
                        </div>
                        <div class="content-card__image-wrapper" onclick="navigateToContentDetails(${item.id})">
                            <img src="${item.poster_path}" 
                                 alt="${item.title}" 
                                 class="content-card__image"
                                 loading="lazy">
                            ${item.is_new_release ? '<span class="content-card__badge">NEW</span>' : ''}
                        </div>
                    </div>
                    <div class="content-card__body">
                        <h3 class="content-card__title">${item.title}</h3>
                        <div class="content-card__meta">
                            <span class="content-card__rating">
                                <i class="bi bi-star-fill content-card__rating-star"></i>
                                ${item.rating || 'N/A'}
                            </span>
                            <span>${item.content_type}</span>
                        </div>
                        ${item.genres && item.genres.length > 0 ? `
                            <p class="text-xs text-muted mt-sm">${item.genres.slice(0, 3).join(', ')}</p>
                        ` : ''}
                    </div>
                    <div class="content-card__overlay">
                        <p class="text-sm mb-sm">${item.overview || 'No description available.'}</p>
                        <div class="content-card__actions">
                            ${auth.isAuthenticated() ? `
                                <button class="content-card__action-btn" onclick="event.stopPropagation(); addToWatchlist(${item.id})">
                                    <i class="bi bi-plus"></i> Watchlist
                                </button>
                            ` : ''}
                            ${item.youtube_trailer ? `
                                <button class="content-card__action-btn" onclick="event.stopPropagation(); window.open('${item.youtube_trailer}', '_blank')">
                                    <i class="bi bi-play"></i> Trailer
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            // Show/hide load more button
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (allContent.length > displayedItems) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function loadMore() {
            displayedItems += 20;
            renderContent();

            if (displayedItems >= allContent.length) {
                document.getElementById('loadMoreContainer').style.display = 'none';
            }
        }

        async function addToWatchlist(contentId) {
            try {
                await api.recordInteraction(contentId, Config.INTERACTIONS.WATCHLIST);
                showToast('Added to watchlist', 'success');
            } catch (error) {
                showToast('Failed to add to watchlist', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>

</html>