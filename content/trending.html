<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Trending Movies, TV Shows & Anime - CineBrain">
  <title>Trending Now - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <main class="page-main">
      <div class="container py-8">
        <!-- Header -->
        <div class="text-center mb-12">
          <h1 class="text-5xl font-bold mb-4">üî• Trending Now</h1>
          <p class="text-xl text-muted">Discover what's hot and trending worldwide</p>
        </div>

        <!-- Filter Tabs -->
        <div class="flex justify-center mb-8">
          <div class="search-filters">
            <button class="filter-chip active" data-type="all" onclick="setTrendingType('all')">All Content</button>
            <button class="filter-chip" data-type="movie" onclick="setTrendingType('movie')">Movies</button>
            <button class="filter-chip" data-type="tv" onclick="setTrendingType('tv')">TV Shows</button>
            <button class="filter-chip" data-type="anime" onclick="setTrendingType('anime')">Anime</button>
          </div>
        </div>

        <!-- Time Period Selector -->
        <div class="flex justify-center mb-8">
          <div class="flex gap-2 bg-elevated rounded-lg p-1">
            <button class="btn btn-ghost btn-sm active" data-period="day" onclick="setTimePeriod('day')">Today</button>
            <button class="btn btn-ghost btn-sm" data-period="week" onclick="setTimePeriod('week')">This Week</button>
          </div>
        </div>

        <!-- Loading State -->
        <div class="text-center py-12" id="trending-loading">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-muted">Loading trending content...</p>
        </div>

        <!-- Trending Content Grid -->
        <div class="content-grid" id="trending-grid" style="display: none;">
          <!-- Real trending content loaded here -->
        </div>

        <!-- Load More Button -->
        <div class="text-center mt-12" id="load-more-section" style="display: none;">
          <button class="btn btn-outline" id="load-more-btn" onclick="loadMoreTrending()">
            Load More Trending
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-nav"></div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let currentType = 'all';
    let currentPeriod = 'day';
    let currentPage = 1;
    let isLoading = false;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeTrendingPage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeTrendingPage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;

        const mobileNavResponse = await fetch('/components/layout/mobile-nav.html');
        const mobileNavHTML = await mobileNavResponse.text();
        document.getElementById('mobile-nav').innerHTML = mobileNavHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    async function initializeTrendingPage() {
      await loadTrendingContent();
      console.log('üî• Trending page initialized');
    }

    async function loadTrendingContent() {
      if (isLoading) return;
      
      isLoading = true;
      showLoading(true);

      try {
        let data;
        
        if (currentType === 'anime') {
          data = await ContentAPI.getAnime(null, 30);
        } else {
          data = await ContentAPI.getTrending(currentType, 30);
        }
        
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          displayTrendingContent(content);
        } else {
          showEmptyState();
        }
        
      } catch (error) {
        console.error('Trending content error:', error);
        showErrorState();
      } finally {
        isLoading = false;
        showLoading(false);
      }
    }

    function displayTrendingContent(content) {
      const grid = document.getElementById('trending-grid');
      const loadMoreSection = document.getElementById('load-more-section');
      
      grid.innerHTML = '';
      grid.style.display = 'grid';
      
      content.forEach((item, index) => {
        const card = app.createContentCard(item);
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-on-scroll');
        grid.appendChild(card);
      });
      
      // Show load more if we have enough content
      if (content.length >= 20) {
        loadMoreSection.style.display = 'block';
      } else {
        loadMoreSection.style.display = 'none';
      }
      
      // Trigger scroll animations
      setTimeout(() => {
        document.querySelectorAll('.animate-on-scroll').forEach(el => {
          el.classList.add('in-view');
        });
      }, 100);
    }

    async function loadMoreTrending() {
      if (isLoading) return;
      
      const loadMoreBtn = document.getElementById('load-more-btn');
      const originalText = loadMoreBtn.textContent;
      loadMoreBtn.textContent = 'Loading...';
      loadMoreBtn.disabled = true;

      try {
        let data;
        const moreLimit = 20;
        
        if (currentType === 'anime') {
          data = await ContentAPI.getAnime(null, moreLimit);
        } else {
          data = await ContentAPI.getTrending(currentType, moreLimit);
        }
        
        const content = data.recommendations || data;
        
        if (content && content.length > 0) {
          appendTrendingContent(content);
        } else {
          loadMoreBtn.style.display = 'none';
          showToast('No more trending content available', 'info');
        }
        
      } catch (error) {
        console.error('Load more error:', error);
        showToast('Failed to load more content', 'error');
      } finally {
        loadMoreBtn.textContent = originalText;
        loadMoreBtn.disabled = false;
      }
    }

    function appendTrendingContent(content) {
      const grid = document.getElementById('trending-grid');
      const currentCount = grid.children.length;
      
      content.forEach((item, index) => {
        const card = app.createContentCard(item);
        card.style.animationDelay = `${index * 0.05}s`;
        card.classList.add('animate-on-scroll');
        grid.appendChild(card);
      });
      
      // Animate new items
      setTimeout(() => {
        const newItems = Array.from(grid.children).slice(currentCount);
        newItems.forEach(el => el.classList.add('in-view'));
      }, 100);
    }

    function setTrendingType(type) {
      if (type === currentType) return;
      
      currentType = type;
      currentPage = 1;
      
      // Update active filter
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
      });
      document.querySelector(`[data-type="${type}"]`).classList.add('active');
      
      loadTrendingContent();
    }

    function setTimePeriod(period) {
      if (period === currentPeriod) return;
      
      currentPeriod = period;
      
      // Update active period
      document.querySelectorAll('[data-period]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-period="${period}"]`).classList.add('active');
      
      // Note: Backend doesn't support time periods, but UI is ready
      showToast(`Time period changed to ${period === 'day' ? 'today' : 'this week'}`, 'info');
    }

    function showLoading(show) {
      document.getElementById('trending-loading').style.display = show ? 'block' : 'none';
      document.getElementById('trending-grid').style.display = show ? 'none' : 'grid';
    }

    function showEmptyState() {
      const grid = document.getElementById('trending-grid');
      grid.innerHTML = `
        <div class="col-span-full">
          <div class="empty-state">
            <h3>üòî No Trending Content</h3>
            <p>No trending content found for the selected category</p>
            <button class="btn btn-primary mt-4" onclick="setTrendingType('all')">View All Content</button>
          </div>
        </div>
      `;
      grid.style.display = 'grid';
    }

    function showErrorState() {
      const grid = document.getElementById('trending-grid');
      grid.innerHTML = `
        <div class="col-span-full">
          <div class="error-state">
            <h3>‚ö†Ô∏è Loading Error</h3>
            <p>Failed to load trending content</p>
            <button class="btn btn-primary mt-4" onclick="loadTrendingContent()">Try Again</button>
          </div>
        </div>
      `;
      grid.style.display = 'grid';
    }
  </script>
</body>
</html>