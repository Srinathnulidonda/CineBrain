<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CineScope</title>
    <meta name="description" content="Manage your CineScope profile and preferences.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Profile...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Profile Header -->
            <div class="card mb-8">
                <div class="card-content">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="avatar avatar-lg" id="profileAvatar">
                            <span id="profileInitials">U</span>
                        </div>
                        <div class="flex-1 text-center md:text-left">
                            <h1 class="text-3xl font-bold" id="profileUsername">Username</h1>
                            <p class="text-gray-400" id="profileEmail">user@example.com</p>
                            <p class="text-sm text-gray-500 mt-2">Member since <span id="memberSince">January 2025</span></p>
                        </div>
                        <div class="flex gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-primary" id="totalWatchlist">0</div>
                                <div class="text-sm text-gray-400">Watchlist</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-secondary" id="totalFavorites">0</div>
                                <div class="text-sm text-gray-400">Favorites</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tabs -->
            <div class="tabs" id="profileTabs">
                <div class="tab-list">
                    <button class="tab-button active" data-tab="settings">Account Settings</button>
                    <button class="tab-button" data-tab="preferences">Preferences</button>
                    <button class="tab-button" data-tab="activity">Activity</button>
                    <button class="tab-button" data-tab="privacy">Privacy</button>
                </div>

                <div class="tab-content">
                    <!-- Account Settings Tab -->
                    <div class="tab-panel active" data-panel="settings">
                        <div class="card">
                            <div class="card-content">
                                <h2 class="text-xl font-semibold mb-6">Account Information</h2>
                                <form id="accountForm" class="space-y-6">
                                    <div class="grid grid-1 md:grid-2 gap-6">
                                        <div class="form-group">
                                            <label for="username" class="form-label">Username</label>
                                            <input type="text" id="username" name="username" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" id="email" name="email" class="form-input" required>
                                        </div>
                                    </div>

                                    <div class="border-t border-gray-700 pt-6">
                                        <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                                        <div class="grid grid-1 md:grid-2 gap-6">
                                            <div class="form-group">
                                                <label for="currentPassword" class="form-label">Current Password</label>
                                                <input type="password" id="currentPassword" name="currentPassword" class="form-input">
                                            </div>
                                            <div class="form-group">
                                                <label for="newPassword" class="form-label">New Password</label>
                                                <input type="password" id="newPassword" name="newPassword" class="form-input">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex justify-end gap-4">
                                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Preferences Tab -->
                    <div class="tab-panel" data-panel="preferences">
                        <div class="space-y-6">
                            <!-- Language Preferences -->
                            <div class="card">
                                <div class="card-content">
                                    <h3 class="text-lg font-semibold mb-4">Language Preferences</h3>
                                    <div class="grid grid-2 md:grid-3 gap-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="languages" value="english" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">English</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="languages" value="hindi" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Hindi</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="languages" value="telugu" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Telugu</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="languages" value="tamil" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Tamil</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="languages" value="kannada" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Kannada</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="languages" value="malayalam" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Malayalam</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Genre Preferences -->
                            <div class="card">
                                <div class="card-content">
                                    <h3 class="text-lg font-semibold mb-4">Favorite Genres</h3>
                                    <div class="grid grid-2 md:grid-4 gap-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="action" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Action</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="comedy" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Comedy</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="drama" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Drama</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="thriller" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Thriller</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="romance" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Romance</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="sci-fi" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Sci-Fi</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="horror" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Horror</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="genres" value="fantasy" class="rounded border-gray-600 bg-gray-700 text-primary">
                                            <span class="ml-3">Fantasy</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Notification Preferences -->
                            <div class="card">
                                <div class="card-content">
                                    <h3 class="text-lg font-semibold mb-4">Notifications</h3>
                                    <div class="space-y-4">
                                        <label class="flex items-center justify-between">
                                            <span>New recommendations</span>
                                            <input type="checkbox" class="toggle" checked>
                                        </label>
                                        <label class="flex items-center justify-between">
                                            <span>New releases in favorite genres</span>
                                            <input type="checkbox" class="toggle" checked>
                                        </label>
                                        <label class="flex items-center justify-between">
                                            <span>Weekly newsletter</span>
                                            <input type="checkbox" class="toggle">
                                        </label>
                                        <label class="flex items-center justify-between">
                                            <span>Email notifications</span>
                                            <input type="checkbox" class="toggle" checked>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button class="btn btn-primary" onclick="savePreferences()">Save Preferences</button>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div class="tab-panel" data-panel="activity">
                        <div class="space-y-6">
                            <!-- Recent Activity -->
                            <div class="card">
                                <div class="card-content">
                                    <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                                    <div id="recentActivity">
                                        <!-- Activity content will be loaded here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Statistics -->
                            <div class="grid grid-1 md:grid-3 gap-6">
                                <div class="stats-card">
                                    <div class="stats-value" id="totalViews">0</div>
                                    <div class="stats-label">Total Views</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value" id="totalRatings">0</div>
                                    <div class="stats-label">Ratings Given</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value" id="avgRating">0</div>
                                    <div class="stats-label">Average Rating</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Privacy Tab -->
                    <div class="tab-panel" data-panel="privacy">
                        <div class="space-y-6">
                            <!-- Privacy Settings -->
                            <div class="card">
                                <div class="card-content">
                                    <h3 class="text-lg font-semibold mb-4">Privacy Settings</h3>
                                    <div class="space-y-4">
                                        <label class="flex items-center justify-between">
                                            <div>
                                                <span class="font-medium">Public Profile</span>
                                                <p class="text-sm text-gray-400">Allow others to see your profile</p>
                                            </div>
                                            <input type="checkbox" class="toggle">
                                        </label>
                                        <label class="flex items-center justify-between">
                                            <div>
                                                <span class="font-medium">Share Watchlist</span>
                                                <p class="text-sm text-gray-400">Make your watchlist public</p>
                                            </div>
                                            <input type="checkbox" class="toggle">
                                        </label>
                                        <label class="flex items-center justify-between">
                                            <div>
                                                <span class="font-medium">Activity Tracking</span>
                                                <p class="text-sm text-gray-400">Allow tracking for better recommendations</p>
                                            </div>
                                            <input type="checkbox" class="toggle" checked>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Management -->
                            <div class="card">
                                <div class="card-content">
                                    <h3 class="text-lg font-semibold mb-4">Data Management</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between p-4 bg-gray-800 rounded-lg">
                                            <div>
                                                <span class="font-medium">Export Data</span>
                                                <p class="text-sm text-gray-400">Download your data in JSON format</p>
                                            </div>
                                            <button class="btn btn-secondary btn-sm" onclick="exportData()">Export</button>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-red-900/20 border border-red-500/30 rounded-lg">
                                            <div>
                                                <span class="font-medium text-red-400">Delete Account</span>
                                                <p class="text-sm text-gray-400">Permanently delete your account and data</p>
                                            </div>
                                            <button class="btn btn-error btn-sm" onclick="deleteAccount()">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!appState.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            UI.initTabs(document.getElementById('profileTabs'));
            await loadProfileData();
            loadUserActivity();
        });

        async function loadProfileData() {
            const user = appState.user;
            if (!user) return;

            // Update profile info
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileInitials').textContent = user.username.charAt(0).toUpperCase();
            
            // Set form values
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;

            // Set member since date
            if (user.created_at) {
                const date = new Date(user.created_at);
                document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
            }

            // Load preferences
            if (user.preferred_languages) {
                const languages = JSON.parse(user.preferred_languages);
                languages.forEach(lang => {
                    const checkbox = document.querySelector(`input[name="languages"][value="${lang}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            if (user.preferred_genres) {
                const genres = JSON.parse(user.preferred_genres);
                genres.forEach(genre => {
                    const checkbox = document.querySelector(`input[name="genres"][value="${genre}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Load user stats
            try {
                const [watchlistResponse, favoritesResponse] = await Promise.all([
                    api.getWatchlist(),
                    api.getFavorites()
                ]);

                document.getElementById('totalWatchlist').textContent = watchlistResponse.watchlist?.length || 0;
                document.getElementById('totalFavorites').textContent = favoritesResponse.favorites?.length || 0;
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        function loadUserActivity() {
            // Simulate activity data
            const activities = [
                { type: 'view', title: 'The Dark Knight', time: '2 hours ago' },
                { type: 'favorite', title: 'Inception', time: '1 day ago' },
                { type: 'watchlist', title: 'Interstellar', time: '2 days ago' },
                { type: 'rating', title: 'The Matrix', rating: 9, time: '3 days ago' }
            ];

            const container = document.getElementById('recentActivity');
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-4">📊</div>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(activity => {
                const icon = activity.type === 'view' ? '👁️' : 
                           activity.type === 'favorite' ? '❤️' : 
                           activity.type === 'watchlist' ? '📋' : '⭐';
                
                const action = activity.type === 'view' ? 'Watched' :
                             activity.type === 'favorite' ? 'Added to favorites' :
                             activity.type === 'watchlist' ? 'Added to watchlist' :
                             `Rated ${activity.rating}/10`;

                return `
                    <div class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-lg transition-colors">
                        <div class="text-2xl">${icon}</div>
                        <div class="flex-1">
                            <p><strong>${activity.title}</strong></p>
                            <p class="text-sm text-gray-400">${action} • ${activity.time}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Update stats
            document.getElementById('totalViews').textContent = activities.filter(a => a.type === 'view').length;
            document.getElementById('totalRatings').textContent = activities.filter(a => a.type === 'rating').length;
            const avgRating = activities.filter(a => a.type === 'rating').reduce((sum, a) => sum + a.rating, 0) / activities.filter(a => a.type === 'rating').length || 0;
            document.getElementById('avgRating').textContent = avgRating.toFixed(1);
        }

        // Form handlers
        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const username = formData.get('username');
            const email = formData.get('email');
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');

            if (!username || !email) {
                UI.showToast('Please fill in required fields', 'error');
                return;
            }

            if (newPassword && !currentPassword) {
                UI.showToast('Current password required to change password', 'error');
                return;
            }

            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Update local user data
                appState.user.username = username;
                appState.user.email = email;
                appState.saveToStorage();

                UI.showToast('Profile updated successfully!', 'success');
                
                // Update displayed info
                document.getElementById('profileUsername').textContent = username;
                document.getElementById('profileEmail').textContent = email;
                document.getElementById('profileInitials').textContent = username.charAt(0).toUpperCase();

            } catch (error) {
                UI.showToast('Failed to update profile', 'error');
            } finally {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        });

        function resetForm() {
            document.getElementById('accountForm').reset();
            loadProfileData();
        }

        async function savePreferences() {
            const languages = Array.from(document.querySelectorAll('input[name="languages"]:checked')).map(cb => cb.value);
            const genres = Array.from(document.querySelectorAll('input[name="genres"]:checked')).map(cb => cb.value);

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Update local preferences
                appState.user.preferred_languages = JSON.stringify(languages);
                appState.user.preferred_genres = JSON.stringify(genres);
                appState.saveToStorage();

                UI.showToast('Preferences saved successfully!', 'success');
            } catch (error) {
                UI.showToast('Failed to save preferences', 'error');
            }
        }

        function exportData() {
            const userData = {
                profile: appState.user,
                preferences: appState.preferences,
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `cinescope-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            UI.showToast('Data exported successfully!', 'success');
        }

        function deleteAccount() {
            UI.showModal(`
                <div class="text-center">
                    <div class="text-6xl mb-4">⚠️</div>
                    <h3 class="text-2xl font-semibold mb-4 text-red-400">Delete Account?</h3>
                    <p class="text-gray-400 mb-6">
                        This action cannot be undone. All your data, including watchlist, 
                        favorites, and activity history will be permanently deleted.
                    </p>
                    <div class="mb-6">
                        <input type="text" id="confirmUsername" placeholder="Type your username to confirm" 
                               class="form-input text-center">
                    </div>
                    <div class="flex justify-center gap-4">
                        <button class="btn btn-secondary" onclick="UI.hideModal(this.closest('.modal-overlay'))">
                            Cancel
                        </button>
                        <button class="btn btn-error" onclick="confirmDeleteAccount()">
                            Delete Account
                        </button>
                    </div>
                </div>
            `, '');
        }

        function confirmDeleteAccount() {
            const confirmUsername = document.getElementById('confirmUsername').value;
            if (confirmUsername !== appState.user.username) {
                UI.showToast('Username does not match', 'error');
                return;
            }

            // Simulate account deletion
            UI.showToast('Account deletion request submitted', 'success');
            UI.hideModal(document.querySelector('.modal-overlay'));
            
            setTimeout(() => {
                appState.logout();
                window.location.href = '/';
            }, 2000);
        }
    </script>
</body>
</html>