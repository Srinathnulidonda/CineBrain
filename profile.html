<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CineScope</title>
    <meta name="description" content="Manage your CineScope profile and preferences for better recommendations.">
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .profile-header {
            background: var(--gradient-dark);
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--gradient-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: bold;
        }
        
        .profile-details h1 {
            margin-bottom: 0.5rem;
        }
        
        .profile-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-blue);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .profile-tabs {
            margin-bottom: 2rem;
        }
        
        .profile-section {
            background: var(--dark-surface);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 0.5rem;
        }
        
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .preference-group {
            background: var(--dark-surface-2);
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }
        
        .preference-group h4 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .activity-timeline {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-smooth);
        }
        
        .activity-item:hover {
            background: var(--dark-surface-2);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .activity-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .recommendation-card {
            background: var(--dark-surface-2);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition-smooth);
            cursor: pointer;
        }
        
        .recommendation-card:hover {
            transform: translateY(-2px);
        }
        
        .recommendation-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }
        
        .recommendation-info {
            padding: 0.75rem;
        }
        
        .recommendation-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .recommendation-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .privacy-settings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .privacy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--dark-surface-2);
            border-radius: var(--border-radius);
        }
        
        .privacy-info h4 {
            margin-bottom: 0.25rem;
        }
        
        .privacy-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #333;
            border-radius: 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        
        .toggle-switch.active {
            background: var(--primary-blue);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: var(--transition-smooth);
        }
        
        .toggle-switch.active::after {
            transform: translateX(25px);
        }
        
        @media (max-width: 768px) {
            .profile-info {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-stats {
                justify-content: center;
            }
            
            .preferences-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <main style="padding-top: 80px;">
        <!-- Profile Header -->
        <section class="profile-header">
            <div class="container">
                <div class="profile-info">
                    <div class="profile-avatar" id="profileAvatar">
                        <!-- Avatar initials will be inserted here -->
                    </div>
                    <div class="profile-details">
                        <h1 id="profileName">Loading...</h1>
                        <p class="text-secondary" id="profileEmail">Loading...</p>
                        <div class="profile-stats" id="profileStats">
                            <div class="stat-item">
                                <div class="stat-number" id="watchlistCount">0</div>
                                <div class="stat-label">Watchlist</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="favoritesCount">0</div>
                                <div class="stat-label">Favorites</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="ratingsCount">0</div>
                                <div class="stat-label">Ratings</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="container">
            <!-- Profile Tabs -->
            <div class="profile-tabs">
                <div class="tabs">
                    <ul class="tab-list">
                        <li><button class="tab-button active" data-tab="preferences">Preferences</button></li>
                        <li><button class="tab-button" data-tab="activity">Activity</button></li>
                        <li><button class="tab-button" data-tab="recommendations">Recommendations</button></li>
                        <li><button class="tab-button" data-tab="privacy">Privacy</button></li>
                        <li><button class="tab-button" data-tab="account">Account</button></li>
                    </ul>
                </div>
            </div>

            <!-- Preferences Tab -->
            <div class="tab-content active" id="preferences-tab">
                <div class="profile-section">
                    <h2 class="section-title">Content Preferences</h2>
                    <form id="preferencesForm">
                        <div class="preferences-grid">
                            <div class="preference-group">
                                <h4>Preferred Languages</h4>
                                <div class="checkbox-list" id="languagePreferences">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lang-english" name="languages" value="english">
                                        <label for="lang-english">English</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lang-hindi" name="languages" value="hindi">
                                        <label for="lang-hindi">Hindi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lang-telugu" name="languages" value="telugu">
                                        <label for="lang-telugu">Telugu</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lang-tamil" name="languages" value="tamil">
                                        <label for="lang-tamil">Tamil</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lang-kannada" name="languages" value="kannada">
                                        <label for="lang-kannada">Kannada</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="lang-malayalam" name="languages" value="malayalam">
                                        <label for="lang-malayalam">Malayalam</label>
                                    </div>
                                </div>
                            </div>

                            <div class="preference-group">
                                <h4>Favorite Genres</h4>
                                <div class="checkbox-list" id="genrePreferences">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-action" name="genres" value="action">
                                        <label for="genre-action">Action</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-comedy" name="genres" value="comedy">
                                        <label for="genre-comedy">Comedy</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-drama" name="genres" value="drama">
                                        <label for="genre-drama">Drama</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-horror" name="genres" value="horror">
                                        <label for="genre-horror">Horror</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-romance" name="genres" value="romance">
                                        <label for="genre-romance">Romance</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-thriller" name="genres" value="thriller">
                                        <label for="genre-thriller">Thriller</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-sci-fi" name="genres" value="sci-fi">
                                        <label for="genre-sci-fi">Sci-Fi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="genre-fantasy" name="genres" value="fantasy">
                                        <label for="genre-fantasy">Fantasy</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                    </form>
                </div>
            </div>

            <!-- Activity Tab -->
            <div class="tab-content" id="activity-tab">
                <div class="profile-section">
                    <h2 class="section-title">Recent Activity</h2>
                    <div class="activity-timeline" id="activityTimeline">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div class="tab-content" id="recommendations-tab">
                <div class="profile-section">
                    <h2 class="section-title">Your Personalized Recommendations</h2>
                    <div class="recommendations-grid" id="personalizedRecommendations">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Privacy Tab -->
            <div class="tab-content" id="privacy-tab">
                <div class="profile-section">
                    <h2 class="section-title">Privacy Settings</h2>
                    <div class="privacy-settings">
                        <div class="privacy-item">
                            <div class="privacy-info">
                                <h4>Public Profile</h4>
                                <p class="privacy-description">Allow others to see your watchlist and favorites</p>
                            </div>
                            <div class="toggle-switch" onclick="togglePrivacySetting(this, 'public_profile')"></div>
                        </div>
                        <div class="privacy-item">
                            <div class="privacy-info">
                                <h4>Activity Tracking</h4>
                                <p class="privacy-description">Track your viewing activity to improve recommendations</p>
                            </div>
                            <div class="toggle-switch active" onclick="togglePrivacySetting(this, 'activity_tracking')"></div>
                        </div>
                        <div class="privacy-item">
                            <div class="privacy-info">
                                <h4>Email Notifications</h4>
                                <p class="privacy-description">Receive email updates about new releases and recommendations</p>
                            </div>
                            <div class="toggle-switch" onclick="togglePrivacySetting(this, 'email_notifications')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Tab -->
            <div class="tab-content" id="account-tab">
                <div class="profile-section">
                    <h2 class="section-title">Account Settings</h2>
                    <form id="accountForm">
                        <div class="form-group">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="form-input">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </form>
                    
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <h3 style="color: #ef4444; margin-bottom: 1rem;">Danger Zone</h3>
                        <p class="text-secondary" style="margin-bottom: 1rem;">
                            Deleting your account will permanently remove all your data, including watchlists, favorites, and ratings.
                        </p>
                        <button class="btn" style="background: #ef4444; color: white;" onclick="confirmDeleteAccount()">
                            Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div data-include="footer"></div>

    <!-- Scripts -->
    <script src="/js/include.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) return;
            
            initializeProfile();
            setupTabSwitching();
            setupForms();
        });

        function initializeProfile() {
            const user = getCurrentUser();
            
            // Update profile info
            document.getElementById('profileName').textContent = user.username;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileAvatar').textContent = user.username.charAt(0).toUpperCase();
            
            // Load user stats
            loadUserStats();
            
            // Load preferences
            loadUserPreferences();
            
            // Load activity
            loadUserActivity();
            
            // Load recommendations
            loadPersonalizedRecommendations();
        }

        async function loadUserStats() {
            try {
                const [watchlistResponse, favoritesResponse] = await Promise.all([
                    ApiService.getWatchlist(),
                    ApiService.getFavorites()
                ]);

                const watchlistCount = watchlistResponse.success ? watchlistResponse.data.watchlist.length : 0;
                const favoritesCount = favoritesResponse.success ? favoritesResponse.data.favorites.length : 0;

                document.getElementById('watchlistCount').textContent = watchlistCount;
                document.getElementById('favoritesCount').textContent = favoritesCount;
                document.getElementById('ratingsCount').textContent = '0'; // Would come from interactions
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        function loadUserPreferences() {
            const user = getCurrentUser();
            
            // Load language preferences
            const languages = user.preferred_languages || [];
            languages.forEach(lang => {
                const checkbox = document.getElementById(`lang-${lang}`);
                if (checkbox) checkbox.checked = true;
            });
            
            // Load genre preferences
            const genres = user.preferred_genres || [];
            genres.forEach(genre => {
                const checkbox = document.getElementById(`genre-${genre}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        async function loadUserActivity() {
            const container = document.getElementById('activityTimeline');
            
            try {
                // For demo, create mock activity data
                const activities = [
                    { type: 'view', title: 'Watched Avengers: Endgame', time: '2 hours ago', icon: 'play' },
                    { type: 'favorite', title: 'Added Inception to favorites', time: '1 day ago', icon: 'heart' },
                    { type: 'watchlist', title: 'Added Breaking Bad to watchlist', time: '2 days ago', icon: 'bookmark' },
                    { type: 'rating', title: 'Rated The Dark Knight 9/10', time: '3 days ago', icon: 'star' },
                    { type: 'view', title: 'Watched Naruto Episode 1', time: '1 week ago', icon: 'play' }
                ];

                container.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-meta">${activity.time}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading activity:', error);
                container.innerHTML = '<p class="text-secondary">Unable to load activity</p>';
            }
        }

        async function loadPersonalizedRecommendations() {
            const container = document.getElementById('personalizedRecommendations');
            
            try {
                showLoadingSkeleton(container);
                
                const response = await ApiService.getPersonalizedRecommendations(12);
                
                if (response.success && response.data.recommendations) {
                    container.innerHTML = response.data.recommendations.map(item => `
                        <div class="recommendation-card" onclick="viewDetails(${item.id})">
                            <img src="${item.poster_path || '/assets/images/placeholder.jpg'}" 
                                 alt="${item.title}" class="recommendation-poster">
                            <div class="recommendation-info">
                                <div class="recommendation-title">${item.title}</div>
                                <div class="recommendation-meta">${item.content_type} â€¢ ${item.rating || 'N/A'}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-secondary">No recommendations available</p>';
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                container.innerHTML = '<p class="text-secondary">Unable to load recommendations</p>';
            }
        }

        function setupTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
        }

        function setupForms() {
            // Preferences form
            const preferencesForm = document.getElementById('preferencesForm');
            preferencesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await updatePreferences();
            });
            
            // Account form
            const accountForm = document.getElementById('accountForm');
            accountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await updatePassword();
            });
        }

        async function updatePreferences() {
            const formData = new FormData(document.getElementById('preferencesForm'));
            const languages = Array.from(formData.getAll('languages'));
            const genres = Array.from(formData.getAll('genres'));
            
            try {
                // Update local user data
                const user = getCurrentUser();
                user.preferred_languages = languages;
                user.preferred_genres = genres;
                
                Auth.updateUserProfile(user);
                
                showToast('Preferences updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating preferences:', error);
                showToast('Failed to update preferences', 'error');
            }
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all fields', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters long', 'error');
                return;
            }
            
            try {
                // This would typically make an API call to update password
                showToast('Password updated successfully!', 'success');
                
                // Clear form
                document.getElementById('accountForm').reset();
            } catch (error) {
                console.error('Error updating password:', error);
                showToast('Failed to update password', 'error');
            }
        }

        function togglePrivacySetting(toggle, setting) {
            toggle.classList.toggle('active');
            
            // Here you would typically save the setting to the backend
            const isEnabled = toggle.classList.contains('active');
            console.log(`Privacy setting ${setting} is now ${isEnabled ? 'enabled' : 'disabled'}`);
            
            showToast(`Privacy setting updated`, 'success');
        }

        function confirmDeleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    deleteAccount();
                }
            }
        }

        async function deleteAccount() {
            try {
                // This would make an API call to delete the account
                showToast('Account deletion initiated. You will be logged out.', 'warning');
                
                setTimeout(() => {
                    Auth.logout();
                }, 2000);
            } catch (error) {
                console.error('Error deleting account:', error);
                showToast('Failed to delete account', 'error');
            }
        }

        function showLoadingSkeleton(container) {
            container.innerHTML = Array(12).fill().map(() => `
                <div class="recommendation-card skeleton">
                    <div style="aspect-ratio: 2/3; background: var(--dark-surface-2);"></div>
                    <div class="recommendation-info">
                        <div style="height: 1rem; background: var(--dark-surface-2); margin-bottom: 0.5rem;"></div>
                        <div style="height: 0.75rem; background: var(--dark-surface-2); width: 60%;"></div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>