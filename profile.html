<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CineScope</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .profile-container {
            margin-top: 64px;
            min-height: calc(100vh - 64px);
            padding: var(--spacing-xl) 0;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border-radius: 1rem;
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-xl);
            color: white;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .profile-details h1 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 2.5rem;
        }

        .profile-details p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.125rem;
        }

        .profile-stats {
            display: flex;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .profile-stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-md);
            border-radius: 0.5rem;
            min-width: 100px;
        }

        .profile-stat-number {
            display: block;
            font-size: 2rem;
            font-weight: bold;
        }

        .profile-stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .profile-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: var(--spacing-xl);
        }

        .profile-main {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-xl);
        }

        .profile-sidebar {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .profile-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
        }

        .profile-section h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .preference-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .preference-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .preference-list li:last-child {
            border-bottom: none;
        }

        .remove-btn {
            background: var(--error);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--spacing-xs) 0;
        }

        .activity-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-md);
        }

        .achievement-item {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--dark-bg);
            border-radius: 0.5rem;
            transition: all var(--transition-fast);
        }

        .achievement-item.earned {
            background: var(--success);
            color: white;
        }

        .achievement-item:hover {
            transform: translateY(-2px);
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .achievement-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0;
        }

        @media (max-width: 1023px) {
            .profile-content {
                grid-template-columns: 1fr;
            }

            .profile-sidebar {
                order: -1;
            }
        }

        @media (max-width: 767px) {
            .profile-info {
                flex-direction: column;
                text-align: center;
            }

            .profile-stats {
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div data-include="header"></div>

    <div class="profile-container">
        <div class="container">
            <div class="profile-header">
                <div class="profile-info">
                    <div class="profile-avatar" id="profile-avatar">
                        <!-- Avatar will be generated from username -->
                    </div>
                    <div class="profile-details">
                        <h1 id="profile-username">Loading...</h1>
                        <p id="profile-email">Loading...</p>
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <span class="profile-stat-number" id="watchlist-count">0</span>
                                <span class="profile-stat-label">Watchlist</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-number" id="favorites-count">0</span>
                                <span class="profile-stat-label">Favorites</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-number" id="interactions-count">0</span>
                                <span class="profile-stat-label">Interactions</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-number" id="member-since">2024</span>
                                <span class="profile-stat-label">Member Since</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-content">
                <div class="profile-main">
                    <h2>Account Settings</h2>

                    <form id="profile-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" id="username" name="username" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" name="email" class="form-input" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="location" class="form-label">Location (Optional)</label>
                            <input type="text" id="location" name="location" class="form-input"
                                placeholder="e.g., Mumbai, India">
                        </div>

                        <h3 style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-lg);">Change Password
                        </h3>

                        <div class="form-group">
                            <label for="current-password" class="form-label">Current Password</label>
                            <input type="password" id="current-password" name="current-password" class="form-input">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-password" class="form-label">New Password</label>
                                <input type="password" id="new-password" name="new-password" class="form-input"
                                    minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password" class="form-label">Confirm Password</label>
                                <input type="password" id="confirm-password" name="confirm-password" class="form-input"
                                    minlength="6">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <div class="profile-sidebar">
                    <div class="profile-section">
                        <h3>Preferred Languages</h3>
                        <ul class="preference-list" id="language-preferences">
                            <!-- Language preferences will be loaded here -->
                        </ul>
                        <button class="btn btn-secondary btn-sm" onclick="profile.addLanguage()">Add Language</button>
                    </div>

                    <div class="profile-section">
                        <h3>Preferred Genres</h3>
                        <ul class="preference-list" id="genre-preferences">
                            <!-- Genre preferences will be loaded here -->
                        </ul>
                        <button class="btn btn-secondary btn-sm" onclick="profile.addGenre()">Add Genre</button>
                    </div>

                    <div class="profile-section">
                        <h3>Recent Activity</h3>
                        <div id="recent-activity">
                            <!-- Recent activity will be loaded here -->
                        </div>
                    </div>

                    <div class="profile-section">
                        <h3>Achievements</h3>
                        <div class="achievement-grid" id="achievements">
                            <!-- Achievements will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div data-include="footer"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class Profile {
            constructor() {
                this.userPreferences = {
                    languages: [],
                    genres: []
                };
                this.achievements = [
                    { id: 'first_watch', icon: 'üé¨', title: 'First Watch', description: 'Watched your first movie' },
                    { id: 'movie_buff', icon: 'üçø', title: 'Movie Buff', description: 'Watched 10 movies' },
                    { id: 'series_fan', icon: 'üì∫', title: 'Series Fan', description: 'Watched 5 TV series' },
                    { id: 'anime_lover', icon: 'üé≠', title: 'Anime Lover', description: 'Watched 5 anime' },
                    { id: 'critic', icon: '‚≠ê', title: 'Critic', description: 'Rated 20 items' },
                    { id: 'explorer', icon: 'üó∫Ô∏è', title: 'Explorer', description: 'Watched content in 3 languages' }
                ];
                this.init();
            }

            async init() {
                if (!app.token) {
                    window.location.href = '/login';
                    return;
                }

                await this.loadUserProfile();
                this.setupForm();
            }

            async loadUserProfile() {
                try {
                    app.showLoading('Loading profile...');

                    // Load user data and stats
                    const [userStats, watchlist, favorites] = await Promise.all([
                        this.loadUserStats(),
                        app.apiCall('/user/watchlist'),
                        app.apiCall('/user/favorites')
                    ]);

                    this.populateProfile();
                    this.loadUserPreferences();
                    this.loadRecentActivity();
                    this.loadAchievements();

                    // Update stats
                    document.getElementById('watchlist-count').textContent = watchlist?.watchlist?.length || 0;
                    document.getElementById('favorites-count').textContent = favorites?.favorites?.length || 0;

                } catch (error) {
                    console.error('Failed to load profile:', error);
                    app.showNotification('Failed to load profile', 'error');
                } finally {
                    app.hideLoading();
                }
            }

            populateProfile() {
                if (app.user) {
                    const avatar = document.getElementById('profile-avatar');
                    const username = document.getElementById('profile-username');
                    const email = document.getElementById('profile-email');
                    const memberSince = document.getElementById('member-since');

                    // Generate avatar from username
                    avatar.textContent = app.user.username.charAt(0).toUpperCase();
                    username.textContent = app.user.username;
                    email.textContent = app.user.email;

                    // Set form values
                    document.getElementById('username').value = app.user.username;
                    document.getElementById('email').value = app.user.email;

                    // Set member since (you might want to get this from user data)
                    memberSince.textContent = '2024';

                    this.userPreferences.languages = app.user.preferred_languages || [];
                    this.userPreferences.genres = app.user.preferred_genres || [];
                }
            }

            loadUserPreferences() {
                this.renderPreferences('language-preferences', this.userPreferences.languages, 'language');
                this.renderPreferences('genre-preferences', this.userPreferences.genres, 'genre');
            }

            renderPreferences(containerId, preferences, type) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (preferences.length === 0) {
                    container.innerHTML = '<li style="color: var(--text-muted);">No preferences set</li>';
                    return;
                }

                container.innerHTML = preferences.map(pref => `
                    <li>
                        <span>${pref}</span>
                        <button class="remove-btn" onclick="profile.removePreference('${type}', '${pref}')">Remove</button>
                    </li>
                `).join('');
            }

            async loadUserStats() {
                // This would typically come from an API call
                return {
                    interactions: 42,
                    memberSince: '2024'
                };
            }

            loadRecentActivity() {
                // Mock recent activity data
                const activities = [
                    { type: 'watch', title: 'Watched Avatar: The Way of Water', time: '2 hours ago', icon: 'üëÅÔ∏è' },
                    { type: 'favorite', title: 'Added to favorites: Dune', time: '1 day ago', icon: '‚ù§Ô∏è' },
                    { type: 'watchlist', title: 'Added to watchlist: Oppenheimer', time: '2 days ago', icon: 'üìã' },
                    { type: 'rating', title: 'Rated The Batman', time: '3 days ago', icon: '‚≠ê' }
                ];

                const container = document.getElementById('recent-activity');
                container.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-content">
                            <p class="activity-title">${activity.title}</p>
                            <p class="activity-meta">${activity.time}</p>
                        </div>
                    </div>
                `).join('');
            }

            loadAchievements() {
                // Mock earned achievements
                const earnedAchievements = ['first_watch', 'movie_buff'];

                const container = document.getElementById('achievements');
                container.innerHTML = this.achievements.map(achievement => `
                    <div class="achievement-item ${earnedAchievements.includes(achievement.id) ? 'earned' : ''}" 
                         title="${achievement.description}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <p class="achievement-title">${achievement.title}</p>
                    </div>
                `).join('');
            }

            setupForm() {
                const form = document.getElementById('profile-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateProfile();
                });

                // Password confirmation validation
                const newPassword = document.getElementById('new-password');
                const confirmPassword = document.getElementById('confirm-password');

                confirmPassword.addEventListener('input', () => {
                    if (confirmPassword.value && newPassword.value !== confirmPassword.value) {
                        confirmPassword.setCustomValidity('Passwords do not match');
                    } else {
                        confirmPassword.setCustomValidity('');
                    }
                });
            }

            async updateProfile() {
                try {
                    app.showLoading('Updating profile...');

                    const formData = new FormData(document.getElementById('profile-form'));
                    const updates = {
                        username: formData.get('username'),
                        email: formData.get('email'),
                        location: formData.get('location')
                    };

                    // Add password if provided
                    const currentPassword = formData.get('current-password');
                    const newPassword = formData.get('new-password');

                    if (currentPassword && newPassword) {
                        updates.current_password = currentPassword;
                        updates.new_password = newPassword;
                    }

                    // This would be an API call to update profile
                    // const response = await app.apiCall('/user/profile', {
                    //     method: 'PUT',
                    //     body: JSON.stringify(updates)
                    // });

                    app.showNotification('Profile updated successfully!', 'success');

                    // Clear password fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                } catch (error) {
                    console.error('Failed to update profile:', error);
                    app.showNotification('Failed to update profile', 'error');
                } finally {
                    app.hideLoading();
                }
            }

            addLanguage() {
                const languages = ['English', 'Hindi', 'Telugu', 'Tamil', 'Kannada', 'Malayalam', 'Spanish', 'French', 'German', 'Japanese', 'Korean'];
                const availableLanguages = languages.filter(lang => !this.userPreferences.languages.includes(lang));

                if (availableLanguages.length === 0) {
                    app.showNotification('All available languages already added', 'warning');
                    return;
                }

                const language = prompt(`Select language:\n${availableLanguages.join(', ')}`);
                if (language && availableLanguages.includes(language)) {
                    this.userPreferences.languages.push(language);
                    this.renderPreferences('language-preferences', this.userPreferences.languages, 'language');
                    app.showNotification(`Added ${language} to preferences`, 'success');
                }
            }

            addGenre() {
                const genres = ['Action', 'Comedy', 'Drama', 'Horror', 'Romance', 'Sci-Fi', 'Thriller', 'Animation', 'Documentary', 'Fantasy'];
                const availableGenres = genres.filter(genre => !this.userPreferences.genres.includes(genre));

                if (availableGenres.length === 0) {
                    app.showNotification('All available genres already added', 'warning');
                    return;
                }

                const genre = prompt(`Select genre:\n${availableGenres.join(', ')}`);
                if (genre && availableGenres.includes(genre)) {
                    this.userPreferences.genres.push(genre);
                    this.renderPreferences('genre-preferences', this.userPreferences.genres, 'genre');
                    app.showNotification(`Added ${genre} to preferences`, 'success');
                }
            }

            removePreference(type, preference) {
                if (type === 'language') {
                    this.userPreferences.languages = this.userPreferences.languages.filter(lang => lang !== preference);
                    this.renderPreferences('language-preferences', this.userPreferences.languages, 'language');
                } else if (type === 'genre') {
                    this.userPreferences.genres = this.userPreferences.genres.filter(genre => genre !== preference);
                    this.renderPreferences('genre-preferences', this.userPreferences.genres, 'genre');
                }

                app.showNotification(`Removed ${preference} from preferences`, 'success');
            }
        }

        // Initialize profile
        let profile;
        document.addEventListener('DOMContentLoaded', () => {
            profile = new Profile();
        });
    </script>
</body>

</html>