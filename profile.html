<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - MovieFlix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #e50914;
            --secondary: #141414;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --input-bg: #333333;
            --success: #46d369;
            --error: #e87c03;
        }

        body {
            background-color: var(--secondary);
            color: var(--text-primary);
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px 50px;
            background: var(--secondary);
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
        }

        /* Main Content */
        .profile-container {
            max-width: 800px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #f40612);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin: 0 auto 20px;
            color: white;
        }

        /* Profile Sections */
        .profile-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid #444;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: #3a3a3a;
        }

        .form-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Preferences */
        .preference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .preference-chip {
            padding: 8px 16px;
            background: var(--input-bg);
            border: 1px solid #444;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.875rem;
        }

        .preference-chip.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        .preference-chip:hover {
            border-color: var(--primary);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #f40612;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid #444;
        }

        .btn-secondary:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: transparent;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .btn-danger:hover {
            background: var(--error);
            color: white;
        }

        /* Success/Error Messages */
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: rgba(70, 211, 105, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .message.error {
            background: rgba(232, 124, 3, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Watch History */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            align-items: center;
        }

        .history-poster {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 4px;
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .history-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            nav {
                padding: 15px 20px;
            }

            .profile-container {
                margin-top: 80px;
            }

            .profile-section {
                padding: 20px;
            }

            .preference-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="flex justify-between items-center">
            <a href="dashboard.html" class="logo">MovieFlix</a>
            <button onclick="goBack()" class="text-gray-300 hover:text-white">
                <i class="fas fa-arrow-left mr-2"></i> Back
            </button>
        </div>
    </nav>

    <!-- Profile Container -->
    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="avatar" id="userAvatar">
                <i class="fas fa-user"></i>
            </div>
            <h1 class="text-3xl font-bold" id="profileUsername">Loading...</h1>
            <p class="text-gray-400" id="profileEmail"></p>
        </div>

        <!-- Success/Error Messages -->
        <div id="successMessage" class="message success"></div>
        <div id="errorMessage" class="message error"></div>

        <!-- Account Information -->
        <div class="profile-section">
            <h2 class="section-title">Account Information</h2>
            <form id="accountForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-input" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Region</label>
                    <input type="text" id="region" class="form-input" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Member Since</label>
                    <input type="text" id="memberSince" class="form-input" disabled>
                </div>
            </form>
        </div>

        <!-- Preferences -->
        <div class="profile-section">
            <h2 class="section-title">Content Preferences</h2>
            <div class="form-group">
                <label class="form-label">Preferred Languages</label>
                <div class="preference-grid" id="languagePreferences">
                    <div class="preference-chip" data-value="en">English</div>
                    <div class="preference-chip" data-value="hi">Hindi</div>
                    <div class="preference-chip" data-value="es">Spanish</div>
                    <div class="preference-chip" data-value="fr">French</div>
                    <div class="preference-chip" data-value="ja">Japanese</div>
                    <div class="preference-chip" data-value="ko">Korean</div>
                </div>
            </div>
            <div class="form-group mt-6">
                <label class="form-label">Favorite Genres</label>
                <div class="preference-grid" id="genrePreferences">
                    <div class="preference-chip" data-value="Action">Action</div>
                    <div class="preference-chip" data-value="Comedy">Comedy</div>
                    <div class="preference-chip" data-value="Drama">Drama</div>
                    <div class="preference-chip" data-value="Horror">Horror</div>
                    <div class="preference-chip" data-value="Romance">Romance</div>
                    <div class="preference-chip" data-value="Sci-Fi">Sci-Fi</div>
                    <div class="preference-chip" data-value="Thriller">Thriller</div>
                    <div class="preference-chip" data-value="Animation">Animation</div>
                </div>
            </div>
            <button type="button" onclick="savePreferences()" class="btn btn-primary mt-4">
                Save Preferences
            </button>
        </div>

        <!-- Statistics -->
        <div class="profile-section">
            <h2 class="section-title">Your Activity</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="watchlistCount">0</div>
                    <div class="stat-label">In Watchlist</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="favoritesCount">0</div>
                    <div class="stat-label">Favorites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ratingsCount">0</div>
                    <div class="stat-label">Rated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="hoursWatched">0</div>
                    <div class="stat-label">Hours Watched</div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="profile-section">
            <h2 class="section-title">Recent Activity</h2>
            <div id="recentActivity" class="history-list">
                <p class="text-gray-400 text-center">No recent activity</p>
            </div>
        </div>

        <!-- Account Actions -->
        <div class="profile-section">
            <h2 class="section-title">Account Actions</h2>
            <div class="flex flex-col gap-3">
                <button onclick="changePassword()" class="btn btn-secondary">
                    <i class="fas fa-key mr-2"></i> Change Password
                </button>
                <button onclick="clearHistory()" class="btn btn-secondary">
                    <i class="fas fa-history mr-2"></i> Clear Watch History
                </button>
                <button onclick="downloadData()" class="btn btn-secondary">
                    <i class="fas fa-download mr-2"></i> Download My Data
                </button>
                <button onclick="deleteAccount()" class="btn btn-danger">
                    <i class="fas fa-trash mr-2"></i> Delete Account
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Check authentication
        if (!token || !user.id) {
            window.location.href = 'login.html';
        }

        // Load user profile
        async function loadProfile() {
            // Set basic info
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('region').value = user.region || 'Not set';
            
            // Set avatar initial
            const firstLetter = user.username.charAt(0).toUpperCase();
            document.getElementById('userAvatar').innerHTML = firstLetter;
            
            // Format member since date
            if (user.created_at) {
                const memberDate = new Date(user.created_at);
                document.getElementById('memberSince').value = memberDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Load preferences
            loadPreferences();
            
            // Load statistics
            await loadStatistics();
        }

        function loadPreferences() {
            // Load language preferences
            const savedLanguages = JSON.parse(user.preferred_languages || '["en"]');
            document.querySelectorAll('#languagePreferences .preference-chip').forEach(chip => {
                if (savedLanguages.includes(chip.dataset.value)) {
                    chip.classList.add('selected');
                }
                chip.addEventListener('click', togglePreference);
            });

            // Load genre preferences
            const savedGenres = JSON.parse(user.preferred_genres || '[]');
            document.querySelectorAll('#genrePreferences .preference-chip').forEach(chip => {
                if (savedGenres.includes(chip.dataset.value)) {
                    chip.classList.add('selected');
                }
                chip.addEventListener('click', togglePreference);
            });
        }

        function togglePreference(event) {
            event.target.classList.toggle('selected');
        }

        async function savePreferences() {
            const selectedLanguages = Array.from(
                document.querySelectorAll('#languagePreferences .preference-chip.selected')
            ).map(chip => chip.dataset.value);

            const selectedGenres = Array.from(
                document.querySelectorAll('#genrePreferences .preference-chip.selected')
            ).map(chip => chip.dataset.value);

            // Update local user object
            user.preferred_languages = JSON.stringify(selectedLanguages);
            user.preferred_genres = JSON.stringify(selectedGenres);
            localStorage.setItem('user', JSON.stringify(user));

            showMessage('success', 'Preferences saved successfully!');
            
            // In a real app, this would save to the backend
            // await fetch(`${API_BASE}/user/preferences`, {
            //     method: 'PUT',
            //     headers: {
            //         'Authorization': `Bearer ${token}`,
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({ 
            //         preferred_languages: selectedLanguages,
            //         preferred_genres: selectedGenres
            //     })
            // });
        }

        async function loadStatistics() {
            try {
                // Load watchlist count
                const watchlistResponse = await fetch(`${API_BASE}/user/watchlist`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (watchlistResponse.ok) {
                    const data = await watchlistResponse.json();
                    document.getElementById('watchlistCount').textContent = data.watchlist.length;
                }

                // Load favorites count
                const favoritesResponse = await fetch(`${API_BASE}/user/favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (favoritesResponse.ok) {
                    const data = await favoritesResponse.json();
                    document.getElementById('favoritesCount').textContent = data.favorites.length;
                    
                    // Display recent favorites as activity
                    if (data.favorites.length > 0) {
                        displayRecentActivity(data.favorites.slice(0, 5));
                    }
                }

                // Simulated data for demo
                document.getElementById('ratingsCount').textContent = Math.floor(Math.random() * 50);
                document.getElementById('hoursWatched').textContent = Math.floor(Math.random() * 200);

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function displayRecentActivity(items) {
            const container = document.getElementById('recentActivity');
            container.innerHTML = items.map(item => `
                <div class="history-item">
                    <img src="${item.poster_url || '/placeholder.jpg'}" 
                         alt="${item.title}" 
                         class="history-poster"
                         onerror="this.src='/placeholder.jpg'">
                    <div class="history-info">
                        <div class="history-title">${item.title}</div>
                        <div class="history-meta">
                            Added ${new Date(item.added_at).toLocaleDateString()}
                        </div>
                    </div>
                    <button onclick="viewContent('${item.id}')" class="btn btn-secondary btn-sm">
                        View
                    </button>
                </div>
            `).join('');
        }

        function viewContent(contentId) {
            sessionStorage.setItem('selectedContentId', contentId);
            window.location.href = 'movie-detail.html';
        }

        function showMessage(type, message) {
            const messageEl = document.getElementById(`${type}Message`);
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        function changePassword() {
            // In a real app, this would show a modal or redirect to password change page
            const newPassword = prompt('Enter new password:');
            if (newPassword && newPassword.length >= 6) {
                showMessage('success', 'Password changed successfully!');
            } else if (newPassword) {
                showMessage('error', 'Password must be at least 6 characters');
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear your watch history?')) {
                showMessage('success', 'Watch history cleared');
            }
        }

        function downloadData() {
            // In a real app, this would generate and download user data
            showMessage('success', 'Your data download will begin shortly');
            
            // Simulate data download
            const userData = {
                username: user.username,
                email: user.email,
                region: user.region,
                preferences: {
                    languages: JSON.parse(user.preferred_languages || '[]'),
                    genres: JSON.parse(user.preferred_genres || '[]')
                },
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `movieflix_data_${user.username}.json`;
            link.click();
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    // In a real app, this would call the delete account API
                    localStorage.clear();
                    window.location.href = 'index.html';
                }
            }
        }

        function goBack() {
            window.history.back();
        }

        // Initialize
        loadProfile();
    </script>
</body>
</html>