<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CineScope</title>
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="css/components.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <i class="fas fa-film"></i>
                <span>CineScope</span>
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading your profile...</div>
        </div>
    </div>

    <!-- Header -->
    <div id="headerContainer"></div>

    <!-- Main Content -->
    <main class="main-content profile-content">
        <!-- Profile Header -->
        <section class="profile-header">
            <div class="container">
                <div class="profile-header-content">
                    <div class="profile-avatar">
                        <div class="avatar-circle">
                            <i class="fas fa-user"></i>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" id="changeAvatarBtn">
                            Change Avatar
                        </button>
                    </div>
                    <div class="profile-info">
                        <h1 class="profile-name" id="profileName">Loading...</h1>
                        <p class="profile-email" id="profileEmail">Loading...</p>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-number" id="totalWatched">0</div>
                                <div class="stat-label">Watched</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalWatchlist">0</div>
                                <div class="stat-label">Watchlist</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalFavorites">0</div>
                                <div class="stat-label">Favorites</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalReviews">0</div>
                                <div class="stat-label">Reviews</div>
                            </div>
                        </div>
                        <div class="profile-member-since">
                            Member since <span id="memberSince">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Tabs -->
        <section class="profile-tabs-section">
            <div class="container">
                <div class="profile-tabs">
                    <button class="tab-btn active" data-tab="settings">
                        <i class="fas fa-cog me-2"></i>
                        Settings
                    </button>
                    <button class="tab-btn" data-tab="preferences">
                        <i class="fas fa-heart me-2"></i>
                        Preferences
                    </button>
                    <button class="tab-btn" data-tab="activity">
                        <i class="fas fa-clock me-2"></i>
                        Activity
                    </button>
                    <button class="tab-btn" data-tab="privacy">
                        <i class="fas fa-shield-alt me-2"></i>
                        Privacy
                    </button>
                </div>
            </div>
        </section>

        <!-- Tab Content -->
        <section class="profile-content-section">
            <div class="container">
                <!-- Settings Tab -->
                <div class="tab-content active" id="settingsTab">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="profile-card">
                                <h3>Account Information</h3>
                                <form id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" class="form-control" id="usernameInput" readonly>
                                            <small class="form-text text-muted">Username cannot be changed</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" id="emailInput">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Display Name</label>
                                            <input type="text" class="form-control" id="displayNameInput" placeholder="Enter display name">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Location</label>
                                            <input type="text" class="form-control" id="locationInput" placeholder="Enter your location">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Bio</label>
                                        <textarea class="form-control" id="bioInput" rows="3" placeholder="Tell us about yourself..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        Save Changes
                                    </button>
                                </form>
                            </div>

                            <div class="profile-card">
                                <h3>Change Password</h3>
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirmNewPassword" required>
                                    </div>
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="fas fa-key me-2"></i>
                                        Update Password
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="profile-card">
                                <h4>Account Status</h4>
                                <div class="status-item">
                                    <span class="status-label">Account Type:</span>
                                    <span class="badge bg-primary">Free User</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Verification:</span>
                                    <span class="badge bg-success">Verified</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Last Login:</span>
                                    <span id="lastLogin">Loading...</span>
                                </div>
                            </div>

                            <div class="profile-card">
                                <h4>Quick Actions</h4>
                                <div class="quick-actions">
                                    <a href="/user/watchlist" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-bookmark me-2"></i>
                                        View Watchlist
                                    </a>
                                    <a href="/user/favorites" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-heart me-2"></i>
                                        View Favorites
                                    </a>
                                    <a href="/dashboard" class="btn btn-outline-primary w-100">
                                        <i class="fas fa-tachometer-alt me-2"></i>
                                        Go to Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences Tab -->
                <div class="tab-content" id="preferencesTab">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="profile-card">
                                <h3>Content Preferences</h3>
                                <div class="preference-section">
                                    <h5>Preferred Languages</h5>
                                    <div class="preference-grid">
                                        <label class="preference-item">
                                            <input type="checkbox" value="english">
                                            <span class="checkmark"></span>
                                            English
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="hindi">
                                            <span class="checkmark"></span>
                                            Hindi
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="telugu">
                                            <span class="checkmark"></span>
                                            Telugu
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="tamil">
                                            <span class="checkmark"></span>
                                            Tamil
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="kannada">
                                            <span class="checkmark"></span>
                                            Kannada
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="malayalam">
                                            <span class="checkmark"></span>
                                            Malayalam
                                        </label>
                                    </div>
                                </div>

                                <div class="preference-section">
                                    <h5>Preferred Genres</h5>
                                    <div class="preference-grid">
                                        <label class="preference-item">
                                            <input type="checkbox" value="action">
                                            <span class="checkmark"></span>
                                            Action
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="comedy">
                                            <span class="checkmark"></span>
                                            Comedy
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="drama">
                                            <span class="checkmark"></span>
                                            Drama
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="horror">
                                            <span class="checkmark"></span>
                                            Horror
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="romance">
                                            <span class="checkmark"></span>
                                            Romance
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="sci-fi">
                                            <span class="checkmark"></span>
                                            Sci-Fi
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="thriller">
                                            <span class="checkmark"></span>
                                            Thriller
                                        </label>
                                        <label class="preference-item">
                                            <input type="checkbox" value="animation">
                                            <span class="checkmark"></span>
                                            Animation
                                        </label>
                                    </div>
                                </div>

                                <button class="btn btn-primary" id="savePreferencesBtn">
                                    <i class="fas fa-save me-2"></i>
                                    Save Preferences
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="profile-card">
                                <h3>Recommendation Settings</h3>
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Enable Personalized Recommendations</h6>
                                        <p>Get recommendations based on your viewing history and preferences</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="personalizedRecommendations" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Include Adult Content</h6>
                                        <p>Show mature and adult-rated content in recommendations</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="includeAdultContent">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Auto-play Trailers</h6>
                                        <p>Automatically play trailers when browsing content</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="autoplayTrailers">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Recommendation Frequency</label>
                                    <select class="form-select" id="recommendationFrequency">
                                        <option value="daily">Daily updates</option>
                                        <option value="weekly" selected>Weekly updates</option>
                                        <option value="monthly">Monthly updates</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-content" id="activityTab">
                    <div class="profile-card">
                        <h3>Recent Activity</h3>
                        <div class="activity-timeline" id="activityTimeline">
                            <div class="activity-loading">
                                <div class="loading-spinner-small"></div>
                                <p>Loading activity...</p>
                            </div>
                        </div>
                    </div>

                    <div class="profile-card">
                        <h3>Viewing Statistics</h3>
                        <div class="stats-dashboard">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" id="totalWatchTime">0h</div>
                                    <div class="stat-label">Total Watch Time</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-film"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" id="moviesWatched">0</div>
                                    <div class="stat-label">Movies Watched</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-tv"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" id="tvShowsWatched">0</div>
                                    <div class="stat-label">TV Shows Watched</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-mask"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" id="animeWatched">0</div>
                                    <div class="stat-label">Anime Watched</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy Tab -->
                <div class="tab-content" id="privacyTab">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="profile-card">
                                <h3>Privacy Settings</h3>
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Profile Visibility</h6>
                                        <p>Control who can see your profile information</p>
                                    </div>
                                    <div class="setting-control">
                                        <select class="form-select" id="profileVisibility">
                                            <option value="public">Public</option>
                                            <option value="friends">Friends Only</option>
                                            <option value="private" selected>Private</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Activity Tracking</h6>
                                        <p>Allow CineScope to track your viewing activity for recommendations</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="activityTracking" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Data Collection</h6>
                                        <p>Allow collection of anonymous usage data to improve the service</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="dataCollection" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-info">
                                        <h6>Marketing Emails</h6>
                                        <p>Receive emails about new features and recommendations</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="marketingEmails">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="profile-card">
                                <h3>Data Management</h3>
                                <div class="data-actions">
                                    <button class="btn btn-outline-primary" id="exportDataBtn">
                                        <i class="fas fa-download me-2"></i>
                                        Export My Data
                                    </button>
                                    <button class="btn btn-outline-warning" id="clearDataBtn">
                                        <i class="fas fa-trash me-2"></i>
                                        Clear Activity History
                                    </button>
                                    <button class="btn btn-outline-danger" id="deleteAccountBtn">
                                        <i class="fas fa-user-times me-2"></i>
                                        Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="profile-card">
                                <h4>Privacy Information</h4>
                                <div class="privacy-info">
                                    <div class="info-item">
                                        <i class="fas fa-shield-alt text-success"></i>
                                        <div>
                                            <h6>Data Encryption</h6>
                                            <p>Your data is encrypted and secure</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-user-secret text-primary"></i>
                                        <div>
                                            <h6>Anonymous Analytics</h6>
                                            <p>We collect anonymous usage data</p>
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-ban text-warning"></i>
                                        <div>
                                            <h6>No Third-party Sharing</h6>
                                            <p>We don't sell your data to third parties</p>
                                        </div>
                                    </div>
                                </div>
                                <a href="/privacy" class="btn btn-outline-primary w-100 mt-3">
                                    <i class="fas fa-file-alt me-2"></i>
                                    Read Privacy Policy
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div id="footerContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/include.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeProfilePage();
        });

        async function initializeProfilePage() {
            // Check authentication
            if (!AuthManager.requireAuth()) return;

            // Load includes
            await loadIncludes();
            
            // Initialize profile
            loadUserProfile();
            bindProfileEvents();
            loadUserActivity();

            Utils.hideLoadingScreen();
        }

        async function loadIncludes() {
            try {
                await Promise.all([
                    loadHeader(),
                    loadFooter()
                ]);
            } catch (error) {
                console.error('Failed to load includes:', error);
            }
        }

        function loadUserProfile() {
            if (AppState.user) {
                // Basic info
                document.getElementById('profileName').textContent = AppState.user.username;
                document.getElementById('profileEmail').textContent = AppState.user.email;
                document.getElementById('usernameInput').value = AppState.user.username;
                document.getElementById('emailInput').value = AppState.user.email;

                // Member since
                const memberSince = new Date(AppState.user.created_at || Date.now()).toLocaleDateString();
                document.getElementById('memberSince').textContent = memberSince;

                // Load preferences
                loadUserPreferences();
            }
        }

        function loadUserPreferences() {
            // Load language preferences
            const preferredLanguages = AppState.user.preferred_languages || [];
            document.querySelectorAll('#preferencesTab input[type="checkbox"]').forEach(checkbox => {
                if (preferredLanguages.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
        }

        function bindProfileEvents() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    const tabId = btn.getAttribute('data-tab');
                    switchTab(tabId);
                };
            });

            // Forms
            document.getElementById('profileForm').onsubmit = handleProfileUpdate;
            document.getElementById('passwordForm').onsubmit = handlePasswordChange;
            document.getElementById('savePreferencesBtn').onclick = savePreferences;

            // Data actions
            document.getElementById('exportDataBtn').onclick = exportUserData;
            document.getElementById('clearDataBtn').onclick = clearActivityData;
            document.getElementById('deleteAccountBtn').onclick = deleteAccount;
        }

        function switchTab(tabId) {
            // Update button states
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}Tab`).classList.add('active');

            // Load tab-specific data
            if (tabId === 'activity' && !document.getElementById('activityTimeline').dataset.loaded) {
                loadUserActivity();
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    email: document.getElementById('emailInput').value,
                    display_name: document.getElementById('displayNameInput').value,
                    location: document.getElementById('locationInput').value,
                    bio: document.getElementById('bioInput').value
                };

                await ApiService.updateProfile(formData);
                Utils.showToast('Profile updated successfully!', 'success');

            } catch (error) {
                console.error('Profile update failed:', error);
                Utils.showToast('Failed to update profile', 'error');
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmPassword) {
                Utils.showToast('Passwords do not match', 'error');
                return;
            }

            try {
                await ApiService.changePassword({
                    current_password: currentPassword,
                    new_password: newPassword
                });

                Utils.showToast('Password changed successfully!', 'success');
                document.getElementById('passwordForm').reset();

            } catch (error) {
                console.error('Password change failed:', error);
                Utils.showToast('Failed to change password', 'error');
            }
        }

        async function savePreferences() {
            try {
                const selectedLanguages = Array.from(
                    document.querySelectorAll('#preferencesTab input[type="checkbox"]:checked')
                ).map(cb => cb.value).filter(val => ['english', 'hindi', 'telugu', 'tamil', 'kannada', 'malayalam'].includes(val));

                const selectedGenres = Array.from(
                    document.querySelectorAll('#preferencesTab input[type="checkbox"]:checked')
                ).map(cb => cb.value).filter(val => ['action', 'comedy', 'drama', 'horror', 'romance', 'sci-fi', 'thriller', 'animation'].includes(val));

                const preferences = {
                    preferred_languages: selectedLanguages,
                    preferred_genres: selectedGenres,
                    personalized_recommendations: document.getElementById('personalizedRecommendations').checked,
                    include_adult_content: document.getElementById('includeAdultContent').checked,
                    autoplay_trailers: document.getElementById('autoplayTrailers').checked,
                    recommendation_frequency: document.getElementById('recommendationFrequency').value
                };

                await ApiService.updatePreferences(preferences);
                Utils.showToast('Preferences saved successfully!', 'success');

            } catch (error) {
                console.error('Failed to save preferences:', error);
                Utils.showToast('Failed to save preferences', 'error');
            }
        }

        async function loadUserActivity() {
            try {
                const timeline = document.getElementById('activityTimeline');
                timeline.innerHTML = '<div class="activity-loading"><div class="loading-spinner-small"></div><p>Loading activity...</p></div>';

                const activity = await ApiService.getUserActivity();
                renderActivityTimeline(activity);
                
                timeline.dataset.loaded = 'true';

            } catch (error) {
                console.error('Failed to load activity:', error);
                document.getElementById('activityTimeline').innerHTML = '<p class="text-muted">Failed to load activity</p>';
            }
        }

        function renderActivityTimeline(activities) {
            const timeline = document.getElementById('activityTimeline');
            
            if (!activities || activities.length === 0) {
                timeline.innerHTML = '<p class="text-muted">No recent activity</p>';
                return;
            }

            const timelineHtml = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-${getActivityIcon(activity.type)}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">${getActivityText(activity)}</div>
                        <div class="activity-time">${Utils.formatDate(activity.timestamp)}</div>
                    </div>
                </div>
            `).join('');

            timeline.innerHTML = timelineHtml;
        }

        function getActivityIcon(type) {
            const icons = {
                'view': 'eye',
                'like': 'heart',
                'watchlist': 'bookmark',
                'favorite': 'star',
                'rating': 'star-half-alt',
                'review': 'comment'
            };
            return icons[type] || 'circle';
        }

        function getActivityText(activity) {
            const actions = {
                'view': 'Watched',
                'like': 'Liked',
                'watchlist': 'Added to watchlist',
                'favorite': 'Added to favorites',
                'rating': 'Rated',
                'review': 'Reviewed'
            };
            
            const action = actions[activity.type] || 'Interacted with';
            return `${action} "${activity.content_title}"`;
        }

        async function exportUserData() {
            try {
                const data = await ApiService.exportUserData();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `cinescope-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                Utils.showToast('Data exported successfully!', 'success');

            } catch (error) {
                console.error('Export failed:', error);
                Utils.showToast('Failed to export data', 'error');
            }
        }

        async function clearActivityData() {
            if (!confirm('Are you sure you want to clear your activity history? This action cannot be undone.')) {
                return;
            }

            try {
                await ApiService.clearUserActivity();
                Utils.showToast('Activity history cleared!', 'success');
                
                // Reload activity tab
                document.getElementById('activityTimeline').dataset.loaded = 'false';
                loadUserActivity();

            } catch (error) {
                console.error('Clear data failed:', error);
                Utils.showToast('Failed to clear activity history', 'error');
            }
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently lost.')) {
                return;
            }

            const confirmation = prompt('Type "DELETE" to confirm account deletion:');
            if (confirmation !== 'DELETE') {
                Utils.showToast('Account deletion cancelled', 'info');
                return;
            }

            try {
                await ApiService.deleteAccount();
                Utils.showToast('Account deleted successfully', 'success');
                
                // Logout and redirect
                AuthManager.logout();
                window.location.href = '/';

            } catch (error) {
                console.error('Account deletion failed:', error);
                Utils.showToast('Failed to delete account', 'error');
            }
        }

        // Extended API service
        ApiService.updateProfile = async function(profileData) {
            return await this.request('/user/profile', {
                method: 'PUT',
                body: JSON.stringify(profileData)
            });
        };

        ApiService.changePassword = async function(passwordData) {
            return await this.request('/user/password', {
                method: 'PUT',
                body: JSON.stringify(passwordData)
            });
        };

        ApiService.getUserActivity = async function() {
            return await this.request('/user/activity');
        };

        ApiService.exportUserData = async function() {
            return await this.request('/user/export');
        };

        ApiService.clearUserActivity = async function() {
            return await this.request('/user/activity', { method: 'DELETE' });
        };

        ApiService.deleteAccount = async function() {
            return await this.request('/user/account', { method: 'DELETE' });
        };
    </script>

    <style>
        .profile-content {
            padding-top: 2rem;
        }

        .profile-header {
            padding: 3rem 0;
            background: var(--gradient-dark);
        }

        .profile-header-content {
            display: flex;
            align-items: center;
            gap: 3rem;
        }

        .profile-avatar {
            text-align: center;
        }

        .avatar-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin-bottom: 1rem;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .profile-email {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .profile-stats .stat-item {
            text-align: center;
        }

        .profile-stats .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .profile-stats .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .profile-member-since {
            color: var(--text-secondary);
        }

        .profile-tabs-section {
            padding: 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .profile-tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-btn.active,
        .tab-btn:hover {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .profile-content-section {
            padding: 3rem 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profile-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .profile-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .quick-actions .btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .preference-section {
            margin-bottom: 2rem;
        }

        .preference-section h5 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .preference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .preference-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .preference-item:hover {
            border-color: var(--primary-color);
        }

        .preference-item input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            transition: var(--transition);
        }

        .preference-item input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .preference-item input[type="checkbox"]:checked + .checkmark::after {
            content: '\2713';
            position: absolute;
            top: -2px;
            left: 3px;
            color: white;
            font-weight: bold;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
            margin-right: 2rem;
        }

        .setting-info h6 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .setting-info p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 0.9rem;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .switch input[type="checkbox"] {
            display: none;
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: var(--transition);
            cursor: pointer;
        }

        .slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: var(--transition);
        }

        .switch input[type="checkbox"]:checked + .slider {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .switch input[type="checkbox"]:checked + .slider::before {
            transform: translateX(26px);
            background: white;
        }

        .activity-timeline {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .stat-card .stat-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .stat-card .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .data-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .privacy-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .info-item i {
            font-size: 1.5rem;
            margin-top: 0.25rem;
        }

        .info-item h6 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .info-item p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0;
        }

        @media (max-width: 768px) {
            .profile-header-content {
                flex-direction: column;
                text-align: center;
                gap: 2rem;
            }

            .profile-stats {
                justify-content: center;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .profile-tabs {
                justify-content: center;
            }

            .setting-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .setting-info {
                margin-right: 0;
            }

            .stats-dashboard {
                grid-template-columns: 1fr;
            }

            .data-actions {
                flex-direction: column;
            }

            .preference-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>