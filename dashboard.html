<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieFlix - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --netflix-red: #E50914;
            --netflix-black: #141414;
            --netflix-gray: #2F2F2F;
            --text-gray: #B3B3B3;
            --card-bg: #181818;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Netflix Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--netflix-black);
            color: white;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            padding: 20px 50px;
            z-index: 1000;
            transition: background 0.3s;
        }

        .header.scrolled {
            background: var(--netflix-black);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--netflix-red);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-gray);
            text-decoration: none;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: white;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            background: transparent;
            border: 1px solid var(--text-gray);
            padding: 8px 16px;
            border-radius: 4px;
            color: white;
            width: 0;
            opacity: 0;
            transition: all 0.3s;
        }

        .search-input.active {
            width: 250px;
            opacity: 1;
        }

        .profile-menu {
            position: relative;
        }

        .profile-icon {
            width: 32px;
            height: 32px;
            background: var(--netflix-red);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Hero Section */
        .hero {
            margin-top: 70px;
            height: 80vh;
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            position: absolute;
            bottom: 30%;
            left: 50px;
            z-index: 10;
            max-width: 500px;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .hero-description {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: var(--text-gray);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-play {
            background: white;
            color: black;
        }

        .btn-play:hover {
            background: rgba(255,255,255,0.8);
        }

        .btn-info {
            background: rgba(109, 109, 110, 0.7);
            color: white;
        }

        .btn-info:hover {
            background: rgba(109, 109, 110, 0.5);
        }

        .hero-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-gradient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, var(--netflix-black) 0%, transparent 50%, transparent 100%);
        }

        /* Content Rows */
        .content-section {
            padding: 0 50px;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .content-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .content-card {
            position: relative;
            background: var(--card-bg);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            aspect-ratio: 2/3;
        }

        .content-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .content-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }

        .content-card:hover img {
            opacity: 0.8;
        }

        .card-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 10px 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .content-card:hover .card-info {
            opacity: 1;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .rating {
            color: #46d369;
            font-weight: bold;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--card-bg) 25%, #2a2a2a 50%, var(--card-bg) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-card {
            aspect-ratio: 2/3;
            border-radius: 4px;
        }

        /* Scroll to Top */
        .scroll-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--netflix-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        .scroll-top.visible {
            opacity: 1;
        }

        .scroll-top:hover {
            transform: scale(1.1);
        }

        /* Search Results */
        .search-results {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--netflix-black);
            z-index: 999;
            padding: 50px;
            overflow-y: auto;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .close-search {
            position: absolute;
            top: 20px;
            right: 50px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-gray);
            transition: color 0.3s;
        }

        .close-search:hover {
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header, .content-section {
                padding: 20px;
            }

            .hero-title {
                font-size: 2rem;
            }

            .hero-description {
                font-size: 1rem;
            }

            .content-row {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" id="header">
        <div class="nav-container">
            <div class="flex items-center gap-8">
                <a href="#" class="logo">MovieFlix</a>
                <nav class="nav-links">
                    <a href="#" class="nav-link active" data-section="home">Home</a>
                    <a href="#" class="nav-link" data-section="movies">Movies</a>
                    <a href="#" class="nav-link" data-section="tv">TV Shows</a>
                    <a href="#" class="nav-link" data-section="anime">Anime</a>
                    <a href="#" class="nav-link" data-section="watchlist">My List</a>
                </nav>
            </div>
            
            <div class="flex items-center gap-6">
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="Search...">
                    <span class="nav-link" id="search-icon">üîç</span>
                </div>
                
                <div class="profile-menu">
                    <div class="profile-icon" id="profile-icon">
                        <span id="user-initial">U</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="hero">
        <img class="hero-backdrop" id="hero-backdrop" src="" alt="">
        <div class="hero-gradient"></div>
        <div class="hero-content">
            <h1 class="hero-title" id="hero-title">Loading...</h1>
            <p class="hero-description" id="hero-description"></p>
            <div class="hero-buttons">
                <button class="btn btn-play" id="play-featured">
                    ‚ñ∂ Play
                </button>
                <button class="btn btn-info" id="info-featured">
                    ‚Ñπ More Info
                </button>
            </div>
        </div>
    </section>

    <!-- Content Sections -->
    <main id="main-content">
        <!-- Sections will be dynamically loaded here -->
    </main>

    <!-- Search Results -->
    <div class="search-results" id="search-results">
        <span class="close-search" id="close-search">‚úï</span>
        <h2 class="text-2xl font-bold mb-6">Search Results</h2>
        <div id="search-results-content"></div>
    </div>

    <!-- Scroll to Top -->
    <div class="scroll-top" id="scroll-top">
        ‚Üë
    </div>

    <script>
        // Global variables
        let auth = window.movieFlixAuth || null;
        let currentSection = 'home';
        let allContent = {};
        let searchTimeout = null;
        const API_BASE = 'http://localhost:5000/api';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/';

        // Check authentication
        if (!auth || !auth.token) {
            window.location.href = '/index.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            updateUserInterface();
            await loadHomepage();
            setupIntersectionObserver();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Header scroll effect
            window.addEventListener('scroll', () => {
                const header = document.getElementById('header');
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }

                // Scroll to top button
                const scrollTop = document.getElementById('scroll-top');
                if (window.scrollY > 300) {
                    scrollTop.classList.add('visible');
                } else {
                    scrollTop.classList.remove('visible');
                }
            });

            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    if (section) {
                        switchSection(section);
                    }
                });
            });

            // Search
            const searchIcon = document.getElementById('search-icon');
            const searchInput = document.getElementById('search-input');
            
            searchIcon.addEventListener('click', () => {
                searchInput.classList.toggle('active');
                if (searchInput.classList.contains('active')) {
                    searchInput.focus();
                }
            });

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (e.target.value.trim()) {
                        performSearch(e.target.value);
                    }
                }, 500);
            });

            // Close search
            document.getElementById('close-search').addEventListener('click', () => {
                document.getElementById('search-results').classList.remove('active');
                document.getElementById('search-input').value = '';
            });

            // Scroll to top
            document.getElementById('scroll-top').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Profile menu
            document.getElementById('profile-icon').addEventListener('click', () => {
                if (confirm('Do you want to logout?')) {
                    window.movieFlixAuth = null;
                    window.location.href = '/index.html';
                }
            });
        }

        // Update user interface
        function updateUserInterface() {
            if (auth && auth.user) {
                document.getElementById('user-initial').textContent = auth.user.username[0].toUpperCase();
            }
        }

        // Switch section
        async function switchSection(section) {
            currentSection = section;
            
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.section === section) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Load content based on section
            switch(section) {
                case 'home':
                    await loadHomepage();
                    break;
                case 'movies':
                    await loadMovies();
                    break;
                case 'tv':
                    await loadTVShows();
                    break;
                case 'anime':
                    await loadAnime();
                    break;
                case 'watchlist':
                    await loadWatchlist();
                    break;
            }
        }

        // Load homepage
        async function loadHomepage() {
            showLoadingState();
            
            try {
                const response = await fetch(`${API_BASE}/homepage`);
                const data = await response.json();
                
                allContent = data;
                
                // Update hero section with featured content
                if (data.featured && data.featured.length > 0) {
                    updateHeroSection(data.featured[0]);
                } else if (data.trending && data.trending.movies && data.trending.movies.length > 0) {
                    updateHeroSection(data.trending.movies[0]);
                }

                // Build content sections
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';

                // Personalized recommendations
                const personalizedResponse = await fetch(`${API_BASE}/recommendations`, {
                    headers: {
                        'Authorization': `Bearer ${auth.token}`
                    }
                });
                
                if (personalizedResponse.ok) {
                    const personalizedData = await personalizedResponse.json();
                    
                    if (personalizedData.continue_watching && personalizedData.continue_watching.length > 0) {
                        mainContent.appendChild(createContentSection('Continue Watching', personalizedData.continue_watching));
                    }
                    
                    if (personalizedData.personalized && personalizedData.personalized.length > 0) {
                        mainContent.appendChild(createContentSection('Recommended for You', personalizedData.personalized));
                    }
                }

                // Trending content
                if (data.trending) {
                    if (data.trending.movies && data.trending.movies.length > 0) {
                        mainContent.appendChild(createContentSection('Trending Movies', data.trending.movies));
                    }
                    if (data.trending.tv && data.trending.tv.length > 0) {
                        mainContent.appendChild(createContentSection('Trending TV Shows', data.trending.tv));
                    }
                    if (data.trending.anime && data.trending.anime.length > 0) {
                        mainContent.appendChild(createContentSection('Trending Anime', data.trending.anime));
                    }
                }

                // Popular by genre
                if (data.popular_by_genre) {
                    Object.entries(data.popular_by_genre).forEach(([genre, items]) => {
                        if (items && items.length > 0) {
                            mainContent.appendChild(createContentSection(`Popular ${genre}`, items));
                        }
                    });
                }

                // Regional content
                if (data.regional) {
                    Object.entries(data.regional).forEach(([lang, items]) => {
                        if (items && items.length > 0) {
                            const langNames = {
                                'hi': 'Hindi',
                                'te': 'Telugu',
                                'ta': 'Tamil',
                                'kn': 'Kannada'
                            };
                            mainContent.appendChild(createContentSection(`${langNames[lang] || lang} Movies`, items));
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading homepage:', error);
                showError('Failed to load content');
            }
        }

        // Update hero section
        function updateHeroSection(content) {
            const backdrop = document.getElementById('hero-backdrop');
            const title = document.getElementById('hero-title');
            const description = document.getElementById('hero-description');
            
            // Use backdrop_path for hero, fallback to poster
            const imagePath = content.backdrop_path || content.poster_path;
            if (imagePath) {
                backdrop.src = `${TMDB_IMAGE_BASE}original${imagePath}`;
            }
            
            title.textContent = content.title || content.name || content.original_title || '';
            description.textContent = content.overview ? 
                (content.overview.length > 200 ? content.overview.substring(0, 200) + '...' : content.overview) : '';
            
            // Set up button actions
            document.getElementById('play-featured').onclick = () => {
                alert('Play functionality coming soon!');
            };
            
            document.getElementById('info-featured').onclick = () => {
                if (content.id || content.tmdb_id) {
                    window.location.href = `/details.html?id=${content.id || content.tmdb_id}`;
                }
            };
        }

        // Create content section
        function createContentSection(title, items) {
            const section = document.createElement('section');
            section.className = 'content-section';
            
            const sectionTitle = document.createElement('h2');
            sectionTitle.className = 'section-title';
            sectionTitle.textContent = title;
            
            const row = document.createElement('div');
            row.className = 'content-row';
            
            items.forEach(item => {
                row.appendChild(createContentCard(item));
            });
            
            section.appendChild(sectionTitle);
            section.appendChild(row);
            
            return section;
        }

        // Create content card
        function createContentCard(item) {
            const card = document.createElement('div');
            card.className = 'content-card';
            
            // Handle different data structures (TMDB, custom, anime)
            const posterPath = item.poster_path || item.image || item.images?.jpg?.image_url || '';
            const title = item.title || item.name || item.original_title || item.title_english || '';
            const rating = item.rating || item.vote_average || item.score || 0;
            const year = item.release_date ? new Date(item.release_date).getFullYear() : 
                        item.first_air_date ? new Date(item.first_air_date).getFullYear() : 
                        item.year || '';
            
            // Get the ID properly
            const contentId = item.id || item.tmdb_id || item.mal_id || '';
            
            card.innerHTML = `
                <img src="${posterPath ? `${TMDB_IMAGE_BASE}w500${posterPath}` : '/placeholder.jpg'}" 
                     alt="${title}" 
                     loading="lazy"
                     onerror="this.src='/placeholder.jpg'">
                <div class="card-info">
                    <h3 class="card-title">${title}</h3>
                    <div class="card-meta">
                        ${rating ? `<span class="rating">${rating.toFixed(1)}</span>` : ''}
                        ${year ? `<span>${year}</span>` : ''}
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                if (contentId) {
                    // For anime, we might need different handling
                    if (item.mal_id) {
                        // For now, just show alert for anime
                        alert('Anime details coming soon!');
                    } else {
                        window.location.href = `/details.html?id=${contentId}`;
                    }
                }
            });
            
            return card;
        }

        // Search functionality
        async function performSearch(query) {
            try {
                const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const searchResults = document.getElementById('search-results');
                const searchContent = document.getElementById('search-results-content');
                
                searchContent.innerHTML = '';
                
                // Combine all results
                const allResults = [
                    ...(data.database || []),
                    ...(data.tmdb || []),
                    ...(data.anime || [])
                ];
                
                if (allResults.length > 0) {
                    const section = createContentSection(`Results for "${query}"`, allResults);
                    searchContent.appendChild(section);
                } else {
                    searchContent.innerHTML = '<p class="text-gray-400">No results found.</p>';
                }
                
                searchResults.classList.add('active');
                
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // Load movies section
        async function loadMovies() {
            showLoadingState();
            
            try {
                // You can create a specific endpoint for movies or filter from homepage data
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                if (allContent.trending && allContent.trending.movies) {
                    mainContent.appendChild(createContentSection('Trending Movies', allContent.trending.movies));
                }
                
                if (allContent.popular_by_genre) {
                    Object.entries(allContent.popular_by_genre).forEach(([genre, items]) => {
                        if (items && items.length > 0) {
                            mainContent.appendChild(createContentSection(`${genre} Movies`, items));
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading movies:', error);
            }
        }

        // Load TV shows section
        async function loadTVShows() {
            showLoadingState();
            
            try {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                if (allContent.trending && allContent.trending.tv) {
                    mainContent.appendChild(createContentSection('Trending TV Shows', allContent.trending.tv));
                }
                
                // Could add more TV-specific sections here
                
            } catch (error) {
                console.error('Error loading TV shows:', error);
            }
        }

        // Load anime section
        async function loadAnime() {
            showLoadingState();
            
            try {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                if (allContent.trending && allContent.trending.anime) {
                    mainContent.appendChild(createContentSection('Trending Anime', allContent.trending.anime));
                }
                
                // Could add more anime-specific sections here
                
            } catch (error) {
                console.error('Error loading anime:', error);
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            showLoadingState();
            
            try {
                const response = await fetch(`${API_BASE}/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${auth.token}`
                    }
                });
                
                const data = await response.json();
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                if (data.watchlist && data.watchlist.length > 0) {
                    const items = data.watchlist.map(item => item.content);
                    mainContent.appendChild(createContentSection('My Watchlist', items));
                } else {
                    mainContent.innerHTML = '<div class="content-section"><p class="text-gray-400">Your watchlist is empty.</p></div>';
                }
                
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        // Show loading state
        function showLoadingState() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';
            
            // Create skeleton loaders
            for (let i = 0; i < 3; i++) {
                const section = document.createElement('section');
                section.className = 'content-section';
                
                const title = document.createElement('div');
                title.className = 'skeleton h-8 w-48 mb-4';
                
                const row = document.createElement('div');
                row.className = 'content-row';
                
                for (let j = 0; j < 6; j++) {
                    const card = document.createElement('div');
                    card.className = 'skeleton loading-card';
                    row.appendChild(card);
                }
                
                section.appendChild(title);
                section.appendChild(row);
                mainContent.appendChild(section);
            }
        }

        // Show error
        function showError(message) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="content-section">
                    <p class="text-red-500">${message}</p>
                </div>
            `;
        }

        // Intersection Observer for lazy loading
        function setupIntersectionObserver() {
            const options = {
                root: null,
                rootMargin: '50px',
                threshold: 0.01
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            observer.unobserve(img);
                        }
                    }
                });
            }, options);
            
            // Observe all images with data-src
            document.querySelectorAll('img[data-src]').forEach(img => {
                observer.observe(img);
            });
        }
    </script>
</body>
</html>