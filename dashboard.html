<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineScope</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav container">
            <a href="/" class="nav-brand">CineScope</a>

            <!-- Search Bar -->
            <div class="search-container">
                <svg class="search-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
                <input type="text" 
                       placeholder="Search movies, TV shows, anime..." 
                       class="search-input"
                       data-search-input>
                <div class="search-results" style="display: none;"></div>
            </div>

            <!-- Desktop Navigation -->
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="/categories/movies" class="nav-link">Movies</a>
                <a href="/categories/tv-shows" class="nav-link">TV Shows</a>
                <a href="/categories/anime" class="nav-link">Anime</a>
                <a href="/user/watchlist" class="nav-link">Watchlist</a>
                <div data-admin="true">
                    <a href="/admin/dashboard" class="nav-link">Admin</a>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm">Hi, <span data-user="name"></span>!</span>
                    <button onclick="app.logout()" class="btn btn-outline btn-sm">Logout</button>
                </div>
            </div>

            <!-- Mobile Menu Button -->
            <button class="btn btn-secondary md:hidden" data-mobile-menu-toggle>
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
        </nav>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-menu-header">
            <div class="nav-brand">CineScope</div>
            <button class="btn btn-secondary" data-mobile-menu-toggle>√ó</button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="/" class="mobile-menu-link">Home</a>
            <a href="/dashboard" class="mobile-menu-link">Dashboard</a>
            <a href="/categories/movies" class="mobile-menu-link">Movies</a>
            <a href="/categories/tv-shows" class="mobile-menu-link">TV Shows</a>
            <a href="/categories/anime" class="mobile-menu-link">Anime</a>
            <a href="/user/watchlist" class="mobile-menu-link">Watchlist</a>
            <a href="/user/favorites" class="mobile-menu-link">Favorites</a>
            <div data-admin="true">
                <a href="/admin/dashboard" class="mobile-menu-link">Admin Dashboard</a>
            </div>
            <button onclick="app.logout()" class="mobile-menu-link w-full text-left">Logout</button>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="container">
        <!-- Welcome Section -->
        <section class="py-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Welcome back, <span data-user="name"></span>!</h1>
                    <p class="text-gray-400">Here's what we recommend for you today</p>
                </div>
                <div class="hidden md:flex gap-4">
                    <a href="/user/watchlist" class="btn btn-outline">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="mr-2">
                            <path d="M2 2v13.5a.5.5 0 0 0 .74.439L8 13.069l5.26 2.87A.5.5 0 0 0 14 15.5V2a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2z"/>
                        </svg>
                        Watchlist
                    </a>
                    <a href="/user/favorites" class="btn btn-outline">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="mr-2">
                            <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                        </svg>
                        Favorites
                    </a>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-blue-400" id="watchlist-count">-</div>
                    <div class="text-sm text-gray-400">Watchlist Items</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-purple-400" id="favorites-count">-</div>
                    <div class="text-sm text-gray-400">Favorites</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-green-400" id="recommendations-count">-</div>
                    <div class="text-sm text-gray-400">Recommendations</div>
                </div>
                <div class="card p-4 text-center">
                    <div class="text-2xl font-bold text-orange-400">24/7</div>
                    <div class="text-sm text-gray-400">Always Available</div>
                </div>
            </div>
        </section>

        <!-- Continue Watching (if available) -->
        <section id="continue-watching" class="py-4">
            <!-- Will be populated if user has viewing history -->
        </section>

        <!-- Personalized Recommendations -->
        <section id="personalized" class="py-4">
            <!-- Content loaded by JavaScript -->
        </section>

        <!-- Watchlist Preview -->
        <section id="watchlist" class="py-4">
            <!-- Content loaded by JavaScript -->
        </section>

        <!-- Favorites Preview -->
        <section id="favorites" class="py-4">
            <!-- Content loaded by JavaScript -->
        </section>

        <!-- Trending Content -->
        <section id="trending" class="py-4">
            <!-- Content loaded by JavaScript -->
        </section>

        <!-- Based on Your Interests -->
        <section class="py-8">
            <h2 class="text-2xl font-bold mb-6">Based on Your Interests</h2>
            <div id="interest-based-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Will be populated based on user's preferred genres -->
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="py-8">
            <h2 class="text-2xl font-bold mb-6">Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <a href="/categories/trending" class="card p-6 hover:bg-gray-800 transition-colors">
                    <div class="text-3xl mb-3">üî•</div>
                    <h3 class="font-semibold mb-2">Explore Trending</h3>
                    <p class="text-sm text-gray-400">See what everyone's watching right now</p>
                </a>
                <a href="/categories/new-releases" class="card p-6 hover:bg-gray-800 transition-colors">
                    <div class="text-3xl mb-3">‚ú®</div>
                    <h3 class="font-semibold mb-2">New Releases</h3>
                    <p class="text-sm text-gray-400">Latest movies and shows</p>
                </a>
                <a href="/categories/critics-choice" class="card p-6 hover:bg-gray-800 transition-colors">
                    <div class="text-3xl mb-3">‚≠ê</div>
                    <h3 class="font-semibold mb-2">Critics Choice</h3>
                    <p class="text-sm text-gray-400">Highly rated content</p>
                </a>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!app.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            loadDashboardContent();
        });

        async function loadDashboardContent() {
            try {
                // Load user statistics
                await loadUserStats();
                
                // Load personalized content
                await loadPersonalizedContent();
                
                // Load trending content
                await loadTrendingContent();
                
                // Load interest-based content
                await loadInterestBasedContent();
                
            } catch (error) {
                console.error('Failed to load dashboard content:', error);
                app.showToast('Some content failed to load', 'warning');
            }
        }

        async function loadUserStats() {
            try {
                const [watchlist, favorites] = await Promise.all([
                    apiClient.getWatchlist(),
                    apiClient.getFavorites()
                ]);

                document.getElementById('watchlist-count').textContent = watchlist.length;
                document.getElementById('favorites-count').textContent = favorites.length;
                document.getElementById('recommendations-count').textContent = '‚àû';

            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }

        async function loadPersonalizedContent() {
            const container = document.getElementById('personalized');
            if (!container) return;

            // Show skeleton loading
            container.innerHTML = `
                <div class="carousel-container">
                    <div class="carousel-header">
                        <h2 class="carousel-title">Recommended for You</h2>
                    </div>
                    <div class="carousel-wrapper">
                        <div class="carousel-track">
                            ${UIComponents.createSkeleton(5)}
                        </div>
                    </div>
                </div>
            `;

            try {
                const recommendations = await apiClient.getPersonalizedRecommendations(20);
                if (recommendations && recommendations.length > 0) {
                    container.innerHTML = UIComponents.createCarousel(
                        'Recommended for You', 
                        recommendations,
                        null
                    );
                    carouselManager.initAll();
                } else {
                    // Fallback to trending if no personalized recommendations
                    const trending = await apiClient.getTrending('all', 20);
                    if (trending && trending.length > 0) {
                        container.innerHTML = UIComponents.createCarousel(
                            'Popular Right Now', 
                            trending,
                            '/categories/trending'
                        );
                        carouselManager.initAll();
                    }
                }
            } catch (error) {
                console.error('Failed to load personalized content:', error);
                container.innerHTML = '<div class="text-center p-4 text-gray-400">Unable to load recommendations</div>';
            }
        }

        async function loadTrendingContent() {
            const container = document.getElementById('trending');
            if (!container) return;

            try {
                const trending = await apiClient.getTrending('all', 15);
                if (trending && trending.length > 0) {
                    container.innerHTML = UIComponents.createCarousel(
                        'Trending Now', 
                        trending,
                        '/categories/trending'
                    );
                    carouselManager.initAll();
                }
            } catch (error) {
                console.error('Failed to load trending content:', error);
            }
        }

        async function loadInterestBasedContent() {
            const container = document.getElementById('interest-based-content');
            if (!container || !app.user?.preferred_genres) return;

            try {
                const preferredGenres = app.user.preferred_genres || [];
                const promises = preferredGenres.slice(0, 2).map(async genre => {
                    try {
                        const content = await apiClient.getGenreRecommendations(genre, 'movie', 10);
                        return { genre, content };
                    } catch (error) {
                        console.error(`Failed to load ${genre} content:`, error);
                        return { genre, content: [] };
                    }
                });

                const results = await Promise.all(promises);
                
                const html = results.map(({ genre, content }) => {
                    if (!content || content.length === 0) return '';
                    
                    return `
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold capitalize">${genre} Movies</h3>
                                <a href="/categories/movies?genre=${genre}" class="btn btn-outline btn-sm">View All</a>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                ${content.slice(0, 4).map(item => `
                                    <div class="content-card" onclick="app.goToDetails(${item.id})">
                                        <img src="${app.getImageUrl(item.poster_path)}" 
                                             alt="${item.title}" 
                                             class="content-card-image"
                                             onerror="this.src='${app.getPlaceholderImage()}'" />
                                        <div class="content-card-overlay">
                                            <h4 class="content-card-title">${item.title}</h4>
                                            <div class="content-card-meta">
                                                ${item.rating ? `‚≠ê ${item.rating.toFixed(1)}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load interest-based content:', error);
            }
        }
    </script>
</body>
</html>