<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineScope</title>
    
    <!-- Stylesheets -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
</head>
<body class="dark-theme">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-logo">
                <div class="logo-animation">
                    <span class="logo-text">CineScope</span>
                    <div class="loading-bars">
                        <div class="loading-bar" style="--delay: 0s"></div>
                        <div class="loading-bar" style="--delay: 0.1s"></div>
                        <div class="loading-bar" style="--delay: 0.2s"></div>
                        <div class="loading-bar" style="--delay: 0.3s"></div>
                        <div class="loading-bar" style="--delay: 0.4s"></div>
                    </div>
                </div>
            </div>
            <div class="loading-text">
                <p id="loadingText">Loading your personalized dashboard...</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Welcome Banner -->
        <section class="welcome-banner">
            <div class="welcome-container">
                <div class="welcome-content">
                    <h1 class="welcome-title">
                        Welcome back, <span id="userName">User</span>!
                    </h1>
                    <p class="welcome-subtitle">
                        Ready to discover your next favorite? Here are your personalized recommendations.
                    </p>
                    <div class="quick-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="watchlistCount">0</span>
                            <span class="stat-label">In Watchlist</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="favoritesCount">0</span>
                            <span class="stat-label">Favorites</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="viewedCount">0</span>
                            <span class="stat-label">Watched</span>
                        </div>
                    </div>
                </div>
                <div class="welcome-actions">
                    <a href="/search" class="btn btn-primary">
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        Discover More
                    </a>
                    <a href="/profile" class="btn btn-outline">
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        Edit Profile
                    </a>
                </div>
            </div>
        </section>

        <!-- Dashboard Sections -->
        <div class="dashboard-sections">
            <!-- Continue Watching -->
            <section class="dashboard-section" id="continueWatchingSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon">‚ñ∂Ô∏è</span>
                        Continue Watching
                    </h2>
                    <a href="/user/watchlist" class="section-view-all">View All</a>
                </div>
                <div class="content-carousel-container">
                    <div class="content-carousel" id="continueWatchingCarousel">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <button class="carousel-btn carousel-prev" onclick="scrollCarousel('continueWatchingCarousel', 'left')">
                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button class="carousel-btn carousel-next" onclick="scrollCarousel('continueWatchingCarousel', 'right')">
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>
            </section>

            <!-- Recommended For You -->
            <section class="dashboard-section" id="recommendedSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon">üéØ</span>
                        Recommended For You
                    </h2>
                    <div class="recommendation-source">
                        <span class="ai-badge" id="recommendationSource">AI Powered</span>
                    </div>
                </div>
                <div class="content-carousel-container">
                    <div class="content-carousel" id="recommendedCarousel">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <button class="carousel-btn carousel-prev" onclick="scrollCarousel('recommendedCarousel', 'left')">
                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button class="carousel-btn carousel-next" onclick="scrollCarousel('recommendedCarousel', 'right')">
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>
            </section>

            <!-- Based on Your Activity -->
            <section class="dashboard-section" id="basedOnActivitySection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon">üìà</span>
                        Based on Your Recent Activity
                    </h2>
                    <a href="#" class="section-view-all" onclick="refreshPersonalizedContent()">Refresh</a>
                </div>
                <div class="content-carousel-container">
                    <div class="content-carousel" id="activityBasedCarousel">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <button class="carousel-btn carousel-prev" onclick="scrollCarousel('activityBasedCarousel', 'left')">
                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button class="carousel-btn carousel-next" onclick="scrollCarousel('activityBasedCarousel', 'right')">
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>
            </section>

            <!-- Trending Now -->
            <section class="dashboard-section" id="trendingSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon">üî•</span>
                        Trending Now
                    </h2>
                    <a href="/categories/trending" class="section-view-all">View All</a>
                </div>
                <div class="content-carousel-container">
                    <div class="content-carousel" id="trendingCarousel">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <button class="carousel-btn carousel-prev" onclick="scrollCarousel('trendingCarousel', 'left')">
                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button class="carousel-btn carousel-next" onclick="scrollCarousel('trendingCarousel', 'right')">
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>
            </section>

            <!-- Your Preferences -->
            <section class="dashboard-section" id="preferencesSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon">‚ù§Ô∏è</span>
                        More Like What You Love
                    </h2>
                    <button class="preference-tune-btn" onclick="showPreferenceTuning()">
                        <svg class="btn-icon" viewBox="0 0 24 24">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                        </svg>
                        Tune Preferences
                    </button>
                </div>
                <div class="content-carousel-container">
                    <div class="content-carousel" id="preferencesCarousel">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <button class="carousel-btn carousel-prev" onclick="scrollCarousel('preferencesCarousel', 'left')">
                        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button class="carousel-btn carousel-next" onclick="scrollCarousel('preferencesCarousel', 'right')">
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions-section">
                <div class="section-header">
                    <h2 class="section-title">Quick Actions</h2>
                </div>
                <div class="quick-actions-grid">
                    <a href="/user/watchlist" class="quick-action-card">
                        <div class="action-icon">üìã</div>
                        <h3 class="action-title">My Watchlist</h3>
                        <p class="action-description">Manage your saved content</p>
                        <span class="action-count" id="quickWatchlistCount">0 items</span>
                    </a>
                    <a href="/user/favorites" class="quick-action-card">
                        <div class="action-icon">‚ù§Ô∏è</div>
                        <h3 class="action-title">My Favorites</h3>
                        <p class="action-description">Your loved content</p>
                        <span class="action-count" id="quickFavoritesCount">0 items</span>
                    </a>
                    <a href="/categories/new-releases" class="quick-action-card">
                        <div class="action-icon">üÜï</div>
                        <h3 class="action-title">New Releases</h3>
                        <p class="action-description">Latest movies & shows</p>
                        <span class="action-count">Updated daily</span>
                    </a>
                    <a href="/search" class="quick-action-card">
                        <div class="action-icon">üîç</div>
                        <h3 class="action-title">Search</h3>
                        <p class="action-description">Find specific content</p>
                        <span class="action-count">Advanced filters</span>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- Preference Tuning Modal -->
    <div class="modal fade" id="preferenceTuningModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tune Your Preferences</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="preference-tuning-container">
                        <div class="tuning-section">
                            <h6 class="tuning-title">Preferred Languages</h6>
                            <div class="language-preferences">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="tuning-section">
                            <h6 class="tuning-title">Favorite Genres</h6>
                            <div class="genre-preferences">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="tuning-section">
                            <h6 class="tuning-title">Content Types</h6>
                            <div class="content-type-preferences">
                                <label class="preference-checkbox">
                                    <input type="checkbox" name="contentTypes" value="movie" checked>
                                    <span class="checkmark"></span>
                                    Movies
                                </label>
                                <label class="preference-checkbox">
                                    <input type="checkbox" name="contentTypes" value="tv" checked>
                                    <span class="checkmark"></span>
                                    TV Shows
                                </label>
                                <label class="preference-checkbox">
                                    <input type="checkbox" name="contentTypes" value="anime" checked>
                                    <span class="checkmark"></span>
                                    Anime
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePreferences()">Save Preferences</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/js/include.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/main.js"></script>

    <script>
        // Dashboard specific functionality
        class Dashboard {
            constructor() {
                this.currentUser = null;
                this.preferenceTuningModal = null;
                this.init();
            }

            async init() {
                // Check authentication
                if (!await Auth.checkExistingSession()) {
                    window.location.href = '/login';
                    return;
                }

                this.currentUser = Auth.currentUser;
                await this.loadIncludes();
                this.setupUI();
                await this.loadDashboardContent();
                this.hideLoading();
                this.setupEventListeners();
            }

            async loadIncludes() {
                try {
                    await Promise.all([
                        includeHTML('header-container', '/includes/header.html'),
                        includeHTML('footer-container', '/includes/footer.html')
                    ]);
                } catch (error) {
                    console.error('Failed to load includes:', error);
                }
            }

            setupUI() {
                // Update user name
                const userNameElement = document.getElementById('userName');
                if (userNameElement && this.currentUser) {
                    userNameElement.textContent = this.currentUser.username;
                }

                // Initialize modals
                const modalElement = document.getElementById('preferenceTuningModal');
                if (modalElement) {
                    this.preferenceTuningModal = new bootstrap.Modal(modalElement);
                }
            }

            async loadDashboardContent() {
                try {
                    // Load user stats
                    await this.loadUserStats();

                    // Load content sections
                    const loadPromises = [
                        this.loadContinueWatching(),
                        this.loadPersonalizedRecommendations(),
                        this.loadActivityBasedContent(),
                        this.loadTrendingContent(),
                        this.loadPreferenceBasedContent()
                    ];

                    await Promise.allSettled(loadPromises);
                } catch (error) {
                    console.error('Error loading dashboard content:', error);
                }
            }

            async loadUserStats() {
                try {
                    const [watchlist, favorites] = await Promise.all([
                        API.getWatchlist(),
                        API.getFavorites()
                    ]);

                    // Update stats
                    document.getElementById('watchlistCount').textContent = watchlist.length;
                    document.getElementById('favoritesCount').textContent = favorites.length;
                    document.getElementById('quickWatchlistCount').textContent = `${watchlist.length} items`;
                    document.getElementById('quickFavoritesCount').textContent = `${favorites.length} items`;

                    // Animate counters
                    this.animateCounters();
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            async loadContinueWatching() {
                try {
                    const watchlist = await API.getWatchlist();
                    if (watchlist && watchlist.length > 0) {
                        this.renderCarousel('continueWatchingCarousel', watchlist.slice(0, 10));
                    } else {
                        this.showEmptyState('continueWatchingCarousel', 'No items in your watchlist yet', 'Start adding content to see it here');
                    }
                } catch (error) {
                    console.error('Error loading continue watching:', error);
                    this.showErrorState('continueWatchingCarousel', 'Failed to load continue watching');
                }
            }

            async loadPersonalizedRecommendations() {
                try {
                    // Try ML-powered recommendations first
                    let recommendations = await API.getMLPersonalizedRecommendations(20);
                    
                    if (!recommendations || recommendations.length === 0) {
                        // Fallback to regular personalized recommendations
                        recommendations = await API.getPersonalizedRecommendations(20);
                    }

                    if (recommendations && recommendations.length > 0) {
                        this.renderCarousel('recommendedCarousel', recommendations);
                        
                        // Update recommendation source badge
                        const sourceElement = document.getElementById('recommendationSource');
                        if (sourceElement) {
                            sourceElement.textContent = recommendations[0].recommendation_source === 'ml_service' ? 'AI Powered' : 'Smart Recommendations';
                        }
                    } else {
                        this.showEmptyState('recommendedCarousel', 'Getting to know your preferences', 'Rate and watch more content for better recommendations');
                    }
                } catch (error) {
                    console.error('Error loading personalized recommendations:', error);
                    this.showErrorState('recommendedCarousel', 'Failed to load recommendations');
                }
            }

            async loadActivityBasedContent() {
                try {
                    // This would ideally use user's viewing history to get similar content
                    const trending = await API.getTrending('all', 15);
                    if (trending && trending.length > 0) {
                        this.renderCarousel('activityBasedCarousel', trending);
                    }
                } catch (error) {
                    console.error('Error loading activity-based content:', error);
                    this.showErrorState('activityBasedCarousel', 'Failed to load activity-based content');
                }
            }

            async loadTrendingContent() {
                try {
                    const trending = await API.getTrending('all', 20);
                    if (trending && trending.length > 0) {
                        this.renderCarousel('trendingCarousel', trending);
                    }
                } catch (error) {
                    console.error('Error loading trending content:', error);
                    this.showErrorState('trendingCarousel', 'Failed to load trending content');
                }
            }

            async loadPreferenceBasedContent() {
                try {
                    // Load content based on user's preferred genres
                    const userGenres = this.currentUser.preferred_genres || ['Action', 'Drama'];
                    let preferenceContent = [];

                    for (const genre of userGenres.slice(0, 2)) {
                        try {
                            const genreContent = await API.getGenreRecommendations(genre, 'movie', 10);
                            preferenceContent = preferenceContent.concat(genreContent);
                        } catch (error) {
                            console.warn(`Failed to load ${genre} content:`, error);
                        }
                    }

                    if (preferenceContent.length > 0) {
                        // Remove duplicates and limit
                        const uniqueContent = preferenceContent.filter((item, index, self) => 
                            index === self.findIndex(t => t.id === item.id)
                        ).slice(0, 20);
                        
                        this.renderCarousel('preferencesCarousel', uniqueContent);
                    }
                } catch (error) {
                    console.error('Error loading preference-based content:', error);
                    this.showErrorState('preferencesCarousel', 'Failed to load preference-based content');
                }
            }

            renderCarousel(carouselId, content) {
                const carousel = document.getElementById(carouselId);
                if (!carousel || !content || content.length === 0) return;

                const carouselHTML = content.map(item => Components.createContentCard(item)).join('');
                carousel.innerHTML = carouselHTML;

                // Initialize lazy loading
                this.initializeLazyLoading(carousel);
            }

            showEmptyState(carouselId, title, description) {
                const carousel = document.getElementById(carouselId);
                if (!carousel) return;

                carousel.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3 class="empty-state-title">${title}</h3>
                        <p class="empty-state-description">${description}</p>
                        <a href="/search" class="btn btn-primary">Discover Content</a>
                    </div>
                `;
            }

            showErrorState(carouselId, message) {
                const carousel = document.getElementById(carouselId);
                if (!carousel) return;

                carousel.innerHTML = Components.createErrorMessage(message, true, `dashboard.retrySection('${carouselId}')`);
            }

            async retrySection(carouselId) {
                const retryMap = {
                    'continueWatchingCarousel': () => this.loadContinueWatching(),
                    'recommendedCarousel': () => this.loadPersonalizedRecommendations(),
                    'activityBasedCarousel': () => this.loadActivityBasedContent(),
                    'trendingCarousel': () => this.loadTrendingContent(),
                    'preferencesCarousel': () => this.loadPreferenceBasedContent()
                };

                if (retryMap[carouselId]) {
                    const carousel = document.getElementById(carouselId);
                    if (carousel) {
                        carousel.innerHTML = Components.createLoadingSpinner('Loading...');
                    }
                    await retryMap[carouselId]();
                }
            }

            animateCounters() {
                const counters = document.querySelectorAll('.stat-number');
                counters.forEach(counter => {
                    const target = parseInt(counter.textContent);
                    const duration = 1000;
                    const increment = target / (duration / 16);
                    let current = 0;

                    const animate = () => {
                        current += increment;
                        if (current < target) {
                            counter.textContent = Math.floor(current);
                            requestAnimationFrame(animate);
                        } else {
                            counter.textContent = target;
                        }
                    };

                    animate();
                });
            }

            initializeLazyLoading(container) {
                if (!('IntersectionObserver' in window)) return;

                const imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src || img.src;
                            img.classList.remove('lazy');
                            imageObserver.unobserve(img);
                        }
                    });
                });

                const images = container.querySelectorAll('img[loading="lazy"]');
                images.forEach(img => imageObserver.observe(img));
            }

            setupEventListeners() {
                // Preference tuning
                const preferenceTuneBtn = document.querySelector('.preference-tune-btn');
                if (preferenceTuneBtn) {
                    preferenceTuneBtn.addEventListener('click', () => this.showPreferenceTuning());
                }
            }

            showPreferenceTuning() {
                if (this.preferenceTuningModal) {
                    this.loadPreferenceTuningOptions();
                    this.preferenceTuningModal.show();
                }
            }

            loadPreferenceTuningOptions() {
                // Load languages
                const languageContainer = document.querySelector('.language-preferences');
                if (languageContainer) {
                    const languages = ['english', 'hindi', 'telugu', 'tamil', 'kannada', 'malayalam'];
                    const userLanguages = this.currentUser.preferred_languages || [];
                    
                    languageContainer.innerHTML = languages.map(lang => `
                        <label class="preference-checkbox">
                            <input type="checkbox" name="languages" value="${lang}" ${userLanguages.includes(lang) ? 'checked' : ''}>
                            <span class="checkmark"></span>
                            ${lang.charAt(0).toUpperCase() + lang.slice(1)}
                        </label>
                    `).join('');
                }

                // Load genres
                const genreContainer = document.querySelector('.genre-preferences');
                if (genreContainer) {
                    const genres = ['Action', 'Drama', 'Comedy', 'Romance', 'Thriller', 'Horror', 'Animation', 'Documentary'];
                    const userGenres = this.currentUser.preferred_genres || [];
                    
                    genreContainer.innerHTML = genres.map(genre => `
                        <label class="preference-checkbox">
                            <input type="checkbox" name="genres" value="${genre}" ${userGenres.includes(genre) ? 'checked' : ''}>
                            <span class="checkmark"></span>
                            ${genre}
                        </label>
                    `).join('');
                }
            }

            async savePreferences() {
                try {
                    const selectedLanguages = Array.from(document.querySelectorAll('input[name="languages"]:checked')).map(cb => cb.value);
                    const selectedGenres = Array.from(document.querySelectorAll('input[name="genres"]:checked')).map(cb => cb.value);
                    const selectedContentTypes = Array.from(document.querySelectorAll('input[name="contentTypes"]:checked')).map(cb => cb.value);

                    await API.updateProfile({
                        preferred_languages: selectedLanguages,
                        preferred_genres: selectedGenres,
                        preferred_content_types: selectedContentTypes
                    });

                    // Update current user
                    this.currentUser.preferred_languages = selectedLanguages;
                    this.currentUser.preferred_genres = selectedGenres;

                    // Close modal
                    this.preferenceTuningModal.hide();

                    // Show success message
                    showNotification('Preferences updated successfully!', 'success');

                    // Refresh recommendations
                    await this.refreshPersonalizedContent();
                } catch (error) {
                    console.error('Error saving preferences:', error);
                    showNotification('Failed to save preferences. Please try again.', 'error');
                }
            }

            async refreshPersonalizedContent() {
                // Show loading
                const carousels = ['recommendedCarousel', 'preferencesCarousel'];
                carousels.forEach(carouselId => {
                    const carousel = document.getElementById(carouselId);
                    if (carousel) {
                        carousel.innerHTML = Components.createLoadingSpinner('Refreshing...');
                    }
                });

                // Reload content
                await Promise.allSettled([
                    this.loadPersonalizedRecommendations(),
                    this.loadPreferenceBasedContent()
                ]);
            }

            hideLoading() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                    }, 800);
                }
            }
        }

        // Global functions
        function showPreferenceTuning() {
            if (window.dashboard) {
                window.dashboard.showPreferenceTuning();
            }
        }

        function savePreferences() {
            if (window.dashboard) {
                window.dashboard.savePreferences();
            }
        }

        function refreshPersonalizedContent() {
            if (window.dashboard) {
                window.dashboard.refreshPersonalizedContent();
            }
        }

        function scrollCarousel(carouselId, direction) {
            const carousel = document.getElementById(carouselId);
            if (!carousel) return;

            const scrollAmount = 220;
            const currentScroll = carousel.scrollLeft;
            
            let newScroll;
            if (direction === 'left') {
                newScroll = Math.max(0, currentScroll - scrollAmount * 3);
            } else {
                newScroll = currentScroll + scrollAmount * 3;
            }

            carousel.scrollTo({
                left: newScroll,
                behavior: 'smooth'
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new Dashboard();
        });
    </script>
</body>
</html>