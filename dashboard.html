<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineScope</title>
    <script src="auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --netflix-red: #e50914;
            --netflix-black: #141414;
            --netflix-gray: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--netflix-black);
            color: white;
            overflow-x: hidden;
        }

        .navbar {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
        }

        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .main-content.full-width {
            margin-left: 0;
        }

        .welcome-banner {
            background: linear-gradient(135deg, var(--netflix-red) 0%, #b8070e 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            border-color: var(--netflix-red);
        }

        .content-row {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .view-all-btn {
            color: var(--netflix-red);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .view-all-btn:hover {
            color: #b8070e;
        }

        .scroll-container {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            gap: 1rem;
            padding: 0.5rem 0 1rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .content-card {
            flex: 0 0 auto;
            width: 200px;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--netflix-gray);
        }

        .content-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .content-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .content-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .content-card:hover .content-overlay {
            opacity: 1;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0.25rem 1rem;
        }

        .sidebar-link:hover, .sidebar-link.active {
            background: rgba(229, 9, 20, 0.1);
            color: var(--netflix-red);
        }

        .sidebar-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--netflix-red);
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            background: var(--netflix-red);
            height: 100%;
            transition: width 0.3s ease;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--netflix-red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .notification-badge {
            background: var(--netflix-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                height: 100vh;
                z-index: 40;
            }

            .main-content {
                margin-left: 0;
            }

            .content-card {
                width: 150px;
                height: 225px;
            }
        }

        @media (max-width: 768px) {
            .welcome-banner {
                padding: 1.5rem;
            }

            .content-card {
                width: 120px;
                height: 180px;
            }

            .stats-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar fixed top-0 left-0 right-0 z-30 px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button id="sidebarToggle" class="lg:hidden text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-red-600">CineScope</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="searchToggle" class="text-white hover:text-red-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
                
                <div class="relative">
                    <button id="notificationToggle" class="text-white hover:text-red-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.97 4.97a.75.75 0 0 0-1.08 1.08l-3.5 3.5a.75.75 0 0 0 1.08 1.08l3.5-3.5zm4.06 0a.75.75 0 0 1 1.08 1.08l3.5 3.5a.75.75 0 0 1-1.08 1.08l-3.5-3.5z"></path>
                        </svg>
                    </button>
                    <div id="notificationBadge" class="notification-badge absolute -top-2 -right-2 hidden">3</div>
                </div>
                
                <div class="relative">
                    <button id="userMenuToggle" class="user-avatar">
                        <span id="userInitial">U</span>
                    </button>
                    <div id="userMenu" class="hidden absolute right-0 top-12 bg-black border border-gray-700 rounded-lg py-2 w-48">
                        <a href="profile.html" class="block px-4 py-2 text-white hover:bg-gray-800">Profile</a>
                        <a href="user/watchlist.html" class="block px-4 py-2 text-white hover:bg-gray-800">Watchlist</a>
                        <a href="user/favorites.html" class="block px-4 py-2 text-white hover:bg-gray-800">Favorites</a>
                        <hr class="border-gray-700 my-2">
                        <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-white hover:bg-gray-800">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-16 h-full z-20">
        <div class="py-6">
            <nav class="space-y-2">
                <a href="dashboard.html" class="sidebar-link active">
                    <svg class="sidebar-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    Dashboard
                </a>
                
                <a href="index.html" class="sidebar-link">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 011 1v4a1 1 0 01-1 1H3a1 1 0 01-1-1V5a1 1 0 011-1h4z"></path>
                    </svg>
                    Browse
                </a>
                
                <a href="user/watchlist.html" class="sidebar-link">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    Watchlist
                    <span id="watchlistCount" class="notification-badge ml-auto">0</span>
                </a>
                
                <a href="user/favorites.html" class="sidebar-link">
                    <svg class="sidebar-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                    </svg>
                    Favorites
                    <span id="favoritesCount" class="notification-badge ml-auto">0</span>
                </a>
                
                <a href="profile.html" class="sidebar-link">
                    <svg class="sidebar-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                    Profile
                </a>
            </nav>
            
            <div class="mt-8 px-6">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Quick Actions</h3>
                <div class="space-y-2">
                    <button class="quick-action-btn w-full text-left" onclick="openRandomContent()">Random Pick</button>
                    <button class="quick-action-btn w-full text-left" onclick="openFreeContent()">Free Content</button>
                    <button class="quick-action-btn w-full text-left" onclick="openTrending()">Trending Now</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="mainContent" class="main-content pt-20 p-6">
        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Welcome back, <span id="userName">User</span>!</h1>
                    <p class="text-lg opacity-90">Ready to discover something amazing?</p>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-lg font-semibold transition" onclick="openRandomContent()">
                        🎲 Random Pick
                    </button>
                    <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-lg font-semibold transition" onclick="continueWatching()">
                        ▶️ Continue Watching
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stats-card">
                <div class="text-2xl font-bold text-red-500" id="totalWatched">-</div>
                <div class="text-sm text-gray-400">Watched</div>
            </div>
            <div class="stats-card">
                <div class="text-2xl font-bold text-blue-500" id="totalWatchlist">-</div>
                <div class="text-sm text-gray-400">Watchlist</div>
            </div>
            <div class="stats-card">
                <div class="text-2xl font-bold text-green-500" id="totalFavorites">-</div>
                <div class="text-sm text-gray-400">Favorites</div>
            </div>
            <div class="stats-card">
                <div class="text-2xl font-bold text-purple-500" id="hoursWatched">-</div>
                <div class="text-sm text-gray-400">Hours</div>
            </div>
        </div>

        <!-- Continue Watching -->
        <div id="continueWatchingSection" class="content-row hidden">
            <div class="section-header">
                <h2 class="section-title">Continue Watching</h2>
                <a href="#" class="view-all-btn">View All</a>
            </div>
            <div id="continueWatchingContainer" class="scroll-container"></div>
        </div>

        <!-- Recommended For You -->
        <div class="content-row">
            <div class="section-header">
                <h2 class="section-title">Recommended For You</h2>
                <a href="#" class="view-all-btn">View All</a>
            </div>
            <div id="recommendedContainer" class="scroll-container">
                <div class="loading-placeholder">Loading recommendations...</div>
            </div>
        </div>

        <!-- Trending Now -->
        <div class="content-row">
            <div class="section-header">
                <h2 class="section-title">Trending Now</h2>
                <a href="#" class="view-all-btn">View All</a>
            </div>
            <div id="trendingContainer" class="scroll-container">
                <div class="loading-placeholder">Loading trending content...</div>
            </div>
        </div>

        <!-- Your Genres -->
        <div class="content-row">
            <div class="section-header">
                <h2 class="section-title">Based on Your Preferences</h2>
                <a href="#" class="view-all-btn">View All</a>
            </div>
            <div id="preferredGenresContainer" class="scroll-container">
                <div class="loading-placeholder">Loading personalized content...</div>
            </div>
        </div>

        <!-- Recently Added -->
        <div class="content-row">
            <div class="section-header">
                <h2 class="section-title">Recently Added</h2>
                <a href="#" class="view-all-btn">View All</a>
            </div>
            <div id="recentlyAddedContainer" class="scroll-container">
                <div class="loading-placeholder">Loading new content...</div>
            </div>
        </div>

        <!-- Free to Watch -->
        <div class="content-row">
            <div class="section-header">
                <h2 class="section-title">Free to Watch</h2>
                <a href="#" class="view-all-btn">View All</a>
            </div>
            <div id="freeContentContainer" class="scroll-container">
                <div class="loading-placeholder">Loading free content...</div>
            </div>
        </div>
    </main>

    <!-- Search Overlay -->
    <div id="searchOverlay" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-start justify-center pt-20">
        <div class="w-full max-w-2xl px-4">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="w-full px-6 py-4 text-xl bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-red-500"
                    placeholder="Search for movies, TV shows, anime..."
                    autocomplete="off"
                >
                <button id="closeSearch" class="absolute right-4 top-4 text-white hover:text-red-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="searchResults" class="mt-4 space-y-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // Constants
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        
        // State
        let currentUser = window.currentUser;
        let authToken = window.authToken;
        let userStats = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            initializeEventListeners();
            loadDashboardData();
        });

        function checkAuthentication() {
            if (!currentUser || !authToken) {
                window.location.href = 'login.html?redirect=dashboard.html';
                return;
            }
            
            // Update UI with user data
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userInitial').textContent = currentUser.username.charAt(0).toUpperCase();
        }

        function initializeEventListeners() {
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            
            // User menu
            document.getElementById('userMenuToggle').addEventListener('click', toggleUserMenu);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Search
            document.getElementById('searchToggle').addEventListener('click', openSearch);
            document.getElementById('closeSearch').addEventListener('click', closeSearch);
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Close user menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#userMenuToggle') && !e.target.closest('#userMenu')) {
                    document.getElementById('userMenu').classList.add('hidden');
                }
            });

            // Close search overlay on escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSearch();
                }
            });
        }

        async function loadDashboardData() {
            await Promise.all([
                loadUserStats(),
                loadRecommendedContent(),
                loadTrendingContent(),
                loadPreferredGenreContent(),
                loadRecentlyAdded(),
                loadFreeContent(),
                loadContinueWatching()
            ]);
        }

        async function loadUserStats() {
            try {
                // Load watchlist
                const watchlistResponse = await fetch(`${API_BASE}/user/watchlist`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const watchlistData = await watchlistResponse.json();
                
                // Load favorites
                const favoritesResponse = await fetch(`${API_BASE}/user/favorites`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const favoritesData = await favoritesResponse.json();

                // Update stats
                const watchlistCount = watchlistData.watchlist?.length || 0;
                const favoritesCount = favoritesData.favorites?.length || 0;

                document.getElementById('totalWatchlist').textContent = watchlistCount;
                document.getElementById('totalFavorites').textContent = favoritesCount;
                document.getElementById('watchlistCount').textContent = watchlistCount;
                document.getElementById('favoritesCount').textContent = favoritesCount;

                // Simulate other stats
                document.getElementById('totalWatched').textContent = Math.floor(Math.random() * 50) + 10;
                document.getElementById('hoursWatched').textContent = Math.floor(Math.random() * 200) + 50;

            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }

        async function loadRecommendedContent() {
            try {
                const response = await fetch(`${API_BASE}/recommendations/personalized`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (response.ok) {
                    displayContent('recommendedContainer', data.recommendations || []);
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
                // Fallback to trending
                loadTrendingContent('recommendedContainer');
            }
        }

        async function loadTrendingContent(containerId = 'trendingContainer') {
            try {
                const response = await fetch(`${API_BASE}/recommendations/trending?limit=20`);
                const data = await response.json();
                
                if (response.ok) {
                    displayContent(containerId, data.recommendations || []);
                }
            } catch (error) {
                console.error('Failed to load trending:', error);
            }
        }

        async function loadPreferredGenreContent() {
            try {
                // Use user's preferred genres or fallback to popular
                const genres = currentUser.preferred_genres?.length > 0 
                    ? currentUser.preferred_genres 
                    : ['action', 'comedy', 'drama'];
                
                const response = await fetch(`${API_BASE}/recommendations/popular/${genres[0]}?limit=20`);
                const data = await response.json();
                
                if (response.ok) {
                    displayContent('preferredGenresContainer', data.recommendations || []);
                }
            } catch (error) {
                console.error('Failed to load preferred genre content:', error);
            }
        }

        async function loadRecentlyAdded() {
            try {
                // Use trending as recently added for now
                const response = await fetch(`${API_BASE}/recommendations/trending?limit=20`);
                const data = await response.json();
                
                if (response.ok) {
                    displayContent('recentlyAddedContainer', data.recommendations || []);
                }
            } catch (error) {
                console.error('Failed to load recently added:', error);
            }
        }

        async function loadFreeContent() {
            try {
                const response = await fetch(`${API_BASE}/recommendations/trending?limit=20`);
                const data = await response.json();
                
                if (response.ok) {
                    const freeContent = (data.recommendations || []).filter(item => 
                        item.ott_platforms?.free_platforms?.length > 0
                    );
                    displayContent('freeContentContainer', freeContent.slice(0, 20));
                }
            } catch (error) {
                console.error('Failed to load free content:', error);
            }
        }

        async function loadContinueWatching() {
            // Simulate continue watching data
            // In a real app, this would come from user's viewing history
            const continueWatchingData = [];
            
            if (continueWatchingData.length > 0) {
                document.getElementById('continueWatchingSection').classList.remove('hidden');
                displayContinueWatching('continueWatchingContainer', continueWatchingData);
            }
        }

        function displayContent(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No content available</p>';
                return;
            }

            container.innerHTML = items.map(item => createContentCard(item)).join('');
        }

        function displayContinueWatching(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = items.map(item => createContinueWatchingCard(item)).join('');
        }

        function createContentCard(item) {
            const posterUrl = item.poster_path || 'https://via.placeholder.com/300x450/333/fff?text=No+Image';
            const rating = item.rating ? `⭐ ${item.rating.toFixed(1)}` : '';
            
            return `
                <div class="content-card" onclick="openContentDetails(${item.id})">
                    <img src="${posterUrl}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/333/fff?text=No+Image'">
                    <div class="content-overlay">
                        <h3 class="font-bold text-sm mb-1">${item.title}</h3>
                        <p class="text-xs text-gray-300 mb-2">${rating}</p>
                        <div class="flex space-x-2">
                            <button class="quick-action-btn text-xs" onclick="event.stopPropagation(); addToWatchlist(${item.id})">+ Watchlist</button>
                            <button class="quick-action-btn text-xs" onclick="event.stopPropagation(); addToFavorites(${item.id})">❤️</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function createContinueWatchingCard(item) {
            const posterUrl = item.poster_path || 'https://via.placeholder.com/300x450/333/fff?text=No+Image';
            const progress = item.progress || 0;
            
            return `
                <div class="content-card" onclick="openContentDetails(${item.id})">
                    <img src="${posterUrl}" alt="${item.title}" loading="lazy">
                    <div class="content-overlay">
                        <h3 class="font-bold text-sm mb-1">${item.title}</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">${progress}% watched</p>
                    </div>
                </div>
            `;
        }

        async function addToWatchlist(contentId) {
            try {
                const response = await fetch(`${API_BASE}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: 'watchlist'
                    })
                });

                if (response.ok) {
                    showNotification('Added to watchlist!');
                    loadUserStats(); // Refresh stats
                }
            } catch (error) {
                console.error('Failed to add to watchlist:', error);
            }
        }

        async function addToFavorites(contentId) {
            try {
                const response = await fetch(`${API_BASE}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: 'favorite'
                    })
                });

                if (response.ok) {
                    showNotification('Added to favorites!');
                    loadUserStats(); // Refresh stats
                }
            } catch (error) {
                console.error('Failed to add to favorites:', error);
            }
        }

        function openContentDetails(contentId) {
            window.location.href = `details.html?id=${contentId}`;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('full-width');
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function logout() {
            // Clear user data
            window.currentUser = null;
            window.authToken = null;
            
            // Redirect to login
            window.location.href = 'login.html';
        }

        function openSearch() {
            document.getElementById('searchOverlay').classList.remove('hidden');
            document.getElementById('searchInput').focus();
        }

        function closeSearch() {
            document.getElementById('searchOverlay').classList.add('hidden');
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        let searchTimeout;
        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/search?query=${encodeURIComponent(query)}&limit=10`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        displaySearchResults(data.results || []);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No results found</p>';
                return;
            }

            container.innerHTML = results.map(item => `
                <div class="flex items-center space-x-4 p-3 hover:bg-white hover:bg-opacity-10 rounded-lg cursor-pointer" onclick="openContentDetails(${item.id}); closeSearch();">
                    <img src="${item.poster_path || 'https://via.placeholder.com/60x90/333/fff?text=No+Image'}" alt="${item.title}" class="w-12 h-18 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-semibold text-white">${item.title}</h3>
                        <p class="text-sm text-gray-400">${item.content_type} • ${item.rating ? item.rating.toFixed(1) + '⭐' : 'Not rated'}</p>
                    </div>
                </div>
            `).join('');
        }

        function openRandomContent() {
            // Get a random content from trending
            loadTrendingContent().then(() => {
                const cards = document.querySelectorAll('#trendingContainer .content-card');
                if (cards.length > 0) {
                    const randomCard = cards[Math.floor(Math.random() * cards.length)];
                    randomCard.click();
                }
            });
        }

        function openFreeContent() {
            window.location.href = 'index.html#free-content';
        }

        function openTrending() {
            window.location.href = 'index.html#trending';
        }

        function continueWatching() {
            // Scroll to continue watching section or load content
            const section = document.getElementById('continueWatchingSection');
            if (!section.classList.contains('hidden')) {
                section.scrollIntoView({ behavior: 'smooth' });
            } else {
                openTrending();
            }
        }

        function showNotification(message) {
            // Simple notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-green-600 text-white px-4 py-2 rounded-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Auto-hide sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 1024) {
                const sidebar = document.getElementById('sidebar');
                const sidebarToggle = document.getElementById('sidebarToggle');
                
                if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.add('hidden');
                    document.getElementById('mainContent').classList.add('full-width');
                }
            }
        });

        // Handle responsive behavior
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('mainContent').classList.remove('full-width');
            }
        });
    </script>
</body>
</html>