<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <script>document.write('<script src="/includes/head.html"><\/script>');</script>
</head>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <!-- Main Content -->
    <main class="container py-8 pt-24">
        <!-- Welcome Section -->
        <section class="mb-12">
            <div class="dashboard-welcome">
                <h1 class="text-4xl font-bold mb-4">
                    Welcome back, <span id="userName" class="text-gradient">User</span>!
                </h1>
                <p class="text-gray-400 text-lg">Continue your entertainment journey with personalized recommendations</p>
            </div>
        </section>

        <!-- Dashboard Stats -->
        <section class="dashboard-stats mb-12">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bookmark"></i>
                </div>
                <div class="stat-number" id="watchlistCount">0</div>
                <div class="stat-label">Watchlist</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="stat-number" id="favoritesCount">0</div>
                <div class="stat-label">Favorites</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number" id="recentViewsCount">0</div>
                <div class="stat-label">Recent Views</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-number" id="ratingsCount">0</div>
                <div class="stat-label">Ratings Given</div>
            </div>
        </section>

        <!-- Continue Watching -->
        <section class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="section-title">
                    <i class="fas fa-play-circle text-green-500"></i>
                    Continue Watching
                </h2>
            </div>
            <div id="continueWatching">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>

        <!-- Recommended For You -->
        <section class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="section-title">
                    <i class="fas fa-magic text-purple-500"></i>
                    Recommended For You
                </h2>
                <button class="btn btn-ghost btn-sm" onclick="refreshRecommendations()">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
            </div>
            <div id="personalizedRecommendations">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>

        <!-- Based on Your Activity -->
        <section class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="section-title">
                    <i class="fas fa-history text-blue-500"></i>
                    Based on Your Activity
                </h2>
            </div>
            <div id="activityBased">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </section>

        <!-- Your Preferences -->
        <section class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="section-title">
                    <i class="fas fa-user-cog text-indigo-500"></i>
                    Your Preferences
                </h2>
                <a href="/profile" class="btn btn-ghost btn-sm">
                    <i class="fas fa-edit mr-2"></i>
                    Edit Preferences
                </a>
            </div>
            <div class="preferences-display">
                <div class="preference-group">
                    <h3 class="preference-title">Languages</h3>
                    <div id="userLanguages" class="preference-tags"></div>
                </div>
                <div class="preference-group">
                    <h3 class="preference-title">Genres</h3>
                    <div id="userGenres" class="preference-tags"></div>
                </div>
            </div>
        </section>

        <!-- Quick Access -->
        <section class="mb-12">
            <h2 class="section-title mb-6">
                <i class="fas fa-bolt text-yellow-500"></i>
                Quick Access
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <a href="/user/watchlist" class="quick-access-card">
                    <i class="fas fa-bookmark text-primary-500"></i>
                    <span>My Watchlist</span>
                </a>
                <a href="/user/favorites" class="quick-access-card">
                    <i class="fas fa-heart text-red-500"></i>
                    <span>My Favorites</span>
                </a>
                <a href="/categories/trending" class="quick-access-card">
                    <i class="fas fa-fire text-orange-500"></i>
                    <span>Trending</span>
                </a>
                <a href="/categories/new-releases" class="quick-access-card">
                    <i class="fas fa-clock text-green-500"></i>
                    <span>New Releases</span>
                </a>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div data-include="footer"></div>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class DashboardManager {
            constructor() {
                this.init();
            }

            async init() {
                if (!AuthManager.requireAuth()) return;

                await this.loadUserData();
                await this.loadDashboardContent();
            }

            async loadUserData() {
                const user = AuthManager.currentUser;
                if (!user) return;

                document.getElementById('userName').textContent = user.username;

                // Display user preferences
                if (user.preferred_languages) {
                    this.displayPreferences('userLanguages', user.preferred_languages);
                }
                if (user.preferred_genres) {
                    this.displayPreferences('userGenres', user.preferred_genres);
                }

                // Load user stats
                await this.loadUserStats();
            }

            displayPreferences(containerId, preferences) {
                const container = document.getElementById(containerId);
                container.innerHTML = preferences.map(pref => 
                    `<span class="preference-tag">${pref}</span>`
                ).join('');
            }

            async loadUserStats() {
                try {
                    const [watchlist, favorites] = await Promise.all([
                        APIService.getWatchlist(),
                        APIService.getFavorites()
                    ]);

                    document.getElementById('watchlistCount').textContent = watchlist.watchlist?.length || 0;
                    document.getElementById('favoritesCount').textContent = favorites.favorites?.length || 0;
                    // Note: Recent views and ratings would need additional API endpoints
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }

            async loadDashboardContent() {
                const sections = [
                    { id: 'continueWatching', loader: this.loadContinueWatching },
                    { id: 'personalizedRecommendations', loader: this.loadPersonalizedRecommendations },
                    { id: 'activityBased', loader: this.loadActivityBased }
                ];

                for (const section of sections) {
                    try {
                        await section.loader.call(this, section.id);
                    } catch (error) {
                        console.error(`Error loading ${section.id}:`, error);
                        document.getElementById(section.id).innerHTML = this.createErrorState();
                    }
                }
            }

            async loadContinueWatching(containerId) {
                // For now, show recent watchlist items
                try {
                    const response = await APIService.getWatchlist();
                    const content = response.watchlist?.slice(0, 10) || [];
                    
                    document.getElementById(containerId).innerHTML = content.length > 0 
                        ? app.createContentGrid(content)
                        : this.createEmptyState('No items to continue watching');
                } catch (error) {
                    document.getElementById(containerId).innerHTML = this.createErrorState();
                }
            }

            async loadPersonalizedRecommendations(containerId) {
                try {
                    const response = await APIService.getPersonalizedRecommendations(20);
                    const content = response.recommendations || [];
                    
                    document.getElementById(containerId).innerHTML = content.length > 0 
                        ? app.createContentGrid(content)
                        : this.createEmptyState('Building your recommendations...');
                } catch (error) {
                    // Fallback to trending
                    const response = await APIService.getTrending();
                    const content = response.recommendations || [];
                    document.getElementById(containerId).innerHTML = app.createContentGrid(content);
                }
            }

            async loadActivityBased(containerId) {
                try {
                    // Mix of different recommendation types based on user activity
                    const [trending, newReleases] = await Promise.all([
                        APIService.getTrending('all', 10),
                        APIService.getNewReleases(null, 'movie', 10)
                    ]);

                    const content = [
                        ...(trending.recommendations || []),
                        ...(newReleases.recommendations || [])
                    ].slice(0, 20);

                    document.getElementById(containerId).innerHTML = content.length > 0 
                        ? app.createContentGrid(content)
                        : this.createEmptyState('No activity-based recommendations');
                } catch (error) {
                    document.getElementById(containerId).innerHTML = this.createErrorState();
                }
            }

            createEmptyState(message) {
                return `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>${message}</p>
                    </div>
                `;
            }

            createErrorState() {
                return `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Failed to load content</p>
                    </div>
                `;
            }
        }

        async function refreshRecommendations() {
            const container = document.getElementById('personalizedRecommendations');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const dashboard = new DashboardManager();
            await dashboard.loadPersonalizedRecommendations('personalizedRecommendations');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });
    </script>
</body>
</html>