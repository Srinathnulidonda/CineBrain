<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your personalized dashboard with movie and TV show recommendations.">
    <title>Dashboard - CineScope</title>
    
    <link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="header-container"></div>
    
    <main class="main-content pt-20">
        <div class="container">
            <!-- Welcome Banner -->
            <section class="welcome-banner mb-8">
                <div class="card card-gradient p-8">
                    <div class="flex flex-col md:flex-row items-center justify-between">
                        <div class="mb-4 md:mb-0">
                            <h1 class="text-3xl font-bold mb-2">
                                Welcome back, <span data-user-info="username" class="text-primary">User</span>!
                            </h1>
                            <p class="text-muted">Discover your next favorite from personalized recommendations</p>
                        </div>
                        <div class="stats-grid grid grid-cols-3 gap-4 text-center">
                            <div class="stat-item">
                                <div class="text-2xl font-bold text-primary" id="watchlist-count">0</div>
                                <div class="text-sm text-muted">Watchlist</div>
                            </div>
                            <div class="stat-item">
                                <div class="text-2xl font-bold text-purple-400" id="favorites-count">0</div>
                                <div class="text-sm text-muted">Favorites</div>
                            </div>
                            <div class="stat-item">
                                <div class="text-2xl font-bold text-green-400" id="viewed-count">0</div>
                                <div class="text-sm text-muted">Viewed</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Continue Watching -->
            <section class="section" id="continue-watching-section" style="display: none;">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Continue Watching</h2>
                        <p class="section-subtitle">Resume from where you left off</p>
                    </div>
                </div>
                <div id="continue-watching-carousel">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Recommended For You -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Recommended For You</h2>
                        <p class="section-subtitle">Personalized picks based on your taste</p>
                    </div>
                    <button class="btn btn-outline" onclick="app.refreshRecommendations()">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="personalized-carousel" class="loading">
                    <div class="carousel">
                        <div class="carousel-track">
                            ${Array(8).fill().map(() => '<div class="content-card skeleton skeleton-card"></div>').join('')}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Based on Your Recent Activity -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Based on Your Recent Activity</h2>
                        <p class="section-subtitle">More like what you've been watching</p>
                    </div>
                </div>
                <div id="recent-activity-carousel" class="loading">
                    <div class="carousel">
                        <div class="carousel-track">
                            ${Array(8).fill().map(() => '<div class="content-card skeleton skeleton-card"></div>').join('')}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Genre Recommendations -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Your Favorite Genres</h2>
                        <p class="section-subtitle">Curated content from genres you love</p>
                    </div>
                </div>
                <div id="genre-tabs" class="flex gap-2 mb-6 overflow-x-auto">
                    <button class="btn btn-outline btn-sm tab-button active" data-genre="action">Action</button>
                    <button class="btn btn-outline btn-sm tab-button" data-genre="drama">Drama</button>
                    <button class="btn btn-outline btn-sm tab-button" data-genre="comedy">Comedy</button>
                    <button class="btn btn-outline btn-sm tab-button" data-genre="sci-fi">Sci-Fi</button>
                    <button class="btn btn-outline btn-sm tab-button" data-genre="horror">Horror</button>
                    <button class="btn btn-outline btn-sm tab-button" data-genre="romance">Romance</button>
                </div>
                <div id="genre-carousel" class="loading">
                    <div class="carousel">
                        <div class="carousel-track">
                            ${Array(8).fill().map(() => '<div class="content-card skeleton skeleton-card"></div>').join('')}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recently Added -->
            <section class="section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Recently Added</h2>
                        <p class="section-subtitle">New content in your preferred genres</p>
                    </div>
                    <button class="btn btn-outline" data-page="new-releases">View All</button>
                </div>
                <div id="recently-added-carousel" class="loading">
                    <div class="carousel">
                        <div class="carousel-track">
                            ${Array(8).fill().map(() => '<div class="content-card skeleton skeleton-card"></div>').join('')}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Access -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Quick Access</h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="quick-access-card card" data-page="watchlist">
                        <div class="text-center p-6">
                            <div class="text-4xl mb-4">üìù</div>
                            <h3 class="font-semibold mb-2">My Watchlist</h3>
                            <p class="text-sm text-muted">Content saved for later</p>
                        </div>
                    </div>
                    <div class="quick-access-card card" data-page="favorites">
                        <div class="text-center p-6">
                            <div class="text-4xl mb-4">‚ù§Ô∏è</div>
                            <h3 class="font-semibold mb-2">My Favorites</h3>
                            <p class="text-sm text-muted">Content you loved</p>
                        </div>
                    </div>
                    <div class="quick-access-card card" data-page="profile">
                        <div class="text-center p-6">
                            <div class="text-4xl mb-4">‚öôÔ∏è</div>
                            <h3 class="font-semibold mb-2">Preferences</h3>
                            <p class="text-sm text-muted">Customize recommendations</p>
                        </div>
                    </div>
                    <div class="quick-access-card card" onclick="app.showDiscoveryQuiz()">
                        <div class="text-center p-6">
                            <div class="text-4xl mb-4">üéØ</div>
                            <h3 class="font-semibold mb-2">Discovery Quiz</h3>
                            <p class="text-sm text-muted">Find your taste</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <div id="footer-container"></div>
    
    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            loadIncludes();
            
            // Redirect if not logged in
            if (!app.currentUser) {
                app.navigateTo('login');
                return;
            }
            
            await loadDashboardContent();
            setupDashboardInteractions();
        });
        
        async function loadDashboardContent() {
            try {
                // Load personalized recommendations
                const [personalized, recentActivity, recentlyAdded] = await Promise.all([
                    app.getRecommendations('personalized', { limit: 20 }),
                    app.getRecommendations('trending', { limit: 20 }), // Fallback
                    app.getRecommendations('new-releases', { limit: 20 })
                ]);
                
                app.renderCarousel(document.getElementById('personalized-carousel'), personalized);
                app.renderCarousel(document.getElementById('recent-activity-carousel'), recentActivity);
                app.renderCarousel(document.getElementById('recently-added-carousel'), recentlyAdded);
                
                // Load default genre (action)
                await loadGenreContent('action');
                
                // Load user stats
                await loadUserStats();
                
            } catch (error) {
                console.error('Failed to load dashboard content:', error);
            }
        }
        
        async function loadGenreContent(genre) {
            try {
                const genreContent = await app.getRecommendations('genre', { genre, limit: 20 });
                app.renderCarousel(document.getElementById('genre-carousel'), genreContent);
            } catch (error) {
                console.error('Failed to load genre content:', error);
            }
        }
        
        async function loadUserStats() {
            try {
                const [watchlist, favorites] = await Promise.all([
                    app.apiCall('/user/watchlist'),
                    app.apiCall('/user/favorites')
                ]);
                
                document.getElementById('watchlist-count').textContent = watchlist.watchlist?.length || 0;
                document.getElementById('favorites-count').textContent = favorites.favorites?.length || 0;
                document.getElementById('viewed-count').textContent = '12'; // Mock data
                
            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }
        
        function setupDashboardInteractions() {
            // Genre tabs
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    // Update active state
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Load genre content
                    const genre = button.dataset.genre;
                    await loadGenreContent(genre);
                });
            });
            
            // Quick access cards
            const quickAccessCards = document.querySelectorAll('.quick-access-card');
            quickAccessCards.forEach(card => {
                card.addEventListener('click', () => {
                    const page = card.dataset.page;
                    if (page) {
                        app.navigateTo(page);
                    }
                });
            });
        }
        
        // Add to app object
        if (typeof app !== 'undefined') {
            app.refreshRecommendations = async function() {
                // Clear cache for personalized recommendations
                this.cache.delete('recommendations_personalized_{}');
                await loadDashboardContent();
                this.showNotification('Recommendations refreshed!', 'success');
            };
            
            app.showDiscoveryQuiz = function() {
                this.showModal(`
                    <div class="discovery-quiz">
                        <h2 class="text-2xl font-bold mb-4">Discover Your Taste</h2>
                        <p class="text-muted mb-6">Answer a few questions to get better recommendations</p>
                        <div class="space-y-4">
                            <div>
                                <label class="form-label">Favorite genres (select multiple):</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" value="action" class="mr-2"> Action
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="comedy" class="mr-2"> Comedy
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="drama" class="mr-2"> Drama
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="sci-fi" class="mr-2"> Sci-Fi
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Preferred content type:</label>
                                <select class="form-input">
                                    <option value="all">All types</option>
                                    <option value="movie">Movies only</option>
                                    <option value="tv">TV Shows only</option>
                                    <option value="anime">Anime only</option>
                                </select>
                            </div>
                            <div class="flex gap-4 mt-6">
                                <button class="btn btn-primary">Update Preferences</button>
                                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `);
            };
        }
    </script>
    
    <style>
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border-radius: var(--radius-xl);
            color: white;
        }
        
        .stats-grid {
            min-width: 200px;
        }
        
        .stat-item {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
        }
        
        .quick-access-card {
            cursor: pointer;
            transition: all var(--transition-normal);
        }
        
        .quick-access-card:hover {
            transform: translateY(-4px);
            background: var(--gradient-card);
        }
        
        .tab-button.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .discovery-quiz {
            max-width: 500px;
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            
            .stat-item {
                padding: 0.75rem 0.5rem;
            }
            
            .welcome-banner .flex {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</body>
</html>