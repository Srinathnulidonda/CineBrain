<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineScope</title>
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
    
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
</head>
<body>
    <!-- Header -->
    <header data-include="header"></header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Welcome Section -->
        <section class="welcome-section">
            <div class="container">
                <div class="welcome-banner">
                    <div class="welcome-content">
                        <h1 class="welcome-title">Welcome back, <span id="user-welcome-name">User</span>!</h1>
                        <p class="welcome-subtitle">Discover your next favorite movie from our personalized recommendations</p>
                        <div class="welcome-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="watchlist-count">0</span>
                                <span class="stat-label">Watchlist Items</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="favorites-count">0</span>
                                <span class="stat-label">Favorites</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="watched-count">0</span>
                                <span class="stat-label">Movies Watched</span>
                            </div>
                        </div>
                    </div>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" data-navigate="/search">
                            üîç Discover New Content
                        </button>
                        <button class="btn btn-secondary" data-navigate="/user/watchlist">
                            üìö View Watchlist
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="quick-actions-section">
            <div class="container">
                <div class="quick-actions">
                    <button class="quick-action-btn" data-navigate="/categories/trending">
                        <div class="quick-action-icon">üî•</div>
                        <div class="quick-action-text">Trending</div>
                    </button>
                    <button class="quick-action-btn" data-navigate="/categories/new-releases">
                        <div class="quick-action-icon">üÜï</div>
                        <div class="quick-action-text">New Releases</div>
                    </button>
                    <button class="quick-action-btn" data-navigate="/categories/critics-choice">
                        <div class="quick-action-icon">‚≠ê</div>
                        <div class="quick-action-text">Critics' Choice</div>
                    </button>
                    <button class="quick-action-btn" data-navigate="/categories/anime">
                        <div class="quick-action-icon">üéå</div>
                        <div class="quick-action-text">Anime</div>
                    </button>
                </div>
            </div>
        </section>

        <!-- Continue Watching -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Continue Watching</h2>
                    <a href="/user/watchlist" class="btn btn-ghost">View All</a>
                </div>
                <div class="content-horizontal-scroll">
                    <div id="continue-watching-content" class="content-horizontal-container">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Recommended For You -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Recommended For You</h2>
                    <div class="recommendation-tuning">
                        <button class="btn btn-ghost btn-small" onclick="app.refreshRecommendations()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <div class="content-grid" id="recommended-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Based on Your Recent Activity -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Based on Your Recent Activity</h2>
                </div>
                <div class="content-grid" id="recent-activity-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Your Preferred Genres -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">More <span id="preferred-genre">Action</span> Movies</h2>
                    <div class="genre-filters">
                        <button class="filter-tag active" data-genre="action">Action</button>
                        <button class="filter-tag" data-genre="comedy">Comedy</button>
                        <button class="filter-tag" data-genre="drama">Drama</button>
                        <button class="filter-tag" data-genre="thriller">Thriller</button>
                    </div>
                </div>
                <div class="content-grid" id="genre-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Regional Content -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Popular in Your Region</h2>
                    <div class="language-filters">
                        <button class="filter-tag active" data-language="hindi">Hindi</button>
                        <button class="filter-tag" data-language="english">English</button>
                        <button class="filter-tag" data-language="telugu">Telugu</button>
                        <button class="filter-tag" data-language="tamil">Tamil</button>
                    </div>
                </div>
                <div class="content-grid" id="regional-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Trending This Week -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Trending This Week</h2>
                    <a href="/categories/trending" class="btn btn-ghost">View All</a>
                </div>
                <div class="content-grid" id="trending-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Recently Added -->
        <section class="content-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Recently Added</h2>
                    <a href="/categories/new-releases" class="btn btn-ghost">View All</a>
                </div>
                <div class="content-grid" id="new-releases-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer data-include="footer"></footer>

    <!-- Recommendation Refresh Modal -->
    <div id="recommendation-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">√ó</button>
            <h3>Refresh Recommendations</h3>
            <p>This will update your recommendations based on your latest activity. Continue?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="app.closeModal(document.getElementById('recommendation-modal'))">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="app.performRecommendationRefresh()">
                    Refresh Now
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    
    <script>
        // Dashboard specific functionality
        document.addEventListener('includesLoaded', () => {
            // Check authentication
            if (!window.app || !window.app.currentUser) {
                window.location.href = '/login';
                return;
            }

            // Initialize dashboard
            initializeDashboard();
        });

        async function initializeDashboard() {
            // Update welcome message
            const welcomeName = document.getElementById('user-welcome-name');
            if (welcomeName && window.app.currentUser) {
                welcomeName.textContent = window.app.currentUser.username;
            }

            // Load user stats
            loadUserStats();

            // Load content sections
            loadDashboardContent();

            // Setup filter handlers
            setupFilterHandlers();
        }

        async function loadUserStats() {
            try {
                const [watchlist, favorites] = await Promise.all([
                    window.app.loadWatchlist(),
                    window.app.loadFavorites()
                ]);

                document.getElementById('watchlist-count').textContent = watchlist.length;
                document.getElementById('favorites-count').textContent = favorites.length;
                
                // Simulate watched count based on interactions
                document.getElementById('watched-count').textContent = Math.floor(Math.random() * 50) + 10;
            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }

        async function loadDashboardContent() {
            const contentSections = [
                {
                    id: 'continue-watching-content',
                    loader: () => window.app.loadWatchlist(),
                    renderer: (content) => renderHorizontalContent(content, 'continue-watching-content')
                },
                {
                    id: 'recommended-content',
                    loader: () => window.app.loadPersonalizedRecommendations(),
                    renderer: (content) => window.app.renderContentGrid(content, 'recommended-content')
                },
                {
                    id: 'recent-activity-content',
                    loader: () => window.app.loadTrending(8, 'movie'),
                    renderer: (content) => window.app.renderContentGrid(content, 'recent-activity-content')
                },
                {
                    id: 'genre-content',
                    loader: () => window.app.loadGenreContent('action', 8),
                    renderer: (content) => window.app.renderContentGrid(content, 'genre-content')
                },
                {
                    id: 'regional-content',
                    loader: () => window.app.loadRegionalContent('hindi', 8),
                    renderer: (content) => window.app.renderContentGrid(content, 'regional-content')
                },
                {
                    id: 'trending-content',
                    loader: () => window.app.loadTrending(8),
                    renderer: (content) => window.app.renderContentGrid(content, 'trending-content')
                },
                {
                    id: 'new-releases-content',
                    loader: () => window.app.loadNewReleases(8),
                    renderer: (content) => window.app.renderContentGrid(content, 'new-releases-content')
                }
            ];

            // Load all sections
            contentSections.forEach(async ({ id, loader, renderer }) => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = window.app.renderLoadingGrid(8);
                    try {
                        const content = await loader();
                        renderer(content);
                    } catch (error) {
                        console.error(`Failed to load content for ${id}:`, error);
                        container.innerHTML = window.app.renderEmptyState('Failed to load content');
                    }
                }
            });
        }

        function renderHorizontalContent(content, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (content.length === 0) {
                container.innerHTML = `
                    <div class="empty-horizontal">
                        <p>Start watching content to see your continue watching list</p>
                        <button class="btn btn-primary" data-navigate="/categories/trending">
                            Browse Content
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = content.map(item => `
                <div class="horizontal-content-item" onclick="app.openContentDetails(${item.id})">
                    <img 
                        class="horizontal-poster lazy-load" 
                        data-src="${window.app.optimizeImageUrl(item.poster_path, 'w200')}"
                        alt="${item.title}"
                        loading="lazy"
                    />
                    <div class="horizontal-info">
                        <h4 class="horizontal-title">${item.title}</h4>
                        <div class="horizontal-meta">
                            <span class="progress-indicator">
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${Math.random() * 100}%"></div>
                                </div>
                                <span class="progress-text">${Math.floor(Math.random() * 100)}% watched</span>
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Setup lazy loading
            window.app.setupLazyLoading(container);
        }

        function setupFilterHandlers() {
            // Genre filter handlers
            document.querySelectorAll('.genre-filters .filter-tag').forEach(tag => {
                tag.addEventListener('click', async (e) => {
                    // Update active state
                    tag.parentElement.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');

                    // Update section title
                    const genre = tag.dataset.genre;
                    document.getElementById('preferred-genre').textContent = genre.charAt(0).toUpperCase() + genre.slice(1);

                    // Load new content
                    const container = document.getElementById('genre-content');
                    container.innerHTML = window.app.renderLoadingGrid(8);
                    const content = await window.app.loadGenreContent(genre, 8);
                    window.app.renderContentGrid(content, 'genre-content');
                });
            });

            // Language filter handlers
            document.querySelectorAll('.language-filters .filter-tag').forEach(tag => {
                tag.addEventListener('click', async (e) => {
                    // Update active state
                    tag.parentElement.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');

                    // Load new content
                    const language = tag.dataset.language;
                    const container = document.getElementById('regional-content');
                    container.innerHTML = window.app.renderLoadingGrid(8);
                    const content = await window.app.loadRegionalContent(language, 8);
                    window.app.renderContentGrid(content, 'regional-content');
                });
            });
        }

        // Extend app with dashboard specific methods
        if (window.app) {
            window.app.refreshRecommendations = function() {
                window.app.openModal('recommendation-modal');
            };

            window.app.performRecommendationRefresh = async function() {
                window.app.closeModal(document.getElementById('recommendation-modal'));
                
                // Clear cache for recommendations
                window.app.cache.clear();
                
                // Reload recommended content
                const container = document.getElementById('recommended-content');
                container.innerHTML = window.app.renderLoadingGrid(8);
                const content = await window.app.loadPersonalizedRecommendations();
                window.app.renderContentGrid(content, 'recommended-content');
                
                window.app.showToast('Recommendations refreshed!', 'success');
            };
        }
    </script>

    <style>
        .welcome-section {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: var(--spacing-xl) 0;
            margin-bottom: var(--spacing-xl);
        }

        .welcome-banner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .welcome-title {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            color: var(--text-muted);
            margin-bottom: var(--spacing-lg);
        }

        .welcome-stats {
            display: flex;
            gap: var(--spacing-xl);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--accent-blue);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .welcome-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .quick-actions-section {
            margin-bottom: var(--spacing-xl);
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            min-width: 120px;
        }

        .quick-action-btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-blue);
        }

        .quick-action-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .quick-action-text {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .content-horizontal-scroll {
            overflow-x: auto;
            padding-bottom: var(--spacing-sm);
        }

        .content-horizontal-container {
            display: flex;
            gap: var(--spacing-lg);
            min-width: min-content;
        }

        .horizontal-content-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            cursor: pointer;
            transition: transform var(--transition-normal);
        }

        .horizontal-content-item:hover {
            transform: scale(1.05);
        }

        .horizontal-poster {
            width: 150px;
            height: 225px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }

        .horizontal-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-indicator {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .progress-text {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .recommendation-tuning {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .empty-horizontal {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            text-align: center;
            color: var(--text-muted);
            min-height: 200px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        @media (max-width: 768px) {
            .welcome-banner {
                flex-direction: column;
                text-align: center;
            }

            .welcome-stats {
                justify-content: center;
                flex-wrap: wrap;
                gap: var(--spacing-lg);
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                display: grid;
            }

            .quick-action-btn {
                min-width: auto;
            }

            .horizontal-poster {
                width: 120px;
                height: 180px;
            }

            .horizontal-content-item {
                min-width: 120px;
            }
        }
    </style>
</body>
</html>