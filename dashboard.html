<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineStream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --netflix-red: #e50914;
            --netflix-black: #141414;
            --netflix-dark-gray: #222222;
            --netflix-gray: #333333;
            --netflix-light-gray: #555555;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--netflix-black);
            color: white;
            overflow-x: hidden;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--netflix-black);
            padding: 15px 20px;
            z-index: 1000;
            border-bottom: 1px solid var(--netflix-gray);
        }

        .welcome-banner {
            background: linear-gradient(135deg, var(--netflix-red), #f40612);
            padding: 40px 20px;
            margin-top: 70px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .content-carousel {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 20px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .content-carousel::-webkit-scrollbar {
            display: none;
        }

        .movie-card {
            min-width: 200px;
            height: 300px;
            background: var(--netflix-gray);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .movie-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .movie-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .movie-card:hover .movie-card-overlay {
            transform: translateY(0);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .continue-watching-card {
            background: var(--netflix-dark-gray);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            height: 200px;
        }

        .continue-watching-card:hover {
            transform: scale(1.02);
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background-color: var(--netflix-red);
            transition: width 0.3s ease;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--netflix-dark-gray);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--netflix-gray);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--netflix-red);
        }

        .preference-tuner {
            background: var(--netflix-dark-gray);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .genre-chip {
            display: inline-block;
            background-color: var(--netflix-gray);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .genre-chip.selected {
            background-color: var(--netflix-red);
            border-color: #f40612;
        }

        .genre-chip:hover {
            background-color: var(--netflix-light-gray);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            height: 100vh;
            background-color: var(--netflix-dark-gray);
            z-index: 2000;
            transition: left 0.3s ease;
            padding: 20px;
        }

        .mobile-menu.active {
            left: 0;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 10px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
            transition: 0.3s;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

                @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .rating-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--netflix-red);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .watchlist-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watchlist-button:hover {
            background-color: var(--netflix-red);
        }

        .watchlist-button.added {
            background-color: var(--netflix-red);
        }

        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }

            .desktop-nav {
                display: none;
            }

            .movie-card {
                min-width: 150px;
                height: 225px;
            }

            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .welcome-banner {
                padding: 30px 15px;
            }
        }

        @media (max-width: 480px) {
            .movie-card {
                min-width: 120px;
                height: 180px;
            }

            .content-carousel {
                gap: 8px;
            }

            .quick-stats {
                grid-template-columns: 1fr;
            }
        }

        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <div class="flex items-center space-x-8">
                <h1 class="text-2xl font-bold text-red-600">CineStream</h1>
                <div class="desktop-nav hidden md:flex space-x-6">
                    <a href="dashboard.html" class="text-red-500 font-semibold">Dashboard</a>
                    <a href="#" class="hover:text-gray-300 transition-colors">Browse</a>
                    <a href="#" class="hover:text-gray-300 transition-colors">My List</a>
                    <a href="profile.html" class="hover:text-gray-300 transition-colors">Profile</a>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="hidden md:block text-gray-300">Welcome, <span id="usernameDisplay"></span></span>
                <button onclick="logout()" class="text-gray-300 hover:text-white transition-colors">
                    Sign Out
                </button>
                <div class="hamburger md:hidden" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold">Menu</h2>
            <button onclick="toggleMobileMenu()" class="text-2xl">&times;</button>
        </div>
        <div class="space-y-4">
            <a href="dashboard.html" class="block py-3 text-lg text-red-500 font-semibold">Dashboard</a>
            <a href="#" class="block py-3 text-lg hover:text-red-500 transition-colors">Browse</a>
            <a href="#" class="block py-3 text-lg hover:text-red-500 transition-colors">My List</a>
            <a href="profile.html" class="block py-3 text-lg hover:text-red-500 transition-colors">Profile</a>
            <hr class="border-gray-600 my-4">
            <button onclick="logout()" class="text-left py-3 text-lg hover:text-red-500 transition-colors">
                Sign Out
            </button>
        </div>
    </div>

    <!-- Welcome Banner -->
    <section class="welcome-banner">
        <div class="max-w-7xl mx-auto relative z-10">
            <h1 class="text-3xl md:text-4xl font-bold mb-4">
                Welcome back, <span id="welcomeUsername"></span>! 🎬
            </h1>
            <p class="text-lg opacity-90 mb-6">
                Ready to discover your next favorite movie or show?
            </p>
            
            <!-- Quick Stats -->
            <div class="quick-stats" id="quickStats">
                <div class="stat-card">
                    <div class="stat-number" id="watchedCount">0</div>
                    <div class="text-gray-300">Movies Watched</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="wishlistCount">0</div>
                    <div class="text-gray-300">In Watchlist</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="favoritesCount">0</div>
                    <div class="text-gray-300">Favorites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="hoursWatched">0</div>
                    <div class="text-gray-300">Hours Watched</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-400">Loading your personalized recommendations...</p>
        </div>

        <!-- Content Container -->
        <div id="contentContainer" style="display: none;">
            <!-- Continue Watching -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    ▶️ Continue Watching
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="continueWatching">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Recommended For You -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    🎯 Recommended For You
                </h2>
                <div class="content-carousel" id="recommendedForYou">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Based on Recent Activity -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    📈 Based on Your Recent Activity
                </h2>
                <div class="content-carousel" id="recentActivity">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Genre Preferences -->
            <section class="mb-12 fade-in">
                <div class="preference-tuner">
                    <h3 class="text-xl font-bold mb-4">🎭 Tune Your Preferences</h3>
                    <p class="text-gray-300 mb-4">Select genres you love to get better recommendations:</p>
                    <div id="genrePreferences">
                        <!-- Dynamic genre chips -->
                    </div>
                    <button onclick="updatePreferences()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 transition-colors">
                        Update Preferences
                    </button>
                </div>
            </section>

            <!-- Genre-based Recommendations -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    🎪 Your Favorite Genres
                </h2>
                <div class="content-carousel" id="genreRecommendations">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Similar to What You Liked -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    💝 Similar to What You Liked
                </h2>
                <div class="content-carousel" id="similarContent">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Watchlist Quick Access -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    📋 Your Watchlist
                </h2>
                <div class="content-carousel" id="watchlistContent">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Recently Added -->
            <section class="mb-12 fade-in">
                <h2 class="section-title">
                    🆕 Recently Added
                </h2>
                <div class="content-carousel" id="recentlyAdded">
                    <!-- Dynamic content -->
                </div>
            </section>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;" class="text-center py-20">
            <div class="text-6xl mb-4">😞</div>
            <h3 class="text-xl font-semibold mb-2">Oops! Something went wrong</h3>
            <p class="text-gray-400 mb-6">We're having trouble loading your dashboard. Please try again.</p>
            <button class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 transition-colors" onclick="loadDashboard()">
                Try Again
            </button>
        </div>
    </main>

    <script>
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        
        // Global variables
        let userPreferences = [];
        let watchlistItems = new Set();
        let isLoading = false;

        // Available genres
        const GENRES = [
            'Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Documentary',
            'Drama', 'Family', 'Fantasy', 'History', 'Horror', 'Music',
            'Mystery', 'Romance', 'Science Fiction', 'Thriller', 'War', 'Western'
        ];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            initializeUser();
            loadDashboard();
            initializeTouchGestures();
        });

        // Check if user is authenticated
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                window.location.href = 'login.html';
                return;
            }
            
            // Display username
            document.getElementById('usernameDisplay').textContent = username;
            document.getElementById('welcomeUsername').textContent = username;
        }

        // Initialize user data
        function initializeUser() {
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('usernameDisplay').textContent = username;
                document.getElementById('welcomeUsername').textContent = username;
            }
        }

        // Load dashboard content
        async function loadDashboard() {
            if (isLoading) return;
            isLoading = true;

            const loadingState = document.getElementById('loadingState');
            const contentContainer = document.getElementById('contentContainer');
            const errorState = document.getElementById('errorState');

            // Show loading state
            loadingState.style.display = 'block';
            contentContainer.style.display = 'none';
            errorState.style.display = 'none';

            try {
                const token = localStorage.getItem('authToken');
                
                // Load personalized recommendations
                const response = await fetch(`${API_BASE}/recommendations/personalized`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Populate sections
                populateRecommendations(data);
                
                // Load user stats
                await loadUserStats();
                
                // Initialize genre preferences
                initializeGenrePreferences();

                // Show content
                loadingState.style.display = 'none';
                contentContainer.style.display = 'block';

                // Initialize touch gestures
                setTimeout(() => {
                    initializeTouchGestures();
                }, 100);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                
                // Show error state
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
            } finally {
                isLoading = false;
            }
        }

        // Populate recommendations
        function populateRecommendations(data) {
            // Continue watching (simulated)
            populateContinueWatching();
            
            // Recommended for you
            populateCarousel('recommendedForYou', data.hybrid_recommendations || []);
            
            // Based on recent activity
            populateCarousel('recentActivity', data.watch_history_based || []);
            
            // Genre-based recommendations
            populateCarousel('genreRecommendations', data.favorites_based || []);
            
            // Similar content
            populateCarousel('similarContent', data.wishlist_influenced || []);
            
            // Recently added (use regional suggestions as placeholder)
            populateCarousel('recentlyAdded', data.regional_suggestions || []);
            
            // Load watchlist
            loadWatchlist();
        }

        // Populate continue watching section
        function populateContinueWatching() {
            const container = document.getElementById('continueWatching');
            container.innerHTML = '<p class="text-gray-400 text-center py-8">No recently watched content. Start watching to see your progress here!</p>';
        }

        // Populate carousel with content
        function populateCarousel(carouselId, items) {
            const carousel = document.getElementById(carouselId);
            if (!carousel) return;

            if (!items || items.length === 0) {
                carousel.innerHTML = '<p class="text-gray-400 text-center py-8">No content available at the moment.</p>';
                return;
            }

            carousel.innerHTML = items.map(item => createMovieCard(item)).join('');
        }

        // Create movie card HTML
        function createMovieCard(item) {
            const title = item.title || item.name || 'Unknown Title';
            const posterPath = item.poster_path || item.poster_url;
            const rating = item.rating || item.vote_average;
            const releaseDate = item.release_date || item.first_air_date;
            const overview = item.overview || '';
            const genres = item.genre_names || item.genres || [];
            const contentId = item.id || item.tmdb_id;

            // Handle poster URL
            let posterUrl = '';
            if (posterPath) {
                if (posterPath.startsWith('http')) {
                    posterUrl = posterPath;
                } else if (posterPath.startsWith('/')) {
                    posterUrl = `https://image.tmdb.org/t/p/w500${posterPath}`;
                }
            }

            const isInWatchlist = watchlistItems.has(contentId);

            return `
                <div class="movie-card" onclick="viewContent(${contentId}, '${item.content_type || 'movie'}')">
                    ${posterUrl ? `<img src="${posterUrl}" alt="${title}" loading="lazy">` : 
                      `<div class="w-full h-full bg-gray-700 flex items-center justify-center">
                         <span class="text-gray-400 text-center p-4">${title}</span>
                       </div>`}
                    
                    <button class="watchlist-button ${isInWatchlist ? 'added' : ''}" 
                            onclick="event.stopPropagation(); toggleWatchlist(${contentId}, '${title}')"
                            title="${isInWatchlist ? 'Remove from watchlist' : 'Add to watchlist'}">
                        ${isInWatchlist ? '✓' : '+'}
                    </button>
                    
                    ${rating ? `<div class="rating-badge">${rating.toFixed(1)}</div>` : ''}
                    
                    <div class="movie-card-overlay">
                        <h3 class="font-bold text-sm mb-2 line-clamp-2">${title}</h3>
                        
                        ${releaseDate ? `<p class="text-xs text-gray-300 mb-2">${new Date(releaseDate).getFullYear()}</p>` : ''}
                        
                        ${genres.length > 0 ? `
                            <div class="mb-2">
                                ${genres.slice(0, 2).map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${overview ? `<p class="text-xs text-gray-300 line-clamp-3">${overview}</p>` : ''}
                        
                        <div class="flex justify-between items-center mt-3">
                            <button class="bg-white text-black px-3 py-1 rounded text-xs font-bold hover:bg-gray-200 transition-colors"
                                    onclick="event.stopPropagation(); viewContent(${contentId}, '${item.content_type || 'movie'}')">
                                ▶ View
                            </button>
                            <button class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-500 transition-colors"
                                    onclick="event.stopPropagation(); rateContent(${contentId}, '${title}')">
                                ⭐ Rate
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                const token = localStorage.getItem('authToken');
                
                // For now, show simulated stats
                document.getElementById('watchedCount').textContent = '0';
                document.getElementById('wishlistCount').textContent = watchlistItems.size;
                document.getElementById('favoritesCount').textContent = '0';
                document.getElementById('hoursWatched').textContent = '0';
                
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Initialize genre preferences
        function initializeGenrePreferences() {
            const container = document.getElementById('genrePreferences');
            
            container.innerHTML = GENRES.map(genre => `
                <span class="genre-chip" onclick="toggleGenre('${genre}')" data-genre="${genre}">
                    ${genre}
                </span>
            `).join('');
        }

        // Toggle genre preference
        function toggleGenre(genre) {
            const chip = document.querySelector(`[data-genre="${genre}"]`);
            
            if (userPreferences.includes(genre)) {
                userPreferences = userPreferences.filter(g => g !== genre);
                chip.classList.remove('selected');
            } else {
                userPreferences.push(genre);
                chip.classList.add('selected');
            }
        }

        // Update user preferences
        async function updatePreferences() {
            try {
                const token = localStorage.getItem('authToken');
                
                // Here you would typically send preferences to backend
                showToast('Preferences updated successfully!', 'success');
                
                // Reload recommendations based on new preferences
                setTimeout(() => {
                    loadDashboard();
                }, 1000);
                
            } catch (error) {
                console.error('Error updating preferences:', error);
                showToast('Failed to update preferences', 'error');
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            try {
                const token = localStorage.getItem('authToken');
                
                // For now, show empty watchlist message
                const container = document.getElementById('watchlistContent');
                container.innerHTML = '<p class="text-gray-400 text-center py-8">Your watchlist is empty. Add some movies and shows to get started!</p>';
                
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        // Toggle watchlist
        async function toggleWatchlist(contentId, title) {
            try {
                const token = localStorage.getItem('authToken');
                
                const response = await fetch(`${API_BASE}/interact`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: 'wishlist'
                    })
                });

                if (response.ok) {
                    if (watchlistItems.has(contentId)) {
                        watchlistItems.delete(contentId);
                        showToast(`Removed "${title}" from watchlist`, 'success');
                    } else {
                        watchlistItems.add(contentId);
                        showToast(`Added "${title}" to watchlist`, 'success');
                    }
                    
                    // Update UI
                    updateWatchlistButtons();
                    loadUserStats();
                } else {
                    throw new Error('Failed to update watchlist');
                }
                
            } catch (error) {
                console.error('Error toggling watchlist:', error);
                showToast('Failed to update watchlist', 'error');
            }
        }

        // Update watchlist buttons
        function updateWatchlistButtons() {
            document.querySelectorAll('.watchlist-button').forEach(button => {
                const card = button.closest('.movie-card');
                const onclick = card.getAttribute('onclick');
                const contentId = onclick.match(/viewContent\((\d+)/)?.[1];
                
                if (contentId && watchlistItems.has(parseInt(contentId))) {
                    button.classList.add('added');
                    button.textContent = '✓';
                    button.title = 'Remove from watchlist';
                } else {
                    button.classList.remove('added');
                    button.textContent = '+';
                    button.title = 'Add to watchlist';
                }
            });
        }

        // Rate content
        async function rateContent(contentId, title) {
            const rating = prompt(`Rate "${title}" (1-10):`);
            
            if (rating && !isNaN(rating) && rating >= 1 && rating <= 10) {
                try {
                    const token = localStorage.getItem('authToken');
                    
                    const response = await fetch(`${API_BASE}/interact`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content_id: contentId,
                            interaction_type: 'rating',
                            rating: parseInt(rating)
                        })
                    });

                    if (response.ok) {
                        showToast(`Rated "${title}" ${rating}/10`, 'success');
                    } else {
                        throw new Error('Failed to submit rating');
                    }
                    
                } catch (error) {
                    console.error('Error rating content:', error);
                    showToast('Failed to submit rating', 'error');
                }
            }
        }

        // View content details
        function viewContent(contentId, contentType = 'movie') {
            sessionStorage.setItem('selectedContent', JSON.stringify({
                id: contentId,
                type: contentType
            }));
            
            window.location.href = 'movie-detail.html';
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            
            mobileMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            
            document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
        }

        // Touch gestures for carousels
        function initializeTouchGestures() {
            const carousels = document.querySelectorAll('.content-carousel');
            
            carousels.forEach(carousel => {
                let isDown = false;
                let startX;
                let scrollLeft;

                carousel.addEventListener('mousedown', (e) => {
                    isDown = true;
                    carousel.style.cursor = 'grabbing';
                    startX = e.pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                });

                carousel.addEventListener('mouseleave', () => {
                    isDown = false;
                    carousel.style.cursor = 'grab';
                });

                carousel.addEventListener('mouseup', () => {
                    isDown = false;
                    carousel.style.cursor = 'grab';
                });

                carousel.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - carousel.offsetLeft;
                    const walk = (x - startX) * 2;
                    carousel.scrollLeft = scrollLeft - walk;
                });

                // Touch events
                let touchStartX = 0;
                
                carousel.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    startX = touchStartX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                });

                carousel.addEventListener('touchmove', (e) => {
                    if (!touchStartX) return;
                    const x = e.touches[0].clientX - carousel.offsetLeft;
                    const walk = (x - startX) * 1.5;
                    carousel.scrollLeft = scrollLeft - walk;
                });

                carousel.addEventListener('touchend', () => {
                    touchStartX = 0;
                });
            });
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                window.location.href = 'index.html';
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white z-50 transform translate-y-full transition-transform duration-300`;
            
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-600');
                    break;
                case 'error':
                    toast.classList.add('bg-red-600');
                    break;
                default:
                    toast.classList.add('bg-blue-600');
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const mobileMenu = document.getElementById('mobileMenu');
                if (mobileMenu.classList.contains('active')) {
                    toggleMobileMenu();
                }
            }
        });

        // Add CSS utility classes
        const style = document.createElement('style');
        style.textContent = `
            .genre-tag {
                background-color: rgba(255,255,255,0.2);
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.75rem;
                margin: 2px;
                display: inline-block;
            }
            
            .content-carousel {
                cursor: grab;
            }
            
            .content-carousel:active {
                cursor: grabbing;
            }
            
            .movie-card {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }
            
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 1500;
            }
            
            .mobile-overlay.active {
                display: block;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>