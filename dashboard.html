<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CineScope</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 64px);
            margin-top: 64px;
        }

        .dashboard-main {
            flex: 1;
            padding: var(--spacing-xl);
        }

        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border-radius: 1rem;
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            color: white;
        }

        .welcome-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .welcome-text h1 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: 2rem;
        }

        .welcome-text p {
            margin: 0;
            opacity: 0.9;
        }

        .quick-stats {
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-md);
            border-radius: 0.5rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .continue-watching {
            margin-bottom: var(--spacing-xl);
        }

        .continue-item {
            display: flex;
            background: var(--card-bg);
            border-radius: 0.5rem;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid var(--border-color);
        }

        .continue-item:hover {
            background: var(--border-color);
            transform: translateY(-1px);
        }

        .continue-poster {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 0.375rem;
            margin-right: var(--spacing-md);
        }

        .continue-info {
            flex: 1;
        }

        .continue-title {
            font-weight: 600;
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--text-primary);
        }

        .continue-progress {
            background: var(--dark-bg);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .continue-progress-bar {
            height: 100%;
            background: var(--accent-blue);
            transition: width var(--transition-normal);
        }

        .continue-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .dashboard-section {
            margin-bottom: var(--spacing-2xl);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .section-title {
            font-size: 1.5rem;
            margin: 0;
            color: var(--text-primary);
        }

        .view-all-btn {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--transition-fast);
        }

        .view-all-btn:hover {
            color: var(--light-blue);
        }

        .preference-tuning {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .preference-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }

        .preference-category {
            background: var(--dark-bg);
            padding: var(--spacing-md);
            border-radius: 0.5rem;
        }

        .preference-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .preference-tag {
            background: var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 1rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .preference-tag.active {
            background: var(--accent-blue);
            color: white;
        }

        .preference-tag:hover {
            background: var(--accent-blue);
            color: white;
        }
    </style>
</head>

<body>
    <div data-include="header"></div>

    <div class="dashboard-container">
        <div data-include="sidebar"></div>

        <main class="dashboard-main">
            <div class="welcome-banner">
                <div class="welcome-content">
                    <div class="welcome-text">
                        <h1>Welcome back, <span class="user-name">User</span>!</h1>
                        <p>Ready to discover your next favorite content?</p>
                    </div>
                    <div class="quick-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="watchlist-count">0</span>
                            <span class="stat-label">Watchlist</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="favorites-count">0</span>
                            <span class="stat-label">Favorites</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="watched-count">0</span>
                            <span class="stat-label">Watched</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Continue Watching Section -->
            <div class="dashboard-section continue-watching" id="continue-watching-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Continue Watching</h2>
                </div>
                <div class="continue-watching-list" id="continue-watching-list">
                    <!-- Continue watching items will be loaded here -->
                </div>
            </div>

            <!-- Personalized Recommendations -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Recommended for You</h2>
                    <a href="/recommendations" class="view-all-btn">View All</a>
                </div>
                <div class="carousel-track" id="personalized-recommendations">
                    <!-- Personalized recommendations will be loaded here -->
                </div>
            </div>

            <!-- Based on Recent Activity -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Based on Your Recent Activity</h2>
                </div>
                <div class="carousel-track" id="activity-based-recommendations">
                    <!-- Activity-based recommendations will be loaded here -->
                </div>
            </div>

            <!-- Preference Tuning -->
            <div class="preference-tuning">
                <h3>Fine-tune Your Preferences</h3>
                <p>Help us recommend better content by updating your preferences</p>
                <div class="preference-grid">
                    <div class="preference-category">
                        <h4>Genres</h4>
                        <div class="preference-tags" id="genre-preferences">
                            <!-- Genre preferences will be loaded here -->
                        </div>
                    </div>
                    <div class="preference-category">
                        <h4>Languages</h4>
                        <div class="preference-tags" id="language-preferences">
                            <!-- Language preferences will be loaded here -->
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="app.updatePreferences()"
                    style="margin-top: var(--spacing-lg);">
                    Update Preferences
                </button>
            </div>

            <!-- Similar to What You Liked -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Similar to What You Liked</h2>
                </div>
                <div class="carousel-track" id="similar-recommendations">
                    <!-- Similar recommendations will be loaded here -->
                </div>
            </div>

            <!-- Recently Added -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Recently Added in Your Preferred Genres</h2>
                </div>
                <div class="carousel-track" id="recently-added">
                    <!-- Recently added content will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <div data-include="footer"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>

    <script>
        // Dashboard specific functionality
        class Dashboard {
            constructor() {
                this.preferredGenres = [];
                this.preferredLanguages = [];
                this.init();
            }

            async init() {
                await this.loadUserStats();
                await this.loadDashboardContent();
                this.setupPreferenceTuning();
            }

            async loadUserStats() {
                try {
                    const [watchlist, favorites] = await Promise.all([
                        app.apiCall('/user/watchlist'),
                        app.apiCall('/user/favorites')
                    ]);

                    document.getElementById('watchlist-count').textContent = watchlist?.watchlist?.length || 0;
                    document.getElementById('favorites-count').textContent = favorites?.favorites?.length || 0;

                    // Update user name
                    if (app.user) {
                        document.querySelector('.user-name').textContent = app.user.username;
                    }
                } catch (error) {
                    console.error('Failed to load user stats:', error);
                }
            }

            async loadDashboardContent() {
                try {
                    app.showLoading('Loading your personalized dashboard...');

                    const [personalized, activityBased, similar, recentlyAdded] = await Promise.all([
                        app.apiCall('/recommendations/personalized?limit=20'),
                        app.apiCall('/recommendations/trending?limit=20'),
                        app.apiCall('/recommendations/popular?limit=20'),
                        app.apiCall('/recommendations/new-releases?limit=20')
                    ]);

                    this.renderCarousel('personalized-recommendations', personalized?.recommendations || []);
                    this.renderCarousel('activity-based-recommendations', activityBased?.recommendations || []);
                    this.renderCarousel('similar-recommendations', similar?.recommendations || []);
                    this.renderCarousel('recently-added', recentlyAdded?.recommendations || []);

                } catch (error) {
                    console.error('Failed to load dashboard content:', error);
                    app.showNotification('Failed to load dashboard content', 'error');
                } finally {
                    app.hideLoading();
                }
            }

            renderCarousel(containerId, content) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = content.map(item => app.createMovieCard(item)).join('');
                app.setupLazyLoading(container);
            }

            setupPreferenceTuning() {
                const genres = ['Action', 'Comedy', 'Drama', 'Horror', 'Romance', 'Sci-Fi', 'Thriller', 'Animation'];
                const languages = ['English', 'Hindi', 'Telugu', 'Tamil', 'Kannada', 'Malayalam'];

                this.renderPreferenceTags('genre-preferences', genres, this.preferredGenres);
                this.renderPreferenceTags('language-preferences', languages, this.preferredLanguages);
            }

            renderPreferenceTags(containerId, options, selected) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = options.map(option => `
                    <span class="preference-tag ${selected.includes(option) ? 'active' : ''}" 
                          onclick="dashboard.togglePreference('${containerId}', '${option}')">
                        ${option}
                    </span>
                `).join('');
            }

            togglePreference(containerId, option) {
                const tag = document.querySelector(`#${containerId} .preference-tag[onclick*="${option}"]`);
                if (!tag) return;

                tag.classList.toggle('active');

                if (containerId === 'genre-preferences') {
                    if (this.preferredGenres.includes(option)) {
                        this.preferredGenres = this.preferredGenres.filter(g => g !== option);
                    } else {
                        this.preferredGenres.push(option);
                    }
                } else if (containerId === 'language-preferences') {
                    if (this.preferredLanguages.includes(option)) {
                        this.preferredLanguages = this.preferredLanguages.filter(l => l !== option);
                    } else {
                        this.preferredLanguages.push(option);
                    }
                }
            }

            async updatePreferences() {
                try {
                    app.showLoading('Updating preferences...');

                    // This would typically update user preferences via API
                    // For now, we'll just show a success message and reload recommendations

                    app.showNotification('Preferences updated successfully!', 'success');
                    await this.loadDashboardContent();

                } catch (error) {
                    console.error('Failed to update preferences:', error);
                    app.showNotification('Failed to update preferences', 'error');
                } finally {
                    app.hideLoading();
                }
            }
        }

        // Initialize dashboard when DOM is loaded
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            if (app.token) {
                dashboard = new Dashboard();

                // Add updatePreferences to app for global access
                app.updatePreferences = () => dashboard.updatePreferences();
            } else {
                window.location.href = '/login';
            }
        });
    </script>
</body>

</html>