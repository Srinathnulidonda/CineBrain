<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - MovieRec</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-primary text-white">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-primary/95 backdrop-blur-sm border-b border-border-color">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-2xl font-bold text-accent-red">MovieRec</a>
                    <button onclick="history.back()" class="btn-ghost">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back
                    </button>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="auth-buttons">
                        <button id="loginBtn" class="btn-secondary mr-2">Login</button>
                        <button id="signupBtn" class="btn-primary">Sign Up</button>
                    </div>
                    
                    <div id="userMenu" class="user-menu hidden">
                        <button id="userMenuToggle" class="flex items-center space-x-2 p-2 hover:bg-secondary-bg rounded-lg">
                            <div class="user-avatar"></div>
                            <span id="userName"></span>
                        </button>
                        <div id="userDropdown" class="user-dropdown hidden">
                            <a href="dashboard.html" class="dropdown-item">Dashboard</a>
                            <a href="profile.html" class="dropdown-item">Profile</a>
                            <button id="logoutBtn" class="dropdown-item w-full text-left">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20">
        <!-- Loading State -->
        <div id="loadingSpinner" class="loading-spinner min-h-screen">
            <div class="spinner"></div>
            <p>Loading movie details...</p>
        </div>

        <!-- Movie Details -->
        <div id="movieContent" class="hidden">
            <!-- Hero Section -->
            <section id="heroSection" class="relative min-h-[70vh] flex items-end">
                <div class="hero-overlay absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                <div class="container mx-auto px-4 py-12 relative z-10">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-end">
                        <div class="lg:col-span-1">
                            <img id="moviePoster" src="" alt="" class="w-full max-w-sm mx-auto lg:mx-0 rounded-lg shadow-xl">
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div>
                                <h1 id="movieTitle" class="text-4xl md:text-6xl font-bold mb-4"></h1>
                                <p id="movieOriginalTitle" class="text-xl text-text-secondary mb-4 hidden"></p>
                                <div class="flex flex-wrap items-center gap-4 mb-4">
                                    <div id="movieRating" class="flex items-center space-x-2">
                                        <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                        <span id="ratingValue" class="text-lg font-semibold"></span>
                                    </div>
                                    <span id="movieYear" class="text-lg"></span>
                                    <span id="movieRuntime" class="text-lg"></span>
                                </div>
                                <div id="movieGenres" class="flex flex-wrap gap-2 mb-6">
                                    <!-- Dynamic genre tags -->
                                </div>
                            </div>
                            
                            <p id="movieOverview" class="text-lg leading-relaxed max-w-3xl"></p>
                            
                            <!-- Action Buttons -->
                            <div id="actionButtons" class="flex flex-wrap gap-4">
                                <button id="favoriteBtn" class="btn-primary">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                    Add to Favorites
                                </button>
                                <button id="wishlistBtn" class="btn-secondary">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                    </svg>
                                    Wishlist
                                </button>
                                <button id="shareBtn" class="btn-ghost">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                                    </svg>
                                    Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Content Sections -->
            <div class="container mx-auto px-4 py-12 space-y-12">
                <!-- User Rating Section -->
                <section id="userRatingSection" class="bg-secondary-bg rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Rate This Movie</h3>
                    <div class="flex items-center space-x-4">
                        <div class="rating-stars" id="userRating">
                            <button class="rating-star" data-rating="1">★</button>
                            <button class="rating-star" data-rating="2">★</button>
                            <button class="rating-star" data-rating="3">★</button>
                            <button class="rating-star" data-rating="4">★</button>
                            <button class="rating-star" data-rating="5">★</button>
                        </div>
                        <span id="ratingText" class="text-text-secondary">Click to rate</span>
                    </div>
                </section>

                <!-- Videos Section -->
                <section id="videosSection" class="hidden">
                    <h3 class="text-2xl font-bold mb-6">Videos & Trailers</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="videosGrid">
                        <!-- Dynamic video content -->
                    </div>
                </section>

                <!-- Cast & Crew -->
                <section id="castSection" class="hidden">
                    <h3 class="text-2xl font-bold mb-6">Cast & Crew</h3>
                    <div class="content-carousel" id="castCarousel">
                        <!-- Dynamic cast content -->
                    </div>
                </section>

                <!-- User Reviews -->
                <section id="reviewsSection">
                    <h3 class="text-2xl font-bold mb-6">User Reviews</h3>
                    <div id="reviewsContainer" class="space-y-4">
                        <!-- Dynamic reviews -->
                    </div>
                </section>

                <!-- Similar Movies -->
                <section id="similarSection">
                    <h3 class="text-2xl font-bold mb-6">Similar Movies</h3>
                    <div class="content-carousel" id="similarCarousel">
                        <!-- Dynamic similar content -->
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/components.js"></script>
    <script>
        class MovieDetailPage {
            constructor() {
                this.movieId = null;
                this.movieData = null;
                this.userRating = 0;
                this.init();
            }

            init() {
                this.movieId = Utils.getUrlParameter('id');
                if (!this.movieId) {
                    window.location.href = 'index.html';
                    return;
                }

                this.initEventListeners();
                this.loadMovieDetails();
            }

            initEventListeners() {
                // Auth buttons
                const loginBtn = document.getElementById('loginBtn');
                const signupBtn = document.getElementById('signupBtn');
                const logoutBtn = document.getElementById('logoutBtn');

                if (loginBtn) loginBtn.addEventListener('click', () => window.location.href = 'login.html');
                if (signupBtn) signupBtn.addEventListener('click', () => window.location.href = 'login.html');
                if (logoutBtn) logoutBtn.addEventListener('click', () => authManager.logout());

                // User menu
                const userMenuToggle = document.getElementById('userMenuToggle');
                const userDropdown = document.getElementById('userDropdown');

                if (userMenuToggle && userDropdown) {
                    userMenuToggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userDropdown.classList.toggle('hidden');
                    });

                    document.addEventListener('click', () => {
                        userDropdown.classList.add('hidden');
                    });
                }

                // Action buttons
                document.getElementById('favoriteBtn')?.addEventListener('click', () => {
                    this.handleInteraction('favorite');
                });

                document.getElementById('wishlistBtn')?.addEventListener('click', () => {
                    this.handleInteraction('wishlist');
                });

                document.getElementById('shareBtn')?.addEventListener('click', () => {
                    this.shareMovie();
                });

                // Rating system
                this.initRatingSystem();
            }

            initRatingSystem() {
                const ratingStars = document.querySelectorAll('.rating-star');
                const ratingText = document.getElementById('ratingText');

                ratingStars.forEach(star => {
                    star.addEventListener('click', async () => {
                        if (!authManager.isLoggedIn) {
                            UIComponents.showToast('Please login to rate movies', 'warning');
                            return;
                        }

                        const rating = parseInt(star.getAttribute('data-rating'));
                        this.userRating = rating;
                        
                        // Update visual state
                        ratingStars.forEach((s, index) => {
                            if (index < rating) {
                                s.classList.add('filled');
                                s.classList.remove('empty');
                            } else {
                                s.classList.remove('filled');
                                s.classList.add('empty');
                            }
                        });

                        ratingText.textContent = `You rated: ${rating}/5`;

                        // Submit rating
                        try {
                            await apiService.recordInteraction({
                                content_id: this.movieId,
                                interaction_type: 'view',
                                rating: rating
                            });
                            UIComponents.showToast('Rating saved!', 'success');
                        } catch (error) {
                            console.error('Failed to save rating:', error);
                            UIComponents.showToast('Failed to save rating', 'error');
                        }
                    });

                    star.addEventListener('mouseover', () => {
                        const rating = parseInt(star.getAttribute('data-rating'));
                        ratingStars.forEach((s, index) => {
                            if (index < rating) {
                                s.style.color = '#fbbf24';
                            } else {
                                s.style.color = '';
                            }
                        });
                    });
                });

                document.getElementById('userRating')?.addEventListener('mouseleave', () => {
                    ratingStars.forEach((s, index) => {
                        if (index < this.userRating) {
                            s.style.color = '#fbbf24';
                        } else {
                            s.style.color = '';
                        }
                    });
                });
            }

            async loadMovieDetails() {
                try {
                    showLoader(true, 'Loading movie details...');
                    
                    const details = await apiService.getContentDetails(this.movieId);
                    this.movieData = details;
                    
                    this.renderMovieDetails();
                    
                    // Record view interaction
                    if (authManager.isLoggedIn) {
                        apiService.recordInteraction({
                            content_id: this.movieId,
                            interaction_type: 'view'
                        }).catch(console.error);
                    }
                    
                    showLoader(false);
                    document.getElementById('loadingSpinner').classList.add('hidden');
                    document.getElementById('movieContent').classList.remove('hidden');
                    
                } catch (error) {
                    showLoader(false);
                    console.error('Failed to load movie details:', error);
                    
                    document.getElementById('loadingSpinner').innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-white mb-2">Movie not found</h3>
                            <p class="text-text-secondary mb-4">The movie you're looking for doesn't exist or has been removed.</p>
                            <button onclick="window.location.href='index.html'" class="btn-primary">Go Back Home</button>
                        </div>
                    `;
                }
            }

            renderMovieDetails() {
                if (!this.movieData) return;

                const { content, youtube_videos, similar_content, user_reviews } = this.movieData;

                // Update page title
                document.title = `${content.title} - MovieRec`;

                // Basic movie info
                document.getElementById('movieTitle').textContent = content.title;
                document.getElementById('moviePoster').src = content.poster_path || '/assets/images/placeholder-poster.jpg';
                document.getElementById('moviePoster').alt = content.title;

                if (content.original_title !== content.title) {
                    document.getElementById('movieOriginalTitle').textContent = content.original_title;
                    document.getElementById('movieOriginalTitle').classList.remove('hidden');
                }

                // Rating
                if (content.rating) {
                    document.getElementById('ratingValue').textContent = content.rating.toFixed(1);
                } else {
                    document.getElementById('movieRating').style.display = 'none';
                }

                // Year and runtime
                if (content.release_date) {
                    document.getElementById('movieYear').textContent = new Date(content.release_date).getFullYear();
                }

                if (content.runtime) {
                    document.getElementById('movieRuntime').textContent = Utils.formatDuration(content.runtime);
                }

                // Genres
                if (content.genre_names && content.genre_names.length > 0) {
                    const genresContainer = document.getElementById('movieGenres');
                    genresContainer.innerHTML = content.genre_names.map(genre => 
                        `<span class="genre-tag">${genre}</span>`
                    ).join('');
                }

                // Overview
                if (content.overview) {
                    document.getElementById('movieOverview').textContent = content.overview;
                }

                // Set backdrop
                if (content.backdrop_path) {
                    const heroSection = document.getElementById('heroSection');
                    heroSection.style.backgroundImage = `url(${content.backdrop_path})`;
                    heroSection.style.backgroundSize = 'cover';
                    heroSection.style.backgroundPosition = 'center';
                }

                // Show action buttons only for logged-in users
                if (authManager.isLoggedIn) {
                    document.getElementById('actionButtons').classList.remove('hidden');
                    document.getElementById('userRatingSection').classList.remove('hidden');
                } else {
                    document.getElementById('actionButtons').classList.add('hidden');
                    document.getElementById('userRatingSection').classList.add('hidden');
                }

                // Render videos
                this.renderVideos(youtube_videos);

                // Render similar content
                this.renderSimilarContent(similar_content);

                // Render reviews
                this.renderReviews(user_reviews);
            }

            renderVideos(videos) {
                if (!videos || (!videos.trailers?.length && !videos.teasers?.length)) {
                    document.getElementById('videosSection').classList.add('hidden');
                    return;
                }

                const videosGrid = document.getElementById('videosGrid');
                const allVideos = [...(videos.trailers || []), ...(videos.teasers || [])];

                videosGrid.innerHTML = allVideos.slice(0, 6).map(video => `
                    <div class="bg-secondary-bg rounded-lg overflow-hidden hover:scale-105 transition-transform">
                        <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-32 object-cover">
                        <div class="p-4">
                            <h4 class="font-medium mb-2 line-clamp-2">${video.title}</h4>
                            <a href="${video.url}" target="_blank" class="btn-primary text-sm">
                                Watch on YouTube
                            </a>
                        </div>
                    </div>
                `).join('');

                document.getElementById('videosSection').classList.remove('hidden');
            }

            renderSimilarContent(similarContent) {
                if (!similarContent || similarContent.length === 0) return;

                UIComponents.createCarousel('similarCarousel', similarContent);
            }

            renderReviews(reviews) {
                const reviewsContainer = document.getElementById('reviewsContainer');
                
                if (!reviews || reviews.length === 0) {
                    reviewsContainer.innerHTML = `
                        <div class="text-center py-8 text-text-secondary">
                            <p>No reviews yet. Be the first to share your thoughts!</p>
                        </div>
                    `;
                    return;
                }

                reviewsContainer.innerHTML = reviews.map(review => `
                    <div class="bg-secondary-bg rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-accent-red rounded-full flex items-center justify-center">
                                    ${review.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-medium">${review.username}</h4>
                                    <div class="flex items-center space-x-1">
                                        ${Array(5).fill().map((_, i) => 
                                            `<span class="text-${i < review.rating ? 'yellow' : 'gray'}-400">★</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                            <span class="text-text-secondary text-sm">
                                ${Utils.formatDate(review.created_at)}
                            </span>
                        </div>
                        ${review.content ? `<p class="text-text-secondary leading-relaxed">${review.content}</p>` : ''}
                    </div>
                `).join('');
            }

            async handleInteraction(type) {
                if (!authManager.isLoggedIn) {
                    UIComponents.showToast('Please login to interact with movies', 'warning');
                    return;
                }

                try {
                    await apiService.recordInteraction({
                        content_id: this.movieId,
                        interaction_type: type
                    });

                    const messages = {
                        favorite: 'Added to favorites!',
                        wishlist: 'Added to wishlist!',
                        like: 'Liked!'
                    };

                    UIComponents.showToast(messages[type], 'success');
                } catch (error) {
                    console.error('Interaction failed:', error);
                    UIComponents.showToast('Failed to save interaction', 'error');
                }
            }

            async shareMovie() {
                const shareData = {
                    title: this.movieData.content.title,
                    text: `Check out ${this.movieData.content.title} on MovieRec!`,
                    url: window.location.href
                };

                if (await Utils.shareContent(shareData)) {
                    UIComponents.showToast('Movie shared!', 'success');
                } else {
                    UIComponents.showToast('Link copied to clipboard!', 'success');
                }
            }
        }

        // Initialize movie detail page
        document.addEventListener('DOMContentLoaded', () => {
            // Update auth UI
            authManager.updateUI();
            
            // Initialize movie detail page
            new MovieDetailPage();
        });
    </script>
</body>
</html>