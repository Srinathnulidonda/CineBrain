<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details - MovieRec</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap-grid.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <style>
        .detail-hero { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('assets/images/placeholder-backdrop.jpg'); background-size: cover; background-position: center; min-height: 60vh; display: flex; align-items: flex-end; padding: 4rem 0 2rem; }
        .detail-content { background: var(--primary-bg); margin-top: -2rem; border-radius: 1rem 1rem 0 0; position: relative; z-index: 2; }
        .detail-info { padding: 2rem 0; }
        .detail-poster { width: 200px; height: 300px; border-radius: 0.75rem; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .detail-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .detail-subtitle { color: var(--text-secondary); font-size: 1.2rem; margin-bottom: 1rem; }
        .detail-meta { display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .meta-item { display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); }
        .rating-large { font-size: 1.5rem; color: #ffd700; }
        .action-buttons { display: flex; gap: 1rem; margin: 2rem 0; flex-wrap: wrap; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .video-card { background: var(--tertiary-bg); border-radius: 0.75rem; overflow: hidden; transition: transform 0.3s ease; }
        .video-card:hover { transform: scale(1.02); }
        .video-thumbnail { width: 100%; height: 180px; object-fit: cover; }
        .video-info { padding: 1rem; }
        .cast-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .cast-card { background: var(--tertiary-bg); border-radius: 0.75rem; padding: 1rem; text-align: center; }
        .cast-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem; }
        .review-card { background: var(--tertiary-bg); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; }
        .review-header { display: flex; justify-content: between; align-items: center; margin-bottom: 1rem; }
        .review-author { font-weight: 600; }
        .review-rating { color: #ffd700; }
        .similar-content { margin: 3rem 0; }
        .content-row { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="row w-100 align-items-center">
                <div class="col-md-3">
                    <a href="index.html" class="navbar-brand">MovieRec</a>
                </div>
                <div class="col-md-6">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Search movies, TV shows, anime..." id="searchInput">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="navbar-nav justify-content-end">
                        <a href="index.html" class="nav-link">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="detail-hero" id="detailHero">
        <div class="container">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <img src="assets/images/placeholder-poster.jpg" alt="Movie Poster" class="detail-poster" id="moviePoster">
                </div>
                <div class="col-md-9">
                    <h1 class="detail-title" id="movieTitle">Loading...</h1>
                    <p class="detail-subtitle" id="movieTagline"></p>
                    <div class="detail-meta">
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span id="releaseDate">Loading...</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span id="runtime">Loading...</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-star rating-large"></i>
                            <span id="rating">0.0</span>/10
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-primary" onclick="playMovie()">
                            <i class="fas fa-play"></i> Watch Now
                        </button>
                        <button class="btn-secondary" onclick="toggleWatchlist()">
                            <i class="far fa-bookmark"></i> Add to Watchlist
                        </button>
                        <button class="btn-secondary" onclick="toggleFavorite()">
                            <i class="far fa-heart"></i> Add to Favorites
                        </button>
                        <button class="btn-secondary" onclick="shareMovie()">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Detail Content -->
    <section class="detail-content">
        <div class="container">
            <!-- Overview -->
            <div class="detail-info">
                <div class="row">
                    <div class="col-md-8">
                        <h3>Overview</h3>
                        <p id="movieOverview" class="text-secondary">Loading overview...</p>
                        
                        <div id="genresContainer">
                            <h4>Genres</h4>
                            <div id="genresList" class="genre-tags">
                                <span class="genre-tag loading-skeleton">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="movie-details">
                            <h4>Details</h4>
                            <div class="detail-list">
                                <div class="detail-item">
                                    <strong>Director:</strong>
                                    <span id="director">Loading...</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Language:</strong>
                                    <span id="language">Loading...</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Budget:</strong>
                                    <span id="budget">Loading...</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Revenue:</strong>
                                    <span id="revenue">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Videos -->
            <div class="videos-section" id="videosSection">
                <h3>Trailers & Videos</h3>
                <div class="video-grid" id="videoGrid">
                    <div class="loading-skeleton" style="height: 200px;"></div>
                </div>
            </div>

            <!-- Cast -->
            <div class="cast-section" id="castSection">
                <h3>Cast</h3>
                <div class="cast-grid" id="castGrid">
                    <div class="loading-skeleton" style="height: 150px;"></div>
                </div>
            </div>

            <!-- Reviews -->
            <div class="reviews-section" id="reviewsSection">
                <h3>User Reviews</h3>
                <div id="reviewsList">
                    <div class="loading-skeleton" style="height: 200px;"></div>
                </div>
                <button class="btn-secondary" onclick="showWriteReview()">
                    <i class="fas fa-pen"></i> Write a Review
                </button>
            </div>

            <!-- Similar Content -->
            <div class="similar-content">
                <h3>You Might Also Like</h3>
                <div class="content-row" id="similarContent">
                    <div class="loading-skeleton movie-card"></div>
                    <div class="loading-skeleton movie-card"></div>
                    <div class="loading-skeleton movie-card"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Write Review Modal -->
    <div id="reviewModal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Write a Review</h3>
                <button class="modal-close" onclick="hideModal('reviewModal')">&times;</button>
            </div>
            <form id="reviewForm">
                <div class="form-group">
                    <label class="form-label">Rating</label>
                    <div class="rating-input" id="ratingInput">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                        <i class="fas fa-star" data-rating="6"></i>
                        <i class="fas fa-star" data-rating="7"></i>
                        <i class="fas fa-star" data-rating="8"></i>
                        <i class="fas fa-star" data-rating="9"></i>
                        <i class="fas fa-star" data-rating="10"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Review</label>
                    <textarea class="form-control" id="reviewText" rows="5" placeholder="Share your thoughts about this movie..."></textarea>
                </div>
                <button type="submit" class="btn-primary">Submit Review</button>
            </form>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/components.js"></script>
    <script>
        class MovieDetailPage {
            constructor() {
                this.movieId = this.getMovieIdFromURL();
                this.movieData = null;
                this.userRating = 0;
                this.init();
            }

            getMovieIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            }

            async init() {
                if (!this.movieId) {
                    window.location.href = 'index.html';
                    return;
                }

                await this.loadMovieDetails();
                this.setupRatingInput();
                this.setupReviewForm();
            }

            async loadMovieDetails() {
                try {
                    const data = await apiService.getContentDetails(this.movieId);
                    this.movieData = data;
                    this.renderMovieDetails(data);
                } catch (error) {
                    console.error('Error loading movie details:', error);
                    this.showError('Failed to load movie details');
                }
            }

            renderMovieDetails(data) {
                const content = data.content;
                
                // Update title and basic info
                document.getElementById('movieTitle').textContent = content.title;
                document.getElementById('moviePoster').src = content.poster_path || 'assets/images/placeholder-poster.jpg';
                document.getElementById('movieOverview').textContent = content.overview || 'No overview available.';
                document.getElementById('rating').textContent = content.rating?.toFixed(1) || '0.0';
                document.getElementById('releaseDate').textContent = content.release_date ? 
                    new Date(content.release_date).getFullYear() : 'Unknown';
                document.getElementById('runtime').textContent = content.runtime ? 
                    `${content.runtime} min` : 'Unknown';

                // Update background
                if (content.backdrop_path) {
                    document.getElementById('detailHero').style.backgroundImage = 
                        `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('${content.backdrop_path}')`;
                }

                // Render genres
                if (content.genre_names && content.genre_names.length > 0) {
                    document.getElementById('genresList').innerHTML = 
                        content.genre_names.map(genre => `<span class="genre-tag">${genre}</span>`).join('');
                }

                // Render additional details
                if (data.tmdb_details) {
                    this.renderTMDBDetails(data.tmdb_details);
                }

                // Render videos
                if (data.youtube_videos) {
                    this.renderVideos(data.youtube_videos);
                }

                // Render similar content
                if (data.similar_content) {
                    this.renderSimilarContent(data.similar_content);
                }

                // Render reviews
                if (data.user_reviews) {
                    this.renderReviews(data.user_reviews);
                }
            }

            renderTMDBDetails(details) {
                if (details.credits && details.credits.crew) {
                    const director = details.credits.crew.find(person => person.job === 'Director');
                    if (director) {
                        document.getElementById('director').textContent = director.name;
                    }
                }

                if (details.spoken_languages && details.spoken_languages.length > 0) {
                    document.getElementById('language').textContent = 
                        details.spoken_languages.map(lang => lang.english_name).join(', ');
                }

                if (details.budget) {
                    document.getElementById('budget').textContent = 
                        new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(details.budget);
                }

                if (details.revenue) {
                    document.getElementById('revenue').textContent = 
                        new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(details.revenue);
                }

                // Render cast
                if (details.credits && details.credits.cast) {
                    this.renderCast(details.credits.cast.slice(0, 12));
                }
            }

            renderVideos(videos) {
                const videoGrid = document.getElementById('videoGrid');
                const allVideos = [...(videos.trailers || []), ...(videos.teasers || [])];
                
                if (allVideos.length === 0) {
                    videoGrid.innerHTML = '<p class="text-secondary">No videos available.</p>';
                    return;
                }

                videoGrid.innerHTML = allVideos.map(video => `
                    <div class="video-card">
                        <img src="${video.thumbnail}" alt="${video.title}" class="video-thumbnail">
                        <div class="video-info">
                            <h4>${video.title}</h4>
                            <a href="${video.url}" target="_blank" class="btn-primary">
                                <i class="fab fa-youtube"></i> Watch on YouTube
                            </a>
                        </div>
                    </div>
                `).join('');
            }

            renderCast(cast) {
                const castGrid = document.getElementById('castGrid');
                castGrid.innerHTML = cast.map(person => `
                    <div class="cast-card">
                        <img src="${person.profile_path ? `https://image.tmdb.org/t/p/w200${person.profile_path}` : 'assets/images/placeholder-person.jpg'}" 
                             alt="${person.name}" class="cast-photo">
                        <h5>${person.name}</h5>
                        <p class="text-secondary">${person.character}</p>
                    </div>
                `).join('');
            }

            renderReviews(reviews) {
                const reviewsList = document.getElementById('reviewsList');
                
                if (reviews.length === 0) {
                    reviewsList.innerHTML = '<p class="text-secondary">No reviews yet. Be the first to review!</p>';
                    return;
                }

                reviewsList.innerHTML = reviews.map(review => `
                    <div class="review-card">
                        <div class="review-header">
                            <span class="review-author">${review.username}</span>
                            <div class="review-rating">
                                ${this.renderStars(review.rating)}
                            </div>
                        </div>
                        <p class="review-text">${review.review_text || 'User rated this movie.'}</p>
                        <small class="text-secondary">${new Date(review.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
            }

            renderSimilarContent(similarContent) {
                const container = document.getElementById('similarContent');
                container.innerHTML = similarContent.map(item => this.createMovieCard(item)).join('');
            }

            createMovieCard(item) {
                return `
                    <div class="movie-card" onclick="window.location.href='movie-detail.html?id=${item.id}'">
                        <div class="movie-poster">
                            <img src="${item.poster_path || 'assets/images/placeholder-poster.jpg'}" alt="${item.title}" loading="lazy">
                        </div>
                        <div class="movie-info">
                            <h3 class="movie-title">${item.title}</h3>
                            <div class="movie-meta">
                                ${item.rating ? `<span class="movie-rating"><i class="fas fa-star"></i> ${item.rating.toFixed(1)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderStars(rating) {
                const stars = [];
                for (let i = 1; i <= 10; i++) {
                    stars.push(`<i class="fas fa-star ${i <= rating ? 'active' : ''}"></i>`);
                }
                return stars.join('');
            }

            setupRatingInput() {
                const stars = document.querySelectorAll('#ratingInput .fa-star');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        this.userRating = parseInt(star.dataset.rating);
                        this.updateRatingDisplay();
                    });
                });
            }

            updateRatingDisplay() {
                const stars = document.querySelectorAll('#ratingInput .fa-star');
                stars.forEach((star, index) => {
                    if (index < this.userRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }

            setupReviewForm() {
                document.getElementById('reviewForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.submitReview();
                });
            }

            async submitReview() {
                if (!localStorage.getItem('authToken')) {
                    window.location.href = 'login.html';
                    return;
                }

                const reviewText = document.getElementById('reviewText').value;
                
                try {
                    await apiService.recordInteraction({
                        content_id: this.movieId,
                        interaction_type: 'review',
                        rating: this.userRating,
                        review_text: reviewText
                    });
                    
                    this.hideModal('reviewModal');
                    this.showSuccess('Review submitted successfully!');
                    await this.loadMovieDetails(); // Reload to show new review
                } catch (error) {
                    this.showError('Failed to submit review.');
                }
            }

            async toggleWatchlist() {
                if (!localStorage.getItem('authToken')) {
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    await apiService.recordInteraction({
                        content_id: this.movieId,
                        interaction_type: 'wishlist'
                    });
                    this.showSuccess('Added to watchlist!');
                } catch (error) {
                    this.showError('Failed to update watchlist.');
                }
            }

            async toggleFavorite() {
                if (!localStorage.getItem('authToken')) {
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    await apiService.recordInteraction({
                        content_id: this.movieId,
                        interaction_type: 'favorite'
                    });
                    this.showSuccess('Added to favorites!');
                } catch (error) {
                    this.showError('Failed to update favorites.');
                }
            }

            playMovie() {
                if (!localStorage.getItem('authToken')) {
                    window.location.href = 'login.html';
                    return;
                }

                apiService.recordInteraction({
                    content_id: this.movieId,
                    interaction_type: 'view'
                });

                this.showSuccess('Playing movie...');
            }

            shareMovie() {
                if (navigator.share) {
                    navigator.share({
                        title: this.movieData.content.title,
                        text: this.movieData.content.overview,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(window.location.href);
                    this.showSuccess('Link copied to clipboard!');
                }
            }

            showWriteReview() {
                if (!localStorage.getItem('authToken')) {
                    window.location.href = 'login.html';
                    return;
                }
                this.showModal('reviewModal');
            }

            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }

            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            showSuccess(message) {
                // Toast implementation
                console.log('Success:', message);
            }

            showError(message) {
                console.error('Error:', message);
            }
        }

        // Initialize page
        const movieDetailPage = new MovieDetailPage();

        // Global functions
        function playMovie() {
            movieDetailPage.playMovie();
        }

        function toggleWatchlist() {
            movieDetailPage.toggleWatchlist();
        }

        function toggleFavorite() {
            movieDetailPage.toggleFavorite();
        }

        function shareMovie() {
            movieDetailPage.shareMovie();
        }

        function showWriteReview() {
            movieDetailPage.showWriteReview();
        }

        function hideModal(modalId) {
            movieDetailPage.hideModal(modalId);
        }
    </script>
</body>
</html>