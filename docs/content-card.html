<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineBrain - Discover Movies, TV Shows & Anime</title>

    <!-- Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Responsive font sizes */
            --font-size-xs: clamp(0.625rem, 0.5rem + 0.5vw, 0.75rem);
            /* 10-12px */
            --font-size-sm: clamp(0.75rem, 0.625rem + 0.5vw, 0.875rem);
            /* 12-14px */
            --font-size-base: clamp(0.875rem, 0.75rem + 0.5vw, 1rem);
            /* 14-16px */
            --font-size-lg: clamp(1rem, 0.875rem + 0.5vw, 1.125rem);
            /* 16-18px */
            --font-size-xl: clamp(1.25rem, 1rem + 1vw, 1.5rem);
            /* 20-24px */
            --font-size-2xl: clamp(1.5rem, 1.25rem + 1vw, 2rem);
            /* 24-32px */

            /* Colors */
            --bg-primary: #0a0e27;
            --bg-secondary: #141829;
            --bg-card: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-gold: #fbbf24;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;

            /* Spacing */
            --spacing-xs: clamp(0.25rem, 0.2rem + 0.25vw, 0.375rem);
            --spacing-sm: clamp(0.5rem, 0.4rem + 0.5vw, 0.75rem);
            --spacing-md: clamp(0.75rem, 0.6rem + 0.75vw, 1rem);
            --spacing-lg: clamp(1rem, 0.8rem + 1vw, 1.5rem);
            --spacing-xl: clamp(1.5rem, 1.2rem + 1.5vw, 2rem);
            --spacing-2xl: clamp(2rem, 1.5rem + 2vw, 3rem);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.5;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Content Row */
        .content-row {
            margin-bottom: var(--spacing-2xl);
            position: relative;
        }

        .row-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            padding: 0 var(--spacing-xs);
        }

        .row-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .see-all {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: var(--font-size-sm);
            font-weight: 500;
            transition: all 0.2s;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 4px;
        }

        .see-all:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
        }

        /* Grid Carousel Container */
        .carousel-container {
            position: relative;
            overflow: hidden;
            margin: 0 calc(var(--spacing-lg) * -1);
            padding: 0 var(--spacing-lg);
        }

        .carousel-wrapper {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: minmax(120px, 1fr);
            gap: var(--spacing-sm);
            overflow-x: auto;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: var(--spacing-xs) 0 var(--spacing-lg);
            -webkit-overflow-scrolling: touch;
        }

        .carousel-wrapper::-webkit-scrollbar {
            display: none;
        }

        /* Grid Responsive Columns */
        @media (min-width: 480px) {
            .carousel-wrapper {
                grid-auto-columns: minmax(140px, 1fr);
                gap: var(--spacing-sm);
            }
        }

        @media (min-width: 640px) {
            .carousel-wrapper {
                grid-auto-columns: minmax(160px, 1fr);
                gap: var(--spacing-md);
            }
        }

        @media (min-width: 768px) {
            .carousel-wrapper {
                grid-auto-columns: minmax(170px, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .carousel-wrapper {
                grid-auto-columns: minmax(180px, 1fr);
            }
        }

        @media (min-width: 1280px) {
            .carousel-wrapper {
                grid-auto-columns: minmax(190px, 1fr);
            }
        }

        @media (min-width: 1536px) {
            .carousel-wrapper {
                grid-auto-columns: minmax(200px, 1fr);
            }
        }

        /* Navigation Arrows - Desktop Only */
        .carousel-nav {
            position: absolute;
            top: 45%;
            transform: translateY(-50%);
            width: clamp(40px, 3vw, 56px);
            height: clamp(40px, 3vw, 56px);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 1024px) {
            .carousel-nav {
                display: flex;
            }
        }

        .carousel-container:hover .carousel-nav {
            opacity: 1;
        }

        .carousel-nav:hover {
            background: rgba(0, 0, 0, 0.95);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-nav.prev {
            left: var(--spacing-xs);
        }

        .carousel-nav.next {
            right: var(--spacing-xs);
        }

        .carousel-nav svg {
            width: 60%;
            height: 60%;
            fill: var(--text-primary);
        }

        .carousel-nav.disabled {
            opacity: 0.3 !important;
            cursor: not-allowed;
        }

        /* Content Card */
        .content-card {
            scroll-snap-align: start;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        .content-card:hover {
            transform: scale(1.05);
            z-index: 5;
        }

        /* Card Poster Container */
        .card-poster-container {
            position: relative;
            width: 100%;
            padding-bottom: 150%;
            /* 2:3 aspect ratio */
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: clamp(6px, 1vw, 12px);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .content-card:hover .card-poster-container {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .card-poster {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card-poster.loaded {
            opacity: 1;
        }

        /* Content Type Badge */
        .content-type-badge {
            position: absolute;
            top: var(--spacing-sm);
            left: var(--spacing-sm);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: calc(var(--spacing-xs) / 2) var(--spacing-xs);
            border-radius: 4px;
            font-size: var(--font-size-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 3;
        }

        .content-type-badge.movie {
            background: linear-gradient(135deg, var(--accent-blue), #2563eb);
        }

        .content-type-badge.tv {
            background: linear-gradient(135deg, var(--accent-green), #059669);
        }

        .content-type-badge.anime {
            background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
        }

        /* Card Overlays */
        .card-overlays {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: var(--spacing-sm);
            pointer-events: none;
            z-index: 2;
        }

        .card-top-overlay {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: all;
        }

        .card-bottom-overlay {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: all;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
            margin: 0 calc(var(--spacing-sm) * -1) calc(var(--spacing-sm) * -1);
            padding: var(--spacing-lg) var(--spacing-sm) var(--spacing-sm);
        }

        /* Wishlist Button - Always Visible */
        .wishlist-btn {
            width: clamp(32px, 2.5vw, 40px);
            height: clamp(32px, 2.5vw, 40px);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .wishlist-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .wishlist-btn svg {
            width: 55%;
            height: 55%;
            fill: none;
            stroke: var(--text-primary);
            stroke-width: 2;
            transition: all 0.3s;
        }

        .wishlist-btn.active svg {
            fill: var(--accent-red);
            stroke: var(--accent-red);
        }

        .wishlist-btn:active {
            transform: scale(0.95);
        }

        /* Rating Badge */
        .rating-badge {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: calc(var(--spacing-xs) / 2) var(--spacing-xs);
            border-radius: 4px;
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-xs) / 2);
        }

        .rating-badge svg {
            width: clamp(10px, 1vw, 14px);
            height: clamp(10px, 1vw, 14px);
            fill: var(--accent-gold);
        }

        /* Card Info */
        .card-info {
            padding: var(--spacing-sm) var(--spacing-xs);
        }

        .card-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: calc(var(--spacing-xs) / 2);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
            min-height: 2.6em;
        }

        @media (min-width: 768px) {
            .card-title {
                font-size: var(--font-size-base);
            }
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .card-year {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .card-runtime {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .card-genres {
            display: flex;
            flex-wrap: wrap;
            gap: calc(var(--spacing-xs) / 2);
        }

        .genre-chip {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px var(--spacing-xs);
            border-radius: 4px;
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .genre-chip:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg,
                    var(--bg-card) 0%,
                    rgba(255, 255, 255, 0.05) 50%,
                    var(--bg-card) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-card {
            scroll-snap-align: start;
        }

        .skeleton-poster {
            width: 100%;
            padding-bottom: 150%;
            border-radius: clamp(6px, 1vw, 12px);
        }

        .skeleton-title {
            height: var(--font-size-base);
            margin: var(--spacing-sm) var(--spacing-xs) var(--spacing-xs);
            border-radius: 4px;
            width: 80%;
        }

        .skeleton-meta {
            height: var(--font-size-sm);
            margin: 0 var(--spacing-xs) var(--spacing-xs);
            border-radius: 4px;
            width: 60%;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Error Message */
        .error-message {
            grid-column: span 12;
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-lg);
            color: var(--accent-red);
        }

        .error-message h3 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-sm);
        }

        .error-message p {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
        }

        .retry-btn {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 500;
            transition: all 0.2s;
        }

        .retry-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .retry-btn:active {
            transform: translateY(0);
        }

        /* Mobile Touch Feedback */
        @media (hover: none) {
            .content-card:active {
                transform: scale(0.98);
            }

            .wishlist-btn:active {
                transform: scale(0.9);
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Dark Mode Adjustments */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f9fafb;
                --bg-secondary: #f3f4f6;
                --bg-card: #ffffff;
                --text-primary: #111827;
                --text-secondary: #6b7280;
                --text-muted: #9ca3af;
            }

            .card-poster-container {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .content-card:hover .card-poster-container {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Content Rows will be dynamically inserted here -->
        <div id="content-container"></div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://backend-app-970m.onrender.com/api';
        const POSTER_BASE_URL = 'https://image.tmdb.org/t/p/w500';

        // Authentication
        let authToken = localStorage.getItem('authToken');
        let isAuthenticated = !!authToken;

        // User wishlist cache
        let userWishlist = new Set();

        // Content Row Configuration
        const contentRows = [
            {
                id: 'trending',
                title: 'Trending Now',
                endpoint: '/recommendations/trending',
                params: { type: 'all', limit: 24 }
            },
            {
                id: 'new-releases',
                title: 'New Releases',
                endpoint: '/recommendations/new-releases',
                params: { type: 'movie', limit: 24 }
            },
            {
                id: 'critics-choice',
                title: 'Critics Choice',
                endpoint: '/recommendations/critics-choice',
                params: { type: 'movie', limit: 24 }
            },
            {
                id: 'popular-movies',
                title: 'Popular Movies',
                endpoint: '/recommendations/trending',
                params: { type: 'movie', limit: 24 }
            },
            {
                id: 'top-tv-shows',
                title: 'Top Rated TV Shows',
                endpoint: '/recommendations/trending',
                params: { type: 'tv', limit: 24 }
            },
            {
                id: 'anime-picks',
                title: 'Anime Picks',
                endpoint: '/recommendations/anime',
                params: { limit: 24 }
            }
        ];

        // Utility Functions
        function formatPosterUrl(posterPath) {
            if (!posterPath) {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgZmlsbD0iIzFhMWYzYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjNjY3IiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+';
            }
            if (posterPath.startsWith('http')) return posterPath;
            return `${POSTER_BASE_URL}${posterPath}`;
        }

        function formatRating(rating) {
            if (!rating) return 'N/A';
            return Number(rating).toFixed(1);
        }

        function extractYear(dateString) {
            if (!dateString) return '';
            return new Date(dateString).getFullYear();
        }

        function formatRuntime(minutes) {
            if (!minutes) return '';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        }

        function getContentTypeColor(type) {
            const colors = {
                'movie': 'movie',
                'tv': 'tv',
                'anime': 'anime'
            };
            return colors[type?.toLowerCase()] || 'movie';
        }

        // Load user wishlist
        async function loadUserWishlist() {
            if (!isAuthenticated) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/watchlist`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userWishlist = new Set(data.watchlist.map(item => item.id));
                }
            } catch (error) {
                console.error('Error loading wishlist:', error);
            }
        }

        // Content Card Component
        function createContentCard(content) {
            const card = document.createElement('div');
            card.className = 'content-card';
            card.dataset.contentId = content.id;

            const posterUrl = formatPosterUrl(content.poster_path);
            const rating = formatRating(content.rating);
            const year = extractYear(content.release_date);
            const genres = content.genres?.slice(0, 2) || [];
            const contentType = content.content_type || 'movie';
            const runtime = formatRuntime(content.runtime);
            const isInWishlist = userWishlist.has(content.id);

            card.innerHTML = `
                <div class="card-poster-container">
                    <img 
                        class="card-poster" 
                        data-src="${posterUrl}" 
                        alt="${content.title}"
                        loading="lazy"
                    >
                    <div class="content-type-badge ${getContentTypeColor(contentType)}">
                        ${contentType.toUpperCase()}
                    </div>
                    <div class="card-overlays">
                        <div class="card-top-overlay">
                            <div></div>
                            <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" 
                                    data-content-id="${content.id}" 
                                    title="Add to Wishlist"
                                    aria-label="Add to Wishlist">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="card-bottom-overlay">
                            <div class="rating-badge">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                </svg>
                                <span>${rating}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-info">
                    <div class="card-title">${content.title}</div>
                    <div class="card-meta">
                        ${year ? `<span class="card-year">${year}</span>` : ''}
                        ${runtime ? `<span class="card-runtime">• ${runtime}</span>` : ''}
                    </div>
                    ${genres.length > 0 ? `
                        <div class="card-genres">
                            ${genres.map(genre => `<span class="genre-chip">${genre}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            // Click handler for navigation
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.wishlist-btn')) {
                    window.location.href = `/content/details.html?id=${content.id}`;
                }
            });

            // Wishlist button handler
            const wishlistBtn = card.querySelector('.wishlist-btn');
            wishlistBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await handleWishlistClick(content.id, wishlistBtn);
            });

            // Lazy load poster image
            const img = card.querySelector('.card-poster');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const imgSrc = img.dataset.src;
                        if (imgSrc) {
                            const tempImg = new Image();
                            tempImg.onload = () => {
                                img.src = imgSrc;
                                img.classList.add('loaded');
                            };
                            tempImg.src = imgSrc;
                        }
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px',
                threshold: 0.01
            });
            observer.observe(img);

            return card;
        }

        // Skeleton Card Component
        function createSkeletonCard() {
            const card = document.createElement('div');
            card.className = 'skeleton-card';
            card.innerHTML = `
                <div class="skeleton skeleton-poster"></div>
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-meta"></div>
            `;
            return card;
        }

        // Carousel Component
        function createCarouselRow(rowConfig) {
            const row = document.createElement('div');
            row.className = 'content-row';
            row.id = rowConfig.id;

            row.innerHTML = `
                <div class="row-header">
                    <h2 class="row-title">${rowConfig.title}</h2>
                    <a href="/browse/${rowConfig.id}" class="see-all">See All →</a>
                </div>
                <div class="carousel-container">
                    <button class="carousel-nav prev" aria-label="Previous">
                        <svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </button>
                    <div class="carousel-wrapper">
                        <!-- Loading skeletons -->
                        ${Array(8).fill('').map(() => {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-card';
                skeleton.innerHTML = `
                                <div class="skeleton skeleton-poster"></div>
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-meta"></div>
                            `;
                return skeleton.outerHTML;
            }).join('')}
                    </div>
                    <button class="carousel-nav next" aria-label="Next">
                        <svg viewBox="0 0 24 24">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                </div>
            `;

            return row;
        }

        // Setup Carousel Navigation
        function setupCarouselNavigation(carouselRow) {
            const wrapper = carouselRow.querySelector('.carousel-wrapper');
            const prevBtn = carouselRow.querySelector('.carousel-nav.prev');
            const nextBtn = carouselRow.querySelector('.carousel-nav.next');

            if (!wrapper) return;

            // Calculate scroll amount based on visible cards
            function getScrollAmount() {
                const containerWidth = wrapper.clientWidth;
                const cardWidth = wrapper.querySelector('.content-card')?.offsetWidth || 180;
                const gap = parseInt(getComputedStyle(wrapper).gap) || 12;
                const visibleCards = Math.floor(containerWidth / (cardWidth + gap));
                return (cardWidth + gap) * Math.max(1, visibleCards - 1);
            }

            // Update navigation buttons state
            function updateNavButtons() {
                if (!prevBtn || !nextBtn) return;

                const scrollLeft = wrapper.scrollLeft;
                const maxScroll = wrapper.scrollWidth - wrapper.clientWidth;

                prevBtn.classList.toggle('disabled', scrollLeft <= 0);
                nextBtn.classList.toggle('disabled', scrollLeft >= maxScroll - 1);
            }

            // Navigation handlers
            if (prevBtn && nextBtn) {
                prevBtn.addEventListener('click', () => {
                    wrapper.scrollBy({
                        left: -getScrollAmount(),
                        behavior: 'smooth'
                    });
                });

                nextBtn.addEventListener('click', () => {
                    wrapper.scrollBy({
                        left: getScrollAmount(),
                        behavior: 'smooth'
                    });
                });

                // Update buttons on scroll
                wrapper.addEventListener('scroll', updateNavButtons);

                // Initial button state
                updateNavButtons();
            }

            // Touch/swipe support for mobile
            let startX = 0;
            let scrollStart = 0;
            let isDown = false;

            wrapper.addEventListener('touchstart', (e) => {
                startX = e.touches[0].pageX;
                scrollStart = wrapper.scrollLeft;
                isDown = true;
            }, { passive: true });

            wrapper.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const x = e.touches[0].pageX;
                const walk = (startX - x) * 1.5;
                wrapper.scrollLeft = scrollStart + walk;
            }, { passive: true });

            wrapper.addEventListener('touchend', () => {
                isDown = false;
            });

            // Mouse drag support for desktop
            let mouseDown = false;
            let mouseStartX = 0;
            let mouseScrollStart = 0;

            wrapper.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseStartX = e.pageX;
                mouseScrollStart = wrapper.scrollLeft;
                wrapper.style.cursor = 'grabbing';
            });

            wrapper.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;
                e.preventDefault();
                const x = e.pageX;
                const walk = (mouseStartX - x) * 2;
                wrapper.scrollLeft = mouseScrollStart + walk;
            });

            wrapper.addEventListener('mouseup', () => {
                mouseDown = false;
                wrapper.style.cursor = 'grab';
            });

            wrapper.addEventListener('mouseleave', () => {
                mouseDown = false;
                wrapper.style.cursor = 'grab';
            });
        }

        // Wishlist Handler
        async function handleWishlistClick(contentId, button) {
            // Check if user is authenticated
            if (!isAuthenticated) {
                // Redirect to login page
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }

            try {
                // Toggle button state optimistically
                const wasActive = button.classList.contains('active');
                button.classList.toggle('active');

                // Update local cache
                if (wasActive) {
                    userWishlist.delete(contentId);
                } else {
                    userWishlist.add(contentId);
                }

                // Send request to backend
                const response = await fetch(`${API_BASE_URL}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        interaction_type: 'watchlist'
                    })
                });

                if (!response.ok) {
                    // Revert on error
                    button.classList.toggle('active');
                    if (wasActive) {
                        userWishlist.add(contentId);
                    } else {
                        userWishlist.delete(contentId);
                    }
                    console.error('Failed to update wishlist');
                }
            } catch (error) {
                // Revert on error
                button.classList.toggle('active');
                console.error('Error updating wishlist:', error);
            }
        }

        // Fetch Content Data
        async function fetchContent(endpoint, params = {}) {
            try {
                const queryString = new URLSearchParams(params).toString();
                const url = `${API_BASE_URL}${endpoint}${queryString ? '?' + queryString : ''}`;

                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(url, { headers });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.recommendations || [];
            } catch (error) {
                console.error('Error fetching content:', error);
                throw error;
            }
        }

        // Load Content Row
        async function loadContentRow(rowConfig) {
            const row = document.getElementById(rowConfig.id);
            if (!row) return;

            const wrapper = row.querySelector('.carousel-wrapper');
            if (!wrapper) return;

            try {
                const content = await fetchContent(rowConfig.endpoint, rowConfig.params);

                // Clear loading skeletons
                wrapper.innerHTML = '';

                if (content.length === 0) {
                    wrapper.innerHTML = `
                        <div class="error-message">
                            <p>No content available</p>
                        </div>
                    `;
                    return;
                }

                // Add content cards
                content.forEach(item => {
                    const card = createContentCard(item);
                    wrapper.appendChild(card);
                });

                // Setup navigation after content loads
                setupCarouselNavigation(row);

            } catch (error) {
                console.error(`Error loading ${rowConfig.title}:`, error);
                wrapper.innerHTML = `
                    <div class="error-message">
                        <h3>Unable to load content</h3>
                        <p>Please check your connection and try again</p>
                        <button class="retry-btn" onclick="retryLoadRow('${rowConfig.id}')">Retry</button>
                    </div>
                `;
            }
        }

        // Retry loading a specific row
        window.retryLoadRow = function (rowId) {
            const rowConfig = contentRows.find(row => row.id === rowId);
            if (rowConfig) {
                const row = document.getElementById(rowId);
                const wrapper = row.querySelector('.carousel-wrapper');
                wrapper.innerHTML = Array(8).fill('').map(() => {
                    return `
                        <div class="skeleton-card">
                            <div class="skeleton skeleton-poster"></div>
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-meta"></div>
                        </div>
                    `;
                }).join('');
                loadContentRow(rowConfig);
            }
        }

        // Initialize
        async function init() {
            const container = document.getElementById('content-container');

            // Load user wishlist if authenticated
            if (isAuthenticated) {
                loadUserWishlist();
            }

            // Create all carousel rows
            contentRows.forEach(rowConfig => {
                const row = createCarouselRow(rowConfig);
                container.appendChild(row);
            });

            // Load content for all rows with staggered loading for better performance
            contentRows.forEach((rowConfig, index) => {
                setTimeout(() => {
                    loadContentRow(rowConfig);
                }, index * 200); // Stagger by 200ms
            });

            // Handle window resize for responsive updates
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    document.querySelectorAll('.content-row').forEach(row => {
                        setupCarouselNavigation(row);
                    });
                }, 250);
            });

            // Listen for authentication changes
            window.addEventListener('storage', (e) => {
                if (e.key === 'authToken') {
                    authToken = e.newValue;
                    isAuthenticated = !!authToken;
                    if (isAuthenticated) {
                        loadUserWishlist();
                    } else {
                        userWishlist.clear();
                    }
                    // Refresh the page to update UI
                    location.reload();
                }
            });
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>