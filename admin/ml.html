<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CineScope Admin ML Service Management">

    <title>ML Service - CineScope Admin</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/bootstrap-overrides.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .ml-status-card {
            background: var(--cs-surface-light);
            border: 1px solid var(--cs-border);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .ml-check-item {
            padding: 1rem;
            border-bottom: 1px solid var(--cs-border);
        }

        .ml-check-item:last-child {
            border-bottom: none;
        }

        .status-pass {
            color: #28a745;
        }

        .status-fail {
            color: #dc3545;
        }

        .status-partial {
            color: #ffc107;
        }
    </style>
</head>

<body class="bg-black">
    <!-- Layout Container -->
    <div id="app-container">
        <!-- Top Bar Container (Desktop) -->
        <div id="topbar-container" class="d-none d-lg-block"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- ML Header -->
                <div class="ml-header py-4 border-bottom border-secondary mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 class="text-white mb-2">
                                <i class="bi bi-robot text-info me-3"></i>ML Service Management
                            </h1>
                            <p class="text-muted mb-0">Monitor and control AI recommendation engine</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button class="btn btn-primary" id="force-update-btn">
                                <i class="bi bi-arrow-clockwise me-2"></i>Force Model Update
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ML Status -->
                <div class="mb-4">
                    <div class="ml-status-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-white mb-0">
                                <i class="bi bi-activity me-2"></i>Service Status
                            </h5>
                            <button class="btn btn-outline-primary btn-sm" id="refresh-status-btn">
                                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                            </button>
                        </div>
                        <div id="ml-status-content">
                            <!-- Status will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- ML Statistics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="ml-status-card">
                            <h5 class="text-white mb-3">
                                <i class="bi bi-database me-2"></i>Data Statistics
                            </h5>
                            <div id="data-stats">
                                <!-- Data stats will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="ml-status-card">
                            <h5 class="text-white mb-3">
                                <i class="bi bi-gear me-2"></i>Model Information
                            </h5>
                            <div id="model-info">
                                <!-- Model info will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="row">
                    <div class="col-12">
                        <div class="ml-status-card">
                            <h5 class="text-white mb-3">
                                <i class="bi bi-tools me-2"></i>Maintenance Actions
                            </h5>
                            <div class="d-flex flex-wrap gap-3">
                                <button class="btn btn-outline-warning" id="retrain-model-btn">
                                    <i class="bi bi-arrow-repeat me-2"></i>Retrain Models
                                </button>
                                <button class="btn btn-outline-info" id="sync-data-btn">
                                    <i class="bi bi-sync me-2"></i>Sync Data
                                </button>
                                <button class="btn btn-outline-danger" id="reset-cache-btn">
                                    <i class="bi bi-trash me-2"></i>Reset Cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation Container -->
        <div id="mobile-nav-container" class="d-lg-none"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core JavaScript -->
    <script src="/js/config.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/app.js"></script>

    <!-- Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('ðŸ¤– Loading Admin ML Page...');

            // Check admin access
            if (!CineScope.App.getCurrentUser().is_admin) {
                window.location.href = '/';
                return;
            }

            // Set page title
            CineScope.UI.updatePageTitle('ML Service Management');

            // Load initial status
            await loadMLStatus();

            // Load statistics
            await loadMLStats();

            // Initialize buttons
            initializeButtons();

            console.log('âœ… Admin ML page loaded');
        });

        async function loadMLStatus() {
            const content = document.getElementById('ml-status-content');

            content.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';

            try {
                const status = await CineScope.HTTP.admin.checkMLService();

                let statusHtml = `
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-circle-fill fs-3 me-3 status-${status.status}"></i>
                        <div>
                            <h6 class="text-white mb-0">Status: <span class="text-${status.status === 'healthy' ? 'success' : status.status === 'partial' ? 'warning' : 'danger'}">${status.status.toUpperCase()}</span></h6>
                            <p class="text-muted small mb-0">Last checked: ${new Date(status.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="ml-checks">
                        ${Object.entries(status.checks).map(([key, check]) => `
                            <div class="ml-check-item d-flex justify-content-between align-items-center">
                                <span class="text-white">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                                <span class="text-${check.status === 'pass' ? 'success' : 'danger'}">${check.status.toUpperCase()}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                content.innerHTML = statusHtml;
            } catch (error) {
                content.innerHTML = '<p class="text-danger text-center">Failed to load status</p>';
            }
        }

        async function loadMLStats() {
            const dataStats = document.getElementById('data-stats');
            const modelInfo = document.getElementById('model-info');

            dataStats.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';
            modelInfo.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';

            try {
                const stats = await CineScope.HTTP.admin.getMLStats();

                dataStats.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Total Content</span>
                        <span class="text-white">${stats.ml_service_stats.data_statistics.total_content}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Unique Users</span>
                        <span class="text-white">${stats.ml_service_stats.data_statistics.unique_users}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Interactions</span>
                        <span class="text-white">${stats.ml_service_stats.data_statistics.total_interactions}</span>
                    </div>
                `;

                modelInfo.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Model Version</span>
                        <span class="text-white">${stats.ml_service_stats.model_version || 'N/A'}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Last Trained</span>
                        <span class="text-white">${new Date(stats.ml_service_stats.last_trained).toLocaleString()}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Accuracy</span>
                        <span class="text-white">${stats.ml_service_stats.accuracy}%</span>
                    </div>
                `;
            } catch (error) {
                dataStats.innerHTML = '<p class="text-danger text-center">Failed to load</p>';
                modelInfo.innerHTML = '<p class="text-danger text-center">Failed to load</p>';
            }
        }

        function initializeButtons() {
            document.getElementById('force-update-btn').addEventListener('click', async function () {
                try {
                    await CineScope.HTTP.admin.updateMLService();
                    CineScope.UI.toast.success('Model update initiated');
                    await loadMLStatus();
                } catch (error) {
                    CineScope.UI.toast.error('Failed to update models');
                }
            });

            document.getElementById('retrain-model-btn').addEventListener('click', function () {
                CineScope.UI.toast.success('Model retraining started');
            });

            document.getElementById('sync-data-btn').addEventListener('click', function () {
                CineScope.UI.toast.success('Data sync initiated');
            });

            document.getElementById('reset-cache-btn').addEventListener('click', function () {
                if (confirm('Reset ML cache? This may affect recommendations temporarily.')) {
                    CineScope.UI.toast.success('Cache reset successful');
                }
            });

            document.getElementById('refresh-status-btn').addEventListener('click', loadMLStatus);
        }
    </script>
</body>

</html>