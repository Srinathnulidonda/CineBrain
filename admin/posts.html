<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Recommendations - CineScope</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .create-recommendation {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .recommendation-form {
            display: grid;
            gap: var(--spacing-md);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .content-search {
            position: relative;
        }

        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .search-result-item:hover {
            background: var(--card-bg);
        }

        .search-result-poster {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

        .recommendations-list {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
        }

        .recommendation-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: var(--spacing-md);
        }

        .recommendation-poster {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 0.375rem;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-weight: 600;
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--text-primary);
        }

        .recommendation-type {
            display: inline-block;
            background: var(--accent-blue);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 1rem;
            font-size: 0.75rem;
            margin-bottom: var(--spacing-sm);
        }

        .recommendation-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-sm);
        }

        .recommendation-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .recommendation-actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .telegram-status {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .telegram-connected {
            color: var(--success);
        }

        .telegram-disconnected {
            color: var(--error);
        }

        @media (max-width: 767px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .recommendation-item {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div data-include="header"></div>

    <div class="content-browser-container">
        <aside class="admin-sidebar">
            <h3>Admin Panel</h3>
            <ul class="admin-nav">
                <li><a href="/admin/dashboard">üìä Dashboard</a></li>
                <li><a href="/admin/content-browser">üé¨ Content Browser</a></li>
                <li><a href="/admin/posts" class="active">üìù Recommendations</a></li>
                <li><a href="/admin/analytics">üìà Analytics</a></li>
            </ul>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h1>Admin Recommendations</h1>
                <p>Create and manage content recommendations</p>
            </div>

            <div class="telegram-status" id="telegram-status">
                <h3>üì± Telegram Integration</h3>
                <p class="telegram-disconnected">Status: Checking connection...</p>
            </div>

            <div class="create-recommendation">
                <h3>Create New Recommendation</h3>
                <form class="recommendation-form" id="recommendation-form">
                    <div class="form-row">
                        <div class="form-group content-search">
                            <label for="content-search" class="form-label">Search Content</label>
                            <input type="text" id="content-search" class="form-input"
                                placeholder="Search for movie, TV show, or anime..." required>
                            <div class="search-results-dropdown" id="search-dropdown">
                                <!-- Search results will appear here -->
                            </div>
                            <input type="hidden" id="selected-content-id" required>
                        </div>

                        <div class="form-group">
                            <label for="recommendation-type" class="form-label">Recommendation Type</label>
                            <select id="recommendation-type" class="form-input" required>
                                <option value="">Select type...</option>
                                <option value="admin_choice">Admin's Choice</option>
                                <option value="trending">Trending</option>
                                <option value="critics_choice">Critics' Choice</option>
                                <option value="hidden_gem">Hidden Gem</option>
                                <option value="must_watch">Must Watch</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="recommendation-description" class="form-label">Description / Why you recommend
                            it</label>
                        <textarea id="recommendation-description" class="form-input" rows="4"
                            placeholder="Explain why this content is worth watching..." required></textarea>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Create Recommendation</button>
                    </div>
                </form>
            </div>

            <div class="recommendations-list">
                <h3>Recent Recommendations</h3>
                <div id="recommendations-container">
                    <!-- Recommendations will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class AdminRecommendations {
            constructor() {
                this.selectedContent = null;
                this.searchTimeout = null;
                this.recommendations = [];
                this.init();
            }

            async init() {
                if (!app.token || !app.user?.is_admin) {
                    window.location.href = '/login';
                    return;
                }

                this.setupEventListeners();
                await this.loadRecommendations();
                this.checkTelegramStatus();
            }

            setupEventListeners() {
                // Content search
                const contentSearch = document.getElementById('content-search');
                contentSearch.addEventListener('input', (e) => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.searchContent(e.target.value);
                    }, 300);
                });

                // Form submission
                const form = document.getElementById('recommendation-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createRecommendation();
                });

                // Click outside to close dropdown
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.content-search')) {
                        this.hideSearchDropdown();
                    }
                });
            }

            async searchContent(query) {
                if (!query.trim()) {
                    this.hideSearchDropdown();
                    return;
                }

                try {
                    const data = await app.apiCall(`/search?query=${encodeURIComponent(query)}&limit=5`);
                    this.showSearchResults(data.results || []);
                } catch (error) {
                    console.error('Content search failed:', error);
                }
            }

            showSearchResults(results) {
                const dropdown = document.getElementById('search-dropdown');

                if (results.length === 0) {
                    dropdown.innerHTML = '<div style="padding: var(--spacing-md); color: var(--text-muted);">No results found</div>';
                } else {
                    dropdown.innerHTML = results.map(item => `
                        <div class="search-result-item" onclick="adminRecommendations.selectContent(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                            <img src="${item.poster_path || '/assets/placeholder.jpg'}" alt="${item.title}" class="search-result-poster">
                            <div>
                                <div style="font-weight: 600;">${item.title}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${item.content_type?.toUpperCase()} ‚Ä¢ ${item.rating ? item.rating.toFixed(1) : 'N/A'} ‚≠ê</div>
                            </div>
                        </div>
                    `).join('');
                }

                dropdown.style.display = 'block';
            }

            selectContent(content) {
                this.selectedContent = content;
                document.getElementById('content-search').value = content.title;
                document.getElementById('selected-content-id').value = content.id;
                this.hideSearchDropdown();
            }

            hideSearchDropdown() {
                const dropdown = document.getElementById('search-dropdown');
                dropdown.style.display = 'none';
            }

            async createRecommendation() {
                try {
                    app.showLoading('Creating recommendation...');

                    const formData = {
                        content_id: document.getElementById('selected-content-id').value,
                        recommendation_type: document.getElementById('recommendation-type').value,
                        description: document.getElementById('recommendation-description').value
                    };

                    const response = await app.apiCall('/admin/recommendations', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });

                    if (response.message) {
                        app.showNotification(
                            `Recommendation created! ${response.telegram_sent ? 'Sent to Telegram ‚úÖ' : 'Telegram failed ‚ùå'}`,
                            'success'
                        );

                        // Reset form
                        document.getElementById('recommendation-form').reset();
                        this.selectedContent = null;

                        // Reload recommendations
                        await this.loadRecommendations();
                    }

                } catch (error) {
                    console.error('Failed to create recommendation:', error);
                    app.showNotification('Failed to create recommendation', 'error');
                } finally {
                    app.hideLoading();
                }
            }

            async loadRecommendations() {
                try {
                    const data = await app.apiCall('/admin/recommendations?page=1&per_page=10');
                    this.recommendations = data.recommendations || [];
                    this.renderRecommendations();
                } catch (error) {
                    console.error('Failed to load recommendations:', error);
                }
            }

            renderRecommendations() {
                const container = document.getElementById('recommendations-container');

                if (this.recommendations.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
                            <h4>No recommendations yet</h4>
                            <p>Create your first recommendation above!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <img src="${rec.content.poster_path || '/assets/placeholder.jpg'}" alt="${rec.content.title}" class="recommendation-poster">
                        <div class="recommendation-content">
                            <h4 class="recommendation-title">${rec.content.title}</h4>
                            <span class="recommendation-type">${rec.recommendation_type.replace('_', ' ').toUpperCase()}</span>
                            <p class="recommendation-description">${rec.description}</p>
                            <div class="recommendation-meta">
                                By ${rec.admin_name} ‚Ä¢ ${new Date(rec.created_at).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="recommendation-actions">
                            <button class="btn btn-sm btn-secondary" onclick="adminRecommendations.editRecommendation(${rec.id})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="adminRecommendations.deleteRecommendation(${rec.id})">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            checkTelegramStatus() {
                // Mock telegram status check
                const statusElement = document.getElementById('telegram-status');
                const statusText = statusElement.querySelector('p');

                // Simulate checking status
                setTimeout(() => {
                    const isConnected = Math.random() > 0.3; // 70% chance of being connected

                    if (isConnected) {
                        statusText.className = 'telegram-connected';
                        statusText.textContent = 'Status: Connected ‚úÖ - Recommendations will be automatically posted to Telegram';
                    } else {
                        statusText.className = 'telegram-disconnected';
                        statusText.textContent = 'Status: Disconnected ‚ùå - Check Telegram bot configuration';
                    }
                }, 1000);
            }

            editRecommendation(id) {
                // Implementation for editing recommendations
                app.showNotification('Edit functionality coming soon', 'info');
            }

            async deleteRecommendation(id) {
                if (!confirm('Are you sure you want to delete this recommendation?')) {
                    return;
                }

                try {
                    // This would be an API call to delete the recommendation
                    // await app.apiCall(`/admin/recommendations/${id}`, { method: 'DELETE' });

                    app.showNotification('Recommendation deleted', 'success');
                    await this.loadRecommendations();
                } catch (error) {
                    console.error('Failed to delete recommendation:', error);
                    app.showNotification('Failed to delete recommendation', 'error');
                }
            }
        }

        let adminRecommendations;
        document.addEventListener('DOMContentLoaded', () => {
            adminRecommendations = new AdminRecommendations();
        });
    </script>
</body>

</html>