<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Posts - CineScope</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/responsive.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    .post-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      position: relative;
    }
    
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: var(--space-md);
    }
    
    .post-meta {
      display: flex;
      gap: var(--space-md);
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .post-content {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: var(--space-lg);
      align-items: start;
    }
    
    .post-poster {
      width: 150px;
      height: 225px;
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .post-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .telegram-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-hover);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
    }
    
    .telegram-success {
      background: var(--accent-green);
      color: white;
    }
    
    @media (max-width: 768px) {
      .post-content {
        grid-template-columns: 1fr;
      }
      
      .post-poster {
        width: 100px;
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" style="display: none;">
    <div class="spinner spinner-lg"></div>
  </div>
  
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container navbar-content">
      <a href="/" class="navbar-brand gradient-text">CineScope Admin</a>
      
      <button class="mobile-menu-toggle lg:hidden">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="navbar-menu hidden md:flex">
        <a href="/" class="navbar-link">Back to Site</a>
        <div class="user-menu"></div>
      </div>
    </div>
  </nav>
  
  <!-- Admin Layout -->
  <div class="admin-layout" style="margin-top: 60px;">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav>
        <a href="/admin/dashboard.html" class="admin-nav-item">
          <i class="fas fa-tachometer-alt mr-sm"></i> Dashboard
        </a>
        <a href="/admin/content-browser.html" class="admin-nav-item">
          <i class="fas fa-search mr-sm"></i> Content Browser
        </a>
        <a href="/admin/posts.html" class="admin-nav-item active">
          <i class="fas fa-bullhorn mr-sm"></i> Admin Posts
        </a>
        <a href="/admin/analytics.html" class="admin-nav-item">
          <i class="fas fa-chart-bar mr-sm"></i> Analytics
        </a>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="admin-content">
      <div class="flex-between mb-xl">
        <h1>Admin Recommendations</h1>
        <a href="/admin/content-browser.html" class="btn btn-primary">
          <i class="fas fa-plus mr-sm"></i> Create New Post
        </a>
      </div>
      
      <!-- Stats -->
      <div class="grid gap-md mb-xl" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="stat-card">
          <h3 class="text-secondary text-sm mb-sm">Total Posts</h3>
          <div class="text-2xl font-bold" id="total-posts">0</div>
        </div>
        
        <div class="stat-card">
          <h3 class="text-secondary text-sm mb-sm">This Month</h3>
          <div class="text-2xl font-bold" id="month-posts">0</div>
        </div>
        
        <div class="stat-card">
          <h3 class="text-secondary text-sm mb-sm">Telegram Sent</h3>
          <div class="text-2xl font-bold" id="telegram-sent">0</div>
        </div>
        
        <div class="stat-card">
          <h3 class="text-secondary text-sm mb-sm">Active Posts</h3>
          <div class="text-2xl font-bold" id="active-posts">0</div>
        </div>
      </div>
      
      <!-- Filter Tabs -->
      <div class="tabs mb-lg">
        <div class="tab active" onclick="filterPosts('all')">All Posts</div>
        <div class="tab" onclick="filterPosts('admin_choice')">Admin's Choice</div>
        <div class="tab" onclick="filterPosts('trending')">Trending</div>
        <div class="tab" onclick="filterPosts('critics_choice')">Critics' Choice</div>
      </div>
      
      <!-- Posts List -->
      <div id="posts-list">
        <div class="text-center p-xl">
          <div class="spinner mx-auto"></div>
          <p class="text-secondary mt-md">Loading posts...</p>
        </div>
      </div>
      
      <!-- Pagination -->
      <div id="pagination" class="flex-center gap-md mt-xl" style="display: none;">
        <button class="btn btn-ghost" onclick="changePage(-1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span id="page-info">Page 1</span>
        <button class="btn btn-ghost" onclick="changePage(1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </main>
  </div>
  
  <!-- Edit Post Modal -->
  <div id="edit-post-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Edit Recommendation</h3>
        <button class="modal-close" onclick="closeModal('edit-post-modal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="edit-post-form">
          <input type="hidden" name="post_id">
          
          <div class="form-group">
            <label class="form-label">Recommendation Type</label>
            <select class="form-select" name="recommendation_type">
              <option value="admin_choice">Admin's Choice</option>
              <option value="trending">Trending</option>
              <option value="critics_choice">Critics' Choice</option>
              <option value="hidden_gem">Hidden Gem</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" name="description" rows="4"></textarea>
          </div>
          
          <div class="form-group">
            <label class="flex items-center gap-sm">
              <input type="checkbox" name="is_active">
              <span>Active</span>
            </label>
          </div>
          
          <div class="flex gap-md">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('edit-post-modal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container"></div>
  
  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script>
    // Check admin authentication
    if (!AppState.user || !AppState.user.is_admin) {
      window.location.href = '/';
    }
    
    let currentFilter = 'all';
    let currentPage = 1;
    let allPosts = [];
    
    // Load admin posts
    async function loadPosts() {
      try {
        const response = await fetch(`${API_BASE}/admin/recommendations?page=${currentPage}`, {
          headers: TokenManager.getHeaders()
        });
        
        const data = await response.json();
        
        // Update stats
        document.getElementById('total-posts').textContent = data.total || '0';
        document.getElementById('active-posts').textContent = data.recommendations?.filter(r => r.is_active !== false).length || '0';
        document.getElementById('telegram-sent').textContent = data.recommendations?.length || '0';
        document.getElementById('month-posts').textContent = data.recommendations?.filter(r => {
          const date = new Date(r.created_at);
          const now = new Date();
          return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }).length || '0';
        
        allPosts = data.recommendations || [];
        renderPosts();
        
        // Update pagination
        document.getElementById('page-info').textContent = `Page ${data.current_page || 1} of ${data.pages || 1}`;
        document.getElementById('pagination').style.display = data.pages > 1 ? 'flex' : 'none';
        
      } catch (error) {
        console.error('Failed to load posts:', error);
        document.getElementById('posts-list').innerHTML = '<div class="text-center text-secondary p-xl">Failed to load posts</div>';
      }
    }
    
    // Render posts
    function renderPosts() {
      const container = document.getElementById('posts-list');
      
      let filteredPosts = allPosts;
      if (currentFilter !== 'all') {
        filteredPosts = allPosts.filter(post => post.recommendation_type === currentFilter);
      }
      
      if (filteredPosts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fas fa-bullhorn"></i>
            </div>
            <h3 class="empty-state-title">No posts found</h3>
            <p class="empty-state-description">Create your first admin recommendation</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredPosts.map(post => `
        <div class="post-card">
          <div class="post-header">
            <div>
              <h3 class="mb-sm">${post.content.title}</h3>
              <div class="post-meta">
                <span><i class="fas fa-user"></i> ${post.admin_name}</span>
                <span><i class="fas fa-calendar"></i> ${new Date(post.created_at).toLocaleDateString()}</span>
                <span class="tag tag-primary">${post.recommendation_type.replace('_', ' ')}</span>
                ${post.telegram_sent !== false ? '<span class="telegram-status telegram-success"><i class="fab fa-telegram"></i> Sent</span>' : ''}
              </div>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-ghost btn-sm" onclick='editPost(${JSON.stringify(post).replace(/'/g, "&apos;")}'>
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-ghost btn-sm text-red" onclick="deletePost(${post.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="post-content">
            <div class="post-poster">
              ${post.content.poster_path ? `<img src="${post.content.poster_path}" alt="${post.content.title}">` : '<div class="bg-hover h-full"></div>'}
            </div>
            
            <div>
              <p class="mb-md">${post.description}</p>
              
              <div class="flex gap-md text-sm text-secondary">
                <span><i class="fas fa-star text-yellow"></i> ${post.content.rating || 'N/A'}</span>
                <span>${post.content.content_type}</span>
                <span><i class="fas fa-eye"></i> View on site</span>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Filter posts
    function filterPosts(filter) {
      currentFilter = filter;
      
      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      renderPosts();
    }
    
    // Edit post
    function editPost(post) {
      const form = document.getElementById('edit-post-form');
      form.post_id.value = post.id;
      form.recommendation_type.value = post.recommendation_type;
      form.description.value = post.description;
      form.is_active.checked = post.is_active !== false;
      
      document.getElementById('edit-post-modal').classList.add('active');
    }
    
    // Delete post
    async function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post?')) return;
      
      try {
        // In a real app, this would call the delete API
        showToast('Post deleted successfully', 'success');
        allPosts = allPosts.filter(p => p.id !== postId);
        renderPosts();
      } catch (error) {
        showToast('Failed to delete post', 'error');
      }
    }
    
    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // Edit form submission
    document.getElementById('edit-post-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // In a real app, this would update the post via API
      showToast('Post updated successfully', 'success');
      closeModal('edit-post-modal');
      loadPosts();
    });
    
    // Pagination
    function changePage(direction) {
      currentPage = Math.max(1, currentPage + direction);
      loadPosts();
    }
    
    // Initialize
    updateAuthUI();
    loadPosts();
  </script>
</body>
</html>