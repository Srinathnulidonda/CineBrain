<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Posts - CineScope Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #e50914;
            --secondary: #221f1f;
            --dark: #141414;
            --light: #f5f5f1;
        }

        body {
            background: var(--dark);
            color: var(--light);
            font-family: 'Arial', sans-serif;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--secondary) 0%, var(--dark) 100%);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: 8px;
            margin: 4px 0;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background: var(--primary);
            color: white;
        }

        .post-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .type-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .type-admin_choice {
            background: rgba(147, 51, 234, 0.2);
            color: #a855f7;
        }

        .type-trending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .type-popular {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .type-critics_choice {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(229, 9, 20, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-black bg-opacity-90 backdrop-blur-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-red-600">CineScope Admin</h1>
                    <span class="text-gray-400">Manage Posts</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span class="text-gray-300">Welcome, <span id="adminName">Admin</span></span>
                    <button onclick="logout()" class="text-white hover:text-red-500 transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="fixed left-0 top-16 bottom-0 w-64 sidebar z-40 overflow-y-auto">
        <div class="p-4">
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item">
                    üìä Dashboard
                </a>
                <a href="content-browser.html" class="nav-item">
                    üîç Browse Content
                </a>
                <a href="#" class="nav-item" style="background: var(--primary); color: white;">
                    üìù Manage Posts
                </a>
                <a href="analytics.html" class="nav-item">
                    üìà Analytics
                </a>
                <a href="../dashboard.html" class="nav-item">
                    üë§ User View
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 pt-16 min-h-screen">
        <div class="p-6">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">Manage Posts</h1>
                <p class="text-gray-400">View, edit, and manage all admin recommendations</p>
            </div>

            <!-- Stats Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="admin-card p-6 text-center">
                    <div class="text-2xl font-bold text-red-500" id="totalPosts">0</div>
                    <div class="text-gray-400 text-sm">Total Posts</div>
                </div>
                <div class="admin-card p-6 text-center">
                    <div class="text-2xl font-bold text-green-500" id="activePosts">0</div>
                    <div class="text-gray-400 text-sm">Active Posts</div>
                </div>
                <div class="admin-card p-6 text-center">
                    <div class="text-2xl font-bold text-yellow-500" id="thisWeekPosts">0</div>
                    <div class="text-gray-400 text-sm">This Week</div>
                </div>
                <div class="admin-card p-6 text-center">
                    <div class="text-2xl font-bold text-blue-500" id="myPosts">0</div>
                    <div class="text-gray-400 text-sm">My Posts</div>
                </div>
            </div>

            <!-- Filters and Actions -->
            <div class="admin-card p-6 mb-8">
                <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                    <div class="flex flex-wrap gap-4">
                        <select id="typeFilter" class="form-input">
                            <option value="">All Types</option>
                            <option value="admin_choice">Admin's Choice</option>
                            <option value="trending">Trending</option>
                            <option value="popular">Popular</option>
                            <option value="critics_choice">Critics' Choice</option>
                        </select>
                        
                        <select id="statusFilter" class="form-input">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        
                        <select id="adminFilter" class="form-input">
                            <option value="">All Admins</option>
                            <option value="me">My Posts Only</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="refreshPosts()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                            üîÑ Refresh
                        </button>
                        <button onclick="window.location.href='content-browser.html'" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                            ‚ûï Create New Post
                        </button>
                    </div>
                </div>
            </div>

            <!-- Posts List -->
            <div class="admin-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">Admin Recommendations</h2>
                    <div id="postsCount" class="text-gray-400"></div>
                </div>
                
                <div id="postsList">
                    <div class="flex justify-center py-12">
                        <div class="loading"></div>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="flex justify-center mt-8 space-x-2 hidden">
                    <!-- Pagination buttons will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6">Edit Recommendation</h3>
            
            <form id="editPostForm">
                <input type="hidden" id="editPostId">
                
                <div class="flex items-start space-x-6 mb-6">
                    <img id="editPostPoster" src="" alt="" class="w-24 h-36 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 id="editPostTitle" class="text-xl font-bold mb-2"></h4>
                        <p id="editPostOverview" class="text-gray-300 text-sm"></p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-300 font-medium mb-2">Recommendation Type</label>
                    <select id="editRecommendationType" class="form-input w-full">
                        <option value="admin_choice">Admin's Choice</option>
                        <option value="trending">Trending</option>
                        <option value="popular">Popular</option>
                        <option value="critics_choice">Critics' Choice</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-300 font-medium mb-2">Description</label>
                    <textarea 
                        id="editRecommendationDescription" 
                        class="form-input w-full h-24 resize-none"
                        required
                    ></textarea>
                </div>

                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="editIsActive" class="mr-2">
                        <span class="text-gray-300">Active (visible to users)</span>
                    </label>
                </div>

                <div class="flex space-x-4">
                    <button 
                        type="submit" 
                        class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition font-medium"
                    >
                        üíæ Save Changes
                    </button>
                    <button 
                        type="button" 
                        onclick="closeEditModal()"
                        class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg hover:bg-gray-700 transition font-medium"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://backend-app-970m.onrender.com/api';
        
        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentPage = 1;
        let totalPages = 1;
        let posts = [];

        // Authentication check
        function checkAuth() {
            authToken = sessionStorage.getItem('authToken');
            const userStr = sessionStorage.getItem('currentUser');
            
            if (!authToken || !userStr) {
                window.location.href = '../login.html';
                return false;
            }
            
            currentUser = JSON.parse(userStr);
            
            if (!currentUser.is_admin) {
                window.location.href = '../dashboard.html';
                return false;
            }
            
            document.getElementById('adminName').textContent = currentUser.username;
            return true;
        }

        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            };
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '../login.html';
        }

        // Load posts
        async function loadPosts(page = 1) {
            currentPage = page;
            showLoading();

            try {
                const params = new URLSearchParams({
                    page: page.toString(),
                    per_page: '10'
                });

                // Add filters
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const adminFilter = document.getElementById('adminFilter').value;

                if (typeFilter) params.append('type', typeFilter);
                if (statusFilter) params.append('status', statusFilter);
                if (adminFilter === 'me') params.append('admin_id', currentUser.id);

                const response = await fetch(`${API_BASE}/admin/recommendations?${params}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    posts = data.recommendations || [];
                    totalPages = data.pages || 1;
                    
                    displayPosts(posts);
                    updatePagination();
                    updateStats();
                } else {
                    showError('Failed to load posts');
                }
            } catch (error) {
                console.error('Load posts error:', error);
                showError('Failed to load posts');
            }
        }

        function showLoading() {
            document.getElementById('postsList').innerHTML = `
                <div class="flex justify-center py-12">
                    <div class="loading"></div>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('postsList').innerHTML = `
                <div class="text-center text-red-500 py-12">
                    ${message}
                </div>
            `;
        }

        function displayPosts(posts) {
            const container = document.getElementById('postsList');
            document.getElementById('postsCount').textContent = `${posts.length} posts`;

            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-12">
                        No posts found. Try adjusting your filters or create a new post.
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const statusClass = post.is_active ? 'status-active' : 'status-inactive';
                const statusText = post.is_active ? 'Active' : 'Inactive';
                const typeClass = `type-${post.recommendation_type}`;
                
                return `
                    <div class="post-card">
                        <div class="flex items-start space-x-4">
                            <img 
                                src="${post.content.poster_path ? `https://image.tmdb.org/t/p/w185${post.content.poster_path}` : '/api/placeholder/90/135'}" 
                                alt="${post.content.title}" 
                                class="w-16 h-24 object-cover rounded-lg"
                            >
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <h3 class="text-lg font-bold text-white">${post.content.title}</h3>
                                        <p class="text-gray-400 text-sm">by ${post.admin_name} ‚Ä¢ ${new Date(post.created_at).toLocaleDateString()}</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                        <span class="type-badge ${typeClass}">${post.recommendation_type.replace('_', ' ')}</span>
                                    </div>
                                </div>
                                
                                <p class="text-gray-300 mb-4">${post.description}</p>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                                        <span>‚≠ê ${post.content.rating || 'N/A'}</span>
                                        <span>üé≠ ${post.content.content_type?.toUpperCase() || 'MOVIE'}</span>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button 
                                            onclick="editPost(${post.id})"
                                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition"
                                        >
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button 
                                            onclick="togglePostStatus(${post.id}, ${!post.is_active})"
                                            class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition"
                                        >
                                            ${post.is_active ? 'üîí Deactivate' : 'üîì Activate'}
                                        </button>
                                        <button 
                                            onclick="deletePost(${post.id})"
                                            class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition"
                                        >
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');
            
            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="loadPosts(${currentPage - 1})" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition">
                        Previous
                    </button>
                `;
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                paginationHTML += `
                    <button 
                        onclick="loadPosts(${i})" 
                        class="px-3 py-2 rounded transition ${isActive ? 'bg-red-600 text-white' : 'bg-gray-700 text-white hover:bg-gray-600'}"
                    >
                        ${i}
                    </button>
                `;
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="loadPosts(${currentPage + 1})" class="px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition">
                        Next
                    </button>
                `;
            }

            pagination.innerHTML = paginationHTML;
        }

        async function updateStats() {
            // Calculate stats from loaded posts
            const totalPosts = posts.length;
            const activePosts = posts.filter(p => p.is_active).length;
            const thisWeekPosts = posts.filter(p => {
                const postDate = new Date(p.created_at);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return postDate >= weekAgo;
            }).length;
            const myPosts = posts.filter(p => p.admin_name === currentUser.username).length;

            document.getElementById('totalPosts').textContent = totalPosts;
            document.getElementById('activePosts').textContent = activePosts;
            document.getElementById('thisWeekPosts').textContent = thisWeekPosts;
            document.getElementById('myPosts').textContent = myPosts;
        }

        // Post actions
        function editPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            document.getElementById('editPostId').value = post.id;
            document.getElementById('editPostTitle').textContent = post.content.title;
            document.getElementById('editPostOverview').textContent = post.content.overview || 'No description available';
            document.getElementById('editPostPoster').src = post.content.poster_path 
                ? `https://image.tmdb.org/t/p/w185${post.content.poster_path}` 
                : '/api/placeholder/150/225';
            document.getElementById('editRecommendationType').value = post.recommendation_type;
            document.getElementById('editRecommendationDescription').value = post.description;
            document.getElementById('editIsActive').checked = post.is_active;

            document.getElementById('editPostModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editPostModal').classList.add('hidden');
        }

        document.getElementById('editPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const postId = document.getElementById('editPostId').value;
            const recommendationType = document.getElementById('editRecommendationType').value;
            const description = document.getElementById('editRecommendationDescription').value;
            const isActive = document.getElementById('editIsActive').checked;

            try {
                const response = await fetch(`${API_BASE}/admin/recommendations/${postId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        recommendation_type: recommendationType,
                        description: description,
                        is_active: isActive
                    })
                });

                if (response.ok) {
                    alert('Post updated successfully!');
                    closeEditModal();
                    loadPosts(currentPage);
                } else {
                    alert('Failed to update post');
                }
            } catch (error) {
                console.error('Update post error:', error);
                alert('Failed to update post');
            }
        });

        async function togglePostStatus(postId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/admin/recommendations/${postId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        is_active: newStatus
                    })
                });

                if (response.ok) {
                    loadPosts(currentPage);
                } else {
                    alert('Failed to update post status');
                }
            } catch (error) {
                console.error('Toggle status error:', error);
                alert('Failed to update post status');
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/recommendations/${postId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    alert('Post deleted successfully!');
                    loadPosts(currentPage);
                } else {
                    alert('Failed to delete post');
                }
            } catch (error) {
                console.error('Delete post error:', error);
                alert('Failed to delete post');
            }
        }

        function refreshPosts() {
            loadPosts(currentPage);
        }

        // Setup filters
        function setupFilters() {
            document.getElementById('typeFilter').addEventListener('change', () => loadPosts(1));
            document.getElementById('statusFilter').addEventListener('change', () => loadPosts(1));
            document.getElementById('adminFilter').addEventListener('change', () => loadPosts(1));
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
            }
        });

        // Initialize page
        function initializePage() {
            if (!checkAuth()) return;
            
            setupFilters();
            loadPosts();
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>