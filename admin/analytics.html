<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <script>document.write('<script src="/includes/head.html"><\/script>');</script>
    <title>Analytics | Admin | CineScope</title>
</head>
<body>
    <div data-include="header"></div>
    
    <main class="container py-8 pt-24">
        <section class="admin-header mb-8">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-chart-bar text-purple-500 mr-3"></i>
                Platform <span class="text-gradient">Analytics</span>
            </h1>
            <p class="text-gray-400 text-lg">Monitor user engagement and content performance</p>
        </section>

        <!-- Key Metrics Overview -->
        <section class="metrics-overview mb-12">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="metric-card">
                    <div class="metric-icon bg-blue-500">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="totalUsers">0</div>
                        <div class="metric-label">Total Users</div>
                        <div class="metric-change positive" id="userChange">+0%</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon bg-green-500">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="totalViews">0</div>
                        <div class="metric-label">Total Views</div>
                        <div class="metric-change positive" id="viewsChange">+0%</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon bg-purple-500">
                        <i class="fas fa-film"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="totalContent">0</div>
                        <div class="metric-label">Content Items</div>
                        <div class="metric-change positive" id="contentChange">+0%</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon bg-orange-500">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="activeUsers">0</div>
                        <div class="metric-label">Active Users (7d)</div>
                        <div class="metric-change positive" id="activeChange">+0%</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="charts-section mb-12">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- User Growth Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">User Growth</h3>
                        <div class="chart-controls">
                            <select id="userGrowthPeriod" class="chart-select" onchange="updateUserGrowthChart()">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>

                <!-- Content Performance Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Content Interactions</h3>
                        <div class="chart-controls">
                            <select id="contentPeriod" class="chart-select" onchange="updateContentChart()">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="contentChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Tables -->
        <section class="data-tables mb-12">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Popular Content -->
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Most Popular Content</h3>
                        <button class="btn btn-ghost btn-sm" onclick="refreshPopularContent()">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="table-container">
                        <div id="popularContentTable">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Popular Genres -->
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">Popular Genres</h3>
                        <button class="btn btn-ghost btn-sm" onclick="refreshGenreData()">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="table-container">
                        <div id="genresTable">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activity Feed -->
        <section class="activity-feed mb-12">
            <div class="feed-header">
                <h2 class="text-2xl font-bold">Recent Activity</h2>
                <div class="feed-controls">
                    <select id="activityFilter" class="filter-select" onchange="filterActivity()">
                        <option value="all">All Activity</option>
                        <option value="views">Views</option>
                        <option value="favorites">Favorites</option>
                        <option value="watchlist">Watchlist</option>
                        <option value="ratings">Ratings</option>
                    </select>
                </div>
            </div>
            <div class="activity-timeline">
                <div id="activityList">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </section>

        <!-- Export & Reports -->
        <section class="reports-section">
            <div class="reports-card">
                <div class="reports-header">
                    <h3 class="text-xl font-bold">Export & Reports</h3>
                    <p class="text-gray-400">Generate detailed reports and export data</p>
                </div>
                <div class="reports-actions">
                    <button class="btn btn-secondary" onclick="exportUserData()">
                        <i class="fas fa-users mr-2"></i>
                        Export User Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportContentData()">
                        <i class="fas fa-film mr-2"></i>
                        Export Content Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportAnalytics()">
                        <i class="fas fa-chart-line mr-2"></i>
                        Export Analytics
                    </button>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-file-pdf mr-2"></i>
                        Generate Report
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div data-include="footer"></div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let userGrowthChart, contentChart;
        let analyticsData = {};

        class AnalyticsManager {
            constructor() {
                this.init();
            }

            async init() {
                if (!AuthManager.requireAdmin()) return;

                await this.loadAnalyticsData();
                this.initializeCharts();
                await this.loadPopularContent();
                await this.loadGenreData();
                await this.loadActivityFeed();
            }

            async loadAnalyticsData() {
                try {
                    analyticsData = await APIService.getAnalytics();
                    this.updateMetrics();
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    ContentManager.showToast('Failed to load analytics data', 'error');
                }
            }

            updateMetrics() {
                document.getElementById('totalUsers').textContent = analyticsData.total_users || 0;
                document.getElementById('totalContent').textContent = analyticsData.total_content || 0;
                document.getElementById('totalViews').textContent = analyticsData.total_interactions || 0;
                document.getElementById('activeUsers').textContent = analyticsData.active_users_last_week || 0;

                // Update percentage changes (mock data)
                document.getElementById('userChange').textContent = '+12%';
                document.getElementById('viewsChange').textContent = '+24%';
                document.getElementById('contentChange').textContent = '+8%';
                document.getElementById('activeChange').textContent = '+15%';
            }

            initializeCharts() {
                this.createUserGrowthChart();
                this.createContentChart();
            }

            createUserGrowthChart() {
                const ctx = document.getElementById('userGrowthChart').getContext('2d');
                
                // Mock data for user growth
                const labels = [];
                const data = [];
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 50) + (analyticsData.total_users || 100) + i * 2);
                }

                userGrowthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Users',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#374151'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#374151'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            }
                        }
                    }
                });
            }

            createContentChart() {
                const ctx = document.getElementById('contentChart').getContext('2d');
                
                // Mock data for content interactions
                const data = {
                    labels: ['Views', 'Favorites', 'Watchlist', 'Ratings', 'Searches'],
                    datasets: [{
                        data: [65, 25, 45, 15, 35],
                        backgroundColor: [
                            '#3b82f6',
                            '#ef4444',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                };

                contentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#d1d5db',
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            }

            async loadPopularContent() {
                const container = document.getElementById('popularContentTable');
                
                try {
                    const popularContent = analyticsData.popular_content || [];
                    
                    if (popularContent.length > 0) {
                        const tableHTML = `
                            <div class="data-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Interactions</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${popularContent.map(item => `
                                            <tr>
                                                <td>${item.title}</td>
                                                <td>${item.interactions}</td>
                                                <td><span class="content-type-badge">${item.type || 'Movie'}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        container.innerHTML = tableHTML;
                    } else {
                        container.innerHTML = '<p class="text-center text-gray-400 py-8">No data available</p>';
                    }
                } catch (error) {
                    container.innerHTML = '<p class="text-center text-red-400 py-8">Failed to load data</p>';
                }
            }

            async loadGenreData() {
                const container = document.getElementById('genresTable');
                
                try {
                    const genreData = analyticsData.popular_genres || [];
                    
                    if (genreData.length > 0) {
                        const tableHTML = `
                            <div class="data-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Genre</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${genreData.map((item, index) => {
                                            const total = genreData.reduce((sum, g) => sum + g.count, 0);
                                            const percentage = ((item.count / total) * 100).toFixed(1);
                                            return `
                                                <tr>
                                                    <td>${item.genre}</td>
                                                    <td>${item.count}</td>
                                                    <td>
                                                        <div class="percentage-bar">
                                                            <div class="percentage-fill" style="width: ${percentage}%"></div>
                                                            <span class="percentage-text">${percentage}%</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        container.innerHTML = tableHTML;
                    } else {
                        container.innerHTML = '<p class="text-center text-gray-400 py-8">No genre data available</p>';
                    }
                } catch (error) {
                    container.innerHTML = '<p class="text-center text-red-400 py-8">Failed to load genre data</p>';
                }
            }

            async loadActivityFeed() {
                const container = document.getElementById('activityList');
                
                // Mock activity data
                const activities = [
                    { type: 'view', user: 'User123', content: 'The Dark Knight', time: '5 minutes ago' },
                    { type: 'favorite', user: 'MovieFan', content: 'Inception', time: '12 minutes ago' },
                    { type: 'watchlist', user: 'CineLover', content: 'Interstellar', time: '25 minutes ago' },
                    { type: 'rating', user: 'Reviewer99', content: 'The Matrix', time: '1 hour ago', rating: 5 },
                    { type: 'view', user: 'ActionFan', content: 'Avengers: Endgame', time: '2 hours ago' }
                ];

                const activitiesHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon activity-${activity.type}">
                            <i class="fas fa-${this.getActivityIcon(activity.type)}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${activity.user}</strong> ${this.getActivityText(activity)}
                            </div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = activitiesHTML;
            }

            getActivityIcon(type) {
                const icons = {
                    view: 'eye',
                    favorite: 'heart',
                    watchlist: 'bookmark',
                    rating: 'star'
                };
                return icons[type] || 'circle';
            }

            getActivityText(activity) {
                switch (activity.type) {
                    case 'view':
                        return `viewed <em>${activity.content}</em>`;
                    case 'favorite':
                        return `added <em>${activity.content}</em> to favorites`;
                    case 'watchlist':
                        return `added <em>${activity.content}</em> to watchlist`;
                    case 'rating':
                        return `rated <em>${activity.content}</em> ${activity.rating} stars`;
                    default:
                        return `interacted with <em>${activity.content}</em>`;
                }
            }
        }

        // Chart update functions
        function updateUserGrowthChart() {
            // Implement chart update logic
            ContentManager.showToast('Chart updated', 'info');
        }

        function updateContentChart() {
            // Implement chart update logic
            ContentManager.showToast('Chart updated', 'info');
        }

        // Data refresh functions
        async function refreshPopularContent() {
            document.getElementById('popularContentTable').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            setTimeout(() => {
                analyticsManager.loadPopularContent();
            }, 1000);
        }

        async function refreshGenreData() {
            document.getElementById('genresTable').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            setTimeout(() => {
                analyticsManager.loadGenreData();
            }, 1000);
        }

        function filterActivity() {
            // Implement activity filtering
            ContentManager.showToast('Activity filtered', 'info');
        }

        // Export functions
        function exportUserData() {
            ContentManager.showToast('Exporting user data...', 'info');
        }

        function exportContentData() {
            ContentManager.showToast('Exporting content data...', 'info');
        }

        function exportAnalytics() {
            ContentManager.showToast('Exporting analytics...', 'info');
        }

        function generateReport() {
            ContentManager.showToast('Generating PDF report...', 'info');
        }

        let analyticsManager;
        document.addEventListener('DOMContentLoaded', () => {
            analyticsManager = new AnalyticsManager();
        });
    </script>

    <style>
        .metric-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
        }
        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        .metric-content {
            flex: 1;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 4px;
        }
        .metric-change {
            font-size: 12px;
            font-weight: 600;
        }
        .metric-change.positive {
            color: #22c55e;
        }
        .metric-change.negative {
            color: #ef4444;
        }
        .chart-card, .table-card {
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }
        .chart-header, .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .chart-title, .table-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        .chart-select {
            padding: 6px 12px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .chart-container {
            height: 300px;
            position: relative;
        }
        .data-table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background: var(--dark-bg);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        .data-table td {
            color: var(--text-secondary);
        }
        .content-type-badge {
            padding: 4px 8px;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .percentage-bar {
            position: relative;
            background: var(--dark-bg);
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
        }
        .percentage-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }
        .percentage-text {
            position: absolute;
            top: 50%;
            left: 8px;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .activity-timeline {
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        .activity-view { background: #3b82f6; }
        .activity-favorite { background: #ef4444; }
        .activity-watchlist { background: #10b981; }
        .activity-rating { background: #f59e0b; }
        .activity-content {
            flex: 1;
        }
        .activity-text {
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        .activity-text em {
            color: var(--primary);
            font-style: normal;
        }
        .activity-time {
            font-size: 12px;
            color: var(--text-muted);
        }
        .reports-card {
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }
        .reports-header {
            margin-bottom: 20px;
        }
        .reports-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        @media (max-width: 768px) {
            .chart-header, .table-header, .feed-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            .reports-actions {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>