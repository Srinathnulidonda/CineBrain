<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Analytics Dashboard - CineScope Admin">
    <title>Analytics Dashboard - CineScope Admin</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body class="admin-body">
    <!-- Admin Top Navigation -->
    <nav class="admin-topbar">
        <div class="admin-topbar-left">
            <a href="/" class="logo">üîß CineScope Admin</a>
        </div>
        <div class="admin-topbar-center">
            <div class="admin-breadcrumb">
                <a href="/admin/" class="breadcrumb-item">Dashboard</a>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-item active">Analytics</span>
            </div>
        </div>
        <div class="admin-topbar-right" id="adminUserSection"></div>
    </nav>

    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="/admin/content.html" class="nav-item">
                <span class="nav-icon">üé¨</span>
                <span class="nav-label">Content Management</span>
            </a>
            <a href="/admin/users.html" class="nav-item">
                <span class="nav-icon">üë•</span>
                <span class="nav-label">User Management</span>
            </a>
            <a href="/admin/analytics.html" class="nav-item active">
                <span class="nav-icon">üìà</span>
                <span class="nav-label">Analytics</span>
            </a>
            <div class="nav-divider"></div>
            <a href="/" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Back to Site</span>
            </a>
        </nav>
    </aside>

    <!-- Admin Main Content -->
    <main class="admin-main">
        <div class="admin-content">
            <div class="content-header">
                <h1>Analytics Dashboard</h1>
                <p>Track platform performance, user engagement, and content metrics</p>
            </div>

            <!-- Time Range Selector -->
            <div class="analytics-controls">
                <div class="time-selector">
                    <button class="time-btn" data-range="today" onclick="changeTimeRange('today')">Today</button>
                    <button class="time-btn" data-range="week" onclick="changeTimeRange('week')">This Week</button>
                    <button class="time-btn active" data-range="month" onclick="changeTimeRange('month')">This Month</button>
                    <button class="time-btn" data-range="year" onclick="changeTimeRange('year')">This Year</button>
                </div>
                <button class="btn btn-outline" onclick="exportAnalytics()">
                    üì§ Export Report
                </button>
            </div>

            <!-- Overview Metrics -->
            <div class="analytics-overview" id="analyticsOverview">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading analytics data...</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="analytics-charts">
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>User Growth</h3>
                        <div class="chart" id="userGrowthChart">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Content Views</h3>
                        <div class="chart" id="contentViewsChart">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Engagement Metrics</h3>
                        <div class="chart" id="engagementChart">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Content Performance</h3>
                        <div class="chart" id="contentPerformanceChart">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Analytics -->
            <div class="analytics-detailed">
                <div class="analytics-section">
                    <h2>Top Performing Content</h2>
                    <div class="content-performance-table" id="topContentTable">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading top content...</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-section">
                    <h2>User Activity by Hour</h2>
                    <div class="hourly-activity" id="hourlyActivity">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading hourly data...</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-section">
                    <h2>Popular Genres</h2>
                    <div class="genre-popularity" id="genrePopularity">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading genre data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let currentTimeRange = 'month';
        let analyticsData = {};

        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin authentication
            if (!window.auth.isAuthenticated() || !window.auth.isAdmin()) {
                window.location.href = '/';
                return;
            }

            updateAdminUserSection();
            await loadAnalyticsData();
        });

        async function loadAnalyticsData() {
            try {
                const overview = await window.api.getAnalytics();
                analyticsData = overview;

                // Load time-series data
                const timeSeries = await window.api.getTimeSeriesData(currentTimeRange);
                analyticsData.timeSeries = timeSeries;

                renderAnalyticsOverview();
                renderCharts();
                renderDetailedAnalytics();

            } catch (error) {
                console.error('Failed to load analytics:', error);
                document.getElementById('analyticsOverview').innerHTML = '<p class="error-text">Failed to load analytics data</p>';
            }
        }

        function renderAnalyticsOverview() {
            const container = document.getElementById('analyticsOverview');
            
            if (!analyticsData) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon">üë•</div>
                        <div class="metric-content">
                            <div class="metric-number">${analyticsData.total_users || 0}</div>
                            <div class="metric-label">Total Users</div>
                            <div class="metric-change positive">
                                <span class="change-icon">‚Üë</span>
                                <span class="change-text">+${Math.floor(Math.random() * 20) + 5}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">üé¨</div>
                        <div class="metric-content">
                            <div class="metric-number">${analyticsData.total_content || 0}</div>
                            <div class="metric-label">Content Items</div>
                            <div class="metric-change positive">
                                <span class="change-icon">‚Üë</span>
                                <span class="change-text">+${Math.floor(Math.random() * 10) + 2}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">üìä</div>
                        <div class="metric-content">
                            <div class="metric-number">${analyticsData.active_users_last_week || 0}</div>
                            <div class="metric-label">Active Users (7d)</div>
                            <div class="metric-change positive">
                                <span class="change-icon">‚Üë</span>
                                <span class="change-text">+${Math.floor(Math.random() * 15) + 3}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">üî•</div>
                        <div class="metric-content">
                            <div class="metric-number">${analyticsData.total_views_last_month || 0}</div>
                            <div class="metric-label">Views (Last Month)</div>
                            <div class="metric-change positive">
                                <span class="change-icon">‚Üë</span>
                                <span class="change-text">+${Math.floor(Math.random() * 25) + 5}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCharts() {
            renderUserGrowthChart();
            renderContentViewsChart();
            renderEngagementChart();
            renderContentPerformanceChart();
        }

        function renderUserGrowthChart() {
            const container = document.getElementById('userGrowthChart');
            
            if (!analyticsData.timeSeries) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                return;
            }

            const data = analyticsData.timeSeries.users || [];
            
            container.innerHTML = `
                <div class="simple-chart">
                    <div class="chart-bars">
                        ${data.map((value, index) => {
                            const maxValue = Math.max(...data.map(d => d.value));
                            const height = (value / maxValue) * 100;
                            return `
                                <div class="bar-container">
                                    <div class="bar" style="height: ${height}%"></div>
                                    <div class="bar-label">${value}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="chart-labels">
                        ${data.map((_, index) => {
                            const label = index === 0 ? 'Start' : 
                                        index === data.length - 1 ? 'Now' : 
                                        `Day ${index}`;
                            return `<div class="label">${label}</div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderContentViewsChart() {
            const container = document.getElementById('contentViewsChart');
            
            if (!analyticsData.timeSeries) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                return;
            }

            const data = analyticsData.timeSeries.views || [];
            
            container.innerHTML = `
                <div class="simple-chart line-chart">
                    <div class="chart-line">
                        ${data.map((value, index) => {
                            const maxValue = Math.max(...data.map(d => d.value));
                            const position = (value / maxValue) * 100;
                            return `
                                <div class="point" style="bottom: ${position}%"></div>
                            `;
                        }).join('')}
                    </div>
                    <div class="chart-labels">
                        ${data.map((_, index) => {
                            const label = index === 0 ? 'Start' : 
                                        index === data.length - 1 ? 'Now' : 
                                        `Day ${index}`;
                            return `<div class="label">${label}</div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderEngagementChart() {
            const container = document.getElementById('engagementChart');
            
            if (!analyticsData.timeSeries) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                return;
            }

            const data = analyticsData.timeSeries.engagement || [];
            
            container.innerHTML = `
                <div class="simple-chart">
                    <div class="chart-metrics">
                        <div class="metric-item">
                            <div class="metric-name">Avg. Session</div>
                            <div class="metric-value">${Math.floor(Math.random() * 20) + 10} min</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-name">Bounce Rate</div>
                            <div class="metric-value">${Math.floor(Math.random() * 30) + 20}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-name">Return Rate</div>
                            <div class="metric-value">${Math.floor(Math.random() * 40) + 60}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContentPerformanceChart() {
            const container = document.getElementById('contentPerformanceChart');
            
            if (!analyticsData.top_content) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                return;
            }

            const topContent = analyticsData.top_content.slice(0, 5);
            
            container.innerHTML = `
                <div class="performance-chart">
                    ${topContent.map((item, index) => {
                        const percentage = ((item.views / Math.max(...topContent.map(c => c.views))) * 100);
                        return `
                            <div class="performance-item">
                                <div class="performance-info">
                                    <span class="performance-rank">#${index + 1}</span>
                                    <span class="performance-title">${item.title}</span>
                                    <span class="performance-views">${item.views} views</span>
                                </div>
                                <div class="performance-bar">
                                    <div class="performance-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderDetailedAnalytics() {
            renderTopContentTable();
            renderHourlyActivity();
            renderGenrePopularity();
        }

        function renderTopContentTable() {
            const container = document.getElementById('topContentTable');
            
            if (!analyticsData.top_content) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
                return;
            }

            const topContent = analyticsData.top_content.slice(0, 10);
            
            container.innerHTML = `
                <div class="performance-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Views</th>
                                <th>Watchlist</th>
                                <th>Favorites</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topContent.map((item, index) => `
                                <tr>
                                    <td>#${index + 1}</td>
                                    <td>${item.title}</td>
                                    <td><span class="type-badge">${item.content_type}</span></td>
                                    <td>${item.views.toLocaleString()}</td>
                                    <td>${item.watchlist_count || 0}</td>
                                    <td>${item.favorite_count || 0}</td>
                                    <td>‚òÖ ${item.rating || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderHourlyActivity() {
            const container = document.getElementById('hourlyActivity');
            
            // Generate hourly activity data
            const hourlyData = [];
            for (let i = 0; i < 24; i++) {
                hourlyData.push({
                    hour: i,
                    activity: Math.floor(Math.random() * 100) + 20
                });
            }
            
            const maxActivity = Math.max(...hourlyData.map(h => h.activity));
            
            container.innerHTML = `
                <div class="hourly-activity-chart">
                    <div class="activity-bars">
                        ${hourlyData.map(hour => {
                            const height = (hour.activity / maxActivity) * 100;
                            return `
                                <div class="hour-bar-container">
                                    <div class="hour-bar" style="height: ${height}%"></div>
                                    <div class="hour-label">${hour.hour}:00</div>
                                    <div class="hour-value">${hour.activity}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderGenrePopularity() {
            const container = document.getElementById('genrePopularity');
            
            // Generate genre popularity data
            const genres = [
                { name: 'Action', views: Math.floor(Math.random() * 50000) + 30000 },
                { name: 'Drama', views: Math.floor(Math.random() * 40000) + 25000 },
                { name: 'Comedy', views: Math.floor(Math.random() * 35000) + 20000 },
                { name: 'Sci-Fi', views: Math.floor(Math.random() * 30000) + 15000 },
                { name: 'Horror', views: Math.floor(Math.random() * 25000) + 10000 },
                { name: 'Romance', views: Math.floor(Math.random() * 20000) + 8000 }
            ];
            
            const maxViews = Math.max(...genres.map(g => g.views));
            
            container.innerHTML = `
                <div class="genre-popularity-chart">
                    ${genres.map(genre => {
                        const percentage = (genre.views / maxViews) * 100;
                        return `
                            <div class="genre-item">
                                <div class="genre-info">
                                    <span class="genre-name">${genre.name}</span>
                                    <span class="genre-views">${genre.views.toLocaleString()} views</span>
                                </div>
                                <div class="genre-bar">
                                    <div class="genre-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function changeTimeRange(range) {
            currentTimeRange = range;
            
            // Update active button
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.range === range) {
                    btn.classList.add('active');
                }
            });
            
            // Reload data with new time range
            loadAnalyticsData();
        }

        function exportAnalytics() {
            if (!analyticsData) {
                showToast('No analytics data to export', 'warning');
                return;
            }

            const exportData = {
                exported_at: new Date().toISOString(),
                time_range: currentTimeRange,
                overview: {
                    total_users: analyticsData.total_users || 0,
                    total_content: analyticsData.total_content || 0,
                    active_users_last_week: analyticsData.active_users_last_week || 0,
                    total_views_last_month: analyticsData.total_views_last_month || 0
                },
                top_content: analyticsData.top_content || [],
                time_series: analyticsData.time_series || {}
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinescope-analytics-${currentTimeRange}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Analytics exported successfully', 'success');
        }

        // Utility Functions
        function updateAdminUserSection() {
            const userSection = document.getElementById('adminUserSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <div class="admin-user-info">
                        <img src="${window.auth.getUserAvatar()}" alt="${user.username}" class="admin-avatar">
                        <span class="admin-username">${user.username}</span>
                        <button class="btn btn-outline btn-sm" onclick="window.auth.logout()">Logout</button>
                    </div>
                `;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>