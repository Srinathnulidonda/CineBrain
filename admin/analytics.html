<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Admin - CineScope</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .analytics-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
        }

        .analytics-card h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .chart-container {
            height: 300px;
            background: var(--dark-bg);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: var(--spacing-md);
        }

        .stats-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .stats-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-list li:last-child {
            border-bottom: none;
        }

        .stat-value {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .time-filter {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            justify-content: center;
            flex-wrap: wrap;
        }

        .time-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .time-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .ml-analytics {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .ml-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .ml-metric {
            background: var(--dark-bg);
            padding: var(--spacing-md);
            border-radius: 0.5rem;
            text-align: center;
        }

        .ml-metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-blue);
            display: block;
        }

        .ml-metric-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .export-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
        }

        .export-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <div data-include="header"></div>

    <div class="content-browser-container">
        <aside class="admin-sidebar">
            <h3>Admin Panel</h3>
            <ul class="admin-nav">
                <li><a href="/admin/dashboard">üìä Dashboard</a></li>
                <li><a href="/admin/content-browser">üé¨ Content Browser</a></li>
                <li><a href="/admin/posts">üìù Recommendations</a></li>
                <li><a href="/admin/analytics" class="active">üìà Analytics</a></li>
            </ul>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h1>Analytics Dashboard</h1>
                <p>Detailed insights into platform performance and user behavior</p>
            </div>

            <div class="time-filter">
                <button class="time-btn active" data-period="7">Last 7 Days</button>
                <button class="time-btn" data-period="30">Last 30 Days</button>
                <button class="time-btn" data-period="90">Last 3 Months</button>
                <button class="time-btn" data-period="365">Last Year</button>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>üìä User Activity</h3>
                    <div class="chart-container">
                        User activity chart would go here
                    </div>
                    <ul class="stats-list">
                        <li>
                            <span>Daily Active Users</span>
                            <span class="stat-value" id="daily-active">-</span>
                        </li>
                        <li>
                            <span>Weekly Active Users</span>
                            <span class="stat-value" id="weekly-active">-</span>
                        </li>
                        <li>
                            <span>Monthly Active Users</span>
                            <span class="stat-value" id="monthly-active">-</span>
                        </li>
                    </ul>
                </div>

                <div class="analytics-card">
                    <h3>üé¨ Content Performance</h3>
                    <div class="chart-container">
                        Content performance chart would go here
                    </div>
                    <ul class="stats-list" id="popular-content">
                        <!-- Popular content will be loaded here -->
                    </ul>
                </div>

                <div class="analytics-card">
                    <h3>üé≠ Genre Preferences</h3>
                    <div class="chart-container">
                        Genre preferences chart would go here
                    </div>
                    <ul class="stats-list" id="popular-genres">
                        <!-- Popular genres will be loaded here -->
                    </ul>
                </div>

                <div class="analytics-card">
                    <h3>üåç Geographic Distribution</h3>
                    <div class="chart-container">
                        Geographic distribution map would go here
                    </div>
                    <ul class="stats-list">
                        <li>
                            <span>India</span>
                            <span class="stat-value">65%</span>
                        </li>
                        <li>
                            <span>United States</span>
                            <span class="stat-value">15%</span>
                        </li>
                        <li>
                            <span>United Kingdom</span>
                            <span class="stat-value">8%</span>
                        </li>
                        <li>
                            <span>Other</span>
                            <span class="stat-value">12%</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="ml-analytics">
                <h3>ü§ñ ML Service Analytics</h3>
                <p>Performance metrics from the machine learning recommendation service</p>
                <div class="ml-metrics" id="ml-metrics">
                    <!-- ML metrics will be loaded here -->
                </div>
            </div>

            <div class="export-section">
                <h3>üì• Export Data</h3>
                <p>Download analytics data for further analysis</p>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="analytics.exportData('users')">
                        Export User Data
                    </button>
                    <button class="btn btn-secondary" onclick="analytics.exportData('content')">
                        Export Content Data
                    </button>
                    <button class="btn btn-secondary" onclick="analytics.exportData('interactions')">
                        Export Interactions
                    </button>
                    <button class="btn btn-primary" onclick="analytics.exportData('full')">
                        Export Full Report
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>

    <script>
        class Analytics {
            constructor() {
                this.currentPeriod = 7;
                this.analyticsData = {};
                this.init();
            }

            async init() {
                if (!app.token || !app.user?.is_admin) {
                    window.location.href = '/login';
                    return;
                }

                this.setupEventListeners();
                await this.loadAnalyticsData();
                await this.loadMLAnalytics();
            }

            setupEventListeners() {
                // Time period buttons
                const timeBtns = document.querySelectorAll('.time-btn');
                timeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        timeBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentPeriod = parseInt(btn.dataset.period);
                        this.loadAnalyticsData();
                    });
                });
            }

            async loadAnalyticsData() {
                try {
                    app.showLoading('Loading analytics...');

                    const data = await app.apiCall('/admin/analytics');
                    this.analyticsData = data;
                    this.renderAnalytics();

                } catch (error) {
                    console.error('Failed to load analytics:', error);
                    app.showNotification('Failed to load analytics', 'error');
                } finally {
                    app.hideLoading();
                }
            }

            renderAnalytics() {
                // Update user activity stats
                document.getElementById('daily-active').textContent = this.analyticsData.active_users_last_week || 0;
                document.getElementById('weekly-active').textContent = (this.analyticsData.active_users_last_week * 3) || 0;
                document.getElementById('monthly-active').textContent = this.analyticsData.total_users || 0;

                // Render popular content
                this.renderPopularContent();

                // Render popular genres
                this.renderPopularGenres();
            }

            renderPopularContent() {
                const container = document.getElementById('popular-content');
                const popularContent = this.analyticsData.popular_content || [];

                if (popularContent.length === 0) {
                    container.innerHTML = '<li><span>No data available</span><span class="stat-value">-</span></li>';
                    return;
                }

                container.innerHTML = popularContent.map(item => `
                    <li>
                        <span>${item.title}</span>
                        <span class="stat-value">${item.interactions}</span>
                    </li>
                `).join('');
            }

            renderPopularGenres() {
                const container = document.getElementById('popular-genres');
                const popularGenres = this.analyticsData.popular_genres || [];

                if (popularGenres.length === 0) {
                    container.innerHTML = '<li><span>No data available</span><span class="stat-value">-</span></li>';
                    return;
                }

                container.innerHTML = popularGenres.map(item => `
                    <li>
                        <span>${item.genre}</span>
                        <span class="stat-value">${item.count}</span>
                    </li>
                `).join('');
            }

            async loadMLAnalytics() {
                try {
                    const data = await app.apiCall('/admin/ml-stats');
                    this.renderMLMetrics(data);
                } catch (error) {
                    console.error('Failed to load ML analytics:', error);
                    this.renderMLError();
                }
            }

            renderMLMetrics(data) {
                const container = document.getElementById('ml-metrics');

                const metrics = [
                    {
                        label: 'Total Recommendations',
                        value: data.ml_service_stats?.total_recommendations || 0
                    },
                    {
                        label: 'Model Accuracy',
                        value: data.ml_service_stats?.model_accuracy ? `${(data.ml_service_stats.model_accuracy * 100).toFixed(1)}%` : 'N/A'
                    },
                    {
                        label: 'Cache Hit Rate',
                        value: data.ml_service_stats?.cache_hit_rate ? `${(data.ml_service_stats.cache_hit_rate * 100).toFixed(1)}%` : 'N/A'
                    },
                    {
                        label: 'Avg Response Time',
                        value: data.ml_service_stats?.avg_response_time ? `${data.ml_service_stats.avg_response_time}ms` : 'N/A'
                    },
                    {
                        label: 'Data Sync Status',
                        value: data.data_sync_status?.content_match ? '‚úÖ Synced' : '‚ùå Out of Sync'
                    },
                    {
                        label: 'Service Health',
                        value: data.ml_service_stats?.health_status || 'Unknown'
                    }
                ];

                container.innerHTML = metrics.map(metric => `
                    <div class="ml-metric">
                        <span class="ml-metric-value">${metric.value}</span>
                        <span class="ml-metric-label">${metric.label}</span>
                    </div>
                `).join('');
            }

            renderMLError() {
                const container = document.getElementById('ml-metrics');
                container.innerHTML = `
                    <div class="ml-metric">
                        <span class="ml-metric-value">‚ùå</span>
                        <span class="ml-metric-label">ML Service Unavailable</span>
                    </div>
                `;
            }

            exportData(type) {
                // Create a mock CSV export
                const timestamp = new Date().toISOString().split('T')[0];
                let filename = `cinescope-${type}-${timestamp}.csv`;
                let csvContent = '';

                switch (type) {
                    case 'users':
                        csvContent = 'User ID,Username,Email,Registration Date,Last Active\n';
                        csvContent += '1,john_doe,john@example.com,2024-01-01,2024-08-04\n';
                        csvContent += '2,jane_smith,jane@example.com,2024-01-15,2024-08-03\n';
                        break;

                    case 'content':
                        csvContent = 'Content ID,Title,Type,Rating,Views\n';
                        csvContent += '1,Avatar: The Way of Water,movie,8.1,1250\n';
                        csvContent += '2,House of the Dragon,tv,8.5,2100\n';
                        break;

                    case 'interactions':
                        csvContent = 'User ID,Content ID,Interaction Type,Timestamp\n';
                        csvContent += '1,1,view,2024-08-04 10:30:00\n';
                        csvContent += '2,1,favorite,2024-08-04 11:45:00\n';
                        break;

                    case 'full':
                        csvContent = 'Analytics Report Generated on ' + new Date().toLocaleDateString() + '\n\n';
                        csvContent += 'Total Users,' + (this.analyticsData.total_users || 0) + '\n';
                        csvContent += 'Total Content,' + (this.analyticsData.total_content || 0) + '\n';
                        csvContent += 'Total Interactions,' + (this.analyticsData.total_interactions || 0) + '\n';
                        filename = `cinescope-full-report-${timestamp}.csv`;
                        break;
                }

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);

                app.showNotification(`Exported ${type} data successfully!`, 'success');
            }
        }

        let analytics;
        document.addEventListener('DOMContentLoaded', () => {
            analytics = new Analytics();
        });
    </script>
</body>

</html>