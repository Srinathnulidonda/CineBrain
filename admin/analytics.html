<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#141414">
    <title>Analytics - MovieRec Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --netflix-red: #E50914;
            --netflix-black: #141414;
            --netflix-gray: #333333;
            --admin-sidebar: #1a1a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--netflix-black);
            color: #fff;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--admin-sidebar);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--netflix-red);
            text-transform: uppercase;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            display: block;
            padding: 1rem 1.5rem;
            color: #999;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            color: #fff;
            background: rgba(229, 9, 20, 0.2);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--netflix-red);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Header */
        .admin-header {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .mobile-menu-btn {
            display: none;
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* Analytics Content */
        .analytics-content {
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .analytics-content {
                padding: 1rem;
            }
        }

        /* Date Range Selector */
        .date-range-selector {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .date-range-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .range-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: #999;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .range-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .range-btn.active {
            background: var(--netflix-red);
            color: #fff;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #999;
            font-size: 0.875rem;
        }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chart-placeholder {
            height: 300px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.125rem;
        }

        /* Tables */
        .data-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            background: rgba(255, 255, 255, 0.08);
            padding: 1.5rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            color: #999;
            font-size: 0.875rem;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.03);
        }

        td {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .rank {
            font-weight: bold;
            color: var(--netflix-red);
        }

        /* Export Button */
        .export-btn {
            padding: 0.75rem 1.5rem;
            background: var(--netflix-red);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: #f40612;
        }

        /* Grid Layout for Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .charts-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--netflix-red);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Mini Chart */
        .mini-chart {
            height: 60px;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .chart-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(229, 9, 20, 0.2), transparent);
            clip-path: polygon(
                0% 80%,
                10% 70%,
                20% 75%,
                30% 60%,
                40% 65%,
                50% 45%,
                60% 50%,
                70% 35%,
                80% 40%,
                90% 20%,
                100% 25%,
                100% 100%,
                0% 100%
            );
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">MovieRec</div>
                <div style="color: #999; font-size: 0.875rem; margin-top: 0.5rem;">Admin Panel</div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>📊 Dashboard</span>
                </a>
                <a href="content-browser.html" class="nav-item">
                    <span>🎬 Content Browser</span>
                </a>
                <a href="posts.html" class="nav-item">
                    <span>📝 Admin Posts</span>
                </a>
                <a href="analytics.html" class="nav-item active">
                    <span>📈 Analytics</span>
                </a>
                <a href="../dashboard.html" class="nav-item">
                    <span>👤 User View</span>
                </a>
                <a href="#" class="nav-item" onclick="logout()">
                    <span>🚪 Logout</span>
                </a>
            </nav>
        </aside>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                    <h1 class="header-title">Analytics</h1>
                </div>
                
                <div class="admin-info">
                    <span id="adminName">Admin</span>
                    <div class="admin-avatar" id="adminAvatar">A</div>
                </div>
            </header>

            <!-- Analytics Content -->
            <div class="analytics-content">
                <!-- Date Range Selector -->
                <div class="date-range-selector">
                    <div class="date-range-buttons">
                        <button class="range-btn active" onclick="setDateRange('today')">Today</button>
                        <button class="range-btn" onclick="setDateRange('week')">This Week</button>
                        <button class="range-btn" onclick="setDateRange('month')">This Month</button>
                        <button class="range-btn" onclick="setDateRange('year')">This Year</button>
                        <button class="range-btn" onclick="setDateRange('custom')">Custom</button>
                    </div>
                    <button class="export-btn" style="margin-left: auto;" onclick="exportData()">
                        <span>📊</span>
                        <span>Export Report</span>
                    </button>
                </div>

                <!-- Stats Overview -->
                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">👥</span>
                            <span class="stat-change positive">+12.5%</span>
                        </div>
                        <div class="stat-value">8,942</div>
                        <div class="stat-label">Total Users</div>
                        <div class="mini-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">👁</span>
                            <span class="stat-change positive">+8.3%</span>
                        </div>
                        <div class="stat-value">45.2K</div>
                        <div class="stat-label">Page Views</div>
                        <div class="mini-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">⏱</span>
                            <span class="stat-change negative">-3.2%</span>
                        </div>
                        <div class="stat-value">6:23</div>
                        <div class="stat-label">Avg. Session Duration</div>
                        <div class="mini-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">🎯</span>
                            <span class="stat-change positive">+15.7%</span>
                        </div>
                        <div class="stat-value">78.5%</div>
                        <div class="stat-label">Engagement Rate</div>
                        <div class="mini-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- User Activity Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">User Activity Trends</h3>
                            <select class="range-btn" style="padding: 0.5rem 2rem 0.5rem 1rem;">
                                <option>Daily</option>
                                <option>Weekly</option>
                                <option>Monthly</option>
                            </select>
                        </div>
                        <div class="chart-placeholder">
                            User Activity Line Chart
                        </div>
                    </div>
                    
                    <!-- Content Performance -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Content Performance</h3>
                        </div>
                        <div class="chart-placeholder">
                            Content Performance Pie Chart
                        </div>
                    </div>
                </div>

                <!-- Top Content Table -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="text-lg font-semibold">Top Performing Content</h3>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Views</th>
                                    <th>Rating</th>
                                    <th>Engagement</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="rank">#1</td>
                                    <td>Inception</td>
                                    <td>Movie</td>
                                    <td>12,543</td>
                                    <td>4.8/5</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>92%</span>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: 92%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="rank">#2</td>
                                    <td>Attack on Titan</td>
                                    <td>Anime</td>
                                    <td>10,892</td>
                                    <td>4.9/5</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>88%</span>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: 88%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="rank">#3</td>
                                    <td>Breaking Bad</td>
                                    <td>TV Show</td>
                                    <td>9,234</td>
                                    <td>4.9/5</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>95%</span>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: 95%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="rank">#4</td>
                                    <td>The Dark Knight</td>
                                    <td>Movie</td>
                                    <td>8,765</td>
                                    <td>4.7/5</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>85%</span>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: 85%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="rank">#5</td>
                                    <td>Demon Slayer</td>
                                    <td>Anime</td>
                                    <td>7,432</td>
                                    <td>4.8/5</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>90%</span>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: 90%;"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Demographics -->
                <div class="charts-grid">
                    <!-- Geographic Distribution -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Geographic Distribution</h3>
                        </div>
                        <div class="chart-placeholder">
                            World Map Visualization
                        </div>
                    </div>
                    
                    <!-- Device Types -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Device Usage</h3>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <tr>
                                    <td>Mobile</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div class="progress-bar" style="width: 150px;">
                                                <div class="progress-fill" style="width: 65%;"></div>
                                            </div>
                                            <span>65%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Desktop</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div class="progress-bar" style="width: 150px;">
                                                <div class="progress-fill" style="width: 25%;"></div>
                                            </div>
                                            <span>25%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Tablet</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div class="progress-bar" style="width: 150px;">
                                                <div class="progress-fill" style="width: 10%;"></div>
                                            </div>
                                            <span>10%</span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Engagement Metrics -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="text-lg font-semibold">User Engagement Metrics</h3>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Today</th>
                                    <th>Yesterday</th>
                                    <th>Last Week</th>
                                    <th>Last Month</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>New Users</td>
                                    <td>342</td>
                                    <td>298</td>
                                    <td>2,156</td>
                                    <td>8,942</td>
                                    <td><span class="stat-change positive">↑ 14.8%</span></td>
                                </tr>
                                <tr>
                                    <td>Ratings Submitted</td>
                                    <td>1,234</td>
                                    <td>1,156</td>
                                    <td>8,234</td>
                                    <td>32,456</td>
                                    <td><span class="stat-change positive">↑ 6.7%</span></td>
                                </tr>
                                <tr>
                                    <td>Watchlist Additions</td>
                                    <td>892</td>
                                    <td>923</td>
                                    <td>6,234</td>
                                    <td>24,567</td>
                                    <td><span class="stat-change negative">↓ 3.4%</span></td>
                                </tr>
                                <tr>
                                    <td>Search Queries</td>
                                    <td>5,432</td>
                                    <td>5,123</td>
                                    <td>35,234</td>
                                    <td>142,345</td>
                                    <td><span class="stat-change positive">↑ 6.0%</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    // API Configuration
    const API_BASE = 'https://backend-app-970m.onrender.com/api';
    
    // Global State
    const state = {
        authToken: null,
        userData: null,
        currentDateRange: 'today'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        if (!initializeAuth()) return;
        
        initializeAdmin();
        updateNavigation();
        loadAnalytics();
        setupEventListeners();
    });

    // Initialize Authentication (UPDATED TO MATCH DASHBOARD)
    function initializeAuth() {
        try {
            // First check if we have auth data in sessionStorage
            const storedAuth = sessionStorage.getItem('adminAuth');
            if (storedAuth) {
                const authData = JSON.parse(storedAuth);
                state.authToken = authData.token;
                state.userData = authData.user;
                
                // Verify admin access
                if (!state.userData.is_admin) {
                    sessionStorage.removeItem('adminAuth');
                    window.location.href = '../dashboard.html';
                    return false;
                }
                return true;
            }
            
            // If no stored auth, check URL hash
            const hash = window.location.hash.substring(1);
            if (!hash) {
                window.location.href = '../login.html';
                return false;
            }

            const authData = JSON.parse(atob(hash));
            state.authToken = authData.token;
            state.userData = authData.user;
            
            // Verify admin access
            if (!state.userData.is_admin) {
                window.location.href = '../dashboard.html';
                return false;
            }
            
            // Store auth data in sessionStorage for other admin pages
            sessionStorage.setItem('adminAuth', JSON.stringify(authData));
            
            // Clear hash after storing
            window.location.hash = '';
            return true;
        } catch (e) {
            console.error('Auth initialization failed:', e);
            sessionStorage.removeItem('adminAuth');
            window.location.href = '../login.html';
            return false;
        }
    }

    // Clear authentication data
    function clearAuthData() {
        sessionStorage.removeItem('adminAuth');
        state.authToken = null;
        state.userData = null;
    }

    // Check if user is authenticated
    function isAuthenticated() {
        return state.authToken && state.userData;
    }

    // Initialize Admin (UPDATED)
    function initializeAdmin() {
        if (!isAuthenticated()) return;
        
        const adminName = document.getElementById('adminName');
        const adminAvatar = document.getElementById('adminAvatar');
        
        if (adminName && adminAvatar) {
            adminName.textContent = state.userData.username;
            adminAvatar.textContent = state.userData.username[0].toUpperCase();
        }
    }

    // Update navigation active state (NEW)
    function updateNavigation() {
        const currentPage = window.location.pathname.split('/').pop();
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            item.classList.remove('active');
            const href = item.getAttribute('href');
            
            if (href === currentPage || (currentPage === 'analytics.html' && href === 'analytics.html')) {
                item.classList.add('active');
            }
        });
    }

    // Setup Event Listeners (NEW)
    function setupEventListeners() {
        // Date range buttons
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                setDateRange(e.target.dataset.range || e.target.textContent.toLowerCase());
            });
        });
    }

    // API Request Helper (NEW)
    async function apiRequest(endpoint, options = {}) {
        if (!isAuthenticated()) {
            window.location.href = '../login.html';
            return null;
        }

        try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${state.authToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                clearAuthData();
                window.location.href = '../login.html';
                return null;
            }

            return response;
        } catch (error) {
            console.error('API request failed:', error);
            showToast('Network error. Please try again.', 'error');
            return null;
        }
    }

    // Load Analytics Data (ENHANCED)
    async function loadAnalytics() {
        try {
            // Load real analytics data from API
            const response = await apiRequest(`/admin/analytics?range=${state.currentDateRange}`);
            
            if (response && response.ok) {
                const data = await response.json();
                updateAnalyticsDisplay(data);
            } else {
                // Fallback to simulated data
                loadSimulatedAnalytics();
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
            loadSimulatedAnalytics();
        }
    }

    // Update Analytics Display (NEW)
    function updateAnalyticsDisplay(data) {
        // Update metrics
        if (data.metrics) {
            animateValue('totalUsers', 0, data.metrics.total_users || 8942, 2000);
            animateValue('totalViews', 0, data.metrics.total_views || 45200, 2000, 'K');
            animateValue('engagementRate', 0, data.metrics.engagement_rate || 78.5, 2000, '%');
            animateValue('activeUsers', 0, data.metrics.active_users || 1234, 2000);
        }

        // Update charts data here if you have chart libraries
        console.log('Analytics data updated for range:', state.currentDateRange);
    }

    // Load Simulated Analytics (FALLBACK)
    function loadSimulatedAnalytics() {
        // Simulate different data based on date range
        const ranges = {
            today: { users: 8942, views: 45.2, engagement: 78.5, active: 1234 },
            week: { users: 12500, views: 89.3, engagement: 82.1, active: 2156 },
            month: { users: 45600, views: 234.7, engagement: 85.3, active: 5678 },
            year: { users: 156789, views: 892.4, engagement: 88.9, active: 12345 }
        };

        const data = ranges[state.currentDateRange] || ranges.today;
        
        animateValue('totalUsers', 0, data.users, 2000);
        animateValue('totalViews', 0, data.views, 2000, 'K');
        animateValue('engagementRate', 0, data.engagement, 2000, '%');
        animateValue('activeUsers', 0, data.active, 2000);
        
        console.log('Loading simulated analytics for date range:', state.currentDateRange);
    }

    // Set Date Range (ENHANCED)
    function setDateRange(range) {
        state.currentDateRange = range;
        
        // Update button states
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.classList.remove('active');
            
            // Check if button matches the range
            const btnRange = btn.dataset.range || btn.textContent.toLowerCase();
            if (btnRange === range) {
                btn.classList.add('active');
            }
        });
        
        // Show loading state
        showToast(`Loading ${range} analytics...`, 'info');
        
        // Reload analytics with new date range
        setTimeout(() => {
            loadAnalytics();
        }, 500);
    }

    // Export Data (ENHANCED)
    async function exportData() {
        try {
            showToast('Preparing export...', 'info');
            
            const response = await apiRequest(`/admin/analytics/export?range=${state.currentDateRange}`, {
                method: 'POST'
            });
            
            if (response && response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `analytics-${state.currentDateRange}-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Analytics exported successfully!', 'success');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            // Fallback to simulated export
            showToast('Demo mode: Export functionality would generate a CSV/PDF report with current analytics data', 'info');
        }
    }

    // Refresh Analytics (NEW)
    function refreshAnalytics() {
        showToast('Refreshing analytics...', 'success');
        loadAnalytics();
    }

    // Toggle Sidebar (UPDATED)
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar && overlay) {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
    }

    // Show Toast (NEW)
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        if (!toast) {
            console.log(`Toast: ${message} (${type})`);
            return;
        }
        
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Logout (UPDATED)
    function logout() {
        clearAuthData();
        window.location.href = '../login.html';
    }

    // Animate Numbers (ENHANCED)
    function animateValue(elementId, start, end, duration, suffix = '') {
        const element = document.getElementById(elementId);
        if (!element) {
            // Fallback: look for elements by class and content
            const elements = document.querySelectorAll('.stat-value');
            elements.forEach(el => {
                if (el.dataset.metric === elementId) {
                    animateElement(el, start, end, duration, suffix);
                }
            });
            return;
        }
        
        animateElement(element, start, end, duration, suffix);
    }

    // Animate Element Helper (NEW)
    function animateElement(element, start, end, duration, suffix = '') {
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= end) {
                current = end;
                clearInterval(timer);
            }
            
            if (suffix === 'K') {
                element.textContent = (current / 1000).toFixed(1) + suffix;
            } else if (suffix === '%') {
                element.textContent = current.toFixed(1) + suffix;
            } else {
                element.textContent = Math.floor(current).toLocaleString();
            }
        }, 16);
    }

    // Handle navigation clicks (NEW)
    document.addEventListener('click', (e) => {
        const navItem = e.target.closest('.nav-item');
        if (navItem && !navItem.getAttribute('onclick')) {
            const href = navItem.getAttribute('href');
            
            if (href === '#') {
                e.preventDefault();
                return;
            }
            
            if (href === '../dashboard.html') {
                e.preventDefault();
                const authData = {
                    token: state.authToken,
                    user: state.userData
                };
                window.location.href = `../dashboard.html#${btoa(JSON.stringify(authData))}`;
                return;
            }
        }
    });

    // Handle page visibility change to check auth status (NEW)
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && !isAuthenticated()) {
            window.location.href = '../login.html';
        } else if (document.visibilityState === 'visible') {
            // Refresh analytics when tab becomes active
            loadAnalytics();
        }
    });

    // Handle window resize for responsive sidebar (NEW)
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        }
    });

    // Auto-refresh analytics every 5 minutes (NEW)
    setInterval(() => {
        if (document.visibilityState === 'visible' && isAuthenticated()) {
            loadAnalytics();
        }
    }, 5 * 60 * 1000);

    // Initialize animations when page loads (UPDATED)
    window.addEventListener('load', () => {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
            loadSimulatedAnalytics();
        }, 100);
    });
</script>
</body>
</html>