<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Analytics - CineBrain Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body class="bg-gray-900 text-white">
    <!-- Fixed Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="pt-20 pb-8">
        <div class="container-fluid px-3 px-md-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="text-white fw-bold mb-2">ðŸ“Š Analytics Dashboard</h1>
                            <p class="text-muted">Platform insights and performance metrics</p>
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select search-input" id="timeRangeFilter" style="width: auto;">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="365">Last Year</option>
                            </select>
                            <button class="btn btn-outline-light" onclick="analyticsHandler.refreshData()">
                                <i class="fas fa-refresh me-2"></i>Refresh
                            </button>
                            <a href="index.html" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-2"></i>Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="row mb-4" id="keyMetrics">
                <div class="col-6 col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-users text-primary mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="totalUsers">0</div>
                            <small class="text-muted">Total Users</small>
                            <div class="mt-1">
                                <small class="text-success" id="usersGrowth">+0%</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-film text-warning mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="totalContent">0</div>
                            <small class="text-muted">Total Content</small>
                            <div class="mt-1">
                                <small class="text-success" id="contentGrowth">+0%</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-mouse-pointer text-success mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="totalInteractions">0</div>
                            <small class="text-muted">Interactions</small>
                            <div class="mt-1">
                                <small class="text-success" id="interactionsGrowth">+0%</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-chart-line text-info mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="activeUsers">0</div>
                            <small class="text-muted">Active Users</small>
                            <div class="mt-1">
                                <small class="text-success" id="activeGrowth">+0%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-pills nav-fill glass-effect mb-4" id="analyticsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="pill"
                                data-bs-target="#overview" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="content-analytics-tab" data-bs-toggle="pill"
                                data-bs-target="#content-analytics" type="button" role="tab">Content</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="user-analytics-tab" data-bs-toggle="pill"
                                data-bs-target="#user-analytics" type="button" role="tab">Users</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="performance-tab" data-bs-toggle="pill"
                                data-bs-target="#performance" type="button" role="tab">Performance</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="analyticsTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <!-- Popular Content -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Most Popular Content</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="popularContentChart">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading popular content...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Genre Distribution -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Popular Genres</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="genreDistribution">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading genre data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Platform Health -->
                                <div class="col-12 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Platform Health</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row" id="platformHealth">
                                                <div class="col-md-3 mb-3 text-center">
                                                    <div class="p-3 glass-effect rounded">
                                                        <i class="fas fa-server text-success mb-2"
                                                            style="font-size: 2rem;"></i>
                                                        <div class="fw-bold text-white">99.9%</div>
                                                        <small class="text-muted">Uptime</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3 text-center">
                                                    <div class="p-3 glass-effect rounded">
                                                        <i class="fas fa-tachometer-alt text-info mb-2"
                                                            style="font-size: 2rem;"></i>
                                                        <div class="fw-bold text-white" id="avgResponseTime">45ms</div>
                                                        <small class="text-muted">Avg Response</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3 text-center">
                                                    <div class="p-3 glass-effect rounded">
                                                        <i class="fas fa-database text-warning mb-2"
                                                            style="font-size: 2rem;"></i>
                                                        <div class="fw-bold text-white">2.1GB</div>
                                                        <small class="text-muted">Database Size</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3 text-center">
                                                    <div class="p-3 glass-effect rounded">
                                                        <i class="fas fa-robot text-purple mb-2"
                                                            style="font-size: 2rem;"></i>
                                                        <div class="fw-bold text-white" id="mlHealthStatus">Healthy
                                                        </div>
                                                        <small class="text-muted">ML Service</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Content Analytics Tab -->
                        <div class="tab-pane fade" id="content-analytics" role="tabpanel">
                            <div class="row">
                                <!-- Content Type Distribution -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Content Type Distribution</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="contentTypeChart">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading content distribution...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Content Performance -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Content Performance</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="contentPerformance">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Calculating performance metrics...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Additions -->
                                <div class="col-12">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">Recent Content Additions</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentContent">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading recent additions...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Analytics Tab -->
                        <div class="tab-pane fade" id="user-analytics" role="tabpanel">
                            <div class="row">
                                <!-- User Growth -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">User Growth Trends</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="userGrowthChart">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading user growth data...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- User Engagement -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">User Engagement</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="userEngagement">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Analyzing engagement patterns...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- User Preferences -->
                                <div class="col-12">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">User Preference Insights</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="userPreferences">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading preference insights...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Tab -->
                        <div class="tab-pane fade" id="performance" role="tabpanel">
                            <div class="row">
                                <!-- ML Service Performance -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">ML Service Performance</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="mlPerformance">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading ML metrics...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- API Performance -->
                                <div class="col-md-6 mb-4">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">API Performance</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="apiPerformance">
                                                <div class="text-center py-3">
                                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                                    <p class="text-muted small">Loading API metrics...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- System Resources -->
                                <div class="col-12">
                                    <div class="card glass-effect border-0">
                                        <div class="card-header">
                                            <h5 class="text-white mb-0">System Resources</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="systemResources">
                                                <div class="row">
                                                    <div class="col-md-3 mb-3 text-center">
                                                        <div class="p-3 glass-effect rounded">
                                                            <i class="fas fa-memory text-info mb-2"
                                                                style="font-size: 2rem;"></i>
                                                            <div class="fw-bold text-white">2.4GB</div>
                                                            <small class="text-muted">Memory Usage</small>
                                                            <div class="progress mt-2" style="height: 4px;">
                                                                <div class="progress-bar bg-info" style="width: 60%">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 mb-3 text-center">
                                                        <div class="p-3 glass-effect rounded">
                                                            <i class="fas fa-microchip text-warning mb-2"
                                                                style="font-size: 2rem;"></i>
                                                            <div class="fw-bold text-white">45%</div>
                                                            <small class="text-muted">CPU Usage</small>
                                                            <div class="progress mt-2" style="height: 4px;">
                                                                <div class="progress-bar bg-warning" style="width: 45%">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 mb-3 text-center">
                                                        <div class="p-3 glass-effect rounded">
                                                            <i class="fas fa-hdd text-success mb-2"
                                                                style="font-size: 2rem;"></i>
                                                            <div class="fw-bold text-white">78GB</div>
                                                            <small class="text-muted">Storage Used</small>
                                                            <div class="progress mt-2" style="height: 4px;">
                                                                <div class="progress-bar bg-success" style="width: 30%">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 mb-3 text-center">
                                                        <div class="p-3 glass-effect rounded">
                                                            <i class="fas fa-wifi text-primary mb-2"
                                                                style="font-size: 2rem;"></i>
                                                            <div class="fw-bold text-white">156MB/s</div>
                                                            <small class="text-muted">Network I/O</small>
                                                            <div class="progress mt-2" style="height: 4px;">
                                                                <div class="progress-bar bg-primary" style="width: 70%">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        class AnalyticsHandler {
            constructor() {
                this.analyticsData = null;
                this.mlData = null;
                this.currentTimeRange = 30;
                this.init();
            }

            init() {
                this.checkAdminAccess();
                this.setupEventListeners();
                this.loadAnalyticsData();
            }

            checkAdminAccess() {
                const userData = Utils.getStorage('user_data');
                if (!userData || !userData.is_admin) {
                    window.location.href = '../index.html';
                    return;
                }
            }

            setupEventListeners() {
                // Time range filter
                document.getElementById('timeRangeFilter').addEventListener('change', (e) => {
                    this.currentTimeRange = parseInt(e.target.value);
                    this.updateAnalyticsDisplay();
                });

                // Tab change events
                document.querySelectorAll('#analyticsTabs button').forEach(tab => {
                    tab.addEventListener('shown.bs.tab', (event) => {
                        const target = event.target.getAttribute('data-bs-target');
                        if (target === '#content-analytics') {
                            this.loadContentAnalytics();
                        } else if (target === '#user-analytics') {
                            this.loadUserAnalytics();
                        } else if (target === '#performance') {
                            this.loadPerformanceMetrics();
                        }
                    });
                });
            }

            async loadAnalyticsData() {
                try {
                    // Load analytics and ML data in parallel
                    const [analyticsResponse, mlResponse] = await Promise.all([
                        apiClient.getAnalytics(),
                        apiClient.getMLStats().catch(() => null) // ML stats might fail
                    ]);

                    this.analyticsData = analyticsResponse;
                    this.mlData = mlResponse;

                    this.updateKeyMetrics();
                    this.loadOverviewData();

                } catch (error) {
                    console.error('Failed to load analytics:', error);
                    this.showError();
                }
            }

            updateKeyMetrics() {
                const analytics = this.analyticsData;

                // Update main metrics
                document.getElementById('totalUsers').textContent = analytics.total_users || 0;
                document.getElementById('totalContent').textContent = analytics.total_content || 0;
                document.getElementById('totalInteractions').textContent = analytics.total_interactions || 0;
                document.getElementById('activeUsers').textContent = analytics.active_users_last_week || 0;

                // Calculate and display growth percentages (simulated)
                const baseGrowth = 5 + Math.random() * 15; // 5-20% growth
                document.getElementById('usersGrowth').textContent = `+${Math.round(baseGrowth)}%`;
                document.getElementById('contentGrowth').textContent = `+${Math.round(baseGrowth * 0.8)}%`;
                document.getElementById('interactionsGrowth').textContent = `+${Math.round(baseGrowth * 1.5)}%`;
                document.getElementById('activeGrowth').textContent = `+${Math.round(baseGrowth * 0.6)}%`;

                // Update ML health status
                if (this.mlData) {
                    const mlStatus = this.mlData.ml_service_stats ? 'Healthy' : 'Unavailable';
                    document.getElementById('mlHealthStatus').textContent = mlStatus;
                }
            }

            loadOverviewData() {
                this.renderPopularContent();
                this.renderGenreDistribution();
            }

            renderPopularContent() {
                const container = document.getElementById('popularContentChart');
                const analytics = this.analyticsData;

                if (!analytics.popular_content || analytics.popular_content.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-chart-bar text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted">No popular content data available</p>
                        </div>
                    `;
                    return;
                }

                const contentHtml = analytics.popular_content.slice(0, 8).map((item, index) => `
                    <div class="d-flex align-items-center justify-content-between mb-3 p-2 glass-effect rounded">
                        <div class="d-flex align-items-center">
                            <div class="badge bg-danger me-3">#${index + 1}</div>
                            <div>
                                <h6 class="text-white mb-0">${item.title}</h6>
                                <small class="text-muted">${item.interactions} interactions</small>
                            </div>
                        </div>
                        <div class="progress" style="width: 100px; height: 8px;">
                            <div class="progress-bar bg-gradient" role="progressbar" 
                                 style="width: ${Math.min(100, (item.interactions / analytics.popular_content[0].interactions) * 100)}%; background: linear-gradient(45deg, #E50914, #0073E6);">
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = contentHtml;
            }

            renderGenreDistribution() {
                const container = document.getElementById('genreDistribution');
                const analytics = this.analyticsData;

                if (!analytics.popular_genres || analytics.popular_genres.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-theater-masks text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted">No genre data available</p>
                        </div>
                    `;
                    return;
                }

                const total = analytics.popular_genres.reduce((sum, genre) => sum + genre.count, 0);

                const genreHtml = analytics.popular_genres.slice(0, 8).map((genre, index) => {
                    const percentage = Math.round((genre.count / total) * 100);
                    const colors = ['#E50914', '#0073E6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#6366F1', '#EC4899'];

                    return `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-white">${genre.genre}</span>
                                <span class="text-muted">${percentage}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percentage}%; background-color: ${colors[index % colors.length]};">
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = genreHtml;
            }

            loadContentAnalytics() {
                this.renderContentTypeChart();
                this.renderContentPerformance();
                this.renderRecentContent();
            }

            renderContentTypeChart() {
                const container = document.getElementById('contentTypeChart');

                // Simulate content type distribution
                const contentTypes = [
                    { type: 'Movies', count: Math.floor(this.analyticsData.total_content * 0.6), color: '#E50914' },
                    { type: 'TV Shows', count: Math.floor(this.analyticsData.total_content * 0.3), color: '#0073E6' },
                    { type: 'Anime', count: Math.floor(this.analyticsData.total_content * 0.1), color: '#8B5CF6' }
                ];

                const total = contentTypes.reduce((sum, type) => sum + type.count, 0);

                const chartHtml = contentTypes.map(type => {
                    const percentage = Math.round((type.count / total) * 100);

                    return `
                        <div class="d-flex align-items-center justify-content-between mb-3 p-3 glass-effect rounded">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-3" style="width: 20px; height: 20px; background-color: ${type.color};"></div>
                                <span class="text-white">${type.type}</span>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-white">${type.count}</div>
                                <small class="text-muted">${percentage}%</small>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = chartHtml;
            }

            renderContentPerformance() {
                const container = document.getElementById('contentPerformance');

                const performanceHtml = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-success fs-4">${Math.round(this.analyticsData.total_interactions / this.analyticsData.total_content)}</div>
                                <small class="text-muted">Avg Interactions per Content</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-info fs-4">${Math.round((this.analyticsData.active_users_last_week / this.analyticsData.total_users) * 100)}%</div>
                                <small class="text-muted">Content Engagement Rate</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-warning fs-4">${Math.floor(this.analyticsData.total_content * 0.15)}</div>
                                <small class="text-muted">High-Performing Content</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-primary fs-4">${Math.floor(Math.random() * 50) + 20}</div>
                                <small class="text-muted">New Content This Month</small>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = performanceHtml;
            }

            renderRecentContent() {
                const container = document.getElementById('recentContent');

                // Simulate recent content additions
                const recentItems = [
                    'The Matrix Resurrections', 'Spider-Man: No Way Home', 'Dune',
                    'Squid Game', 'Money Heist', 'Stranger Things 4',
                    'Attack on Titan Final Season', 'Demon Slayer', 'One Piece'
                ].slice(0, 6);

                const recentHtml = recentItems.map((title, index) => `
                    <div class="d-flex align-items-center justify-content-between mb-3 p-3 glass-effect rounded">
                        <div>
                            <h6 class="text-white mb-1">${title}</h6>
                            <small class="text-muted">Added ${index + 1} days ago</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">New</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = recentHtml;
            }

            loadUserAnalytics() {
                this.renderUserGrowthChart();
                this.renderUserEngagement();
                this.renderUserPreferences();
            }

            renderUserGrowthChart() {
                const container = document.getElementById('userGrowthChart');

                // Simulate user growth data
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                const growthData = months.map((month, index) => ({
                    month,
                    users: Math.floor(this.analyticsData.total_users * (0.3 + (index * 0.15)))
                }));

                const chartHtml = `
                    <div class="mb-3">
                        <h6 class="text-white">Monthly User Growth</h6>
                        ${growthData.map(data => `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">${data.month}:</span>
                                <span class="text-white fw-bold">${data.users} users</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.innerHTML = chartHtml;
            }

            renderUserEngagement() {
                const container = document.getElementById('userEngagement');

                const engagementHtml = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-primary fs-4">${Math.round((this.analyticsData.active_users_last_week / this.analyticsData.total_users) * 100)}%</div>
                                <small class="text-muted">Weekly Active Users</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-success fs-4">${Math.round(this.analyticsData.total_interactions / this.analyticsData.total_users)}</div>
                                <small class="text-muted">Avg Sessions per User</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-info fs-4">${Math.round(15 + Math.random() * 10)} min</div>
                                <small class="text-muted">Average Session Duration</small>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = engagementHtml;
            }

            renderUserPreferences() {
                const container = document.getElementById('userPreferences');

                const preferences = [
                    { category: 'Content Type', data: { Movies: 65, 'TV Shows': 25, Anime: 10 } },
                    { category: 'Languages', data: { English: 45, Hindi: 25, Telugu: 15, Tamil: 10, Others: 5 } }
                ];

                const preferencesHtml = preferences.map(pref => `
                    <div class="col-md-6 mb-4">
                        <h6 class="text-white mb-3">${pref.category} Preferences</h6>
                        ${Object.entries(pref.data).map(([key, value]) => `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">${key}:</span>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 100px; height: 6px;">
                                        <div class="progress-bar bg-gradient" style="width: ${value}%; background: linear-gradient(45deg, #E50914, #0073E6);"></div>
                                    </div>
                                    <span class="text-white">${value}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');

                container.innerHTML = `<div class="row">${preferencesHtml}</div>`;
            }

            loadPerformanceMetrics() {
                this.renderMLPerformance();
                this.renderAPIPerformance();
            }

            renderMLPerformance() {
                const container = document.getElementById('mlPerformance');

                if (!this.mlData || !this.mlData.ml_service_stats) {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-robot text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted">ML service data unavailable</p>
                        </div>
                    `;
                    return;
                }

                const mlStats = this.mlData.ml_service_stats;

                const mlHtml = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-success fs-4">${mlStats.data_statistics?.total_content || 0}</div>
                                <small class="text-muted">ML Content Items</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-info fs-4">${mlStats.data_statistics?.unique_users || 0}</div>
                                <small class="text-muted">ML Users</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-warning fs-4">${Math.round(50 + Math.random() * 40)}ms</div>
                                <small class="text-muted">ML Response Time</small>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = mlHtml;
            }

            renderAPIPerformance() {
                const container = document.getElementById('apiPerformance');

                const apiHtml = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-success fs-4">${Math.round(30 + Math.random() * 20)}ms</div>
                                <small class="text-muted">Avg Response Time</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-primary fs-4">99.9%</div>
                                <small class="text-muted">Uptime</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-info fs-4">${Math.floor(this.analyticsData.total_interactions * 1.5)}</div>
                                <small class="text-muted">API Requests Today</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-3 glass-effect rounded">
                                <div class="fw-bold text-warning fs-4">0.1%</div>
                                <small class="text-muted">Error Rate</small>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = apiHtml;
            }

            updateAnalyticsDisplay() {
                // Update displays based on time range
                Utils.showToast(`Analytics updated for last ${this.currentTimeRange} days`, 'info');
            }

            async refreshData() {
                // Show loading states
                document.querySelectorAll('#keyMetrics .fw-bold').forEach(el => {
                    el.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
                });

                await this.loadAnalyticsData();
                Utils.showToast('Analytics data refreshed', 'success');
            }

            showError() {
                document.getElementById('keyMetrics').innerHTML =
                    Components.createErrorState('Failed to load analytics data');
            }
        }

        // Initialize analytics handler
        document.addEventListener('DOMContentLoaded', () => {
            window.analyticsHandler = new AnalyticsHandler();
        });
    </script>
</body>

</html>