<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - CineScope Admin</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav container">
            <a href="/admin/dashboard" class="nav-brand">CineScope Admin</a>
            <div class="nav-menu">
                <a href="/admin/dashboard" class="nav-link">Dashboard</a>
                <a href="/admin/content-browser" class="nav-link">Content</a>
                <a href="/admin/posts" class="nav-link">Recommendations</a>
                <a href="/admin/analytics" class="nav-link active">Analytics</a>
                <button onclick="app.logout()" class="btn btn-outline btn-sm">Logout</button>
            </div>
            <button class="btn btn-secondary md:hidden" data-mobile-menu-toggle>‚ò∞</button>
        </nav>
    </header>

    <main class="container py-8">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">üìä Analytics Dashboard</h1>
                <p class="text-gray-400">Platform insights and performance metrics</p>
            </div>
            <div class="flex gap-4">
                <select id="time-range" class="form-select">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button id="export-data" class="btn btn-outline">Export Data</button>
                <button id="refresh-data" class="btn btn-primary">Refresh</button>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Total Users</h3>
                    <div class="text-3xl">üë•</div>
                </div>
                <div class="stat-value" id="total-users">-</div>
                <div class="stat-change positive" id="users-change">+12% from last month</div>
            </div>

            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Active Users</h3>
                    <div class="text-3xl">üü¢</div>
                </div>
                <div class="stat-value" id="active-users">-</div>
                <div class="stat-change positive" id="active-change">+8% from last week</div>
            </div>

            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Content Library</h3>
                    <div class="text-3xl">üé¨</div>
                </div>
                <div class="stat-value" id="total-content">-</div>
                <div class="stat-change positive" id="content-change">+25 this month</div>
            </div>

            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Interactions</h3>
                    <div class="text-3xl">üî•</div>
                </div>
                <div class="stat-value" id="total-interactions">-</div>
                <div class="stat-change positive" id="interactions-change">+18% this week</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- User Activity Chart -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">User Activity</h3>
                <div class="h-64">
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>

            <!-- Content Popularity Chart -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">Content Type Distribution</h3>
                <div class="h-64">
                    <canvas id="contentTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Popular Content -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">Top Content</h3>
                <div id="popular-content-list" class="space-y-3">
                    <!-- Loading skeleton -->
                    <div class="skeleton h-16 rounded"></div>
                    <div class="skeleton h-16 rounded"></div>
                    <div class="skeleton h-16 rounded"></div>
                </div>
            </div>

            <!-- Popular Genres -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">Popular Genres</h3>
                <div id="popular-genres-list" class="space-y-3">
                    <!-- Loading skeleton -->
                    <div class="skeleton h-8 rounded"></div>
                    <div class="skeleton h-8 rounded"></div>
                    <div class="skeleton h-8 rounded"></div>
                </div>
            </div>

            <!-- User Engagement -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">User Engagement</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Avg. Session Duration</span>
                        <span class="font-semibold" id="avg-session">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Bounce Rate</span>
                        <span class="font-semibold" id="bounce-rate">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Return Users</span>
                        <span class="font-semibold" id="return-users">-</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Daily Active Users</span>
                        <span class="font-semibold" id="daily-active">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geographic Distribution -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-bold mb-4">Geographic Distribution</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-800 rounded-lg">
                    <div class="text-2xl mb-2">üáÆüá≥</div>
                    <div class="font-semibold">India</div>
                    <div class="text-sm text-gray-400">65% of users</div>
                </div>
                <div class="text-center p-4 bg-gray-800 rounded-lg">
                    <div class="text-2xl mb-2">üá∫üá∏</div>
                    <div class="font-semibold">United States</div>
                    <div class="text-sm text-gray-400">15% of users</div>
                </div>
                <div class="text-center p-4 bg-gray-800 rounded-lg">
                    <div class="text-2xl mb-2">üá¨üáß</div>
                    <div class="font-semibold">United Kingdom</div>
                    <div class="text-sm text-gray-400">8% of users</div>
                </div>
                <div class="text-center p-4 bg-gray-800 rounded-lg">
                    <div class="text-2xl mb-2">üåç</div>
                    <div class="font-semibold">Others</div>
                    <div class="text-sm text-gray-400">12% of users</div>
                </div>
            </div>
        </div>

        <!-- Platform Performance -->
        <div class="card p-6 mb-8">
            <h3 class="text-xl font-bold mb-4">Platform Performance</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">Response Times</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm">API Average</span>
                            <span class="text-sm font-semibold text-green-400">245ms</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Search API</span>
                            <span class="text-sm font-semibold text-green-400">180ms</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">ML Service</span>
                            <span class="text-sm font-semibold text-yellow-400">580ms</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">Error Rates</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm">4xx Errors</span>
                            <span class="text-sm font-semibold text-green-400">0.2%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">5xx Errors</span>
                            <span class="text-sm font-semibold text-green-400">0.05%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Uptime</span>
                            <span class="text-sm font-semibold text-green-400">99.9%</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">ML Service Health</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm">Status</span>
                            <span class="text-sm font-semibold text-green-400" id="ml-status">Healthy</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Recommendations/hour</span>
                            <span class="text-sm font-semibold">1,245</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm">Cache Hit Rate</span>
                            <span class="text-sm font-semibold text-green-400">87%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Log -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">Recent Activity</h3>
                <button id="view-full-log" class="btn btn-outline btn-sm">View Full Log</button>
            </div>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Content</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log">
                        <!-- Activity log will be populated here -->
                        <tr>
                            <td colspan="5" class="text-center text-gray-400">Loading activity...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
        let userActivityChart, contentTypeChart;
        let currentTimeRange = 30;

        document.addEventListener('DOMContentLoaded', function() {
            if (!app.isAdmin()) {
                window.location.href = '/login';
                return;
            }
            
            setupEventListeners();
            loadAnalyticsData();
        });

        function setupEventListeners() {
            document.getElementById('time-range').addEventListener('change', (e) => {
                currentTimeRange = parseInt(e.target.value);
                loadAnalyticsData();
            });

            document.getElementById('refresh-data').addEventListener('click', loadAnalyticsData);
            document.getElementById('export-data').addEventListener('click', exportAnalyticsData);
            document.getElementById('view-full-log').addEventListener('click', () => {
                // Would open a detailed activity log modal or page
                app.showToast('Full log viewer coming soon', 'info');
            });
        }

        async function loadAnalyticsData() {
            try {
                showLoadingStates();
                
                // Load basic analytics
                const analytics = await apiClient.getAnalytics();
                updateKeyMetrics(analytics);
                updatePopularContent(analytics.popular_content || []);
                updatePopularGenres(analytics.popular_genres || []);
                
                // Create charts
                createUserActivityChart();
                createContentTypeChart();
                
                // Load additional data
                loadUserEngagement();
                loadActivityLog();
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                app.showToast('Failed to load analytics data', 'error');
            }
        }

        function showLoadingStates() {
            // Show loading states for various components
            document.getElementById('total-users').textContent = '-';
            document.getElementById('active-users').textContent = '-';
            document.getElementById('total-content').textContent = '-';
            document.getElementById('total-interactions').textContent = '-';
        }

        function updateKeyMetrics(analytics) {
            document.getElementById('total-users').textContent = analytics.total_users || 0;
            document.getElementById('active-users').textContent = analytics.active_users_last_week || 0;
            document.getElementById('total-content').textContent = analytics.total_content || 0;
            document.getElementById('total-interactions').textContent = analytics.total_interactions || 0;
        }

        function updatePopularContent(popularContent) {
            const container = document.getElementById('popular-content-list');
            
            if (!popularContent || popularContent.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No data available</p>';
                return;
            }

            const html = popularContent.slice(0, 5).map((item, index) => `
                <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center font-bold text-sm">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium text-sm">${item.title}</h4>
                        <p class="text-xs text-gray-400">${item.interactions} interactions</p>
                    </div>
                    <div class="text-green-400 text-xs font-semibold">
                        ${((item.interactions / (popularContent[0]?.interactions || 1)) * 100).toFixed(0)}%
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updatePopularGenres(popularGenres) {
            const container = document.getElementById('popular-genres-list');
            
            if (!popularGenres || popularGenres.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No data available</p>';
                return;
            }

            const maxCount = Math.max(...popularGenres.map(g => g.count));
            
            const html = popularGenres.slice(0, 8).map(genre => {
                const percentage = (genre.count / maxCount) * 100;
                return `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">${genre.genre}</span>
                        <div class="flex items-center gap-2">
                            <div class="w-16 h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-purple-400 rounded-full transition-all duration-500" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 w-8 text-right">${genre.count}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function createUserActivityChart() {
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (userActivityChart) {
                userActivityChart.destroy();
            }

            // Generate sample data based on time range
            const days = currentTimeRange;
            const labels = [];
            const data = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en', { month: 'short', day: 'numeric' }));
                // Generate realistic-looking sample data
                data.push(Math.floor(Math.random() * 100) + 50 + (Math.sin(i / 7) * 20));
            }

            userActivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Active Users',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: {
                                color: '#374151'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        }
                    }
                }
            });
        }

        function createContentTypeChart() {
            const ctx = document.getElementById('contentTypeChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (contentTypeChart) {
                contentTypeChart.destroy();
            }

            contentTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Movies', 'TV Shows', 'Anime'],
                    datasets: [{
                        data: [45, 35, 20],
                        backgroundColor: [
                            '#3b82f6',
                            '#7c3aed',
                            '#ec4899'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#d1d5db',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function loadUserEngagement() {
            // Simulate user engagement data
            document.getElementById('avg-session').textContent = '8m 42s';
            document.getElementById('bounce-rate').textContent = '32%';
            document.getElementById('return-users').textContent = '68%';
            document.getElementById('daily-active').textContent = '1,247';
        }

        function loadActivityLog() {
            const logContainer = document.getElementById('activity-log');
            
            // Simulate recent activity data
            const activities = [
                { time: '2m ago', user: 'john_doe', action: 'Added to Watchlist', content: 'Inception', ip: '192.168.1.1' },
                { time: '5m ago', user: 'sarah_k', action: 'Rated', content: 'The Dark Knight', ip: '192.168.1.2' },
                { time: '8m ago', user: 'mike_91', action: 'Searched', content: 'Marvel movies', ip: '192.168.1.3' },
                { time: '12m ago', user: 'emma_s', action: 'Added to Favorites', content: 'Your Name', ip: '192.168.1.4' },
                { time: '15m ago', user: 'alex_m', action: 'Viewed Details', content: 'Breaking Bad', ip: '192.168.1.5' }
            ];

            const html = activities.map(activity => `
                <tr>
                    <td class="text-sm text-gray-400">${activity.time}</td>
                    <td class="text-sm font-medium">${activity.user}</td>
                    <td class="text-sm">${activity.action}</td>
                    <td class="text-sm text-blue-400">${activity.content}</td>
                    <td class="text-sm text-gray-400">${activity.ip}</td>
                </tr>
            `).join('');

            logContainer.innerHTML = html;
        }

        async function exportAnalyticsData() {
            try {
                app.showToast('Preparing export...', 'info');
                
                // Simulate export preparation
                setTimeout(() => {
                    const data = {
                        timeRange: currentTimeRange,
                        exportedAt: new Date().toISOString(),
                        metrics: {
                            totalUsers: document.getElementById('total-users').textContent,
                            activeUsers: document.getElementById('active-users').textContent,
                            totalContent: document.getElementById('total-content').textContent,
                            totalInteractions: document.getElementById('total-interactions').textContent
                        }
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cinescope-analytics-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    app.showToast('Analytics data exported successfully', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Export failed:', error);
                app.showToast('Export failed', 'error');
            }
        }
    </script>
</body>
</html>