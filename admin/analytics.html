<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - CineScope Admin</title>
    <meta name="description" content="Comprehensive analytics and insights for CineScope platform.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Analytics...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Analytics Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">📊 Analytics Dashboard</h1>
                <p class="text-gray-400">Comprehensive insights and platform statistics</p>
            </div>
            <div class="flex items-center gap-4">
                <select id="timeRangeFilter" class="form-input">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button class="btn btn-primary" onclick="exportAnalytics()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export Data
                </button>
            </div>
        </div>

        <!-- Key Metrics Overview -->
        <div class="grid grid-2 md:grid-4 gap-6 mb-8">
            <div class="stats-card">
                <div class="stats-value" id="totalUsers">0</div>
                <div class="stats-label">Total Users</div>
                <div class="text-xs text-green-400 mt-1">+12% from last month</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="totalContent">0</div>
                <div class="stats-label">Content Items</div>
                <div class="text-xs text-blue-400 mt-1">+8% from last month</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="totalInteractions">0</div>
                <div class="stats-label">User Interactions</div>
                <div class="text-xs text-purple-400 mt-1">+25% from last month</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="activeUsers">0</div>
                <div class="stats-label">Active Users</div>
                <div class="text-xs text-yellow-400 mt-1">+5% from last week</div>
            </div>
        </div>

        <!-- Charts and Analytics -->
        <div class="grid grid-1 lg:grid-2 gap-8 mb-8">
            <!-- User Growth Chart -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-xl font-semibold mb-4">User Growth</h3>
                    <div id="userGrowthChart" class="h-64 flex items-center justify-center bg-gray-800 rounded">
                        <div class="text-center">
                            <div class="text-4xl mb-2">📈</div>
                            <p class="text-gray-400">Chart visualization would go here</p>
                            <p class="text-xs text-gray-500">Integration with Chart.js or similar library</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Engagement -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-xl font-semibold mb-4">Content Engagement</h3>
                    <div id="engagementChart" class="h-64 flex items-center justify-center bg-gray-800 rounded">
                        <div class="text-center">
                            <div class="text-4xl mb-2">💹</div>
                            <p class="text-gray-400">Engagement metrics chart</p>
                            <p class="text-xs text-gray-500">Shows views, likes, watchlist adds</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Content Analysis -->
        <div class="grid grid-1 lg:grid-2 gap-8 mb-8">
            <!-- Top Content -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-xl font-semibold mb-4">Top Performing Content</h3>
                    <div id="topContent" class="space-y-4">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Popular Genres -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-xl font-semibold mb-4">Popular Genres</h3>
                    <div id="popularGenres" class="space-y-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- User Behavior Analysis -->
        <div class="grid grid-1 lg:grid-3 gap-8 mb-8">
            <!-- User Activity Heatmap -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-lg font-semibold mb-4">Activity Heatmap</h3>
                    <div class="grid grid-7 gap-1 text-xs">
                        <!-- Days of week -->
                        <div class="text-center font-medium">S</div>
                        <div class="text-center font-medium">M</div>
                        <div class="text-center font-medium">T</div>
                        <div class="text-center font-medium">W</div>
                        <div class="text-center font-medium">T</div>
                        <div class="text-center font-medium">F</div>
                        <div class="text-center font-medium">S</div>
                        
                        <!-- Activity squares (simulated) -->
                        ${Array(28).fill(0).map((_, i) => `
                            <div class="aspect-square bg-gray-800 rounded-sm ${Math.random() > 0.5 ? 'bg-primary opacity-' + Math.floor(Math.random() * 100) : ''}" 
                                 title="Day ${i + 1}"></div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-2">
                        <span>Less</span>
                        <span>More</span>
                    </div>
                </div>
            </div>

            <!-- Device Statistics -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-lg font-semibold mb-4">Device Usage</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-sm">Mobile</span>
                            </div>
                            <span class="text-sm font-medium">65%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-sm">Desktop</span>
                            </div>
                            <span class="text-sm font-medium">25%</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                                <span class="text-sm">Tablet</span>
                            </div>
                            <span class="text-sm font-medium">10%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Retention -->
            <div class="card">
                <div class="card-content">
                    <h3 class="text-lg font-semibold mb-4">User Retention</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Day 1</span>
                                <span>78%</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Day 7</span>
                                <span>45%</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-2">
                                <div class="bg-yellow-500 h-2 rounded-full" style="width: 45%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Day 30</span>
                                <span>23%</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-2">
                                <div class="bg-red-500 h-2 rounded-full" style="width: 23%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="card mb-8">
            <div class="card-content">
                <h3 class="text-xl font-semibold mb-6">System Performance</h3>
                <div class="grid grid-1 md:grid-4 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400 mb-1">99.9%</div>
                        <div class="text-sm text-gray-400">Uptime</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-400 mb-1">1.2s</div>
                        <div class="text-sm text-gray-400">Avg Response</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-400 mb-1">15GB</div>
                        <div class="text-sm text-gray-400">Data Usage</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-400 mb-1">2.1K</div>
                        <div class="text-sm text-gray-400">API Calls/min</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Feed -->
        <div class="card">
            <div class="card-content">
                <h3 class="text-xl font-semibold mb-4">Recent Platform Activity</h3>
                <div id="activityFeed" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!appState.isAuthenticated() || !appState.isAdmin()) {
                window.location.href = '/login';
                return;
            }

            await loadAnalyticsData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('timeRangeFilter').addEventListener('change', loadAnalyticsData);
        }

        async function loadAnalyticsData() {
            try {
                const response = await api.getAnalytics();
                updateKeyMetrics(response);
                updateTopContent(response.popular_content || []);
                updatePopularGenres(response.popular_genres || []);
                updateActivityFeed();

            } catch (error) {
                console.error('Error loading analytics:', error);
                UI.showToast('Failed to load analytics data', 'error');
            }
        }

        function updateKeyMetrics(data) {
            document.getElementById('totalUsers').textContent = (data.total_users || 0).toLocaleString();
            document.getElementById('totalContent').textContent = (data.total_content || 0).toLocaleString();
            document.getElementById('totalInteractions').textContent = (data.total_interactions || 0).toLocaleString();
            document.getElementById('activeUsers').textContent = (data.active_users_last_week || 0).toLocaleString();
        }

        function updateTopContent(contentList) {
            const container = document.getElementById('topContent');
            
            if (contentList.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>No content data available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = contentList.slice(0, 10).map((item, index) => `
                <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-sm font-bold">
                        ${index + 1}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium truncate">${Utils.sanitizeHTML(item.title)}</h4>
                        <p class="text-sm text-gray-400">${item.interactions} interactions</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium">${item.interactions}</div>
                        <div class="text-xs text-gray-400">views</div>
                    </div>
                </div>
            `).join('');
        }

        function updatePopularGenres(genreList) {
            const container = document.getElementById('popularGenres');
            
            if (genreList.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <p>No genre data available</p>
                    </div>
                `;
                return;
            }

            const maxCount = Math.max(...genreList.map(g => g.count));

            container.innerHTML = genreList.slice(0, 8).map(genre => {
                const percentage = Math.round((genre.count / maxCount) * 100);
                return `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">${Utils.sanitizeHTML(genre.genre)}</span>
                        <div class="flex items-center gap-3 flex-1 ml-4">
                            <div class="flex-1 bg-gray-800 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full transition-all duration-300" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 w-8">${genre.count}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateActivityFeed() {
            const activities = [
                { type: 'user_signup', message: 'New user registered: john_doe', time: '2 minutes ago', icon: '👤' },
                { type: 'content_add', message: 'New movie added: "The Matrix Resurrections"', time: '5 minutes ago', icon: '🎬' },
                { type: 'interaction', message: 'High engagement on "Stranger Things S4"', time: '10 minutes ago', icon: '📈' },
                { type: 'admin_action', message: 'Admin recommendation created', time: '15 minutes ago', icon: '⭐' },
                { type: 'system', message: 'ML recommendations updated', time: '30 minutes ago', icon: '🤖' },
                { type: 'user_signup', message: 'New user registered: movie_lover_23', time: '45 minutes ago', icon: '👤' },
                { type: 'content_add', message: 'New anime series added: "Demon Slayer"', time: '1 hour ago', icon: '🎌' },
                { type: 'milestone', message: 'Platform reached 10,000 users!', time: '2 hours ago', icon: '🎉' },
            ];

            const container = document.getElementById('activityFeed');
            container.innerHTML = activities.map(activity => `
                <div class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-lg transition-colors">
                    <div class="text-2xl">${activity.icon}</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm">${activity.message}</p>
                        <p class="text-xs text-gray-400">${activity.time}</p>
                    </div>
                    <div class="w-2 h-2 bg-primary rounded-full"></div>
                </div>
            `).join('');
        }

        function exportAnalytics() {
            const timeRange = document.getElementById('timeRangeFilter').value;
            
            // Simulate analytics data export
            const analyticsData = {
                exported_at: new Date().toISOString(),
                time_range_days: timeRange,
                metrics: {
                    total_users: parseInt(document.getElementById('totalUsers').textContent.replace(/,/g, '')),
                    total_content: parseInt(document.getElementById('totalContent').textContent.replace(/,/g, '')),
                    total_interactions: parseInt(document.getElementById('totalInteractions').textContent.replace(/,/g, '')),
                    active_users: parseInt(document.getElementById('activeUsers').textContent.replace(/,/g, ''))
                },
                device_stats: {
                    mobile: 65,
                    desktop: 25,
                    tablet: 10
                },
                retention_rates: {
                    day_1: 78,
                    day_7: 45,
                    day_30: 23
                }
            };

            const dataStr = JSON.stringify(analyticsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `cinescope-analytics-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            UI.showToast('Analytics data exported successfully!', 'success');
        }

        // Simulate real-time updates
        setInterval(() => {
            // Update active users count with small random changes
            const activeUsersElement = document.getElementById('activeUsers');
            const currentValue = parseInt(activeUsersElement.textContent.replace(/,/g, ''));
            const change = Math.floor(Math.random() * 10) - 5; // Random change between -5 and +5
            const newValue = Math.max(0, currentValue + change);
            activeUsersElement.textContent = newValue.toLocaleString();
        }, 30000); // Update every 30 seconds
    </script>
</body>
</html>