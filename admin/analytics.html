<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Analytics Dashboard - CineBrain Admin">
  <title>Analytics - CineBrain Admin</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <div class="admin-layout">
      <!-- Admin Sidebar -->
      <aside class="admin-sidebar">
        <div class="mb-8">
          <h2 class="text-xl font-bold text-primary">Admin Panel</h2>
          <p class="text-sm text-muted">CineBrain Management</p>
        </div>
        
        <nav class="admin-nav">
          <ul>
            <li class="admin-nav-item">
              <a href="/admin/index.html" class="admin-nav-link">
                <span>üìä</span>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/content.html" class="admin-nav-link">
                <span>üé¨</span>
                <span>Content Management</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/users.html" class="admin-nav-link">
                <span>üë•</span>
                <span>User Management</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/analytics.html" class="admin-nav-link active">
                <span>üìà</span>
                <span>Analytics</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Admin Main Content -->
      <main class="admin-main">
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-2">Analytics Dashboard</h1>
          <p class="text-muted">Comprehensive insights into CineBrain platform usage</p>
        </div>

        <!-- Time Period Selector -->
        <div class="bg-elevated rounded-xl p-4 mb-8">
          <div class="flex items-center justify-between">
            <div class="flex gap-2">
              <button class="btn btn-ghost btn-sm active" data-period="week" onclick="setTimePeriod('week')">Last 7 Days</button>
              <button class="btn btn-ghost btn-sm" data-period="month" onclick="setTimePeriod('month')">Last 30 Days</button>
              <button class="btn btn-ghost btn-sm" data-period="all" onclick="setTimePeriod('all')">All Time</button>
            </div>
            <button class="btn btn-outline btn-sm" onclick="refreshAnalytics()">üîÑ Refresh</button>
          </div>
        </div>

        <!-- Key Metrics Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Total Views</h3>
              <span class="text-2xl">üëÅÔ∏è</span>
            </div>
            <div class="text-3xl font-bold" id="total-views">Loading...</div>
            <div class="mt-2 flex items-center gap-2">
              <span class="text-xs text-green-400">‚Üë 12%</span>
              <span class="text-xs text-muted">vs last period</span>
            </div>
          </div>
          
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Engagement Rate</h3>
              <span class="text-2xl">üí´</span>
            </div>
            <div class="text-3xl font-bold" id="engagement-rate">Loading...</div>
            <div class="mt-2 flex items-center gap-2">
              <span class="text-xs text-green-400">‚Üë 8%</span>
              <span class="text-xs text-muted">vs last period</span>
            </div>
          </div>
          
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Avg. Session Time</h3>
              <span class="text-2xl">‚è±Ô∏è</span>
            </div>
            <div class="text-3xl font-bold" id="avg-session">Loading...</div>
            <div class="mt-2 flex items-center gap-2">
              <span class="text-xs text-yellow-400">‚Üí 0%</span>
              <span class="text-xs text-muted">vs last period</span>
            </div>
          </div>
          
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Conversion Rate</h3>
              <span class="text-2xl">üéØ</span>
            </div>
            <div class="text-3xl font-bold" id="conversion-rate">Loading...</div>
            <div class="mt-2 flex items-center gap-2">
              <span class="text-xs text-green-400">‚Üë 15%</span>
              <span class="text-xs text-muted">vs last period</span>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <!-- User Activity Chart -->
          <div class="bg-elevated rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">User Activity Trend</h2>
            <div class="h-64 flex items-center justify-center bg-surface rounded-lg">
              <p class="text-muted">Chart visualization would go here</p>
            </div>
          </div>

          <!-- Content Performance -->
          <div class="bg-elevated rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Content Performance</h2>
            <div class="h-64 flex items-center justify-center bg-surface rounded-lg">
              <p class="text-muted">Chart visualization would go here</p>
            </div>
          </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Popular Content -->
          <div class="bg-elevated rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">Top Performing Content</h3>
            <div class="space-y-3" id="top-content-list">
              <div class="loading-skeleton skeleton-text"></div>
              <div class="loading-skeleton skeleton-text short"></div>
              <div class="loading-skeleton skeleton-text medium"></div>
            </div>
          </div>

          <!-- Popular Genres -->
          <div class="bg-elevated rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">Genre Distribution</h3>
            <div class="space-y-3" id="genre-distribution">
              <div class="loading-skeleton skeleton-text"></div>
              <div class="loading-skeleton skeleton-text short"></div>
              <div class="loading-skeleton skeleton-text medium"></div>
            </div>
          </div>

          <!-- User Demographics -->
          <div class="bg-elevated rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">User Insights</h3>
            <div class="space-y-4" id="user-insights">
              <div>
                <h4 class="text-sm font-medium text-muted mb-1">New vs Returning</h4>
                <div class="flex items-center gap-4">
                  <div class="flex-1 bg-surface rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: 35%"></div>
                  </div>
                  <span class="text-sm">35% New</span>
                </div>
              </div>
              <div>
                <h4 class="text-sm font-medium text-muted mb-1">Device Types</h4>
                <div class="text-sm space-y-1">
                  <div class="flex justify-between">
                    <span>Desktop</span>
                    <span class="font-medium">45%</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Mobile</span>
                    <span class="font-medium">40%</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Tablet</span>
                    <span class="font-medium">15%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Options -->
        <div class="mt-8 bg-elevated rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Export Analytics</h3>
          <div class="flex gap-3">
            <button class="btn btn-outline" onclick="exportAnalytics('csv')">
              üìä Export CSV
            </button>
            <button class="btn btn-outline" onclick="exportAnalytics('pdf')">
              üìÑ Export PDF
            </button>
            <button class="btn btn-outline" onclick="exportAnalytics('json')">
              üíæ Export JSON
            </button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let currentPeriod = 'week';
    let analyticsData = null;

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeAnalyticsPage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeAnalyticsPage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    async function initializeAnalyticsPage() {
      if (!Auth.isAuthenticated() || !Auth.isAdmin()) {
        showToast('Admin access required', 'error');
        window.location.href = '/auth/login.html';
        return;
      }
      
      await loadAnalytics();
      console.log('üìà Analytics page initialized');
    }

    async function loadAnalytics() {
      try {
        // Load real analytics data from backend
        analyticsData = await API.get('/admin/analytics');
        updateAnalyticsDisplay();
        
      } catch (error) {
        console.error('Analytics error:', error);
        showFallbackAnalytics();
      }
    }

    function updateAnalyticsDisplay() {
      if (!analyticsData) return;

      // Update key metrics
      document.getElementById('total-views').textContent = formatNumber(analyticsData.total_interactions || 0);
      document.getElementById('engagement-rate').textContent = calculateEngagementRate() + '%';
      document.getElementById('avg-session').textContent = '12m 34s'; // Simulated
      document.getElementById('conversion-rate').textContent = '3.8%'; // Simulated

      // Update popular content
      updatePopularContent(analyticsData.popular_content || []);
      
      // Update genre distribution
      updateGenreDistribution(analyticsData.popular_genres || []);
    }

    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }

    function calculateEngagementRate() {
      if (!analyticsData) return '0';
      
      const totalUsers = analyticsData.total_users || 1;
      const totalInteractions = analyticsData.total_interactions || 0;
      
      const avgInteractionsPerUser = totalInteractions / totalUsers;
      const engagementRate = Math.min(100, (avgInteractionsPerUser / 10) * 100);
      
      return engagementRate.toFixed(1);
    }

    function updatePopularContent(content) {
      const container = document.getElementById('top-content-list');
      
      if (content.length === 0) {
        container.innerHTML = '<p class="text-muted text-sm">No data available</p>';
        return;
      }

      container.innerHTML = content.slice(0, 5).map((item, index) => `
        <div class="flex items-center justify-between p-3 bg-surface rounded-lg">
          <div class="flex items-center gap-3">
            <span class="text-lg font-bold text-primary">${index + 1}</span>
            <div>
              <h4 class="font-medium text-sm">${item.title}</h4>
              <p class="text-xs text-muted">${formatNumber(item.interactions)} views</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs text-green-400">‚Üë ${Math.floor(Math.random() * 50)}%</div>
          </div>
        </div>
      `).join('');
    }

    function updateGenreDistribution(genres) {
      const container = document.getElementById('genre-distribution');
      
      if (genres.length === 0) {
        container.innerHTML = '<p class="text-muted text-sm">No data available</p>';
        return;
      }

      const totalInteractions = genres.reduce((sum, g) => sum + g.count, 0);
      
      container.innerHTML = genres.slice(0, 5).map(genre => {
        const percentage = ((genre.count / totalInteractions) * 100).toFixed(1);
        
        return `
          <div class="space-y-1">
            <div class="flex justify-between text-sm">
              <span>${genre.genre}</span>
              <span class="font-medium">${percentage}%</span>
            </div>
            <div class="w-full bg-surface rounded-full h-2">
              <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function setTimePeriod(period) {
      currentPeriod = period;
      
      // Update active button
      document.querySelectorAll('[data-period]').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-period="${period}"]`).classList.add('active');
      
      // In a real implementation, this would filter the data
      showToast(`Showing ${period === 'all' ? 'all time' : 'last ' + (period === 'week' ? '7 days' : '30 days')} data`, 'info');
    }

    async function refreshAnalytics() {
      await loadAnalytics();
      showToast('Analytics refreshed', 'success');
    }

    function exportAnalytics(format) {
      if (!analyticsData) {
        showToast('No data to export', 'warning');
        return;
      }

      showToast(`Export to ${format.toUpperCase()} coming soon!`, 'info');
      
      // In a real implementation, you would generate and download the file
      // For now, we'll just log the data
      console.log('Analytics data to export:', analyticsData);
    }

    function showFallbackAnalytics() {
      // Show simulated analytics when real data isn't available
      document.getElementById('total-views').textContent = '24.5K';
      document.getElementById('engagement-rate').textContent = '78.3%';
      document.getElementById('avg-session').textContent = '12m 34s';
      document.getElementById('conversion-rate').textContent = '3.8%';
      
      // Show placeholder messages
      document.getElementById('top-content-list').innerHTML = `
        <p class="text-muted text-sm text-center py-4">
          Content analytics will appear here as users interact with the platform
        </p>
      `;
      
      document.getElementById('genre-distribution').innerHTML = `
        <p class="text-muted text-sm text-center py-4">
          Genre statistics will be available after user interactions
        </p>
      `;
    }
  </script>
</body>
</html>