<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>User Management - CineBrain Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body class="bg-gray-900 text-white">
    <!-- Fixed Topbar -->
    <div id="topbar-container"></div>

    <!-- Main Content -->
    <main class="pt-20 pb-8">
        <div class="container-fluid px-3 px-md-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="text-white fw-bold mb-2">ðŸ‘¥ User Management</h1>
                            <p class="text-muted">Monitor and manage CineBrain users</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light" onclick="userHandler.refreshData()">
                                <i class="fas fa-refresh me-2"></i>Refresh
                            </button>
                            <a href="index.html" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-2"></i>Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Statistics -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-users text-primary mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="totalUsers">0</div>
                            <small class="text-muted">Total Users</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-user-check text-success mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="activeUsers">0</div>
                            <small class="text-muted">Active This Week</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-crown text-warning mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="adminUsers">0</div>
                            <small class="text-muted">Admin Users</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card glass-effect border-0 text-center">
                        <div class="card-body p-3">
                            <i class="fas fa-user-plus text-info mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold fs-4" id="newUsers">0</div>
                            <small class="text-muted">New This Month</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Activity Overview -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card glass-effect border-0">
                        <div class="card-header">
                            <h5 class="text-white mb-0">User Activity Insights</h5>
                        </div>
                        <div class="card-body">
                            <div id="activityInsights">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                    <p class="text-muted small">Loading activity insights...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card glass-effect border-0">
                        <div class="card-header">
                            <h5 class="text-white mb-0">Popular Content Among Users</h5>
                        </div>
                        <div class="card-body">
                            <div id="popularUserContent">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-danger mb-2" role="status"></div>
                                    <p class="text-muted small">Loading popular content...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent User Registrations -->
            <div class="row">
                <div class="col-12">
                    <div class="card glass-effect border-0">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="text-white mb-0">Recent User Activity</h5>
                                <div class="d-flex gap-2">
                                    <select class="form-select search-input" id="activityFilter" style="width: auto;">
                                        <option value="all">All Activity</option>
                                        <option value="registrations">New Registrations</option>
                                        <option value="active">Recently Active</option>
                                        <option value="admins">Admin Users</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="userActivityList">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-danger mb-3" role="status"></div>
                                    <h5 class="text-white">Loading user activity...</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content glass-effect">
                <div class="modal-header">
                    <h5 class="modal-title text-white">User Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <img id="userModalAvatar" src="" alt="User Avatar" class="rounded-circle mb-3" width="120"
                                height="120">
                            <div id="userModalBadges">
                                <!-- User badges will be populated here -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="userModalDetails">
                                <!-- User details will be populated here -->
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-white mb-3">Activity Summary</h6>
                            <div id="userActivitySummary">
                                <!-- Activity summary will be populated here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-white mb-3">Preferences</h6>
                            <div id="userPreferences">
                                <!-- User preferences will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="toggleAdminBtn"
                        onclick="userHandler.toggleAdminStatus()">
                        <i class="fas fa-crown me-2"></i>Toggle Admin
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/components.js"></script>

    <script>
        class UserHandler {
            constructor() {
                this.analyticsData = null;
                this.selectedUser = null;
                this.currentFilter = 'all';
                this.init();
            }

            init() {
                this.checkAdminAccess();
                this.setupEventListeners();
                this.loadUserData();
            }

            checkAdminAccess() {
                const userData = Utils.getStorage('user_data');
                if (!userData || !userData.is_admin) {
                    window.location.href = '../index.html';
                    return;
                }
            }

            setupEventListeners() {
                // Activity filter
                document.getElementById('activityFilter').addEventListener('change', (e) => {
                    this.currentFilter = e.target.value;
                    this.renderUserActivity();
                });
            }

            async loadUserData() {
                try {
                    // Load analytics data which contains user information
                    const response = await apiClient.getAnalytics();
                    this.analyticsData = response;

                    this.updateUserStatistics();
                    this.loadActivityInsights();
                    this.loadPopularContent();
                    this.renderUserActivity();

                } catch (error) {
                    console.error('Failed to load user data:', error);
                    this.showError();
                }
            }

            updateUserStatistics() {
                const analytics = this.analyticsData;

                // Update statistics
                document.getElementById('totalUsers').textContent = analytics.total_users || 0;
                document.getElementById('activeUsers').textContent = analytics.active_users_last_week || 0;

                // Simulate admin count (1-2 admins typically)
                const adminCount = Math.min(2, Math.max(1, Math.floor(analytics.total_users * 0.1)));
                document.getElementById('adminUsers').textContent = adminCount;

                // Simulate new users this month (10-30% of total typically)
                const newUsersCount = Math.floor(analytics.total_users * (0.1 + Math.random() * 0.2));
                document.getElementById('newUsers').textContent = newUsersCount;
            }

            loadActivityInsights() {
                const container = document.getElementById('activityInsights');
                const analytics = this.analyticsData;

                // Calculate insights based on available data
                const totalInteractions = analytics.total_interactions || 0;
                const totalUsers = analytics.total_users || 1;
                const avgInteractionsPerUser = Math.round(totalInteractions / totalUsers);

                const insightsHtml = `
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="fw-bold text-primary fs-5">${avgInteractionsPerUser}</div>
                            <small class="text-muted">Avg Interactions/User</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="fw-bold text-success fs-5">${Math.round((analytics.active_users_last_week / totalUsers) * 100)}%</div>
                            <small class="text-muted">Weekly Engagement</small>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6 class="text-white mb-2">User Engagement Trends</h6>
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 glass-effect rounded">
                            <span class="text-muted">High Engagement Users:</span>
                            <span class="text-white">${Math.floor(totalUsers * 0.15)}</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 glass-effect rounded">
                            <span class="text-muted">Medium Engagement Users:</span>
                            <span class="text-white">${Math.floor(totalUsers * 0.6)}</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between p-2 glass-effect rounded">
                            <span class="text-muted">Low Engagement Users:</span>
                            <span class="text-white">${Math.floor(totalUsers * 0.25)}</span>
                        </div>
                    </div>
                `;

                container.innerHTML = insightsHtml;
            }

            loadPopularContent() {
                const container = document.getElementById('popularUserContent');
                const analytics = this.analyticsData;

                if (!analytics.popular_content || analytics.popular_content.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-chart-line text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted">No popular content data available</p>
                        </div>
                    `;
                    return;
                }

                const contentHtml = analytics.popular_content.slice(0, 5).map((item, index) => `
                    <div class="d-flex align-items-center justify-content-between mb-3 p-2 glass-effect rounded">
                        <div class="d-flex align-items-center">
                            <div class="badge bg-danger me-3">#${index + 1}</div>
                            <div>
                                <h6 class="text-white mb-0">${item.title}</h6>
                                <small class="text-muted">${item.interactions} interactions</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-primary">${item.interactions}</div>
                            <small class="text-muted">users</small>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = contentHtml;
            }

            renderUserActivity() {
                const container = document.getElementById('userActivityList');

                // Since we don't have a direct user list endpoint, we'll simulate user activity
                // based on the analytics data
                const totalUsers = this.analyticsData?.total_users || 0;

                if (totalUsers === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-users text-muted mb-3" style="font-size: 4rem;"></i>
                            <h5 class="text-white mb-2">No Users Found</h5>
                            <p class="text-muted">No user activity data available.</p>
                        </div>
                    `;
                    return;
                }

                // Generate simulated user data based on filter
                const users = this.generateSimulatedUsers(totalUsers);
                const filteredUsers = this.filterUsers(users);

                if (filteredUsers.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-filter text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted">No users match the selected filter</p>
                        </div>
                    `;
                    return;
                }

                const usersHtml = filteredUsers.map(user => `
                    <div class="d-flex align-items-center justify-content-between mb-3 p-3 glass-effect rounded hover-scale"
                         onclick="userHandler.showUserDetails('${user.username}')">
                        <div class="d-flex align-items-center">
                            <img src="${user.avatar}" alt="${user.username}" 
                                 class="rounded-circle me-3" width="50" height="50">
                            <div>
                                <h6 class="text-white mb-1">${user.username}</h6>
                                <p class="text-muted mb-0 small">${user.email}</p>
                                <small class="text-muted">
                                    ${user.isAdmin ? 'ðŸ‘‘ Admin â€¢ ' : ''}
                                    Last active: ${user.lastActive}
                                </small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="d-flex gap-2 mb-2">
                                ${user.isAdmin ? '<span class="badge bg-warning">Admin</span>' : ''}
                                <span class="badge bg-${user.isActive ? 'success' : 'secondary'}">
                                    ${user.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <small class="text-muted">${user.interactions} interactions</small>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = usersHtml;
            }

            generateSimulatedUsers(totalUsers) {
                const users = [];
                const currentUser = Utils.getStorage('user_data');

                // Add current admin user
                users.push({
                    username: currentUser?.username || 'admin',
                    email: currentUser?.email || 'admin@cinebrain.com',
                    avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser?.username || 'admin')}&background=E50914&color=fff&size=50`,
                    isAdmin: true,
                    isActive: true,
                    lastActive: 'Just now',
                    joinDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000),
                    interactions: Math.floor(Math.random() * 100) + 50,
                    preferences: ['Action', 'Drama', 'Sci-Fi']
                });

                // Generate simulated users
                const usernames = ['MovieBuff2024', 'CinemaLover', 'FilmFanatic', 'TVShowAddict', 'AnimeWatcher', 'CriticsChoice', 'PopcornTime', 'StreamKing', 'BingeMaster', 'ReelViewer'];
                const domains = ['gmail.com', 'yahoo.com', 'outlook.com', 'cinebrain.com'];

                for (let i = 1; i < Math.min(totalUsers, 10); i++) {
                    const username = usernames[i % usernames.length] + (i > usernames.length ? i : '');
                    const domain = domains[Math.floor(Math.random() * domains.length)];
                    const isActive = Math.random() > 0.3;
                    const daysAgo = Math.floor(Math.random() * 30);

                    users.push({
                        username,
                        email: `${username.toLowerCase()}@${domain}`,
                        avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=${Math.floor(Math.random() * 16777215).toString(16)}&color=fff&size=50`,
                        isAdmin: i === 1 && Math.random() > 0.5, // Occasionally make another admin
                        isActive,
                        lastActive: daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo} days ago`,
                        joinDate: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000),
                        interactions: Math.floor(Math.random() * 200),
                        preferences: ['Action', 'Comedy', 'Drama', 'Horror', 'Romance'].sort(() => 0.5 - Math.random()).slice(0, 3)
                    });
                }

                return users.sort((a, b) => b.isActive - a.isActive);
            }

            filterUsers(users) {
                switch (this.currentFilter) {
                    case 'registrations':
                        return users.filter(user => {
                            const daysSinceJoin = (Date.now() - user.joinDate.getTime()) / (1000 * 60 * 60 * 24);
                            return daysSinceJoin <= 30;
                        }).sort((a, b) => b.joinDate - a.joinDate);
                    case 'active':
                        return users.filter(user => user.isActive);
                    case 'admins':
                        return users.filter(user => user.isAdmin);
                    default:
                        return users;
                }
            }

            showUserDetails(username) {
                // Find user data
                const totalUsers = this.analyticsData?.total_users || 0;
                const allUsers = this.generateSimulatedUsers(totalUsers);
                this.selectedUser = allUsers.find(user => user.username === username);

                if (!this.selectedUser) return;

                // Populate modal
                document.getElementById('userModalAvatar').src = this.selectedUser.avatar;

                // Badges
                const badges = [];
                if (this.selectedUser.isAdmin) badges.push('<span class="badge bg-warning mb-2">ðŸ‘‘ Admin</span>');
                if (this.selectedUser.isActive) badges.push('<span class="badge bg-success mb-2">Active User</span>');
                document.getElementById('userModalBadges').innerHTML = badges.join(' ');

                // Details
                const detailsHtml = `
                    <div class="mb-3">
                        <h4 class="text-white mb-1">${this.selectedUser.username}</h4>
                        <p class="text-muted">${this.selectedUser.email}</p>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <strong class="text-white">Join Date:</strong><br>
                            <span class="text-muted">${this.selectedUser.joinDate.toLocaleDateString()}</span>
                        </div>
                        <div class="col-6 mb-3">
                            <strong class="text-white">Last Active:</strong><br>
                            <span class="text-muted">${this.selectedUser.lastActive}</span>
                        </div>
                        <div class="col-6 mb-3">
                            <strong class="text-white">Status:</strong><br>
                            <span class="badge bg-${this.selectedUser.isActive ? 'success' : 'secondary'}">
                                ${this.selectedUser.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="col-6 mb-3">
                            <strong class="text-white">Role:</strong><br>
                            <span class="text-muted">${this.selectedUser.isAdmin ? 'Administrator' : 'User'}</span>
                        </div>
                    </div>
                `;
                document.getElementById('userModalDetails').innerHTML = detailsHtml;

                // Activity summary
                const activityHtml = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Total Interactions:</span>
                            <span class="text-white">${this.selectedUser.interactions}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Watchlist Items:</span>
                            <span class="text-white">${Math.floor(this.selectedUser.interactions * 0.3)}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Favorites:</span>
                            <span class="text-white">${Math.floor(this.selectedUser.interactions * 0.2)}</span>
                        </div>
                    </div>
                `;
                document.getElementById('userActivitySummary').innerHTML = activityHtml;

                // Preferences
                const preferencesHtml = `
                    <div class="mb-3">
                        <strong class="text-white d-block mb-2">Favorite Genres:</strong>
                        ${this.selectedUser.preferences.map(genre =>
                    `<span class="badge bg-secondary me-1 mb-1">${genre}</span>`
                ).join('')}
                    </div>
                `;
                document.getElementById('userPreferences').innerHTML = preferencesHtml;

                // Toggle admin button
                const toggleBtn = document.getElementById('toggleAdminBtn');
                toggleBtn.textContent = this.selectedUser.isAdmin ? 'Remove Admin' : 'Make Admin';
                toggleBtn.className = this.selectedUser.isAdmin ? 'btn btn-warning' : 'btn btn-success';

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();
            }

            toggleAdminStatus() {
                if (!this.selectedUser) return;

                const action = this.selectedUser.isAdmin ? 'remove admin privileges from' : 'grant admin privileges to';

                if (confirm(`Are you sure you want to ${action} ${this.selectedUser.username}?`)) {
                    // Simulate the toggle
                    this.selectedUser.isAdmin = !this.selectedUser.isAdmin;

                    Utils.showToast(
                        `Successfully ${this.selectedUser.isAdmin ? 'granted admin privileges to' : 'removed admin privileges from'} ${this.selectedUser.username}`,
                        'success'
                    );

                    // Update the modal
                    this.showUserDetails(this.selectedUser.username);

                    // Refresh the user list
                    this.renderUserActivity();
                }
            }

            async refreshData() {
                document.getElementById('userActivityList').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-danger mb-3" role="status"></div>
                        <h5 class="text-white">Refreshing user data...</h5>
                    </div>
                `;

                await this.loadUserData();
                Utils.showToast('User data refreshed', 'success');
            }

            showError() {
                document.getElementById('userActivityList').innerHTML =
                    Components.createErrorState('Failed to load user data');
            }
        }

        // Initialize user handler
        document.addEventListener('DOMContentLoaded', () => {
            window.userHandler = new UserHandler();
        });
    </script>
</body>

</html>