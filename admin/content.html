<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Content Management - CineScope Admin">
    <title>Content Management - CineScope Admin</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body class="admin-body">
    <!-- Admin Top Navigation -->
    <nav class="admin-topbar">
        <div class="admin-topbar-left">
            <a href="/" class="logo">üîß CineScope Admin</a>
        </div>
        <div class="admin-topbar-center">
            <div class="admin-breadcrumb">
                <a href="/admin/" class="breadcrumb-item">Dashboard</a>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-item active">Content Management</span>
            </div>
        </div>
        <div class="admin-topbar-right" id="adminUserSection"></div>
    </nav>

    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="/admin/content.html" class="nav-item active">
                <span class="nav-icon">üé¨</span>
                <span class="nav-label">Content Management</span>
            </a>
            <a href="/admin/users.html" class="nav-item">
                <span class="nav-icon">üë•</span>
                <span class="nav-label">User Management</span>
            </a>
            <a href="/admin/analytics.html" class="nav-item">
                <span class="nav-icon">üìà</span>
                <span class="nav-label">Analytics</span>
            </a>
            <div class="nav-divider"></div>
            <a href="/" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Back to Site</span>
            </a>
        </nav>
    </aside>

    <!-- Admin Main Content -->
    <main class="admin-main">
        <div class="admin-content">
            <div class="content-header">
                <h1>Content Management</h1>
                <p>Add and manage movies, TV shows, and anime in the database</p>
            </div>

            <!-- Content Stats -->
            <div class="content-stats-grid" id="contentStats">
                <div class="stat-card">
                    <div class="stat-icon">üé¨</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalContent">0</div>
                        <div class="stat-label">Total Content</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üé•</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalMovies">0</div>
                        <div class="stat-label">Movies</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì∫</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalShows">0</div>
                        <div class="stat-label">TV Shows</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéå</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalAnime">0</div>
                        <div class="stat-label">Anime</div>
                    </div>
                </div>
            </div>

            <!-- Content Search Section -->
            <div class="admin-section">
                <h2>Add New Content</h2>
                <div class="content-search-form">
                    <div class="search-controls">
                        <input type="text" 
                               id="contentSearchInput" 
                               class="admin-input" 
                               placeholder="Search for movies, TV shows, or anime..."
                               onkeydown="handleSearchKeydown(event)">
                        
                        <select id="contentSource" class="admin-select">
                            <option value="tmdb">TMDB (Movies & TV)</option>
                            <option value="anime">MyAnimeList (Anime)</option>
                        </select>
                        
                        <button class="btn btn-primary" onclick="searchExternalContent()">
                            Search
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div class="search-results" id="searchResults">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Recent Content -->
            <div class="admin-section">
                <h2>Recently Added Content</h2>
                <div class="recent-content-list" id="recentContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading recent content...</p>
                    </div>
                </div>
            </div>

            <!-- Bulk Import -->
            <div class="admin-section">
                <h2>Bulk Import</h2>
                <div class="bulk-import-controls">
                    <p>Import multiple titles at once from curated lists</p>
                    <div class="import-options">
                        <button class="btn btn-outline" onclick="importTrending()">
                            Import Trending (TMDB)
                        </button>
                        <button class="btn btn-outline" onclick="importTopRated()">
                            Import Top Rated
                        </button>
                        <button class="btn btn-outline" onclick="importNewReleases()">
                            Import New Releases
                        </button>
                        <button class="btn btn-outline" onclick="importTopAnime()">
                            Import Top Anime
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let isSearching = false;
        let recentlyAddedContent = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin authentication
            if (!window.auth.isAuthenticated() || !window.auth.isAdmin()) {
                window.location.href = '/';
                return;
            }

            updateAdminUserSection();
            await loadContentStats();
            await loadRecentContent();
        });

        async function loadContentStats() {
            try {
                const analytics = await window.api.getAnalytics();
                
                document.getElementById('totalContent').textContent = analytics.total_content || 0;
                
                // Estimate content types based on available data
                const totalContent = analytics.total_content || 0;
                document.getElementById('totalMovies').textContent = Math.floor(totalContent * 0.6);
                document.getElementById('totalShows').textContent = Math.floor(totalContent * 0.3);
                document.getElementById('totalAnime').textContent = Math.floor(totalContent * 0.1);
                
            } catch (error) {
                console.error('Failed to load content stats:', error);
            }
        }

        async function loadRecentContent() {
            try {
                // Load some recent trending content as "recently added"
                const trending = await window.api.getTrending({ limit: 10 });
                recentlyAddedContent = trending.recommendations || [];
                
                renderRecentContent();
            } catch (error) {
                console.error('Failed to load recent content:', error);
                document.getElementById('recentContent').innerHTML = '<p class="error-text">Failed to load recent content</p>';
            }
        }

        function renderRecentContent() {
            const container = document.getElementById('recentContent');
            
            if (recentlyAddedContent.length === 0) {
                container.innerHTML = '<p class="empty-state">No recent content</p>';
                return;
            }

            container.innerHTML = `
                <div class="content-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Poster</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Rating</th>
                                <th>Release Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentlyAddedContent.map(content => `
                                <tr>
                                    <td>
                                        <img src="${content.poster_path}" 
                                             alt="${content.title}" 
                                             class="table-poster">
                                    </td>
                                    <td>${content.title}</td>
                                    <td><span class="type-badge">${content.content_type}</span></td>
                                    <td>‚òÖ ${content.rating || 'N/A'}</td>
                                    <td>${content.release_date ? new Date(content.release_date).toLocaleDateString() : 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline" onclick="viewContent(${content.id})">
                                            View
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="createRecommendation(${content.id}, '${content.title.replace(/'/g, "\\'")}')">
                                            Recommend
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function searchExternalContent() {
            if (isSearching) return;
            
            const query = document.getElementById('contentSearchInput').value.trim();
            const source = document.getElementById('contentSource').value;
            const resultsContainer = document.getElementById('searchResults');

            if (!query) {
                showToast('Please enter a search query', 'warning');
                return;
            }

            isSearching = true;
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            try {
                const results = await window.api.adminSearch(query, source);
                
                if (results.results && results.results.length > 0) {
                    resultsContainer.innerHTML = `
                        <h3>Search Results (${results.results.length})</h3>
                        <div class="search-results-grid">
                            ${results.results.map(item => renderSearchResult(item)).join('')}
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '<p class="empty-state">No results found. Try different search terms.</p>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<p class="error-state">Search failed. Please try again.</p>';
            } finally {
                isSearching = false;
            }
        }

        function renderSearchResult(item) {
            return `
                <div class="search-result-card">
                    <div class="result-poster">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                    </div>
                    <div class="result-info">
                        <h4>${item.title}</h4>
                        <div class="result-meta">
                            <span class="type-badge">${item.content_type}</span>
                            ${item.release_date ? `<span class="year">${new Date(item.release_date).getFullYear()}</span>` : ''}
                            ${item.rating ? `<span class="rating">‚òÖ ${item.rating}</span>` : ''}
                        </div>
                        <p>${(item.overview || '').substring(0, 150)}${item.overview && item.overview.length > 150 ? '...' : ''}</p>
                        <div class="result-actions">
                            <button class="btn btn-primary btn-sm" onclick="addContentToDatabase(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                Add to Database
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="viewExternalDetails(${item.id})">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function addContentToDatabase(contentData) {
            try {
                showToast('Adding content to database...', 'info');
                
                const result = await window.api.saveExternalContent(contentData);
                
                if (result.content_id) {
                    showToast('Content added successfully!', 'success');
                    
                    // Refresh stats and recent content
                    await loadContentStats();
                    await loadRecentContent();
                    
                    // Clear search results
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('contentSearchInput').value = '';
                } else {
                    showToast('Content was already in database', 'info');
                }
            } catch (error) {
                console.error('Failed to add content:', error);
                showToast('Failed to add content to database', 'error');
            }
        }

        async function createRecommendation(contentId, title) {
            try {
                const recommendationData = {
                    content_id: contentId,
                    recommendation_type: 'admin_choice',
                    description: `Staff pick: ${title} is highly recommended by our editorial team.`
                };

                const result = await window.api.createAdminRecommendation(recommendationData);
                
                if (result.telegram_sent) {
                    showToast('Recommendation created and posted to Telegram!', 'success');
                } else {
                    showToast('Recommendation created successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Failed to create recommendation:', error);
                showToast('Failed to create recommendation', 'error');
            }
        }

        async function importTrending() {
            showToast('Importing trending content...', 'info');
            
            try {
                const trending = await window.api.getTrending({ limit: 20 });
                
                if (trending.recommendations && trending.recommendations.length > 0) {
                    // Add each trending item to database
                    const promises = trending.recommendations.map(item => 
                        window.api.saveExternalContent({
                            id: item.id,
                            title: item.title,
                            content_type: item.content_type,
                            release_date: item.release_date,
                            rating: item.rating,
                            overview: item.overview,
                            poster_path: item.poster_path,
                            genres: item.genres
                        })
                    );
                    
                    await Promise.all(promises);
                    
                    showToast(`Successfully imported ${trending.recommendations.length} trending items!`, 'success');
                    await loadContentStats();
                    await loadRecentContent();
                }
            } catch (error) {
                console.error('Failed to import trending content:', error);
                showToast('Failed to import trending content', 'error');
            }
        }

        async function importTopRated() {
            showToast('Importing top rated content...', 'info');
            
            try {
                const topRated = await window.api.getCriticsChoice({ limit: 20 });
                
                if (topRated.recommendations && topRated.recommendations.length > 0) {
                    const promises = topRated.recommendations.map(item => 
                        window.api.saveExternalContent({
                            id: item.id,
                            title: item.title,
                            content_type: item.content_type,
                            release_date: item.release_date,
                            rating: item.rating,
                            overview: item.overview,
                            poster_path: item.poster_path,
                            genres: item.genres
                        })
                    );
                    
                    await Promise.all(promises);
                    
                    showToast(`Successfully imported ${topRated.recommendations.length} top rated items!`, 'success');
                    await loadContentStats();
                    await loadRecentContent();
                }
            } catch (error) {
                console.error('Failed to import top rated content:', error);
                showToast('Failed to import top rated content', 'error');
            }
        }

        async function importNewReleases() {
            showToast('Importing new releases...', 'info');
            
            try {
                const newReleases = await window.api.getNewReleases({ limit: 20 });
                
                if (newReleases.recommendations && newReleases.recommendations.length > 0) {
                    const promises = newReleases.recommendations.map(item => 
                        window.api.saveExternalContent({
                            id: item.id,
                            title: item.title,
                            content_type: item.content_type,
                            release_date: item.release_date,
                            rating: item.rating,
                            overview: item.overview,
                            poster_path: item.poster_path,
                            genres: item.genres
                        })
                    );
                    
                    await Promise.all(promises);
                    
                    showToast(`Successfully imported ${newReleases.recommendations.length} new releases!`, 'success');
                    await loadContentStats();
                    await loadRecentContent();
                }
            } catch (error) {
                console.error('Failed to import new releases:', error);
                showToast('Failed to import new releases', 'error');
            }
        }

        async function importTopAnime() {
            showToast('Importing top anime...', 'info');
            
            try {
                const topAnime = await window.api.getAnimeRecommendations({ limit: 20 });
                
                if (topAnime.recommendations && topAnime.recommendations.length > 0) {
                    const promises = topAnime.recommendations.map(item => 
                        window.api.saveExternalContent({
                            id: item.mal_id || item.id,
                            title: item.title,
                            content_type: 'anime',
                            release_date: item.release_date,
                            rating: item.rating,
                            overview: item.overview,
                            poster_path: item.poster_path,
                            genres: item.genres,
                            source: 'anime'
                        })
                    );
                    
                    await Promise.all(promises);
                    
                    showToast(`Successfully imported ${topAnime.recommendations.length} anime titles!`, 'success');
                    await loadContentStats();
                    await loadRecentContent();
                }
            } catch (error) {
                console.error('Failed to import top anime:', error);
                showToast('Failed to import top anime', 'error');
            }
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchExternalContent();
            }
        }

        function viewContent(contentId) {
            window.open(`/content/details.html?id=${contentId}`, '_blank');
        }

        function viewExternalDetails(externalId) {
            // In a real app, this would open external source details
            showToast('External details view would be implemented', 'info');
        }

        // Utility Functions
        function updateAdminUserSection() {
            const userSection = document.getElementById('adminUserSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <div class="admin-user-info">
                        <img src="${window.auth.getUserAvatar()}" alt="${user.username}" class="admin-avatar">
                        <span class="admin-username">${user.username}</span>
                        <button class="btn btn-outline btn-sm" onclick="window.auth.logout()">Logout</button>
                    </div>
                `;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>