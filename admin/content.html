<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Content Management - CineBrain Admin">
  <title>Content Management - CineBrain Admin</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <div class="admin-layout">
      <!-- Admin Sidebar -->
      <aside class="admin-sidebar">
        <div class="mb-8">
          <h2 class="text-xl font-bold text-primary">Admin Panel</h2>
          <p class="text-sm text-muted">CineBrain Management</p>
        </div>
        
        <nav class="admin-nav">
          <ul>
            <li class="admin-nav-item">
              <a href="/admin/index.html" class="admin-nav-link">
                <span>📊</span>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/content.html" class="admin-nav-link active">
                <span>🎬</span>
                <span>Content Management</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/users.html" class="admin-nav-link">
                <span>👥</span>
                <span>User Management</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/analytics.html" class="admin-nav-link">
                <span>📈</span>
                <span>Analytics</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Admin Main Content -->
      <main class="admin-main">
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-2">Content Management</h1>
          <p class="text-muted">Add recommendations and manage content curation</p>
        </div>

        <!-- Add New Recommendation -->
        <div class="bg-elevated rounded-xl p-6 mb-8">
          <h2 class="text-2xl font-semibold mb-6">Add Admin Recommendation</h2>
          
          <!-- Search for Content -->
          <div class="mb-6">
            <label class="form-label">Search Content</label>
            <div class="flex gap-3">
              <input 
                type="text" 
                id="content-search" 
                class="form-input flex-1" 
                placeholder="Search movies, TV shows, or anime..."
              >
              <select id="search-source" class="form-input">
                <option value="tmdb">TMDB (Movies/TV)</option>
                <option value="anime">Anime (MAL)</option>
              </select>
              <button class="btn btn-primary" onclick="searchContent()">Search</button>
            </div>
          </div>

          <!-- Search Results -->
          <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" style="display: none;">
            <!-- Real search results loaded here -->
          </div>

          <!-- Selected Content -->
          <div id="selected-content" class="bg-surface rounded-lg p-4 mb-6" style="display: none;">
            <h3 class="font-semibold mb-2">Selected Content</h3>
            <div id="selected-info" class="flex items-center gap-4">
              <!-- Selected content displayed here -->
            </div>
          </div>

          <!-- Recommendation Form -->
          <form id="recommendation-form" style="display: none;">
            <div class="form-group">
              <label for="rec-type" class="form-label">Recommendation Type</label>
              <select id="rec-type" name="recommendation_type" class="form-input" required>
                <option value="admin_choice">Admin's Choice</option>
                <option value="must_watch">Must Watch</option>
                <option value="hidden_gem">Hidden Gem</option>
                <option value="cult_classic">Cult Classic</option>
                <option value="award_winner">Award Winner</option>
              </select>
            </div>

            <div class="form-group">
              <label for="rec-description" class="form-label">Recommendation Description</label>
              <textarea 
                id="rec-description" 
                name="description" 
                class="form-input h-32" 
                placeholder="Why are you recommending this content? What makes it special?"
                required
                maxlength="500"
              ></textarea>
              <p class="text-xs text-muted mt-1">This will be shared with users and on Telegram</p>
            </div>

            <div class="flex gap-3">
              <button type="submit" class="btn btn-primary">Create Recommendation</button>
              <button type="button" class="btn btn-outline" onclick="resetForm()">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Current Admin Recommendations -->
        <div class="bg-elevated rounded-xl p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold">Current Recommendations</h2>
            <button class="btn btn-outline btn-sm" onclick="refreshRecommendations()">🔄 Refresh</button>
          </div>

          <div id="recommendations-loading" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-muted">Loading recommendations...</p>
          </div>

          <div id="recommendations-list" class="space-y-4" style="display: none;">
            <!-- Real recommendations loaded here -->
          </div>

          <div id="no-recommendations" class="empty-state" style="display: none;">
            <h3>No Recommendations Yet</h3>
            <p>Start by searching for content and creating your first recommendation</p>
          </div>
        </div>

        <!-- ML Service Integration -->
        <div class="mt-8 bg-elevated rounded-xl p-6">
          <h2 class="text-2xl font-semibold mb-4">ML Recommendation Service</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-medium mb-2">Service Status</h3>
              <div class="flex items-center gap-2 mb-4">
                <div class="w-3 h-3 rounded-full" id="ml-status-dot"></div>
                <span id="ml-status-text">Checking...</span>
              </div>
              
              <button class="btn btn-outline w-full" onclick="forceMLUpdate()">
                Force Model Update
              </button>
            </div>
            
            <div>
              <h3 class="font-medium mb-2">ML Statistics</h3>
              <div id="ml-stats" class="space-y-2 text-sm">
                <div class="loading-skeleton skeleton-text"></div>
                <div class="loading-skeleton skeleton-text short"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Telegram Integration Info -->
        <div class="mt-8 p-4 bg-blue-500/10 rounded-lg border border-blue-500/20">
          <h3 class="text-sm font-medium text-blue-400 mb-2">📢 Telegram Integration</h3>
          <p class="text-xs text-muted">All admin recommendations are automatically posted to the CineBrain Telegram channel</p>
        </div>
      </main>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    let selectedContent = null;
    let currentRecommendations = [];

    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeContentPage();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeContentPage();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    async function initializeContentPage() {
      if (!Auth.isAuthenticated() || !Auth.isAdmin()) {
        showToast('Admin access required', 'error');
        window.location.href = '/auth/login.html';
        return;
      }
      
      setupEventListeners();
      await loadCurrentRecommendations();
      await checkMLServiceStatus();
      
      console.log('🎬 Content management initialized');
    }

    function setupEventListeners() {
      document.getElementById('recommendation-form').addEventListener('submit', handleRecommendationSubmit);
      
      document.getElementById('content-search').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          searchContent();
        }
      });
    }

    async function searchContent() {
      const query = document.getElementById('content-search').value.trim();
      const source = document.getElementById('search-source').value;
      
      if (!query) {
        showToast('Please enter a search query', 'warning');
        return;
      }

      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = '<div class="col-span-2 text-center"><div class="loading-spinner mx-auto"></div></div>';
      resultsContainer.style.display = 'grid';

      try {
        const results = await API.get('/admin/search', { query, source });
        
        if (results.results && results.results.length > 0) {
          displaySearchResults(results.results);
        } else {
          resultsContainer.innerHTML = '<div class="col-span-2 text-center text-muted">No results found</div>';
        }
      } catch (error) {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="col-span-2 text-center text-red-400">Search failed</div>';
      }
    }

    function displaySearchResults(results) {
      const container = document.getElementById('search-results');
      
      container.innerHTML = results.slice(0, 6).map(item => `
        <div class="bg-surface rounded-lg p-4 cursor-pointer hover:bg-velvet-dark transition" onclick='selectContent(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
          <div class="flex gap-3">
            <img 
              src="${item.poster_path || '/images/placeholder-poster.jpg'}" 
              alt="${item.title}" 
              class="w-16 h-24 object-cover rounded"
            >
            <div class="flex-1">
              <h4 class="font-semibold">${item.title}</h4>
              <p class="text-sm text-muted">
                ${item.content_type.toUpperCase()} • 
                ${item.release_date ? new Date(item.release_date).getFullYear() : 'N/A'} • 
                ⭐ ${item.rating || 'N/A'}
              </p>
              <p class="text-xs text-muted mt-1 line-clamp-2">${item.overview || 'No description'}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function selectContent(content) {
      selectedContent = content;
      
      // Save content to database if not already saved
      try {
        const saveResult = await API.post('/admin/content', content);
        if (saveResult.content_id) {
          selectedContent.content_id = saveResult.content_id;
        }
      } catch (error) {
        console.error('Error saving content:', error);
      }
      
      // Display selected content
      const selectedContainer = document.getElementById('selected-content');
      const selectedInfo = document.getElementById('selected-info');
      
      selectedInfo.innerHTML = `
        <img 
          src="${content.poster_path || '/images/placeholder-poster.jpg'}" 
          alt="${content.title}" 
          class="w-20 h-30 object-cover rounded"
        >
        <div>
          <h4 class="font-semibold text-lg">${content.title}</h4>
          <p class="text-muted">
            ${content.content_type.toUpperCase()} • 
            ${content.release_date ? new Date(content.release_date).getFullYear() : 'N/A'} • 
            ⭐ ${content.rating || 'N/A'}
          </p>
        </div>
      `;
      
      selectedContainer.style.display = 'block';
      document.getElementById('recommendation-form').style.display = 'block';
      document.getElementById('search-results').style.display = 'none';
      
      // Focus on recommendation type
      document.getElementById('rec-type').focus();
    }

    async function handleRecommendationSubmit(event) {
      event.preventDefault();
      
      if (!selectedContent) {
        showToast('Please select content first', 'warning');
        return;
      }

      const formData = new FormData(event.target);
      const recommendationData = {
        content_id: selectedContent.content_id || selectedContent.id,
        recommendation_type: formData.get('recommendation_type'),
        description: formData.get('description')
      };

      try {
        const result = await API.post('/admin/recommendations', recommendationData);
        
        if (result.message) {
          showToast('Recommendation created successfully!', 'success');
          
          if (result.telegram_sent) {
            showToast('Posted to Telegram channel', 'info');
          }
          
          // Reset form
          resetForm();
          
          // Refresh recommendations list
          await loadCurrentRecommendations();
        }
      } catch (error) {
        console.error('Recommendation error:', error);
        showToast('Failed to create recommendation', 'error');
      }
    }

    function resetForm() {
      selectedContent = null;
      document.getElementById('selected-content').style.display = 'none';
      document.getElementById('recommendation-form').style.display = 'none';
      document.getElementById('recommendation-form').reset();
      document.getElementById('content-search').value = '';
      document.getElementById('search-results').style.display = 'none';
    }

    async function loadCurrentRecommendations() {
      const loadingDiv = document.getElementById('recommendations-loading');
      const listDiv = document.getElementById('recommendations-list');
      const noRecsDiv = document.getElementById('no-recommendations');
      
      loadingDiv.style.display = 'block';
      listDiv.style.display = 'none';
      noRecsDiv.style.display = 'none';

      try {
        const result = await API.get('/admin/recommendations', { per_page: 20 });
        currentRecommendations = result.recommendations || [];
        
        if (currentRecommendations.length > 0) {
          displayRecommendations(currentRecommendations);
          listDiv.style.display = 'block';
        } else {
          noRecsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Load recommendations error:', error);
        noRecsDiv.style.display = 'block';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    function displayRecommendations(recommendations) {
      const container = document.getElementById('recommendations-list');
      
      container.innerHTML = recommendations.map(rec => `
        <div class="bg-surface rounded-lg p-4">
          <div class="flex gap-4">
            <img 
              src="${rec.content.poster_path ? 'https://image.tmdb.org/t/p/w200' + rec.content.poster_path : '/images/placeholder-poster.jpg'}" 
              alt="${rec.content.title}" 
              class="w-20 h-30 object-cover rounded"
            >
            <div class="flex-1">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h4 class="font-semibold text-lg">${rec.content.title}</h4>
                  <p class="text-sm text-muted">
                    ${rec.content.content_type.toUpperCase()} • 
                    ⭐ ${rec.content.rating || 'N/A'}
                  </p>
                </div>
                <span class="badge badge-primary">${rec.recommendation_type.replace('_', ' ')}</span>
              </div>
              <p class="text-sm mb-2">${rec.description}</p>
              <p class="text-xs text-muted">
                By ${rec.admin_name} • ${new Date(rec.created_at).toLocaleDateString()}
              </p>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function refreshRecommendations() {
      await loadCurrentRecommendations();
      showToast('Recommendations refreshed', 'success');
    }

    async function checkMLServiceStatus() {
      try {
        const status = await API.get('/admin/ml-service-check');
        updateMLStatus(status);
      } catch (error) {
        console.error('ML status check error:', error);
        updateMLStatus({ status: 'error' });
      }
    }

    function updateMLStatus(status) {
      const statusDot = document.getElementById('ml-status-dot');
      const statusText = document.getElementById('ml-status-text');
      
      if (status.status === 'healthy') {
        statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
        statusText.textContent = 'Service Healthy';
      } else if (status.status === 'partial') {
        statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500';
        statusText.textContent = 'Partial Service';
      } else {
        statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
        statusText.textContent = 'Service Unavailable';
      }

      // Update stats if available
      if (status.checks && status.checks.statistics) {
        const statsDiv = document.getElementById('ml-stats');
        statsDiv.innerHTML = `
          <div>Content Count: ${status.checks.statistics.data_count || 'N/A'}</div>
          <div>User Count: ${status.checks.statistics.user_count || 'N/A'}</div>
          <div>Response Time: ${status.checks.statistics.response_time || 'N/A'}</div>
        `;
      }
    }

    async function forceMLUpdate() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Updating...';
      btn.disabled = true;

      try {
        const result = await API.post('/admin/ml-service-update', {});
        
        if (result.success) {
          showToast('ML model update initiated', 'success');
        } else {
          showToast(result.message || 'Update failed', 'error');
        }
      } catch (error) {
        console.error('ML update error:', error);
        showToast('Failed to update ML service', 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
        
        // Refresh status
        await checkMLServiceStatus();
      }
    }
  </script>
</body>
</html>