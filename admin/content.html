<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Content Management - CineScope Admin</title>

    <link rel="preload" href="/js/config.js" as="script">
    <link rel="preload" href="/js/api.js" as="script">
    <link rel="preload" href="/js/auth.js" as="script">
    <link rel="preload" href="/js/app.js" as="script">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">

    <style>
        .admin-search-section {
            background: var(--theater-dark);
            padding: var(--spacing-xl);
            border-radius: 12px;
            margin-bottom: var(--spacing-xl);
        }

        .search-form {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .search-form input {
            flex: 1;
        }

        .external-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .external-item {
            background: var(--velvet-dark);
            padding: var(--spacing-md);
            border-radius: 8px;
            text-align: center;
        }

        .external-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: var(--spacing-sm);
        }

        .recommendation-form {
            background: var(--theater-dark);
            padding: var(--spacing-xl);
            border-radius: 12px;
            margin-top: var(--spacing-xl);
        }
    </style>
</head>

<body>
    <div id="topbar"></div>

    <main id="main-content">
        <div class="container">
            <h1>Content Management</h1>

            <div class="admin-search-section">
                <h2>Search External Content</h2>
                <div class="search-form">
                    <input type="text" id="external-search" class="form-input"
                        placeholder="Search movies, TV shows, anime...">
                    <select id="search-source" class="form-input" style="width: auto;">
                        <option value="tmdb">TMDB</option>
                        <option value="anime">Anime (MAL)</option>
                    </select>
                    <button class="btn-primary" onclick="searchExternal()">Search</button>
                </div>
                <div id="external-results"></div>
            </div>

            <div id="recommendation-section" style="display: none;">
                <div class="recommendation-form">
                    <h2>Create Admin Recommendation</h2>
                    <form id="recommendation-form">
                        <input type="hidden" id="content-id">
                        <div class="form-group">
                            <label class="form-label">Content Title</label>
                            <input type="text" id="content-title" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Recommendation Type</label>
                            <select id="rec-type" class="form-input">
                                <option value="admin_choice">Admin's Choice</option>
                                <option value="hidden_gem">Hidden Gem</option>
                                <option value="must_watch">Must Watch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="rec-description" class="form-input" rows="4"
                                placeholder="Why do you recommend this?"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Create Recommendation & Post to Telegram</button>
                    </form>
                </div>
            </div>

            <div class="page-section">
                <h2>Recent Admin Recommendations</h2>
                <div id="recent-recommendations"></div>
            </div>
        </div>
    </main>

    <div id="mobile-nav"></div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>
    <script>
        let selectedContent = null;

        async function searchExternal() {
            const query = document.getElementById('external-search').value;
            const source = document.getElementById('search-source').value;

            if (!query) return;

            try {
                const results = await API.admin.searchExternal(query, source);
                const resultsContainer = document.getElementById('external-results');

                if (results.results && results.results.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="external-results">
                            ${results.results.map(item => `
                                <div class="external-item">
                                    <img src="${item.poster_path || '/images/placeholder.jpg'}" alt="${item.title}">
                                    <h4>${item.title}</h4>
                                    <p>${item.content_type} • ${item.rating || 'N/A'} ⭐</p>
                                    <button class="btn-primary" onclick="selectContent(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                        Select
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '<p>No results found</p>';
                }
            } catch (error) {
                App.showToast('Search failed', 'error');
            }
        }

        async function selectContent(content) {
            selectedContent = content;

            // First save the content
            try {
                const savedContent = await API.admin.saveContent(content);

                document.getElementById('content-id').value = savedContent.content_id;
                document.getElementById('content-title').value = content.title;
                document.getElementById('recommendation-section').style.display = 'block';

                // Scroll to recommendation form
                document.getElementById('recommendation-section').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                App.showToast('Failed to save content', 'error');
            }
        }

        async function loadRecentRecommendations() {
            try {
                const recommendations = await API.admin.getRecommendations();
                const container = document.getElementById('recent-recommendations');

                if (recommendations.recommendations && recommendations.recommendations.length > 0) {
                    container.innerHTML = `
                        <div class="content-grid">
                            ${recommendations.recommendations.map(rec => `
                                <div class="content-card">
                                    <div class="card-poster">
                                        <img src="${rec.content.poster_path}" alt="${rec.content.title}">
                                    </div>
                                    <div class="card-info">
                                        <h3 class="card-title">${rec.content.title}</h3>
                                        <p class="text-muted">${rec.recommendation_type}</p>
                                        <p>${rec.description}</p>
                                        <p class="text-muted">By ${rec.admin_name} on ${new Date(rec.created_at).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p>No recommendations yet</p>';
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
            }
        }

        document.getElementById('recommendation-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                content_id: document.getElementById('content-id').value,
                recommendation_type: document.getElementById('rec-type').value,
                description: document.getElementById('rec-description').value
            };

            try {
                const result = await API.admin.createRecommendation(data);
                App.showToast('Recommendation created and posted to Telegram!', 'success');

                // Reset form
                document.getElementById('recommendation-form').reset();
                document.getElementById('recommendation-section').style.display = 'none';

                // Reload recommendations
                loadRecentRecommendations();
            } catch (error) {
                App.showToast('Failed to create recommendation', 'error');
            }
        });

        // Load recent recommendations on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!Auth.isAdmin()) {
                window.location.href = '/';
                return;
            }
            loadRecentRecommendations();
        });
    </script>
</body>

</html>