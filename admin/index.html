<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Admin Dashboard - CineScope</title>

    <link rel="preload" href="/js/config.js" as="script">
    <link rel="preload" href="/js/api.js" as="script">
    <link rel="preload" href="/js/auth.js" as="script">
    <link rel="preload" href="/js/app.js" as="script">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">
</head>

<body>
    <div id="topbar"></div>

    <main id="main-content">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading admin dashboard...</p>
        </div>
    </main>

    <div id="mobile-nav"></div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.isAdmin()) {
                window.location.href = '/';
                return;
            }

            try {
                const [analytics, mlStatus] = await Promise.all([
                    API.admin.getAnalytics(),
                    API.admin.checkMLService()
                ]);

                const mainContent = document.querySelector('#main-content');

                mainContent.innerHTML = `
                    <div class="admin-dashboard">
                        <div class="dashboard-header">
                            <h1>Admin Dashboard</h1>
                            <p>Welcome back, ${Auth.getUser().username}</p>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <h3>Total Users</h3>
                                <p class="dashboard-number">${analytics.total_users}</p>
                            </div>
                            <div class="dashboard-card">
                                <h3>Total Content</h3>
                                <p class="dashboard-number">${analytics.total_content}</p>
                            </div>
                            <div class="dashboard-card">
                                <h3>Total Interactions</h3>
                                <p class="dashboard-number">${analytics.total_interactions}</p>
                            </div>
                            <div class="dashboard-card">
                                <h3>Active Users (7d)</h3>
                                <p class="dashboard-number">${analytics.active_users_last_week}</p>
                            </div>
                        </div>
                        
                        <div class="page-section">
                            <h2>ML Service Status</h2>
                            <div class="section-content">
                                <p>Status: <span class="status-badge ${mlStatus.status}">${mlStatus.status}</span></p>
                                <p>URL: ${mlStatus.ml_service_url || 'Not configured'}</p>
                                ${mlStatus.status === 'healthy' ? `
                                    <button class="btn-primary" onclick="updateMLService()">Force Update Models</button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="page-section">
                            <h2>Quick Actions</h2>
                            <div class="section-content">
                                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                                    <a href="/admin/content.html" class="btn-primary">Manage Content</a>
                                    <a href="/admin/users.html" class="btn-secondary">Manage Users</a>
                                    <a href="/admin/analytics.html" class="btn-secondary">View Analytics</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="page-section">
                            <h2>Popular Content</h2>
                            <div class="section-content">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Interactions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${analytics.popular_content.map(item => `
                                            <tr>
                                                <td>${item.title}</td>
                                                <td>${item.interactions}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                window.updateMLService = async () => {
                    try {
                        const result = await API.admin.updateMLService();
                        App.showToast(result.message || 'ML service update initiated', 'success');
                    } catch (error) {
                        App.showToast('Failed to update ML service', 'error');
                    }
                };

            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        });
    </script>
</body>

</html>