<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope Admin</a>

                <div class="navbar__menu">
                    <a href="/admin/index.html" class="navbar__link navbar__link--active">Dashboard</a>
                    <a href="/admin/content.html" class="navbar__link">Content</a>
                    <a href="/admin/recommendations.html" class="navbar__link">Recommendations</a>
                    <a href="/admin/analytics.html" class="navbar__link">Analytics</a>
                </div>

                <div class="navbar__user">
                    <span class="text-sm text-muted me-md">Admin Panel</span>
                    <button class="btn btn-sm btn-secondary" onclick="auth.logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Admin Layout -->
        <div class="admin-layout">
            <!-- Sidebar -->
            <aside class="admin-sidebar">
                <div class="sidebar__section">
                    <h3 class="sidebar__title">Quick Actions</h3>
                    <nav class="sidebar__nav">
                        <a href="/admin/content.html" class="sidebar__link">
                            <i class="bi bi-plus-circle"></i> Add Content
                        </a>
                        <a href="/admin/recommendations.html" class="sidebar__link">
                            <i class="bi bi-star"></i> Create Recommendation
                        </a>
                        <a href="#" onclick="checkMLService()" class="sidebar__link">
                            <i class="bi bi-cpu"></i> ML Service Status
                        </a>
                    </nav>
                </div>

                <div class="sidebar__section">
                    <h3 class="sidebar__title">Navigation</h3>
                    <nav class="sidebar__nav">
                        <a href="/admin/index.html" class="sidebar__link sidebar__link--active">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                        <a href="/admin/content.html" class="sidebar__link">
                            <i class="bi bi-collection-play"></i> Content Management
                        </a>
                        <a href="/admin/recommendations.html" class="sidebar__link">
                            <i class="bi bi-award"></i> Recommendations
                        </a>
                        <a href="/admin/analytics.html" class="sidebar__link">
                            <i class="bi bi-graph-up"></i> Analytics
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="admin-content">
                <div class="admin-header">
                    <h1>Dashboard</h1>
                    <div class="d-flex gap-sm">
                        <button class="btn btn-primary" onclick="refreshDashboard()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="admin-stats animate-fadeIn">
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__label">Total Users</div>
                        <div class="admin-stat-card__value" id="totalUsers">
                            <div class="skeleton" style="height: 40px; width: 100px;"></div>
                        </div>
                        <div class="admin-stat-card__change text-success">
                            <i class="bi bi-arrow-up"></i> <span id="userGrowth">--</span>
                        </div>
                    </div>

                    <div class="admin-stat-card">
                        <div class="admin-stat-card__label">Total Content</div>
                        <div class="admin-stat-card__value" id="totalContent">
                            <div class="skeleton" style="height: 40px; width: 100px;"></div>
                        </div>
                        <div class="admin-stat-card__change text-success">
                            <i class="bi bi-arrow-up"></i> <span id="contentGrowth">--</span>
                        </div>
                    </div>

                    <div class="admin-stat-card">
                        <div class="admin-stat-card__label">Total Interactions</div>
                        <div class="admin-stat-card__value" id="totalInteractions">
                            <div class="skeleton" style="height: 40px; width: 100px;"></div>
                        </div>
                        <div class="admin-stat-card__change text-success">
                            <i class="bi bi-arrow-up"></i> <span id="interactionGrowth">--</span>
                        </div>
                    </div>

                    <div class="admin-stat-card">
                        <div class="admin-stat-card__label">Active Users (7d)</div>
                        <div class="admin-stat-card__value" id="activeUsers">
                            <div class="skeleton" style="height: 40px; width: 100px;"></div>
                        </div>
                        <div class="admin-stat-card__change" id="activeUserChange">
                            <span>--</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mt-xl">
                    <!-- Popular Content -->
                    <div class="col-lg-6 mb-lg">
                        <div class="bg-secondary rounded-lg p-lg">
                            <h3 class="mb-lg">Popular Content</h3>
                            <div id="popularContent">
                                <div class="skeleton mb-md" style="height: 60px;"></div>
                                <div class="skeleton mb-md" style="height: 60px;"></div>
                                <div class="skeleton mb-md" style="height: 60px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Popular Genres -->
                    <div class="col-lg-6 mb-lg">
                        <div class="bg-secondary rounded-lg p-lg">
                            <h3 class="mb-lg">Popular Genres</h3>
                            <div id="popularGenres">
                                <div class="skeleton mb-md" style="height: 40px;"></div>
                                <div class="skeleton mb-md" style="height: 40px;"></div>
                                <div class="skeleton mb-md" style="height: 40px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-secondary rounded-lg p-lg mt-lg">
                    <h3 class="mb-lg">Recent Admin Activity</h3>
                    <div id="recentActivity">
                        <div class="skeleton mb-md" style="height: 60px;"></div>
                        <div class="skeleton mb-md" style="height: 60px;"></div>
                    </div>
                </div>

                <!-- ML Service Status -->
                <div class="bg-secondary rounded-lg p-lg mt-lg">
                    <div class="d-flex justify-between align-center mb-lg">
                        <h3 class="mb-0">ML Service Status</h3>
                        <button class="btn btn-sm btn-secondary" onclick="checkMLService()">
                            <i class="bi bi-arrow-clockwise"></i> Check Status
                        </button>
                    </div>
                    <div id="mlServiceStatus">
                        <p class="text-muted">Click "Check Status" to verify ML service connection</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        // Check admin authentication
        if (!auth.requireAdmin()) {
            // Will redirect if not admin
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const analytics = await api.getAnalytics();

                // Update stats
                document.getElementById('totalUsers').textContent = analytics.total_users.toLocaleString();
                document.getElementById('totalContent').textContent = analytics.total_content.toLocaleString();
                document.getElementById('totalInteractions').textContent = analytics.total_interactions.toLocaleString();
                document.getElementById('activeUsers').textContent = analytics.active_users_last_week.toLocaleString();

                // Calculate growth (simulated)
                document.getElementById('userGrowth').textContent = '+12%';
                document.getElementById('contentGrowth').textContent = '+8%';
                document.getElementById('interactionGrowth').textContent = '+25%';
                document.getElementById('activeUserChange').innerHTML = '<i class="bi bi-arrow-up"></i> +5%';
                document.getElementById('activeUserChange').className = 'admin-stat-card__change text-success';

                // Render popular content
                renderPopularContent(analytics.popular_content);

                // Render popular genres
                renderPopularGenres(analytics.popular_genres);

                // Load recent activity
                loadRecentActivity();

            } catch (error) {
                console.error('Failed to load analytics:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        function renderPopularContent(content) {
            const container = document.getElementById('popularContent');

            if (!content || content.length === 0) {
                container.innerHTML = '<p class="text-muted">No data available</p>';
                return;
            }

            container.innerHTML = content.slice(0, 5).map((item, index) => `
                <div class="d-flex justify-between align-center p-md bg-tertiary rounded mb-sm animate-fadeInUp" 
                     style="animation-delay: ${index * 0.1}s">
                    <div>
                        <p class="font-weight-semibold mb-xs">${index + 1}. ${item.title}</p>
                        <p class="text-sm text-muted mb-0">${item.interactions} interactions</p>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="navigateToContentDetails(${item.id || 1})">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderPopularGenres(genres) {
            const container = document.getElementById('popularGenres');

            if (!genres || genres.length === 0) {
                container.innerHTML = '<p class="text-muted">No data available</p>';
                return;
            }

            const maxCount = Math.max(...genres.map(g => g.count));

            container.innerHTML = genres.slice(0, 5).map((genre, index) => `
                <div class="mb-md animate-fadeInUp" style="animation-delay: ${index * 0.1}s">
                    <div class="d-flex justify-between mb-xs">
                        <span class="font-weight-semibold">${genre.genre}</span>
                        <span class="text-sm text-muted">${genre.count} views</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-gradient-primary" 
                             style="width: ${(genre.count / maxCount) * 100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        async function loadRecentActivity() {
            try {
                const response = await api.getAdminRecommendations(1, 5);
                const container = document.getElementById('recentActivity');

                if (!response.recommendations || response.recommendations.length === 0) {
                    container.innerHTML = '<p class="text-muted">No recent activity</p>';
                    return;
                }

                container.innerHTML = response.recommendations.map((rec, index) => `
                    <div class="d-flex align-center gap-md p-md bg-tertiary rounded mb-sm animate-fadeInUp"
                         style="animation-delay: ${index * 0.1}s">
                        <i class="bi bi-award-fill text-gold text-xl"></i>
                        <div class="flex-grow-1">
                            <p class="mb-xs">
                                <strong>${rec.admin_name}</strong> recommended 
                                <strong>${rec.content.title}</strong>
                            </p>
                            <p class="text-xs text-muted mb-0">${formatRelativeTime(rec.created_at)}</p>
                        </div>
                        <button class="btn btn-sm btn-secondary" 
                                onclick="navigateToContentDetails(${rec.content.id})">
                            View
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent activity:', error);
            }
        }

        async function checkMLService() {
            const statusContainer = document.getElementById('mlServiceStatus');
            statusContainer.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch('/api/admin/ml-service-check', {
                    headers: {
                        'Authorization': `Bearer ${Storage.getToken()}`
                    }
                });

                const data = await response.json();

                if (data.status === 'healthy') {
                    statusContainer.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-sm"></i>
                            ML Service is operational
                            <ul class="mt-sm mb-0 text-sm">
                                <li>Response Time: ${data.checks?.connectivity?.response_time || 'N/A'}</li>
                                <li>Models Initialized: ${data.checks?.connectivity?.models_initialized ? 'Yes' : 'No'}</li>
                                <li>Data Ready: ${data.checks?.database_integration?.data_ready ? 'Yes' : 'No'}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    statusContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-sm"></i>
                            ML Service Status: ${data.status}
                            <p class="mb-0 text-sm mt-sm">${data.message || 'Service may be experiencing issues'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-sm"></i>
                        Failed to check ML service status
                    </div>
                `;
            }
        }

        function refreshDashboard() {
            showToast('Refreshing dashboard...', 'info');
            loadDashboardData();
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;

            return date.toLocaleDateString();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>

</html>