<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Admin Dashboard - CineScope</title>
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="/css/main.css" as="style">
    <link rel="preload" href="/js/config.js" as="script">
    <link rel="preload" href="/js/api.js" as="script">
    <link rel="preload" href="/js/auth.js" as="script">
    <link rel="preload" href="/js/app.js" as="script">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
    <div id="app">
        <div class="admin-page">
            <aside class="admin-sidebar">
                <h3>Admin Panel</h3>
                <nav class="admin-nav">
                    <a href="/admin/index.html" class="admin-nav-item active">Dashboard</a>
                    <a href="/admin/content.html" class="admin-nav-item">Content Management</a>
                    <a href="/admin/users.html" class="admin-nav-item">User Management</a>
                    <a href="/admin/analytics.html" class="admin-nav-item">Analytics</a>
                    <a href="/" class="admin-nav-item">Back to Site</a>
                </nav>
            </aside>
            
            <main class="admin-content">
                <div class="admin-header">
                    <h1>Admin Dashboard</h1>
                    <p>Welcome back, <span id="admin-name"></span></p>
                </div>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-icon">ðŸ‘¥</div>
                        <div class="card-content">
                            <h3>Total Users</h3>
                            <p class="card-value" id="total-users">-</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon">ðŸŽ¬</div>
                        <div class="card-content">
                            <h3>Total Content</h3>
                            <p class="card-value" id="total-content">-</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon">ðŸ’¬</div>
                        <div class="card-content">
                            <h3>Total Interactions</h3>
                            <p class="card-value" id="total-interactions">-</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon">ðŸ“ˆ</div>
                        <div class="card-content">
                            <h3>Active Users (7d)</h3>
                            <p class="card-value" id="active-users">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-sections">
                    <section class="dashboard-section">
                        <h2>ML Service Status</h2>
                        <div id="ml-status" class="ml-status">
                            <div class="loading">
                                <div class="loader-spinner"></div>
                                <p>Checking ML service...</p>
                            </div>
                        </div>
                    </section>
                    
                    <section class="dashboard-section">
                        <h2>Popular Content</h2>
                        <div id="popular-content" class="content-table">
                            <div class="loading">
                                <div class="loader-spinner"></div>
                            </div>
                        </div>
                    </section>
                    
                    <section class="dashboard-section">
                        <h2>Popular Genres</h2>
                        <div id="popular-genres" class="genre-stats">
                            <div class="loading">
                                <div class="loader-spinner"></div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>
    
    <script>
        // Check admin authentication
        if (!Auth.requireAdmin()) {
            // Will redirect to home
        }
        
        async function loadDashboard() {
            const user = Auth.getUser();
            document.getElementById('admin-name').textContent = user?.username || 'Admin';
            
            try {
                // Load analytics
                const response = await API.request(API_ENDPOINTS.ADMIN_ANALYTICS);
                
                // Update stats
                document.getElementById('total-users').textContent = response.total_users || 0;
                document.getElementById('total-content').textContent = response.total_content || 0;
                document.getElementById('total-interactions').textContent = response.total_interactions || 0;
                document.getElementById('active-users').textContent = response.active_users_last_week || 0;
                
                // Popular content
                if (response.popular_content && response.popular_content.length > 0) {
                    document.getElementById('popular-content').innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Interactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${response.popular_content.map(item => `
                                    <tr>
                                        <td>${item.title}</td>
                                        <td>${item.interactions}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                // Popular genres
                if (response.popular_genres && response.popular_genres.length > 0) {
                    document.getElementById('popular-genres').innerHTML = response.popular_genres.map(genre => `
                        <div class="genre-bar">
                            <span class="genre-name">${genre.genre}</span>
                            <div class="genre-progress">
                                <div class="genre-fill" style="width: ${(genre.count / response.popular_genres[0].count) * 100}%"></div>
                            </div>
                            <span class="genre-count">${genre.count}</span>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
            
            // Check ML service
            checkMLService();
        }
        
        async function checkMLService() {
            try {
                const response = await API.request(API_ENDPOINTS.ADMIN_ML_CHECK);
                
                const statusDiv = document.getElementById('ml-status');
                const statusClass = response.status === 'healthy' ? 'status-healthy' : 
                                   response.status === 'partial' ? 'status-partial' : 'status-unhealthy';
                
                statusDiv.innerHTML = `
                    <div class="status-indicator ${statusClass}">
                        <div class="status-dot"></div>
                        <span>ML Service: ${response.status.toUpperCase()}</span>
                    </div>
                    
                    <div class="status-details">
                        <h4>Service Checks</h4>
                        ${Object.entries(response.checks).map(([check, result]) => `
                            <div class="check-item">
                                <span>${check}:</span>
                                <span class="${result.status === 'pass' ? 'text-success' : 'text-error'}">
                                    ${result.status === 'pass' ? 'âœ“' : 'âœ—'} ${result.status}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${response.quick_actions.force_update_available ? `
                        <button class="btn btn-primary" onclick="forceMLUpdate()">Force ML Update</button>
                    ` : ''}
                `;
            } catch (error) {
                document.getElementById('ml-status').innerHTML = `
                    <div class="status-indicator status-unhealthy">
                        <div class="status-dot"></div>
                        <span>ML Service: OFFLINE</span>
                    </div>
                `;
            }
        }
        
        async function forceMLUpdate() {
            if (!confirm('Force update ML models? This may take a few moments.')) return;
            
            try {
                await API.request(API_ENDPOINTS.ADMIN_ML_UPDATE, { method: 'POST' });
                app.showToast('ML update initiated', 'success');
                setTimeout(checkMLService, 5000);
            } catch (error) {
                app.showToast('Failed to update ML service', 'error');
            }
        }
        
        // Load dashboard on page load
        loadDashboard();
    </script>
    
    <style>
        .admin-header {
            margin-bottom: var(--space-2xl);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }
        
        .dashboard-card {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            padding: var(--space-xl);
            background: var(--surface-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }
        
        .card-icon {
            font-size: 3rem;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-500);
        }
        
        .dashboard-sections {
            display: grid;
            gap: var(--space-2xl);
        }
        
        .dashboard-section {
            background: var(--surface-secondary);
            padding: var(--space-xl);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }
        
        .dashboard-section h2 {
            margin-bottom: var(--space-lg);
        }
        
        /* ML Status */
        .ml-status {
            padding: var(--space-lg);
            background: var(--surface-tertiary);
            border-radius: 4px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-weight: 600;
            margin-bottom: var(--space-lg);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-healthy .status-dot {
            background: #10b981;
        }
        
        .status-partial .status-dot {
            background: #f59e0b;
        }
        
        .status-unhealthy .status-dot {
            background: #ef4444;
        }
        
        .status-details {
            margin-top: var(--space-lg);
        }
        
        .check-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
        }
        
        .text-success {
            color: #10b981;
        }
        
        .text-error {
            color: #ef4444;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
        }
        
        th {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* Genre Stats */
        .genre-bar {
            display: grid;
            grid-template-columns: 120px 1fr 60px;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .genre-progress {
            height: 8px;
            background: var(--surface-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .genre-fill {
            height: 100%;
            background: var(--primary-500);
            transition: width var(--transition-medium);
        }
        
        .genre-count {
            text-align: right;
            font-weight: 600;
        }
    </style>
</body>
</html>