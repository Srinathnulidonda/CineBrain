<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Admin Dashboard - CineBrain">
  <title>Admin Dashboard - CineBrain</title>
  
  <!-- Critical CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layouts.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <!-- Fixed Topbar -->
  <div id="topbar"></div>

  <!-- Main Content -->
  <div class="page-layout">
    <div class="admin-layout">
      <!-- Admin Sidebar -->
      <aside class="admin-sidebar">
        <div class="mb-8">
          <h2 class="text-xl font-bold text-primary">Admin Panel</h2>
          <p class="text-sm text-muted">CineBrain Management</p>
        </div>
        
        <nav class="admin-nav">
          <ul>
            <li class="admin-nav-item">
              <a href="/admin/index.html" class="admin-nav-link active">
                <span>üìä</span>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/content.html" class="admin-nav-link">
                <span>üé¨</span>
                <span>Content Management</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/users.html" class="admin-nav-link">
                <span>üë•</span>
                <span>User Management</span>
              </a>
            </li>
            <li class="admin-nav-item">
              <a href="/admin/analytics.html" class="admin-nav-link">
                <span>üìà</span>
                <span>Analytics</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Admin Main Content -->
      <main class="admin-main">
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-2">Dashboard Overview</h1>
          <p class="text-muted">Welcome back, Admin. Here's what's happening with CineBrain.</p>
        </div>

        <!-- Real-time Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Total Users</h3>
              <span class="text-2xl">üë•</span>
            </div>
            <div class="text-3xl font-bold" id="total-users">Loading...</div>
            <p class="text-sm text-green-400" id="users-growth">+0% from last week</p>
          </div>
          
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Total Content</h3>
              <span class="text-2xl">üé¨</span>
            </div>
            <div class="text-3xl font-bold" id="total-content">Loading...</div>
            <p class="text-sm text-blue-400" id="content-growth">Database items</p>
          </div>
          
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Active Users</h3>
              <span class="text-2xl">üü¢</span>
            </div>
            <div class="text-3xl font-bold" id="active-users">Loading...</div>
            <p class="text-sm text-yellow-400" id="active-growth">Last 7 days</p>
          </div>
          
          <div class="bg-elevated rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium text-muted">Total Interactions</h3>
              <span class="text-2xl">üí´</span>
            </div>
            <div class="text-3xl font-bold" id="total-interactions">Loading...</div>
            <p class="text-sm text-purple-400" id="interactions-growth">All time</p>
          </div>
        </div>

        <!-- ML Service Status -->
        <div class="bg-elevated rounded-xl p-6 mb-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">ML Recommendation Service</h2>
            <button class="btn btn-outline btn-sm" onclick="checkMLService()">üîÑ Refresh Status</button>
          </div>
          
          <div id="ml-status-content">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse" id="ml-status-indicator"></div>
              <span id="ml-status-text">Checking ML service status...</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="ml-metrics">
              <!-- ML metrics loaded here -->
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Popular Content -->
          <div class="bg-elevated rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Popular Content</h2>
            <div class="space-y-3" id="popular-content-list">
              <div class="loading-skeleton skeleton-text"></div>
              <div class="loading-skeleton skeleton-text short"></div>
              <div class="loading-skeleton skeleton-text medium"></div>
            </div>
          </div>

          <!-- Popular Genres -->
          <div class="bg-elevated rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4">Popular Genres</h2>
            <div class="space-y-3" id="popular-genres-list">
              <div class="loading-skeleton skeleton-text"></div>
              <div class="loading-skeleton skeleton-text short"></div>
              <div class="loading-skeleton skeleton-text medium"></div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-8">
          <h2 class="text-xl font-semibold mb-4">Quick Actions</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button class="btn btn-outline p-6 h-auto flex flex-col items-center" onclick="goToContentManagement()">
              <span class="text-3xl mb-2">üé¨</span>
              <span class="font-medium">Manage Content</span>
              <span class="text-sm text-muted">Add recommendations</span>
            </button>
            
            <button class="btn btn-outline p-6 h-auto flex flex-col items-center" onclick="goToAnalytics()">
              <span class="text-3xl mb-2">üìä</span>
              <span class="font-medium">View Analytics</span>
              <span class="text-sm text-muted">Detailed insights</span>
            </button>
            
            <button class="btn btn-outline p-6 h-auto flex flex-col items-center" onclick="goToUsers()">
              <span class="text-3xl mb-2">üë•</span>
              <span class="font-medium">User Management</span>
              <span class="text-sm text-muted">Manage users</span>
            </button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/app.js"></script>

  <!-- Page-Specific Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      loadComponents();
      
      window.addEventListener('appReady', function() {
        initializeAdminDashboard();
      });
      
      if (window.app && window.app.isInitialized) {
        initializeAdminDashboard();
      }
    });

    async function loadComponents() {
      try {
        const topbarResponse = await fetch('/components/layout/topbar.html');
        const topbarHTML = await topbarResponse.text();
        document.getElementById('topbar').innerHTML = topbarHTML;
      } catch (error) {
        console.error('Error loading components:', error);
      }
    }

    async function initializeAdminDashboard() {
      // Check admin permissions
      if (!Auth.isAuthenticated() || !Auth.isAdmin()) {
        showToast('Admin access required', 'error');
        window.location.href = '/auth/login.html';
        return;
      }
      
      await loadDashboardData();
      await checkMLService();
      
      console.log('üõ†Ô∏è Admin dashboard initialized');
    }

    async function loadDashboardData() {
      try {
        // Load real analytics data from backend
        const analytics = await API.get('/admin/analytics');
        
        if (analytics) {
          updateStatsCards(analytics);
          updatePopularContent(analytics.popular_content || []);
          updatePopularGenres(analytics.popular_genres || []);
        }
        
      } catch (error) {
        console.error('Dashboard data error:', error);
        showFallbackData();
      }
    }

    function updateStatsCards(analytics) {
      document.getElementById('total-users').textContent = analytics.total_users?.toLocaleString() || '0';
      document.getElementById('total-content').textContent = analytics.total_content?.toLocaleString() || '0';
      document.getElementById('active-users').textContent = analytics.active_users_last_week?.toLocaleString() || '0';
      document.getElementById('total-interactions').textContent = analytics.total_interactions?.toLocaleString() || '0';
      
      // Update growth indicators
      document.getElementById('users-growth').textContent = 'Active community';
      document.getElementById('content-growth').textContent = 'Movies, shows & anime';
      document.getElementById('active-growth').textContent = 'Weekly active users';
      document.getElementById('interactions-growth').textContent = 'User engagements';
    }

    function updatePopularContent(popularContent) {
      const container = document.getElementById('popular-content-list');
      
      if (popularContent.length > 0) {
        container.innerHTML = popularContent.slice(0, 5).map((item, index) => `
          <div class="flex items-center justify-between p-3 bg-surface rounded-lg">
            <div>
              <h4 class="font-medium">${item.title}</h4>
              <p class="text-sm text-muted">${item.interactions} interactions</p>
            </div>
            <span class="text-sm font-bold text-primary">#${index + 1}</span>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<p class="text-muted">No interaction data available</p>';
      }
    }

    function updatePopularGenres(popularGenres) {
      const container = document.getElementById('popular-genres-list');
      
      if (popularGenres.length > 0) {
        container.innerHTML = popularGenres.slice(0, 5).map((item, index) => `
          <div class="flex items-center justify-between p-3 bg-surface rounded-lg">
            <div>
              <h4 class="font-medium">${item.genre}</h4>
              <p class="text-sm text-muted">${item.count} interactions</p>
            </div>
            <div class="w-16 bg-gray-600 rounded-full h-2">
              <div class="bg-primary h-2 rounded-full" style="width: ${Math.min(100, (item.count / popularGenres[0].count) * 100)}%"></div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<p class="text-muted">No genre data available</p>';
      }
    }

    async function checkMLService() {
      try {
        const mlStatus = await API.get('/admin/ml-service-check');
        updateMLServiceStatus(mlStatus);
      } catch (error) {
        console.error('ML service check error:', error);
        updateMLServiceStatus({
          status: 'error',
          message: 'Failed to check ML service status'
        });
      }
    }

    function updateMLServiceStatus(status) {
      const indicator = document.getElementById('ml-status-indicator');
      const text = document.getElementById('ml-status-text');
      const metricsContainer = document.getElementById('ml-metrics');
      
      // Update status indicator
      if (status.status === 'healthy') {
        indicator.className = 'w-3 h-3 bg-green-500 rounded-full';
        text.textContent = 'ML Recommendation Service is healthy';
      } else if (status.status === 'partial') {
        indicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
        text.textContent = 'ML Service has some issues';
      } else {
        indicator.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
        text.textContent = status.message || 'ML Service is unavailable';
      }
      
      // Update metrics
      if (status.checks) {
        const metrics = Object.entries(status.checks).map(([key, value]) => {
          const statusIcon = value.status === 'pass' ? '‚úÖ' : '‚ùå';
          const responseTime = value.response_time || 'N/A';
          
          return `
            <div class="bg-surface rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium">${key.replace('_', ' ').toUpperCase()}</span>
                <span>${statusIcon}</span>
              </div>
              <p class="text-sm text-muted">Response: ${responseTime}</p>
            </div>
          `;
        }).join('');
        
        metricsContainer.innerHTML = metrics;
      }
    }

    function showFallbackData() {
      // Show placeholder data when real data isn't available
      document.getElementById('total-users').textContent = '1,247';
      document.getElementById('total-content').textContent = '15,430';
      document.getElementById('active-users').textContent = '892';
      document.getElementById('total-interactions').textContent = '23,456';
      
      document.getElementById('popular-content-list').innerHTML = `
        <p class="text-muted text-center py-4">
          Analytics data will appear here when users start interacting with content
        </p>
      `;
      
      document.getElementById('popular-genres-list').innerHTML = `
        <p class="text-muted text-center py-4">
          Genre statistics will be available after user interactions
        </p>
      `;
    }

    // Navigation functions
    function goToContentManagement() {
      window.location.href = '/admin/content.html';
    }

    function goToAnalytics() {
      window.location.href = '/admin/analytics.html';
    }

    function goToUsers() {
      window.location.href = '/admin/users.html';
    }
  </script>
</body>
</html>