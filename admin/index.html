<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="CineScope Admin Dashboard">
    <title>Admin Dashboard - CineScope</title>
    
    <link rel="preload" href="../js/config.js" as="script">
    <link rel="preload" href="../js/api.js" as="script">
    <link rel="preload" href="../js/auth.js" as="script">
    
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layouts.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/theme.css">
</head>
<body class="admin-body">
    <!-- Admin Top Navigation -->
    <nav class="admin-topbar">
        <div class="admin-topbar-left">
            <a href="/" class="logo">üîß CineScope Admin</a>
        </div>
        <div class="admin-topbar-center">
            <div class="admin-breadcrumb">
                <span class="breadcrumb-item active">Dashboard</span>
            </div>
        </div>
        <div class="admin-topbar-right" id="adminUserSection"></div>
    </nav>

    <!-- Admin Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-section="dashboard">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-section="content">
                <span class="nav-icon">üé¨</span>
                <span class="nav-label">Content Management</span>
            </a>
            <a href="#" class="nav-item" data-section="users">
                <span class="nav-icon">üë•</span>
                <span class="nav-label">User Management</span>
            </a>
            <a href="#" class="nav-item" data-section="analytics">
                <span class="nav-icon">üìà</span>
                <span class="nav-label">Analytics</span>
            </a>
            <a href="#" class="nav-item" data-section="ml-service">
                <span class="nav-icon">ü§ñ</span>
                <span class="nav-label">ML Service</span>
            </a>
            <a href="#" class="nav-item" data-section="recommendations">
                <span class="nav-icon">‚≠ê</span>
                <span class="nav-label">Admin Picks</span>
            </a>
            <div class="nav-divider"></div>
            <a href="/" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Back to Site</span>
            </a>
        </nav>
    </aside>

    <!-- Admin Main Content -->
    <main class="admin-main">
        <div class="admin-content" id="adminContent">
            <div class="loading" id="adminLoading">
                <div class="spinner"></div>
                <p>Loading admin dashboard...</p>
            </div>
        </div>
    </main>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        let analyticsData = null;
        let mlServiceStatus = null;
        let contentStats = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin authentication
            if (!window.auth.isAuthenticated() || !window.auth.isAdmin()) {
                window.location.href = '/';
                return;
            }

            updateAdminUserSection();
            setupAdminNavigation();
            await loadAdminData();
            showAdminSection('dashboard');
        });

        async function loadAdminData() {
            try {
                // Load all admin data in parallel
                const promises = [
                    window.api.getAnalytics(),
                    window.api.checkMLService(),
                    loadContentStats()
                ];

                const [analytics, mlStatus, contentData] = await Promise.allSettled(promises);

                analyticsData = analytics.value || {};
                mlServiceStatus = mlStatus.value || { status: 'unknown' };
                contentStats = contentData.value || {};

                document.getElementById('adminLoading').style.display = 'none';

            } catch (error) {
                console.error('Failed to load admin data:', error);
                showAdminError('Failed to load admin dashboard');
            }
        }

        async function loadContentStats() {
            // Since there's no specific endpoint, we'll derive from analytics
            try {
                const analytics = await window.api.getAnalytics();
                return {
                    totalContent: analytics.total_content || 0,
                    totalUsers: analytics.total_users || 0,
                    totalInteractions: analytics.total_interactions || 0,
                    activeUsers: analytics.active_users_last_week || 0,
                    popularContent: analytics.popular_content || [],
                    popularGenres: analytics.popular_genres || []
                };
            } catch (error) {
                return {};
            }
        }

        function setupAdminNavigation() {
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = e.currentTarget.dataset.section;
                    showAdminSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    
                    // Update breadcrumb
                    const breadcrumb = document.querySelector('.admin-breadcrumb');
                    breadcrumb.innerHTML = `<span class="breadcrumb-item active">${getSectionTitle(section)}</span>`;
                });
            });
        }

        function getSectionTitle(section) {
            const titles = {
                'dashboard': 'Dashboard',
                'content': 'Content Management',
                'users': 'User Management',
                'analytics': 'Analytics',
                'ml-service': 'ML Service',
                'recommendations': 'Admin Picks'
            };
            return titles[section] || 'Dashboard';
        }

        function showAdminSection(section) {
            const content = document.getElementById('adminContent');
            
            switch (section) {
                case 'dashboard':
                    renderDashboard(content);
                    break;
                case 'content':
                    renderContentManagement(content);
                    break;
                case 'users':
                    renderUserManagement(content);
                    break;
                case 'analytics':
                    renderAnalytics(content);
                    break;
                case 'ml-service':
                    renderMLService(content);
                    break;
                case 'recommendations':
                    renderRecommendations(content);
                    break;
                default:
                    renderDashboard(content);
            }
        }

        function renderDashboard(container) {
            container.innerHTML = `
                <div class="admin-dashboard">
                    <div class="dashboard-header">
                        <h1>Admin Dashboard</h1>
                        <p>System overview and quick actions</p>
                    </div>

                    <!-- Quick Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-content">
                                <div class="stat-number">${analyticsData.total_users || 0}</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üé¨</div>
                            <div class="stat-content">
                                <div class="stat-number">${analyticsData.total_content || 0}</div>
                                <div class="stat-label">Total Content</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-number">${analyticsData.total_interactions || 0}</div>
                                <div class="stat-label">Total Interactions</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚ö°</div>
                            <div class="stat-content">
                                <div class="stat-number">${analyticsData.active_users_last_week || 0}</div>
                                <div class="stat-label">Active Users (7d)</div>
                            </div>
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3>System Status</h3>
                            <div class="status-items">
                                <div class="status-item">
                                    <span class="status-indicator status-online"></span>
                                    <span class="status-label">Backend API</span>
                                    <span class="status-value">Online</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-indicator ${getMLStatusClass()}"></span>
                                    <span class="status-label">ML Service</span>
                                    <span class="status-value">${getMLStatusText()}</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-indicator status-online"></span>
                                    <span class="status-label">Database</span>
                                    <span class="status-value">Connected</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h3>Popular Content</h3>
                            <div class="popular-list">
                                ${(analyticsData.popular_content || []).slice(0, 5).map(item => `
                                    <div class="popular-item">
                                        <span class="popular-title">${item.title}</span>
                                        <span class="popular-count">${item.interactions} interactions</span>
                                    </div>
                                `).join('')}
                                ${(analyticsData.popular_content || []).length === 0 ? 
                                    '<p class="empty-state">No data available</p>' : ''}
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h3>Quick Actions</h3>
                            <div class="quick-actions">
                                <button class="action-btn" onclick="showAdminSection('content')">
                                    <span class="action-icon">‚ûï</span>
                                    <span class="action-label">Add Content</span>
                                </button>
                                <button class="action-btn" onclick="showAdminSection('recommendations')">
                                    <span class="action-icon">‚≠ê</span>
                                    <span class="action-label">Create Recommendation</span>
                                </button>
                                <button class="action-btn" onclick="refreshMLService()">
                                    <span class="action-icon">üîÑ</span>
                                    <span class="action-label">Refresh ML Service</span>
                                </button>
                                <button class="action-btn" onclick="showAdminSection('analytics')">
                                    <span class="action-icon">üìä</span>
                                    <span class="action-label">View Analytics</span>
                                </button>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h3>Recent Activity</h3>
                            <div class="activity-feed">
                                <div class="activity-item">
                                    <div class="activity-time">2 hours ago</div>
                                    <div class="activity-text">New user registered: user123</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">4 hours ago</div>
                                    <div class="activity-text">Content added: Latest Movie</div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-time">6 hours ago</div>
                                    <div class="activity-text">ML recommendations updated</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContentManagement(container) {
            container.innerHTML = `
                <div class="admin-content-management">
                    <div class="section-header">
                        <h1>Content Management</h1>
                        <p>Search and add new content from external sources</p>
                    </div>

                    <!-- Content Search -->
                    <div class="content-search-section">
                        <h3>Search External Content</h3>
                        <div class="search-form">
                            <div class="search-input-group">
                                <input type="text" 
                                       id="contentSearchInput" 
                                       class="form-input" 
                                       placeholder="Search for movies, TV shows, or anime..."
                                       onkeydown="handleContentSearchKeydown(event)">
                                <select id="contentSourceSelect" class="form-select">
                                    <option value="tmdb">TMDB (Movies & TV)</option>
                                    <option value="anime">MyAnimeList (Anime)</option>
                                </select>
                                <button class="btn btn-primary" onclick="searchExternalContent()">
                                    Search
                                </button>
                            </div>
                        </div>

                        <div class="search-results" id="contentSearchResults">
                            <!-- Results will be populated here -->
                        </div>
                    </div>

                    <!-- Content Stats -->
                    <div class="content-stats">
                        <h3>Content Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">${contentStats.totalContent || 0}</div>
                                <div class="stat-label">Total Content Items</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${(analyticsData.popular_genres || []).length}</div>
                                <div class="stat-label">Active Genres</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${contentStats.totalInteractions || 0}</div>
                                <div class="stat-label">Total Interactions</div>
                            </div>
                        </div>
                    </div>

                    <!-- Popular Genres -->
                    <div class="genre-stats">
                        <h3>Popular Genres</h3>
                        <div class="genre-list">
                            ${(analyticsData.popular_genres || []).map(genre => `
                                <div class="genre-item">
                                    <span class="genre-name">${genre.genre}</span>
                                    <span class="genre-count">${genre.count} items</span>
                                </div>
                            `).join('')}
                            ${(analyticsData.popular_genres || []).length === 0 ? 
                                '<p class="empty-state">No genre data available</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMLService(container) {
            container.innerHTML = `
                <div class="admin-ml-service">
                    <div class="section-header">
                        <h1>ML Service Management</h1>
                        <p>Monitor and manage the machine learning recommendation service</p>
                    </div>

                    <!-- ML Service Status -->
                    <div class="ml-status-section">
                        <h3>Service Status</h3>
                        <div class="ml-status-card">
                            <div class="status-header">
                                <div class="status-indicator ${getMLStatusClass()}"></div>
                                <div class="status-info">
                                    <div class="status-title">${getMLStatusText()}</div>
                                    <div class="status-subtitle">${getMLStatusDescription()}</div>
                                </div>
                                <button class="btn btn-outline" onclick="refreshMLServiceStatus()">
                                    üîÑ Refresh Status
                                </button>
                            </div>
                            
                            ${mlServiceStatus.status === 'healthy' ? renderMLServiceDetails() : ''}
                        </div>
                    </div>

                    <!-- ML Service Actions -->
                    <div class="ml-actions-section">
                        <h3>Service Actions</h3>
                        <div class="action-grid">
                            <button class="action-card" onclick="updateMLModels()">
                                <div class="action-icon">üîÑ</div>
                                <div class="action-title">Update Models</div>
                                <div class="action-desc">Retrain recommendation models</div>
                            </button>
                            <button class="action-card" onclick="testMLRecommendations()">
                                <div class="action-icon">üß™</div>
                                <div class="action-title">Test Recommendations</div>
                                <div class="action-desc">Run recommendation test</div>
                            </div>
                            <button class="action-card" onclick="viewMLLogs()">
                                <div class="action-icon">üìã</div>
                                <div class="action-title">View Logs</div>
                                <div class="action-desc">Check service logs</div>
                            </button>
                            <button class="action-card" onclick="downloadMLStats()">
                                <div class="action-icon">üìä</div>
                                <div class="action-title">Download Stats</div>
                                <div class="action-desc">Export ML statistics</div>
                            </button>
                        </div>
                    </div>

                    <!-- ML Performance Metrics -->
                    ${mlServiceStatus.checks ? renderMLMetrics() : ''}
                </div>
            `;
        }

        function renderMLServiceDetails() {
            const checks = mlServiceStatus.checks || {};
            
            return `
                <div class="ml-service-details">
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Response Time:</span>
                            <span class="detail-value">${checks.connectivity?.response_time || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Models Initialized:</span>
                            <span class="detail-value">${checks.connectivity?.models_initialized ? '‚úÖ' : '‚ùå'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Recommendations Working:</span>
                            <span class="detail-value">${checks.recommendations?.status === 'pass' ? '‚úÖ' : '‚ùå'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Database Integration:</span>
                            <span class="detail-value">${checks.database_integration?.status === 'pass' ? '‚úÖ' : '‚ùå'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMLMetrics() {
            const checks = mlServiceStatus.checks || {};
            
            return `
                <div class="ml-metrics-section">
                    <h3>Performance Metrics</h3>
                    <div class="metrics-grid">
                        ${Object.entries(checks.performance || {}).map(([endpoint, data]) => `
                            <div class="metric-card">
                                <div class="metric-header">
                                    <span class="metric-name">${endpoint}</span>
                                    <span class="metric-status ${data.status === 'pass' ? 'status-pass' : 'status-fail'}">
                                        ${data.status === 'pass' ? '‚úÖ' : '‚ùå'}
                                    </span>
                                </div>
                                <div class="metric-value">${data.response_time || 'N/A'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderRecommendations(container) {
            container.innerHTML = `
                <div class="admin-recommendations">
                    <div class="section-header">
                        <h1>Admin Recommendations</h1>
                        <p>Create and manage staff picks and featured content</p>
                    </div>

                    <!-- Create Recommendation -->
                    <div class="create-recommendation-section">
                        <h3>Create New Recommendation</h3>
                        <div class="recommendation-form">
                            <div class="form-group">
                                <label class="form-label">Search for Content</label>
                                <input type="text" 
                                       id="recommendationSearchInput" 
                                       class="form-input" 
                                       placeholder="Search for content to recommend..."
                                       onkeydown="handleRecommendationSearchKeydown(event)">
                                <button class="btn btn-outline" onclick="searchContentForRecommendation()">
                                    Search
                                </button>
                            </div>
                            
                            <div class="search-results" id="recommendationSearchResults">
                                <!-- Search results will appear here -->
                            </div>

                            <div class="recommendation-details" id="recommendationDetails" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Recommendation Type</label>
                                    <select id="recommendationType" class="form-select">
                                        <option value="admin_choice">Admin's Choice</option>
                                        <option value="staff_pick">Staff Pick</option>
                                        <option value="featured">Featured</option>
                                        <option value="hidden_gem">Hidden Gem</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea id="recommendationDescription" 
                                              class="form-textarea" 
                                              placeholder="Write why you recommend this content..."
                                              rows="4"></textarea>
                                </div>

                                <div class="form-actions">
                                    <button class="btn btn-primary" onclick="createRecommendation()">
                                        Create Recommendation
                                    </button>
                                    <button class="btn btn-outline" onclick="cancelRecommendation()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Recommendations -->
                    <div class="existing-recommendations-section">
                        <h3>Current Recommendations</h3>
                        <div class="recommendations-list" id="recommendationsList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading recommendations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            loadExistingRecommendations();
        }

        // ML Service Functions
        function getMLStatusClass() {
            switch (mlServiceStatus.status) {
                case 'healthy': return 'status-online';
                case 'partial': return 'status-warning';
                case 'unhealthy': return 'status-offline';
                default: return 'status-unknown';
            }
        }

        function getMLStatusText() {
            switch (mlServiceStatus.status) {
                case 'healthy': return 'Online';
                case 'partial': return 'Partial';
                case 'unhealthy': return 'Offline';
                default: return 'Unknown';
            }
        }

        function getMLStatusDescription() {
            switch (mlServiceStatus.status) {
                case 'healthy': return 'All systems operational';
                case 'partial': return 'Some features unavailable';
                case 'unhealthy': return 'Service unavailable';
                default: return 'Status unknown';
            }
        }

        async function refreshMLServiceStatus() {
            try {
                showToast('Checking ML service status...', 'info');
                mlServiceStatus = await window.api.checkMLService();
                showAdminSection('ml-service');
                showToast('ML service status updated', 'success');
            } catch (error) {
                console.error('Failed to refresh ML service status:', error);
                showToast('Failed to refresh ML service status', 'error');
            }
        }

        async function updateMLModels() {
            try {
                showToast('Updating ML models...', 'info');
                const result = await window.api.updateMLService();
                
                if (result.success) {
                    showToast('ML models update initiated successfully', 'success');
                } else {
                    showToast('Failed to update ML models: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Failed to update ML models:', error);
                showToast('Failed to update ML models', 'error');
            }
        }

        function testMLRecommendations() {
            showToast('ML recommendation testing would be implemented', 'info');
        }

        function viewMLLogs() {
            showToast('ML service logs viewer would be implemented', 'info');
        }

        function downloadMLStats() {
            if (mlServiceStatus) {
                const blob = new Blob([JSON.stringify(mlServiceStatus, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ml-service-stats-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('ML statistics downloaded', 'success');
            }
        }

        // Content Management Functions
        async function searchExternalContent() {
            const query = document.getElementById('contentSearchInput').value.trim();
            const source = document.getElementById('contentSourceSelect').value;
            const resultsContainer = document.getElementById('contentSearchResults');

            if (!query) {
                showToast('Please enter a search query', 'warning');
                return;
            }

            try {
                resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';
                
                const results = await window.api.adminSearch(query, source);
                
                if (results.results && results.results.length > 0) {
                    resultsContainer.innerHTML = `
                        <h4>Search Results (${results.results.length})</h4>
                        <div class="content-results-grid">
                            ${results.results.map(item => renderContentSearchResult(item)).join('')}
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '<p class="empty-state">No results found. Try different search terms.</p>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<p class="error-state">Search failed. Please try again.</p>';
            }
        }

        function renderContentSearchResult(item) {
            return `
                <div class="content-result-card">
                    <div class="result-poster">
                        <img src="${item.poster_path}" alt="${item.title}" loading="lazy">
                    </div>
                    <div class="result-info">
                        <h4 class="result-title">${item.title}</h4>
                        <div class="result-meta">
                            <span class="result-type">${item.content_type.toUpperCase()}</span>
                            <span class="result-rating">‚òÖ ${item.rating || 'N/A'}</span>
                            ${item.release_date ? `<span class="result-year">${item.release_date.split('-')[0]}</span>` : ''}
                        </div>
                        <p class="result-overview">${(item.overview || '').substring(0, 100)}${item.overview && item.overview.length > 100 ? '...' : ''}</p>
                        <div class="result-actions">
                            <button class="btn btn-primary btn-sm" onclick="addContentToDatabase(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                Add to Database
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function addContentToDatabase(contentData) {
            try {
                showToast('Adding content to database...', 'info');
                
                const result = await window.api.saveExternalContent(contentData);
                
                if (result.content_id) {
                    showToast('Content added successfully!', 'success');
                    
                    // Refresh content stats
                    contentStats = await loadContentStats();
                } else {
                    showToast('Content was already in database', 'info');
                }
            } catch (error) {
                console.error('Failed to add content:', error);
                showToast('Failed to add content to database', 'error');
            }
        }

        function handleContentSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchExternalContent();
            }
        }

        // Recommendation Management Functions
        let selectedContentForRecommendation = null;

        async function searchContentForRecommendation() {
            const query = document.getElementById('recommendationSearchInput').value.trim();
            const resultsContainer = document.getElementById('recommendationSearchResults');

            if (!query) {
                showToast('Please enter a search query', 'warning');
                return;
            }

            try {
                resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';
                
                // Search in our database first
                const results = await window.api.search(query);
                
                if (results.results && results.results.length > 0) {
                    resultsContainer.innerHTML = `
                        <h4>Select Content to Recommend</h4>
                        <div class="recommendation-search-grid">
                            ${results.results.map(item => renderRecommendationSearchResult(item)).join('')}
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '<p class="empty-state">No content found in database. Add content first.</p>';
                }
            } catch (error) {
                console.error('Recommendation search error:', error);
                resultsContainer.innerHTML = '<p class="error-state">Search failed. Please try again.</p>';
            }
        }

        function renderRecommendationSearchResult(item) {
            return `
                <div class="recommendation-search-result" onclick="selectContentForRecommendation(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <img src="${item.poster_path}" alt="${item.title}" class="result-poster">
                    <div class="result-info">
                        <h5 class="result-title">${item.title}</h5>
                        <div class="result-meta">
                            <span class="result-type">${item.content_type}</span>
                            <span class="result-rating">‚òÖ ${item.rating || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function selectContentForRecommendation(contentData) {
            selectedContentForRecommendation = contentData;
            
            document.getElementById('recommendationSearchResults').innerHTML = `
                <div class="selected-content">
                    <h4>Selected Content</h4>
                    <div class="selected-content-card">
                        <img src="${contentData.poster_path}" alt="${contentData.title}" class="selected-poster">
                        <div class="selected-info">
                            <h5>${contentData.title}</h5>
                            <p class="selected-meta">${contentData.content_type} ‚Ä¢ ‚òÖ ${contentData.rating || 'N/A'}</p>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="clearSelectedContent()">Change</button>
                    </div>
                </div>
            `;
            
            document.getElementById('recommendationDetails').style.display = 'block';
        }

        function clearSelectedContent() {
            selectedContentForRecommendation = null;
            document.getElementById('recommendationSearchResults').innerHTML = '';
            document.getElementById('recommendationDetails').style.display = 'none';
        }

        async function createRecommendation() {
            if (!selectedContentForRecommendation) {
                showToast('Please select content first', 'warning');
                return;
            }

            const type = document.getElementById('recommendationType').value;
            const description = document.getElementById('recommendationDescription').value.trim();

            if (!description) {
                showToast('Please enter a description', 'warning');
                return;
            }

            try {
                showToast('Creating recommendation...', 'info');
                
                const recommendationData = {
                    content_id: selectedContentForRecommendation.id,
                    recommendation_type: type,
                    description: description
                };

                const result = await window.api.createAdminRecommendation(recommendationData);
                
                showToast('Recommendation created successfully!', 'success');
                
                if (result.telegram_sent) {
                    showToast('Recommendation posted to Telegram channel', 'success');
                }
                
                // Reset form
                cancelRecommendation();
                
                // Reload recommendations list
                loadExistingRecommendations();
                
            } catch (error) {
                console.error('Failed to create recommendation:', error);
                showToast('Failed to create recommendation', 'error');
            }
        }

        function cancelRecommendation() {
            selectedContentForRecommendation = null;
            document.getElementById('recommendationSearchInput').value = '';
            document.getElementById('recommendationDescription').value = '';
            document.getElementById('recommendationSearchResults').innerHTML = '';
            document.getElementById('recommendationDetails').style.display = 'none';
        }

        async function loadExistingRecommendations() {
            try {
                const recommendations = await window.api.request('/admin/recommendations');
                const container = document.getElementById('recommendationsList');
                
                if (recommendations.recommendations && recommendations.recommendations.length > 0) {
                    container.innerHTML = recommendations.recommendations.map(renderExistingRecommendation).join('');
                } else {
                    container.innerHTML = '<p class="empty-state">No recommendations created yet.</p>';
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
                document.getElementById('recommendationsList').innerHTML = '<p class="error-state">Failed to load recommendations.</p>';
            }
        }

        function renderExistingRecommendation(rec) {
            return `
                <div class="existing-recommendation">
                    <div class="rec-content">
                        <img src="${rec.content.poster_path}" alt="${rec.content.title}" class="rec-poster">
                        <div class="rec-info">
                            <h4 class="rec-title">${rec.content.title}</h4>
                            <div class="rec-meta">
                                <span class="rec-type">${rec.recommendation_type.replace('_', ' ')}</span>
                                <span class="rec-admin">by ${rec.admin_name}</span>
                                <span class="rec-date">${new Date(rec.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="rec-description">${rec.description}</p>
                        </div>
                    </div>
                    <div class="rec-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteRecommendation(${rec.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }

        function deleteRecommendation(recId) {
            if (confirm('Are you sure you want to delete this recommendation?')) {
                showToast('Delete functionality would be implemented with backend API', 'info');
            }
        }

        function handleRecommendationSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchContentForRecommendation();
            }
        }

        // Additional Admin Functions
        function renderUserManagement(container) {
            container.innerHTML = `
                <div class="admin-users">
                    <div class="section-header">
                        <h1>User Management</h1>
                        <p>Manage user accounts and permissions</p>
                    </div>
                    
                    <div class="user-stats">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${analyticsData.total_users || 0}</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${analyticsData.active_users_last_week || 0}</div>
                                <div class="stat-label">Active This Week</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-management-note">
                        <p>Advanced user management features would be implemented with dedicated backend APIs for:</p>
                        <ul>
                            <li>User search and filtering</li>
                            <li>Account status management</li>
                            <li>Permission and role management</li>
                            <li>User activity monitoring</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderAnalytics(container) {
            container.innerHTML = `
                <div class="admin-analytics">
                    <div class="section-header">
                        <h1>Analytics Dashboard</h1>
                        <p>Detailed insights and usage statistics</p>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>Content Performance</h3>
                            <div class="performance-list">
                                ${(analyticsData.popular_content || []).map(item => `
                                    <div class="performance-item">
                                        <span class="performance-title">${item.title}</span>
                                        <span class="performance-value">${item.interactions} interactions</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>Genre Popularity</h3>
                            <div class="genre-chart">
                                ${(analyticsData.popular_genres || []).map(genre => `
                                    <div class="chart-item">
                                        <div class="chart-label">${genre.genre}</div>
                                        <div class="chart-bar">
                                            <div class="chart-fill" style="width: ${(genre.count / Math.max(...(analyticsData.popular_genres || []).map(g => g.count), 1)) * 100}%"></div>
                                        </div>
                                        <div class="chart-value">${genre.count}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function refreshMLService() {
            await refreshMLServiceStatus();
        }

        // Utility Functions
        function updateAdminUserSection() {
            const userSection = document.getElementById('adminUserSection');
            
            if (window.auth.isAuthenticated()) {
                const user = window.auth.getUser();
                userSection.innerHTML = `
                    <div class="admin-user-info">
                        <img src="${window.auth.getUserAvatar()}" alt="${user.username}" class="admin-avatar">
                        <span class="admin-username">${user.username}</span>
                        <button class="btn btn-outline btn-sm" onclick="window.auth.logout()">Logout</button>
                    </div>
                `;
            }
        }

        function showAdminError(message) {
            document.getElementById('adminContent').innerHTML = `
                <div class="admin-error">
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-show'), 100);
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>