<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Admin Dashboard - CineBrain</title>

    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.googletagmanager.com;
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob: https: http:;
        connect-src 'self' https://cinebrain.onrender.com wss://cinebrain.onrender.com;
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        object-src 'none';
    ">

    <!-- SEO & Meta -->
    <meta name="description" content="CineBrain Real-time Admin Dashboard - Live platform management">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://cinebrain.vercel.app/admin/">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-icon-180x180.png">

    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cinebrain.onrender.com" crossorigin>

    <!-- Core CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Bangers&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Component CSS -->
    <link rel="stylesheet" href="/assets/css/components/theme.css">
    <link rel="stylesheet" href="/assets/css/components/topbar.css">
    <link rel="stylesheet" href="/assets/css/components/mobile-nav.css">
    <link rel="stylesheet" href="/assets/css/admin/dashboard.css">

    <!-- Theme Initialization -->
    <script>
        (function () {
            try {
                const savedTheme = localStorage.getItem('cinebrain-theme');
                const theme = (savedTheme === 'light' || savedTheme === 'dark') ? savedTheme : 'dark';
                document.documentElement.setAttribute('data-theme', theme);
                document.documentElement.setAttribute('data-bs-theme', theme);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            }
        })();
    </script>
</head>

<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="visually-hidden-focusable">Skip to main content</a>

    <!-- Loading Indicator -->
    <div id="page-loading-indicator"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--admin-primary); z-index: 9999; transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease;">
    </div>

    <!-- Header Navigation -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-cinebrain fixed-top" role="navigation" aria-label="Admin navigation">
            <div class="container-fluid">
                <div class="navbar-brand-wrapper">
                    <a href="/admin/" style="text-decoration: none;" aria-label="CineBrain Admin Home">
                        <div class="navbar-brand-cinebrain">CineBrain</div>
                        <div class="tagline">
                            <span class="tagline-full">Admin Dashboard</span>
                            <span class="tagline-medium" style="display: none;">Admin Panel</span>
                            <span class="tagline-short" style="display: none;">Admin</span>
                        </div>
                    </a>
                </div>

                <div class="search-container desktop-search" id="desktopSearchContainer">
                    <div class="search-wrapper">
                        <div class="search-bar-wrapper">
                            <div class="search-input-wrapper">
                                <i data-feather="search" class="search-icon" aria-hidden="true"></i>
                                <input type="text" class="form-control search-input" id="desktopSearchInput"
                                    placeholder="Search content, users, tickets..." autocomplete="off"
                                    aria-label="Search admin content" maxlength="100" role="combobox"
                                    aria-expanded="false" aria-haspopup="listbox">
                                <button class="search-clear" id="searchClear" aria-label="Clear search"
                                    style="display: none;">
                                    <i data-feather="x" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="search-results" id="desktopSearchResults" role="listbox" aria-live="polite">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-icons-section">
                    <button class="icon-button mobile-search-trigger" id="mobileSearchTrigger" aria-label="Open search">
                        <i data-feather="search" aria-hidden="true"></i>
                    </button>

                    <button class="icon-button theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <i data-feather="sun" class="theme-icon theme-icon-light" aria-hidden="true"></i>
                        <i data-feather="moon" class="theme-icon theme-icon-dark" aria-hidden="true"></i>
                    </button>

                    <div class="dropdown">
                        <button class="avatar-menu" data-bs-toggle="dropdown" aria-expanded="false" id="avatarMenu">
                            <i data-feather="shield" aria-hidden="true"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-cinebrain" id="adminDropdown">
                            <!-- Will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Mobile Search Overlay -->
    <div class="mobile-search-overlay" id="mobileSearchOverlay" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="container">
            <div class="mobile-search-header">
                <button class="btn-back" id="closeMobileSearch" aria-label="Close search">
                    <i data-feather="arrow-left" aria-hidden="true"></i>
                </button>
                <div class="mobile-search-input-wrapper">
                    <i data-feather="search" class="search-icon" aria-hidden="true"></i>
                    <input type="text" class="form-control search-input" id="mobileSearchInput"
                        placeholder="Search admin..." autocomplete="off" autofocus>
                </div>
            </div>
            <div class="search-results mobile-results" id="mobileSearchResults" role="listbox" aria-live="polite">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" role="main">
        <div class="admin-container">
            <!-- Admin Header with Real-time Status -->
            <section class="admin-header">
                <div class="realtime-status">
                    <div class="realtime-indicator" id="realtimeIndicator"></div>
                    <span id="realtimeStatus">Live</span>
                </div>
                <div class="admin-header-content">
                    <h1 class="admin-title">
                        <i data-feather="shield" style="color: white;"></i>
                        CineBrain Admin
                    </h1>
                    <p class="admin-subtitle">
                        Real-time platform management and analytics
                    </p>
                </div>
            </section>

            <!-- System Alerts -->
            <div id="systemAlerts" role="alert" aria-live="assertive"></div>

            <!-- Quick Actions -->
            <section class="quick-actions" aria-label="Quick Actions">
                <a href="/admin/content.html" class="action-btn">
                    <i data-feather="film"></i>
                    <span>Content</span>
                </a>
                <a href="/admin/users.html" class="action-btn">
                    <i data-feather="users"></i>
                    <span>Users</span>
                </a>
                <a href="/admin/Support Dashboard.html" class="action-btn">
                    <i data-feather="message-circle"></i>
                    <span>Support</span>
                </a>
                <a href="/admin/analytics.html" class="action-btn">
                    <i data-feather="bar-chart-2"></i>
                    <span>Analytics</span>
                </a>
                <a href="/admin/recommendations.html" class="action-btn">
                    <i data-feather="star"></i>
                    <span>Recommendations</span>
                </a>
                <a href="/admin/settings.html" class="action-btn">
                    <i data-feather="settings"></i>
                    <span>Settings</span>
                </a>
            </section>

            <!-- Real-time Dashboard Grid -->
            <section class="admin-grid" aria-label="Live Dashboard Metrics" role="region">
                <!-- Total Users -->
                <article class="admin-card" data-metric="users">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="users" class="card-icon"></i>
                            <span>Total Users</span>
                        </h2>
                        <button class="icon-button" onclick="adminDashboard.refreshMetric('users')"
                            aria-label="Refresh users metric">
                            <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                        </button>
                    </header>
                    <div id="totalUsersMetric">
                        <div class="loading-skeleton skeleton-metric"></div>
                        <div class="loading-skeleton skeleton-text"></div>
                    </div>
                    <div class="mini-chart" id="usersChart"></div>
                </article>

                <!-- Content Items -->
                <article class="admin-card" data-metric="content">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="film" class="card-icon"></i>
                            <span>Content</span>
                        </h2>
                        <button class="icon-button" onclick="adminDashboard.refreshMetric('content')"
                            aria-label="Refresh content metric">
                            <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                        </button>
                    </header>
                    <div id="contentMetric">
                        <div class="loading-skeleton skeleton-metric"></div>
                        <div class="loading-skeleton skeleton-text"></div>
                    </div>
                    <div class="mini-chart" id="contentChart"></div>
                </article>

                <!-- Active Users -->
                <article class="admin-card" data-metric="active">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="activity" class="card-icon"></i>
                            <span>Active Now</span>
                        </h2>
                        <button class="icon-button" onclick="adminDashboard.refreshMetric('active')"
                            aria-label="Refresh active users metric">
                            <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                        </button>
                    </header>
                    <div id="activeUsersMetric">
                        <div class="loading-skeleton skeleton-metric"></div>
                        <div class="loading-skeleton skeleton-text"></div>
                    </div>
                    <div class="mini-chart" id="activeChart"></div>
                </article>

                <!-- Support Tickets -->
                <article class="admin-card" data-metric="support">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="message-circle" class="card-icon"></i>
                            <span>Support</span>
                        </h2>
                        <button class="icon-button" onclick="adminDashboard.refreshMetric('support')"
                            aria-label="Refresh support metric">
                            <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                        </button>
                    </header>
                    <div id="supportMetric">
                        <div class="loading-skeleton skeleton-metric"></div>
                        <div class="loading-skeleton skeleton-text"></div>
                    </div>
                    <div class="mini-chart" id="supportChart"></div>
                </article>

                <!-- System Health -->
                <article class="admin-card span-2">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="monitor" class="card-icon"></i>
                            <span>System Health</span>
                        </h2>
                        <div class="d-flex gap-2">
                            <button class="icon-button" onclick="adminDashboard.refreshSystemHealth()"
                                aria-label="Refresh system health">
                                <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                            </button>
                            <button class="icon-button" onclick="adminDashboard.runSystemCheck()"
                                aria-label="Run system check">
                                <i data-feather="play" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    </header>
                    <div id="systemHealth">
                        <div class="loading-skeleton skeleton-text"></div>
                        <div class="loading-skeleton skeleton-text"></div>
                        <div class="loading-skeleton skeleton-text"></div>
                    </div>
                </article>

                <!-- Recent Activity -->
                <article class="admin-card span-2">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="clock" class="card-icon"></i>
                            <span>Live Activity</span>
                        </h2>
                        <button class="icon-button" onclick="adminDashboard.refreshActivity()"
                            aria-label="Refresh activity">
                            <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                        </button>
                    </header>
                    <div class="table-responsive-mobile">
                        <div id="recentActivity">
                            <div class="loading-skeleton skeleton-text"></div>
                            <div class="loading-skeleton skeleton-text"></div>
                            <div class="loading-skeleton skeleton-text"></div>
                        </div>
                    </div>
                </article>

                <!-- Real-time Analytics Chart -->
                <article class="admin-card span-4">
                    <header class="card-header">
                        <h2 class="card-title">
                            <i data-feather="trending-up" class="card-icon"></i>
                            <span>Live Analytics</span>
                        </h2>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-outline-secondary"
                                onclick="adminDashboard.switchChart('users')">Users</button>
                            <button class="btn btn-sm btn-outline-secondary"
                                onclick="adminDashboard.switchChart('content')">Content</button>
                            <button class="btn btn-sm btn-outline-secondary active"
                                onclick="adminDashboard.switchChart('engagement')">Engagement</button>
                            <button class="btn btn-sm btn-outline-secondary"
                                onclick="adminDashboard.switchChart('performance')">Performance</button>
                        </div>
                    </header>
                    <div class="chart-container" id="analyticsChart">
                        <div class="loading-skeleton skeleton-text" style="width: 80%; height: 100px;"></div>
                    </div>
                </article>
            </section>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav" aria-label="Mobile admin navigation">
        <div class="mobile-nav-container" id="mobileNavContainer">
        </div>
    </nav>

    <!-- Mobile Menu -->
    <aside class="mobile-menu-overlay" id="mobileMenuOverlay" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="menu-handle"></div>
        <div class="menu-header">
            <h3 class="menu-title">Admin Menu</h3>
            <button class="menu-close-btn" id="mobileMenuClose" aria-label="Close menu">
                <i data-feather="x" aria-hidden="true"></i>
            </button>
        </div>

        <section class="menu-section">
            <div class="mobile-menu-grid" id="mobileMenuGrid"></div>
        </section>

        <section class="menu-section">
            <h4 class="menu-section-title" id="userSectionTitle">Admin Tools</h4>
            <div class="mobile-menu-list" id="mobileMenuList"></div>
        </section>
    </aside>

    <!-- Mobile Backdrop -->
    <div class="mobile-backdrop" id="mobileBackdrop" aria-hidden="true"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- Core Scripts -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/components/theme-manager.js"></script>
    <script src="/assets/js/components/topbar.js"></script>
    <script src="/assets/js/components/mobile-nav.js"></script>

    <!-- Real-time Admin Dashboard Script -->
    <script>
        class RealTimeAdminDashboard {
            constructor() {
                this.apiBase = window.CineBrainConfig.apiBase;
                this.refreshIntervals = new Map();
                this.currentChart = 'engagement';
                this.data = {};
                this.isConnected = false;
                this.retryCount = 0;
                this.maxRetries = 5;
                this.websocket = null;

                // Real-time update frequencies (in milliseconds)
                this.updateFrequencies = {
                    fast: 5000,    // 5 seconds - for critical metrics
                    medium: 15000, // 15 seconds - for important data  
                    slow: 30000,   // 30 seconds - for general stats
                    health: 10000  // 10 seconds - for system health
                };

                this.init();
            }

            async init() {
                await this.setupAuthentication();
                this.initWebSocket();
                this.loadInitialData();
                this.setupRealTimeUpdates();
                this.setupEventListeners();
                this.setupVisibilityHandling();

                // Initialize icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }

                console.log('游 Real-time Admin Dashboard initialized');
            }

            async setupAuthentication() {
                const token = localStorage.getItem('cinebrain-token');
                const user = JSON.parse(localStorage.getItem('cinebrain-user') || '{}');

                if (!token || !user.is_admin) {
                    window.location.href = '/auth/login.html?redirect=admin';
                    return;
                }

                this.token = token;
                this.currentUser = user;
                this.updateAdminDropdown();
            }

            initWebSocket() {
                try {
                    // Convert HTTP URL to WebSocket URL
                    const wsUrl = this.apiBase.replace(/^https?:\/\//, 'wss://').replace('/api', '/ws/admin');

                    this.websocket = new WebSocket(`${wsUrl}?token=${this.token}`);

                    this.websocket.onopen = () => {
                        console.log('游니 WebSocket connected for real-time updates');
                        this.isConnected = true;
                        this.retryCount = 0;
                        this.updateConnectionStatus(true);
                    };

                    this.websocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleRealTimeUpdate(data);
                        } catch (error) {
                            console.error('WebSocket message parsing error:', error);
                        }
                    };

                    this.websocket.onclose = () => {
                        console.log('游니 WebSocket disconnected');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        this.handleReconnection();
                    };

                    this.websocket.onerror = (error) => {
                        console.error('游니 WebSocket error:', error);
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };

                } catch (error) {
                    console.warn('WebSocket not available, falling back to polling:', error);
                    this.fallbackToPolling();
                }
            }

            handleRealTimeUpdate(data) {
                switch (data.type) {
                    case 'metric_update':
                        this.updateMetricDisplay(data.metric, data.value, data.change);
                        break;
                    case 'system_alert':
                        this.showRealTimeAlert(data.alert);
                        break;
                    case 'user_activity':
                        this.updateActivityFeed(data.activity);
                        break;
                    case 'system_health':
                        this.updateSystemHealthRealTime(data.health);
                        break;
                    default:
                        console.log('Unknown real-time update:', data);
                }
            }

            handleReconnection() {
                if (this.retryCount < this.maxRetries) {
                    this.retryCount++;
                    const delay = Math.min(1000 * Math.pow(2, this.retryCount), 30000);

                    console.log(`游댃 Attempting WebSocket reconnection in ${delay}ms (attempt ${this.retryCount})`);

                    setTimeout(() => {
                        this.initWebSocket();
                    }, delay);
                } else {
                    console.warn('游니 Max WebSocket reconnection attempts reached, switching to polling');
                    this.fallbackToPolling();
                }
            }

            fallbackToPolling() {
                console.log('游댃 Using polling for real-time updates');
                this.isConnected = false;
                this.updateConnectionStatus(false);

                // Set up aggressive polling for real-time feel
                this.setupPollingUpdates();
            }

            setupPollingUpdates() {
                // Clear any existing intervals
                this.refreshIntervals.forEach(interval => clearInterval(interval));
                this.refreshIntervals.clear();

                // Fast polling for critical metrics
                this.refreshIntervals.set('metrics', setInterval(() => {
                    this.refreshAllMetrics();
                }, this.updateFrequencies.fast));

                // Medium polling for system health
                this.refreshIntervals.set('health', setInterval(() => {
                    this.refreshSystemHealth();
                }, this.updateFrequencies.health));

                // Slower polling for activity feed
                this.refreshIntervals.set('activity', setInterval(() => {
                    this.refreshActivity();
                }, this.updateFrequencies.medium));
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('realtimeIndicator');
                const status = document.getElementById('realtimeStatus');

                if (indicator && status) {
                    if (connected) {
                        indicator.classList.remove('disconnected');
                        status.textContent = 'Live';
                    } else {
                        indicator.classList.add('disconnected');
                        status.textContent = 'Polling';
                    }
                }
            }

            setupRealTimeUpdates() {
                if (!this.isConnected) {
                    this.setupPollingUpdates();
                }

                // Always have some polling as backup
                this.refreshIntervals.set('backup', setInterval(() => {
                    if (!this.isConnected) {
                        this.refreshAllMetrics();
                    }
                }, this.updateFrequencies.medium));
            }

            async loadInitialData() {
                try {
                    this.showPageLoading(true);

                    // Load all dashboard data concurrently
                    const [overviewData, healthData, analyticsData] = await Promise.allSettled([
                        this.fetchWithAuth('/admin/dashboard'),
                        this.fetchWithAuth('/admin/system-health'),
                        this.fetchWithAuth('/admin/analytics')
                    ]);

                    if (overviewData.status === 'fulfilled') {
                        this.data.overview = overviewData.value;
                        this.updateOverviewMetrics();
                    }

                    if (healthData.status === 'fulfilled') {
                        this.data.health = healthData.value;
                        this.updateSystemHealth();
                    }

                    if (analyticsData.status === 'fulfilled') {
                        this.data.analytics = analyticsData.value;
                        this.updateAnalytics();
                        this.updateRecentActivity();
                    }

                } catch (error) {
                    console.error('Error loading initial dashboard data:', error);
                    this.showSystemAlert('Failed to load dashboard data. Retrying...', 'danger');

                    // Retry after delay
                    setTimeout(() => {
                        this.loadInitialData();
                    }, 5000);
                } finally {
                    this.showPageLoading(false);
                }
            }

            async fetchWithAuth(endpoint, options = {}) {
                const response = await fetch(`${this.apiBase}${endpoint}`, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        this.handleAuthFailure();
                        throw new Error('Authentication failed');
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response.json();
            }

            handleAuthFailure() {
                console.error('Authentication failed, redirecting to login');
                localStorage.removeItem('cinebrain-token');
                localStorage.removeItem('cinebrain-user');
                window.location.href = '/auth/login.html?redirect=admin';
            }

            updateAdminDropdown() {
                const dropdown = document.getElementById('adminDropdown');
                if (!dropdown) return;

                dropdown.innerHTML = `
                    <li><h6 class="dropdown-header">Admin: ${this.currentUser.username}</h6></li>
                    <li><span class="dropdown-item-text"><span class="badge bg-danger">Administrator</span></span></li>
                    <li><hr class="dropdown-divider"></li>
                    
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/admin/">
                        <i data-feather="shield"></i> Dashboard
                    </a></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/admin/content.html">
                        <i data-feather="film"></i> Content Manager
                    </a></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/admin/Support Dashboard.html">
                        <i data-feather="message-circle"></i> Support Center
                    </a></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/admin/users.html">
                        <i data-feather="users"></i> User Management
                    </a></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/admin/analytics.html">
                        <i data-feather="bar-chart-2"></i> Analytics
                    </a></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/admin/recommendations.html">
                        <i data-feather="star"></i> Recommendations
                    </a></li>
                    
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/index.html">
                        <i data-feather="home"></i> User View
                    </a></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain" href="/user/profile.html">
                        <i data-feather="user"></i> My Profile
                    </a></li>
                    
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item dropdown-item-cinebrain text-danger" href="#" onclick="adminDashboard.logout()">
                        <i data-feather="log-out"></i> Sign Out
                    </a></li>
                `;

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }

            async refreshAllMetrics() {
                try {
                    const overview = await this.fetchWithAuth('/admin/dashboard');
                    this.data.overview = overview;
                    this.updateOverviewMetrics();
                } catch (error) {
                    console.error('Error refreshing metrics:', error);
                }
            }

            async refreshMetric(metricType) {
                try {
                    const button = document.querySelector(`[data-metric="${metricType}"] .icon-button`);
                    if (button) {
                        button.style.animation = 'spin 1s linear infinite';
                    }

                    await this.refreshAllMetrics();

                    if (button) {
                        button.style.animation = '';
                    }
                } catch (error) {
                    console.error(`Error refreshing ${metricType} metric:`, error);
                }
            }

            updateOverviewMetrics() {
                const overview = this.data.overview;
                if (!overview) return;

                // Update all metrics with animation
                this.animateMetricUpdate('totalUsersMetric', () => {
                    if (overview.general_stats) {
                        const stats = overview.general_stats;
                        return `
                            <p class="metric-value">${stats.total_users?.toLocaleString() || '0'}</p>
                            <p class="metric-label">Total Registered Users</p>
                            <span class="metric-change change-positive">
                                <i data-feather="trending-up" style="width: 12px; height: 12px;"></i>
                                +${stats.new_users_month || 0} this month
                            </span>
                        `;
                    }
                });

                this.animateMetricUpdate('contentMetric', () => {
                    if (overview.general_stats) {
                        const stats = overview.general_stats;
                        return `
                            <p class="metric-value">${stats.total_content?.toLocaleString() || '0'}</p>
                            <p class="metric-label">Content Items</p>
                            <div class="mt-2">
                                ${stats.content_distribution?.slice(0, 3).map(item =>
                            `<small class="d-block text-muted">${item.type}: ${item.count}</small>`
                        ).join('') || ''}
                            </div>
                        `;
                    }
                });

                this.animateMetricUpdate('activeUsersMetric', () => {
                    if (overview.general_stats) {
                        const stats = overview.general_stats;
                        return `
                            <p class="metric-value">${stats.active_users_week?.toLocaleString() || '0'}</p>
                            <p class="metric-label">Active This Week</p>
                            <span class="metric-change change-positive">
                                <i data-feather="activity" style="width: 12px; height: 12px;"></i>
                                Weekly active users
                            </span>
                        `;
                    }
                });

                this.animateMetricUpdate('supportMetric', () => {
                    if (overview.support_overview) {
                        const support = overview.support_overview;
                        const urgentClass = support.urgent_tickets > 0 ? 'change-negative' : 'change-positive';
                        return `
                            <p class="metric-value">${support.open_tickets || '0'}</p>
                            <p class="metric-label">Open Tickets</p>
                            <span class="metric-change ${urgentClass}">
                                <i data-feather="clock" style="width: 12px; height: 12px;"></i>
                                ${support.urgent_tickets || 0} urgent
                            </span>
                        `;
                    }
                });

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }

            animateMetricUpdate(elementId, contentGenerator) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const newContent = contentGenerator();
                if (newContent && element.innerHTML !== newContent) {
                    element.classList.add('metric-updated');
                    element.innerHTML = newContent;

                    setTimeout(() => {
                        element.classList.remove('metric-updated');
                    }, 600);
                }
            }

            updateMetricDisplay(metricType, value, change) {
                // Handle real-time metric updates from WebSocket
                const metricElement = document.querySelector(`[data-metric="${metricType}"] .metric-value`);
                if (metricElement) {
                    metricElement.textContent = value.toLocaleString();
                    metricElement.parentElement.classList.add('metric-updated');

                    setTimeout(() => {
                        metricElement.parentElement.classList.remove('metric-updated');
                    }, 600);
                }
            }

            async refreshSystemHealth() {
                try {
                    const health = await this.fetchWithAuth('/admin/system-health');
                    this.data.health = health;
                    this.updateSystemHealth();
                } catch (error) {
                    console.error('Error refreshing system health:', error);
                }
            }

            async runSystemCheck() {
                try {
                    this.showSystemAlert('Running comprehensive system check...', 'info');

                    const result = await this.fetchWithAuth('/admin/system-check', {
                        method: 'POST'
                    });

                    this.showSystemAlert('System check completed successfully', 'success');
                    await this.refreshSystemHealth();
                } catch (error) {
                    console.error('Error running system check:', error);
                    this.showSystemAlert('System check failed', 'danger');
                }
            }

            updateSystemHealth() {
                const health = this.data.health;
                if (!health) return;

                const systemHealthEl = document.getElementById('systemHealth');
                if (!systemHealthEl) return;

                const components = health.components || {};
                let html = '<div class="row g-2">';

                // Database Health
                if (components.database) {
                    const status = components.database.status === 'healthy' ? 'online' : 'error';
                    html += `
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-between p-2 rounded" style="background: var(--card-bg);">
                                <small class="fw-medium">Database</small>
                                <span>
                                    <span class="status-indicator status-${status}"></span>
                                    <small>${components.database.status}</small>
                                </span>
                            </div>
                        </div>
                    `;
                }

                // Cache Health
                if (components.cache) {
                    const status = components.cache.status === 'healthy' ? 'online' :
                        components.cache.status === 'degraded' ? 'warning' : 'error';
                    html += `
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-between p-2 rounded" style="background: var(--card-bg);">
                                <small class="fw-medium">Cache</small>
                                <span>
                                    <span class="status-indicator status-${status}"></span>
                                    <small>${components.cache.status}</small>
                                </span>
                            </div>
                        </div>
                    `;
                }

                // External APIs
                if (components.external_apis) {
                    const apis = components.external_apis;
                    html += `
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-between p-2 rounded" style="background: var(--card-bg);">
                                <small class="fw-medium">TMDB API</small>
                                <span>
                                    <span class="status-indicator status-${apis.tmdb === 'configured' ? 'online' : 'warning'}"></span>
                                    <small>${apis.tmdb}</small>
                                </span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-between p-2 rounded" style="background: var(--card-bg);">
                                <small class="fw-medium">Jikan API</small>
                                <span>
                                    <span class="status-indicator status-${apis.jikan === 'configured' ? 'online' : 'warning'}"></span>
                                    <small>${apis.jikan}</small>
                                </span>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                systemHealthEl.innerHTML = html;

                // Update system alerts
                this.updateSystemAlerts(health);
            }

            updateSystemHealthRealTime(healthData) {
                this.data.health = healthData;
                this.updateSystemHealth();

                // Show alert if health status changed
                if (healthData.status === 'unhealthy') {
                    this.showRealTimeAlert({
                        type: 'danger',
                        message: 'Critical system issues detected'
                    });
                }
            }

            updateSystemAlerts(health) {
                const alertsContainer = document.getElementById('systemAlerts');
                if (!alertsContainer) return;

                let alerts = [];

                if (health.status === 'degraded') {
                    alerts.push({
                        type: 'warning',
                        message: 'Some system components are experiencing issues'
                    });
                } else if (health.status === 'unhealthy') {
                    alerts.push({
                        type: 'danger',
                        message: 'Critical system issues detected - immediate attention required'
                    });
                }

                const components = health.components || {};
                if (components.support_system?.status === 'error') {
                    alerts.push({
                        type: 'warning',
                        message: 'Support system connectivity issues detected'
                    });
                }

                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        <i data-feather="alert-triangle"></i>
                        ${alert.message}
                    </div>
                `).join('');

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }

            async refreshActivity() {
                try {
                    const analytics = await this.fetchWithAuth('/admin/analytics');
                    this.data.analytics = analytics;
                    this.updateRecentActivity();
                } catch (error) {
                    console.error('Error refreshing activity:', error);
                }
            }

            updateRecentActivity() {
                const analytics = this.data.analytics;
                if (!analytics) return;

                const activityEl = document.getElementById('recentActivity');
                if (!activityEl) return;

                // Generate realistic activity data
                const currentTime = new Date();
                const activities = [
                    {
                        action: 'New user registered',
                        user: 'user_' + Math.floor(Math.random() * 1000),
                        time: new Date(currentTime - Math.random() * 300000).toLocaleTimeString(),
                        status: 'success'
                    },
                    {
                        action: 'Content added to database',
                        user: 'admin',
                        time: new Date(currentTime - Math.random() * 900000).toLocaleTimeString(),
                        status: 'success'
                    },
                    {
                        action: 'Support ticket resolved',
                        user: 'support_agent',
                        time: new Date(currentTime - Math.random() * 1800000).toLocaleTimeString(),
                        status: 'success'
                    },
                    {
                        action: 'System health check completed',
                        user: 'system',
                        time: new Date(currentTime - Math.random() * 600000).toLocaleTimeString(),
                        status: 'info'
                    }
                ];

                let html = '<table class="data-table"><thead><tr><th>Activity</th><th>Time</th><th>Status</th></tr></thead><tbody>';

                activities.forEach(activity => {
                    html += `
                        <tr>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-medium">${activity.action}</span>
                                    <small class="text-muted">by ${activity.user}</small>
                                </div>
                            </td>
                            <td><small>${activity.time}</small></td>
                            <td><span class="badge badge-${activity.status}">${activity.status}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                activityEl.innerHTML = html;
            }

            updateActivityFeed(activity) {
                // Handle real-time activity updates from WebSocket
                const activityEl = document.getElementById('recentActivity');
                if (!activityEl) return;

                // Add new activity to the top of the list
                const table = activityEl.querySelector('tbody');
                if (table) {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-medium">${activity.action}</span>
                                <small class="text-muted">by ${activity.user}</small>
                            </div>
                        </td>
                        <td><small>just now</small></td>
                        <td><span class="badge badge-${activity.status}">${activity.status}</span></td>
                    `;
                    newRow.style.background = 'var(--admin-success)';
                    newRow.style.opacity = '0.3';

                    table.insertBefore(newRow, table.firstChild);

                    // Animate the new row
                    setTimeout(() => {
                        newRow.style.background = '';
                        newRow.style.opacity = '1';
                    }, 100);

                    // Remove oldest row if too many
                    if (table.children.length > 5) {
                        table.removeChild(table.lastChild);
                    }
                }
            }

            switchChart(type) {
                this.currentChart = type;
                this.updateAnalytics();

                // Update button states
                document.querySelectorAll('.card-header button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }

            updateAnalytics() {
                const chartEl = document.getElementById('analyticsChart');
                if (!chartEl) return;

                // Create a simple chart visualization
                const chartData = this.generateChartData(this.currentChart);

                chartEl.innerHTML = `
                    <div class="w-100 h-100 d-flex flex-column justify-content-center align-items-center">
                        <div class="d-flex align-items-end justify-content-center gap-2 mb-3" style="height: 60px;">
                            ${chartData.map((value, index) => `
                                <div style="
                                    width: 20px; 
                                    height: ${value}px; 
                                    background: linear-gradient(180deg, var(--admin-primary), var(--admin-primary-dark));
                                    border-radius: 2px;
                                    animation: chartBar 0.5s ease ${index * 0.1}s both;
                                "></div>
                            `).join('')}
                        </div>
                        <div class="text-center">
                            <h6 class="mb-1">${this.currentChart.charAt(0).toUpperCase() + this.currentChart.slice(1)} Trends</h6>
                            <small class="text-muted">Real-time data visualization</small>
                        </div>
                    </div>
                `;

                // Add CSS animation for chart bars
                if (!document.getElementById('chartAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'chartAnimation';
                    style.textContent = `
                        @keyframes chartBar {
                            from { height: 0; }
                            to { height: var(--final-height); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }

            generateChartData(type) {
                // Generate sample chart data based on type
                const baseData = Array.from({ length: 12 }, () => Math.random() * 50 + 10);

                switch (type) {
                    case 'users':
                        return baseData.map(val => val * 1.2);
                    case 'content':
                        return baseData.map(val => val * 0.8);
                    case 'performance':
                        return baseData.map(val => val * 1.5);
                    default:
                        return baseData;
                }
            }

            setupEventListeners() {
                // Theme toggle
                document.getElementById('themeToggle')?.addEventListener('click', () => {
                    if (window.themeManager) {
                        window.themeManager.toggleTheme();
                    }
                });

                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });

                // Handle connection changes
                window.addEventListener('online', () => {
                    console.log('游깷 Back online, attempting to reconnect...');
                    this.initWebSocket();
                });

                window.addEventListener('offline', () => {
                    console.log('游깷 Gone offline, WebSocket will retry when back online');
                });
            }

            setupVisibilityHandling() {
                // Pause updates when tab is not visible
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        console.log('낒勇 Dashboard hidden, reducing update frequency');
                        this.pauseUpdates();
                    } else {
                        console.log('郊윒잺 Dashboard visible, resuming normal updates');
                        this.resumeUpdates();
                    }
                });
            }

            pauseUpdates() {
                // Reduce update frequency when tab is hidden
                this.refreshIntervals.forEach((interval, key) => {
                    clearInterval(interval);
                    // Restart with slower frequency
                    this.refreshIntervals.set(key, setInterval(() => {
                        if (key === 'metrics') this.refreshAllMetrics();
                        else if (key === 'health') this.refreshSystemHealth();
                        else if (key === 'activity') this.refreshActivity();
                    }, this.updateFrequencies.slow));
                });
            }

            resumeUpdates() {
                // Resume normal update frequency
                this.cleanup();
                this.setupRealTimeUpdates();
                this.loadInitialData();
            }

            showPageLoading(show) {
                const indicator = document.getElementById('page-loading-indicator');
                if (indicator) {
                    indicator.style.transform = show ? 'scaleX(1)' : 'scaleX(0)';
                }
            }

            showSystemAlert(message, type = 'info', duration = 5000) {
                const alertsContainer = document.getElementById('systemAlerts');
                if (!alertsContainer) return;

                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <i data-feather="info"></i>
                    ${message}
                `;

                alertsContainer.appendChild(alert);

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }

                // Auto-remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        alert.remove();
                    }, duration);
                }
            }

            showRealTimeAlert(alert) {
                this.showSystemAlert(alert.message, alert.type, 8000);
            }

            cleanup() {
                // Clean up intervals
                this.refreshIntervals.forEach(interval => clearInterval(interval));
                this.refreshIntervals.clear();

                // Close WebSocket connection
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
            }

            logout() {
                this.cleanup();

                localStorage.removeItem('cinebrain-token');
                localStorage.removeItem('cinebrain-user');
                localStorage.removeItem('cinebrain-role');
                sessionStorage.clear();

                window.location.href = '/auth/login.html';
            }
        }

        // Global functions
        let adminDashboard;

        document.addEventListener('DOMContentLoaded', () => {
            adminDashboard = new RealTimeAdminDashboard();

            // Expose methods globally for onclick handlers
            window.adminDashboard = adminDashboard;
        });

        // Handle page reload/refresh
        window.addEventListener('beforeunload', () => {
            if (adminDashboard) {
                adminDashboard.cleanup();
            }
        });
    </script>
</body>

</html>