<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Browser - CineScope Admin</title>
    <meta name="description" content="Browse and manage all content on CineScope platform.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Content Browser...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">üóÇÔ∏è Content Browser</h1>
                <p class="text-gray-400">Browse, search, and manage all platform content</p>
            </div>
            <div class="flex items-center gap-4">
                <button class="btn btn-secondary" onclick="openFilterModal()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    Advanced Filters
                </button>
                <button class="btn btn-primary" onclick="openAddContentModal()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Content
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="card mb-8">
            <div class="card-content">
                <div class="grid grid-1 md:grid-4 gap-4">
                    <div class="md:col-span-2">
                        <input type="search" id="contentSearch" class="form-input" placeholder="Search by title, ID, or IMDB ID...">
                    </div>
                    <div>
                        <select id="contentTypeFilter" class="form-input">
                            <option value="">All Types</option>
                            <option value="movie">Movies</option>
                            <option value="tv">TV Shows</option>
                            <option value="anime">Anime</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary w-full" onclick="searchContent()">
                            Search Content
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Table -->
        <div class="card">
            <div class="card-content">
                <!-- Table Actions -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                        <select id="bulkAction" class="form-input">
                            <option value="">Bulk Actions</option>
                            <option value="recommend">Create Recommendations</option>
                            <option value="update">Update Metadata</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="applyBulkAction()">Apply</button>
                    </div>
                    <div class="text-sm text-gray-400">
                        Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> items
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-800">
                            <tr>
                                <th class="px-4 py-3 text-left">
                                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                                </th>
                                <th class="px-4 py-3 text-left">ID</th>
                                <th class="px-4 py-3 text-left">Title</th>
                                <th class="px-4 py-3 text-left">Type</th>
                                <th class="px-4 py-3 text-left">Rating</th>
                                <th class="px-4 py-3 text-left">Release Date</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contentTableBody">
                            <!-- Content rows will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Items per page:</span>
                        <select id="itemsPerPage" class="form-input" onchange="changeItemsPerPage()">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-ghost btn-sm" onclick="previousPage()" id="prevBtn" disabled>
                            Previous
                        </button>
                        <span class="px-4 py-2 text-sm">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </span>
                        <button class="btn btn-ghost btn-sm" onclick="nextPage()" id="nextBtn">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Add Content Modal -->
    <div id="addContentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Content</h3>
                <button class="modal-close" onclick="closeAddContentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Search External Sources</label>
                        <input type="text" id="externalSearchQuery" class="form-input" 
                               placeholder="Enter movie/show title...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select id="externalSource" class="form-input">
                            <option value="tmdb">TMDB (Movies & TV)</option>
                            <option value="anime">Jikan (Anime)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-full" onclick="searchExternal()">
                        Search External Database
                    </button>
                    
                    <div id="externalSearchResults" class="mt-6" style="display: none;">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Content Modal -->
    <div id="editContentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Content</h3>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="editContentForm" class="space-y-4">
                    <!-- Form fields will be populated dynamically -->
                </form>
            </div>
        </div>
    </div>

    <!-- Recommendation Modal -->
    <div id="recommendationModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create Admin Recommendation</h3>
                <button class="modal-close" onclick="closeRecommendationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="recommendationForm" class="space-y-4">
                    <div id="selectedContentInfo" class="mb-4">
                        <!-- Selected content info will be shown here -->
                    </div>
                    <div class="form-group">
                        <label class="form-label">Recommendation Type</label>
                        <select id="recommendationType" class="form-input">
                            <option value="admin_choice">Admin's Choice</option>
                            <option value="trending">Trending Pick</option>
                            <option value="hidden_gem">Hidden Gem</option>
                            <option value="must_watch">Must Watch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="recommendationDescription" class="form-input h-32" 
                                  placeholder="Why do you recommend this content?" required></textarea>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" class="btn btn-secondary" onclick="closeRecommendationModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Create Recommendation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalItems = 0;
        let selectedItems = new Set();
        let allContent = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!appState.isAuthenticated() || !appState.isAdmin()) {
                window.location.href = '/login';
                return;
            }

            await loadContent();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('contentSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchContent();
            });

            document.getElementById('recommendationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createRecommendation();
            });
        }

        async function loadContent() {
            try {
                // Simulate loading content from database
                const response = await api.getTrending('all', 100);
                allContent = response.recommendations || [];
                totalItems = allContent.length;
                
                renderContent();
                updatePagination();

            } catch (error) {
                console.error('Error loading content:', error);
                UI.showToast('Failed to load content', 'error');
            }
        }

        function renderContent() {
            const tbody = document.getElementById('contentTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageContent = allContent.slice(start, end);

            if (pageContent.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-400">
                            No content found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageContent.map(item => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="px-4 py-3">
                        <input type="checkbox" value="${item.id}" onchange="toggleSelection(${item.id})"
                               ${selectedItems.has(item.id) ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-3 text-sm">${item.id}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <img src="${item.poster_path || Utils.getPlaceholderImage(40, 60)}" 
                                 alt="${Utils.sanitizeHTML(item.title)}" 
                                 class="w-10 h-15 object-cover rounded">
                            <div>
                                <div class="font-medium">${Utils.sanitizeHTML(item.title)}</div>
                                <div class="text-xs text-gray-400">${item.original_title || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge badge-ghost">${item.content_type?.toUpperCase()}</span>
                    </td>
                    <td class="px-4 py-3">
                        ${item.rating ? `<span class="text-yellow-400">‚≠ê ${item.rating.toFixed(1)}</span>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        ${item.release_date ? new Date(item.release_date).toLocaleDateString() : '-'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge ${getStatusBadgeClass(item)}">
                            ${getContentStatus(item)}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <button class="btn btn-ghost btn-sm" onclick="Router.navigate('/details?id=${item.id}')" 
                                    title="View">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                            <button class="btn btn-ghost btn-sm" onclick="editContent(${item.id})" 
                                    title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button class="btn btn-ghost btn-sm" onclick="openRecommendationModal(${item.id})" 
                                    title="Recommend">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('showingCount').textContent = pageContent.length;
            document.getElementById('totalCount').textContent = totalItems;
        }

        function getContentStatus(item) {
            if (item.is_trending) return 'Trending';
            if (item.is_new_release) return 'New';
            if (item.is_critics_choice) return 'Critics\' Choice';
            return 'Active';
        }

        function getStatusBadgeClass(item) {
            if (item.is_trending) return 'badge-warning';
            if (item.is_new_release) return 'badge-success';
            if (item.is_critics_choice) return 'badge-primary';
            return 'badge-ghost';
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderContent();
                updatePagination();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderContent();
                updatePagination();
            }
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            renderContent();
            updatePagination();
        }

        function toggleSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#contentTableBody input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const id = parseInt(checkbox.value);
                if (selectAll.checked) {
                    selectedItems.add(id);
                } else {
                    selectedItems.delete(id);
                }
            });
        }

        async function searchContent() {
            const query = document.getElementById('contentSearch').value.trim();
            const type = document.getElementById('contentTypeFilter').value;

            if (!query && !type) {
                await loadContent();
                return;
            }

            // Filter content
            let filtered = allContent;

            if (query) {
                filtered = filtered.filter(item => 
                    item.title.toLowerCase().includes(query.toLowerCase()) ||
                    item.id.toString() === query ||
                    (item.imdb_id && item.imdb_id === query)
                );
            }

            if (type) {
                filtered = filtered.filter(item => item.content_type === type);
            }

            allContent = filtered;
            totalItems = filtered.length;
            currentPage = 1;
            renderContent();
            updatePagination();
        }

        function openAddContentModal() {
            document.getElementById('addContentModal').classList.add('show');
        }

        function closeAddContentModal() {
            document.getElementById('addContentModal').classList.remove('show');
            document.getElementById('externalSearchResults').style.display = 'none';
            document.getElementById('externalSearchQuery').value = '';
        }

        async function searchExternal() {
            const query = document.getElementById('externalSearchQuery').value.trim();
            const source = document.getElementById('externalSource').value;

            if (!query) {
                UI.showToast('Please enter a search query', 'error');
                return;
            }

            try {
                const resultsContainer = document.getElementById('externalSearchResults');
                resultsContainer.style.display = 'block';
                resultsContainer.innerHTML = '<div class="text-center py-4"><div class="loader"></div></div>';

                const response = await api.adminSearch(query, source);
                const results = response.results || [];

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="text-center text-gray-400 py-4">No results found</div>';
                    return;
                }

                resultsContainer.innerHTML = `
                    <h4 class="font-semibold mb-4">Search Results (${results.length})</h4>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${results.map(item => `
                            <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                <img src="${item.poster_path || Utils.getPlaceholderImage(60, 90)}" 
                                     alt="${Utils.sanitizeHTML(item.title)}" 
                                     class="w-12 h-18 object-cover rounded">
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-medium truncate">${Utils.sanitizeHTML(item.title)}</h5>
                                    <p class="text-sm text-gray-400">${item.release_date || 'N/A'} ‚Ä¢ ${item.content_type?.toUpperCase()}</p>
                                    ${item.rating ? `<div class="text-xs text-yellow-400">‚≠ê ${item.rating}</div>` : ''}
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="addExternalContent(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                    Add to DB
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Error searching external content:', error);
                document.getElementById('externalSearchResults').innerHTML = 
                    '<div class="text-center text-red-400 py-4">Search failed. Please try again.</div>';
            }
        }

        async function addExternalContent(contentData) {
            try {
                const response = await api.saveContent(contentData);
                UI.showToast('Content added successfully!', 'success');
                closeAddContentModal();
                await loadContent();

            } catch (error) {
                console.error('Error adding content:', error);
                UI.showToast('Failed to add content', 'error');
            }
        }

        function editContent(contentId) {
            const content = allContent.find(item => item.id === contentId);
            if (!content) return;

            // Populate edit form
            const modal = document.getElementById('editContentModal');
            const form = document.getElementById('editContentForm');
            
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" value="${Utils.sanitizeHTML(content.title)}" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input">
                        <option value="active" ${!content.is_hidden ? 'selected' : ''}>Active</option>
                        <option value="hidden" ${content.is_hidden ? 'selected' : ''}>Hidden</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" ${content.is_trending ? 'checked' : ''}>
                        <span>Mark as Trending</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" ${content.is_critics_choice ? 'checked' : ''}>
                        <span>Mark as Critics' Choice</span>
                    </label>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveContentEdits(${contentId})">Save Changes</button>
                </div>
            `;

            modal.classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editContentModal').classList.remove('show');
        }

        async function saveContentEdits(contentId) {
            // Implement save functionality
            UI.showToast('Content updated successfully!', 'success');
            closeEditModal();
            await loadContent();
        }

        function openRecommendationModal(contentId) {
            const content = allContent.find(item => item.id === contentId);
            if (!content) return;

            currentRecommendationContent = content;

            // Show content info
            document.getElementById('selectedContentInfo').innerHTML = `
                <div class="flex items-center gap-4 p-4 bg-gray-800 rounded-lg">
                    <img src="${content.poster_path || Utils.getPlaceholderImage(60, 90)}" 
                         alt="${Utils.sanitizeHTML(content.title)}" 
                         class="w-12 h-18 object-cover rounded">
                    <div>
                        <h4 class="font-semibold">${Utils.sanitizeHTML(content.title)}</h4>
                        <p class="text-sm text-gray-400">
                            ${content.release_date ? new Date(content.release_date).getFullYear() : 'N/A'} ‚Ä¢ 
                            ${content.content_type?.toUpperCase()} ‚Ä¢ 
                            ${content.rating ? `‚≠ê ${content.rating.toFixed(1)}` : 'No rating'}
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('recommendationModal').classList.add('show');
        }

        function closeRecommendationModal() {
            document.getElementById('recommendationModal').classList.remove('show');
            document.getElementById('recommendationForm').reset();
            currentRecommendationContent = null;
        }

        async function createRecommendation() {
            if (!currentRecommendationContent) return;

            const type = document.getElementById('recommendationType').value;
            const description = document.getElementById('recommendationDescription').value;

            try {
                await api.createAdminRecommendation(
                    currentRecommendationContent.id,
                    type,
                    description
                );

                UI.showToast('Recommendation created successfully!', 'success');
                closeRecommendationModal();

            } catch (error) {
                console.error('Error creating recommendation:', error);
                UI.showToast('Failed to create recommendation', 'error');
            }
        }

        function applyBulkAction() {
            const action = document.getElementById('bulkAction').value;
            
            if (!action) {
                UI.showToast('Please select an action', 'warning');
                return;
            }

            if (selectedItems.size === 0) {
                UI.showToast('Please select items first', 'warning');
                return;
            }

            switch (action) {
                case 'recommend':
                    UI.showToast(`Creating recommendations for ${selectedItems.size} items...`, 'info');
                    break;
                case 'update':
                    UI.showToast(`Updating metadata for ${selectedItems.size} items...`, 'info');
                    break;
                case 'delete':
                    if (confirm(`Are you sure you want to delete ${selectedItems.size} items?`)) {
                        UI.showToast(`Deleting ${selectedItems.size} items...`, 'warning');
                    }
                    break;
            }

            // Clear selections
            selectedItems.clear();
            document.getElementById('selectAll').checked = false;
            renderContent();
        }

        let currentRecommendationContent = null;

        // Click outside modal to close
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>