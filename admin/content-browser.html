<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Browser - Admin - CineScope</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/responsive.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    .search-panel {
      background: var(--bg-card);
      padding: var(--space-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-xl);
    }
    
    .source-tabs {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
      border-bottom: 1px solid var(--bg-hover);
    }
    
    .source-tab {
      padding: var(--space-sm) var(--space-lg);
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .source-tab.active {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
    }
    
    .search-results {
      display: grid;
      gap: var(--space-md);
    }
    
    .result-item {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      display: grid;
      grid-template-columns: 100px 1fr auto;
      gap: var(--space-lg);
      align-items: center;
      transition: all var(--transition-base);
    }
    
    .result-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }
    
    .result-poster {
      width: 100px;
      height: 150px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: var(--bg-hover);
    }
    
    .result-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .result-info h3 {
      margin-bottom: var(--space-xs);
    }
    
    .result-meta {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      margin-top: var(--space-sm);
    }
    
    @media (max-width: 768px) {
      .result-item {
        grid-template-columns: 80px 1fr;
      }
      
      .result-actions {
        grid-column: 1 / -1;
        margin-top: var(--space-md);
      }
      
      .result-poster {
        width: 80px;
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" style="display: none;">
    <div class="spinner spinner-lg"></div>
  </div>
  
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container navbar-content">
      <a href="/" class="navbar-brand gradient-text">CineScope Admin</a>
      
      <button class="mobile-menu-toggle lg:hidden">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="navbar-menu hidden md:flex">
        <a href="/" class="navbar-link">Back to Site</a>
        <div class="user-menu"></div>
      </div>
    </div>
  </nav>
  
  <!-- Admin Layout -->
  <div class="admin-layout" style="margin-top: 60px;">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav>
        <a href="/admin/dashboard.html" class="admin-nav-item">
          <i class="fas fa-tachometer-alt mr-sm"></i> Dashboard
        </a>
        <a href="/admin/content-browser.html" class="admin-nav-item active">
          <i class="fas fa-search mr-sm"></i> Content Browser
        </a>
        <a href="/admin/posts.html" class="admin-nav-item">
          <i class="fas fa-bullhorn mr-sm"></i> Admin Posts
        </a>
        <a href="/admin/analytics.html" class="admin-nav-item">
          <i class="fas fa-chart-bar mr-sm"></i> Analytics
        </a>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="admin-content">
      <h1 class="mb-xl">Content Browser</h1>
      
      <!-- Search Panel -->
      <div class="search-panel">
        <div class="source-tabs">
          <div class="source-tab active" onclick="switchSource('tmdb')">TMDB</div>
          <div class="source-tab" onclick="switchSource('anime')">Anime (MAL)</div>
        </div>
        
        <form id="content-search-form" class="grid gap-md" style="grid-template-columns: 1fr auto;">
          <input type="text" class="form-input" id="search-query" placeholder="Search for movies, TV shows, or anime..." required>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search mr-sm"></i> Search
          </button>
        </form>
      </div>
      
      <!-- Search Results -->
      <div id="search-results"></div>
      
      <!-- Pagination -->
      <div id="pagination" class="flex-center gap-md mt-xl" style="display: none;">
        <button class="btn btn-ghost" onclick="changePage(-1)" id="prev-page">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span id="page-info">Page 1</span>
        <button class="btn btn-ghost" onclick="changePage(1)" id="next-page">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </main>
  </div>
  
  <!-- Add Content Modal -->
  <div id="add-content-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Add to CineScope</h3>
        <button class="modal-close" onclick="closeModal('add-content-modal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="modal-content-details"></div>
        
        <form id="recommendation-form" class="mt-lg">
          <div class="form-group">
            <label class="form-label">Recommendation Type</label>
            <select class="form-select" name="recommendation_type" required>
              <option value="admin_choice">Admin's Choice</option>
              <option value="trending">Trending</option>
              <option value="critics_choice">Critics' Choice</option>
              <option value="hidden_gem">Hidden Gem</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Admin Note</label>
            <textarea class="form-textarea" name="description" rows="3" placeholder="Why do you recommend this?" required></textarea>
          </div>
          
          <div class="flex gap-md">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus mr-sm"></i> Add Content
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('add-content-modal')">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container"></div>
  
  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script>
    // Check admin authentication
    if (!AppState.user || !AppState.user.is_admin) {
      window.location.href = '/';
    }
    
    let currentSource = 'tmdb';
    let currentPage = 1;
    let currentQuery = '';
    let selectedContent = null;
    
    // Switch content source
    function switchSource(source) {
      currentSource = source;
      currentPage = 1;
      
      // Update tabs
      document.querySelectorAll('.source-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Clear results
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('pagination').style.display = 'none';
    }
    
    // Search form handler
    document.getElementById('content-search-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      currentQuery = document.getElementById('search-query').value;
      currentPage = 1;
      
      await searchContent();
    });
    
    // Search content
    async function searchContent() {
      if (!currentQuery) return;
      
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = '<div class="text-center p-xl"><div class="spinner mx-auto"></div></div>';
      
      try {
        const response = await fetch(`${API_BASE}/admin/search?query=${encodeURIComponent(currentQuery)}&source=${currentSource}&page=${currentPage}`, {
          headers: TokenManager.getHeaders()
        });
        
        const data = await response.json();
        renderSearchResults(data.results || []);
        
        // Update pagination
        document.getElementById('page-info').textContent = `Page ${currentPage}`;
        document.getElementById('pagination').style.display = data.results && data.results.length > 0 ? 'flex' : 'none';
        
      } catch (error) {
        resultsContainer.innerHTML = '<div class="text-center text-secondary p-xl">Failed to search content</div>';
        showToast('Search failed', 'error');
      }
    }
    
    // Render search results
    function renderSearchResults(results) {
      const container = document.getElementById('search-results');
      
      if (results.length === 0) {
        container.innerHTML = '<div class="text-center text-secondary p-xl">No results found</div>';
        return;
      }
      
      container.innerHTML = `
        <div class="search-results">
          ${results.map(item => `
            <div class="result-item">
              <div class="result-poster">
                ${item.poster_path ? `<img src="${item.poster_path}" alt="${item.title}">` : '<i class="fas fa-film text-2xl text-muted" style="line-height: 150px;"></i>'}
              </div>
              
              <div class="result-info">
                <h3>${item.title}</h3>
                <p class="text-secondary text-sm mb-sm">${item.overview ? item.overview.substring(0, 150) + '...' : 'No description available'}</p>
                
                <div class="result-meta text-sm">
                  <span class="tag">${item.content_type}</span>
                  ${item.release_date ? `<span class="text-secondary">${new Date(item.release_date).getFullYear()}</span>` : ''}
                  ${item.rating ? `
                    <div class="flex items-center gap-xs">
                      <i class="fas fa-star text-yellow"></i>
                      <span>${item.rating}</span>
                    </div>
                  ` : ''}
                  <span class="tag tag-primary">${item.source.toUpperCase()}</span>
                </div>
              </div>
              
              <div class="result-actions">
                <button class="btn btn-primary btn-sm" onclick='addContent(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                  <i class="fas fa-plus mr-xs"></i> Add
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // Add content
    function addContent(content) {
      selectedContent = content;
      
      // Show modal with content details
      const modalDetails = document.getElementById('modal-content-details');
      modalDetails.innerHTML = `
        <div class="flex gap-md mb-lg">
          <div style="width: 100px;">
            ${content.poster_path ? `<img src="${content.poster_path}" alt="${content.title}" class="rounded-md">` : '<div class="bg-hover rounded-md" style="height: 150px;"></div>'}
          </div>
          <div>
            <h3 class="mb-sm">${content.title}</h3>
            <p class="text-secondary text-sm">${content.content_type} • ${content.release_date ? new Date(content.release_date).getFullYear() : 'N/A'}</p>
            ${content.rating ? `<div class="rating mt-sm"><i class="fas fa-star text-yellow"></i> <span>${content.rating}</span></div>` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('add-content-modal').classList.add('active');
    }
    
    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // Recommendation form handler
    document.getElementById('recommendation-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      try {
        // First, save the content
        const saveResponse = await fetch(`${API_BASE}/admin/content`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...TokenManager.getHeaders()
          },
          body: JSON.stringify(selectedContent)
        });
        
        const saveData = await saveResponse.json();
        
        if (saveData.content_id) {
          // Then create recommendation
          const recResponse = await fetch(`${API_BASE}/admin/recommendations`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...TokenManager.getHeaders()
            },
            body: JSON.stringify({
              content_id: saveData.content_id,
              recommendation_type: formData.get('recommendation_type'),
              description: formData.get('description')
            })
          });
          
          const recData = await recResponse.json();
          
          showToast('Content added successfully!', 'success');
          closeModal('add-content-modal');
          e.target.reset();
        }
        
      } catch (error) {
        showToast('Failed to add content', 'error');
      }
    });
    
    // Pagination
    function changePage(direction) {
      currentPage = Math.max(1, currentPage + direction);
      searchContent();
    }
    
    // Initialize
    updateAuthUI();
  </script>
</body>
</html>