<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Browser - Admin - CineScope</title>
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <i class="fas fa-film"></i>
                <span>CineScope</span>
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading content browser...</div>
        </div>
    </div>

    <!-- Header -->
    <div id="headerContainer"></div>

    <!-- Main Content -->
    <main class="main-content admin-content">
        <!-- Admin Header -->
        <section class="admin-header">
            <div class="container">
                <div class="admin-header-content">
                    <div class="breadcrumb-nav">
                        <nav class="breadcrumb">
                            <span class="breadcrumb-item"><a href="/">Home</a></span>
                            <span class="breadcrumb-item"><a href="/admin/dashboard">Admin</a></span>
                            <span class="breadcrumb-item active">Content Browser</span>
                        </nav>
                    </div>
                    <h1 class="admin-title">
                        <i class="fas fa-search text-primary me-3"></i>
                        Content Browser
                    </h1>
                    <p class="admin-subtitle">
                        Search and manage content from external sources
                    </p>
                </div>
            </div>
        </section>

        <!-- Search Section -->
        <section class="content-search-section">
            <div class="container">
                <div class="search-card">
                    <div class="search-header">
                        <h3>Search External Content</h3>
                        <div class="source-selector">
                            <label>Source:</label>
                            <select class="form-select form-select-sm" id="sourceSelect">
                                <option value="tmdb">TMDB (Movies & TV)</option>
                                <option value="anime">Jikan (Anime)</option>
                                <option value="omdb">OMDb</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-form">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="search-input-wrapper">
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="Search for movies, TV shows, or anime...">
                                    <button class="btn btn-primary" id="searchBtn">
                                        <i class="fas fa-search me-2"></i>
                                        Search
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="contentTypeFilter">
                                    <option value="multi">All Types</option>
                                    <option value="movie">Movies</option>
                                    <option value="tv">TV Shows</option>
                                    <option value="anime">Anime</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-tips">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>Search by title, year, or IMDb ID. Use filters to narrow results.</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Search Results -->
        <section class="search-results-section">
            <div class="container">
                <div class="results-header" id="resultsHeader" style="display: none;">
                    <h3>Search Results</h3>
                    <div class="results-stats">
                        <span id="resultCount">0 results</span>
                        <span id="searchTime">0s</span>
                    </div>
                </div>
                
                <div class="results-grid" id="resultsGrid">
                    <!-- Initial state -->
                    <div class="empty-state">
                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                        <h4>No search performed yet</h4>
                        <p>Enter a search term above to find content from external sources.</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <button class="btn btn-outline-primary" id="prevPageBtn" disabled>
                        <i class="fas fa-chevron-left me-2"></i>
                        Previous
                    </button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button class="btn btn-outline-primary" id="nextPageBtn" disabled>
                        Next
                        <i class="fas fa-chevron-right ms-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Database Content Section -->
        <section class="database-content-section">
            <div class="container">
                <div class="section-header">
                    <h3>Recently Added to Database</h3>
                    <button class="btn btn-outline-primary btn-sm" id="refreshRecentBtn">
                        <i class="fas fa-sync-alt me-2"></i>
                        Refresh
                    </button>
                </div>
                <div class="recent-content-grid" id="recentContentGrid">
                    <div class="loading-skeleton">
                        <div class="skeleton-card skeleton"></div>
                        <div class="skeleton-card skeleton"></div>
                        <div class="skeleton-card skeleton"></div>
                        <div class="skeleton-card skeleton"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div id="footerContainer"></div>

    <!-- Content Details Modal -->
    <div class="modal fade" id="contentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Content Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be dynamically loaded -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="saveToDbBtn">
                        <i class="fas fa-save me-2"></i>
                        Save to Database
                    </button>
                    <button type="button" class="btn btn-primary" id="createRecommendationBtn">
                        <i class="fas fa-star me-2"></i>
                        Create Recommendation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/include.js"></script>
    <script>
        let searchState = {
            currentPage: 1,
            totalPages: 1,
            currentQuery: '',
            currentSource: 'tmdb',
            searchResults: [],
            selectedContent: null
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeContentBrowser();
        });

        async function initializeContentBrowser() {
            // Check admin authentication
            if (!AuthManager.requireAuth()) return;
            
            if (!AppState.user || !AppState.user.is_admin) {
                Utils.showToast('Admin access required', 'error');
                window.location.href = '/dashboard';
                return;
            }

            // Load includes
            await loadIncludes();
            
            // Initialize content browser
            bindContentBrowserEvents();
            await loadRecentContent();

            Utils.hideLoadingScreen();
        }

        async function loadIncludes() {
            try {
                await Promise.all([
                    loadHeader(),
                    loadFooter()
                ]);
            } catch (error) {
                console.error('Failed to load includes:', error);
            }
        }

        function bindContentBrowserEvents() {
            // Search events
            document.getElementById('searchBtn').onclick = performSearch;
            document.getElementById('searchInput').onkeypress = (e) => {
                if (e.key === 'Enter') performSearch();
            };

            // Source change
            document.getElementById('sourceSelect').onchange = (e) => {
                searchState.currentSource = e.target.value;
                // Update content type filter based on source
                updateContentTypeFilter();
            };

            // Pagination
            document.getElementById('prevPageBtn').onclick = () => changePage(-1);
            document.getElementById('nextPageBtn').onclick = () => changePage(1);

            // Refresh recent content
            document.getElementById('refreshRecentBtn').onclick = loadRecentContent;

            // Modal events
            document.getElementById('saveToDbBtn').onclick = saveContentToDatabase;
            document.getElementById('createRecommendationBtn').onclick = createRecommendation;
        }

        function updateContentTypeFilter() {
            const contentTypeFilter = document.getElementById('contentTypeFilter');
            const source = searchState.currentSource;

            if (source === 'anime') {
                contentTypeFilter.innerHTML = `
                    <option value="anime">All Anime</option>
                    <option value="tv">TV Series</option>
                    <option value="movie">Movies</option>
                    <option value="ova">OVA</option>
                `;
            } else {
                contentTypeFilter.innerHTML = `
                    <option value="multi">All Types</option>
                    <option value="movie">Movies</option>
                    <option value="tv">TV Shows</option>
                `;
            }
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                Utils.showToast('Please enter a search term', 'error');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const originalText = searchBtn.innerHTML;
            
            try {
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Searching...';
                searchBtn.disabled = true;

                const startTime = Date.now();
                searchState.currentQuery = query;
                searchState.currentPage = 1;

                const response = await ApiService.adminSearch(query, searchState.currentSource, searchState.currentPage);
                searchState.searchResults = response.results || [];
                
                const endTime = Date.now();
                const searchTime = ((endTime - startTime) / 1000).toFixed(2);

                displaySearchResults();
                updateResultsHeader(searchState.searchResults.length, searchTime);

            } catch (error) {
                console.error('Search failed:', error);
                Utils.showToast('Search failed. Please try again.', 'error');
                displayEmptyState('Search failed. Please try again.');
            } finally {
                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
            }
        }

        function displaySearchResults() {
            const grid = document.getElementById('resultsGrid');
            document.getElementById('resultsHeader').style.display = 'block';

            if (searchState.searchResults.length === 0) {
                displayEmptyState('No results found. Try a different search term.');
                return;
            }

            const resultsHtml = searchState.searchResults.map(item => `
                <div class="result-card" onclick="showContentDetails(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div class="result-poster">
                        <img src="${item.poster_path || 'https://via.placeholder.com/300x450?text=No+Image'}" 
                             alt="${item.title}"
                             onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                        <div class="result-overlay">
                            <button class="btn btn-primary btn-sm">
                                <i class="fas fa-eye me-2"></i>
                                View Details
                            </button>
                        </div>
                    </div>
                    <div class="result-info">
                        <h6 class="result-title">${item.title}</h6>
                        <div class="result-meta">
                            <span class="content-type">${item.content_type.toUpperCase()}</span>
                            <span class="release-date">${item.release_date || 'N/A'}</span>
                        </div>
                        <div class="result-rating">
                            <i class="fas fa-star"></i>
                            <span>${item.rating || 'N/A'}</span>
                        </div>
                        <p class="result-overview">${Utils.truncateText(item.overview || 'No overview available', 100)}</p>
                        <div class="result-source">
                            <span class="badge bg-info">Source: ${item.source.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            grid.innerHTML = resultsHtml;
            updatePagination();
        }

        function displayEmptyState(message) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                    <h4>${message}</h4>
                </div>
            `;
            document.getElementById('paginationContainer').style.display = 'none';
        }

        function updateResultsHeader(count, time) {
            document.getElementById('resultCount').textContent = `${count} result${count !== 1 ? 's' : ''}`;
            document.getElementById('searchTime').textContent = `${time}s`;
        }

        function updatePagination() {
            const container = document.getElementById('paginationContainer');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');

            if (searchState.searchResults.length > 0) {
                container.style.display = 'flex';
                prevBtn.disabled = searchState.currentPage === 1;
                nextBtn.disabled = searchState.currentPage >= searchState.totalPages;
                pageInfo.textContent = `Page ${searchState.currentPage} of ${searchState.totalPages}`;
            } else {
                container.style.display = 'none';
            }
        }

        async function changePage(direction) {
            searchState.currentPage += direction;
            await performSearch();
        }

        function showContentDetails(content) {
            searchState.selectedContent = content;
            const modal = new bootstrap.Modal(document.getElementById('contentDetailsModal'));
            
            // Update modal content
            document.getElementById('modalTitle').textContent = content.title;
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="content-details">
                    <div class="row">
                        <div class="col-md-4">
                            <img src="${content.poster_path || 'https://via.placeholder.com/300x450?text=No+Image'}" 
                                 alt="${content.title}" 
                                 class="img-fluid rounded">
                        </div>
                        <div class="col-md-8">
                            <h5>${content.title}</h5>
                            <div class="details-meta">
                                <span class="badge bg-primary">${content.content_type.toUpperCase()}</span>
                                <span class="badge bg-secondary">${content.release_date || 'N/A'}</span>
                                <span class="badge bg-warning">
                                    <i class="fas fa-star me-1"></i>
                                    ${content.rating || 'N/A'}
                                </span>
                            </div>
                            <div class="details-info">
                                <p><strong>Overview:</strong></p>
                                <p>${content.overview || 'No overview available'}</p>
                                
                                <div class="row mt-3">
                                    <div class="col-6">
                                        <p><strong>Source:</strong> ${content.source.toUpperCase()}</p>
                                        <p><strong>External ID:</strong> ${content.id}</p>
                                    </div>
                                    <div class="col-6">
                                        <p><strong>Type:</strong> ${content.content_type}</p>
                                        <p><strong>Release:</strong> ${content.release_date || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }

        async function saveContentToDatabase() {
            if (!searchState.selectedContent) return;

            const saveBtn = document.getElementById('saveToDbBtn');
            const originalText = saveBtn.innerHTML;

            try {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                saveBtn.disabled = true;

                await ApiService.saveExternalContent(searchState.selectedContent);
                
                Utils.showToast('Content saved to database successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('contentDetailsModal'));
                modal.hide();
                
                // Refresh recent content
                await loadRecentContent();

            } catch (error) {
                console.error('Failed to save content:', error);
                Utils.showToast('Failed to save content to database', 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function createRecommendation() {
            if (!searchState.selectedContent) return;

            // First save to database if not already saved
            await saveContentToDatabase();
            
            // Then redirect to create recommendation
            const contentId = searchState.selectedContent.id;
            window.location.href = `/admin/posts?content_id=${contentId}`;
        }

        async function loadRecentContent() {
            try {
                const grid = document.getElementById('recentContentGrid');
                grid.innerHTML = '<div class="loading-skeleton"><div class="skeleton-card skeleton"></div><div class="skeleton-card skeleton"></div><div class="skeleton-card skeleton"></div><div class="skeleton-card skeleton"></div></div>';

                const response = await ApiService.getRecentContent();
                const recentContent = response.content || [];

                if (recentContent.length === 0) {
                    grid.innerHTML = '<p class="text-muted text-center">No recent content added</p>';
                    return;
                }

                const contentHtml = recentContent.map(item => `
                    <div class="recent-card">
                        <div class="recent-poster">
                            <img src="${Utils.getImageUrl(item.poster_path)}" 
                                 alt="${item.title}"
                                 onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                        </div>
                        <div class="recent-info">
                            <h6 class="recent-title">${item.title}</h6>
                            <div class="recent-meta">
                                <span class="content-type">${item.content_type.toUpperCase()}</span>
                                <span class="added-date">Added ${new Date(item.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="recent-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="Utils.navigateToDetails(${item.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="window.location.href='/admin/posts?content_id=${item.id}'">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                grid.innerHTML = contentHtml;

            } catch (error) {
                console.error('Failed to load recent content:', error);
                document.getElementById('recentContentGrid').innerHTML = '<p class="text-muted text-center">Failed to load recent content</p>';
            }
        }

        // Extended API service
        ApiService.adminSearch = async function(query, source = 'tmdb', page = 1) {
            return await this.request(`/admin/search?query=${encodeURIComponent(query)}&source=${source}&page=${page}`);
        };

        ApiService.saveExternalContent = async function(content) {
            return await this.request('/admin/content', {
                method: 'POST',
                body: JSON.stringify(content)
            });
        };

        ApiService.getRecentContent = async function() {
            return await this.request('/admin/content/recent');
        };
    </script>

    <style>
        .content-search-section {
            padding: 2rem 0;
        }

        .search-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .search-header h3 {
            margin: 0;
        }

        .source-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-input-wrapper {
            display: flex;
            gap: 1rem;
        }

        .search-input-wrapper .form-control {
            flex: 1;
        }

        .search-tips {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .search-results-section {
            padding: 2rem 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .results-stats {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }

        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .result-poster {
            position: relative;
            overflow: hidden;
            height: 200px;
        }

        .result-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .result-card:hover .result-overlay {
            opacity: 1;
        }

        .result-info {
            padding: 1.5rem;
        }

        .result-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .result-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .result-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
            color: var(--warning-color);
        }

        .result-overview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .result-source {
            margin-top: auto;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }

        .page-info {
            color: var(--text-secondary);
        }

        .database-content-section {
            padding: 3rem 0;
            background: var(--bg-secondary);
        }

        .recent-content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .recent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .recent-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .recent-poster {
            height: 150px;
            overflow: hidden;
        }

        .recent-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recent-info {
            padding: 1rem;
        }

        .recent-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .recent-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .recent-actions {
            display: flex;
            gap: 0.5rem;
        }

        .content-details {
            color: var(--text-primary);
        }

        .details-meta {
            margin: 1rem 0;
        }

        .details-info {
            margin-top: 1rem;
        }

        .details-info p {
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .search-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .search-input-wrapper {
                flex-direction: column;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .recent-content-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .pagination-container {
                flex-wrap: wrap;
                gap: 1rem;
            }
        }
    </style>
</body>
</html>