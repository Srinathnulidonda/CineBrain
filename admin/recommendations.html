<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Recommendations - CineScope</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/base.css" rel="stylesheet">
    <link href="/assets/css/components.css" rel="stylesheet">
    <link href="/assets/css/layouts.css" rel="stylesheet">
    <link href="/assets/css/animations.css" rel="stylesheet">
    <link href="/assets/css/responsive.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
</head>

<body>
    <div class="app-layout">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container navbar__container">
                <a href="/" class="navbar__logo">CineScope Admin</a>

                <div class="navbar__menu">
                    <a href="/admin/index.html" class="navbar__link">Dashboard</a>
                    <a href="/admin/content.html" class="navbar__link">Content</a>
                    <a href="/admin/recommendations.html" class="navbar__link navbar__link--active">Recommendations</a>
                    <a href="/admin/analytics.html" class="navbar__link">Analytics</a>
                </div>

                <div class="navbar__user">
                    <span class="text-sm text-muted me-md">Admin Panel</span>
                    <button class="btn btn-sm btn-secondary" onclick="auth.logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Admin Layout -->
        <div class="admin-layout">
            <!-- Sidebar -->
            <aside class="admin-sidebar">
                <div class="sidebar__section">
                    <h3 class="sidebar__title">Quick Actions</h3>
                    <nav class="sidebar__nav">
                        <a href="#" onclick="showCreateModal()" class="sidebar__link">
                            <i class="bi bi-plus-circle"></i> New Recommendation
                        </a>
                    </nav>
                </div>

                <div class="sidebar__section">
                    <h3 class="sidebar__title">Navigation</h3>
                    <nav class="sidebar__nav">
                        <a href="/admin/index.html" class="sidebar__link">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                        <a href="/admin/content.html" class="sidebar__link">
                            <i class="bi bi-collection-play"></i> Content Management
                        </a>
                        <a href="/admin/recommendations.html" class="sidebar__link sidebar__link--active">
                            <i class="bi bi-award"></i> Recommendations
                        </a>
                        <a href="/admin/analytics.html" class="sidebar__link">
                            <i class="bi bi-graph-up"></i> Analytics
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="admin-content">
                <div class="admin-header">
                    <h1>Admin Recommendations</h1>
                    <button class="btn btn-primary" onclick="showCreateModal()">
                        <i class="bi bi-plus"></i> Create Recommendation
                    </button>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <ul class="tabs__list">
                        <li class="tabs__item tabs__item--active" data-tab="active">Active Recommendations</li>
                        <li class="tabs__item" data-tab="search">Search & Add</li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Active Recommendations -->
                    <div class="tab-pane active" id="active">
                        <div class="mb-lg">
                            <p class="text-muted">Your curated recommendations will appear on the homepage and be sent
                                to the Telegram channel.</p>
                        </div>

                        <div id="recommendationsList">
                            <div class="spinner mx-auto"></div>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination" id="pagination" style="display: none;">
                            <!-- Dynamic pagination -->
                        </div>
                    </div>

                    <!-- Search & Add -->
                    <div class="tab-pane" id="search">
                        <div class="mb-xl">
                            <h3 class="mb-lg">Search External Content</h3>
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="d-flex gap-sm mb-lg">
                                        <input type="text" class="form-control"
                                            placeholder="Search movies, TV shows, anime..." id="externalSearchInput">
                                        <select class="form-control" id="searchSource" style="width: auto;">
                                            <option value="tmdb">TMDB</option>
                                            <option value="anime">Anime (Jikan)</option>
                                        </select>
                                        <button class="btn btn-primary" onclick="searchExternal()">
                                            <i class="bi bi-search"></i> Search
                                        </button>
                                    </div>

                                    <div id="searchResults">
                                        <p class="text-center text-muted">Search for content to add recommendations</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Recommendation Modal -->
    <div class="modal" id="createModal">
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Create Recommendation</h3>
                <button class="modal__close" onclick="hideCreateModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal__body">
                <form id="recommendationForm">
                    <div class="auth-form__group">
                        <label class="auth-form__label">Content ID</label>
                        <input type="number" id="contentId" class="form-control"
                            placeholder="Enter content ID or search above" required>
                        <div class="auth-form__error" id="contentIdError"></div>
                    </div>

                    <div class="auth-form__group">
                        <label class="auth-form__label">Recommendation Type</label>
                        <select class="form-control" id="recommendationType" required>
                            <option value="admin_choice">Admin's Choice</option>
                            <option value="trending">Trending Pick</option>
                            <option value="critics_choice">Critics' Choice</option>
                            <option value="hidden_gem">Hidden Gem</option>
                        </select>
                    </div>

                    <div class="auth-form__group">
                        <label class="auth-form__label">Description</label>
                        <textarea class="form-control" id="description" rows="3"
                            placeholder="Why are you recommending this?" required></textarea>
                        <div class="auth-form__error" id="descriptionError"></div>
                    </div>

                    <div class="d-flex gap-sm">
                        <button type="submit" class="btn btn-primary">
                            Create Recommendation
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="hideCreateModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/storage.js"></script>
    <script src="/assets/js/core/api.js"></script>
    <script src="/assets/js/core/auth.js"></script>
    <script src="/assets/js/core/router.js"></script>

    <script>
        // Check admin authentication
        if (!auth.requireAdmin()) {
            // Will redirect if not admin
        }

        let currentPage = 1;
        let totalPages = 1;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadRecommendations();
            setupTabs();
            setupForm();
        });

        function setupTabs() {
            const tabs = document.querySelectorAll('.tabs__item');
            const panes = document.querySelectorAll('.tab-pane');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('tabs__item--active'));
                    panes.forEach(p => p.classList.remove('active'));

                    tab.classList.add('tabs__item--active');
                    const paneId = tab.dataset.tab;
                    document.getElementById(paneId).classList.add('active');
                });
            });
        }

        async function loadRecommendations(page = 1) {
            try {
                currentPage = page;
                const response = await api.getAdminRecommendations(page, 10);

                renderRecommendations(response.recommendations);
                totalPages = response.pages || 1;
                renderPagination();

            } catch (error) {
                console.error('Failed to load recommendations:', error);
                showToast('Failed to load recommendations', 'error');
            }
        }

        function renderRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');

            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-award empty-state__icon"></i>
                        <h2 class="empty-state__title">No recommendations yet</h2>
                        <p class="empty-state__description">
                            Create your first admin recommendation to showcase great content
                        </p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recommendations.map((rec, index) => `
                <div class="bg-secondary rounded-lg p-lg mb-md animate-fadeInUp" 
                     style="animation-delay: ${index * 0.1}s">
                    <div class="row align-center">
                        <div class="col-auto">
                            <img src="${rec.content.poster_path}" 
                                 alt="${rec.content.title}"
                                 style="width: 80px; height: 120px; object-fit: cover; border-radius: 8px;">
                        </div>
                        <div class="col">
                            <h4 class="mb-sm">${rec.content.title}</h4>
                            <div class="d-flex gap-md mb-sm text-sm text-muted">
                                <span><i class="bi bi-star-fill text-gold"></i> ${rec.content.rating || 'N/A'}</span>
                                <span>${rec.content.content_type.toUpperCase()}</span>
                                <span>
                                    <span class="badge bg-gradient-primary">${rec.recommendation_type.replace('_', ' ').toUpperCase()}</span>
                                </span>
                            </div>
                            <p class="mb-sm">"${rec.description}"</p>
                            <p class="text-sm text-muted mb-0">
                                By ${rec.admin_name} â€¢ ${formatRelativeTime(rec.created_at)}
                            </p>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="navigateToContentDetails(${rec.content.id})">
                                <i class="bi bi-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';

            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <button class="pagination__item ${currentPage === 1 ? 'pagination__item--disabled' : ''}" 
                        onclick="loadRecommendations(${currentPage - 1})"
                        ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="bi bi-chevron-left"></i>
                </button>
            `;

            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                paginationHTML += `
                    <button class="pagination__item ${i === currentPage ? 'pagination__item--active' : ''}" 
                            onclick="loadRecommendations(${i})">${i}</button>
                `;
            }

            // Next button
            paginationHTML += `
                <button class="pagination__item ${currentPage === totalPages ? 'pagination__item--disabled' : ''}" 
                        onclick="loadRecommendations(${currentPage + 1})"
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="bi bi-chevron-right"></i>
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        async function searchExternal() {
            const query = document.getElementById('externalSearchInput').value.trim();
            const source = document.getElementById('searchSource').value;

            if (!query) {
                showToast('Please enter a search query', 'warning');
                return;
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                const response = await api.adminSearch(query, source);

                if (response.results.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-muted">No results found</p>';
                    return;
                }

                resultsContainer.innerHTML = `
                    <div class="content-grid content-grid--movies">
                        ${response.results.map(item => `
                            <div class="content-card">
                                <div class="content-card__image-wrapper">
                                    <img src="${item.poster_path || '/assets/images/placeholder-poster.jpg'}" 
                                         alt="${item.title}" 
                                         class="content-card__image">
                                </div>
                                <div class="content-card__body">
                                    <h3 class="content-card__title text-sm">${item.title}</h3>
                                    <p class="text-xs text-muted mb-sm">${item.release_date || 'N/A'}</p>
                                    <button class="btn btn-sm btn-primary w-100" 
                                            onclick="selectForRecommendation(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                        Select
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Search failed:', error);
                resultsContainer.innerHTML = '<p class="text-center text-error">Search failed. Please try again.</p>';
            }
        }

        async function selectForRecommendation(item) {
            // First save the content to database
            try {
                const saveResponse = await api.saveAdminContent(item);

                if (saveResponse.content_id) {
                    document.getElementById('contentId').value = saveResponse.content_id;
                    showCreateModal();
                    showToast('Content saved. Now create your recommendation.', 'success');
                }
            } catch (error) {
                console.error('Failed to save content:', error);
                showToast('Failed to save content', 'error');
            }
        }

        function setupForm() {
            document.getElementById('recommendationForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const contentId = document.getElementById('contentId').value;
                const recommendationType = document.getElementById('recommendationType').value;
                const description = document.getElementById('description').value;

                if (!contentId || !description) {
                    showToast('Please fill all fields', 'warning');
                    return;
                }

                try {
                    await api.createAdminRecommendation({
                        content_id: parseInt(contentId),
                        recommendation_type: recommendationType,
                        description: description
                    });

                    showToast('Recommendation created successfully!', 'success');
                    hideCreateModal();
                    loadRecommendations();

                    // Reset form
                    document.getElementById('recommendationForm').reset();

                } catch (error) {
                    console.error('Failed to create recommendation:', error);
                    showToast('Failed to create recommendation', 'error');
                }
            });
        }

        function showCreateModal() {
            document.getElementById('createModal').classList.add('modal--open');
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.remove('modal--open');
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;

            return date.toLocaleDateString();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type} animate-slideInRight`;
            toast.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} toast__icon"></i>
                <span class="toast__message">${message}</span>
                <i class="bi bi-x toast__close" onclick="this.parentElement.remove()"></i>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.add('toast--visible'), 10);
            setTimeout(() => toast.remove(), 5000);
        }

        // Close modal on click outside
        document.getElementById('createModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                hideCreateModal();
            }
        });
    </script>
</body>

</html>