<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CineScope</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav container">
            <a href="/" class="nav-brand">CineScope Admin</a>
            <div class="nav-menu">
                <a href="/admin/dashboard" class="nav-link active">Dashboard</a>
                <a href="/admin/content-browser" class="nav-link">Content</a>
                <a href="/admin/posts" class="nav-link">Recommendations</a>
                <a href="/admin/analytics" class="nav-link">Analytics</a>
                <a href="/dashboard" class="nav-link">User View</a>
                <button onclick="app.logout()" class="btn btn-outline btn-sm">Logout</button>
            </div>
            <button class="btn btn-secondary md:hidden" data-mobile-menu-toggle>‚ò∞</button>
        </nav>
    </header>

    <main class="container py-8">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">‚ö° Admin Dashboard</h1>
                <p class="text-gray-400">Manage content and monitor platform performance</p>
            </div>
            <div class="flex gap-4">
                <button id="ml-service-check" class="btn btn-outline">ML Service Status</button>
                <button id="refresh-data" class="btn btn-primary">Refresh Data</button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Total Users</h3>
                    <div class="text-3xl">üë•</div>
                </div>
                <div class="text-3xl font-bold text-blue-400" id="total-users">-</div>
                <p class="text-sm text-gray-400 mt-2">
                    <span id="active-users">-</span> active this week
                </p>
            </div>

            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Content Library</h3>
                    <div class="text-3xl">üé¨</div>
                </div>
                <div class="text-3xl font-bold text-purple-400" id="total-content">-</div>
                <p class="text-sm text-gray-400 mt-2">
                    Movies, TV shows & anime
                </p>
            </div>

            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">User Interactions</h3>
                    <div class="text-3xl">üìä</div>
                </div>
                <div class="text-3xl font-bold text-green-400" id="total-interactions">-</div>
                <p class="text-sm text-gray-400 mt-2">
                    Views, ratings & saves
                </p>
            </div>

            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">ML Service</h3>
                    <div class="text-3xl">ü§ñ</div>
                </div>
                <div class="text-3xl font-bold" id="ml-status">-</div>
                <p class="text-sm text-gray-400 mt-2">
                    AI recommendation engine
                </p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 hover:bg-gray-800 cursor-pointer" onclick="window.location.href='/admin/content-browser'">
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-4xl">üîç</div>
                    <div>
                        <h3 class="text-lg font-semibold">Browse Content</h3>
                        <p class="text-sm text-gray-400">Search and add new content</p>
                    </div>
                </div>
                <div class="text-blue-400 text-sm font-medium">‚Üí Open Content Browser</div>
            </div>

            <div class="card p-6 hover:bg-gray-800 cursor-pointer" onclick="window.location.href='/admin/posts'">
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-4xl">‚ú®</div>
                    <div>
                        <h3 class="text-lg font-semibold">Create Recommendation</h3>
                        <p class="text-sm text-gray-400">Feature content to users</p>
                    </div>
                </div>
                <div class="text-purple-400 text-sm font-medium">‚Üí Create New Post</div>
            </div>

            <div class="card p-6 hover:bg-gray-800 cursor-pointer" onclick="window.location.href='/admin/analytics'">
                <div class="flex items-center gap-4 mb-4">
                    <div class="text-4xl">üìà</div>
                    <div>
                        <h3 class="text-lg font-semibold">View Analytics</h3>
                        <p class="text-sm text-gray-400">Platform insights & metrics</p>
                    </div>
                </div>
                <div class="text-green-400 text-sm font-medium">‚Üí Open Analytics</div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Popular Content -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">Popular Content</h3>
                <div id="popular-content-list" class="space-y-3">
                    <!-- Loading state -->
                    <div class="skeleton h-16 rounded"></div>
                    <div class="skeleton h-16 rounded"></div>
                    <div class="skeleton h-16 rounded"></div>
                </div>
            </div>

            <!-- Popular Genres -->
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">Popular Genres</h3>
                <div id="popular-genres-list" class="space-y-3">
                    <!-- Loading state -->
                    <div class="skeleton h-8 rounded"></div>
                    <div class="skeleton h-8 rounded"></div>
                    <div class="skeleton h-8 rounded"></div>
                </div>
            </div>
        </div>

        <!-- ML Service Status Detail -->
        <div id="ml-service-detail" class="card p-6 hidden">
            <h3 class="text-xl font-bold mb-4">ML Service Detailed Status</h3>
            <div id="ml-service-info" class="space-y-4">
                <!-- ML service details will be populated here -->
            </div>
        </div>

        <!-- Recent Admin Recommendations -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">Recent Recommendations</h3>
                <a href="/admin/posts" class="btn btn-outline btn-sm">View All</a>
            </div>
            <div id="recent-recommendations" class="space-y-4">
                <!-- Loading state -->
                <div class="skeleton h-20 rounded"></div>
                <div class="skeleton h-20 rounded"></div>
                <div class="skeleton h-20 rounded"></div>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!app.isAdmin()) {
                window.location.href = '/login';
                return;
            }
            
            setupAdminDashboard();
            loadDashboardData();
        });

        function setupAdminDashboard() {
            document.getElementById('ml-service-check').addEventListener('click', checkMLService);
            document.getElementById('refresh-data').addEventListener('click', loadDashboardData);
        }

        async function loadDashboardData() {
            try {
                // Load analytics data
                const analytics = await apiClient.getAnalytics();
                updateDashboardStats(analytics);
                updatePopularContent(analytics.popular_content || []);
                updatePopularGenres(analytics.popular_genres || []);
                
                // Load recent admin recommendations
                await loadRecentRecommendations();
                
                // Check ML service status
                await checkMLServiceStatus();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                app.showToast('Some dashboard data failed to load', 'warning');
            }
        }

        function updateDashboardStats(analytics) {
            document.getElementById('total-users').textContent = analytics.total_users || 0;
            document.getElementById('active-users').textContent = analytics.active_users_last_week || 0;
            document.getElementById('total-content').textContent = analytics.total_content || 0;
            document.getElementById('total-interactions').textContent = analytics.total_interactions || 0;
        }

        function updatePopularContent(popularContent) {
            const container = document.getElementById('popular-content-list');
            
            if (!popularContent || popularContent.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No data available</p>';
                return;
            }

            const html = popularContent.slice(0, 5).map((item, index) => `
                <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                    <div class="text-lg font-bold text-blue-400">#${index + 1}</div>
                    <div class="flex-1">
                        <h4 class="font-medium">${item.title}</h4>
                        <p class="text-sm text-gray-400">${item.interactions} interactions</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updatePopularGenres(popularGenres) {
            const container = document.getElementById('popular-genres-list');
            
            if (!popularGenres || popularGenres.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No data available</p>';
                return;
            }

            const maxCount = Math.max(...popularGenres.map(g => g.count));
            
            const html = popularGenres.slice(0, 8).map(genre => {
                const percentage = (genre.count / maxCount) * 100;
                return `
                    <div class="flex items-center justify-between">
                        <span class="font-medium">${genre.genre}</span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-purple-400 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm text-gray-400 w-8">${genre.count}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function loadRecentRecommendations() {
            try {
                const recommendations = await apiClient.request('/admin/recommendations?per_page=5');
                const container = document.getElementById('recent-recommendations');
                
                if (!recommendations.recommendations || recommendations.recommendations.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">No recommendations yet</p>';
                    return;
                }

                const html = recommendations.recommendations.map(rec => `
                    <div class="flex items-center gap-4 p-4 bg-gray-800 rounded-lg">
                        <img src="${app.getImageUrl(rec.content.poster_path, 'w92')}" 
                             alt="${rec.content.title}" 
                             class="w-12 h-18 object-cover rounded"
                             onerror="this.src='${app.getPlaceholderImage(92, 138)}'" />
                        <div class="flex-1">
                            <h4 class="font-medium">${rec.content.title}</h4>
                            <p class="text-sm text-gray-400 mb-1">${rec.description}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-500">
                                <span>By ${rec.admin_name}</span>
                                <span>${new Date(rec.created_at).toLocaleDateString()}</span>
                                <span class="px-2 py-1 bg-blue-600 rounded">${rec.recommendation_type}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;

            } catch (error) {
                console.error('Failed to load recent recommendations:', error);
                document.getElementById('recent-recommendations').innerHTML = 
                    '<p class="text-red-400 text-center py-4">Failed to load recommendations</p>';
            }
        }

        async function checkMLServiceStatus() {
            try {
                const response = await apiClient.request('/admin/ml-service-check');
                const statusElement = document.getElementById('ml-status');
                
                if (response.status === 'healthy') {
                    statusElement.textContent = '‚úÖ Healthy';
                    statusElement.className = 'text-3xl font-bold text-green-400';
                } else if (response.status === 'partial') {
                    statusElement.textContent = '‚ö†Ô∏è Partial';
                    statusElement.className = 'text-3xl font-bold text-yellow-400';
                } else {
                    statusElement.textContent = '‚ùå Down';
                    statusElement.className = 'text-3xl font-bold text-red-400';
                }

            } catch (error) {
                console.error('Failed to check ML service:', error);
                const statusElement = document.getElementById('ml-status');
                statusElement.textContent = '‚ùì Unknown';
                statusElement.className = 'text-3xl font-bold text-gray-400';
            }
        }

        async function checkMLService() {
            const detailContainer = document.getElementById('ml-service-detail');
            const infoContainer = document.getElementById('ml-service-info');
            
            detailContainer.classList.remove('hidden');
            infoContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await apiClient.request('/admin/ml-service-check');
                
                const html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold mb-3">Service Status</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Overall Status:</span>
                                    <span class="font-medium ${getStatusColor(response.status)}">${response.status}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Service URL:</span>
                                    <span class="text-sm text-gray-400">${response.ml_service_url || 'Not configured'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Last Check:</span>
                                    <span class="text-sm text-gray-400">${new Date(response.timestamp).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-3">Health Checks</h4>
                            <div class="space-y-2">
                                ${Object.entries(response.checks || {}).map(([check, result]) => `
                                    <div class="flex justify-between">
                                        <span>${check.replace(/_/g, ' ')}:</span>
                                        <span class="font-medium ${result.status === 'pass' ? 'text-green-400' : 'text-red-400'}">
                                            ${result.status === 'pass' ? '‚úÖ' : '‚ùå'} ${result.status}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    ${response.summary ? `
                        <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                            <h4 class="font-semibold mb-2">Summary</h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-green-400">${response.summary.passed}</div>
                                    <div class="text-gray-400">Passed</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-red-400">${response.summary.failed}</div>
                                    <div class="text-gray-400">Failed</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-400">${response.summary.total_checks}</div>
                                    <div class="text-gray-400">Total</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="flex gap-4 mt-6">
                        <button onclick="forceMLUpdate()" class="btn btn-outline btn-sm">Force Update Models</button>
                        <button onclick="checkMLService()" class="btn btn-outline btn-sm">Refresh Status</button>
                    </div>
                `;

                infoContainer.innerHTML = html;

            } catch (error) {
                console.error('Failed to get ML service details:', error);
                infoContainer.innerHTML = '<p class="text-red-400">Failed to get ML service status</p>';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'healthy': return 'text-green-400';
                case 'partial': return 'text-yellow-400';
                case 'unhealthy': return 'text-red-400';
                default: return 'text-gray-400';
            }
        }

        async function forceMLUpdate() {
            try {
                const response = await apiClient.request('/admin/ml-service-update', { method: 'POST' });
                
                if (response.success) {
                    app.showToast('ML model update initiated', 'success');
                } else {
                    app.showToast(response.message || 'Update failed', 'error');
                }
            } catch (error) {
                console.error('Failed to update ML models:', error);
                app.showToast('Failed to update ML models', 'error');
            }
        }
    </script>
</body>
</html>
