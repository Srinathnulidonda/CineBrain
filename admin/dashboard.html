<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CineScope</title>
    <meta name="description" content="CineScope admin dashboard for content and user management.">
    
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>
<body>
    <div id="preloader" class="preloader">
        <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium">Loading Admin Dashboard...</p>
        </div>
    </div>

    <div id="header-placeholder"></div>

    <main class="container py-8">
        <!-- Admin Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">üõ†Ô∏è Admin Dashboard</h1>
                <p class="text-gray-400">Manage content, users, and platform analytics</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="stats-card min-w-0">
                    <div class="stats-value text-sm" id="lastUpdate">--</div>
                    <div class="stats-label">Last Update</div>
                </div>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-2 md:grid-4 gap-6 mb-8">
            <div class="stats-card">
                <div class="stats-value" id="totalUsers">0</div>
                <div class="stats-label">Total Users</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="totalContent">0</div>
                <div class="stats-label">Content Items</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="totalInteractions">0</div>
                <div class="stats-label">User Interactions</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="activeUsers">0</div>
                <div class="stats-label">Active Users (7d)</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <section class="section">
            <h2 class="section-title">Quick Actions</h2>
            <div class="grid grid-2 md:grid-4 gap-4">
                <a href="/admin/content-browser" class="card hover:scale-105 transition-transform">
                    <div class="card-content text-center">
                        <div class="text-3xl mb-2">üé¨</div>
                        <h3 class="font-semibold">Content Browser</h3>
                        <p class="text-sm text-gray-400">Search & manage content</p>
                    </div>
                </a>
                <a href="/admin/analytics" class="card hover:scale-105 transition-transform">
                    <div class="card-content text-center">
                        <div class="text-3xl mb-2">üìä</div>
                        <h3 class="font-semibold">Analytics</h3>
                        <p class="text-sm text-gray-400">View detailed statistics</p>
                    </div>
                </a>
                <button class="card hover:scale-105 transition-transform" onclick="openContentSearch()">
                    <div class="card-content text-center">
                        <div class="text-3xl mb-2">üîç</div>
                        <h3 class="font-semibold">Add Content</h3>
                        <p class="text-sm text-gray-400">Search external APIs</p>
                    </div>
                </button>
                <button class="card hover:scale-105 transition-transform" onclick="checkMLService()">
                    <div class="card-content text-center">
                        <div class="text-3xl mb-2">ü§ñ</div>
                        <h3 class="font-semibold">ML Service</h3>
                        <p class="text-sm text-gray-400">Check service status</p>
                    </div>
                </button>
            </div>
        </section>

        <!-- Recent Admin Recommendations -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Recent Recommendations</h2>
                <button class="btn btn-primary btn-sm" onclick="createNewRecommendation()">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Recommendation
                </button>
            </div>
            <div class="space-y-4" id="recentRecommendations">
                <!-- Recent recommendations will be loaded here -->
            </div>
        </section>

        <!-- Popular Content Overview -->
        <section class="section">
            <h2 class="section-title">Popular Content</h2>
            <div class="content-grid" id="popularContent">
                <!-- Popular content will be loaded here -->
            </div>
        </section>

        <!-- ML Service Status -->
        <section class="section">
            <h2 class="section-title">ML Service Status</h2>
            <div class="card">
                <div class="card-content">
                    <div id="mlServiceStatus">
                        <div class="flex items-center justify-center py-8">
                            <div class="loader"></div>
                            <span class="ml-4">Checking ML service status...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Content Search Modal -->
    <div id="contentSearchModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Search External Content</h3>
                <button class="modal-close" onclick="closeContentSearchModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Search Query</label>
                        <input type="text" id="contentSearchInput" class="form-input" placeholder="Enter movie, TV show, or anime title...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select id="contentSource" class="form-input">
                            <option value="tmdb">TMDB (Movies & TV)</option>
                            <option value="anime">Jikan (Anime)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-full" onclick="searchExternalContent()">
                        Search Content
                    </button>
                </div>
                <div id="searchResults" class="mt-6" style="display: none;">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script src="/js/include.js"></script>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!appState.isAuthenticated() || !appState.isAdmin()) {
                window.location.href = '/login';
                return;
            }

            await loadDashboardData();
            updateLastUpdateTime();
        });

        async function loadDashboardData() {
            try {
                // Load analytics data
                const analyticsResponse = await api.getAnalytics();
                updateStatistics(analyticsResponse);

                // Load recent admin recommendations
                await loadRecentRecommendations();

                // Load popular content
                await loadPopularContent();

                // Check ML service status
                await loadMLServiceStatus();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                UI.showToast('Some dashboard data failed to load', 'warning');
            }
        }

        function updateStatistics(data) {
            document.getElementById('totalUsers').textContent = (data.total_users || 0).toLocaleString();
            document.getElementById('totalContent').textContent = (data.total_content || 0).toLocaleString();
            document.getElementById('totalInteractions').textContent = (data.total_interactions || 0).toLocaleString();
            document.getElementById('activeUsers').textContent = (data.active_users_last_week || 0).toLocaleString();
        }

        async function loadRecentRecommendations() {
            try {
                const response = await api.getAdminRecommendations(1, 5);
                const recommendations = response.recommendations || [];

                const container = document.getElementById('recentRecommendations');
                
                if (recommendations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <h3 class="empty-state-title">No recommendations yet</h3>
                            <p class="empty-state-description">Create your first admin recommendation to share with users.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = recommendations.map(rec => `
                    <div class="card">
                        <div class="card-content">
                            <div class="flex items-start gap-4">
                                <img src="${rec.content.poster_path || Utils.getPlaceholderImage(80, 120)}" 
                                     alt="${Utils.sanitizeHTML(rec.content.title)}" 
                                     class="w-16 h-24 object-cover rounded">
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold mb-1">${Utils.sanitizeHTML(rec.content.title)}</h3>
                                    <p class="text-sm text-gray-400 mb-2">
                                        Recommended by ${rec.admin_name} ‚Ä¢ ${new Date(rec.created_at).toLocaleDateString()}
                                    </p>
                                    <p class="text-sm text-gray-300">${Utils.truncateText(rec.description, 100)}</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="badge badge-${rec.recommendation_type === 'trending' ? 'warning' : 'primary'}">
                                            ${rec.recommendation_type.replace('_', ' ').toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                                <button class="btn btn-ghost btn-sm" onclick="Router.navigate('/details?id=${rec.content.id}')">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading recent recommendations:', error);
            }
        }

        async function loadPopularContent() {
            try {
                const response = await api.getTrending('all', 8);
                const content = response.recommendations || [];

                const container = document.getElementById('popularContent');
                contentManager.renderMovieGrid(container, { recommendations: content });

            } catch (error) {
                console.error('Error loading popular content:', error);
                document.getElementById('popularContent').innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-8">
                        Failed to load popular content
                    </div>
                `;
            }
        }

        async function loadMLServiceStatus() {
            try {
                const response = await api.checkMLService();
                renderMLServiceStatus(response);

            } catch (error) {
                console.error('Error checking ML service:', error);
                document.getElementById('mlServiceStatus').innerHTML = `
                    <div class="text-center text-red-400 py-4">
                        <div class="text-2xl mb-2">‚ùå</div>
                        <p>Failed to check ML service status</p>
                    </div>
                `;
            }
        }

        function renderMLServiceStatus(status) {
            const container = document.getElementById('mlServiceStatus');
            const isHealthy = status.status === 'healthy';
            const isPartial = status.status === 'partial';

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${isHealthy ? 'bg-green-400' : isPartial ? 'bg-yellow-400' : 'bg-red-400'} animate-pulse"></div>
                            <h3 class="text-lg font-semibold">
                                ML Service: ${status.status.charAt(0).toUpperCase() + status.status.slice(1)}
                            </h3>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="loadMLServiceStatus()">
                            Refresh
                        </button>
                    </div>
                    
                    <div class="grid grid-1 md:grid-3 gap-4">
                        ${Object.entries(status.checks || {}).map(([key, check]) => `
                            <div class="bg-gray-800 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium capitalize">${key.replace('_', ' ')}</span>
                                    <span class="w-2 h-2 rounded-full ${check.status === 'pass' ? 'bg-green-400' : 'bg-red-400'}"></span>
                                </div>
                                ${check.response_time ? `<div class="text-xs text-gray-400">Response: ${check.response_time}</div>` : ''}
                                ${check.error ? `<div class="text-xs text-red-400">${check.error}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    ${status.quick_actions?.force_update_available ? `
                        <div class="flex justify-end">
                            <button class="btn btn-primary btn-sm" onclick="updateMLService()">
                                Force Update Models
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        async function refreshDashboard() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = `
                <svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refreshing...
            `;
            button.disabled = true;

            try {
                await loadDashboardData();
                updateLastUpdateTime();
                UI.showToast('Dashboard refreshed!', 'success');
            } catch (error) {
                UI.showToast('Failed to refresh dashboard', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function openContentSearch() {
            document.getElementById('contentSearchModal').classList.add('show');
        }

        function closeContentSearchModal() {
            document.getElementById('contentSearchModal').classList.remove('show');
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('contentSearchInput').value = '';
        }

        async function searchExternalContent() {
            const query = document.getElementById('contentSearchInput').value.trim();
            const source = document.getElementById('contentSource').value;

            if (!query) {
                UI.showToast('Please enter a search query', 'error');
                return;
            }

            try {
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.style.display = 'block';
                resultsContainer.innerHTML = '<div class="text-center py-4"><div class="loader"></div></div>';

                const response = await api.adminSearch(query, source);
                const results = response.results || [];

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="text-center text-gray-400 py-4">No results found</div>';
                    return;
                }

                resultsContainer.innerHTML = `
                    <h4 class="font-semibold mb-4">Search Results (${results.length})</h4>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${results.map(item => `
                            <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                                <img src="${item.poster_path || Utils.getPlaceholderImage(60, 90)}" 
                                     alt="${Utils.sanitizeHTML(item.title)}" 
                                     class="w-12 h-18 object-cover rounded">
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-medium truncate">${Utils.sanitizeHTML(item.title)}</h5>
                                    <p class="text-sm text-gray-400">${item.release_date || 'N/A'} ‚Ä¢ ${item.content_type?.toUpperCase()}</p>
                                    ${item.rating ? `<div class="text-xs text-yellow-400">‚≠ê ${item.rating}</div>` : ''}
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="saveExternalContent(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                    Add to DB
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Error searching external content:', error);
                document.getElementById('searchResults').innerHTML = 
                    '<div class="text-center text-red-400 py-4">Search failed. Please try again.</div>';
            }
        }

        async function saveExternalContent(contentData) {
            try {
                const response = await api.saveContent(contentData);
                UI.showToast('Content added to database!', 'success');
                
                // Refresh dashboard stats
                loadDashboardData();
                
            } catch (error) {
                console.error('Error saving content:', error);
                UI.showToast('Failed to save content', 'error');
            }
        }

        function createNewRecommendation() {
            Router.navigate('/admin/content-browser?action=recommend');
        }

        async function updateMLService() {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = 'Updating...';

                await api.updateMLService();
                UI.showToast('ML service update initiated!', 'success');
                
                // Refresh ML service status after a delay
                setTimeout(loadMLServiceStatus, 3000);

            } catch (error) {
                UI.showToast('Failed to update ML service', 'error');
            } finally {
                event.target.disabled = false;
                event.target.textContent = 'Force Update Models';
            }
        }

        async function checkMLService() {
            await loadMLServiceStatus();
            UI.showToast('ML service status refreshed', 'info');
        }

        // Click outside modal to close
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>